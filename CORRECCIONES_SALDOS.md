# üîß CORRECCIONES INTEGRALES DEL SISTEMA DE SALDOS

**Fecha**: 2025
**Objetivo**: Corregir de ra√≠z los problemas de c√°lculo y visualizaci√≥n de saldos

---

## üìä PROBLEMAS IDENTIFICADOS

### 1. **Inconsistencia en Signos de EGRESOS**

- **S√≠ntoma**: EGRESO mostraba `-10.1`, `-914.4` en reportes
- **Causa Ra√≠z**: Doble aplicaci√≥n de signo negativo
  - Se pasaba `monto: -efectivo` a `logMovimientoSaldo()`
  - El servicio aplicaba el signo nuevamente
  - Resultado: inconsistencia en algunos casos

### 2. **Cambios de Divisa No Visibles**

- **S√≠ntoma**: Dif√≠cil encontrar movimientos de cambio de divisa
- **Causa**: No hab√≠a filtro espec√≠fico para `tipo_referencia: "CAMBIO_DIVISA"`

### 3. **Visualizaci√≥n Confusa en Reportes**

- **S√≠ntoma**: Montos negativos sin contexto visual claro
- **Causa**: Se mostraba el valor raw de la BD sin normalizar

---

## ‚úÖ CORRECCIONES IMPLEMENTADAS

### **NIVEL 1: Registro de Movimientos (Backend)**

#### 1.1 Enum TipoReferencia

**Archivo**: `server/services/movimientoSaldoService.ts`

```typescript
export enum TipoReferencia {
  EXCHANGE = "EXCHANGE",
  CAMBIO_DIVISA = "CAMBIO_DIVISA", // ‚úÖ NUEVO
  TRANSFER = "TRANSFER",
  // ... otros
}
```

#### 1.2 Exchanges - Registro Correcto

**Archivo**: `server/routes/exchanges.ts`

```typescript
// ‚ùå ANTES:
monto: -egresoEf, // Negativo para EGRESO

// ‚úÖ DESPU√âS:
monto: egresoEf, // Positivo - el servicio aplica el signo
```

#### 1.3 Transferencias - Registro Correcto

**Archivo**: `server/services/transferCreationService.ts`

```typescript
// ‚ùå ANTES:
monto: -efectivo, // Negativo para EGRESO

// ‚úÖ DESPU√âS:
monto: efectivo, // Positivo - el servicio aplica el signo
```

**REGLA DE ORO**:

> Siempre pasar montos POSITIVOS a `logMovimientoSaldo()`.
> El servicio centralizado aplica el signo seg√∫n `tipo_movimiento`.

---

### **NIVEL 2: Reportes (Backend)**

#### 2.1 Normalizaci√≥n de Datos

**Archivo**: `server/services/reportDataService.ts`

```typescript
return rows.map((r) => {
  const montoRaw = Number(r.monto);
  return {
    // ... otros campos
    monto: Math.abs(montoRaw), // ‚úÖ Siempre positivo
    signo: montoRaw >= 0 ? "+" : "-", // ‚úÖ Signo separado
  };
});
```

#### 2.2 Tipo TypeScript

**Archivo**: `server/types/reportTypes.ts`

```typescript
export interface AccountingMovementData {
  // ... otros campos
  monto: number; // ‚úÖ Siempre positivo (valor absoluto)
  signo: "+" | "-"; // ‚úÖ Signo del movimiento
}
```

---

### **NIVEL 3: Visualizaci√≥n (Frontend)**

#### 3.1 Renderizado con Colores

**Archivo**: `src/components/reports/ReportsImproved.tsx`

```typescript
// Formateo especial para monto con signo
if (key === "monto" && "signo" in row) {
  const signo = row.signo === "+" ? "+" : "-";
  const color = row.signo === "+" ? "text-green-600" : "text-red-600";
  return (
    <td className={`px-4 py-3 text-sm font-medium ${color}`}>
      {signo}{" "}
      {value.toLocaleString("es-EC", {
        minimumFractionDigits: 2,
        maximumFractionDigits: 2,
      })}
    </td>
  );
}
```

**Resultado Visual**:

- INGRESO: `+ 500.00` (verde)
- EGRESO: `- 10.10` (rojo)

#### 3.2 Filtro por Tipo de Referencia

**Nuevo filtro** en reportes de movimientos contables:

- üîÑ Cambio de Divisa
- üí± Exchange
- üí∏ Transferencia
- üè¢ Servicio Externo
- ‚úèÔ∏è Ajuste Manual
- üí∞ Saldo Inicial
- üìä Cierre Diario
- üì¶ Servientrega

---

### **NIVEL 4: Exportaci√≥n a Excel**

#### 4.1 Normalizaci√≥n Pre-Exportaci√≥n

**Archivo**: `src/utils/exportToExcel.ts`

```typescript
// Normalizar datos: combinar monto con signo
const normalizedData = data.map((row) => {
  if ("signo" in row && "monto" in row) {
    const { signo, monto, ...rest } = row;
    const montoValue = typeof monto === "number" ? monto : 0;
    const montoConSigno = signo === "-" ? -montoValue : montoValue;
    return { ...rest, monto: montoConSigno };
  }
  return row;
});
```

**Resultado en Excel**:

- INGRESO: `500.00` (positivo)
- EGRESO: `-10.10` (negativo)
- Columna "signo" NO aparece

---

## üéØ ARQUITECTURA DEL SISTEMA

### Flujo de Datos Correcto

```
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ 1. REGISTRO DE MOVIMIENTO                                   ‚îÇ
‚îÇ    (exchanges.ts, transferCreationService.ts, etc.)         ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                      ‚îÇ
                      ‚îÇ monto: POSITIVO
                      ‚îÇ tipo_movimiento: "INGRESO" | "EGRESO"
                      ‚ñº
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ 2. SERVICIO CENTRALIZADO                                    ‚îÇ
‚îÇ    movimientoSaldoService.ts                                ‚îÇ
‚îÇ    - Aplica signo seg√∫n tipo_movimiento                     ‚îÇ
‚îÇ    - INGRESO: monto positivo                                ‚îÇ
‚îÇ    - EGRESO: monto negativo                                 ‚îÇ
‚îÇ    - Valida consistencia                                    ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                      ‚îÇ
                      ‚îÇ Guarda en BD con signo correcto
                      ‚ñº
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ 3. BASE DE DATOS                                            ‚îÇ
‚îÇ    movimiento_saldo                                         ‚îÇ
‚îÇ    - INGRESO: monto > 0                                     ‚îÇ
‚îÇ    - EGRESO: monto < 0                                      ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                      ‚îÇ
                      ‚îÇ Consulta para reportes
                      ‚ñº
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ 4. SERVICIO DE REPORTES                                     ‚îÇ
‚îÇ    reportDataService.ts                                     ‚îÇ
‚îÇ    - Normaliza: monto = Math.abs(monto)                     ‚îÇ
‚îÇ    - Agrega: signo = monto >= 0 ? "+" : "-"                 ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                      ‚îÇ
                      ‚îÇ JSON con monto positivo + signo
                      ‚ñº
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ 5. FRONTEND                                                 ‚îÇ
‚îÇ    ReportsImproved.tsx                                      ‚îÇ
‚îÇ    - Muestra: signo + monto formateado                      ‚îÇ
‚îÇ    - Color: verde (+) / rojo (-)                            ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                      ‚îÇ
                      ‚îÇ Exportar a Excel
                      ‚ñº
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ 6. EXPORTACI√ìN                                              ‚îÇ
‚îÇ    exportToExcel.ts                                         ‚îÇ
‚îÇ    - Combina signo con monto                                ‚îÇ
‚îÇ    - Excel: valores positivos/negativos                     ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
```

---

## üîí REGLAS FUNDAMENTALES

### ‚úÖ DO (Hacer)

1. **Siempre** pasar montos POSITIVOS a `registrarMovimientoSaldo()`
2. **Siempre** especificar `tipo_movimiento` correcto
3. **Siempre** incluir `tipo_referencia` para trazabilidad
4. **Usar** el servicio de reconciliaci√≥n si hay inconsistencias

### ‚ùå DON'T (No Hacer)

1. **Nunca** insertar directamente en `movimiento_saldo`
2. **Nunca** pasar montos negativos para EGRESO
3. **Nunca** modificar el signo manualmente en la BD
4. **Nunca** saltarse el servicio centralizado

---

## üß™ VERIFICACI√ìN

### Comandos de Verificaci√≥n

```bash
# 1. Compilar proyecto
npm run build

# 2. Verificar tipos TypeScript
npx tsc --noEmit

# 3. Ejecutar servidor
npm run dev
```

### Pruebas Manuales

1. **Crear un cambio de divisa**

   - Verificar que aparece en movimientos contables
   - Verificar que EGRESO muestra `- X.XX` en rojo
   - Verificar que INGRESO muestra `+ X.XX` en verde

2. **Filtrar por tipo de referencia**

   - Ir a Reportes > Movimientos Contables
   - Seleccionar "Cambio de Divisa"
   - Verificar que solo aparecen cambios de divisa

3. **Exportar a Excel**
   - Generar reporte de movimientos contables
   - Exportar a Excel
   - Verificar que EGRESO tiene valores negativos
   - Verificar que no hay columna "signo"

---

## üìù ARCHIVOS MODIFICADOS

### Backend

1. `server/services/movimientoSaldoService.ts` - Enum actualizado
2. `server/routes/exchanges.ts` - Registro corregido
3. `server/services/transferCreationService.ts` - Registro corregido
4. `server/services/reportDataService.ts` - Normalizaci√≥n agregada
5. `server/types/reportTypes.ts` - Tipo actualizado

### Frontend

6. `src/components/reports/ReportsImproved.tsx` - Visualizaci√≥n mejorada
7. `src/utils/exportToExcel.ts` - Exportaci√≥n normalizada

---

## üöÄ PR√ìXIMOS PASOS (Opcional)

### Mejoras Futuras

1. **Dashboard de Reconciliaci√≥n**: Panel para detectar inconsistencias
2. **Alertas Autom√°ticas**: Notificar cuando hay diferencias > 0.01
3. **Auditor√≠a de Cambios**: Log de todas las modificaciones a saldos
4. **Reportes Avanzados**: Gr√°ficos de flujo de efectivo por tipo

### Mantenimiento

1. **Ejecutar reconciliaci√≥n mensual**: `npm run reconcile-balances`
2. **Revisar logs de errores**: Buscar "saldo inconsistente"
3. **Backup antes de ajustes**: Siempre respaldar antes de correcciones masivas

---

## üìû SOPORTE

Si encuentras problemas:

1. Verificar que todos los archivos est√©n actualizados
2. Revisar logs del servidor: `tail -f logs/server.log`
3. Ejecutar script de verificaci√≥n: `npm run verify-balances`
4. Contactar al equipo de desarrollo

---

**√öltima actualizaci√≥n**: 2025
**Estado**: ‚úÖ COMPLETADO Y PROBADO

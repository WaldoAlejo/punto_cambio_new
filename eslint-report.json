[{"filePath":"C:\\Users\\oswal\\OneDrive\\Documentos\\Punto Cambio\\punto_cambio_new\\ecosystem.config.cjs","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\oswal\\OneDrive\\Documentos\\Punto Cambio\\punto_cambio_new\\eslint.config.js","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\oswal\\OneDrive\\Documentos\\Punto Cambio\\punto_cambio_new\\postcss.config.js","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\oswal\\OneDrive\\Documentos\\Punto Cambio\\punto_cambio_new\\prisma\\seed-clean-db.ts","messages":[{"ruleId":null,"message":"Unused eslint-disable directive (no problems were reported from 'no-console').","line":88,"column":9,"severity":1,"nodeType":null,"fix":{"range":[2344,2382],"text":" "}}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":1,"fixableErrorCount":0,"fixableWarningCount":1,"source":"import { PrismaClient } from '@prisma/client'\r\n\r\nconst prisma = new PrismaClient()\r\n\r\ntype DelegateKey =\r\n  | 'servicioExternoDetalleCierre'\r\n  | 'detalleCuadreCaja'\r\n  | 'recibo'\r\n  | 'permiso'\r\n  | 'solicitudSaldo'\r\n  | 'servicioExternoMovimiento'\r\n  | 'servicioExternoAsignacion'\r\n  | 'servicioExternoSaldo'\r\n  | 'servicioExternoCierreDiario'\r\n  | 'cambioDivisa'\r\n  | 'transferencia'\r\n  | 'movimientoSaldo'\r\n  | 'historialSaldo'\r\n  | 'movimiento'\r\n  | 'saldoInicial'\r\n  | 'saldo'\r\n  | 'servientregaGuia'\r\n  | 'servientregaRemitente'\r\n  | 'servientregaDestinatario'\r\n  | 'servientregaSaldo'\r\n  | 'servientregaSolicitudSaldo'\r\n  | 'servientregaHistorialSaldo'\r\n  | 'servientregaSolicitudAnulacion'\r\n  | 'cierreDiario'\r\n  | 'cuadreCaja'\r\n  | 'historialAsignacionPunto'\r\n\r\n// IMPORTANT: These models will be preserved: Usuario, PuntoAtencion, Moneda, Jornada\r\n// We DO NOT delete those.\r\n\r\nconst deleteOrder: DelegateKey[] = [\r\n  'servicioExternoDetalleCierre',\r\n  'detalleCuadreCaja',\r\n  'recibo',\r\n  'permiso',\r\n  'solicitudSaldo',\r\n  'servicioExternoMovimiento',\r\n  'servicioExternoAsignacion',\r\n  'servicioExternoSaldo',\r\n  'servicioExternoCierreDiario',\r\n  'cambioDivisa',\r\n  'transferencia',\r\n  'movimientoSaldo',\r\n  'historialSaldo',\r\n  'movimiento',\r\n  'saldoInicial',\r\n  'saldo',\r\n  'servientregaGuia',\r\n  'servientregaRemitente',\r\n  'servientregaDestinatario',\r\n  'servientregaSaldo',\r\n  'servientregaSolicitudSaldo',\r\n  'servientregaHistorialSaldo',\r\n  'servientregaSolicitudAnulacion',\r\n  'cierreDiario',\r\n  'cuadreCaja',\r\n  'historialAsignacionPunto',\r\n]\r\n\r\nfunction parseArgs() {\r\n  const args = new Set(process.argv.slice(2))\r\n  const execute = args.has('--execute') || args.has('-x')\r\n  const force = args.has('--force') || args.has('-f')\r\n  const verbose = args.has('--verbose') || args.has('-v')\r\n  return { execute, force, verbose }\r\n}\r\n\r\nasync function countAll() {\r\n  const counts: Record<string, number> = {}\r\n  for (const key of deleteOrder) {\r\n    // @ts-expect-error dynamic delegate access\r\n    counts[key] = await prisma[key].count()\r\n  }\r\n  return counts\r\n}\r\n\r\nasync function deleteAll(verbose: boolean) {\r\n  await prisma.$transaction(async (tx) => {\r\n    for (const key of deleteOrder) {\r\n      // @ts-expect-error dynamic delegate access\r\n      const res = await tx[key].deleteMany()\r\n      if (verbose) {\r\n        // eslint-disable-next-line no-console\r\n        console.log(`[deleted] ${key}: ${res.count}`)\r\n      }\r\n    }\r\n  })\r\n}\r\n\r\nasync function main() {\r\n  const { execute, force, verbose } = parseArgs()\r\n\r\n  // Safety: prevent accidental production wipe unless explicitly forced\r\n  const isProd = process.env.NODE_ENV === 'production'\r\n  if (isProd && !force) {\r\n    throw new Error('NODE_ENV=production detected. Use --force to proceed.')\r\n  }\r\n\r\n  if (!execute) {\r\n    const counts = await countAll()\r\n    const total = Object.values(counts).reduce((a, b) => a + b, 0)\r\n    console.log('=== Dry-run: rows that would be deleted ===')\r\n    for (const key of deleteOrder) {\r\n      console.log(`${key}: ${counts[key]}`)\r\n    }\r\n    console.log(`Total rows to delete: ${total}`)\r\n    console.log('\\nRun with --execute to perform cleanup. Optional: --force in production, --verbose for per-table deletion logs.')\r\n    return\r\n  }\r\n\r\n  console.log('Executing cleanup...')\r\n  await deleteAll(verbose)\r\n  console.log('Cleanup completed successfully.')\r\n}\r\n\r\nmain()\r\n  .catch((e) => {\r\n    console.error(e)\r\n    process.exit(1)\r\n  })\r\n  .finally(async () => {\r\n    await prisma.$disconnect()\r\n  })\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\oswal\\OneDrive\\Documentos\\Punto Cambio\\punto_cambio_new\\prisma\\seed-complete.ts","messages":[{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'admin' is assigned a value but never used. Allowed unused vars must match /^_/u.","line":74,"column":9,"nodeType":null,"messageId":"unusedVar","endLine":74,"endColumn":14}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":1,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import { PrismaClient } from '@prisma/client'\r\nimport bcrypt from 'bcryptjs'\r\nimport currencyCodes from 'currency-codes'\r\nimport getSymbolFromCurrency from 'currency-symbol-map'\r\n\r\nconst prisma = new PrismaClient()\r\n\r\nfunction isRecord(value: unknown): value is Record<string, unknown> {\r\n  return typeof value === 'object' && value !== null\r\n}\r\n\r\nasync function main() {\r\n  console.log('Seed: creating unique index for principal PuntoAtencion if not exists...')\r\n  await prisma.$executeRawUnsafe(\r\n    `CREATE UNIQUE INDEX IF NOT EXISTS unique_principal_on_puntoatencion ON \"PuntoAtencion\" (es_principal) WHERE es_principal = true;`\r\n  )\r\n\r\n  const principalName = process.env.PRINCIPAL_OFFICE_NAME ?? 'OFICINA PRINCIPAL'\r\n\r\n  console.log('Seed: upserting principal PuntoAtencion ->', principalName)\r\n  const principal = await prisma.puntoAtencion.upsert({\r\n    where: { nombre: principalName },\r\n    update: {\r\n      es_principal: true,\r\n      activo: true,\r\n      updated_at: new Date(),\r\n    },\r\n    create: {\r\n      nombre: principalName,\r\n      direccion: 'Sede principal',\r\n      ciudad: 'Ciudad',\r\n      provincia: 'Provincia',\r\n      codigo_postal: null,\r\n      telefono: null,\r\n      es_principal: true,\r\n      activo: true,\r\n    },\r\n  })\r\n\r\n  console.log('Seed: creating protection triggers for principal PuntoAtencion (prevents update/delete)')\r\n  const fnSql = `\r\n  CREATE OR REPLACE FUNCTION prevent_principal_modification()\r\n  RETURNS trigger AS $$\r\n  BEGIN\r\n    IF (OLD.es_principal = true) THEN\r\n      RAISE EXCEPTION 'Modification or deletion of principal PuntoAtencion is not allowed';\r\n    END IF;\r\n    RETURN OLD;\r\n  END;\r\n  $$ LANGUAGE plpgsql;\r\n  `\r\n\r\n  await prisma.$executeRawUnsafe(fnSql)\r\n\r\n  await prisma.$executeRawUnsafe(\r\n    `DROP TRIGGER IF EXISTS trg_prevent_principal_delete ON \"PuntoAtencion\";`\r\n  )\r\n  await prisma.$executeRawUnsafe(\r\n    `CREATE TRIGGER trg_prevent_principal_delete BEFORE DELETE ON \"PuntoAtencion\" FOR EACH ROW EXECUTE FUNCTION prevent_principal_modification();`\r\n  )\r\n\r\n  await prisma.$executeRawUnsafe(\r\n    `DROP TRIGGER IF EXISTS trg_prevent_principal_update ON \"PuntoAtencion\";`\r\n  )\r\n  await prisma.$executeRawUnsafe(\r\n    `CREATE TRIGGER trg_prevent_principal_update BEFORE UPDATE ON \"PuntoAtencion\" FOR EACH ROW EXECUTE FUNCTION prevent_principal_modification();`\r\n  )\r\n\r\n  const adminUsername = process.env.ADMIN_USERNAME ?? 'admin'\r\n  const adminPassword = process.env.ADMIN_PASSWORD ?? 'Admin123!'\r\n  const hashed = bcrypt.hashSync(adminPassword, 10)\r\n\r\n  console.log('Seed: upserting admin user ->', adminUsername)\r\n  const admin = await prisma.usuario.upsert({\r\n    where: { username: adminUsername },\r\n    update: {\r\n      password: hashed,\r\n      rol: 'ADMIN',\r\n      nombre: 'Administrador',\r\n      punto_atencion_id: principal.id,\r\n      activo: true,\r\n      updated_at: new Date(),\r\n    },\r\n    create: {\r\n      username: adminUsername,\r\n      password: hashed,\r\n      rol: 'ADMIN',\r\n      nombre: 'Administrador',\r\n      correo: null,\r\n      telefono: null,\r\n      activo: true,\r\n      punto_atencion_id: principal.id,\r\n    },\r\n  })\r\n\r\n  console.log('Seed: inserting currencies from `currency-codes` package')\r\n  const codes: string[] = typeof currencyCodes.codes === 'function' ? currencyCodes.codes() : []\r\n\r\n  for (let i = 0; i < codes.length; i++) {\r\n    const code = codes[i]\r\n    const data = currencyCodes.code(code) as unknown\r\n    const name =\r\n      (isRecord(data) && typeof data.currency === 'string' && data.currency) || code\r\n    const symbol = getSymbolFromCurrency(code) || code\r\n\r\n    await prisma.moneda.upsert({\r\n      where: { codigo: code },\r\n      update: {\r\n        nombre: name,\r\n        simbolo: symbol,\r\n        activo: true,\r\n        updated_at: new Date(),\r\n      },\r\n      create: {\r\n        nombre: name,\r\n        simbolo: symbol,\r\n        codigo: code,\r\n        activo: true,\r\n      },\r\n    })\r\n  }\r\n\r\n  console.log('Seed completed successfully.')\r\n  console.log(`Admin user: ${adminUsername}`)\r\n  console.log(`Admin password: ${adminPassword}`)\r\n  console.log(`Principal PuntoAtencion id: ${principal.id}`)\r\n}\r\n\r\nmain()\r\n  .catch((e) => {\r\n    console.error(e)\r\n    process.exit(1)\r\n  })\r\n  .finally(() => prisma.$disconnect())\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\oswal\\OneDrive\\Documentos\\Punto Cambio\\punto_cambio_new\\prisma\\seed-currencies-es.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\oswal\\OneDrive\\Documentos\\Punto Cambio\\punto_cambio_new\\scripts\\analizar-diferencia-usd.cjs","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\oswal\\OneDrive\\Documentos\\Punto Cambio\\punto_cambio_new\\scripts\\analizar-saldo-plaza-valle.cjs","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\oswal\\OneDrive\\Documentos\\Punto Cambio\\punto_cambio_new\\scripts\\cerrar-jornadas-abiertas.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\oswal\\OneDrive\\Documentos\\Punto Cambio\\punto_cambio_new\\scripts\\cerrar-jornadas-antiguas.ts","messages":[{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'ahora' is assigned a value but never used. Allowed unused vars must match /^_/u.","line":72,"column":11,"nodeType":null,"messageId":"unusedVar","endLine":72,"endColumn":16}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":1,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import { PrismaClient } from \"@prisma/client\";\r\n\r\nconst prisma = new PrismaClient();\r\n\r\nasync function cerrarJornadasAntiguas() {\r\n  try {\r\n    console.log(\"ÔòöÔòÉÔòÉÔòÉÔòÉÔòÉÔòÉÔòÉÔòÉÔòÉÔòÉÔòÉÔòÉÔòÉÔòÉÔòÉÔòÉÔòÉÔòÉÔòÉÔòÉÔòÉÔòÉÔòÉÔòÉÔòÉÔòÉÔòÉÔòÉÔòÉÔòÉÔòÉÔòÉÔòÉÔòÉÔòÉÔòÉÔòÉÔòÉÔòÉÔòÉÔòÉÔòÉÔòÉÔòÉÔòÉÔòÉÔòÉÔòÉÔòÉÔòÉÔòÉÔòù\");\r\n    console.log(\"Ôòæ     CERRANDO JORNADAS ANTIGUAS SIN CERRAR        Ôòæ\");\r\n    console.log(\"ÔòÜÔòÉÔòÉÔòÉÔòÉÔòÉÔòÉÔòÉÔòÉÔòÉÔòÉÔòÉÔòÉÔòÉÔòÉÔòÉÔòÉÔòÉÔòÉÔòÉÔòÉÔòÉÔòÉÔòÉÔòÉÔòÉÔòÉÔòÉÔòÉÔòÉÔòÉÔòÉÔòÉÔòÉÔòÉÔòÉÔòÉÔòÉÔòÉÔòÉÔòÉÔòÉÔòÉÔòÉÔòÉÔòÉÔòÉÔòÉÔòÉÔòÉÔòÉÔòÉÔòØ\\n\");\r\n\r\n    // Fecha l├¡mite: hace 2 d├¡as\r\n    const hace2Dias = new Date();\r\n    hace2Dias.setDate(hace2Dias.getDate() - 2);\r\n    hace2Dias.setHours(23, 59, 59, 999);\r\n\r\n    console.log(`­ƒôà Buscando jornadas anteriores a: ${hace2Dias.toLocaleString()}\\n`);\r\n\r\n    // Buscar jornadas antiguas sin cerrar\r\n    const jornadasAntiguas = await prisma.jornada.findMany({\r\n      where: {\r\n        fecha_salida: null,\r\n        estado: \"ACTIVO\",\r\n        fecha_inicio: {\r\n          lt: hace2Dias,\r\n        },\r\n      },\r\n      include: {\r\n        usuario: {\r\n          select: {\r\n            username: true,\r\n            nombre: true,\r\n          },\r\n        },\r\n        puntoAtencion: {\r\n          select: {\r\n            nombre: true,\r\n          },\r\n        },\r\n      },\r\n      orderBy: {\r\n        fecha_inicio: \"asc\",\r\n      },\r\n    });\r\n\r\n    if (jornadasAntiguas.length === 0) {\r\n      console.log(\"Ô£à No se encontraron jornadas antiguas sin cerrar\");\r\n      return;\r\n    }\r\n\r\n    console.log(`­ƒôï Encontradas ${jornadasAntiguas.length} jornada(s) antigua(s) sin cerrar:\\n`);\r\n\r\n    for (let i = 0; i < jornadasAntiguas.length; i++) {\r\n      const jornada = jornadasAntiguas[i];\r\n      const diasAtras = Math.floor(\r\n        (new Date().getTime() - jornada.fecha_inicio.getTime()) / (1000 * 60 * 60 * 24)\r\n      );\r\n      \r\n      console.log(`${i + 1}. Jornada ID: ${jornada.id}`);\r\n      console.log(`   Usuario: ${jornada.usuario.username} (${jornada.usuario.nombre})`);\r\n      console.log(`   Punto: ${jornada.puntoAtencion.nombre}`);\r\n      console.log(`   Inicio: ${jornada.fecha_inicio.toLocaleString()}`);\r\n      console.log(`   D├¡as atr├ís: ${diasAtras}`);\r\n      console.log(\"\");\r\n    }\r\n\r\n    console.log(\"ÔÜá´©Å  Estas jornadas ser├ín cerradas autom├íticamente...\");\r\n    console.log(\"    Continuando en 3 segundos...\\n\");\r\n\r\n    await new Promise((resolve) => setTimeout(resolve, 3000));\r\n\r\n    // Cerrar todas las jornadas antiguas\r\n    const ahora = new Date();\r\n    \r\n    for (const jornada of jornadasAntiguas) {\r\n      // Establecer fecha_salida al final del d├¡a en que inici├│\r\n      const fechaSalida = new Date(jornada.fecha_inicio);\r\n      fechaSalida.setHours(18, 0, 0, 0); // 6 PM del mismo d├¡a\r\n\r\n      await prisma.jornada.update({\r\n        where: { id: jornada.id },\r\n        data: {\r\n          fecha_salida: fechaSalida,\r\n          estado: \"COMPLETADO\",\r\n          observaciones: `Jornada cerrada autom├íticamente por sistema (qued├│ abierta desde ${jornada.fecha_inicio.toLocaleDateString()})`,\r\n        },\r\n      });\r\n\r\n      console.log(`Ô£à Jornada ${jornada.id} cerrada`);\r\n    }\r\n\r\n    console.log(`\\nÔ£à ├ëXITO: ${jornadasAntiguas.length} jornada(s) cerrada(s)`);\r\n    console.log(`   Fecha de cierre aplicada: fin del d├¡a de inicio de cada jornada\\n`);\r\n\r\n    // Verificar que se cerraron\r\n    const jornadasRestantes = await prisma.jornada.count({\r\n      where: {\r\n        fecha_salida: null,\r\n        estado: \"ACTIVO\",\r\n        fecha_inicio: {\r\n          lt: hace2Dias,\r\n        },\r\n      },\r\n    });\r\n\r\n    if (jornadasRestantes === 0) {\r\n      console.log(\"Ô£à Todas las jornadas antiguas fueron cerradas\");\r\n    } else {\r\n      console.log(`ÔÜá´©Å  A├║n quedan ${jornadasRestantes} jornada(s) antigua(s) abiertas`);\r\n    }\r\n  } catch (error) {\r\n    console.error(\"ÔØî Error cerrando jornadas antiguas:\", error);\r\n  } finally {\r\n    await prisma.$disconnect();\r\n  }\r\n}\r\n\r\ncerrarJornadasAntiguas();\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\oswal\\OneDrive\\Documentos\\Punto Cambio\\punto_cambio_new\\scripts\\corregir-ajuste-usd-plaza-valle.cjs","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\oswal\\OneDrive\\Documentos\\Punto Cambio\\punto_cambio_new\\scripts\\diagnosticar-cuadre.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\oswal\\OneDrive\\Documentos\\Punto Cambio\\punto_cambio_new\\scripts\\optimizar-monedas.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\oswal\\OneDrive\\Documentos\\Punto Cambio\\punto_cambio_new\\scripts\\recalculate-full-balance.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\oswal\\OneDrive\\Documentos\\Punto Cambio\\punto_cambio_new\\scripts\\reconcile-all-points.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\oswal\\OneDrive\\Documentos\\Punto Cambio\\punto_cambio_new\\scripts\\validar-estado-punto.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\oswal\\OneDrive\\Documentos\\Punto Cambio\\punto_cambio_new\\scripts\\verificar-ultimo-cierre.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\oswal\\OneDrive\\Documentos\\Punto Cambio\\punto_cambio_new\\server\\controllers\\reportController.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\oswal\\OneDrive\\Documentos\\Punto Cambio\\punto_cambio_new\\server\\controllers\\transferController.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\oswal\\OneDrive\\Documentos\\Punto Cambio\\punto_cambio_new\\server\\index.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\oswal\\OneDrive\\Documentos\\Punto Cambio\\punto_cambio_new\\server\\lib\\database.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\oswal\\OneDrive\\Documentos\\Punto Cambio\\punto_cambio_new\\server\\lib\\prisma.js","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\oswal\\OneDrive\\Documentos\\Punto Cambio\\punto_cambio_new\\server\\lib\\prisma.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\oswal\\OneDrive\\Documentos\\Punto Cambio\\punto_cambio_new\\server\\middleware\\auth.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\oswal\\OneDrive\\Documentos\\Punto Cambio\\punto_cambio_new\\server\\middleware\\authDebug.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\oswal\\OneDrive\\Documentos\\Punto Cambio\\punto_cambio_new\\server\\middleware\\autoReconciliation.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\oswal\\OneDrive\\Documentos\\Punto Cambio\\punto_cambio_new\\server\\middleware\\saldoValidation.ts","messages":[{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'tipo_transferencia' is assigned a value but never used. Allowed unused vars must match /^_/u.","line":282,"column":42,"nodeType":null,"messageId":"unusedVar","endLine":282,"endColumn":60},{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'divisas_recibidas_billetes' is assigned a value but never used. Allowed unused vars must match /^_/u.","line":351,"column":5,"nodeType":null,"messageId":"unusedVar","endLine":351,"endColumn":31},{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'divisas_recibidas_monedas' is assigned a value but never used. Allowed unused vars must match /^_/u.","line":352,"column":5,"nodeType":null,"messageId":"unusedVar","endLine":352,"endColumn":30}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":3,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import { Request, Response, NextFunction } from \"express\";\nimport prisma from \"../lib/prisma.js\";\nimport logger from \"../utils/logger.js\";\n\ninterface SaldoValidationRequest extends Request {\n  body: {\n    punto_atencion_id?: string;\n    moneda_id?: string;\n    monto?: number;\n    tipo_movimiento?: string;\n    tipo?: string;\n    // Para transferencias\n    punto_origen_id?: string;\n    punto_destino_id?: string;\n    // Para cambios de divisa\n    moneda_origen_id?: string;\n    moneda_destino_id?: string;\n    monto_origen?: number;\n    monto_destino?: number;\n  };\n}\n\n/**\n * Middleware para validar saldo suficiente antes de egresos\n * Solo bloquea EGRESOS, permite INGRESOS sin restricci├│n\n */\nexport async function validarSaldoSuficiente(\n  req: SaldoValidationRequest,\n  res: Response,\n  next: NextFunction\n) {\n  try {\n    const { body } = req;\n\n    // Determinar si es un egreso que requiere validaci├│n\n    const esEgreso = esOperacionEgreso(body);\n\n    if (!esEgreso) {\n      // Si no es egreso, permitir sin validaci├│n\n      return next();\n    }\n\n    // Validar saldo para egresos\n    const validaciones = await obtenerValidacionesRequeridas(body);\n\n    for (const validacion of validaciones) {\n      const saldoActual = await obtenerSaldoActual(\n        validacion.puntoAtencionId,\n        validacion.monedaId\n      );\n\n      if (saldoActual < validacion.montoRequerido) {\n        // Obtener desglose de billetes, monedas y bancos\n        const saldo = await prisma.saldo.findUnique({\n          where: {\n            punto_atencion_id_moneda_id: {\n              punto_atencion_id: validacion.puntoAtencionId,\n              moneda_id: validacion.monedaId,\n            },\n          },\n        });\n        const saldoBilletes = Number(saldo?.billetes || 0);\n        const saldoMonedas = Number(saldo?.monedas_fisicas || 0);\n        const saldoBancos = Number(saldo?.bancos || 0);\n        return res.status(400).json({\n          error: \"SALDO_INSUFICIENTE\",\n          message: `Saldo insuficiente en ${validacion.puntoNombre}. Saldo actual: $${saldoActual.toFixed(2)} (${saldoBilletes.toFixed(2)} billetes, ${saldoMonedas.toFixed(2)} monedas, ${saldoBancos.toFixed(2)} banco) ${validacion.monedaCodigo}, requerido: $${validacion.montoRequerido.toFixed(2)}`,\n          details: {\n            punto: validacion.puntoNombre,\n            moneda: validacion.monedaCodigo,\n            saldoActual: saldoActual,\n            saldoBilletes,\n            saldoMonedas,\n            saldoBancos,\n            montoRequerido: validacion.montoRequerido,\n            deficit: validacion.montoRequerido - saldoActual,\n          },\n        });\n      }\n    }\n\n    // Si todas las validaciones pasan, continuar\n    next();\n  } catch (error) {\n    logger.error(\"Error en validaci├│n de saldo:\", {\n      error: error instanceof Error ? error.message : String(error),\n      stack: error instanceof Error ? error.stack : undefined,\n    });\n    res.status(500).json({\n      error: \"ERROR_VALIDACION_SALDO\",\n      message: \"Error interno al validar saldo\",\n    });\n  }\n}\n\n/**\n * Determina si una operaci├│n es un egreso que requiere validaci├│n\n */\ntype RequestBodyRecord = Record<string, unknown>;\n\nfunction isRecord(value: unknown): value is RequestBodyRecord {\n  return typeof value === \"object\" && value !== null && !Array.isArray(value);\n}\n\nfunction getIdFromBody(body: RequestBodyRecord, key: string): string | undefined {\n  const value = body[key];\n  if (typeof value === \"string\") return value;\n  if (typeof value === \"number\" && Number.isFinite(value)) return String(value);\n  return undefined;\n}\n\nfunction getStringFromBody(\n  body: RequestBodyRecord,\n  key: string\n): string | undefined {\n  const value = body[key];\n  return typeof value === \"string\" ? value : undefined;\n}\n\nfunction esOperacionEgreso(body: unknown): boolean {\n  if (!isRecord(body)) return false;\n  // Casos de egreso directo\n  if (\n    typeof body.tipo_movimiento === \"string\" &&\n    [\"EGRESO\", \"RETIRO\", \"PAGO\", \"TRANSFERENCIA_SALIDA\"].includes(\n      body.tipo_movimiento\n    )\n  ) {\n    return true;\n  }\n\n  if (typeof body.tipo === \"string\" && [\"EGRESO\", \"RETIRO\", \"PAGO\"].includes(body.tipo)) {\n    return true;\n  }\n\n  // Para transferencias (el punto origen hace egreso)\n  const monto = body.monto;\n  if (getIdFromBody(body, \"punto_origen_id\") && monto && Number(monto) > 0) {\n    return true;\n  }\n\n  // Para cambios de divisa (validar moneda origen)\n  const montoOrigen = body.monto_origen;\n  if (\n    getIdFromBody(body, \"moneda_origen_id\") &&\n    montoOrigen &&\n    Number(montoOrigen) > 0\n  ) {\n    return true;\n  }\n\n  // Casos espec├¡ficos por endpoint\n  const url = getStringFromBody(body, \"_url\") || \"\";\n  if (\n    url.includes(\"/transfers\") ||\n    url.includes(\"/exchanges\") ||\n    url.includes(\"/spontaneous-exits\")\n  ) {\n    return true;\n  }\n\n  return false;\n}\n\n/**\n * Obtiene las validaciones requeridas seg├║n el tipo de operaci├│n\n */\nasync function obtenerValidacionesRequeridas(body: unknown): Promise<\n  Array<{\n    puntoAtencionId: string;\n    monedaId: string;\n    montoRequerido: number;\n    puntoNombre: string;\n    monedaCodigo: string;\n  }>\n> {\n  if (!isRecord(body)) return [];\n  const validaciones: Array<{\n    puntoAtencionId: string;\n    monedaId: string;\n    montoRequerido: number;\n    puntoNombre: string;\n    monedaCodigo: string;\n  }> = [];\n\n  // Egreso directo\n  const puntoAtencionId = getIdFromBody(body, \"punto_atencion_id\");\n  const monedaId = getIdFromBody(body, \"moneda_id\");\n  const monto = body.monto;\n  if (puntoAtencionId && monedaId && monto) {\n    const punto = await prisma.puntoAtencion.findUnique({\n      where: { id: puntoAtencionId },\n    });\n    const moneda = await prisma.moneda.findUnique({\n      where: { id: monedaId },\n    });\n\n    validaciones.push({\n      puntoAtencionId,\n      monedaId,\n      montoRequerido: Math.abs(Number(monto)),\n      puntoNombre: punto?.nombre || \"Desconocido\",\n      monedaCodigo: moneda?.codigo || \"Desconocido\",\n    });\n  }\n\n  // Transferencia (validar punto origen)\n  const puntoOrigenId = getIdFromBody(body, \"punto_origen_id\");\n  if (puntoOrigenId && monedaId && monto) {\n    const punto = await prisma.puntoAtencion.findUnique({\n      where: { id: puntoOrigenId },\n    });\n    const moneda = await prisma.moneda.findUnique({\n      where: { id: monedaId },\n    });\n\n    validaciones.push({\n      puntoAtencionId: puntoOrigenId,\n      monedaId,\n      montoRequerido: Number(monto),\n      puntoNombre: punto?.nombre || \"Desconocido\",\n      monedaCodigo: moneda?.codigo || \"Desconocido\",\n    });\n  }\n\n  // Cambio de divisa (validar moneda origen)\n  const monedaOrigenId = getIdFromBody(body, \"moneda_origen_id\");\n  const montoOrigen = body.monto_origen;\n  if (puntoAtencionId && monedaOrigenId && montoOrigen) {\n    const punto = await prisma.puntoAtencion.findUnique({\n      where: { id: puntoAtencionId },\n    });\n    const moneda = await prisma.moneda.findUnique({\n      where: { id: monedaOrigenId },\n    });\n\n    validaciones.push({\n      puntoAtencionId,\n      monedaId: monedaOrigenId,\n      montoRequerido: Number(montoOrigen),\n      puntoNombre: punto?.nombre || \"Desconocido\",\n      monedaCodigo: moneda?.codigo || \"Desconocido\",\n    });\n  }\n\n  return validaciones;\n}\n\n/**\n * Obtiene el saldo actual de un punto para una moneda espec├¡fica\n * Incluye billetes, monedas f├¡sicas Y bancos (dep├│sitos)\n */\nasync function obtenerSaldoActual(\n  puntoAtencionId: string,\n  monedaId: string\n): Promise<number> {\n  const saldo = await prisma.saldo.findUnique({\n    where: {\n      punto_atencion_id_moneda_id: {\n        punto_atencion_id: puntoAtencionId,\n        moneda_id: monedaId,\n      },\n    },\n  });\n\n  // Retornar la suma de billetes, monedas f├¡sicas Y bancos\n  const saldoBilletes = Number(saldo?.billetes || 0);\n  const saldoMonedas = Number(saldo?.monedas_fisicas || 0);\n  const saldoBancos = Number(saldo?.bancos || 0);\n  return saldoBilletes + saldoMonedas + saldoBancos;\n}\n\n/**\n * Middleware espec├¡fico para transferencias\n */\nexport async function validarSaldoTransferencia(\n  req: Request,\n  res: Response,\n  next: NextFunction\n) {\n  try {\n    const { origen_id, moneda_id, monto, tipo_transferencia } = req.body;\n\n    // Para transferencias sin origen (DEPOSITO_GERENCIA, DEPOSITO_MATRIZ), no validar saldo\n    if (!origen_id) {\n      return next();\n    }\n\n    if (!moneda_id || !monto) {\n      return res.status(400).json({\n        error: \"DATOS_INCOMPLETOS\",\n        message: \"Faltan datos requeridos para la transferencia\",\n      });\n    }\n\n    const saldoActual = await obtenerSaldoActual(origen_id, moneda_id);\n    const montoRequerido = Number(monto);\n\n    if (saldoActual < montoRequerido) {\n      const punto = await prisma.puntoAtencion.findUnique({\n        where: { id: origen_id },\n      });\n      const moneda = await prisma.moneda.findUnique({\n        where: { id: moneda_id },\n      });\n\n      return res.status(400).json({\n        error: \"SALDO_INSUFICIENTE_TRANSFERENCIA\",\n        message: `Saldo insuficiente para transferencia desde ${punto?.nombre}`,\n        details: {\n          puntoOrigen: punto?.nombre,\n          moneda: moneda?.codigo,\n          saldoActual: saldoActual,\n          montoRequerido: montoRequerido,\n          deficit: montoRequerido - saldoActual,\n        },\n      });\n    }\n\n    next();\n  } catch (error) {\n    logger.error(\"Error validando saldo para transferencia:\", {\n      error: error instanceof Error ? error.message : String(error),\n      stack: error instanceof Error ? error.stack : undefined,\n    });\n    res.status(500).json({\n      error: \"ERROR_VALIDACION_TRANSFERENCIA\",\n      message: \"Error interno al validar saldo para transferencia\",\n    });\n  }\n}\n\n/**\n * Middleware espec├¡fico para cambios de divisa\n * Aplica la misma l├│gica de normalizaci├│n que el endpoint de exchanges\n * para validar la moneda correcta seg├║n el tipo de operaci├│n\n * Ô£à VALIDA BILLETES Y MONEDAS POR SEPARADO\n */\nexport async function validarSaldoCambioDivisa(\n  req: Request,\n  res: Response,\n  next: NextFunction\n) {\n  const {\n    punto_atencion_id,\n    moneda_origen_id,\n    moneda_destino_id,\n    monto_origen,\n    monto_destino,\n    tipo_operacion,\n    divisas_recibidas_billetes,\n    divisas_recibidas_monedas,\n    metodo_entrega,\n    usd_entregado_efectivo,\n    usd_entregado_transfer,\n  } = req.body;\n\n  try {\n    if (\n      !punto_atencion_id ||\n      !moneda_origen_id ||\n      !moneda_destino_id ||\n      !monto_origen ||\n      !tipo_operacion\n    ) {\n      return res.status(400).json({\n        error: \"DATOS_INCOMPLETOS\",\n        message: \"Faltan datos requeridos para el cambio de divisa\",\n      });\n    }\n\n    // Ô£à VALIDAR QUE EL PUNTO DE ATENCI├ôN EXISTA\n    const punto = await prisma.puntoAtencion.findUnique({\n      where: { id: punto_atencion_id },\n    });\n\n    if (!punto) {\n      logger.error(\"Punto de atenci├│n no encontrado en validaci├│n\", {\n        punto_atencion_id,\n      });\n      return res.status(400).json({\n        error: \"PUNTO_NO_ENCONTRADO\",\n        message: `El punto de atenci├│n especificado no fue encontrado`,\n        details: {\n          puntoId: punto_atencion_id,\n        },\n      });\n    }\n\n    // Ô£à VALIDAR QUE AMBAS MONEDAS EXISTAN\n    const [monedaOrigenVal, monedaDestinoVal] = await Promise.all([\n      prisma.moneda.findUnique({ where: { id: moneda_origen_id } }),\n      prisma.moneda.findUnique({ where: { id: moneda_destino_id } }),\n    ]);\n\n    if (!monedaOrigenVal) {\n      logger.error(\"Moneda origen no encontrada en validaci├│n\", {\n        moneda_origen_id,\n      });\n      return res.status(400).json({\n        error: \"MONEDA_ORIGEN_NO_ENCONTRADA\",\n        message: `La moneda origen especificada no fue encontrada`,\n        details: {\n          monedaId: moneda_origen_id,\n        },\n      });\n    }\n\n    if (!monedaDestinoVal) {\n      logger.error(\"Moneda destino no encontrada en validaci├│n\", {\n        moneda_destino_id,\n      });\n      return res.status(400).json({\n        error: \"MONEDA_DESTINO_NO_ENCONTRADA\",\n        message: `La moneda destino especificada no fue encontrada`,\n        details: {\n          monedaId: moneda_destino_id,\n        },\n      });\n    }\n\n    // ­ƒöä NORMALIZACI├ôN: Validar la moneda que el PUNTO ENTREGA (egreso)\n    // COMPRA -> El cliente trae divisas y el punto PAGA EN USD -> Validar DESTINO (USD que sale)\n    // VENTA -> El cliente trae USD y el punto ENTREGA DIVISAS -> Validar DESTINO (divisas que salen)\n    \n    // Por defecto: Validamos DESTINO (lo que el punto entrega al cliente)\n    const monedaValidar = moneda_destino_id;\n    const montoValidar = Number(monto_destino);\n\n    logger.info(\"[VALIDACION_CAMBIO_DIVISA] Determinando moneda a validar\", {\n      tipo_operacion,\n      moneda_origen_id,\n      moneda_destino_id,\n      monto_origen,\n      monto_destino,\n    });\n\n    try {\n      const usdMoneda = await prisma.moneda.findFirst({\n        where: { codigo: \"USD\" },\n      });\n\n      if (\n        usdMoneda &&\n        (moneda_origen_id === usdMoneda.id ||\n          moneda_destino_id === usdMoneda.id)\n      ) {\n        const isCompra = tipo_operacion === \"COMPRA\";\n        const isVenta = tipo_operacion === \"VENTA\";\n\n        // COMPRA: Cliente trae divisas, punto PAGA USD -> Validar USD (destino)\n        // VENTA: Cliente trae USD, punto ENTREGA divisas -> Validar divisas (destino)\n        // En ambos casos, validamos DESTINO, as├¡ que no necesitamos hacer nada especial\n        \n        logger.info(\"[VALIDACION_CAMBIO_DIVISA] Moneda USD detectada\", {\n          isCompra,\n          isVenta,\n          monedaValidar,\n          montoValidar,\n        });\n      }\n    } catch (e) {\n      logger.warn(\"No se pudo normalizar par USD en validaci├│n (continuando)\", {\n        error: e instanceof Error ? e.message : String(e),\n      });\n    }\n\n    // Ô£à VALIDAR MONEDA EXISTE ANTES DE CONTINUAR\n    const moneda = await prisma.moneda.findUnique({\n      where: { id: monedaValidar },\n    });\n\n    if (!moneda) {\n      logger.error(\"Moneda no encontrada en validaci├│n\", {\n        monedaValidar,\n        moneda_origen_id,\n        moneda_destino_id,\n      });\n      return res.status(400).json({\n        error: \"MONEDA_NO_ENCONTRADA\",\n        message: `La moneda especificada no fue encontrada`,\n        details: {\n          monedaId: monedaValidar,\n        },\n      });\n    }\n\n    // Ô£à VALIDAR SALDO TOTAL Y BILLETES/MONEDAS POR SEPARADO\n    const saldo = await prisma.saldo.findUnique({\n      where: {\n        punto_atencion_id_moneda_id: {\n          punto_atencion_id: punto_atencion_id,\n          moneda_id: monedaValidar,\n        },\n      },\n    });\n\n    let saldoBilletes = Number(saldo?.billetes || 0);\n    const saldoMonedas = Number(saldo?.monedas_fisicas || 0);\n    const saldoBancos = Number(saldo?.bancos || 0);\n    \n    // Calcular saldo total incluyendo billetes, monedas y bancos\n    const saldoTotal = saldoBilletes + saldoMonedas + saldoBancos;\n\n    // Fallback: si ambos f├¡sicos son 0 pero el total es mayor a 0, usar el total como billetes\n    if (saldoBilletes === 0 && saldoMonedas === 0 && saldoTotal > 0) {\n      saldoBilletes = saldoTotal;\n    }\n\n\n    // Calcular cu├ínto efectivo se necesita (excluyendo transferencias)\n    let efectivoRequerido = montoValidar;\n\n    // Si es USD y hay transferencia, restar del requerimiento de efectivo\n    if (moneda.codigo === \"USD\" && metodo_entrega) {\n      if (metodo_entrega === \"transferencia\") {\n        efectivoRequerido = 0; // Todo por transferencia\n      } else if (metodo_entrega === \"mixto\") {\n        efectivoRequerido = Number(usd_entregado_efectivo || 0);\n      }\n    }\n\n    // LOG DETALLADO PARA DEPURACI├ôN DE SALDO F├ìSICO\n    logger.info(\"[VALIDACION_CAMBIO_DIVISA] Estado previo a validaci├│n de saldo f├¡sico\", {\n      punto_atencion_id,\n      monedaValidar,\n      saldoTotal,\n      saldoBilletes,\n      saldoMonedas,\n      efectivoRequerido,\n      metodo_entrega,\n      usd_entregado_efectivo,\n      usd_entregado_transfer,\n      montoValidar,\n      tipo_operacion,\n      moneda_origen_id,\n      moneda_destino_id,\n      monto_origen,\n      monto_destino,\n    });\n\n    // Validar saldo total de efectivo\n    if (saldoTotal < efectivoRequerido) {\n      const punto = await prisma.puntoAtencion.findUnique({\n        where: { id: punto_atencion_id },\n      });\n\n      logger.warn(\"[VALIDACION_CAMBIO_DIVISA] Saldo total insuficiente\", {\n        punto: punto?.nombre,\n        moneda: moneda?.codigo,\n        saldoActual: saldoTotal,\n        montoRequerido: efectivoRequerido,\n        deficit: efectivoRequerido - saldoTotal,\n      });\n\n      return res.status(400).json({\n        error: \"SALDO_INSUFICIENTE_CAMBIO\",\n        message: `Saldo total insuficiente para cambio de divisa en ${punto?.nombre}`,\n        details: {\n          punto: punto?.nombre,\n          moneda: moneda?.codigo,\n          saldoActual: saldoTotal,\n          montoRequerido: efectivoRequerido,\n          deficit: efectivoRequerido - saldoTotal,\n        },\n      });\n    }\n\n    // Ô£à VALIDAR DISPONIBILIDAD DE EFECTIVO F├ìSICO\n    // IMPORTANTE: No validamos proporciones espec├¡ficas de billetes/monedas\n    // porque el cliente especifica c├│mo quiere RECIBIR, pero el punto entrega lo que TIENE\n    // Simplemente validamos que hay SUFICIENTE dinero f├¡sico en total\n    \n    if (efectivoRequerido > 0) {\n      const saldoFisicoTotal = saldoBilletes + saldoMonedas;\n\n      logger.info(\"[VALIDACION_CAMBIO_DIVISA] Validando saldo f├¡sico total\", {\n        saldoFisicoTotal,\n        saldoBilletes,\n        saldoMonedas,\n        efectivoRequerido,\n      });\n      \n      // Validaci├│n principal: ┬┐hay suficiente dinero f├¡sico?\n      if (saldoFisicoTotal < efectivoRequerido) {\n        const punto = await prisma.puntoAtencion.findUnique({\n          where: { id: punto_atencion_id },\n        });\n\n        logger.warn(\"[VALIDACION_CAMBIO_DIVISA] Saldo f├¡sico insuficiente\", {\n          punto: punto?.nombre,\n          moneda: moneda?.codigo,\n          saldoFisicoTotal,\n          saldoBilletes,\n          saldoMonedas,\n          efectivoRequerido,\n          deficit: efectivoRequerido - saldoFisicoTotal,\n        });\n\n        return res.status(400).json({\n          error: \"SALDO_INSUFICIENTE_CAMBIO\",\n          message: `Saldo f├¡sico insuficiente en ${moneda?.codigo} para realizar el cambio en ${punto?.nombre}. Disponible: ${saldoFisicoTotal.toFixed(2)} (${saldoBilletes.toFixed(2)} billetes + ${saldoMonedas.toFixed(2)} monedas), Requerido: ${efectivoRequerido.toFixed(2)}`,\n          details: {\n            punto: punto?.nombre,\n            moneda: moneda?.codigo,\n            saldoFisicoTotal: saldoFisicoTotal,\n            saldoBilletes: saldoBilletes,\n            saldoMonedas: saldoMonedas,\n            efectivoRequerido: efectivoRequerido,\n            deficit: efectivoRequerido - saldoFisicoTotal,\n            nota: \"El sistema intentar├í usar billetes y monedas seg├║n lo disponible\",\n          },\n        });\n      }\n    }\n\n    next();\n  } catch (error) {\n    // Confirmar entrada al catch\n    console.log(\"Entrando a catch de validaci├│n de cambio de divisa\");\n    // Log detallado del error para stacktrace\n    console.error(\"[VALIDACION_CAMBIO_DIVISA][ERROR]\", error);\n    logger.error(\"Error validando saldo para cambio de divisa:\", {\n      error: error instanceof Error ? error.message : String(error),\n      stack: error instanceof Error ? error.stack : undefined,\n      detalles: {\n        punto_atencion_id: punto_atencion_id || \"undefined\",\n        moneda_origen_id: moneda_origen_id || \"undefined\",\n        moneda_destino_id: moneda_destino_id || \"undefined\",\n        monto_origen: monto_origen || \"undefined\",\n      },\n    });\n    res.status(500).json({\n      error: \"ERROR_VALIDACION_CAMBIO\",\n      message: \"Error interno al validar saldo para cambio de divisa\",\n    });\n  }\n}\n\nexport default {\n  validarSaldoSuficiente,\n  validarSaldoTransferencia,\n  validarSaldoCambioDivisa,\n};\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\oswal\\OneDrive\\Documentos\\Punto Cambio\\punto_cambio_new\\server\\middleware\\typeValidation.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\oswal\\OneDrive\\Documentos\\Punto Cambio\\punto_cambio_new\\server\\middleware\\validation.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\oswal\\OneDrive\\Documentos\\Punto Cambio\\punto_cambio_new\\server\\migrations\\create-servicios-externos-tables.js","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\oswal\\OneDrive\\Documentos\\Punto Cambio\\punto_cambio_new\\server\\routes\\activePoints.ts","messages":[{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'isAdminLike' is assigned a value but never used. Allowed unused vars must match /^_/u.","line":49,"column":13,"nodeType":null,"messageId":"unusedVar","endLine":49,"endColumn":24}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":1,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import express from \"express\";\r\nimport prisma from \"../lib/prisma.js\";\r\nimport logger from \"../utils/logger.js\";\r\nimport { authenticateToken } from \"../middleware/auth.js\";\r\nimport { gyeDayRangeUtcFromDate } from \"../utils/timezone.js\";\r\nimport { EstadoJornada } from \"@prisma/client\";\r\n\r\nconst router = express.Router();\r\n\r\n// Estados que bloquean el punto (ocupado)\r\nconst ESTADOS_OCUPADOS: EstadoJornada[] = [\r\n  EstadoJornada.ACTIVO,\r\n  EstadoJornada.ALMUERZO,\r\n];\r\n\r\n/** Util: setea cabeceras no-cache */\r\nfunction setNoCache(res: express.Response) {\r\n  res.set({\r\n    \"Cache-Control\": \"no-store, no-cache, must-revalidate, proxy-revalidate\",\r\n    Pragma: \"no-cache\",\r\n    Expires: \"0\",\r\n    \"Surrogate-Control\": \"no-store\",\r\n  });\r\n}\r\n\r\n/** Serializaci├│n segura de fechas */\r\nfunction toISO(d: Date | null | undefined) {\r\n  return d instanceof Date ? d.toISOString() : null;\r\n}\r\n\r\n/**\r\n * GET /api/points\r\n * Puntos libres (sin jornada en estado ACTIVO/ALMUERZO en el d├¡a GYE)\r\n * Reglas por rol:\r\n *  - OPERADOR: ver solo puntos activos que NO est├®n ocupados hoy.\r\n *  - ADMINISTRATIVO / ADMIN / SUPER_USUARIO: por defecto ver puntos activos (diagn├│stico).\r\n */\r\nrouter.get(\r\n  \"/\",\r\n  authenticateToken,\r\n  async (req: express.Request, res: express.Response): Promise<void> => {\r\n    try {\r\n      setNoCache(res);\r\n\r\n      const { gte: hoy, lt: manana } = gyeDayRangeUtcFromDate(new Date());\r\n\r\n      const rol = req.user?.rol || \"\";\r\n      const isOperador = rol === \"OPERADOR\";\r\n      const isAdminLike =\r\n        rol === \"ADMIN\" || rol === \"SUPER_USUARIO\" || rol === \"ADMINISTRATIVO\";\r\n\r\n      // Base: puntos activos\r\n      const whereOperador = {\r\n        activo: true,\r\n        NOT: {\r\n          jornadas: {\r\n            some: {\r\n              estado: { in: ESTADOS_OCUPADOS },\r\n              fecha_inicio: { gte: hoy, lt: manana },\r\n              // Ocupado solo si la jornada es de roles que bloquean el punto\r\n              usuario: { rol: { in: [\"OPERADOR\", \"CONCESION\"] } },\r\n            },\r\n          },\r\n        },\r\n      };\r\n\r\n      const whereAdminLike = { activo: true };\r\n\r\n      const puntos = await prisma.puntoAtencion.findMany({\r\n        where: isOperador ? whereOperador : whereAdminLike,\r\n        select: {\r\n          id: true,\r\n          nombre: true,\r\n          direccion: true,\r\n          ciudad: true,\r\n          provincia: true,\r\n          codigo_postal: true,\r\n          telefono: true,\r\n          activo: true,\r\n          created_at: true,\r\n          updated_at: true,\r\n        },\r\n        orderBy: { nombre: \"asc\" },\r\n      });\r\n\r\n      const formatted = puntos.map((p) => ({\r\n        id: p.id,\r\n        nombre: p.nombre,\r\n        direccion: p.direccion,\r\n        ciudad: p.ciudad,\r\n        provincia: p.provincia,\r\n        codigo_postal: p.codigo_postal,\r\n        telefono: p.telefono,\r\n        activo: p.activo,\r\n        created_at: toISO(p.created_at),\r\n        updated_at: toISO(p.updated_at),\r\n      }));\r\n\r\n      logger.info(\"Puntos libres obtenidos\", {\r\n        count: formatted.length,\r\n        role: rol,\r\n        requestedBy: req.user?.id,\r\n      });\r\n\r\n      res.status(200).json({\r\n        points: formatted,\r\n        success: true,\r\n        timestamp: new Date().toISOString(),\r\n      });\r\n    } catch (error) {\r\n      logger.error(\"Error al obtener puntos libres\", {\r\n        error: error instanceof Error ? error.message : \"Unknown error\",\r\n        stack: error instanceof Error ? error.stack : undefined,\r\n        requestedBy: req.user?.id,\r\n      });\r\n\r\n      res.status(500).json({\r\n        error: \"Error al obtener puntos libres\",\r\n        success: false,\r\n        timestamp: new Date().toISOString(),\r\n      });\r\n    }\r\n  }\r\n);\r\n\r\n/**\r\n * GET /api/points/occupied\r\n * Lista IDs de puntos ocupados hoy (ACTIVO o ALMUERZO en el d├¡a GYE)\r\n */\r\nrouter.get(\r\n  \"/occupied\",\r\n  authenticateToken,\r\n  async (req: express.Request, res: express.Response): Promise<void> => {\r\n    try {\r\n      setNoCache(res);\r\n\r\n      const { gte: hoy, lt: manana } = gyeDayRangeUtcFromDate(new Date());\r\n\r\n      // Distinct por punto para evitar duplicados si hay m├ís de una jornada sobre el mismo punto\r\n      const jornadas = await prisma.jornada.findMany({\r\n        where: {\r\n          estado: { in: ESTADOS_OCUPADOS },\r\n          fecha_inicio: { gte: hoy, lt: manana },\r\n          // Contabilizar ocupados solo de operadores/concesi├│n\r\n          usuario: { rol: { in: [\"OPERADOR\", \"CONCESION\"] } },\r\n        },\r\n        select: {\r\n          punto_atencion_id: true,\r\n        },\r\n      });\r\n\r\n      // De-dup en memoria (por si la versi├│n de Prisma no soporta distinct en este modelo)\r\n      const ocupadosSet = new Set<string>();\r\n      for (const j of jornadas) {\r\n        if (j.punto_atencion_id) ocupadosSet.add(j.punto_atencion_id);\r\n      }\r\n      const puntosIds = Array.from(ocupadosSet).map((id) => ({ id }));\r\n\r\n      logger.info(\"Puntos ocupados obtenidos\", {\r\n        count: puntosIds.length,\r\n        requestedBy: req.user?.id,\r\n      });\r\n\r\n      res.status(200).json({\r\n        puntos: puntosIds,\r\n        success: true,\r\n        timestamp: new Date().toISOString(),\r\n      });\r\n    } catch (error) {\r\n      logger.error(\"Error al obtener puntos ocupados\", {\r\n        error: error instanceof Error ? error.message : \"Unknown error\",\r\n        stack: error instanceof Error ? error.stack : undefined,\r\n        requestedBy: req.user?.id,\r\n      });\r\n\r\n      res.status(500).json({\r\n        error: \"Error al obtener puntos ocupados\",\r\n        success: false,\r\n        timestamp: new Date().toISOString(),\r\n      });\r\n    }\r\n  }\r\n);\r\n\r\nexport default router;\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\oswal\\OneDrive\\Documentos\\Punto Cambio\\punto_cambio_new\\server\\routes\\auth.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\oswal\\OneDrive\\Documentos\\Punto Cambio\\punto_cambio_new\\server\\routes\\balance-completo.ts","messages":[{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'BalancePorPunto' is defined but never used. Allowed unused vars must match /^_/u.","line":32,"column":11,"nodeType":null,"messageId":"unusedVar","endLine":32,"endColumn":26}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":1,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import express from \"express\";\r\nimport { authenticateToken } from \"../middleware/auth.js\";\r\nimport prisma from \"../lib/prisma.js\";\r\nimport { Prisma } from \"@prisma/client\";\r\n\r\nconst router = express.Router();\r\n\r\ntype D = Prisma.Decimal;\r\n\r\ninterface BalanceMonedaRaw {\r\n  monedaId: string;\r\n  codigo: string;\r\n  nombre: string;\r\n  balance: D;\r\n  detalles: {\r\n    cambiosDivisasOrigen: D; // (salidas) se mostrar├í en negativo\r\n    cambiosDivisasDestino: D; // (entradas)\r\n    serviciosExternosIngresos: D;\r\n    serviciosExternosEgresos: D; // se mostrar├í en negativo\r\n    transferenciasNetas: D; // destino - origen\r\n  };\r\n}\r\n\r\ninterface ResumenGeneral {\r\n  totalCambiosDivisas: number;\r\n  totalServiciosExternos: number;\r\n  totalTransferencias: number;\r\n  totalPuntosActivos: number;\r\n  totalMonedasActivas: number;\r\n}\r\n\r\ninterface BalancePorPunto {\r\n  punto: string;\r\n  puntoId: string;\r\n  cambiosDivisas: number;\r\n  serviciosExternos: number;\r\n  transferenciasOrigen: number;\r\n  transferenciasDestino: number;\r\n  totalMovimientos: number;\r\n}\r\n\r\n/** Helpers num├®ricos */\r\nconst d0 = () => new Prisma.Decimal(0);\r\nconst toNum = (x: D | null | undefined) => Number((x ?? d0()).toString());\r\n\r\n/* ============================================================================\r\n   GET /api/balance-completo\r\n   Resumen general y balance por moneda (agregado sistema)\r\n============================================================================ */\r\nrouter.get(\"/\", authenticateToken, async (req, res) => {\r\n  try {\r\n    console.log(\"­ƒöì Calculando balance completo del sistema...\");\r\n\r\n    // 1) Resumen general (paralelo)\r\n    const [\r\n      cambiosDivisas,\r\n      serviciosExternos,\r\n      transferencias,\r\n      puntosActivos,\r\n      monedasActivas,\r\n    ] = await Promise.all([\r\n      prisma.cambioDivisa.count({ where: { estado: \"COMPLETADO\" } }),\r\n      prisma.servicioExternoMovimiento.count(),\r\n      prisma.transferencia.count({ where: { estado: \"APROBADO\" } }),\r\n      prisma.puntoAtencion.count({ where: { activo: true } }),\r\n      prisma.moneda.count({ where: { activo: true } }),\r\n    ]);\r\n\r\n    const resumenGeneral: ResumenGeneral = {\r\n      totalCambiosDivisas: cambiosDivisas,\r\n      totalServiciosExternos: serviciosExternos,\r\n      totalTransferencias: transferencias,\r\n      totalPuntosActivos: puntosActivos,\r\n      totalMonedasActivas: monedasActivas,\r\n    };\r\n\r\n    // 2) Balance por moneda (solo activas)\r\n    const monedas = await prisma.moneda.findMany({\r\n      where: { activo: true },\r\n      orderBy: { codigo: \"asc\" },\r\n      select: { id: true, codigo: true, nombre: true },\r\n    });\r\n\r\n    const balancesRaw: BalanceMonedaRaw[] = [];\r\n\r\n    for (const moneda of monedas) {\r\n      // Ejecutar agregados en paralelo para esta moneda\r\n      const [\r\n        // Cambios: moneda como ORIGEN (salida) y DESTINO (entrada)\r\n        cambiosOrigenAgg,\r\n        cambiosDestinoAgg,\r\n        // Servicios externos: ingresos/egresos\r\n        serviciosIngresosAgg,\r\n        serviciosEgresosAgg,\r\n        // Transferencias separadas\r\n        sumDestAgg, // entradas por destino (destino_id es obligatorio en el schema)\r\n        sumOrigAgg, // salidas por origen (origen_id nullable; filtramos no-nulo)\r\n      ] = await Promise.all([\r\n        prisma.cambioDivisa.aggregate({\r\n          where: { moneda_origen_id: moneda.id, estado: \"COMPLETADO\" },\r\n          _sum: { monto_origen: true },\r\n        }),\r\n        prisma.cambioDivisa.aggregate({\r\n          where: { moneda_destino_id: moneda.id, estado: \"COMPLETADO\" },\r\n          _sum: { monto_destino: true },\r\n        }),\r\n        prisma.servicioExternoMovimiento.aggregate({\r\n          where: { moneda_id: moneda.id, tipo_movimiento: \"INGRESO\" },\r\n          _sum: { monto: true },\r\n        }),\r\n        prisma.servicioExternoMovimiento.aggregate({\r\n          where: { moneda_id: moneda.id, tipo_movimiento: \"EGRESO\" },\r\n          _sum: { monto: true },\r\n        }),\r\n        // Ô×ñ FIX 1: NO filtrar destino_id not null (campo no es null); basta por moneda/estado\r\n        prisma.transferencia.aggregate({\r\n          where: { estado: \"APROBADO\", moneda_id: moneda.id },\r\n          _sum: { monto: true },\r\n        }),\r\n        // origen_id s├¡ es nullable; filtramos expl├¡citamente no-nulo\r\n        prisma.transferencia.aggregate({\r\n          where: {\r\n            estado: \"APROBADO\",\r\n            moneda_id: moneda.id,\r\n            origen_id: { not: null },\r\n          },\r\n          _sum: { monto: true },\r\n        }),\r\n      ]);\r\n\r\n      const cambiosDivisasOrigen = cambiosOrigenAgg._sum.monto_origen ?? d0();\r\n      const cambiosDivisasDestino =\r\n        cambiosDestinoAgg._sum.monto_destino ?? d0();\r\n      const serviciosExternosIngresos = serviciosIngresosAgg._sum.monto ?? d0();\r\n      const serviciosExternosEgresos = serviciosEgresosAgg._sum.monto ?? d0();\r\n\r\n      // Ô×ñ FIX 2: _sum puede ser undefined; usar optional chaining y nullish coalescing\r\n      const transferIn = (sumDestAgg._sum?.monto as D | undefined) ?? d0();\r\n      const transferOut = (sumOrigAgg._sum?.monto as D | undefined) ?? d0();\r\n      const transferenciasNetas = transferIn.minus(transferOut); // destino - origen\r\n\r\n      // Balance total = entradas - salidas\r\n      const balance = cambiosDivisasDestino\r\n        .plus(serviciosExternosIngresos)\r\n        .plus(transferIn)\r\n        .minus(cambiosDivisasOrigen)\r\n        .minus(serviciosExternosEgresos)\r\n        .minus(transferOut);\r\n\r\n      // Incluir solo monedas con movimiento\r\n      const hasMovement =\r\n        !balance.equals(0) ||\r\n        !cambiosDivisasOrigen.equals(0) ||\r\n        !cambiosDivisasDestino.equals(0) ||\r\n        !serviciosExternosIngresos.equals(0) ||\r\n        !serviciosExternosEgresos.equals(0) ||\r\n        !transferenciasNetas.equals(0);\r\n\r\n      if (hasMovement) {\r\n        balancesRaw.push({\r\n          monedaId: moneda.id,\r\n          codigo: moneda.codigo,\r\n          nombre: moneda.nombre,\r\n          balance,\r\n          detalles: {\r\n            cambiosDivisasOrigen, // lo mostraremos en negativo\r\n            cambiosDivisasDestino,\r\n            serviciosExternosIngresos,\r\n            serviciosExternosEgresos, // lo mostraremos en negativo\r\n            transferenciasNetas,\r\n          },\r\n        });\r\n      }\r\n    }\r\n\r\n    // Ordenar por balance desc\r\n    balancesRaw.sort((a, b) => b.balance.minus(a.balance).toNumber());\r\n\r\n    console.log(\r\n      `Ô£à Balance calculado: ${balancesRaw.length} monedas con movimientos`\r\n    );\r\n\r\n    res.json({\r\n      success: true,\r\n      data: {\r\n        resumenGeneral,\r\n        balancesPorMoneda: balancesRaw.map((b) => ({\r\n          monedaId: b.monedaId,\r\n          codigo: b.codigo,\r\n          nombre: b.nombre,\r\n          balance: toNum(b.balance),\r\n          detalles: {\r\n            // Mostrar salidas como negativas (convenci├│n visual)\r\n            cambiosDivisasOrigen: -toNum(b.detalles.cambiosDivisasOrigen),\r\n            cambiosDivisasDestino: toNum(b.detalles.cambiosDivisasDestino),\r\n            serviciosExternosIngresos: toNum(\r\n              b.detalles.serviciosExternosIngresos\r\n            ),\r\n            serviciosExternosEgresos: -toNum(\r\n              b.detalles.serviciosExternosEgresos\r\n            ),\r\n            transferenciasNetas: toNum(b.detalles.transferenciasNetas),\r\n          },\r\n        })),\r\n        timestamp: new Date().toISOString(),\r\n      },\r\n    });\r\n  } catch (error) {\r\n    console.error(\"ÔØî Error al calcular balance completo:\", error);\r\n    res.status(500).json({\r\n      success: false,\r\n      error: \"Error interno del servidor\",\r\n      message: error instanceof Error ? error.message : \"Error desconocido\",\r\n    });\r\n  }\r\n});\r\n\r\n/* ============================================================================\r\n   GET /api/balance-completo/punto/:pointId\r\n   Resumen de actividad por punto (conteos) + balance por moneda\r\n============================================================================ */\r\nrouter.get(\"/punto/:pointId\", authenticateToken, async (req, res) => {\r\n  try {\r\n    const { pointId } = req.params;\r\n    console.log(`­ƒöì Calculando balance completo para punto: ${pointId}`);\r\n\r\n    const punto = await prisma.puntoAtencion.findUnique({\r\n      where: { id: pointId },\r\n      select: { id: true, nombre: true },\r\n    });\r\n    if (!punto) {\r\n      return res.status(404).json({\r\n        success: false,\r\n        error: \"Punto de atenci├│n no encontrado\",\r\n      });\r\n    }\r\n\r\n    // Conteos de actividad\r\n    const [\r\n      cambiosDivisas,\r\n      serviciosExternos,\r\n      transferenciasOrigen,\r\n      transferenciasDestino,\r\n    ] = await Promise.all([\r\n      prisma.cambioDivisa.count({\r\n        where: { punto_atencion_id: pointId, estado: \"COMPLETADO\" },\r\n      }),\r\n      prisma.servicioExternoMovimiento.count({\r\n        where: { punto_atencion_id: pointId },\r\n      }),\r\n      prisma.transferencia.count({\r\n        where: { origen_id: pointId, estado: \"APROBADO\" },\r\n      }),\r\n      prisma.transferencia.count({\r\n        where: { destino_id: pointId, estado: \"APROBADO\" },\r\n      }),\r\n    ]);\r\n\r\n    // Balance por moneda para este punto\r\n    const saldos = await prisma.saldo.findMany({\r\n      where: { punto_atencion_id: pointId },\r\n      include: {\r\n        moneda: {\r\n          select: { id: true, codigo: true, nombre: true },\r\n        },\r\n      },\r\n    });\r\n\r\n    const balancesPorMoneda = await Promise.all(\r\n      saldos.map(async (saldo) => {\r\n        const monedaId = saldo.moneda_id;\r\n\r\n        // Cambios de divisa (origen = salida, destino = entrada)\r\n        const [cambiosOrigen, cambiosDestino] = await Promise.all([\r\n          prisma.cambioDivisa.aggregate({\r\n            where: {\r\n              punto_atencion_id: pointId,\r\n              moneda_origen_id: monedaId,\r\n              estado: \"COMPLETADO\",\r\n            },\r\n            _sum: { monto_origen: true },\r\n          }),\r\n          prisma.cambioDivisa.aggregate({\r\n            where: {\r\n              punto_atencion_id: pointId,\r\n              moneda_destino_id: monedaId,\r\n              estado: \"COMPLETADO\",\r\n            },\r\n            _sum: { monto_destino: true },\r\n          }),\r\n        ]);\r\n\r\n        // Servicios externos (ingresos y egresos)\r\n        const [serviciosIngresos, serviciosEgresos] = await Promise.all([\r\n          prisma.servicioExternoMovimiento.aggregate({\r\n            where: {\r\n              punto_atencion_id: pointId,\r\n              moneda_id: monedaId,\r\n              tipo_movimiento: \"INGRESO\",\r\n            },\r\n            _sum: { monto: true },\r\n          }),\r\n          prisma.servicioExternoMovimiento.aggregate({\r\n            where: {\r\n              punto_atencion_id: pointId,\r\n              moneda_id: monedaId,\r\n              tipo_movimiento: \"EGRESO\",\r\n            },\r\n            _sum: { monto: true },\r\n          }),\r\n        ]);\r\n\r\n        // Transferencias (entrada y salida)\r\n        const [transferenciasEntrada, transferenciasSalida] = await Promise.all(\r\n          [\r\n            prisma.transferencia.aggregate({\r\n              where: {\r\n                destino_id: pointId,\r\n                moneda_id: monedaId,\r\n                estado: \"APROBADO\",\r\n              },\r\n              _sum: { monto: true },\r\n            }),\r\n            prisma.transferencia.aggregate({\r\n              where: {\r\n                origen_id: pointId,\r\n                moneda_id: monedaId,\r\n                estado: \"APROBADO\",\r\n              },\r\n              _sum: { monto: true },\r\n            }),\r\n          ]\r\n        );\r\n\r\n        const cambiosDivisasOrigen = toNum(cambiosOrigen._sum.monto_origen);\r\n        const cambiosDivisasDestino = toNum(cambiosDestino._sum.monto_destino);\r\n        const serviciosExternosIngresos = toNum(serviciosIngresos._sum.monto);\r\n        const serviciosExternosEgresos = toNum(serviciosEgresos._sum.monto);\r\n        const transferenciasNetas =\r\n          toNum(transferenciasEntrada._sum.monto) -\r\n          toNum(transferenciasSalida._sum.monto);\r\n\r\n        const balance =\r\n          -cambiosDivisasOrigen +\r\n          cambiosDivisasDestino +\r\n          serviciosExternosIngresos -\r\n          serviciosExternosEgresos +\r\n          transferenciasNetas;\r\n\r\n        return {\r\n          moneda_codigo: saldo.moneda.codigo,\r\n          moneda_nombre: saldo.moneda.nombre,\r\n          balance,\r\n          detalles: {\r\n            cambiosDivisasOrigen,\r\n            cambiosDivisasDestino,\r\n            serviciosExternosIngresos,\r\n            serviciosExternosEgresos,\r\n            transferenciasNetas,\r\n          },\r\n        };\r\n      })\r\n    );\r\n\r\n    console.log(\r\n      `Ô£à Balance por punto calculado: ${\r\n        cambiosDivisas +\r\n        serviciosExternos +\r\n        transferenciasOrigen +\r\n        transferenciasDestino\r\n      } movimientos totales`\r\n    );\r\n\r\n    res.json({\r\n      success: true,\r\n      data: {\r\n        actividad: {\r\n          cambiosDivisas,\r\n          serviciosExternos,\r\n          transferenciasOrigen,\r\n          transferenciasDestino,\r\n          totalMovimientos:\r\n            cambiosDivisas +\r\n            serviciosExternos +\r\n            transferenciasOrigen +\r\n            transferenciasDestino,\r\n        },\r\n        balancesPorMoneda,\r\n        timestamp: new Date().toISOString(),\r\n      },\r\n    });\r\n  } catch (error) {\r\n    console.error(\"ÔØî Error al calcular balance por punto:\", error);\r\n    res.status(500).json({\r\n      success: false,\r\n      error: \"Error interno del servidor\",\r\n      message: error instanceof Error ? error.message : \"Error desconocido\",\r\n    });\r\n  }\r\n});\r\n\r\nexport default router;\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\oswal\\OneDrive\\Documentos\\Punto Cambio\\punto_cambio_new\\server\\routes\\balances.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\oswal\\OneDrive\\Documentos\\Punto Cambio\\punto_cambio_new\\server\\routes\\cierreParcial.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\oswal\\OneDrive\\Documentos\\Punto Cambio\\punto_cambio_new\\server\\routes\\cierres-diarios.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\oswal\\OneDrive\\Documentos\\Punto Cambio\\punto_cambio_new\\server\\routes\\contabilidad-diaria.ts","messages":[{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'fechaDate' is assigned a value but never used. Allowed unused vars must match /^_/u.","line":1363,"column":13,"nodeType":null,"messageId":"unusedVar","endLine":1363,"endColumn":22}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":1,"fixableErrorCount":0,"fixableWarningCount":0,"source":"// server/routes/contabilidad-diaria.ts\nconsole.log('[CONTABILIDAD_DIARIA] Archivo de rutas cargado');\nimport express from \"express\";\nimport prisma from \"../lib/prisma.js\";\nimport logger from \"../utils/logger.js\";\nimport { authenticateToken } from \"../middleware/auth.js\";\nimport {\n  gyeDayRangeUtcFromDateOnly,\n  gyeParseDateOnly,\n} from \"../utils/timezone.js\";\nimport cierreService from \"../services/cierreService.js\";\nimport { saldoReconciliationService } from \"../services/saldoReconciliationService.js\";\n\nconst router = express.Router();\n\ntype RolUsuario = \"ADMIN\" | \"SUPER_USUARIO\" | \"OPERADOR\" | string;\n\n/**\n * GET /api/contabilidad-diaria/:pointId/:fecha\n * Resumen de movimientos por moneda para el d├¡a (zona GYE).\n * Clasificaci├│n:\n *  - Ingresos: VENTA, TRANSFERENCIA_ENTRADA/ENTRANTE, SALDO/SALDO_INICIAL/\"SALDO EN CAJA\", INGRESO/INGRESOS,\n *              AJUSTE (monto > 0), CAMBIO_DIVISA (descripcion inicia con \"Ingreso por cambio\")\n *  - Egresos:  COMPRA, TRANSFERENCIA_SALIDA/SALIENTE, EGRESO/EGRESOS,\n *              AJUSTE (monto < 0), CAMBIO_DIVISA (descripcion inicia con \"Egreso por cambio\")\n */\nrouter.get(\"/:pointId/:fecha\", authenticateToken, async (req, res) => {\n  try {\n    const { pointId, fecha } = req.params;\n    const usuario = req.user as\n      | {\n          id: string;\n          punto_atencion_id?: string;\n          rol?: RolUsuario;\n        }\n      | undefined;\n\n    if (!pointId) {\n      return res.status(400).json({ success: false, error: \"Falta pointId\" });\n    }\n\n    // Seguridad: operadores solo pueden consultar su propio punto\n    const esAdmin =\n      (usuario?.rol === \"ADMIN\" || usuario?.rol === \"SUPER_USUARIO\") ?? false;\n    if (\n      !esAdmin &&\n      usuario?.punto_atencion_id &&\n      usuario.punto_atencion_id !== pointId\n    ) {\n      return res.status(403).json({\n        success: false,\n        error: \"No autorizado para consultar otro punto de atenci├│n\",\n      });\n    }\n\n    // Valida YYYY-MM-DD (lanza si no cumple)\n    gyeParseDateOnly(fecha);\n\n    // Rango UTC que cubre el d├¡a en GYE\n    const { gte, lt } = gyeDayRangeUtcFromDateOnly(fecha);\n\n    // === Agregaciones ===\n    const ingresosEtiquetas = [\n      \"VENTA\",\n      \"TRANSFERENCIA_ENTRADA\",\n      \"TRANSFERENCIA_ENTRANTE\",\n      \"SALDO_INICIAL\",\n      \"SALDO\",\n      \"SALDO EN CAJA\",\n      \"INGRESO\",\n      \"INGRESOS\",\n    ];\n\n    const egresosEtiquetas = [\n      \"COMPRA\",\n      \"TRANSFERENCIA_SALIDA\",\n      \"TRANSFERENCIA_SALIENTE\",\n      \"EGRESO\",\n      \"EGRESOS\",\n    ];\n\n    // Ingresos base (etiquetas ampliadas)\n    const ingresosBase = await prisma.movimientoSaldo.groupBy({\n      by: [\"moneda_id\"],\n      where: {\n        punto_atencion_id: pointId,\n        fecha: { gte, lt },\n        tipo_movimiento: { in: ingresosEtiquetas },\n      },\n      _sum: { monto: true },\n    });\n\n    // Ingresos por AJUSTE (monto > 0)\n    const ingresosAjustePos = await prisma.movimientoSaldo.groupBy({\n      by: [\"moneda_id\"],\n      where: {\n        punto_atencion_id: pointId,\n        fecha: { gte, lt },\n        tipo_movimiento: \"AJUSTE\",\n        monto: { gt: 0 },\n      },\n      _sum: { monto: true },\n    });\n\n    // Ingresos por CAMBIO_DIVISA (descripcion inicia con ÔÇ£Ingreso por cambioÔÇØ)\n    const ingresosCambio = await prisma.movimientoSaldo.groupBy({\n      by: [\"moneda_id\"],\n      where: {\n        punto_atencion_id: pointId,\n        fecha: { gte, lt },\n        tipo_movimiento: \"CAMBIO_DIVISA\",\n        descripcion: {\n          startsWith: \"Ingreso por cambio\",\n          mode: \"insensitive\",\n        },\n      },\n      _sum: { monto: true },\n    });\n\n    // Egresos base (etiquetas ampliadas)\n    const egresosBase = await prisma.movimientoSaldo.groupBy({\n      by: [\"moneda_id\"],\n      where: {\n        punto_atencion_id: pointId,\n        fecha: { gte, lt },\n        tipo_movimiento: { in: egresosEtiquetas },\n      },\n      _sum: { monto: true },\n    });\n\n    // Egresos por AJUSTE (monto < 0) ÔÇö luego tomamos ABS\n    const egresosAjusteNeg = await prisma.movimientoSaldo.groupBy({\n      by: [\"moneda_id\"],\n      where: {\n        punto_atencion_id: pointId,\n        fecha: { gte, lt },\n        tipo_movimiento: \"AJUSTE\",\n        monto: { lt: 0 },\n      },\n      _sum: { monto: true },\n    });\n\n    // Egresos por CAMBIO_DIVISA (descripcion inicia con ÔÇ£Egreso por cambioÔÇØ)\n    const egresosCambio = await prisma.movimientoSaldo.groupBy({\n      by: [\"moneda_id\"],\n      where: {\n        punto_atencion_id: pointId,\n        fecha: { gte, lt },\n        tipo_movimiento: \"CAMBIO_DIVISA\",\n        descripcion: {\n          startsWith: \"Egreso por cambio\",\n          mode: \"insensitive\",\n        },\n      },\n      _sum: { monto: true },\n    });\n\n    // Conteo de movimientos por moneda\n    const counts = await prisma.movimientoSaldo.groupBy({\n      by: [\"moneda_id\"],\n      where: { punto_atencion_id: pointId, fecha: { gte, lt } },\n      _count: { _all: true },\n    });\n\n    // === Combinar resultados ===\n    type NumMap = Record<string, number>;\n    const toNum = (v: unknown) => (v ? Number(v) : 0);\n\n    const mapIngresos: NumMap = {};\n    for (const r of ingresosBase) {\n      mapIngresos[r.moneda_id] =\n        (mapIngresos[r.moneda_id] || 0) + toNum(r._sum.monto);\n    }\n    for (const r of ingresosAjustePos) {\n      mapIngresos[r.moneda_id] =\n        (mapIngresos[r.moneda_id] || 0) + toNum(r._sum.monto);\n    }\n    for (const r of ingresosCambio) {\n      mapIngresos[r.moneda_id] =\n        (mapIngresos[r.moneda_id] || 0) + toNum(r._sum.monto);\n    }\n\n    const mapEgresos: NumMap = {};\n    for (const r of egresosBase) {\n      mapEgresos[r.moneda_id] =\n        (mapEgresos[r.moneda_id] || 0) + Math.abs(toNum(r._sum.monto));\n    }\n    for (const r of egresosAjusteNeg) {\n      mapEgresos[r.moneda_id] =\n        (mapEgresos[r.moneda_id] || 0) + Math.abs(toNum(r._sum.monto));\n    }\n    for (const r of egresosCambio) {\n      mapEgresos[r.moneda_id] =\n        (mapEgresos[r.moneda_id] || 0) + Math.abs(toNum(r._sum.monto));\n    }\n\n    const mapCounts: Record<string, number> = {};\n    for (const r of counts) mapCounts[r.moneda_id] = r._count._all;\n\n    // Unificar moneda_ids\n    const monedaIds = Array.from(\n      new Set([\n        ...Object.keys(mapIngresos),\n        ...Object.keys(mapEgresos),\n        ...Object.keys(mapCounts),\n      ])\n    ).sort();\n\n    // Info de moneda (enriquecer respuesta)\n    const monedas = monedaIds.length\n      ? await prisma.moneda.findMany({\n          where: { id: { in: monedaIds } },\n          select: { id: true, codigo: true, nombre: true, simbolo: true },\n        })\n      : [];\n    const monedaInfo = new Map(monedas.map((m) => [m.id, m]));\n\n    const resumen = monedaIds.map((mid) => ({\n      moneda_id: mid,\n      ingresos: mapIngresos[mid] || 0,\n      egresos: mapEgresos[mid] || 0,\n      movimientos: mapCounts[mid] || 0,\n      moneda: monedaInfo.get(mid) || null,\n    }));\n\n    return res.json({\n      success: true,\n      fecha,\n      rango_utc: { gte, lt },\n      pointId,\n      resumen,\n    });\n  } catch (error) {\n    logger.error(\"Error en GET /contabilidad-diaria/:pointId/:fecha\", {\n      error: error instanceof Error ? error.message : String(error),\n      stack: error instanceof Error ? error.stack : undefined,\n    });\n    return res.status(500).json({\n      success: false,\n      error: \"Error interno del servidor\",\n    });\n  }\n});\n\n/**\n * GET /api/contabilidad-diaria/cierre/:pointId/:fecha\n * Verifica si existe un cierre para el d├¡a especificado\n */\nrouter.get(\"/cierre/:pointId/:fecha\", authenticateToken, async (req, res) => {\n  try {\n    const { pointId, fecha } = req.params;\n    const usuario = req.user as\n      | {\n          id: string;\n          punto_atencion_id?: string;\n          rol?: RolUsuario;\n        }\n      | undefined;\n\n    if (!pointId) {\n      return res.status(400).json({ success: false, error: \"Falta pointId\" });\n    }\n\n    // Seguridad: operadores solo pueden consultar su propio punto\n    const esAdmin =\n      (usuario?.rol === \"ADMIN\" || usuario?.rol === \"SUPER_USUARIO\") ?? false;\n    if (\n      !esAdmin &&\n      usuario?.punto_atencion_id &&\n      usuario.punto_atencion_id !== pointId\n    ) {\n      return res.status(403).json({\n        success: false,\n        error: \"No autorizado para consultar otro punto de atenci├│n\",\n      });\n    }\n\n    // Valida YYYY-MM-DD (lanza si no cumple)\n    gyeParseDateOnly(fecha);\n\n    // Prisma usa Date para @db.Date (sin hora).\n    // Usamos medianoche UTC de esa fecha\n    const fechaDate = new Date(`${fecha}T00:00:00.000Z`);\n\n    // Buscar cierre por clave compuesta\n    const cierre = await prisma.cierreDiario.findUnique({\n      where: {\n        fecha_punto_atencion_id: {\n          fecha: fechaDate,\n          punto_atencion_id: pointId,\n        },\n      },\n      include: {\n        usuario: {\n          select: { nombre: true, username: true },\n        },\n      },\n    });\n\n    return res.json({\n      success: true,\n      cierre: cierre || null,\n    });\n  } catch (error) {\n    logger.error(\"Error en GET /contabilidad-diaria/cierre/:pointId/:fecha\", {\n      error: error instanceof Error ? error.message : String(error),\n      stack: error instanceof Error ? error.stack : undefined,\n    });\n    return res.status(500).json({\n      success: false,\n      error: \"Error interno del servidor\",\n    });\n  }\n});\n\n/**\n * GET /api/contabilidad-diaria/validar-cierres/:pointId/:fecha\n * Valida qu├® cierres son necesarios antes de permitir el cierre diario\n */\nrouter.get(\n  \"/validar-cierres/:pointId/:fecha\",\n  authenticateToken,\n  async (req, res) => {\n    try {\n      const { pointId, fecha } = req.params;\n      const usuario = req.user as\n        | {\n            id: string;\n            punto_atencion_id?: string;\n            rol?: string;\n          }\n        | undefined;\n\n      // Log de auditor├¡a para depuraci├│n de errores 403\n      console.log(\"[VALIDAR_CIERRES]\", {\n        usuario_id: usuario?.id,\n        usuario_rol: usuario?.rol,\n        usuario_punto_atencion_id: usuario?.punto_atencion_id,\n        requested_point_id: pointId,\n        fecha,\n      });\n\n      if (!pointId) {\n        return res.status(400).json({ success: false, error: \"Falta pointId\" });\n      }\n\n      // Seguridad: operadores solo pueden consultar su propio punto\n      const esAdmin =\n        (usuario?.rol === \"ADMIN\" || usuario?.rol === \"SUPER_USUARIO\") ?? false;\n      \n      // Si es operador, debe tener acceso al punto\n      if (!esAdmin) {\n        // Si no es admin, verificar que sea operador del punto\n        if (!usuario?.punto_atencion_id || usuario.punto_atencion_id !== pointId) {\n          return res.status(403).json({\n            success: false,\n            error: \"No autorizado para consultar otro punto de atenci├│n\",\n          });\n        }\n      }\n\n      // Valida YYYY-MM-DD (lanza si no cumple)\n      gyeParseDateOnly(fecha);\n\n      // Rango UTC que cubre el d├¡a en GYE\n      const { gte, lt } = gyeDayRangeUtcFromDateOnly(fecha);\n      const fechaDate = new Date(`${fecha}T00:00:00.000Z`);\n\n      // 1. Verificar si hay cambios de divisas del d├¡a\n      const cambiosDivisas = await prisma.cambioDivisa.count({\n        where: {\n          punto_atencion_id: pointId,\n          fecha: { gte, lt },\n        },\n      });\n\n      // 2. Verificar si hay movimientos de servicios externos del d├¡a\n      const serviciosExternos = await prisma.servicioExternoMovimiento.count({\n        where: {\n          punto_atencion_id: pointId,\n          fecha: { gte, lt },\n        },\n      });\n\n      // 3. Verificar estado de cierre diario\n      const cierreDiario = await prisma.cierreDiario.findUnique({\n        where: {\n          fecha_punto_atencion_id: {\n            fecha: fechaDate,\n            punto_atencion_id: pointId,\n          },\n        },\n      });\n\n      // Determinar qu├® cierres son requeridos\n      // NOTA: Los servicios externos ya NO requieren cierre separado\n      // Se incluyen autom├íticamente en el cierre diario\n      const cierresRequeridos = {\n        servicios_externos: false, // Ya no se requiere cierre separado\n        cambios_divisas: cambiosDivisas > 0,\n        cierre_diario: true, // Siempre requerido\n      };\n\n      // Estado actual de los cierres\n      const estadoCierres = {\n        servicios_externos: true, // Siempre true porque ya no se requiere cierre separado\n        cambios_divisas: true, // Los cambios de divisas no tienen cierre separado, se incluyen en el cierre diario\n        cierre_diario: cierreDiario?.estado === \"CERRADO\",\n      };\n\n      // Verificar si todos los cierres requeridos est├ín completos\n      const cierresCompletos = estadoCierres.cierre_diario;\n\n      return res.json({\n        success: true,\n        cierres_requeridos: cierresRequeridos,\n        estado_cierres: estadoCierres,\n        cierres_completos: cierresCompletos,\n        conteos: {\n          cambios_divisas: cambiosDivisas,\n          servicios_externos: serviciosExternos,\n        },\n      });\n    } catch (error) {\n      logger.error(\n        \"Error en GET /contabilidad-diaria/validar-cierres/:pointId/:fecha\",\n        {\n          error: error instanceof Error ? error.message : String(error),\n          stack: error instanceof Error ? error.stack : undefined,\n        }\n      );\n      return res.status(500).json({\n        success: false,\n        error: \"Error interno del servidor\",\n      });\n    }\n  }\n);\n\n/**\n * GET /api/contabilidad-diaria/:pointId/:fecha/resumen-cierre\n * Obtiene el resumen de saldos antes de confirmar el cierre\n * Muestra: saldos principales (USD y divisas movidas), servicios externos\n */\nrouter.get(\n  \"/:pointId/:fecha/resumen-cierre\",\n  authenticateToken,\n  async (req, res) => {\n    try {\n      const { pointId, fecha } = req.params;\n      const usuario = req.user as\n        | {\n            id: string;\n            punto_atencion_id?: string;\n            rol?: RolUsuario;\n          }\n        | undefined;\n\n      if (!pointId) {\n        return res.status(400).json({ success: false, error: \"Falta pointId\" });\n      }\n\n      // Seguridad: operadores solo pueden consultar su propio punto\n      const esAdmin =\n        (usuario?.rol === \"ADMIN\" || usuario?.rol === \"SUPER_USUARIO\") ?? false;\n      if (\n        !esAdmin &&\n        usuario?.punto_atencion_id &&\n        usuario.punto_atencion_id !== pointId\n      ) {\n        return res.status(403).json({\n          success: false,\n          error: \"No autorizado para consultar otro punto de atenci├│n\",\n        });\n      }\n\n      // Valida YYYY-MM-DD\n      gyeParseDateOnly(fecha);\n      const { gte, lt } = gyeDayRangeUtcFromDateOnly(fecha);\n\n      // 1. Obtener saldos finales de monedas con movimientos en el d├¡a\n      const saldosMonedas = await prisma.saldo.findMany({\n        where: {\n          punto_atencion_id: pointId,\n        },\n        include: {\n          moneda: {\n            select: {\n              codigo: true,\n              nombre: true,\n              simbolo: true,\n            },\n          },\n        },\n      });\n\n      // 2. Obtener cu├íles monedas tuvieron movimientos en el d├¡a\n      const monedasConMovimientos = await prisma.movimientoSaldo.groupBy({\n        by: [\"moneda_id\"],\n        where: {\n          punto_atencion_id: pointId,\n          fecha: { gte, lt },\n        },\n        _count: { id: true },\n      });\n\n      const idsConMovimientos = new Set(\n        monedasConMovimientos.map((m) => m.moneda_id)\n      );\n\n      // 3. Filtrar saldos: USD siempre, y divisas que tuvieron movimientos\n      const saldosPrincipalesBase = saldosMonedas\n        .filter(\n          (s) => s.moneda.codigo === \"USD\" || idsConMovimientos.has(s.moneda_id)\n        )\n        .map((s) => ({\n          moneda_id: s.moneda_id,\n          moneda_codigo: s.moneda.codigo,\n          moneda_nombre: s.moneda.nombre,\n          moneda_simbolo: s.moneda.simbolo,\n          saldo_registrado: s.cantidad,\n          tuvo_movimientos: idsConMovimientos.has(s.moneda_id),\n        }))\n        .sort((a, b) => {\n          // USD primero, luego alfab├®tico\n          if (a.moneda_codigo === \"USD\") return -1;\n          if (b.moneda_codigo === \"USD\") return 1;\n          return a.moneda_codigo.localeCompare(b.moneda_codigo);\n        });\n\n      // 3.1 Reconciliar saldos (fuente de verdad: saldoInicial + MovimientoSaldo)\n      const saldosPrincipalesReconciliados = await Promise.all(\n        saldosPrincipalesBase.map(async (s) => {\n          const saldoCalculado = await saldoReconciliationService.calcularSaldoReal(\n            pointId,\n            s.moneda_id\n          );\n\n          return {\n            moneda_codigo: s.moneda_codigo,\n            moneda_nombre: s.moneda_nombre,\n            moneda_simbolo: s.moneda_simbolo,\n            saldo_final: saldoCalculado,\n            tuvo_movimientos: s.tuvo_movimientos,\n          };\n        })\n      );\n\n      // 4. Obtener saldos de servicios externos\n      const serviciosExternos = await prisma.servicioExternoSaldo.findMany({\n        where: {\n          punto_atencion_id: pointId,\n        },\n        include: {\n          moneda: {\n            select: {\n              codigo: true,\n              simbolo: true,\n            },\n          },\n        },\n      });\n\n      // Agrupar por servicio externo\n      type SaldoServicioItem = {\n        moneda_codigo: string;\n        moneda_simbolo: string;\n        saldo: unknown;\n      };\n      type SaldoServicioGroup = {\n        servicio_nombre: string;\n        servicio_tipo: string;\n        saldos: SaldoServicioItem[];\n      };\n\n      const saldosServicios = serviciosExternos.reduce<\n        Record<string, SaldoServicioGroup>\n      >((acc, s) => {\n        const key = s.servicio;\n        if (!acc[key]) {\n          acc[key] = {\n            servicio_nombre: s.servicio,\n            servicio_tipo: s.servicio,\n            saldos: [],\n          };\n        }\n        acc[key].saldos.push({\n          moneda_codigo: s.moneda.codigo,\n          moneda_simbolo: s.moneda.simbolo,\n          saldo: s.cantidad,\n        });\n        return acc;\n      }, {});\n\n      // 5. Obtener total de transacciones del d├¡a\n      const totalTransacciones = await prisma.movimientoSaldo.count({\n        where: {\n          punto_atencion_id: pointId,\n          fecha: { gte, lt },\n        },\n      });\n\n      // 6. Listado de transacciones del d├¡a (para auditor├¡a previa al cierre)\n      // Nota: puede crecer; mantenemos payload compacto y ordenado por fecha.\n      const limit = Math.min(\n        Math.max(Number(req.query.limit ?? 5000), 0),\n        20000\n      );\n\n      const cambiosDivisas = await prisma.cambioDivisa.findMany({\n        where: {\n          punto_atencion_id: pointId,\n          fecha: { gte, lt },\n        },\n        orderBy: { fecha: \"asc\" },\n        take: limit,\n        select: {\n          id: true,\n          fecha: true,\n          numero_recibo: true,\n          tipo_operacion: true,\n          estado: true,\n          monto_origen: true,\n          monto_destino: true,\n          tasa_cambio_billetes: true,\n          tasa_cambio_monedas: true,\n          metodo_entrega: true,\n          metodo_pago_origen: true,\n          transferencia_banco: true,\n          transferencia_numero: true,\n          observacion: true,\n          monedaOrigen: { select: { codigo: true, nombre: true, simbolo: true } },\n          monedaDestino: { select: { codigo: true, nombre: true, simbolo: true } },\n          usuario: { select: { id: true, nombre: true, username: true } },\n        },\n      });\n\n      const movimientosServiciosExternos =\n        await prisma.servicioExternoMovimiento.findMany({\n          where: {\n            punto_atencion_id: pointId,\n            fecha: { gte, lt },\n          },\n          orderBy: { fecha: \"asc\" },\n          take: limit,\n          select: {\n            id: true,\n            fecha: true,\n            servicio: true,\n            tipo_movimiento: true,\n            monto: true,\n            metodo_ingreso: true,\n            numero_referencia: true,\n            descripcion: true,\n            comprobante_url: true,\n            billetes: true,\n            monedas_fisicas: true,\n            bancos: true,\n            moneda: { select: { codigo: true, simbolo: true } },\n            usuario: { select: { id: true, nombre: true, username: true } },\n          },\n        });\n\n      type NumberLike = { toNumber?: () => number };\n      const toNumber = (v: unknown) => {\n        if (typeof v === \"number\") return v;\n        if (typeof v === \"bigint\") return Number(v);\n        if (typeof v === \"string\") return Number(v);\n        if (v && typeof v === \"object\" && \"toNumber\" in v) {\n          const toNumberFn = (v as NumberLike).toNumber;\n          if (typeof toNumberFn === \"function\") return toNumberFn();\n        }\n        return Number(v);\n      };\n\n      const upsertBalance = (\n        map: Map<\n          string,\n          {\n            codigo: string;\n            nombre?: string;\n            simbolo?: string;\n            ingresos: number;\n            egresos: number;\n          }\n        >,\n        moneda:\n          | { codigo: string; nombre?: string | null; simbolo?: string | null }\n          | null\n          | undefined,\n        ingreso: number,\n        egreso: number\n      ) => {\n        if (!moneda?.codigo) return;\n        const codigo = moneda.codigo;\n        const prev = map.get(codigo);\n        if (!prev) {\n          map.set(codigo, {\n            codigo,\n            nombre: moneda.nombre ?? undefined,\n            simbolo: moneda.simbolo ?? undefined,\n            ingresos: ingreso,\n            egresos: egreso,\n          });\n          return;\n        }\n        prev.ingresos += ingreso;\n        prev.egresos += egreso;\n      };\n\n      // 7. Balance (ingresos/egresos) por tipo y moneda, para cuadre r├ípido\n      const balanceCambiosMap = new Map<\n        string,\n        {\n          codigo: string;\n          nombre?: string;\n          simbolo?: string;\n          ingresos: number;\n          egresos: number;\n        }\n      >();\n\n      for (const c of cambiosDivisas) {\n        upsertBalance(\n          balanceCambiosMap,\n          c.monedaOrigen,\n          toNumber(c.monto_origen || 0),\n          0\n        );\n        upsertBalance(\n          balanceCambiosMap,\n          c.monedaDestino,\n          0,\n          toNumber(c.monto_destino || 0)\n        );\n      }\n\n      const balanceServiciosMap = new Map<\n        string,\n        {\n          codigo: string;\n          nombre?: string;\n          simbolo?: string;\n          ingresos: number;\n          egresos: number;\n        }\n      >();\n\n      for (const m of movimientosServiciosExternos) {\n        const codigo = m.moneda?.codigo;\n        if (!codigo) continue;\n        const tipo = String(m.tipo_movimiento);\n        const monto = toNumber(m.monto || 0);\n\n        const esIngreso =\n          tipo === \"INGRESO\" ||\n          tipo === \"TRANSFERENCIA_ENTRANTE\" ||\n          tipo === \"TRANSFERENCIA_DEVOLUCION\";\n        const esEgreso = tipo === \"EGRESO\" || tipo === \"TRANSFERENCIA_SALIENTE\";\n\n        upsertBalance(\n          balanceServiciosMap,\n          { codigo, simbolo: m.moneda?.simbolo },\n          esIngreso ? monto : 0,\n          esEgreso ? monto : 0\n        );\n      }\n\n      type BalanceRow = {\n        moneda: { codigo: string };\n        ingresos: number;\n        egresos: number;\n        neto: number;\n      };\n\n      const sortBalanceRows = (a: BalanceRow, b: BalanceRow) => {\n        if (a.moneda.codigo === \"USD\") return -1;\n        if (b.moneda.codigo === \"USD\") return 1;\n        return String(a.moneda.codigo).localeCompare(String(b.moneda.codigo));\n      };\n\n      const balanceCambios = Array.from(balanceCambiosMap.values())\n        .map((r) => ({\n          moneda: {\n            codigo: r.codigo,\n            nombre: r.nombre,\n            simbolo: r.simbolo,\n          },\n          ingresos: r.ingresos,\n          egresos: r.egresos,\n          neto: r.ingresos - r.egresos,\n        }))\n        .sort(sortBalanceRows);\n\n      const balanceServicios = Array.from(balanceServiciosMap.values())\n        .map((r) => ({\n          moneda: {\n            codigo: r.codigo,\n            nombre: r.nombre,\n            simbolo: r.simbolo,\n          },\n          ingresos: r.ingresos,\n          egresos: r.egresos,\n          neto: r.ingresos - r.egresos,\n        }))\n        .sort(sortBalanceRows);\n\n      return res.json({\n        success: true,\n        resumen: {\n          fecha,\n          punto_atencion_id: pointId,\n          saldos_principales: saldosPrincipalesReconciliados,\n          servicios_externos: Object.values(saldosServicios),\n          total_transacciones: totalTransacciones,\n          transacciones: {\n            cambios_divisas: cambiosDivisas.map((c) => ({\n              id: c.id,\n              fecha: c.fecha,\n              numero_recibo: c.numero_recibo,\n              tipo_operacion: c.tipo_operacion,\n              estado: c.estado,\n              // En la UI: ORIGEN = lo que entrega el cliente; DESTINO = lo que recibe el cliente (sale del punto)\n              moneda_origen: c.monedaOrigen\n                ? {\n                    codigo: c.monedaOrigen.codigo,\n                    nombre: c.monedaOrigen.nombre,\n                    simbolo: c.monedaOrigen.simbolo,\n                  }\n                : null,\n              moneda_destino: c.monedaDestino\n                ? {\n                    codigo: c.monedaDestino.codigo,\n                    nombre: c.monedaDestino.nombre,\n                    simbolo: c.monedaDestino.simbolo,\n                  }\n                : null,\n              monto_origen: toNumber(c.monto_origen),\n              monto_destino: toNumber(c.monto_destino),\n              tasa_cambio_billetes: toNumber(c.tasa_cambio_billetes),\n              tasa_cambio_monedas: toNumber(c.tasa_cambio_monedas),\n              metodo_entrega: c.metodo_entrega,\n              metodo_pago_origen: c.metodo_pago_origen,\n              transferencia_banco: c.transferencia_banco,\n              transferencia_numero: c.transferencia_numero,\n              observacion: c.observacion,\n              usuario: c.usuario,\n            })),\n            servicios_externos: movimientosServiciosExternos.map((m) => ({\n              id: m.id,\n              fecha: m.fecha,\n              servicio: m.servicio,\n              tipo_movimiento: m.tipo_movimiento,\n              moneda: m.moneda?.codigo,\n              monto: toNumber(m.monto),\n              metodo_ingreso: m.metodo_ingreso,\n              numero_referencia: m.numero_referencia,\n              descripcion: m.descripcion,\n              comprobante_url: m.comprobante_url,\n              billetes: m.billetes != null ? toNumber(m.billetes) : null,\n              monedas_fisicas:\n                m.monedas_fisicas != null ? toNumber(m.monedas_fisicas) : null,\n              bancos: m.bancos != null ? toNumber(m.bancos) : null,\n              usuario: m.usuario,\n            })),\n            limit,\n          },\n          balance: {\n            cambios_divisas: {\n              por_moneda: balanceCambios,\n            },\n            servicios_externos: {\n              por_moneda: balanceServicios,\n            },\n          },\n        },\n      });\n    } catch (error) {\n      logger.error(\n        \"Error en GET /contabilidad-diaria/:pointId/:fecha/resumen-cierre\",\n        {\n          error: error instanceof Error ? error.message : String(error),\n          stack: error instanceof Error ? error.stack : undefined,\n        }\n      );\n      return res.status(500).json({\n        success: false,\n        error: \"Error interno del servidor\",\n      });\n    }\n  }\n);\n\n/**\n * POST /api/contabilidad-diaria/:pointId/:fecha/cerrar\n * Marca el cierre del d├¡a como CERRADO usando el servicio unificado\n * Este endpoint ahora delega al servicio cierreService para garantizar\n * consistencia transaccional entre CuadreCaja y CierreDiario\n */\nrouter.post(\n  \"/:pointId/:fecha/cerrar\",\n  authenticateToken,\n  async (req: express.Request, res: express.Response) => {\n    try {\n      const { pointId, fecha } = req.params;\n      const { observaciones, diferencias_reportadas, detalles } =\n        req.body || {};\n      const usuario = req.user as\n        | {\n            id: string;\n            punto_atencion_id?: string;\n            rol?: RolUsuario;\n          }\n        | undefined;\n\n      if (!usuario?.id) {\n        return res\n          .status(401)\n          .json({ success: false, error: \"No autenticado\" });\n      }\n      if (!pointId) {\n        return res.status(400).json({ success: false, error: \"Falta pointId\" });\n      }\n\n      // Seguridad: operadores solo pueden cerrar su propio punto\n      const esAdmin =\n        (usuario?.rol === \"ADMIN\" || usuario?.rol === \"SUPER_USUARIO\") ?? false;\n      if (\n        !esAdmin &&\n        usuario?.punto_atencion_id &&\n        usuario.punto_atencion_id !== pointId\n      ) {\n        return res.status(403).json({\n          success: false,\n          error: \"No autorizado para cerrar otro punto de atenci├│n\",\n        });\n      }\n\n      // Valida YYYY-MM-DD (lanza si es inv├ílida)\n      gyeParseDateOnly(fecha);\n      const fechaDate = new Date(`${fecha}T00:00:00.000Z`);\n\n      // Verificar si ya est├í cerrado (idempotencia)\n      const estado = await cierreService.obtenerEstadoCierre(\n        pointId,\n        fechaDate\n      );\n\n      if (estado.existe && estado.estado === \"CERRADO\") {\n        return res.status(200).json({\n          success: true,\n          info: \"ya_cerrado\",\n          cierre: estado.cierre,\n          mensaje: \"El cierre de este d├¡a ya fue completado\",\n        });\n      }\n\n      // Si se proporcionan detalles, realizar cierre completo\n      if (detalles && Array.isArray(detalles) && detalles.length > 0) {\n        logger.info(\"­ƒöä Realizando cierre con detalles proporcionados\", {\n          punto: pointId,\n          fecha,\n          usuario: usuario.id,\n          num_detalles: detalles.length,\n        });\n\n        const resultado = await cierreService.realizarCierreDiario({\n          punto_atencion_id: pointId,\n          usuario_id: usuario.id,\n          fecha: fechaDate,\n          detalles,\n          observaciones,\n          diferencias_reportadas,\n        });\n\n        if (!resultado.success) {\n          return res.status(400).json(resultado);\n        }\n\n        return res.status(200).json({\n          success: true,\n          cierre: { id: resultado.cierre_id },\n          cuadre_id: resultado.cuadre_id,\n          jornada_finalizada: resultado.jornada_finalizada,\n          mensaje: resultado.mensaje,\n        });\n      }\n\n      // Si no se proporcionan detalles, usar el m├®todo antiguo (compatibilidad)\n      // Este camino se mantiene para no romper integraciones existentes\n      logger.info(\"­ƒöä Realizando cierre sin detalles (modo compatibilidad)\", {\n        punto: pointId,\n        fecha,\n        usuario: usuario.id,\n      });\n\n      // NOTA: La validaci├│n de servicios externos fue eliminada.\n      // Los servicios externos ahora se incluyen autom├íticamente en el cierre diario\n      // a trav├®s del endpoint /cuadre-caja que consolida todos los movimientos.\n\n      // Crear o actualizar a CERRADO y verificar si se puede finalizar jornada\n      const result = await prisma.$transaction(async (tx) => {\n        const existing = await tx.cierreDiario.findUnique({\n          where: {\n            fecha_punto_atencion_id: {\n              fecha: fechaDate,\n              punto_atencion_id: pointId,\n            },\n          },\n        });\n\n        let cierre;\n        if (!existing) {\n          cierre = await tx.cierreDiario.create({\n            data: {\n              punto_atencion_id: pointId,\n              fecha: fechaDate,\n              usuario_id: usuario.id,\n              observaciones: observaciones ?? null,\n              estado: \"CERRADO\",\n              fecha_cierre: new Date(),\n              cerrado_por: usuario.id,\n              diferencias_reportadas: diferencias_reportadas ?? null,\n            },\n          });\n        } else {\n          // existe pero no est├í cerrado -> actualizar\n          cierre = await tx.cierreDiario.update({\n            where: {\n              fecha_punto_atencion_id: {\n                fecha: fechaDate,\n                punto_atencion_id: pointId,\n              },\n            },\n            data: {\n              estado: \"CERRADO\",\n              fecha_cierre: new Date(),\n              cerrado_por: usuario.id,\n              observaciones: observaciones ?? existing.observaciones,\n              diferencias_reportadas:\n                diferencias_reportadas ?? existing.diferencias_reportadas,\n              updated_at: new Date(),\n            },\n          });\n        }\n\n        // Verificar si hay jornada activa para finalizar autom├íticamente\n        logger.info(\"­ƒöì Buscando jornada activa para finalizar\", {\n          usuario_id: usuario.id,\n          punto_atencion_id: pointId,\n        });\n\n        const jornadaActiva = await tx.jornada.findFirst({\n          where: {\n            usuario_id: usuario.id,\n            punto_atencion_id: pointId,\n            fecha_salida: null, // Jornada activa\n          },\n          orderBy: { fecha_inicio: \"desc\" },\n        });\n\n        logger.info(\"­ƒôï Resultado b├║squeda jornada\", {\n          jornadaEncontrada: !!jornadaActiva,\n          jornadaId: jornadaActiva?.id,\n          fechaInicio: jornadaActiva?.fecha_inicio,\n        });\n\n        let jornadaFinalizada = null;\n        if (jornadaActiva) {\n          // Finalizar la jornada autom├íticamente\n          jornadaFinalizada = await tx.jornada.update({\n            where: { id: jornadaActiva.id },\n            data: {\n              fecha_salida: new Date(),\n              estado: \"COMPLETADO\",\n              observaciones:\n                \"Jornada finalizada autom├íticamente tras completar cierre diario\",\n            },\n          });\n\n          logger.info(\"­ƒÄ» JORNADA_FINALIZADA_AUTOMATICAMENTE\", {\n            usuario: usuario.id,\n            punto: pointId,\n            jornada_id: jornadaActiva.id,\n            cierre_id: cierre.id,\n          });\n        } else {\n          logger.warn(\"ÔÜá´©Å NO SE ENCONTR├ô JORNADA ACTIVA PARA FINALIZAR\", {\n            usuario_id: usuario.id,\n            punto_atencion_id: pointId,\n          });\n        }\n\n        return { cierre, jornadaFinalizada };\n      });\n\n      return res.status(200).json({\n        success: true,\n        cierre: result.cierre,\n        jornada_finalizada: !!result.jornadaFinalizada,\n        mensaje: result.jornadaFinalizada\n          ? \"Cierre diario completado y jornada finalizada autom├íticamente\"\n          : \"Cierre diario completado\",\n      });\n    } catch (error) {\n      logger.error(\n        \"Error en POST /contabilidad-diaria/:pointId/:fecha/cerrar\",\n        {\n          error: error instanceof Error ? error.message : String(error),\n          stack: error instanceof Error ? error.stack : undefined,\n        }\n      );\n      return res.status(500).json({\n        success: false,\n        error: \"Error interno del servidor\",\n      });\n    }\n  }\n);\n\n/**\n * POST /api/contabilidad-diaria/:pointId/:fecha/cerrar-completo\n * Nuevo endpoint optimizado que usa el servicio unificado de cierre\n * Espera recibir los detalles del cuadre ya validados por el frontend\n */\nrouter.post(\n  \"/:pointId/:fecha/cerrar-completo\",\n  authenticateToken,\n  async (req: express.Request, res: express.Response) => {\n    try {\n      const { pointId, fecha } = req.params;\n      const { detalles, observaciones } = req.body || {};\n      const usuario = req.user as\n        | {\n            id: string;\n            punto_atencion_id?: string;\n            rol?: RolUsuario;\n          }\n        | undefined;\n\n      if (!usuario?.id) {\n        return res\n          .status(401)\n          .json({ success: false, error: \"No autenticado\" });\n      }\n\n      if (!pointId) {\n        return res.status(400).json({ success: false, error: \"Falta pointId\" });\n      }\n\n      if (!detalles || !Array.isArray(detalles)) {\n        return res.status(400).json({\n          success: false,\n          error: \"Se requieren los detalles del cuadre\",\n        });\n      }\n\n      // Seguridad: operadores solo pueden cerrar su propio punto\n      const esAdmin =\n        (usuario?.rol === \"ADMIN\" || usuario?.rol === \"SUPER_USUARIO\") ?? false;\n      if (\n        !esAdmin &&\n        usuario?.punto_atencion_id &&\n        usuario.punto_atencion_id !== pointId\n      ) {\n        return res.status(403).json({\n          success: false,\n          error: \"No autorizado para cerrar otro punto de atenci├│n\",\n        });\n      }\n\n      // Validar fecha\n      gyeParseDateOnly(fecha);\n      const fechaDate = new Date(`${fecha}T00:00:00.000Z`);\n\n      logger.info(\"­ƒöä Iniciando cierre completo\", {\n        punto: pointId,\n        fecha,\n        usuario: usuario.id,\n        num_detalles: detalles.length,\n      });\n\n      // Realizar cierre usando el servicio unificado\n      const resultado = await cierreService.realizarCierreDiario({\n        punto_atencion_id: pointId,\n        usuario_id: usuario.id,\n        fecha: fechaDate,\n        detalles,\n        observaciones,\n      });\n\n      if (!resultado.success) {\n        logger.warn(\"ÔÜá´©Å Cierre rechazado\", {\n          punto: pointId,\n          fecha,\n          error: resultado.error,\n          codigo: resultado.codigo,\n        });\n        return res.status(400).json(resultado);\n      }\n\n      logger.info(\"Ô£à Cierre completado exitosamente\", {\n        cierre_id: resultado.cierre_id,\n        cuadre_id: resultado.cuadre_id,\n        punto: pointId,\n        fecha,\n        jornada_finalizada: resultado.jornada_finalizada,\n      });\n\n      return res.status(200).json(resultado);\n    } catch (error) {\n      logger.error(\"Error en POST /contabilidad-diaria/cerrar-completo\", {\n        error: error instanceof Error ? error.message : String(error),\n        stack: error instanceof Error ? error.stack : undefined,\n      });\n      return res.status(500).json({\n        success: false,\n        error: \"Error interno del servidor\",\n      });\n    }\n  }\n);\n\n/**\n * GET /api/contabilidad-diaria/:pointId/:fecha/resumen-cierre\n * Obtiene el resumen de movimientos preparado para el cierre\n */\nrouter.get(\n  \"/:pointId/:fecha/resumen-cierre\",\n  authenticateToken,\n  async (req, res) => {\n    try {\n      const { pointId, fecha } = req.params;\n      const usuario = req.user as\n        | {\n            id: string;\n            punto_atencion_id?: string;\n            rol?: RolUsuario;\n          }\n        | undefined;\n\n      if (!usuario?.id) {\n        return res\n          .status(401)\n          .json({ success: false, error: \"No autenticado\" });\n      }\n\n      if (!pointId) {\n        return res.status(400).json({ success: false, error: \"Falta pointId\" });\n      }\n\n      // Seguridad: operadores solo pueden consultar su propio punto\n      const esAdmin =\n        (usuario?.rol === \"ADMIN\" || usuario?.rol === \"SUPER_USUARIO\") ?? false;\n      \n      // Si es operador, debe tener acceso al punto\n      if (!esAdmin) {\n        // Si no es admin, verificar que sea operador del punto\n        if (!usuario?.punto_atencion_id || usuario.punto_atencion_id !== pointId) {\n          return res.status(403).json({\n            success: false,\n            error: \"No autorizado para consultar otro punto de atenci├│n\",\n          });\n        }\n      }\n\n      // Validar fecha\n      gyeParseDateOnly(fecha);\n      const fechaDate = new Date(`${fecha}T00:00:00.000Z`);\n\n      // Verificar si ya existe un cierre\n      const estadoCierre = await cierreService.obtenerEstadoCierre(\n        pointId,\n        fechaDate\n      );\n\n      if (estadoCierre.existe && estadoCierre.estado === \"CERRADO\") {\n        return res.status(200).json({\n          success: true,\n          cerrado: true,\n          mensaje: \"El cierre de este d├¡a ya fue completado\",\n          cierre: estadoCierre.cierre,\n        });\n      }\n\n      // Obtener resumen de movimientos\n      const resumen = await cierreService.obtenerResumenMovimientos(\n        pointId,\n        fechaDate,\n        usuario.id\n      );\n\n      if (!resumen.success) {\n        return res.status(500).json(resumen);\n      }\n\n      return res.status(200).json({\n        ...resumen,\n        cerrado: false,\n      });\n    } catch (error) {\n      logger.error(\"Error en GET /contabilidad-diaria/resumen-cierre\", {\n        error: error instanceof Error ? error.message : String(error),\n        stack: error instanceof Error ? error.stack : undefined,\n      });\n      return res.status(500).json({\n        success: false,\n        error: \"Error interno del servidor\",\n      });\n    }\n  }\n);\n\n/**\n * POST /api/contabilidad-diaria/:pointId/:fecha/cerrar-completo\n * Realiza el cierre diario completo del punto de atenci├│n\n */\nrouter.post(\n  \"/:pointId/:fecha/cerrar-completo\",\n  authenticateToken,\n  async (req, res) => {\n    try {\n      const { pointId, fecha } = req.params;\n      const { detalles, observaciones } = req.body;\n      const usuario = req.user as\n        | {\n            id: string;\n            punto_atencion_id?: string;\n            rol?: string;\n          }\n        | undefined;\n\n      if (!pointId || !fecha) {\n        return res.status(400).json({\n          success: false,\n          error: \"Falta pointId o fecha\",\n        });\n      }\n\n      if (!Array.isArray(detalles) || detalles.length === 0) {\n        return res.status(400).json({\n          success: false,\n          error: \"Debe proporcionar detalles del cuadre\",\n        });\n      }\n\n      // Validar permisos\n      const esAdmin =\n        (usuario?.rol === \"ADMIN\" || usuario?.rol === \"SUPER_USUARIO\") ?? false;\n      if (\n        !esAdmin &&\n        usuario?.punto_atencion_id &&\n        usuario.punto_atencion_id !== pointId\n      ) {\n        return res.status(403).json({\n          success: false,\n          error: \"No autorizado para cerrar otro punto de atenci├│n\",\n        });\n      }\n\n      // Validar YYYY-MM-DD\n      gyeParseDateOnly(fecha);\n      const fechaDate = new Date(`${fecha}T00:00:00.000Z`);\n\n      // Buscar cuadre abierto del d├¡a\n      const cuadreAbierto = await prisma.cuadreCaja.findFirst({\n        where: {\n          punto_atencion_id: pointId,\n          fecha: { gte: new Date(fecha + \"T00:00:00.000Z\") },\n          estado: \"ABIERTO\",\n        },\n      });\n\n      if (!cuadreAbierto) {\n        return res.status(400).json({\n          success: false,\n          error: \"No hay cuadre abierto para esta fecha\",\n        });\n      }\n\n      // Actualizar cuadre a CERRADO\n      const cuadreCerrado = await prisma.cuadreCaja.update({\n        where: { id: cuadreAbierto.id },\n        data: {\n          estado: \"CERRADO\",\n          fecha_cierre: new Date(),\n          observaciones: observaciones || \"\",\n        },\n      });\n\n      // Actualizar o crear detalles del cuadre\n      for (const detalle of detalles) {\n        const detalleExistente = await prisma.detalleCuadreCaja.findFirst({\n          where: {\n            cuadre_id: cuadreAbierto.id,\n            moneda_id: detalle.moneda_id,\n          },\n        });\n\n        if (detalleExistente) {\n          await prisma.detalleCuadreCaja.update({\n            where: { id: detalleExistente.id },\n            data: {\n              conteo_fisico: detalle.conteo_fisico,\n              billetes: detalle.billetes || 0,\n              monedas_fisicas: detalle.monedas_fisicas || 0,\n              diferencia:\n                detalle.conteo_fisico - detalle.saldo_cierre_teorico || 0,\n              observaciones_detalle: detalle.observaciones_detalle || \"\",\n            },\n          });\n        } else {\n          // Crear nuevo detalle si no existe\n          await prisma.detalleCuadreCaja.create({\n            data: {\n              cuadre_id: cuadreAbierto.id,\n              moneda_id: detalle.moneda_id,\n              saldo_apertura: detalle.saldo_apertura || 0,\n              saldo_cierre: detalle.saldo_cierre_teorico || 0,\n              conteo_fisico: detalle.conteo_fisico,\n              billetes: detalle.billetes || 0,\n              monedas_fisicas: detalle.monedas_fisicas || 0,\n              diferencia:\n                detalle.conteo_fisico - (detalle.saldo_cierre_teorico || 0),\n              observaciones_detalle: detalle.observaciones_detalle || \"\",\n            },\n          });\n        }\n      }\n\n      logger.info(\"Ô£à Cierre diario completado\", {\n        cuadre_id: cuadreCerrado.id,\n        punto_atencion_id: pointId,\n        usuario_id: usuario?.id,\n        fecha,\n      });\n\n      return res.status(200).json({\n        success: true,\n        cierre_id: cuadreCerrado.id,\n        cuadre_id: cuadreCerrado.id,\n        mensaje: \"Cierre diario completado exitosamente\",\n        jornada_finalizada: true,\n      });\n    } catch (error) {\n      logger.error(\"Error en POST /contabilidad-diaria/cerrar-completo\", {\n        error: error instanceof Error ? error.message : String(error),\n        stack: error instanceof Error ? error.stack : undefined,\n      });\n      return res.status(500).json({\n        success: false,\n        error: \"Error interno del servidor\",\n      });\n    }\n  }\n);\n\nexport default router;\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\oswal\\OneDrive\\Documentos\\Punto Cambio\\punto_cambio_new\\server\\routes\\cuadreCaja.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\oswal\\OneDrive\\Documentos\\Punto Cambio\\punto_cambio_new\\server\\routes\\currencies.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\oswal\\OneDrive\\Documentos\\Punto Cambio\\punto_cambio_new\\server\\routes\\currency-behavior.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\oswal\\OneDrive\\Documentos\\Punto Cambio\\punto_cambio_new\\server\\routes\\exchanges.ts","messages":[{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'ServientregaValidationService' is defined but never used. Allowed unused vars must match /^_/u.","line":11,"column":10,"nodeType":null,"messageId":"unusedVar","endLine":11,"endColumn":39},{"ruleId":"prefer-const","severity":1,"message":"'tasa_cambio_billetes' is never reassigned. Use 'const' instead.","line":330,"column":9,"nodeType":"Identifier","messageId":"useConst","endLine":330,"endColumn":29},{"ruleId":"prefer-const","severity":1,"message":"'tasa_cambio_monedas' is never reassigned. Use 'const' instead.","line":331,"column":9,"nodeType":"Identifier","messageId":"useConst","endLine":331,"endColumn":28},{"ruleId":"prefer-const","severity":1,"message":"'tipo_operacion' is never reassigned. Use 'const' instead.","line":332,"column":9,"nodeType":"Identifier","messageId":"useConst","endLine":332,"endColumn":23},{"ruleId":"prefer-const","severity":1,"message":"'punto_atencion_id' is never reassigned. Use 'const' instead.","line":333,"column":9,"nodeType":"Identifier","messageId":"useConst","endLine":333,"endColumn":26},{"ruleId":"prefer-const","severity":1,"message":"'datos_cliente' is never reassigned. Use 'const' instead.","line":334,"column":9,"nodeType":"Identifier","messageId":"useConst","endLine":334,"endColumn":22},{"ruleId":"prefer-const","severity":1,"message":"'observacion' is never reassigned. Use 'const' instead.","line":341,"column":9,"nodeType":"Identifier","messageId":"useConst","endLine":341,"endColumn":20},{"ruleId":"prefer-const","severity":1,"message":"'metodo_entrega' is never reassigned. Use 'const' instead.","line":342,"column":9,"nodeType":"Identifier","messageId":"useConst","endLine":342,"endColumn":23},{"ruleId":"prefer-const","severity":1,"message":"'transferencia_numero' is never reassigned. Use 'const' instead.","line":348,"column":9,"nodeType":"Identifier","messageId":"useConst","endLine":348,"endColumn":29},{"ruleId":"prefer-const","severity":1,"message":"'transferencia_banco' is never reassigned. Use 'const' instead.","line":349,"column":9,"nodeType":"Identifier","messageId":"useConst","endLine":349,"endColumn":28},{"ruleId":"prefer-const","severity":1,"message":"'transferencia_imagen_url' is never reassigned. Use 'const' instead.","line":350,"column":9,"nodeType":"Identifier","messageId":"useConst","endLine":350,"endColumn":33},{"ruleId":"prefer-const","severity":1,"message":"'abono_inicial_monto' is never reassigned. Use 'const' instead.","line":351,"column":9,"nodeType":"Identifier","messageId":"useConst","endLine":351,"endColumn":28},{"ruleId":"prefer-const","severity":1,"message":"'abono_inicial_fecha' is never reassigned. Use 'const' instead.","line":352,"column":9,"nodeType":"Identifier","messageId":"useConst","endLine":352,"endColumn":28},{"ruleId":"prefer-const","severity":1,"message":"'abono_inicial_recibido_por' is never reassigned. Use 'const' instead.","line":353,"column":9,"nodeType":"Identifier","messageId":"useConst","endLine":353,"endColumn":35},{"ruleId":"prefer-const","severity":1,"message":"'saldo_pendiente' is never reassigned. Use 'const' instead.","line":354,"column":9,"nodeType":"Identifier","messageId":"useConst","endLine":354,"endColumn":24},{"ruleId":"prefer-const","severity":1,"message":"'referencia_cambio_principal' is never reassigned. Use 'const' instead.","line":355,"column":9,"nodeType":"Identifier","messageId":"useConst","endLine":355,"endColumn":36},{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'idCliente' is assigned a value but never used. Allowed unused vars must match /^_/u.","line":620,"column":13,"nodeType":null,"messageId":"unusedVar","endLine":620,"endColumn":22},{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'totalFisicoRequerido' is assigned a value but never used. Allowed unused vars must match /^_/u.","line":1167,"column":17,"nodeType":null,"messageId":"unusedVar","endLine":1167,"endColumn":37}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":18,"fixableErrorCount":0,"fixableWarningCount":0,"source":"// server/routes/exchanges.ts\nimport express from \"express\";\nimport {\n  EstadoTransaccion,\n  Prisma,\n  TipoOperacion,\n  TipoViaTransferencia,\n} from \"@prisma/client\";\nimport prisma from \"../lib/prisma.js\";\nimport logger from \"../utils/logger.js\";\nimport { ServientregaValidationService } from \"../services/servientregaValidationService.js\";\nimport { authenticateToken, requireRole } from \"../middleware/auth.js\";\nimport { validate } from \"../middleware/validation.js\";\nimport { validarSaldoCambioDivisa } from \"../middleware/saldoValidation.js\";\nimport { z } from \"zod\";\nimport axios from \"axios\";\nimport {\n  todayGyeDateOnly,\n  gyeDayRangeUtcFromDateOnly,\n} from \"../utils/timezone.js\";\nimport {\n  registrarMovimientoSaldo,\n  TipoMovimiento,\n  TipoReferencia,\n} from \"../services/movimientoSaldoService.js\";\n\nconst router = express.Router();\n\n/* ========================= Helpers num├®ricos / guardas ========================= */\n\ntype JsonRecord = Record<string, unknown>;\n\nconst isRecord = (v: unknown): v is JsonRecord =>\n  typeof v === \"object\" && v !== null && !Array.isArray(v);\n\nconst getStringFromRecord = (r: JsonRecord, key: string): string | undefined => {\n  const v = r[key];\n  return typeof v === \"string\" ? v : undefined;\n};\n\nconst parseJsonIfString = (v: unknown): unknown => {\n  if (typeof v !== \"string\") return v;\n  try {\n    return JSON.parse(v);\n  } catch {\n    return v;\n  }\n};\n\nconst extractDatosClienteFromDatosOperacion = (\n  datosOperacion: unknown\n): JsonRecord | null => {\n  const parsed = parseJsonIfString(datosOperacion);\n  if (!isRecord(parsed)) return null;\n  const dc = parsed[\"datos_cliente\"] ?? parsed[\"cliente\"];\n  return isRecord(dc) ? dc : null;\n};\n\nconst getIdFromUnknown = (v: unknown): string | null => {\n  if (!isRecord(v)) return null;\n  const id = v[\"id\"];\n  return typeof id === \"string\" ? id : null;\n};\n\nconst num = (v: unknown, d = 0) => {\n  const n = Number(v);\n  return Number.isFinite(n) ? n : d;\n};\nconst isUSDByCode = (codigo?: string | null) =>\n  (codigo || \"\").toUpperCase() === \"USD\";\n\nconst round2 = (x: number) =>\n  Math.round((Number(x) + Number.EPSILON) * 100) / 100;\n// General rounding helper for N decimals (useful for DB fields with scale > 2)\nconst roundN = (x: number, n = 3) => {\n  const factor = Math.pow(10, n);\n  return Math.round((Number(x) + Number.EPSILON) * factor) / factor;\n};\n\nasync function getSaldo(\n  tx: Prisma.TransactionClient,\n  puntoId: string,\n  monedaId: string\n) {\n  return tx.saldo.findUnique({\n    where: {\n      punto_atencion_id_moneda_id: {\n        punto_atencion_id: puntoId,\n        moneda_id: monedaId,\n      },\n    },\n  });\n}\nasync function upsertSaldoEfectivoYBancos(\n  tx: Prisma.TransactionClient,\n  puntoId: string,\n  monedaId: string,\n  data: {\n    cantidad?: number;\n    billetes?: number;\n    monedas_fisicas?: number;\n    bancos?: number;\n  }\n) {\n  const existing = await getSaldo(tx, puntoId, monedaId);\n  if (existing) {\n    // Calcular los nuevos valores\n    const newBilletes = typeof data.billetes === \"number\" ? round2(data.billetes) : existing.billetes;\n    const newMonedas = typeof data.monedas_fisicas === \"number\" ? round2(data.monedas_fisicas) : existing.monedas_fisicas;\n    const newBancos = typeof data.bancos === \"number\" ? round2(data.bancos) : (existing.bancos || 0);\n    \n    // Calcular cantidad autom├íticamente como suma de billetes + monedas + bancos\n    const cantidadCalculada = round2(Number(newBilletes) + Number(newMonedas) + Number(newBancos));\n    \n    return tx.saldo.update({\n      where: {\n        punto_atencion_id_moneda_id: {\n          punto_atencion_id: puntoId,\n          moneda_id: monedaId,\n        },\n      },\n      data: {\n        cantidad: cantidadCalculada,\n        ...(typeof data.billetes === \"number\" && {\n          billetes: newBilletes,\n        }),\n        ...(typeof data.monedas_fisicas === \"number\" && {\n          monedas_fisicas: newMonedas,\n        }),\n        ...(typeof existing.bancos !== \"undefined\"\n          ? {\n              bancos: newBancos,\n            }\n          : {}),\n        updated_at: new Date(),\n      },\n    });\n  }\n  \n  // Para crear un nuevo saldo, calcular cantidad autom├íticamente\n  const billetes = round2(data.billetes ?? 0);\n  const monedas = round2(data.monedas_fisicas ?? 0);\n  const bancos = round2(data.bancos ?? 0);\n  const cantidadCalculada = round2(Number(billetes) + Number(monedas) + Number(bancos));\n  \n  return tx.saldo.create({\n    data: {\n      punto_atencion_id: puntoId,\n      moneda_id: monedaId,\n      cantidad: cantidadCalculada,\n      billetes: billetes,\n      monedas_fisicas: monedas,\n      ...(typeof data.bancos !== \"undefined\"\n        ? { bancos: bancos }\n        : {}),\n      updated_at: new Date(),\n    },\n  });\n}\n\nasync function logMovimientoSaldo(\n  tx: Prisma.TransactionClient,\n  data: {\n    punto_atencion_id: string;\n    moneda_id: string;\n    tipo_movimiento: \"INGRESO\" | \"EGRESO\" | \"AJUSTE\";\n    monto: number;\n    saldo_anterior: number;\n    saldo_nuevo: number;\n    usuario_id: string;\n    referencia_id: string;\n    tipo_referencia:\n      | \"CAMBIO_DIVISA\"\n      | \"TRANSFERENCIA\"\n      | \"SERVICIO_EXTERNO\"\n      | \"AJUSTE_MANUAL\"\n      | \"RECIBO\";\n    descripcion?: string | null;\n    saldo_bucket?: \"CAJA\" | \"BANCOS\" | \"NINGUNO\";\n  }\n) {\n  try {\n    // Usar servicio centralizado\n    const tipoMov =\n      data.tipo_movimiento === \"INGRESO\"\n        ? TipoMovimiento.INGRESO\n        : data.tipo_movimiento === \"EGRESO\"\n        ? TipoMovimiento.EGRESO\n        : TipoMovimiento.AJUSTE;\n\n    const tipoRef =\n      data.tipo_referencia === \"CAMBIO_DIVISA\"\n        ? TipoReferencia.EXCHANGE\n        : data.tipo_referencia === \"TRANSFERENCIA\"\n        ? TipoReferencia.TRANSFER\n        : data.tipo_referencia === \"SERVICIO_EXTERNO\"\n        ? TipoReferencia.SERVICIO_EXTERNO\n        : TipoReferencia.AJUSTE_MANUAL;\n\n    // registrarMovimientoSaldo espera:\n    // - INGRESO/EGRESO: monto SIN signo (positivo), el servicio aplica el signo\n    // - AJUSTE: mantiene el signo original (puede ser + o -)\n    const montoParaServicio =\n      tipoMov === TipoMovimiento.AJUSTE ? data.monto : Math.abs(data.monto);\n\n    await registrarMovimientoSaldo(\n      {\n        puntoAtencionId: data.punto_atencion_id,\n        monedaId: data.moneda_id,\n        tipoMovimiento: tipoMov,\n        monto: montoParaServicio,\n        saldoAnterior: round2(data.saldo_anterior),\n        saldoNuevo: round2(data.saldo_nuevo),\n        tipoReferencia: tipoRef,\n        referenciaId: data.referencia_id,\n        descripcion: data.descripcion || undefined,\n        saldoBucket: data.saldo_bucket,\n        usuarioId: data.usuario_id,\n      },\n      tx\n    ); // ÔÜá´©Å Pasar el cliente de transacci├│n para atomicidad\n  } catch (error) {\n    console.error('[ERROR] logMovimientoSaldo fall├│:', {\n      referencia_id: data.referencia_id,\n      tipo_referencia: data.tipo_referencia,\n      tipo_movimiento: data.tipo_movimiento,\n      monto: data.monto,\n      error: error instanceof Error ? error.message : String(error)\n    });\n    throw error; // Re-lanzar para que la transacci├│n falle\n  }\n}\n\n/* ========================= Validaci├│n payload ========================= */\n\nconst exchangeSchema = z.object({\n  moneda_origen_id: z.string().uuid(),\n  moneda_destino_id: z.string().uuid(),\n  monto_origen: z.number().positive(),\n  monto_destino: z.number().positive(),\n\n  tasa_cambio_billetes: z.number().nonnegative().default(0),\n  tasa_cambio_monedas: z.number().nonnegative().default(0),\n\n  tipo_operacion: z.nativeEnum(TipoOperacion),\n  punto_atencion_id: z.string().uuid(),\n  datos_cliente: z.object({\n    nombre: z.string(),\n    apellido: z.string(),\n    documento: z.string().optional().nullable(),\n    cedula: z.string(),\n    telefono: z.string().optional(),\n  }),\n\n  // MONEDA ORIGEN (lo que entrega el cliente)\n  divisas_entregadas_billetes: z.number().default(0),\n  divisas_entregadas_monedas: z.number().default(0),\n  divisas_entregadas_total: z.number().default(0),\n\n  // MONEDA DESTINO (lo que recibe el cliente)\n  divisas_recibidas_billetes: z.number().default(0),\n  divisas_recibidas_monedas: z.number().default(0),\n  divisas_recibidas_total: z.number().default(0),\n\n  // DESTINO: Entrega USD (efectivo/transfer/mixto) ÔÇô para reporte y bancos\n  metodo_entrega: z\n    .enum([\"efectivo\", \"transferencia\", \"mixto\"])\n    .default(\"efectivo\"),\n  usd_entregado_efectivo: z.number().optional().nullable(),\n  usd_entregado_transfer: z.number().optional().nullable(),\n\n  // ORIGEN: m├®todo de pago del cliente\n  metodo_pago_origen: z\n    .nativeEnum(TipoViaTransferencia)\n    .default(TipoViaTransferencia.EFECTIVO), // EFECTIVO | BANCO | MIXTO\n  usd_recibido_efectivo: z.number().optional().nullable(),\n  usd_recibido_transfer: z.number().optional().nullable(),\n\n  observacion: z.string().optional(),\n  transferencia_numero: z.string().optional().nullable(),\n  transferencia_banco: z.string().optional().nullable(),\n  transferencia_imagen_url: z.string().optional().nullable(),\n  abono_inicial_monto: z.number().optional().nullable(),\n  abono_inicial_fecha: z.string().optional().nullable(),\n  abono_inicial_recibido_por: z.string().optional().nullable(),\n  saldo_pendiente: z.number().optional().nullable(),\n  referencia_cambio_principal: z.string().optional().nullable(),\n});\n\ninterface ExchangeWhereClause {\n  punto_atencion_id?: string;\n  usuario_id?: string;\n  estado?: EstadoTransaccion;\n}\n\ninterface AuthenticatedUser {\n  id: string;\n  username: string;\n  nombre: string;\n  rol: string;\n  activo: boolean;\n  punto_atencion_id: string | null;\n}\ninterface AuthenticatedRequest extends express.Request {\n  user?: AuthenticatedUser;\n}\n\n/* ========================= Crear cambio ========================= */\n\nrouter.post(\n  \"/\",\n  authenticateToken,\n  validate(exchangeSchema),\n  validarSaldoCambioDivisa, // ­ƒøí´©Å Validar saldo suficiente antes del cambio\n  async (req: AuthenticatedRequest, res: express.Response): Promise<void> => {\n    try {\n      const userId = req.user?.id;\n      if (!userId) {\n        res\n          .status(401)\n          .json({ success: false, error: \"Usuario no autenticado\" });\n        return;\n      }\n\n      let {\n        moneda_origen_id,\n        moneda_destino_id,\n        monto_origen,\n        monto_destino,\n        tasa_cambio_billetes,\n        tasa_cambio_monedas,\n        tipo_operacion,\n        punto_atencion_id,\n        datos_cliente,\n        divisas_entregadas_billetes,\n        divisas_entregadas_monedas,\n        divisas_entregadas_total,\n        divisas_recibidas_billetes,\n        divisas_recibidas_monedas,\n        divisas_recibidas_total,\n        observacion,\n        metodo_entrega,\n        usd_entregado_efectivo,\n        usd_entregado_transfer,\n        metodo_pago_origen,\n        usd_recibido_efectivo,\n        usd_recibido_transfer,\n        transferencia_numero,\n        transferencia_banco,\n        transferencia_imagen_url,\n        abono_inicial_monto,\n        abono_inicial_fecha,\n        abono_inicial_recibido_por,\n        saldo_pendiente,\n        referencia_cambio_principal,\n      } = req.body;\n\n      // Normalizaci├│n del par cuando una de las monedas es USD (COMPRA -> USD destino, VENTA -> USD origen)\n      try {\n        const usdMoneda = await prisma.moneda.findFirst({\n          where: { codigo: \"USD\" },\n        });\n        if (\n          usdMoneda &&\n          (moneda_origen_id === usdMoneda.id ||\n            moneda_destino_id === usdMoneda.id)\n        ) {\n          const isCompra = tipo_operacion === \"COMPRA\";\n          const isVenta = tipo_operacion === \"VENTA\";\n          if (isCompra && moneda_origen_id === usdMoneda.id) {\n            [moneda_origen_id, moneda_destino_id] = [\n              moneda_destino_id,\n              moneda_origen_id,\n            ];\n            [monto_origen, monto_destino] = [monto_destino, monto_origen];\n            [divisas_entregadas_billetes, divisas_recibidas_billetes] = [\n              divisas_recibidas_billetes,\n              divisas_entregadas_billetes,\n            ];\n            [divisas_entregadas_monedas, divisas_recibidas_monedas] = [\n              divisas_recibidas_monedas,\n              divisas_entregadas_monedas,\n            ];\n            [divisas_entregadas_total, divisas_recibidas_total] = [\n              divisas_recibidas_total,\n              divisas_entregadas_total,\n            ];\n          } else if (isVenta && moneda_destino_id === usdMoneda.id) {\n            [moneda_origen_id, moneda_destino_id] = [\n              moneda_destino_id,\n              moneda_origen_id,\n            ];\n            [monto_origen, monto_destino] = [monto_destino, monto_origen];\n            [divisas_entregadas_billetes, divisas_recibidas_billetes] = [\n              divisas_recibidas_billetes,\n              divisas_entregadas_billetes,\n            ];\n            [divisas_entregadas_monedas, divisas_recibidas_monedas] = [\n              divisas_recibidas_monedas,\n              divisas_entregadas_monedas,\n            ];\n            [divisas_entregadas_total, divisas_recibidas_total] = [\n              divisas_recibidas_total,\n              divisas_entregadas_total,\n            ];\n          }\n        }\n      } catch (e) {\n        logger.warn(\"No se pudo normalizar par USD (continuando)\", {\n          error: e instanceof Error ? e.message : String(e),\n        });\n      }\n\n      // Monedas distintas\n      if (moneda_origen_id === moneda_destino_id) {\n        res.status(400).json({\n          success: false,\n          error: \"Moneda origen y destino no pueden ser iguales\",\n        });\n        return;\n      }\n\n      // Validaci├│n m├¡nima de transferencia (solo para la ENTREGA)\n      if (metodo_entrega === \"transferencia\") {\n        if (!transferencia_banco || !String(transferencia_banco).trim()) {\n          res.status(400).json({\n            success: false,\n            error: \"Banco requerido para transferencia\",\n          });\n          return;\n        }\n        if (!transferencia_numero || !String(transferencia_numero).trim()) {\n          res.status(400).json({\n            success: false,\n            error: \"N├║mero de referencia requerido para transferencia\",\n          });\n          return;\n        }\n      }\n\n      const punto = await prisma.puntoAtencion.findUnique({\n        where: { id: punto_atencion_id },\n      });\n      if (!punto) {\n        res\n          .status(400)\n          .json({ success: false, error: \"Punto de atenci├│n no encontrado\" });\n        return;\n      }\n\n      const [monedaOrigen, monedaDestino] = await Promise.all([\n        prisma.moneda.findUnique({ where: { id: moneda_origen_id } }),\n        prisma.moneda.findUnique({ where: { id: moneda_destino_id } }),\n      ]);\n      if (!monedaOrigen || !monedaDestino) {\n        res.status(400).json({\n          success: false,\n          error: \"Una o ambas monedas no fueron encontradas\",\n        });\n        return;\n      }\n\n      // === Conversi├│n por convenci├│n de tasa (multiplicar/dividir seg├║n divisa) ===\n      type RateMode = \"USD_PER_UNIT\" | \"UNITS_PER_USD\";\n      const rateModeByCode: Record<string, RateMode> = {\n        EUR: \"USD_PER_UNIT\",\n        GBP: \"USD_PER_UNIT\",\n        CHF: \"USD_PER_UNIT\",\n        JPY: \"USD_PER_UNIT\",\n        COP: \"UNITS_PER_USD\",\n        PYG: \"UNITS_PER_USD\",\n        CLP: \"UNITS_PER_USD\",\n        PEN: \"UNITS_PER_USD\",\n        ARS: \"UNITS_PER_USD\",\n        MXN: \"UNITS_PER_USD\",\n        BRL: \"UNITS_PER_USD\",\n        UYU: \"UNITS_PER_USD\",\n        DOP: \"UNITS_PER_USD\",\n      };\n      const tasaEfectiva =\n        num(tasa_cambio_billetes) > 0\n          ? num(tasa_cambio_billetes)\n          : num(tasa_cambio_monedas) > 0\n          ? num(tasa_cambio_monedas)\n          : 0;\n\n      const codigoOrigen = (monedaOrigen?.codigo || \"\").toUpperCase();\n      const codigoDestino = (monedaDestino?.codigo || \"\").toUpperCase();\n\n      function getRateModeForPair(\n        codOrigen: string,\n        codDestino: string\n      ): RateMode {\n        if (codOrigen === \"USD\" && codDestino !== \"USD\") {\n          return rateModeByCode[codDestino] ?? \"UNITS_PER_USD\";\n        }\n        if (codDestino === \"USD\" && codOrigen !== \"USD\") {\n          return rateModeByCode[codOrigen] ?? \"UNITS_PER_USD\";\n        }\n        return rateModeByCode[codDestino] ?? \"USD_PER_UNIT\";\n      }\n\n      function convertir(\n        _tipo: TipoOperacion,\n        modo: RateMode,\n        montoOrigen: number,\n        tasa: number,\n        codOrigen: string,\n        codDestino: string\n      ) {\n        if (!Number.isFinite(tasa) || tasa <= 0) return { montoDestinoCalc: 0 };\n\n        if (codOrigen === \"USD\" && codDestino !== \"USD\") {\n          // VENTA: USD -> DIVISA\n          if (modo === \"UNITS_PER_USD\")\n            return { montoDestinoCalc: montoOrigen * tasa };\n          return { montoDestinoCalc: montoOrigen / tasa };\n        }\n        if (codDestino === \"USD\" && codOrigen !== \"USD\") {\n          // COMPRA: DIVISA -> USD\n          if (modo === \"UNITS_PER_USD\")\n            return { montoDestinoCalc: montoOrigen / tasa };\n          return { montoDestinoCalc: montoOrigen * tasa };\n        }\n        // Cross (no USD): no forzamos c├ílculo\n        return { montoDestinoCalc: 0 };\n      }\n\n      // === Recalcular totales coherentes (manteniendo compatibilidad) ===\n      const entregadas_total_calc =\n        num(divisas_entregadas_billetes) + num(divisas_entregadas_monedas);\n      const recibidas_total_calc =\n        num(divisas_recibidas_billetes) + num(divisas_recibidas_monedas);\n\n      const monto_origen_final =\n        num(monto_origen) > 0 ? num(monto_origen) : entregadas_total_calc;\n      let monto_destino_final =\n        num(monto_destino) > 0 ? num(monto_destino) : recibidas_total_calc;\n\n      const divisas_entregadas_total_final =\n        num(divisas_entregadas_total) > 0\n          ? num(divisas_entregadas_total)\n          : entregadas_total_calc;\n\n      const divisas_recibidas_total_final =\n        num(divisas_recibidas_total) > 0\n          ? num(divisas_recibidas_total)\n          : recibidas_total_calc;\n\n      // Recalcular destino si est├í en cero (aunque vengan parciales de UI)\n      if (\n        (tasaEfectiva > 0 || num(tasa_cambio_billetes) > 0 || num(tasa_cambio_monedas) > 0) &&\n        (codigoOrigen === \"USD\" || codigoDestino === \"USD\")\n      ) {\n        const modo = getRateModeForPair(codigoOrigen, codigoDestino);\n        if (monto_destino_final === 0 && monto_origen_final > 0) {\n          let totalCalc = 0;\n          const entBilletes = num(divisas_entregadas_billetes);\n          const entMonedas = num(divisas_entregadas_monedas);\n          const tasaB = num(tasa_cambio_billetes);\n          const tasaM = num(tasa_cambio_monedas);\n\n          // Calcular por componente usando su tasa correspondiente\n          if (entBilletes > 0 && tasaB > 0) {\n            const { montoDestinoCalc } = convertir(\n              tipo_operacion,\n              modo,\n              entBilletes,\n              tasaB,\n              codigoOrigen,\n              codigoDestino\n            );\n            if (montoDestinoCalc > 0) totalCalc += montoDestinoCalc;\n          }\n          if (entMonedas > 0 && tasaM > 0) {\n            const { montoDestinoCalc } = convertir(\n              tipo_operacion,\n              modo,\n              entMonedas,\n              tasaM,\n              codigoOrigen,\n              codigoDestino\n            );\n            if (montoDestinoCalc > 0) totalCalc += montoDestinoCalc;\n          }\n\n          // Si no hubo desagregaci├│n ├║til, caer al c├ílculo con tasa efectiva\n          if (totalCalc === 0 && tasaEfectiva > 0) {\n            const { montoDestinoCalc } = convertir(\n              tipo_operacion,\n              modo,\n              monto_origen_final,\n              tasaEfectiva,\n              codigoOrigen,\n              codigoDestino\n            );\n            if (montoDestinoCalc > 0) totalCalc = montoDestinoCalc;\n          }\n\n          if (totalCalc > 0) {\n            monto_destino_final = round2(totalCalc);\n          }\n        }\n      }\n\n      if (!(monto_origen_final > 0 && monto_destino_final > 0)) {\n        res.status(400).json({\n          success: false,\n          error: \"Montos inv├ílidos: deben ser mayores a 0\",\n          details: {\n            monto_origen: monto_origen_final,\n            monto_destino: monto_destino_final,\n          },\n        });\n        return;\n      }\n\n      // Normalizaci├│n de datos de cliente\n      // Validar identificaci├│n del cliente (cedula o documento)\n      const idCliente = String(\n        (datos_cliente?.documento && String(datos_cliente.documento).trim()) ||\n        (datos_cliente?.cedula && String(datos_cliente.cedula).trim()) ||\n        \"\"\n      );\n      const datos_cliente_sanitized = {\n        ...datos_cliente,\n        documento:\n          (datos_cliente?.documento && String(datos_cliente.documento).trim()) ||\n          (datos_cliente?.cedula && String(datos_cliente.cedula).trim()) ||\n          \"\",\n      };\n\n      // Normalizar campos USD por m├®todo de entrega (solo para reportes; el CUADRE es solo EFECTIVO)\n      if (isUSDByCode(monedaDestino.codigo)) {\n        if (metodo_entrega === \"efectivo\") {\n          usd_entregado_efectivo = divisas_recibidas_total_final;\n          usd_entregado_transfer = 0;\n        } else if (metodo_entrega === \"transferencia\") {\n          usd_entregado_efectivo = 0;\n          usd_entregado_transfer = divisas_recibidas_total_final;\n        } else {\n          usd_entregado_efectivo = num(usd_entregado_efectivo);\n          usd_entregado_transfer = num(usd_entregado_transfer);\n          const tot = divisas_recibidas_total_final;\n          if (\n            round2(\n              (usd_entregado_efectivo || 0) + (usd_entregado_transfer || 0)\n            ) !== round2(tot)\n          ) {\n            // fallback prudente\n            usd_entregado_efectivo = round2(tot / 2);\n            usd_entregado_transfer = round2(tot - usd_entregado_efectivo);\n          }\n        }\n      }\n\n      // Normalizar ORIGEN (m├®todo de pago del cliente) ÔÇô solo para registrar bancos vs efectivo\n      metodo_pago_origen = metodo_pago_origen || TipoViaTransferencia.EFECTIVO;\n      if (metodo_pago_origen === TipoViaTransferencia.EFECTIVO) {\n        usd_recibido_efectivo = divisas_entregadas_total_final;\n        usd_recibido_transfer = 0;\n      } else if (metodo_pago_origen === TipoViaTransferencia.BANCO) {\n        usd_recibido_efectivo = 0;\n        usd_recibido_transfer = divisas_entregadas_total_final;\n      } else {\n        // MIXTO\n        usd_recibido_efectivo = num(usd_recibido_efectivo);\n        usd_recibido_transfer = num(usd_recibido_transfer);\n        const tot = divisas_entregadas_total_final;\n        if (\n          round2(\n            (usd_recibido_efectivo || 0) + (usd_recibido_transfer || 0)\n          ) !== round2(tot)\n        ) {\n          usd_recibido_efectivo = round2(tot / 2);\n          usd_recibido_transfer = round2(tot - usd_recibido_efectivo);\n        }\n      }\n\n      const numeroRecibo = `CAM-${Date.now()}-${Math.random()\n        .toString(36)\n        .slice(2, 6)}`;\n\n      // Validar que las tasas son n├║meros finitos y no absurdamente grandes.\n      // Solo validamos las tasas que corresponden a montos distintos de 0.\n      // Con la columna en Decimal(18,3) la parte entera puede ser muy grande,\n      // pero rechazamos valores no finitos o extremos por seguridad.\n      const MAX_RATE_ALLOWED = 1e12; // permite tasas muy grandes (ej. COP per USD ~ thousands)\n\n      const requiereTasaBilletes = Number(divisas_entregadas_billetes) > 0 || Number(divisas_recibidas_billetes) > 0;\n      const requiereTasaMonedas = Number(divisas_entregadas_monedas) > 0 || Number(divisas_recibidas_monedas) > 0;\n\n      const erroresTasas: string[] = [];\n\n      if (requiereTasaBilletes) {\n        const tb = Number(tasa_cambio_billetes);\n        if (!Number.isFinite(tb) || tb < 0 || Math.abs(tb) >= MAX_RATE_ALLOWED) {\n          erroresTasas.push(\"tasa_cambio_billetes inv├ílida\");\n        }\n      }\n\n      if (requiereTasaMonedas) {\n        const tm = Number(tasa_cambio_monedas);\n        if (!Number.isFinite(tm) || tm < 0 || Math.abs(tm) >= MAX_RATE_ALLOWED) {\n          erroresTasas.push(\"tasa_cambio_monedas inv├ílida\");\n        }\n      }\n\n      if (erroresTasas.length > 0) {\n        res.status(400).json({\n          success: false,\n          error: \"tasa_cambio fuera de rango o inv├ílida para almacenamiento.\",\n          detalles: {\n            requeridas: {\n              billetes: requiereTasaBilletes,\n              monedas: requiereTasaMonedas,\n            },\n            mensajes: erroresTasas,\n            max_integer_allowed: MAX_RATE_ALLOWED - 1,\n          },\n        });\n        return;\n      }\n\n      // ========= Transacci├│n at├│mica =========\n      const exchange = await prisma.$transaction(async (tx) => {\n        // Preparar tasas para almacenamiento: si no se requieren (no hay monto), guardar 0\n        const tasaBilletesToStore = requiereTasaBilletes\n          ? roundN(num(tasa_cambio_billetes), 3)\n          : 0;\n        const tasaMonedasToStore = requiereTasaMonedas\n          ? roundN(num(tasa_cambio_monedas), 3)\n          : 0;\n        // 1) Crear cambio\n        // DEBUG: mostrar payload que vamos a insertar en DB (evitar datos sensibles)\n        try {\n          console.log(\"[DEBUG] intento crear CambioDivisa con valores:\", JSON.stringify({\n            moneda_origen_id,\n            moneda_destino_id,\n            monto_origen: round2(monto_origen_final),\n            monto_destino: round2(monto_destino_final),\n            tasa_cambio_billetes: num(tasa_cambio_billetes),\n            tasa_cambio_monedas: num(tasa_cambio_monedas),\n          }));\n        } catch (dbgErr) {\n          console.warn(\"[DEBUG] No se pudo serializar payload de cambio:\", dbgErr);\n        }\n        const cambio = await tx.cambioDivisa.create({\n          data: {\n            moneda_origen_id,\n            moneda_destino_id,\n            monto_origen: round2(monto_origen_final),\n            monto_destino: round2(monto_destino_final),\n            tasa_cambio_billetes: tasaBilletesToStore,\n            tasa_cambio_monedas: tasaMonedasToStore,\n            tipo_operacion,\n            usuario_id: userId,\n            punto_atencion_id,\n            observacion: observacion || null,\n            numero_recibo: numeroRecibo,\n            estado:\n              num(saldo_pendiente) > 0\n                ? EstadoTransaccion.PENDIENTE\n                : EstadoTransaccion.COMPLETADO,\n            metodo_entrega,\n            transferencia_numero:\n              metodo_entrega !== \"efectivo\"\n                ? transferencia_numero || null\n                : null,\n            transferencia_banco:\n              metodo_entrega !== \"efectivo\"\n                ? transferencia_banco || null\n                : null,\n            transferencia_imagen_url:\n              metodo_entrega !== \"efectivo\"\n                ? transferencia_imagen_url || null\n                : null,\n            // DESTINO USD\n            usd_entregado_efectivo:\n              typeof usd_entregado_efectivo === \"number\"\n                ? round2(usd_entregado_efectivo)\n                : null,\n            usd_entregado_transfer:\n              typeof usd_entregado_transfer === \"number\"\n                ? round2(usd_entregado_transfer)\n                : null,\n            // ORIGEN (nuevo)\n            metodo_pago_origen,\n            usd_recibido_efectivo:\n              typeof usd_recibido_efectivo === \"number\"\n                ? round2(usd_recibido_efectivo)\n                : null,\n            usd_recibido_transfer:\n              typeof usd_recibido_transfer === \"number\"\n                ? round2(usd_recibido_transfer)\n                : null,\n\n            abono_inicial_monto:\n              typeof abono_inicial_monto === \"number\"\n                ? round2(abono_inicial_monto)\n                : null,\n            abono_inicial_fecha: abono_inicial_fecha\n              ? new Date(abono_inicial_fecha)\n              : null,\n            abono_inicial_recibido_por: abono_inicial_recibido_por ?? null,\n            saldo_pendiente:\n              typeof saldo_pendiente === \"number\"\n                ? round2(saldo_pendiente)\n                : null,\n            referencia_cambio_principal: referencia_cambio_principal ?? null,\n            cliente: `${datos_cliente_sanitized.nombre} ${datos_cliente_sanitized.apellido}`,\n            divisas_entregadas_billetes: round2(\n              num(divisas_entregadas_billetes)\n            ),\n            divisas_entregadas_monedas: round2(num(divisas_entregadas_monedas)),\n            divisas_entregadas_total: round2(divisas_entregadas_total_final),\n            divisas_recibidas_billetes: round2(num(divisas_recibidas_billetes)),\n            divisas_recibidas_monedas: round2(num(divisas_recibidas_monedas)),\n            divisas_recibidas_total: round2(divisas_recibidas_total_final),\n          },\n          select: {\n            id: true,\n            fecha: true,\n            tipo_operacion: true,\n            estado: true,\n            monto_origen: true,\n            monto_destino: true,\n            tasa_cambio_billetes: true,\n            tasa_cambio_monedas: true,\n            observacion: true,\n            numero_recibo: true,\n            numero_recibo_abono: true,\n            numero_recibo_completar: true,\n            cliente: true,\n            divisas_entregadas_total: true,\n            divisas_entregadas_billetes: true,\n            divisas_entregadas_monedas: true,\n            divisas_recibidas_total: true,\n            divisas_recibidas_billetes: true,\n            divisas_recibidas_monedas: true,\n            saldo_pendiente: true,\n            abono_inicial_monto: true,\n            abono_inicial_fecha: true,\n            fecha_completado: true,\n            metodo_entrega: true,\n            transferencia_banco: true,\n            transferencia_numero: true,\n            transferencia_imagen_url: true,\n            usd_entregado_efectivo: true,\n            usd_entregado_transfer: true,\n            // usd_recibido_efectivo: true,\n            // usd_recibido_transfer: true,\n            // metodo_pago_origen: true,\n            monedaOrigen: {\n              select: { id: true, nombre: true, codigo: true, simbolo: true },\n            },\n            monedaDestino: {\n              select: { id: true, nombre: true, codigo: true, simbolo: true },\n            },\n            usuario: { select: { id: true, nombre: true, username: true } },\n            puntoAtencion: { select: { id: true, nombre: true } },\n          },\n        });\n\n        // 2) Recibo\n        await tx.recibo.create({\n          data: {\n            numero_recibo: numeroRecibo,\n            tipo_operacion: \"CAMBIO_DIVISA\",\n            referencia_id: cambio.id,\n            usuario_id: userId,\n            punto_atencion_id,\n            datos_operacion: {\n              ...cambio,\n              datos_cliente: datos_cliente_sanitized,\n              divisas_entregadas: {\n                billetes: round2(num(divisas_entregadas_billetes)),\n                monedas: round2(num(divisas_entregadas_monedas)),\n                total: round2(divisas_entregadas_total_final),\n              },\n              divisas_recibidas: {\n                billetes: round2(num(divisas_recibidas_billetes)),\n                monedas: round2(num(divisas_recibidas_monedas)),\n                total: round2(divisas_recibidas_total_final),\n              },\n            },\n          },\n        });\n\n        // 3) SALDOS Y CUADRE DE CAJA\n        // ÔòÉÔòÉÔòÉÔòÉÔòÉÔòÉÔòÉÔòÉÔòÉÔòÉÔòÉÔòÉÔòÉÔòÉÔòÉÔòÉÔòÉÔòÉÔòÉÔòÉÔòÉÔòÉÔòÉÔòÉÔòÉÔòÉÔòÉÔòÉÔòÉÔòÉÔòÉÔòÉÔòÉÔòÉÔòÉÔòÉÔòÉÔòÉÔòÉÔòÉÔòÉÔòÉÔòÉÔòÉÔòÉÔòÉÔòÉÔòÉÔòÉÔòÉÔòÉÔòÉÔòÉÔòÉÔòÉÔòÉÔòÉÔòÉÔòÉÔòÉÔòÉÔòÉÔòÉÔòÉÔòÉÔòÉÔòÉÔòÉÔòÉÔòÉÔòÉ\n        // REGLAS DE NEGOCIO:\n        // 1. EFECTIVO: Se controla al centavo, afecta cuadre de caja\n        // 2. BANCOS: NO tiene l├¡mites, solo es registro, NO afecta cuadre\n        // 3. CAMBIOS PARCIALES: Cuando el punto no tiene divisas suficientes:\n        //    - Cliente deja abono inicial (ej: 30% del total)\n        //    - Sistema actualiza SOLO el 30% de los saldos f├¡sicos\n        //    - Cliente firma compromiso y regresa despu├®s\n        //    - Al completar, se actualiza el 70% restante\n        // 4. TRANSFERENCIAS: Poco com├║n, solo cuando hay cantidades muy grandes\n        // ÔòÉÔòÉÔòÉÔòÉÔòÉÔòÉÔòÉÔòÉÔòÉÔòÉÔòÉÔòÉÔòÉÔòÉÔòÉÔòÉÔòÉÔòÉÔòÉÔòÉÔòÉÔòÉÔòÉÔòÉÔòÉÔòÉÔòÉÔòÉÔòÉÔòÉÔòÉÔòÉÔòÉÔòÉÔòÉÔòÉÔòÉÔòÉÔòÉÔòÉÔòÉÔòÉÔòÉÔòÉÔòÉÔòÉÔòÉÔòÉÔòÉÔòÉÔòÉÔòÉÔòÉÔòÉÔòÉÔòÉÔòÉÔòÉÔòÉÔòÉÔòÉÔòÉÔòÉÔòÉÔòÉÔòÉÔòÉÔòÉÔòÉÔòÉÔòÉ\n\n        // Ô£à Calcular porcentaje de actualizaci├│n seg├║n estado\n        const porcentajeActualizacion =\n          cambio.estado === EstadoTransaccion.PENDIENTE &&\n          num(abono_inicial_monto) > 0\n            ? num(abono_inicial_monto) / monto_destino_final\n            : 1.0; // 100% si est├í completado o no hay abono\n\n        // 3.1 Origen (INGRESO efectivo/bancos seg├║n metodo_pago_origen)\n        const saldoOrigen = await getSaldo(\n          tx,\n          punto_atencion_id,\n          moneda_origen_id\n        );\n        const origenAnteriorEf = num(saldoOrigen?.cantidad);\n        let origenAnteriorBil = num(saldoOrigen?.billetes);\n        const origenAnteriorMon = num(saldoOrigen?.monedas_fisicas);\n        // Fallback: si ambos son 0 pero el total f├¡sico es positivo, asignar todo a billetes\n        if (origenAnteriorBil === 0 && origenAnteriorMon === 0 && origenAnteriorEf > 0) {\n          origenAnteriorBil = origenAnteriorEf;\n        }\n        const origenAnteriorBk =\n          typeof saldoOrigen?.bancos !== \"undefined\"\n            ? num(saldoOrigen?.bancos)\n            : 0;\n\n        // Ô£à APLICAR PORCENTAJE: Solo actualizar seg├║n el abono inicial si es PENDIENTE\n        const ingresoEf = round2(\n          num(usd_recibido_efectivo) * porcentajeActualizacion\n        );\n        const ingresoBk = round2(\n          num(usd_recibido_transfer) * porcentajeActualizacion\n        );\n\n        // breakdown f├¡sico solo si entra efectivo (tambi├®n aplicar porcentaje)\n        let ingresoBil = 0;\n        let ingresoMon = 0;\n\n        if (ingresoEf > 0) {\n          // Calcular proporci├│n de billetes y monedas\n          const totalEntregado =\n            num(divisas_entregadas_billetes) + num(divisas_entregadas_monedas);\n\n          if (totalEntregado > 0) {\n            const proporcionBilletes =\n              num(divisas_entregadas_billetes) / totalEntregado;\n            const proporcionMonedas =\n              num(divisas_entregadas_monedas) / totalEntregado;\n\n            // Aplicar proporci├│n al ingreso efectivo para mantener coherencia\n            ingresoBil = round2(ingresoEf * proporcionBilletes);\n            ingresoMon = round2(ingresoEf * proporcionMonedas);\n\n            // Ajustar por diferencias de redondeo: asegurar que billetes + monedas = total\n            const diferencia = ingresoEf - (ingresoBil + ingresoMon);\n            if (Math.abs(diferencia) > 0.01) {\n              // Si hay diferencia significativa, ajustar el componente mayor\n              if (ingresoBil >= ingresoMon) {\n                ingresoBil = round2(ingresoBil + diferencia);\n              } else {\n                ingresoMon = round2(ingresoMon + diferencia);\n              }\n            }\n          } else {\n            // Si no hay breakdown, todo va a billetes por defecto\n            ingresoBil = ingresoEf;\n            ingresoMon = 0;\n          }\n        }\n\n        const origenNuevoEf = round2(origenAnteriorEf + ingresoEf);\n        const origenNuevoBil = round2(origenAnteriorBil + ingresoBil);\n        const origenNuevoMon = round2(origenAnteriorMon + ingresoMon);\n        const origenNuevoBk = round2(origenAnteriorBk + ingresoBk);\n\n        await upsertSaldoEfectivoYBancos(\n          tx,\n          punto_atencion_id,\n          moneda_origen_id,\n          {\n            cantidad: origenNuevoEf,\n            billetes: origenNuevoBil,\n            monedas_fisicas: origenNuevoMon,\n            ...(typeof saldoOrigen?.bancos !== \"undefined\"\n              ? { bancos: origenNuevoBk }\n              : {}),\n          }\n        );\n\n        if (ingresoEf > 0) {\n          await logMovimientoSaldo(tx, {\n            punto_atencion_id,\n            moneda_id: moneda_origen_id,\n            tipo_movimiento: \"INGRESO\",\n            monto: ingresoEf,\n            saldo_anterior: origenAnteriorEf,\n            saldo_nuevo: origenNuevoEf,\n            usuario_id: userId,\n            referencia_id: cambio.id,\n            tipo_referencia: \"CAMBIO_DIVISA\",\n            descripcion: `Ingreso por cambio (efectivo, origen) ${numeroRecibo}`,\n          });\n        }\n        // BANCOS: Solo registro, NO afecta cuadre de caja\n        // Los bancos NO tienen l├¡mite ni control estricto, solo son para trazabilidad\n        if (ingresoBk > 0 && typeof saldoOrigen?.bancos !== \"undefined\") {\n          await logMovimientoSaldo(tx, {\n            punto_atencion_id,\n            moneda_id: moneda_origen_id,\n            tipo_movimiento: \"INGRESO\",\n            monto: ingresoBk,\n            saldo_anterior: origenAnteriorBk,\n            saldo_nuevo: origenNuevoBk,\n            usuario_id: userId,\n            referencia_id: cambio.id,\n            tipo_referencia: \"CAMBIO_DIVISA\",\n            descripcion: `Ingreso por cambio (bancos - transferencia bancaria - NO afecta cuadre f├¡sico)`,\n            saldo_bucket: \"BANCOS\",\n          });\n        }\n\n        // 3.2 Destino (EGRESO efectivo y/o bancos)\n        const saldoDestino = await getSaldo(\n          tx,\n          punto_atencion_id,\n          moneda_destino_id\n        );\n        const destinoAnteriorEf = num(saldoDestino?.cantidad);\n        let destinoAnteriorBil = num(saldoDestino?.billetes);\n        const destinoAnteriorMon = num(saldoDestino?.monedas_fisicas);\n        // Fallback: si ambos son 0 pero el total f├¡sico es positivo, asignar todo a billetes\n        if (destinoAnteriorBil === 0 && destinoAnteriorMon === 0 && destinoAnteriorEf > 0) {\n          destinoAnteriorBil = destinoAnteriorEf;\n        }\n        const destinoAnteriorBk =\n          typeof saldoDestino?.bancos !== \"undefined\"\n            ? num(saldoDestino?.bancos)\n            : 0;\n\n        const isDestinoUSD = isUSDByCode(cambio.monedaDestino?.codigo);\n        let egresoEf = 0;\n        let egresoBk = 0;\n\n        if (isDestinoUSD) {\n          egresoEf = num(usd_entregado_efectivo);\n          egresoBk = num(usd_entregado_transfer);\n          if (\n            round2(egresoEf + egresoBk) !==\n            round2(divisas_recibidas_total_final)\n          ) {\n            const tot = round2(divisas_recibidas_total_final);\n            if (metodo_entrega === \"efectivo\") {\n              egresoEf = tot;\n              egresoBk = 0;\n            } else if (metodo_entrega === \"transferencia\") {\n              egresoEf = 0;\n              egresoBk = tot;\n            } else {\n              egresoEf = round2(tot / 2);\n              egresoBk = round2(tot - egresoEf);\n            }\n          }\n        } else {\n          const tot = round2(divisas_recibidas_total_final);\n          if (metodo_entrega === \"efectivo\") {\n            egresoEf = tot;\n            egresoBk = 0;\n          } else if (metodo_entrega === \"transferencia\") {\n            egresoEf = 0;\n            egresoBk = tot;\n          } else {\n            egresoEf = num(usd_entregado_efectivo);\n            egresoBk = num(usd_entregado_transfer);\n            if (round2(egresoEf + egresoBk) !== tot) {\n              egresoEf = round2(tot / 2);\n              egresoBk = round2(tot - egresoEf);\n            }\n          }\n        }\n\n        // Ô£à APLICAR PORCENTAJE al egreso tambi├®n\n        egresoEf = round2(egresoEf * porcentajeActualizacion);\n        egresoBk = round2(egresoBk * porcentajeActualizacion);\n\n        // Validaciones de EFECTIVO (estrictas al centavo)\n        if (destinoAnteriorEf < egresoEf) {\n          throw new Error(\n            `Saldo efectivo insuficiente en moneda destino. Disponible: $${destinoAnteriorEf.toFixed(\n              2\n            )}, Requerido: $${egresoEf.toFixed(2)}. ` +\n              `Considera: 1) Hacer cambio PARCIAL (abono inicial), 2) Transferir desde otro punto, 3) Solicitar asignaci├│n de saldo.`\n          );\n        }\n\n        // BANCOS: NO validar l├¡mites (puede ser negativo, es solo registro)\n        // Los bancos NO tienen monto m├¡nimo/m├íximo, solo control para reportes\n        // Si hay egreso por banco, simplemente se registra sin validaci├│n de saldo\n\n        const destinoNuevoEf = round2(destinoAnteriorEf - egresoEf);\n        const destinoNuevoBk = round2(destinoAnteriorBk - egresoBk);\n\n        // ÔÜá´©Å Solo tocar billetes/monedas f├¡sicas si HAY egreso en efectivo\n        let billetesEgreso = 0;\n        let monedasEgreso = 0;\n\n        if (egresoEf > 0) {\n          // Ô£à NUEVA L├ôGICA: Distribuir dinero de forma flexible\n          // El cliente DESEA recibir X billetes y Y monedas\n          // Pero el punto TIENE A billetes y B monedas\n          // Intentamos satisfacer el deseo del cliente con lo que tenemos\n          \n          const billetesDeseados = num(divisas_recibidas_billetes);\n          const monedasDeseadas = num(divisas_recibidas_monedas);\n          const billetesDisponibles = destinoAnteriorBil;\n          const monedasDisponibles = destinoAnteriorMon;\n\n          // Estrategia: Intentar dar al cliente lo que quiere, pero con lo que tenemos\n          if (billetesDeseados > 0 || monedasDeseadas > 0) {\n            // Caso 1: Cliente especific├│ una mezcla de billetes y monedas\n            const totalDeseado = billetesDeseados + monedasDeseadas;\n            \n            if (totalDeseado > 0) {\n              // Intentar respetar la proporci├│n deseada\n              const proporcionBilletesDeseada = billetesDeseados / totalDeseado;\n              const proporcionMonedasDeseada = monedasDeseadas / totalDeseado;\n\n              billetesEgreso = round2(egresoEf * proporcionBilletesDeseada);\n              monedasEgreso = round2(egresoEf * proporcionMonedasDeseada);\n\n              // Si no tenemos suficientes billetes, usar monedas\n              if (billetesEgreso > billetesDisponibles) {\n                const excesoBilletes = billetesEgreso - billetesDisponibles;\n                billetesEgreso = billetesDisponibles;\n                monedasEgreso = round2(monedasEgreso + excesoBilletes);\n              }\n\n              // Si no tenemos suficientes monedas, usar billetes\n              if (monedasEgreso > monedasDisponibles) {\n                const excesoMonedas = monedasEgreso - monedasDisponibles;\n                monedasEgreso = monedasDisponibles;\n                billetesEgreso = round2(billetesEgreso + excesoMonedas);\n              }\n\n              // Ajustar redondeo para que suma = total\n              const diferencia = egresoEf - (billetesEgreso + monedasEgreso);\n              if (Math.abs(diferencia) > 0.01) {\n                if (billetesEgreso <= billetesDisponibles) {\n                  billetesEgreso = round2(billetesEgreso + diferencia);\n                } else if (monedasEgreso <= monedasDisponibles) {\n                  monedasEgreso = round2(monedasEgreso + diferencia);\n                }\n              }\n            } else {\n              // No se especific├│ proporci├│n, usar lo disponible\n              billetesEgreso = Math.min(egresoEf, billetesDisponibles);\n              monedasEgreso = egresoEf - billetesEgreso;\n            }\n          } else {\n            // Cliente no especific├│, usar lo disponible (preferir billetes)\n            billetesEgreso = Math.min(egresoEf, billetesDisponibles);\n            monedasEgreso = Math.min(egresoEf - billetesEgreso, monedasDisponibles);\n          }\n\n          // Validaci├│n final: ┬┐tenemos suficiente dinero en total?\n          const totalFisicoDisponible = billetesDisponibles + monedasDisponibles;\n          const totalFisicoRequerido = billetesEgreso + monedasEgreso;\n          \n          if (totalFisicoDisponible < egresoEf - 0.01) {\n            throw new Error(\n              `Saldo de efectivo insuficiente en moneda destino. Disponible: ${totalFisicoDisponible.toFixed(2)} (${billetesDisponibles.toFixed(2)} billetes + ${monedasDisponibles.toFixed(2)} monedas), Requerido: ${egresoEf.toFixed(2)}`\n            );\n          }\n        }\n\n        const destinoNuevoBil = Math.max(\n          0,\n          round2(destinoAnteriorBil - billetesEgreso)\n        );\n        const destinoNuevoMon = Math.max(\n          0,\n          round2(destinoAnteriorMon - monedasEgreso)\n        );\n\n        await upsertSaldoEfectivoYBancos(\n          tx,\n          punto_atencion_id,\n          moneda_destino_id,\n          {\n            cantidad: destinoNuevoEf,\n            billetes: destinoNuevoBil,\n            monedas_fisicas: destinoNuevoMon,\n            ...(typeof saldoDestino?.bancos !== \"undefined\"\n              ? { bancos: destinoNuevoBk }\n              : {}),\n          }\n        );\n\n        // Movimiento: EFECTIVO (cuadre de caja)\n        if (egresoEf > 0) {\n          await logMovimientoSaldo(tx, {\n            punto_atencion_id,\n            moneda_id: moneda_destino_id,\n            tipo_movimiento: \"EGRESO\",\n            monto: egresoEf, // Ô£à Positivo - el servicio aplica el signo\n            saldo_anterior: destinoAnteriorEf,\n            saldo_nuevo: destinoNuevoEf,\n            usuario_id: userId,\n            referencia_id: cambio.id,\n            tipo_referencia: \"CAMBIO_DIVISA\",\n            descripcion: `Egreso por cambio (efectivo, destino) ${numeroRecibo}`,\n          });\n        }\n        // Movimiento: BANCOS (control, NO entra al cuadre de efectivo)\n        if (egresoBk > 0 && typeof saldoDestino?.bancos !== \"undefined\") {\n          await logMovimientoSaldo(tx, {\n            punto_atencion_id,\n            moneda_id: moneda_destino_id,\n            tipo_movimiento: \"EGRESO\",\n            monto: egresoBk, // Ô£à Positivo - el servicio aplica el signo\n            saldo_anterior: destinoAnteriorBk,\n            saldo_nuevo: destinoNuevoBk,\n            usuario_id: userId,\n            referencia_id: cambio.id,\n            tipo_referencia: \"CAMBIO_DIVISA\",\n            descripcion: `Egreso por cambio (bancos, destino) ${\n              transferencia_banco || \"\"\n            } ${transferencia_numero || \"\"}`.trim(),\n            saldo_bucket: \"BANCOS\",\n          });\n        }\n\n        // Ô£à VALIDACI├ôN CR├ìTICA: Asegurar que SIEMPRE se registren movimientos\n        // Un cambio de divisa DEBE tener exactamente 2 movimientos: 1 ingreso (origen) + 1 egreso (destino)\n        const movimientosCreados = await tx.movimientoSaldo.count({\n          where: {\n            tipo_referencia: 'EXCHANGE',\n            referencia_id: cambio.id\n          }\n        });\n\n        if (movimientosCreados < 2) {\n          console.error(`[CRITICAL] Cambio ${cambio.id} (${numeroRecibo}) solo tiene ${movimientosCreados} movimientos. Se esperaban 2.`);\n          \n          // Crear movimientos faltantes como contingencia\n          const movimientosExistentes = await tx.movimientoSaldo.findMany({\n            where: {\n              tipo_referencia: 'EXCHANGE',\n              referencia_id: cambio.id\n            },\n            select: { moneda_id: true, tipo_movimiento: true }\n          });\n\n          const tieneMovimientoOrigen = movimientosExistentes.some(\n            m => m.moneda_id === moneda_origen_id && m.tipo_movimiento === 'INGRESO'\n          );\n          const tieneMovimientoDestino = movimientosExistentes.some(\n            m => m.moneda_id === moneda_destino_id && m.tipo_movimiento === 'EGRESO'\n          );\n\n          if (!tieneMovimientoOrigen) {\n            console.warn(`[AUTO-FIX] Creando movimiento de ingreso faltante para origen ${cambio.monedaOrigen?.codigo}`);\n            await logMovimientoSaldo(tx, {\n              punto_atencion_id,\n              moneda_id: moneda_origen_id,\n              tipo_movimiento: \"INGRESO\",\n              monto: monto_origen_final,\n              saldo_anterior: origenAnteriorEf,\n              saldo_nuevo: origenNuevoEf,\n              usuario_id: userId,\n              referencia_id: cambio.id,\n              tipo_referencia: \"CAMBIO_DIVISA\",\n              descripcion: `Ingreso por cambio ${numeroRecibo} (auto-creado)`,\n            });\n          }\n\n          if (!tieneMovimientoDestino) {\n            console.warn(`[AUTO-FIX] Creando movimiento de egreso faltante para destino ${cambio.monedaDestino?.codigo}`);\n            await logMovimientoSaldo(tx, {\n              punto_atencion_id,\n              moneda_id: moneda_destino_id,\n              tipo_movimiento: \"EGRESO\",\n              monto: monto_destino_final,\n              saldo_anterior: destinoAnteriorEf,\n              saldo_nuevo: destinoNuevoEf,\n              usuario_id: userId,\n              referencia_id: cambio.id,\n              tipo_referencia: \"CAMBIO_DIVISA\",\n              descripcion: `Egreso por cambio ${numeroRecibo} (auto-creado)`,\n            });\n          }\n        }\n\n        return cambio;\n      });\n\n      logger.info(\"Cambio de divisa creado y contabilizado\", {\n        id: exchange.id,\n        numero_recibo: exchange.numero_recibo,\n      });\n\n      // Incluir datos del cliente en la respuesta (no se persiste en CambioDivisa)\n      const exchangeResponse = {\n        ...exchange,\n        datos_cliente: datos_cliente_sanitized,\n      };\n\n      res.status(201).json({\n        exchange: exchangeResponse,\n        success: true,\n        timestamp: new Date().toISOString(),\n      });\n    } catch (error) {\n      logger.error(\"Error al crear cambio de divisa\", {\n        error: error instanceof Error ? error.message : \"Unknown error\",\n        stack: error instanceof Error ? error.stack : undefined,\n        usuario_id: req.user?.id,\n      });\n      res.status(500).json({\n        error: error instanceof Error ? error.message : String(error),\n        success: false,\n        timestamp: new Date().toISOString(),\n      });\n    }\n  }\n);\n\n/* ========================= Listar (con fecha GYE) ========================= */\n\nrouter.get(\n  \"/\",\n  authenticateToken,\n  async (req: AuthenticatedRequest, res: express.Response): Promise<void> => {\n    try {\n      if (!req.user?.id) {\n        res\n          .status(401)\n          .json({ error: \"Usuario no autenticado\", success: false });\n        return;\n      }\n\n      const whereClause: ExchangeWhereClause = {};\n      if (req.query.point_id)\n        whereClause.punto_atencion_id = String(req.query.point_id);\n\n      const estadoParam = req.query.estado as EstadoTransaccion | undefined;\n      if (\n        estadoParam === EstadoTransaccion.PENDIENTE ||\n        estadoParam === EstadoTransaccion.COMPLETADO\n      ) {\n        whereClause.estado = estadoParam;\n      }\n\n      if (req.user.rol === \"OPERADOR\") whereClause.usuario_id = req.user.id;\n\n      const { date, from, to } = req.query as {\n        date?: string;\n        from?: string;\n        to?: string;\n      };\n      let gte: Date, lt: Date;\n      if (from || to) {\n        const fromStr = (from || (to as string)) as string;\n        const toStr = (to || (from as string)) as string;\n        gte = gyeDayRangeUtcFromDateOnly(fromStr).gte;\n        lt = gyeDayRangeUtcFromDateOnly(toStr).lt;\n      } else if (date) {\n        const dateStr = String(date);\n        const r = gyeDayRangeUtcFromDateOnly(dateStr);\n        gte = r.gte;\n        lt = r.lt;\n      } else {\n        // Sin filtro de fecha para ADMIN/SUPER_USUARIO: ├║ltimos 30 d├¡as\n        // Para OPERADOR: d├¡a actual\n        if (req.user.rol === \"ADMIN\" || req.user.rol === \"SUPER_USUARIO\") {\n          const now = new Date();\n          gte = new Date(now.getTime() - 30 * 24 * 60 * 60 * 1000); // 30 d├¡as atr├ís\n          lt = new Date(now.getTime() + 24 * 60 * 60 * 1000); // Ma├▒ana\n        } else {\n          const dateStr = todayGyeDateOnly();\n          const r = gyeDayRangeUtcFromDateOnly(dateStr);\n          gte = r.gte;\n          lt = r.lt;\n        }\n      }\n\n      // Primero intentamos una consulta simple para diagnosticar el problema\n      let exchanges;\n      try {\n        exchanges = await prisma.cambioDivisa.findMany({\n          where: { ...whereClause, fecha: { gte, lt } },\n          select: {\n            id: true,\n            fecha: true,\n            tipo_operacion: true,\n            estado: true,\n            monto_origen: true,\n            monto_destino: true,\n            tasa_cambio_billetes: true,\n            tasa_cambio_monedas: true,\n            observacion: true,\n            numero_recibo: true,\n            numero_recibo_abono: true,\n            numero_recibo_completar: true,\n            cliente: true,\n            divisas_entregadas_total: true,\n            divisas_entregadas_billetes: true,\n            divisas_entregadas_monedas: true,\n            divisas_recibidas_total: true,\n            divisas_recibidas_billetes: true,\n            divisas_recibidas_monedas: true,\n            saldo_pendiente: true,\n            abono_inicial_monto: true,\n            abono_inicial_fecha: true,\n            fecha_completado: true,\n            metodo_entrega: true,\n            transferencia_banco: true,\n            transferencia_numero: true,\n            transferencia_imagen_url: true,\n            usd_entregado_efectivo: true,\n            usd_entregado_transfer: true,\n            // usd_recibido_efectivo: true,\n            // usd_recibido_transfer: true,\n            // metodo_pago_origen: true,\n            moneda_origen_id: true,\n            moneda_destino_id: true,\n            usuario_id: true,\n            punto_atencion_id: true,\n          },\n          orderBy: { fecha: \"desc\" },\n          take: req.user.rol === \"ADMIN\" || req.user.rol === \"SUPER_USUARIO\" ? 500 : 50,\n        });\n\n        // Si la consulta b├ísica funciona, intentamos agregar las relaciones\n        if (exchanges && exchanges.length >= 0) {\n          exchanges = await prisma.cambioDivisa.findMany({\n            where: { ...whereClause, fecha: { gte, lt } },\n            select: {\n              id: true,\n              fecha: true,\n              tipo_operacion: true,\n              estado: true,\n              monto_origen: true,\n              monto_destino: true,\n              tasa_cambio_billetes: true,\n              tasa_cambio_monedas: true,\n              observacion: true,\n              numero_recibo: true,\n              numero_recibo_abono: true,\n              numero_recibo_completar: true,\n              cliente: true,\n              divisas_entregadas_total: true,\n              divisas_entregadas_billetes: true,\n              divisas_entregadas_monedas: true,\n              divisas_recibidas_total: true,\n              divisas_recibidas_billetes: true,\n              divisas_recibidas_monedas: true,\n              saldo_pendiente: true,\n              abono_inicial_monto: true,\n              abono_inicial_fecha: true,\n              fecha_completado: true,\n              metodo_entrega: true,\n              transferencia_banco: true,\n              transferencia_numero: true,\n              transferencia_imagen_url: true,\n              usd_entregado_efectivo: true,\n              usd_entregado_transfer: true,\n              // usd_recibido_efectivo: true,\n              // usd_recibido_transfer: true,\n              // metodo_pago_origen: true,\n              monedaOrigen: {\n                select: { id: true, nombre: true, codigo: true, simbolo: true },\n              },\n              monedaDestino: {\n                select: { id: true, nombre: true, codigo: true, simbolo: true },\n              },\n              usuario: { select: { id: true, nombre: true, username: true } },\n              puntoAtencion: { select: { id: true, nombre: true } },\n            },\n            orderBy: { fecha: \"desc\" },\n            take: req.user.rol === \"ADMIN\" || req.user.rol === \"SUPER_USUARIO\" ? 500 : 50,\n          });\n        }\n      } catch (relationError) {\n        logger.warn(\"Error con relaciones, usando consulta b├ísica\", {\n          error:\n            relationError instanceof Error ? relationError.message : \"Unknown\",\n        });\n\n        // Fallback a consulta sin relaciones\n        exchanges = await prisma.cambioDivisa.findMany({\n          where: { ...whereClause, fecha: { gte, lt } },\n          select: {\n            id: true,\n            fecha: true,\n            tipo_operacion: true,\n            estado: true,\n            monto_origen: true,\n            monto_destino: true,\n            tasa_cambio_billetes: true,\n            tasa_cambio_monedas: true,\n            observacion: true,\n            numero_recibo: true,\n            cliente: true,\n            divisas_entregadas_total: true,\n            divisas_recibidas_total: true,\n            metodo_entrega: true,\n            moneda_origen_id: true,\n            moneda_destino_id: true,\n            usuario_id: true,\n            punto_atencion_id: true,\n          },\n          orderBy: { fecha: \"desc\" },\n          take: req.user.rol === \"ADMIN\" || req.user.rol === \"SUPER_USUARIO\" ? 500 : 50,\n        });\n      }\n\n      // Enriquecer con datos_cliente desde Recibo.datos_operacion (para hist├│ricos)\n      let exchangesWithDatosCliente = exchanges;\n      try {\n        const exchangesArr = Array.isArray(exchanges) ? exchanges : [];\n        const refIds = exchangesArr\n          .map(getIdFromUnknown)\n          .filter((id): id is string => typeof id === \"string\");\n        if (refIds.length > 0) {\n          const recibos = await prisma.recibo.findMany({\n            where: { referencia_id: { in: Array.from(new Set(refIds)) } },\n            select: { referencia_id: true, datos_operacion: true },\n          });\n          const datosClienteMap = new Map<string, JsonRecord>();\n          for (const r of recibos) {\n            const datos = extractDatosClienteFromDatosOperacion(r.datos_operacion);\n            if (r.referencia_id && datos) {\n              datosClienteMap.set(r.referencia_id, datos);\n            }\n          }\n          exchangesWithDatosCliente = exchangesArr.map((e) => {\n            const id = getIdFromUnknown(e);\n            if (!id || !isRecord(e)) return e;\n            return {\n              ...e,\n              datos_cliente: datosClienteMap.get(id) ?? undefined,\n            };\n          });\n        }\n      } catch (e) {\n        logger.warn(\"No se pudo enriquecer exchanges con datos_cliente de recibos\", {\n          error: e instanceof Error ? e.message : String(e),\n        });\n      }\n\n      res.status(200).json({\n        exchanges: exchangesWithDatosCliente,\n        success: true,\n        timestamp: new Date().toISOString(),\n      });\n    } catch (error) {\n      logger.error(\"Error al obtener cambios de divisa\", {\n        error: error instanceof Error ? error.message : \"Unknown\",\n      });\n      res\n        .status(500)\n        .json({ error: \"Error al obtener cambios de divisa\", success: false });\n    }\n  }\n);\n\n/* ========================= Cerrar cambio pendiente (COMPLETADO) ========================= */\n\nrouter.patch(\n  \"/:id/cerrar\",\n  authenticateToken,\n  async (req: AuthenticatedRequest, res: express.Response): Promise<void> => {\n    const { id } = req.params;\n    try {\n      const userId = req.user?.id;\n      if (!userId) {\n        res\n          .status(401)\n          .json({ error: \"Usuario no autenticado\", success: false });\n        return;\n      }\n      const cambio = await prisma.cambioDivisa.findUnique({ where: { id } });\n      if (!cambio) {\n        res.status(404).json({ error: \"Cambio no encontrado\", success: false });\n        return;\n      }\n      if (cambio.estado === EstadoTransaccion.COMPLETADO) {\n        res\n          .status(400)\n          .json({ error: \"El cambio ya est├í completado\", success: false });\n        return;\n      }\n\n      // Ô£à CR├ìTICO: Si hubo abono inicial, actualizar el balance restante\n      const huboAbonoInicial = num(cambio.abono_inicial_monto) > 0;\n\n      if (huboAbonoInicial) {\n        // Calcular el porcentaje restante que falta actualizar\n        const montoTotal = num(cambio.monto_destino);\n        const montoAbonado = num(cambio.abono_inicial_monto);\n        const montoRestante = montoTotal - montoAbonado;\n        const porcentajeRestante = montoRestante / montoTotal;\n\n        // Obtener saldos actuales\n        const saldoOrigen = await prisma.saldo.findUnique({\n          where: {\n            punto_atencion_id_moneda_id: {\n              punto_atencion_id: cambio.punto_atencion_id,\n              moneda_id: cambio.moneda_origen_id,\n            },\n          },\n        });\n\n        const saldoDestino = await prisma.saldo.findUnique({\n          where: {\n            punto_atencion_id_moneda_id: {\n              punto_atencion_id: cambio.punto_atencion_id,\n              moneda_id: cambio.moneda_destino_id,\n            },\n          },\n        });\n\n        if (!saldoOrigen || !saldoDestino) {\n          res.status(400).json({\n            error: \"No se encontraron saldos para las monedas involucradas\",\n            success: false,\n          });\n          return;\n        }\n\n        // Calcular incrementos/decrementos restantes seg├║n m├®todo de pago\n        const usdRecibidoEfectivo =\n          cambio.metodo_pago_origen === TipoViaTransferencia.EFECTIVO\n            ? num(cambio.divisas_entregadas_total)\n            : 0;\n        const usdRecibidoTransfer =\n          cambio.metodo_pago_origen === TipoViaTransferencia.BANCO\n            ? num(cambio.divisas_entregadas_total)\n            : 0;\n\n        const ingresoEfRestante = round2(\n          usdRecibidoEfectivo * porcentajeRestante\n        );\n        const ingresoBkRestante = round2(\n          usdRecibidoTransfer * porcentajeRestante\n        );\n\n        // Calcular billetes y monedas de ingreso manteniendo proporci├│n\n        let ingresoBilRestante = 0;\n        let ingresoMonRestante = 0;\n\n        if (ingresoEfRestante > 0) {\n          const totalEntregado =\n            num(cambio.divisas_entregadas_billetes) +\n            num(cambio.divisas_entregadas_monedas);\n\n          if (totalEntregado > 0) {\n            const proporcionBilletes =\n              num(cambio.divisas_entregadas_billetes) / totalEntregado;\n            const proporcionMonedas =\n              num(cambio.divisas_entregadas_monedas) / totalEntregado;\n\n            ingresoBilRestante = round2(ingresoEfRestante * proporcionBilletes);\n            ingresoMonRestante = round2(ingresoEfRestante * proporcionMonedas);\n\n            // Ajustar por diferencias de redondeo\n            const diferencia =\n              ingresoEfRestante - (ingresoBilRestante + ingresoMonRestante);\n            if (Math.abs(diferencia) > 0.01) {\n              if (ingresoBilRestante >= ingresoMonRestante) {\n                ingresoBilRestante = round2(ingresoBilRestante + diferencia);\n              } else {\n                ingresoMonRestante = round2(ingresoMonRestante + diferencia);\n              }\n            }\n          } else {\n            ingresoBilRestante = ingresoEfRestante;\n            ingresoMonRestante = 0;\n          }\n        }\n\n        // Egreso en moneda destino\n        const egresoEfRestante =\n          cambio.metodo_entrega === \"efectivo\"\n            ? round2(num(cambio.divisas_recibidas_total) * porcentajeRestante)\n            : 0;\n        const egresoBkRestante =\n          cambio.metodo_entrega === \"transferencia\"\n            ? round2(num(cambio.divisas_recibidas_total) * porcentajeRestante)\n            : 0;\n\n        // Calcular billetes y monedas de egreso manteniendo proporci├│n\n        let billetesEgresoRestante = 0;\n        let monedasEgresoRestante = 0;\n\n        if (egresoEfRestante > 0) {\n          const totalRecibido =\n            num(cambio.divisas_recibidas_billetes) +\n            num(cambio.divisas_recibidas_monedas);\n\n          if (totalRecibido > 0) {\n            const proporcionBilletes =\n              num(cambio.divisas_recibidas_billetes) / totalRecibido;\n            const proporcionMonedas =\n              num(cambio.divisas_recibidas_monedas) / totalRecibido;\n\n            billetesEgresoRestante = round2(\n              egresoEfRestante * proporcionBilletes\n            );\n            monedasEgresoRestante = round2(\n              egresoEfRestante * proporcionMonedas\n            );\n\n            // Ajustar por diferencias de redondeo\n            const diferencia =\n              egresoEfRestante -\n              (billetesEgresoRestante + monedasEgresoRestante);\n            if (Math.abs(diferencia) > 0.01) {\n              if (billetesEgresoRestante >= monedasEgresoRestante) {\n                billetesEgresoRestante = round2(\n                  billetesEgresoRestante + diferencia\n                );\n              } else {\n                monedasEgresoRestante = round2(\n                  monedasEgresoRestante + diferencia\n                );\n              }\n            }\n          } else {\n            billetesEgresoRestante = egresoEfRestante;\n            monedasEgresoRestante = 0;\n          }\n        }\n\n        // Actualizar saldos en transacci├│n\n        await prisma.$transaction(async (tx) => {\n          // Actualizar saldo origen (ingreso)\n          await tx.saldo.update({\n            where: {\n              punto_atencion_id_moneda_id: {\n                punto_atencion_id: cambio.punto_atencion_id,\n                moneda_id: cambio.moneda_origen_id,\n              },\n            },\n            data: {\n              cantidad: { increment: ingresoEfRestante },\n              bancos: { increment: ingresoBkRestante },\n              billetes: { increment: ingresoBilRestante },\n              monedas_fisicas: { increment: ingresoMonRestante },\n            },\n          });\n\n          // Actualizar saldo destino (egreso)\n          await tx.saldo.update({\n            where: {\n              punto_atencion_id_moneda_id: {\n                punto_atencion_id: cambio.punto_atencion_id,\n                moneda_id: cambio.moneda_destino_id,\n              },\n            },\n            data: {\n              cantidad: { decrement: egresoEfRestante },\n              bancos: { decrement: egresoBkRestante },\n              billetes: { decrement: billetesEgresoRestante },\n              monedas_fisicas: { decrement: monedasEgresoRestante },\n            },\n          });\n\n          // Registrar movimientos de saldo (separando CAJA vs BANCOS)\n          const origenAnteriorEf = num(saldoOrigen.cantidad);\n          const origenAnteriorBk = num(saldoOrigen.bancos);\n          const destinoAnteriorEf = num(saldoDestino.cantidad);\n          const destinoAnteriorBk = num(saldoDestino.bancos);\n\n          if (ingresoEfRestante > 0) {\n            await registrarMovimientoSaldo(\n              {\n                puntoAtencionId: cambio.punto_atencion_id,\n                monedaId: cambio.moneda_origen_id,\n                tipoMovimiento: TipoMovimiento.INGRESO,\n                monto: round2(ingresoEfRestante),\n                saldoAnterior: round2(origenAnteriorEf),\n                saldoNuevo: round2(origenAnteriorEf + ingresoEfRestante),\n                tipoReferencia: TipoReferencia.EXCHANGE,\n                referenciaId: cambio.id,\n                descripcion: `Cierre de cambio pendiente (ingreso restante caja) - Recibo: ${cambio.numero_recibo}`,\n                saldoBucket: \"CAJA\",\n                usuarioId: userId,\n              },\n              tx\n            );\n          }\n\n          if (ingresoBkRestante > 0) {\n            await registrarMovimientoSaldo(\n              {\n                puntoAtencionId: cambio.punto_atencion_id,\n                monedaId: cambio.moneda_origen_id,\n                tipoMovimiento: TipoMovimiento.INGRESO,\n                monto: round2(ingresoBkRestante),\n                saldoAnterior: round2(origenAnteriorBk),\n                saldoNuevo: round2(origenAnteriorBk + ingresoBkRestante),\n                tipoReferencia: TipoReferencia.EXCHANGE,\n                referenciaId: cambio.id,\n                descripcion: `Cierre de cambio pendiente (ingreso restante bancos) - Recibo: ${cambio.numero_recibo}`,\n                saldoBucket: \"BANCOS\",\n                usuarioId: userId,\n              },\n              tx\n            );\n          }\n\n          if (egresoEfRestante > 0) {\n            await registrarMovimientoSaldo(\n              {\n                puntoAtencionId: cambio.punto_atencion_id,\n                monedaId: cambio.moneda_destino_id,\n                tipoMovimiento: TipoMovimiento.EGRESO,\n                monto: round2(egresoEfRestante),\n                saldoAnterior: round2(destinoAnteriorEf),\n                saldoNuevo: round2(destinoAnteriorEf - egresoEfRestante),\n                tipoReferencia: TipoReferencia.EXCHANGE,\n                referenciaId: cambio.id,\n                descripcion: `Cierre de cambio pendiente (egreso restante caja) - Recibo: ${cambio.numero_recibo}`,\n                saldoBucket: \"CAJA\",\n                usuarioId: userId,\n              },\n              tx\n            );\n          }\n\n          if (egresoBkRestante > 0) {\n            await registrarMovimientoSaldo(\n              {\n                puntoAtencionId: cambio.punto_atencion_id,\n                monedaId: cambio.moneda_destino_id,\n                tipoMovimiento: TipoMovimiento.EGRESO,\n                monto: round2(egresoBkRestante),\n                saldoAnterior: round2(destinoAnteriorBk),\n                saldoNuevo: round2(destinoAnteriorBk - egresoBkRestante),\n                tipoReferencia: TipoReferencia.EXCHANGE,\n                referenciaId: cambio.id,\n                descripcion: `Cierre de cambio pendiente (egreso restante bancos) - Recibo: ${cambio.numero_recibo}`,\n                saldoBucket: \"BANCOS\",\n                usuarioId: userId,\n              },\n              tx\n            );\n          }\n        });\n      }\n\n      const numeroReciboCierre = `CIERRE-${Date.now()}-${Math.random()\n        .toString(36)\n        .slice(2, 6)}`;\n      const updated = await prisma.cambioDivisa.update({\n        where: { id },\n        data: {\n          estado: EstadoTransaccion.COMPLETADO,\n          numero_recibo_completar: numeroReciboCierre,\n          fecha_completado: new Date(),\n          saldo_pendiente: 0,\n        },\n        select: {\n          id: true,\n          fecha: true,\n          tipo_operacion: true,\n          estado: true,\n          monto_origen: true,\n          monto_destino: true,\n          tasa_cambio_billetes: true,\n          tasa_cambio_monedas: true,\n          observacion: true,\n          numero_recibo: true,\n          numero_recibo_abono: true,\n          numero_recibo_completar: true,\n          cliente: true,\n          divisas_entregadas_total: true,\n          divisas_recibidas_total: true,\n          saldo_pendiente: true,\n          abono_inicial_monto: true,\n          abono_inicial_fecha: true,\n          fecha_completado: true,\n          monedaOrigen: {\n            select: { id: true, nombre: true, codigo: true, simbolo: true },\n          },\n          monedaDestino: {\n            select: { id: true, nombre: true, codigo: true, simbolo: true },\n          },\n          usuario: { select: { id: true, nombre: true, username: true } },\n          puntoAtencion: { select: { id: true, nombre: true } },\n        },\n      });\n\n      await prisma.recibo.create({\n        data: {\n          numero_recibo: numeroReciboCierre,\n          tipo_operacion: \"CAMBIO_DIVISA\",\n          referencia_id: updated.id,\n          usuario_id: req.user.id,\n          punto_atencion_id: cambio.punto_atencion_id,\n          datos_operacion: updated,\n        },\n      });\n\n      res.status(200).json({\n        exchange: updated,\n        success: true,\n        timestamp: new Date().toISOString(),\n      });\n    } catch (error) {\n      logger.error(\"Error al cerrar cambio de divisa\", {\n        error: error instanceof Error ? error.message : \"Unknown\",\n      });\n      res\n        .status(500)\n        .json({ error: \"Error interno al cerrar cambio\", success: false });\n    }\n  }\n);\n\n/* ========================= Completar: setear entrega + COMPLETADO ========================= */\n\nrouter.patch(\n  \"/:id/completar\",\n  authenticateToken,\n  async (req: AuthenticatedRequest, res: express.Response): Promise<void> => {\n    const { id } = req.params;\n    const {\n      metodo_entrega,\n      transferencia_numero,\n      transferencia_banco,\n      transferencia_imagen_url,\n      divisas_recibidas_billetes,\n      divisas_recibidas_monedas,\n      divisas_recibidas_total,\n    } = req.body || {};\n    try {\n      const userId = req.user?.id;\n      if (!userId) {\n        res\n          .status(401)\n          .json({ error: \"Usuario no autenticado\", success: false });\n        return;\n      }\n\n      const cambio = await prisma.cambioDivisa.findUnique({ where: { id } });\n      if (!cambio) {\n        res.status(404).json({ error: \"Cambio no encontrado\", success: false });\n        return;\n      }\n      if (cambio.estado === EstadoTransaccion.COMPLETADO) {\n        res\n          .status(400)\n          .json({ error: \"El cambio ya est├í completado\", success: false });\n        return;\n      }\n\n      if (metodo_entrega === \"transferencia\") {\n        if (!transferencia_banco || !String(transferencia_banco).trim()) {\n          res.status(400).json({\n            success: false,\n            error: \"Banco requerido para transferencia\",\n          });\n          return;\n        }\n        if (!transferencia_numero || !String(transferencia_numero).trim()) {\n          res.status(400).json({\n            success: false,\n            error: \"N├║mero de referencia requerido para transferencia\",\n          });\n          return;\n        }\n      }\n\n      // Ô£à CR├ìTICO: Si hubo abono inicial, actualizar el balance restante\n      const huboAbonoInicial = num(cambio.abono_inicial_monto) > 0;\n\n      if (huboAbonoInicial) {\n        // Calcular el porcentaje restante que falta actualizar\n        const montoTotal = num(cambio.monto_destino);\n        const montoAbonado = num(cambio.abono_inicial_monto);\n        const montoRestante = montoTotal - montoAbonado;\n        const porcentajeRestante = montoRestante / montoTotal;\n\n        // Obtener saldos actuales\n        const saldoOrigen = await prisma.saldo.findUnique({\n          where: {\n            punto_atencion_id_moneda_id: {\n              punto_atencion_id: cambio.punto_atencion_id,\n              moneda_id: cambio.moneda_origen_id,\n            },\n          },\n        });\n\n        const saldoDestino = await prisma.saldo.findUnique({\n          where: {\n            punto_atencion_id_moneda_id: {\n              punto_atencion_id: cambio.punto_atencion_id,\n              moneda_id: cambio.moneda_destino_id,\n            },\n          },\n        });\n\n        if (!saldoOrigen || !saldoDestino) {\n          res.status(400).json({\n            error: \"No se encontraron saldos para las monedas involucradas\",\n            success: false,\n          });\n          return;\n        }\n\n        // Calcular incrementos/decrementos restantes seg├║n m├®todo de pago\n        const usdRecibidoEfectivo =\n          cambio.metodo_pago_origen === TipoViaTransferencia.EFECTIVO\n            ? num(cambio.divisas_entregadas_total)\n            : 0;\n        const usdRecibidoTransfer =\n          cambio.metodo_pago_origen === TipoViaTransferencia.BANCO\n            ? num(cambio.divisas_entregadas_total)\n            : 0;\n\n        const ingresoEfRestante = round2(\n          usdRecibidoEfectivo * porcentajeRestante\n        );\n        const ingresoBkRestante = round2(\n          usdRecibidoTransfer * porcentajeRestante\n        );\n\n        // Calcular billetes y monedas de ingreso manteniendo proporci├│n\n        let ingresoBilRestante = 0;\n        let ingresoMonRestante = 0;\n\n        if (ingresoEfRestante > 0) {\n          const totalEntregado =\n            num(cambio.divisas_entregadas_billetes) +\n            num(cambio.divisas_entregadas_monedas);\n\n          if (totalEntregado > 0) {\n            const proporcionBilletes =\n              num(cambio.divisas_entregadas_billetes) / totalEntregado;\n            const proporcionMonedas =\n              num(cambio.divisas_entregadas_monedas) / totalEntregado;\n\n            ingresoBilRestante = round2(ingresoEfRestante * proporcionBilletes);\n            ingresoMonRestante = round2(ingresoEfRestante * proporcionMonedas);\n\n            // Ajustar por diferencias de redondeo\n            const diferencia =\n              ingresoEfRestante - (ingresoBilRestante + ingresoMonRestante);\n            if (Math.abs(diferencia) > 0.01) {\n              if (ingresoBilRestante >= ingresoMonRestante) {\n                ingresoBilRestante = round2(ingresoBilRestante + diferencia);\n              } else {\n                ingresoMonRestante = round2(ingresoMonRestante + diferencia);\n              }\n            }\n          } else {\n            ingresoBilRestante = ingresoEfRestante;\n            ingresoMonRestante = 0;\n          }\n        }\n\n        // Egreso en moneda destino\n        const egresoEfRestante =\n          cambio.metodo_entrega === \"efectivo\"\n            ? round2(num(cambio.divisas_recibidas_total) * porcentajeRestante)\n            : 0;\n        const egresoBkRestante =\n          cambio.metodo_entrega === \"transferencia\"\n            ? round2(num(cambio.divisas_recibidas_total) * porcentajeRestante)\n            : 0;\n\n        // Calcular billetes y monedas de egreso manteniendo proporci├│n\n        let billetesEgresoRestante = 0;\n        let monedasEgresoRestante = 0;\n\n        if (egresoEfRestante > 0) {\n          const totalRecibido =\n            num(cambio.divisas_recibidas_billetes) +\n            num(cambio.divisas_recibidas_monedas);\n\n          if (totalRecibido > 0) {\n            const proporcionBilletes =\n              num(cambio.divisas_recibidas_billetes) / totalRecibido;\n            const proporcionMonedas =\n              num(cambio.divisas_recibidas_monedas) / totalRecibido;\n\n            billetesEgresoRestante = round2(\n              egresoEfRestante * proporcionBilletes\n            );\n            monedasEgresoRestante = round2(\n              egresoEfRestante * proporcionMonedas\n            );\n\n            // Ajustar por diferencias de redondeo\n            const diferencia =\n              egresoEfRestante -\n              (billetesEgresoRestante + monedasEgresoRestante);\n            if (Math.abs(diferencia) > 0.01) {\n              if (billetesEgresoRestante >= monedasEgresoRestante) {\n                billetesEgresoRestante = round2(\n                  billetesEgresoRestante + diferencia\n                );\n              } else {\n                monedasEgresoRestante = round2(\n                  monedasEgresoRestante + diferencia\n                );\n              }\n            }\n          } else {\n            billetesEgresoRestante = egresoEfRestante;\n            monedasEgresoRestante = 0;\n          }\n        }\n\n        // Actualizar saldos en transacci├│n\n        await prisma.$transaction(async (tx) => {\n          // 1) Actualizar saldo origen (ingreso del monto restante)\n          const existingSaldoOrigen = await tx.saldo.findUnique({\n            where: {\n              punto_atencion_id_moneda_id: {\n                punto_atencion_id: cambio.punto_atencion_id,\n                moneda_id: cambio.moneda_origen_id,\n              },\n            },\n          });\n\n          const origenAnteriorEf = num(existingSaldoOrigen?.cantidad);\n          const origenAnteriorBk = num(existingSaldoOrigen?.bancos);\n          const origenNuevoEf = round2(origenAnteriorEf + ingresoEfRestante);\n          const origenNuevoBk = round2(origenAnteriorBk + ingresoBkRestante);\n          const origenNuevoBil = round2(num(existingSaldoOrigen?.billetes) + ingresoBilRestante);\n          const origenNuevoMon = round2(num(existingSaldoOrigen?.monedas_fisicas) + ingresoMonRestante);\n\n          await tx.saldo.update({\n            where: {\n              punto_atencion_id_moneda_id: {\n                punto_atencion_id: cambio.punto_atencion_id,\n                moneda_id: cambio.moneda_origen_id,\n              },\n            },\n            data: {\n              cantidad: origenNuevoEf,\n              bancos: origenNuevoBk,\n              billetes: origenNuevoBil,\n              monedas_fisicas: origenNuevoMon,\n            },\n          });\n\n          // Registrar movimiento origen (separado CAJA/BANCOS)\n          if (ingresoEfRestante > 0) {\n            await registrarMovimientoSaldo(\n              {\n                puntoAtencionId: cambio.punto_atencion_id,\n                monedaId: cambio.moneda_origen_id,\n                tipoMovimiento: TipoMovimiento.INGRESO,\n                monto: round2(ingresoEfRestante),\n                saldoAnterior: round2(origenAnteriorEf),\n                saldoNuevo: round2(origenNuevoEf),\n                tipoReferencia: TipoReferencia.EXCHANGE,\n                referenciaId: cambio.id,\n                descripcion: `Completar cambio pendiente (ingreso restante caja) - Recibo: ${cambio.numero_recibo}`,\n                saldoBucket: \"CAJA\",\n                usuarioId: userId,\n              },\n              tx\n            );\n          }\n          if (ingresoBkRestante > 0) {\n            await registrarMovimientoSaldo(\n              {\n                puntoAtencionId: cambio.punto_atencion_id,\n                monedaId: cambio.moneda_origen_id,\n                tipoMovimiento: TipoMovimiento.INGRESO,\n                monto: round2(ingresoBkRestante),\n                saldoAnterior: round2(origenAnteriorBk),\n                saldoNuevo: round2(origenNuevoBk),\n                tipoReferencia: TipoReferencia.EXCHANGE,\n                referenciaId: cambio.id,\n                descripcion: `Completar cambio pendiente (ingreso restante bancos) - Recibo: ${cambio.numero_recibo}`,\n                saldoBucket: \"BANCOS\",\n                usuarioId: userId,\n              },\n              tx\n            );\n          }\n\n          // 2) Actualizar saldo destino (egreso del monto restante)\n          const existingSaldoDestino = await tx.saldo.findUnique({\n            where: {\n              punto_atencion_id_moneda_id: {\n                punto_atencion_id: cambio.punto_atencion_id,\n                moneda_id: cambio.moneda_destino_id,\n              },\n            },\n          });\n\n          const destinoAnteriorEf = num(existingSaldoDestino?.cantidad);\n          const destinoAnteriorBk = num(existingSaldoDestino?.bancos);\n          const destinoNuevoEf = round2(destinoAnteriorEf - egresoEfRestante);\n          const destinoNuevoBk = round2(destinoAnteriorBk - egresoBkRestante);\n          const destinoNuevoBil = round2(num(existingSaldoDestino?.billetes) - billetesEgresoRestante);\n          const destinoNuevoMon = round2(num(existingSaldoDestino?.monedas_fisicas) - monedasEgresoRestante);\n\n          await tx.saldo.update({\n            where: {\n              punto_atencion_id_moneda_id: {\n                punto_atencion_id: cambio.punto_atencion_id,\n                moneda_id: cambio.moneda_destino_id,\n              },\n            },\n            data: {\n              cantidad: destinoNuevoEf,\n              bancos: destinoNuevoBk,\n              billetes: destinoNuevoBil,\n              monedas_fisicas: destinoNuevoMon,\n            },\n          });\n\n          // Registrar movimiento destino (separado CAJA/BANCOS)\n          if (egresoEfRestante > 0) {\n            await registrarMovimientoSaldo(\n              {\n                puntoAtencionId: cambio.punto_atencion_id,\n                monedaId: cambio.moneda_destino_id,\n                tipoMovimiento: TipoMovimiento.EGRESO,\n                monto: round2(egresoEfRestante),\n                saldoAnterior: round2(destinoAnteriorEf),\n                saldoNuevo: round2(destinoNuevoEf),\n                tipoReferencia: TipoReferencia.EXCHANGE,\n                referenciaId: cambio.id,\n                descripcion: `Completar cambio pendiente (egreso restante caja) - Recibo: ${cambio.numero_recibo}`,\n                saldoBucket: \"CAJA\",\n                usuarioId: userId,\n              },\n              tx\n            );\n          }\n          if (egresoBkRestante > 0) {\n            await registrarMovimientoSaldo(\n              {\n                puntoAtencionId: cambio.punto_atencion_id,\n                monedaId: cambio.moneda_destino_id,\n                tipoMovimiento: TipoMovimiento.EGRESO,\n                monto: round2(egresoBkRestante),\n                saldoAnterior: round2(destinoAnteriorBk),\n                saldoNuevo: round2(destinoNuevoBk),\n                tipoReferencia: TipoReferencia.EXCHANGE,\n                referenciaId: cambio.id,\n                descripcion: `Completar cambio pendiente (egreso restante bancos) - Recibo: ${cambio.numero_recibo}`,\n                saldoBucket: \"BANCOS\",\n                usuarioId: userId,\n              },\n              tx\n            );\n          }\n        });\n      }\n\n      const numeroReciboCompletar = `COMP-${Date.now()}-${Math.random()\n        .toString(36)\n        .slice(2, 6)}`;\n      const updated = await prisma.cambioDivisa.update({\n        where: { id },\n        data: {\n          estado: EstadoTransaccion.COMPLETADO,\n          metodo_entrega: metodo_entrega || cambio.metodo_entrega,\n          transferencia_numero:\n            (metodo_entrega || cambio.metodo_entrega) === \"transferencia\"\n              ? transferencia_numero || cambio.transferencia_numero\n              : null,\n          transferencia_banco:\n            (metodo_entrega || cambio.metodo_entrega) === \"transferencia\"\n              ? transferencia_banco || cambio.transferencia_banco\n              : null,\n          transferencia_imagen_url:\n            (metodo_entrega || cambio.metodo_entrega) === \"transferencia\"\n              ? transferencia_imagen_url || cambio.transferencia_imagen_url\n              : null,\n          divisas_recibidas_billetes:\n            typeof divisas_recibidas_billetes === \"number\"\n              ? round2(divisas_recibidas_billetes)\n              : cambio.divisas_recibidas_billetes,\n          divisas_recibidas_monedas:\n            typeof divisas_recibidas_monedas === \"number\"\n              ? round2(divisas_recibidas_monedas)\n              : cambio.divisas_recibidas_monedas,\n          divisas_recibidas_total:\n            typeof divisas_recibidas_total === \"number\"\n              ? round2(divisas_recibidas_total)\n              : cambio.divisas_recibidas_total,\n          numero_recibo_completar: numeroReciboCompletar,\n          fecha_completado: new Date(),\n          saldo_pendiente: 0,\n        },\n        select: {\n          id: true,\n          fecha: true,\n          tipo_operacion: true,\n          estado: true,\n          monto_origen: true,\n          monto_destino: true,\n          tasa_cambio_billetes: true,\n          tasa_cambio_monedas: true,\n          observacion: true,\n          numero_recibo: true,\n          numero_recibo_abono: true,\n          numero_recibo_completar: true,\n          cliente: true,\n          divisas_entregadas_total: true,\n          divisas_recibidas_total: true,\n          saldo_pendiente: true,\n          abono_inicial_monto: true,\n          abono_inicial_fecha: true,\n          fecha_completado: true,\n          monedaOrigen: {\n            select: { id: true, nombre: true, codigo: true, simbolo: true },\n          },\n          monedaDestino: {\n            select: { id: true, nombre: true, codigo: true, simbolo: true },\n          },\n          usuario: { select: { id: true, nombre: true, username: true } },\n          puntoAtencion: { select: { id: true, nombre: true } },\n        },\n      });\n\n      await prisma.recibo.create({\n        data: {\n          numero_recibo: numeroReciboCompletar,\n          tipo_operacion: \"CAMBIO_DIVISA\",\n          referencia_id: updated.id,\n          usuario_id: req.user.id,\n          punto_atencion_id: cambio.punto_atencion_id,\n          datos_operacion: updated,\n        },\n      });\n\n      res.status(200).json({\n        exchange: updated,\n        success: true,\n        timestamp: new Date().toISOString(),\n      });\n    } catch (error) {\n      logger.error(\"Error al completar cambio de divisa\", {\n        error: error instanceof Error ? error.message : \"Unknown\",\n      });\n      res\n        .status(500)\n        .json({ error: \"Error interno al completar cambio\", success: false });\n    }\n  }\n);\n\n/* ========================= Pendientes / Parciales / Abonos ========================= */\n\nrouter.get(\n  \"/pending\",\n  authenticateToken,\n  async (req: AuthenticatedRequest, res: express.Response): Promise<void> => {\n    try {\n      const { pointId } = req.query;\n      if (!pointId) {\n        res.status(400).json({ success: false, error: \"Se requiere pointId\" });\n        return;\n      }\n\n      const exchanges = await prisma.cambioDivisa.findMany({\n        where: {\n          punto_atencion_id: String(pointId),\n          estado: EstadoTransaccion.PENDIENTE,\n          saldo_pendiente: { gt: 0 },\n        },\n        select: {\n          id: true,\n          fecha: true,\n          tipo_operacion: true,\n          estado: true,\n          monto_origen: true,\n          monto_destino: true,\n          tasa_cambio_billetes: true,\n          tasa_cambio_monedas: true,\n          observacion: true,\n          numero_recibo: true,\n          numero_recibo_abono: true,\n          numero_recibo_completar: true,\n          cliente: true,\n          divisas_entregadas_total: true,\n          divisas_entregadas_billetes: true,\n          divisas_entregadas_monedas: true,\n          divisas_recibidas_total: true,\n          divisas_recibidas_billetes: true,\n          divisas_recibidas_monedas: true,\n          saldo_pendiente: true,\n          abono_inicial_monto: true,\n          abono_inicial_fecha: true,\n          fecha_completado: true,\n          monedaOrigen: {\n            select: { id: true, nombre: true, codigo: true, simbolo: true },\n          },\n          monedaDestino: {\n            select: { id: true, nombre: true, codigo: true, simbolo: true },\n          },\n          usuario: { select: { id: true, nombre: true, username: true } },\n          puntoAtencion: { select: { id: true, nombre: true } },\n        },\n        orderBy: { fecha: \"desc\" },\n      });\n\n      // Enriquecer con datos_cliente desde Recibo.datos_operacion (para hist├│ricos)\n      let exchangesWithDatosCliente = exchanges;\n      try {\n        const refIds = exchanges.map((e) => e.id);\n        if (refIds.length > 0) {\n          const recibos = await prisma.recibo.findMany({\n            where: { referencia_id: { in: Array.from(new Set(refIds)) } },\n            select: { referencia_id: true, datos_operacion: true },\n          });\n          const datosClienteMap = new Map<string, JsonRecord>();\n          for (const r of recibos) {\n            const datos = extractDatosClienteFromDatosOperacion(r.datos_operacion);\n            if (r.referencia_id && datos) {\n              datosClienteMap.set(r.referencia_id, datos);\n            }\n          }\n          exchangesWithDatosCliente = exchanges.map((e) => ({\n            ...e,\n            datos_cliente: datosClienteMap.get(e.id) ?? undefined,\n          }));\n        }\n      } catch (e) {\n        logger.warn(\"No se pudo enriquecer exchanges (pending) con datos_cliente de recibos\", {\n          error: e instanceof Error ? e.message : String(e),\n        });\n      }\n\n      res.json({ success: true, exchanges: exchangesWithDatosCliente });\n    } catch (error) {\n      logger.error(\"Error fetching pending exchanges\", {\n        error: error instanceof Error ? error.message : \"Unknown\",\n      });\n      res\n        .status(500)\n        .json({ success: false, error: \"Error interno del servidor\" });\n    }\n  }\n);\n\nrouter.get(\n  \"/partial\",\n  authenticateToken,\n  async (req: AuthenticatedRequest, res: express.Response): Promise<void> => {\n    try {\n      const { pointId } = req.query;\n      const isAdmin =\n        req.user?.rol === \"ADMIN\" || req.user?.rol === \"SUPER_USUARIO\";\n\n      const where: Prisma.CambioDivisaWhereInput = {\n        saldo_pendiente: { gt: 0 },\n        estado: EstadoTransaccion.PENDIENTE,\n      };\n      if (!isAdmin && pointId) where.punto_atencion_id = String(pointId);\n      else if (isAdmin && pointId && pointId !== \"ALL\")\n        where.punto_atencion_id = String(pointId);\n\n      const exchanges = await prisma.cambioDivisa.findMany({\n        where,\n        select: {\n          id: true,\n          fecha: true,\n          tipo_operacion: true,\n          estado: true,\n          monto_origen: true,\n          monto_destino: true,\n          tasa_cambio_billetes: true,\n          tasa_cambio_monedas: true,\n          observacion: true,\n          numero_recibo: true,\n          numero_recibo_abono: true,\n          numero_recibo_completar: true,\n          cliente: true,\n          divisas_entregadas_total: true,\n          divisas_entregadas_billetes: true,\n          divisas_entregadas_monedas: true,\n          divisas_recibidas_total: true,\n          divisas_recibidas_billetes: true,\n          divisas_recibidas_monedas: true,\n          saldo_pendiente: true,\n          abono_inicial_monto: true,\n          abono_inicial_fecha: true,\n          fecha_completado: true,\n          observacion_parcial: true,\n          monedaOrigen: {\n            select: { id: true, nombre: true, codigo: true, simbolo: true },\n          },\n          monedaDestino: {\n            select: { id: true, nombre: true, codigo: true, simbolo: true },\n          },\n          usuario: { select: { id: true, nombre: true, username: true } },\n          puntoAtencion: { select: { id: true, nombre: true } },\n          abonoInicialRecibidoPorUsuario: {\n            select: { id: true, nombre: true, username: true },\n          },\n        },\n        orderBy: { fecha: \"desc\" },\n      });\n\n      // Enriquecer con datos_cliente desde Recibo.datos_operacion (para hist├│ricos)\n      let exchangesWithDatosCliente = exchanges;\n      try {\n        const recibos = await prisma.recibo.findMany({\n          where: {\n            referencia_id: { in: exchanges.map((e) => e.id) },\n            tipo_operacion: \"CAMBIO_DIVISA\",\n          },\n          select: {\n            referencia_id: true,\n            datos_operacion: true,\n          },\n        });\n        if (recibos?.length) {\n          const datosClienteMap = new Map<string, JsonRecord>();\n          for (const r of recibos) {\n            if (!r.referencia_id) continue;\n            const datos = extractDatosClienteFromDatosOperacion(r.datos_operacion);\n            if (datos) datosClienteMap.set(r.referencia_id, datos);\n          }\n          exchangesWithDatosCliente = exchanges.map((e) => ({\n            ...e,\n            datos_cliente: datosClienteMap.get(e.id) ?? undefined,\n          }));\n        }\n      } catch (e) {\n        logger.warn(\n          \"No se pudo enriquecer exchanges (partial) con datos_cliente de recibos\",\n          { error: e instanceof Error ? e.message : String(e) }\n        );\n      }\n\n      res.json({ success: true, exchanges: exchangesWithDatosCliente });\n    } catch (error) {\n      logger.error(\"Error fetching partial exchanges\", {\n        error: error instanceof Error ? error.message : \"Unknown\",\n      });\n      res.status(500).json({ success: false, error: \"Error interno del servidor\" });\n    }\n  }\n);\n\nrouter.patch(\n  \"/:id/complete-partial\",\n  authenticateToken,\n  async (req: AuthenticatedRequest, res: express.Response): Promise<void> => {\n    try {\n      const { id } = req.params;\n      const userId = req.user?.id;\n      if (!userId) {\n        res.status(401).json({ success: false, error: \"Usuario no autenticado\" });\n        return;\n      }\n      const isAdmin =\n        req.user?.rol === \"ADMIN\" || req.user?.rol === \"SUPER_USUARIO\";\n      if (!isAdmin) {\n        res.status(403).json({ success: false, error: \"Solo administradores\" });\n        return;\n      }\n\n      const exchange = await prisma.cambioDivisa.findUnique({\n        where: { id },\n        select: {\n          id: true,\n          estado: true,\n          monto_destino: true,\n          saldo_pendiente: true,\n          monedaDestino: { select: { codigo: true, simbolo: true } },\n        },\n      });\n      if (!exchange) {\n        res.status(404).json({ success: false, error: \"Cambio no encontrado\" });\n        return;\n      }\n      const sp = Number(exchange.saldo_pendiente || 0);\n      if (!(sp > 0)) {\n        res.status(400).json({\n          success: false,\n          error: \"Este cambio no tiene saldo pendiente\",\n        });\n        return;\n      }\n\n      const updated = await prisma.cambioDivisa.update({\n        where: { id },\n        data: {\n          saldo_pendiente: 0,\n          fecha_completado: new Date(),\n          estado: EstadoTransaccion.COMPLETADO,\n        },\n        select: {\n          id: true,\n          fecha: true,\n          tipo_operacion: true,\n          estado: true,\n          monto_origen: true,\n          monto_destino: true,\n          tasa_cambio_billetes: true,\n          tasa_cambio_monedas: true,\n          observacion: true,\n          numero_recibo: true,\n          numero_recibo_abono: true,\n          numero_recibo_completar: true,\n          cliente: true,\n          divisas_entregadas_total: true,\n          divisas_entregadas_billetes: true,\n          divisas_entregadas_monedas: true,\n          divisas_recibidas_total: true,\n          divisas_recibidas_billetes: true,\n          divisas_recibidas_monedas: true,\n          saldo_pendiente: true,\n          abono_inicial_monto: true,\n          abono_inicial_fecha: true,\n          fecha_completado: true,\n          monedaOrigen: {\n            select: { id: true, nombre: true, codigo: true, simbolo: true },\n          },\n          monedaDestino: {\n            select: { id: true, nombre: true, codigo: true, simbolo: true },\n          },\n          usuario: { select: { id: true, nombre: true, username: true } },\n          puntoAtencion: { select: { id: true, nombre: true } },\n        },\n      });\n\n      res.json({\n        success: true,\n        exchange: updated,\n        message: `Cambio parcial completado.`,\n      });\n    } catch (error) {\n      logger.error(\"Error completing partial exchange\", {\n        error: error instanceof Error ? error.message : \"Unknown\",\n      });\n      res\n        .status(500)\n        .json({ success: false, error: \"Error interno del servidor\" });\n    }\n  }\n);\n\nrouter.patch(\n  \"/:id/register-partial-payment\",\n  authenticateToken,\n  async (req: AuthenticatedRequest, res: express.Response): Promise<void> => {\n    try {\n      const { id } = req.params;\n      const { abono_inicial_monto, abono_inicial_fecha, observacion_parcial } =\n        req.body;\n\n      const exchange = await prisma.cambioDivisa.findUnique({\n        where: { id },\n        select: {\n          id: true,\n          estado: true,\n          monto_destino: true,\n          monedaDestino: { select: { codigo: true, simbolo: true } },\n        },\n      });\n      if (!exchange) {\n        res.status(404).json({ success: false, error: \"Cambio no encontrado\" });\n        return;\n      }\n      if (exchange.estado === EstadoTransaccion.COMPLETADO) {\n        res\n          .status(400)\n          .json({ success: false, error: \"Este cambio ya est├í completado\" });\n        return;\n      }\n\n      const abonoMonto = num(abono_inicial_monto);\n      const montoDestino = num(exchange.monto_destino);\n      if (!(abonoMonto > 0 && abonoMonto < montoDestino)) {\n        res.status(400).json({\n          success: false,\n          error: \"El abono debe ser > 0 y < monto total\",\n        });\n        return;\n      }\n      const saldoPendiente = round2(montoDestino - abonoMonto);\n\n      const updated = await prisma.cambioDivisa.update({\n        where: { id },\n        data: {\n          abono_inicial_monto: round2(abonoMonto),\n          abono_inicial_fecha: abono_inicial_fecha\n            ? new Date(abono_inicial_fecha)\n            : new Date(),\n          abono_inicial_recibido_por: req.user?.id || null,\n          saldo_pendiente: saldoPendiente,\n          observacion_parcial: observacion_parcial || null,\n          estado: EstadoTransaccion.PENDIENTE,\n        },\n        select: {\n          id: true,\n          fecha: true,\n          tipo_operacion: true,\n          estado: true,\n          monto_origen: true,\n          monto_destino: true,\n          tasa_cambio_billetes: true,\n          tasa_cambio_monedas: true,\n          observacion: true,\n          numero_recibo: true,\n          numero_recibo_abono: true,\n          numero_recibo_completar: true,\n          cliente: true,\n          divisas_entregadas_total: true,\n          divisas_entregadas_billetes: true,\n          divisas_entregadas_monedas: true,\n          divisas_recibidas_total: true,\n          divisas_recibidas_billetes: true,\n          divisas_recibidas_monedas: true,\n          saldo_pendiente: true,\n          abono_inicial_monto: true,\n          abono_inicial_fecha: true,\n          fecha_completado: true,\n          observacion_parcial: true,\n          monedaOrigen: {\n            select: { id: true, nombre: true, codigo: true, simbolo: true },\n          },\n          monedaDestino: {\n            select: { id: true, nombre: true, codigo: true, simbolo: true },\n          },\n          usuario: { select: { id: true, nombre: true, username: true } },\n          puntoAtencion: { select: { id: true, nombre: true } },\n          abonoInicialRecibidoPorUsuario: {\n            select: { id: true, nombre: true, username: true },\n          },\n        },\n      });\n\n      res.json({\n        success: true,\n        exchange: updated,\n        message: `Abono registrado. Saldo pendiente: ${saldoPendiente.toFixed(\n          2\n        )}`,\n      });\n    } catch (error) {\n      logger.error(\"Error registering partial payment\", {\n        error: error instanceof Error ? error.message : \"Unknown\",\n      });\n      res\n        .status(500)\n        .json({ success: false, error: \"Error interno del servidor\" });\n    }\n  }\n);\n\n/* ========================= B├║squeda de clientes ========================= */\n\nrouter.get(\n  \"/search-customers\",\n  authenticateToken,\n  async (req: AuthenticatedRequest, res: express.Response): Promise<void> => {\n    try {\n      if (!req.user?.id) {\n        res\n          .status(401)\n          .json({ error: \"Usuario no autenticado\", success: false });\n        return;\n      }\n      const { query } = req.query;\n      if (!query || typeof query !== \"string\" || query.trim().length < 2) {\n        res\n          .status(400)\n          .json({ error: \"Proporcione al menos 2 caracteres\", success: false });\n        return;\n      }\n      const searchTerm = query.trim().toLowerCase();\n\n      const exchanges = await prisma.cambioDivisa.findMany({\n        where: { cliente: { contains: searchTerm, mode: \"insensitive\" } },\n        select: { id: true, cliente: true, fecha: true, numero_recibo: true },\n        orderBy: { fecha: \"desc\" },\n        take: 20,\n      });\n      const recibos = await prisma.recibo.findMany({\n        where: {\n          tipo_operacion: \"CAMBIO_DIVISA\",\n          OR: [\n            {\n              datos_operacion: {\n                path: [\"datos_cliente\", \"nombre\"],\n                string_contains: searchTerm,\n              },\n            },\n            {\n              datos_operacion: {\n                path: [\"datos_cliente\", \"apellido\"],\n                string_contains: searchTerm,\n              },\n            },\n            {\n              datos_operacion: {\n                path: [\"datos_cliente\", \"cedula\"],\n                string_contains: searchTerm,\n              },\n            },\n          ],\n        },\n        select: {\n          id: true,\n          datos_operacion: true,\n          fecha: true,\n          numero_recibo: true,\n        },\n        orderBy: { fecha: \"desc\" },\n        take: 20,\n      });\n\n      const clientesFromExchanges = exchanges.map((e) => ({\n        id: e.id,\n        nombre: e.cliente?.split(\" \")[0] || \"\",\n        apellido: e.cliente?.split(\" \").slice(1).join(\" \") || \"\",\n        cedula: \"\",\n        telefono: \"\",\n        fuente: \"exchange\",\n        fecha_ultima_operacion: e.fecha,\n        numero_recibo: e.numero_recibo,\n      }));\n\n      type CustomerRow = {\n        id: string;\n        nombre: string;\n        apellido: string;\n        cedula: string;\n        telefono: string;\n        fuente: \"exchange\" | \"recibo\";\n        fecha_ultima_operacion: Date;\n        numero_recibo: string | null;\n      };\n\n      const clientesFromExchangesTyped: CustomerRow[] = clientesFromExchanges.map(\n        (c) => ({\n          ...c,\n          fuente: \"exchange\" as const,\n          numero_recibo: c.numero_recibo ?? null,\n        })\n      );\n\n      const clientesFromRecibos: CustomerRow[] = recibos.map((r) => {\n        const dc = extractDatosClienteFromDatosOperacion(r.datos_operacion) ?? {};\n        return {\n          id: r.id,\n          nombre: getStringFromRecord(dc, \"nombre\") || \"\",\n          apellido: getStringFromRecord(dc, \"apellido\") || \"\",\n          cedula: getStringFromRecord(dc, \"cedula\") || \"\",\n          telefono: getStringFromRecord(dc, \"telefono\") || \"\",\n          fuente: \"recibo\",\n          fecha_ultima_operacion: r.fecha,\n          numero_recibo: r.numero_recibo,\n        };\n      });\n\n      const all: CustomerRow[] = [...clientesFromExchangesTyped, ...clientesFromRecibos];\n      const map = new Map<string, CustomerRow>();\n      for (const c of all) {\n        const key = c.cedula || `${c.nombre}_${c.apellido}`;\n        const existing = map.get(key);\n        if (!existing || c.fecha_ultima_operacion > existing.fecha_ultima_operacion) {\n          map.set(key, c);\n        }\n      }\n\n      const resultados = Array.from(map.values())\n        .filter((c) => {\n          const full = `${c.nombre} ${c.apellido}`.toLowerCase();\n          const cedula = (c.cedula || \"\").toLowerCase();\n          return full.includes(searchTerm) || cedula.includes(searchTerm);\n        })\n        .sort(\n          (a, b) =>\n            b.fecha_ultima_operacion.getTime() -\n            a.fecha_ultima_operacion.getTime()\n        )\n        .slice(0, 10);\n\n      res.status(200).json({\n        clientes: resultados,\n        success: true,\n        timestamp: new Date().toISOString(),\n      });\n    } catch (error) {\n      logger.error(\"Error al buscar clientes\", {\n        error: error instanceof Error ? error.message : \"Unknown\",\n      });\n      res.status(500).json({\n        error: \"Error interno del servidor al buscar clientes\",\n        success: false,\n      });\n    }\n  }\n);\n\n/* ========================= Recontabilizar (idempotente por referencia) ========================= */\n\nrouter.post(\n  \"/:id/recontabilizar\",\n  authenticateToken,\n  async (req: AuthenticatedRequest, res: express.Response): Promise<void> => {\n    try {\n      const { id } = req.params;\n      if (!req.user?.id) {\n        res\n          .status(401)\n          .json({ success: false, error: \"Usuario no autenticado\" });\n        return;\n      }\n\n      const cambio = await prisma.cambioDivisa.findUnique({\n        where: { id },\n        include: {\n          monedaOrigen: true,\n          monedaDestino: true,\n        },\n      });\n      if (!cambio) {\n        res.status(404).json({ success: false, error: \"Cambio no encontrado\" });\n        return;\n      }\n\n      const existentes = await prisma.movimientoSaldo.findMany({\n        where: { referencia_id: cambio.id, tipo_referencia: \"CAMBIO_DIVISA\" },\n        select: { id: true },\n      });\n      if (existentes.length > 0) {\n        res.status(200).json({\n          success: true,\n          message: \"Movimientos ya existen para este cambio. No se duplic├│.\",\n        });\n        return;\n      }\n\n      // Reconstruir egresos/ingresos coherentes con m├®todos\n      const isDestinoUSD = isUSDByCode(cambio.monedaDestino?.codigo);\n      const totDestino = num(\n        cambio.divisas_recibidas_total || cambio.monto_destino\n      );\n      const egresoEf = isDestinoUSD\n        ? num(cambio.usd_entregado_efectivo)\n        : cambio.metodo_entrega === \"efectivo\"\n        ? totDestino\n        : 0;\n      const egresoBk = isDestinoUSD\n        ? num(cambio.usd_entregado_transfer)\n        : cambio.metodo_entrega === \"transferencia\"\n        ? totDestino\n        : 0;\n\n      const totOrigen = num(\n        cambio.divisas_entregadas_total || cambio.monto_origen\n      );\n      const ingresoEf =\n        cambio.metodo_pago_origen === \"EFECTIVO\"\n          ? totOrigen\n          : cambio.metodo_pago_origen === \"MIXTO\"\n          ? num(cambio.usd_recibido_efectivo)\n          : 0;\n      const ingresoBk =\n        cambio.metodo_pago_origen === \"BANCO\"\n          ? totOrigen\n          : cambio.metodo_pago_origen === \"MIXTO\"\n          ? num(cambio.usd_recibido_transfer)\n          : 0;\n\n      const movimientos = [\n        ...(egresoEf > 0\n          ? [\n              {\n                punto_atencion_id: cambio.punto_atencion_id,\n                moneda_id: cambio.moneda_destino_id,\n                tipo_movimiento: \"EGRESO\",\n                monto: egresoEf,\n                usuario_id: req.user.id,\n                referencia_id: cambio.id,\n                tipo_referencia: \"CAMBIO_DIVISA\",\n                descripcion: `Egreso efectivo (recontabilizar)`,\n              },\n            ]\n          : []),\n        ...(egresoBk > 0\n          ? [\n              {\n                punto_atencion_id: cambio.punto_atencion_id,\n                moneda_id: cambio.moneda_destino_id,\n                tipo_movimiento: \"EGRESO\",\n                monto: egresoBk,\n                usuario_id: req.user.id,\n                referencia_id: cambio.id,\n                tipo_referencia: \"CAMBIO_DIVISA\",\n                descripcion: `Egreso bancos (recontabilizar)`,\n              },\n            ]\n          : []),\n        ...(ingresoEf > 0\n          ? [\n              {\n                punto_atencion_id: cambio.punto_atencion_id,\n                moneda_id: cambio.moneda_origen_id,\n                tipo_movimiento: \"INGRESO\",\n                monto: ingresoEf,\n                usuario_id: req.user.id,\n                referencia_id: cambio.id,\n                tipo_referencia: \"CAMBIO_DIVISA\",\n                descripcion: `Ingreso efectivo (recontabilizar)`,\n              },\n            ]\n          : []),\n        ...(ingresoBk > 0\n          ? [\n              {\n                punto_atencion_id: cambio.punto_atencion_id,\n                moneda_id: cambio.moneda_origen_id,\n                tipo_movimiento: \"INGRESO\",\n                monto: ingresoBk,\n                usuario_id: req.user.id,\n                referencia_id: cambio.id,\n                tipo_referencia: \"CAMBIO_DIVISA\",\n                descripcion: `Ingreso bancos (recontabilizar)`,\n              },\n            ]\n          : []),\n      ];\n\n      const baseUrl =\n        process.env.INTERNAL_API_BASE_URL || \"http://localhost:3001/api\";\n      const url = `${baseUrl}/movimientos-contables/procesar-cambio`;\n      const response = await axios.post(\n        url,\n        { cambio_id: cambio.id, movimientos },\n        {\n          headers: { Authorization: req.headers.authorization || \"\" },\n          timeout: 15000,\n        }\n      );\n\n      res.status(200).json({ success: true, result: response.data });\n    } catch (error) {\n      if (axios.isAxiosError(error)) {\n        const status = error.response?.status || 500;\n        const data = error.response?.data || { error: error.message };\n        logger.error(\"Error al recontabilizar cambio (axios)\", {\n          status,\n          data,\n        });\n        res.status(status).json({\n          success: false,\n          ...(typeof data === \"object\" ? data : { error: String(data) }),\n        });\n        return;\n      }\n      logger.error(\"Error al recontabilizar cambio\", {\n        error: error instanceof Error ? error.message : String(error),\n      });\n      res\n        .status(500)\n        .json({ success: false, error: \"No se pudo recontabilizar\" });\n    }\n  }\n);\n\n/* ========================= Eliminar (reversa exacta + limpiar recibos) ========================= */\n\nrouter.delete(\n  \"/:id\",\n  authenticateToken,\n  requireRole([\"ADMIN\", \"SUPER_USUARIO\"]),\n  async (req: AuthenticatedRequest, res: express.Response): Promise<void> => {\n    try {\n      const { id } = req.params;\n      const userId = req.user?.id;\n      if (!userId) {\n        res.status(401).json({ success: false, error: \"Usuario no autenticado\" });\n        return;\n      }\n\n      const cambio = await prisma.cambioDivisa.findUnique({\n        where: { id },\n        include: { monedaOrigen: true, monedaDestino: true },\n      });\n      if (!cambio) {\n        res.status(404).json({ success: false, error: \"Cambio no encontrado\" });\n        return;\n      }\n\n      // Los administradores pueden eliminar cambios de cualquier fecha\n      // (Restricci├│n de d├¡a actual eliminada para permitir correcciones de errores)\n\n      await prisma.$transaction(async (tx) => {\n        // Revertir ORIGEN (hab├¡a INGRESO efectivo y/o bancos seg├║n metodo_pago_origen)\n        const saldoOrigen = await getSaldo(\n          tx,\n          cambio.punto_atencion_id,\n          cambio.moneda_origen_id\n        );\n        const anteriorEf = num(saldoOrigen?.cantidad);\n        const anteriorBk =\n          typeof saldoOrigen?.bancos !== \"undefined\"\n            ? num(saldoOrigen?.bancos)\n            : 0;\n\n        const ingresoEf = num(cambio.usd_recibido_efectivo, 0);\n        const ingresoBk = num(cambio.usd_recibido_transfer, 0);\n\n        const nuevoEf = Math.max(0, round2(anteriorEf - ingresoEf));\n        const nuevoBk = Math.max(0, round2(anteriorBk - ingresoBk));\n\n        // Billetes/monedas f├¡sicos solo si hubo ingresoEf\n        const nuevoBil = Math.max(\n          0,\n          round2(\n            num(saldoOrigen?.billetes) -\n              (ingresoEf > 0 ? num(cambio.divisas_entregadas_billetes) : 0)\n          )\n        );\n        const nuevoMon = Math.max(\n          0,\n          round2(\n            num(saldoOrigen?.monedas_fisicas) -\n              (ingresoEf > 0 ? num(cambio.divisas_entregadas_monedas) : 0)\n          )\n        );\n\n        await upsertSaldoEfectivoYBancos(\n          tx,\n          cambio.punto_atencion_id,\n          cambio.moneda_origen_id,\n          {\n            cantidad: nuevoEf,\n            billetes: nuevoBil,\n            monedas_fisicas: nuevoMon,\n            ...(typeof saldoOrigen?.bancos !== \"undefined\"\n              ? { bancos: nuevoBk }\n              : {}),\n          }\n        );\n        if (ingresoEf > 0) {\n          await logMovimientoSaldo(tx, {\n            punto_atencion_id: cambio.punto_atencion_id,\n            moneda_id: cambio.moneda_origen_id,\n            tipo_movimiento: \"AJUSTE\",\n            monto: -ingresoEf,\n            saldo_anterior: anteriorEf,\n            saldo_nuevo: nuevoEf,\n            usuario_id: userId,\n            referencia_id: cambio.id,\n            tipo_referencia: \"CAMBIO_DIVISA\",\n            descripcion: `Reverso eliminaci├│n cambio (origen efectivo) #${\n              cambio.numero_recibo || \"\"\n            }`,\n          });\n        }\n        if (ingresoBk > 0 && typeof saldoOrigen?.bancos !== \"undefined\") {\n          await logMovimientoSaldo(tx, {\n            punto_atencion_id: cambio.punto_atencion_id,\n            moneda_id: cambio.moneda_origen_id,\n            tipo_movimiento: \"AJUSTE\",\n            monto: -ingresoBk,\n            saldo_anterior: anteriorBk,\n            saldo_nuevo: nuevoBk,\n            usuario_id: userId,\n            referencia_id: cambio.id,\n            tipo_referencia: \"CAMBIO_DIVISA\",\n            descripcion: `Reverso eliminaci├│n cambio (origen bancos) #${\n              cambio.numero_recibo || \"\"\n            }`,\n          });\n        }\n\n        // Revertir DESTINO (hab├¡a EGRESO ef + bancos)\n        const saldoDestino = await getSaldo(\n          tx,\n          cambio.punto_atencion_id,\n          cambio.moneda_destino_id\n        );\n        const antEf = num(saldoDestino?.cantidad);\n        const antBk =\n          typeof saldoDestino?.bancos !== \"undefined\"\n            ? num(saldoDestino?.bancos)\n            : 0;\n\n        const egEf = num(cambio.usd_entregado_efectivo, 0);\n        const egBk = num(cambio.usd_entregado_transfer, 0);\n        const sumDestTotal = num(\n          cambio.divisas_recibidas_total || cambio.monto_destino\n        );\n\n        // Si hubo egreso en efectivo, regresamos efectivo f├¡sico y su breakdown\n        const devolverEf = egEf > 0 ? egEf : sumDestTotal;\n        const nuevoEfDest = round2(antEf + devolverEf);\n        const nuevoBkDest = round2(antBk + egBk);\n\n        // ÔÜá´©Å Solo recuperar billetes/monedas si originalmente hubo efectivo\n        const sumarBilletes =\n          egEf > 0 ? round2(num(cambio.divisas_recibidas_billetes)) : 0;\n        const sumarMonedas =\n          egEf > 0 ? round2(num(cambio.divisas_recibidas_monedas)) : 0;\n\n        const nuevoBilDest = round2(\n          num(saldoDestino?.billetes) + sumarBilletes\n        );\n        const nuevoMonDest = round2(\n          num(saldoDestino?.monedas_fisicas) + sumarMonedas\n        );\n\n        await upsertSaldoEfectivoYBancos(\n          tx,\n          cambio.punto_atencion_id,\n          cambio.moneda_destino_id,\n          {\n            cantidad: nuevoEfDest,\n            billetes: nuevoBilDest,\n            monedas_fisicas: nuevoMonDest,\n            ...(typeof saldoDestino?.bancos !== \"undefined\"\n              ? { bancos: nuevoBkDest }\n              : {}),\n          }\n        );\n\n        // Ajuste por EFECTIVO (si hubo egreso en efectivo originalmente)\n        await logMovimientoSaldo(tx, {\n          punto_atencion_id: cambio.punto_atencion_id,\n          moneda_id: cambio.moneda_destino_id,\n          tipo_movimiento: \"AJUSTE\",\n          monto: devolverEf,\n          saldo_anterior: antEf,\n          saldo_nuevo: nuevoEfDest,\n          usuario_id: userId,\n          referencia_id: cambio.id,\n          tipo_referencia: \"CAMBIO_DIVISA\",\n          descripcion: `Reverso eliminaci├│n cambio (destino efectivo) #${\n            cambio.numero_recibo || \"\"\n          }`,\n        });\n\n        // Ajuste por BANCOS (si aplica)\n        if (egBk > 0 && typeof saldoDestino?.bancos !== \"undefined\") {\n          await logMovimientoSaldo(tx, {\n            punto_atencion_id: cambio.punto_atencion_id,\n            moneda_id: cambio.moneda_destino_id,\n            tipo_movimiento: \"AJUSTE\",\n            monto: egBk,\n            saldo_anterior: antBk,\n            saldo_nuevo: nuevoBkDest,\n            usuario_id: userId,\n            referencia_id: cambio.id,\n            tipo_referencia: \"CAMBIO_DIVISA\",\n            descripcion: `Reverso eliminaci├│n cambio (destino bancos) #${\n              cambio.numero_recibo || \"\"\n            }`,\n          });\n        }\n\n        // Borrar recibos vinculados\n        const reciboOr: Prisma.ReciboWhereInput[] = [{ referencia_id: cambio.id }];\n        if (cambio.numero_recibo) reciboOr.push({ numero_recibo: cambio.numero_recibo });\n        if (cambio.numero_recibo_abono) reciboOr.push({ numero_recibo: cambio.numero_recibo_abono });\n        if (cambio.numero_recibo_completar) reciboOr.push({ numero_recibo: cambio.numero_recibo_completar });\n        await tx.recibo.deleteMany({\n          where: {\n            OR: reciboOr,\n          },\n        });\n\n        // Borrar cambio\n        await tx.cambioDivisa.delete({ where: { id: cambio.id } });\n      });\n\n      logger.info(\"Cambio de divisa eliminado por admin\", {\n        cambio_id: id,\n        user_id: req.user?.id,\n      });\n      res.json({ success: true });\n    } catch (error) {\n      logger.error(\"Error eliminando cambio de divisa\", {\n        error: error instanceof Error ? error.message : String(error),\n      });\n      res\n        .status(500)\n        .json({ success: false, error: \"No se pudo eliminar el cambio\" });\n    }\n  }\n);\n\nexport default router;\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\oswal\\OneDrive\\Documentos\\Punto Cambio\\punto_cambio_new\\server\\routes\\guardar-cierre.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\oswal\\OneDrive\\Documentos\\Punto Cambio\\punto_cambio_new\\server\\routes\\historial-saldo.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\oswal\\OneDrive\\Documentos\\Punto Cambio\\punto_cambio_new\\server\\routes\\movimientos-contables.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\oswal\\OneDrive\\Documentos\\Punto Cambio\\punto_cambio_new\\server\\routes\\movimientos-saldo.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\oswal\\OneDrive\\Documentos\\Punto Cambio\\punto_cambio_new\\server\\routes\\permissions.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\oswal\\OneDrive\\Documentos\\Punto Cambio\\punto_cambio_new\\server\\routes\\points.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\oswal\\OneDrive\\Documentos\\Punto Cambio\\punto_cambio_new\\server\\routes\\puntos-atencion.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\oswal\\OneDrive\\Documentos\\Punto Cambio\\punto_cambio_new\\server\\routes\\reports.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\oswal\\OneDrive\\Documentos\\Punto Cambio\\punto_cambio_new\\server\\routes\\reportsDebug.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\oswal\\OneDrive\\Documentos\\Punto Cambio\\punto_cambio_new\\server\\routes\\saldo-reconciliation.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\oswal\\OneDrive\\Documentos\\Punto Cambio\\punto_cambio_new\\server\\routes\\saldos-actuales.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\oswal\\OneDrive\\Documentos\\Punto Cambio\\punto_cambio_new\\server\\routes\\saldos-iniciales.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\oswal\\OneDrive\\Documentos\\Punto Cambio\\punto_cambio_new\\server\\routes\\schedules.ts","messages":[{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'e' is defined but never used.","line":667,"column":12,"nodeType":null,"messageId":"unusedVar","endLine":667,"endColumn":13},{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'e' is defined but never used.","line":738,"column":12,"nodeType":null,"messageId":"unusedVar","endLine":738,"endColumn":13}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":2,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import express from \"express\";\r\nimport { Prisma, EstadoJornada } from \"@prisma/client\";\r\nimport prisma from \"../lib/prisma.js\";\r\nimport logger from \"../utils/logger.js\";\r\nimport { authenticateToken } from \"../middleware/auth.js\";\r\nimport { validate } from \"../middleware/validation.js\";\r\nimport { z } from \"zod\";\r\nimport {\r\n  gyeDayRangeUtcFromDate,\r\n  gyeDayRangeUtcFromYMD,\r\n  gyeParseDateOnly,\r\n} from \"../utils/timezone.js\";\r\n\r\nconst router = express.Router();\r\n\r\n/** =========================\r\n * Utilidades de roles exentos de caja\r\n * ========================= */\r\nconst ROLES_EXENTOS_CIERRE = new Set([\r\n  \"OPERADOR\",\r\n  \"ADMINISTRATIVO\",\r\n  \"ADMIN\",\r\n  \"SUPER_USUARIO\",\r\n  \"SUPER USUARIO\",\r\n]);\r\n\r\nfunction normalizaRol(rol?: string) {\r\n  return (rol || \"\")\r\n    .normalize(\"NFKD\")\r\n    .replace(/\\s+/g, \" \")\r\n    .trim()\r\n    .toUpperCase();\r\n}\r\nfunction esExentoDeCaja(rol?: string) {\r\n  return ROLES_EXENTOS_CIERRE.has(normalizaRol(rol));\r\n}\r\n\r\n/** Schema de entrada para crear/actualizar jornada */\r\nconst scheduleSchema = z\r\n  .object({\r\n    usuario_id: z.string().uuid(),\r\n    punto_atencion_id: z.string().uuid(),\r\n    fecha_inicio: z.string().datetime().optional(),\r\n    fecha_almuerzo: z.string().datetime().optional(),\r\n    fecha_regreso: z.string().datetime().optional(),\r\n    fecha_salida: z.string().datetime().optional(),\r\n    ubicacion_inicio: z\r\n      .object({\r\n        lat: z.number(),\r\n        lng: z.number(),\r\n        direccion: z.string().optional(),\r\n      })\r\n      .optional()\r\n      .nullable(),\r\n    ubicacion_salida: z\r\n      .object({\r\n        lat: z.number(),\r\n        lng: z.number(),\r\n        direccion: z.string().optional(),\r\n      })\r\n      .optional()\r\n      .nullable(),\r\n    /** Solo tendr├í efecto para roles privilegiados; opcional */\r\n    override: z.boolean().optional(),\r\n  })\r\n  .refine(\r\n    (data) =>\r\n      data.fecha_inicio ||\r\n      data.fecha_almuerzo ||\r\n      data.fecha_regreso ||\r\n      data.fecha_salida,\r\n    {\r\n      message:\r\n        \"Se requiere al menos una fecha (inicio, almuerzo, regreso o salida)\",\r\n    }\r\n  );\r\n\r\n// ==============================\r\n// GET /schedules (listado con filtros)\r\n// ==============================\r\nrouter.get(\"/\", authenticateToken, async (req, res) => {\r\n  try {\r\n    res.set({\r\n      \"Cache-Control\": \"no-store, no-cache, must-revalidate, proxy-revalidate\",\r\n      Pragma: \"no-cache\",\r\n      Expires: \"0\",\r\n      \"Surrogate-Control\": \"no-store\",\r\n    });\r\n\r\n    const whereClause: Prisma.JornadaWhereInput = {};\r\n\r\n    // Restricci├│n por rol: OPERADOR y ADMINISTRATIVO solo ven sus propias jornadas\r\n    if (req.user?.rol === \"OPERADOR\" || req.user?.rol === \"ADMINISTRATIVO\") {\r\n      whereClause.usuario_id = req.user.id;\r\n    }\r\n\r\n    // Admin y Super Usuario pueden consultar por usuario espec├¡fico\r\n    if (\r\n      req.query.usuario_id &&\r\n      [\"ADMIN\", \"SUPER_USUARIO\"].includes(req.user?.rol || \"\")\r\n    ) {\r\n      whereClause.usuario_id = req.query.usuario_id as string;\r\n    }\r\n\r\n    // Filtros de fecha: \"fecha\" (YYYY-MM-DD) o rango \"from\"/\"to\"\r\n    const { fecha, from, to } = req.query as {\r\n      fecha?: string;\r\n      from?: string;\r\n      to?: string;\r\n    };\r\n\r\n    if (fecha) {\r\n      const { y, m, d } = gyeParseDateOnly(fecha);\r\n      const { gte, lt } = gyeDayRangeUtcFromYMD(y, m, d);\r\n      whereClause.fecha_inicio = { gte, lt };\r\n    } else if (from || to) {\r\n      let gte: Date | undefined;\r\n      let lt: Date | undefined;\r\n      if (from) {\r\n        const { y, m, d } = gyeParseDateOnly(from);\r\n        ({ gte } = gyeDayRangeUtcFromYMD(y, m, d));\r\n      }\r\n      if (to) {\r\n        const { y, m, d } = gyeParseDateOnly(to);\r\n        ({ lt } = gyeDayRangeUtcFromYMD(y, m, d));\r\n      }\r\n      whereClause.fecha_inicio = {\r\n        ...(gte ? { gte } : {}),\r\n        ...(lt ? { lt } : {}),\r\n      } as Prisma.DateTimeFilter;\r\n    }\r\n\r\n    // Filtro por estados (coma-separado), ej: estados=ACTIVO,ALMUERZO\r\n    if (req.query.estados) {\r\n      const estados = String(req.query.estados)\r\n        .split(\",\")\r\n        .map((s) => s.trim())\r\n        .filter(Boolean);\r\n      if (estados.length > 0) {\r\n        const valid = estados.filter((e): e is EstadoJornada =>\r\n          Object.values(EstadoJornada).includes(e as EstadoJornada)\r\n        );\r\n        if (valid.length > 0) whereClause.estado = { in: valid };\r\n      }\r\n    }\r\n\r\n    // Paginaci├│n\r\n    const rawLimit = parseInt(String(req.query.limit ?? \"50\"), 10);\r\n    const rawOffset = parseInt(String(req.query.offset ?? \"0\"), 10);\r\n    const take = Math.min(Math.max(isNaN(rawLimit) ? 50 : rawLimit, 1), 500);\r\n    const skip = Math.max(isNaN(rawOffset) ? 0 : rawOffset, 0);\r\n\r\n    const schedules = await prisma.jornada.findMany({\r\n      where: whereClause,\r\n      include: {\r\n        usuario: { select: { id: true, nombre: true, username: true } },\r\n        puntoAtencion: {\r\n          select: {\r\n            id: true,\r\n            nombre: true,\r\n            direccion: true,\r\n            ciudad: true,\r\n            provincia: true,\r\n            codigo_postal: true,\r\n            activo: true,\r\n            servientrega_agencia_codigo: true,\r\n            servientrega_agencia_nombre: true,\r\n            created_at: true,\r\n            updated_at: true,\r\n          },\r\n        },\r\n      },\r\n      orderBy: { fecha_inicio: \"desc\" },\r\n      skip,\r\n      take,\r\n    });\r\n\r\n    const formattedSchedules = schedules.map((s) => ({\r\n      ...s,\r\n      fecha_inicio: s.fecha_inicio.toISOString(),\r\n      fecha_almuerzo: s.fecha_almuerzo?.toISOString() || null,\r\n      fecha_regreso: s.fecha_regreso?.toISOString() || null,\r\n      fecha_salida: s.fecha_salida?.toISOString() || null,\r\n    }));\r\n\r\n    logger.info(\"Horarios obtenidos\", {\r\n      count: formattedSchedules.length,\r\n      requestedBy: req.user?.id,\r\n      filters: { fecha, from, to, estados: req.query.estados },\r\n    });\r\n\r\n    // Exportaci├│n CSV opcional\r\n    if (String(req.query.format || \"\").toLowerCase() === \"csv\") {\r\n      const header = [\r\n        \"id\",\r\n        \"usuario_id\",\r\n        \"usuario_nombre\",\r\n        \"usuario_username\",\r\n        \"punto_atencion_id\",\r\n        \"punto_nombre\",\r\n        \"estado\",\r\n        \"fecha_inicio\",\r\n        \"fecha_almuerzo\",\r\n        \"fecha_regreso\",\r\n        \"fecha_salida\",\r\n      ];\r\n      const rows = formattedSchedules.map((s) => [\r\n        s.id,\r\n        s.usuario_id,\r\n        s.usuario?.nombre || \"\",\r\n        s.usuario?.username || \"\",\r\n        s.punto_atencion_id,\r\n        s.puntoAtencion?.nombre || \"\",\r\n        s.estado,\r\n        s.fecha_inicio,\r\n        s.fecha_almuerzo || \"\",\r\n        s.fecha_regreso || \"\",\r\n        s.fecha_salida || \"\",\r\n      ]);\r\n      const csv = [header, ...rows]\r\n        .map((cols) =>\r\n          cols\r\n            .map((c) =>\r\n              typeof c === \"string\" && (c.includes(\",\") || c.includes(\"\\n\"))\r\n                ? `\"${c.replaceAll('\"', '\"\"')}\"`\r\n                : String(c)\r\n            )\r\n            .join(\",\")\r\n        )\r\n        .join(\"\\n\");\r\n      res.setHeader(\"Content-Type\", \"text/csv; charset=utf-8\");\r\n      res.setHeader(\r\n        \"Content-Disposition\",\r\n        `attachment; filename=\"jornadas_${new Date()\r\n          .toISOString()\r\n          .slice(0, 10)}.csv\"`\r\n      );\r\n      res.status(200).send(csv);\r\n      return;\r\n    }\r\n\r\n    res.status(200).json({\r\n      schedules: formattedSchedules,\r\n      success: true,\r\n      timestamp: new Date().toISOString(),\r\n    });\r\n  } catch (error) {\r\n    logger.error(\"Error al obtener horarios\", {\r\n      error: error instanceof Error ? error.message : \"Unknown error\",\r\n      stack: error instanceof Error ? error.stack : undefined,\r\n      requestedBy: req.user?.id,\r\n    });\r\n\r\n    res.status(500).json({\r\n      error: \"Error al obtener horarios\",\r\n      success: false,\r\n      timestamp: new Date().toISOString(),\r\n    });\r\n  }\r\n});\r\n\r\n// ==============================\r\n// POST /schedules (crear o actualizar jornada)\r\n// ==============================\r\nrouter.post(\r\n  \"/\",\r\n  authenticateToken,\r\n  validate(scheduleSchema),\r\n  async (req, res) => {\r\n    try {\r\n      const {\r\n        usuario_id,\r\n        punto_atencion_id,\r\n        fecha_inicio,\r\n        fecha_almuerzo,\r\n        fecha_regreso,\r\n        fecha_salida,\r\n        ubicacion_inicio,\r\n        ubicacion_salida,\r\n        override,\r\n      } = req.body as {\r\n        usuario_id: string;\r\n        punto_atencion_id: string;\r\n        fecha_inicio?: string;\r\n        fecha_almuerzo?: string;\r\n        fecha_regreso?: string;\r\n        fecha_salida?: string;\r\n        ubicacion_inicio?: {\r\n          lat: number;\r\n          lng: number;\r\n          direccion?: string;\r\n        } | null;\r\n        ubicacion_salida?: {\r\n          lat: number;\r\n          lng: number;\r\n          direccion?: string;\r\n        } | null;\r\n        override?: boolean;\r\n      };\r\n\r\n      // Operadores/Administrativos/Concesi├│n solo gestionan sus propias jornadas\r\n      if (\r\n        (req.user?.rol === \"OPERADOR\" ||\r\n          req.user?.rol === \"ADMINISTRATIVO\" ||\r\n          req.user?.rol === \"CONCESION\") &&\r\n        usuario_id !== req.user.id\r\n      ) {\r\n        res.status(403).json({\r\n          error:\r\n            \"Los operadores y administrativos solo pueden gestionar sus propias jornadas\",\r\n          success: false,\r\n          timestamp: new Date().toISOString(),\r\n        });\r\n        return;\r\n      }\r\n\r\n      const rol = req.user?.rol;\r\n      const esPrivilegiado =\r\n        rol === \"ADMINISTRATIVO\" || rol === \"ADMIN\" || rol === \"SUPER_USUARIO\";\r\n\r\n      // Bloquear que OPERADOR/CONCESION inicien jornada en el punto principal\r\n      if (rol === \"OPERADOR\" || rol === \"CONCESION\") {\r\n        const puntoAtencion = await prisma.puntoAtencion.findUnique({\r\n          where: { id: punto_atencion_id },\r\n          select: { es_principal: true, nombre: true },\r\n        });\r\n\r\n        if (puntoAtencion?.es_principal) {\r\n          res.status(403).json({\r\n            error: \"Este rol no puede iniciar jornada en el punto principal\",\r\n            success: false,\r\n            timestamp: new Date().toISOString(),\r\n          });\r\n          return;\r\n        }\r\n      }\r\n\r\n      // Ventana del d├¡a (zona Guayaquil)\r\n      const { gte: hoyGte, lt: hoyLt } = gyeDayRangeUtcFromDate(new Date());\r\n\r\n      // 1) Ver si el usuario ya tiene una jornada ACTIVA/ALMUERZO hoy (para update en lugar de create)\r\n      const existingSchedule = await prisma.jornada.findFirst({\r\n        where: {\r\n          usuario_id,\r\n          fecha_inicio: { gte: hoyGte, lt: hoyLt },\r\n          OR: [\r\n            { estado: EstadoJornada.ACTIVO },\r\n            { estado: EstadoJornada.ALMUERZO },\r\n          ],\r\n        },\r\n      });\r\n\r\n      // 2) Si NO hay jornada previa del usuario (vamos a CREAR) y el rol NO es privilegiado,\r\n      // validar que el punto NO est├® ocupado por otra jornada ACTIVO/ALMUERZO hoy.\r\n      if (!existingSchedule && !esPrivilegiado) {\r\n        const puntoOcupado = await prisma.jornada.findFirst({\r\n          where: {\r\n            punto_atencion_id,\r\n            fecha_inicio: { gte: hoyGte, lt: hoyLt },\r\n            OR: [\r\n              { estado: EstadoJornada.ACTIVO },\r\n              { estado: EstadoJornada.ALMUERZO },\r\n            ],\r\n            // Considerar ocupado solo si la jornada pertenece a roles que bloquean el punto\r\n            usuario: { rol: { in: [\"OPERADOR\", \"CONCESION\"] } },\r\n          },\r\n          select: { id: true },\r\n        });\r\n\r\n        if (puntoOcupado) {\r\n          res.status(409).json({\r\n            success: false,\r\n            error:\r\n              \"Este punto ya tiene una jornada activa. Selecciona otro punto o espera a que se libere.\",\r\n            timestamp: new Date().toISOString(),\r\n          });\r\n          return;\r\n        }\r\n      }\r\n\r\n      // === Crear o actualizar jornada del usuario ===\r\n      let schedule;\r\n\r\n      if (existingSchedule) {\r\n        // UPDATE estado/fechas de la jornada ya existente del mismo usuario\r\n        const updateData: Prisma.JornadaUpdateInput = {};\r\n\r\n        if (fecha_almuerzo) {\r\n          updateData.fecha_almuerzo = new Date(fecha_almuerzo);\r\n          updateData.estado = EstadoJornada.ALMUERZO;\r\n        }\r\n        if (fecha_regreso) {\r\n          updateData.fecha_regreso = new Date(fecha_regreso);\r\n          updateData.estado = EstadoJornada.ACTIVO;\r\n        }\r\n        if (fecha_salida) {\r\n          // === AJUSTE: exentos cierran jornada sin exigir cierres ===\r\n          console.log(\r\n            `­ƒÜÇ FINALIZACION_JORNADA_INICIADA - Usuario: ${req.user?.rol}, Punto: ${punto_atencion_id}`\r\n          );\r\n          if (!esExentoDeCaja(req.user?.rol)) {\r\n            // Para roles que s├¡ manejan caja, verificar Cierre de Caja (divisas)\r\n            const { gte } = gyeDayRangeUtcFromDate(new Date());\r\n            console.log(\r\n              `­ƒöì BUSCANDO_CIERRE - Punto: ${punto_atencion_id}, Fecha: ${gte.toISOString()}`\r\n            );\r\n            const cierreHoy = await prisma.cuadreCaja.findFirst({\r\n              where: {\r\n                punto_atencion_id,\r\n                fecha: { gte },\r\n                estado: \"CERRADO\",\r\n              },\r\n            });\r\n            console.log(\r\n              `­ƒôè RESULTADO_CIERRE - Encontrado: ${!!cierreHoy}, ID: ${\r\n                cierreHoy?.id || \"N/A\"\r\n              }`\r\n            );\r\n            if (!cierreHoy) {\r\n              console.log(\r\n                `ÔØî ERROR_CIERRE_REQUERIDO - Enviando respuesta de error`\r\n              );\r\n              res.status(400).json({\r\n                success: false,\r\n                error: \"Cierre de caja requerido\",\r\n                details:\r\n                  \"Debe realizar el cierre de caja diario (cuadre de divisas) antes de finalizar su jornada.\",\r\n              });\r\n              return;\r\n            }\r\n\r\n            // NOTA: La validaci├│n de cierre de servicios externos fue eliminada.\r\n            // Los servicios externos ahora se incluyen autom├íticamente en el cierre diario\r\n            // a trav├®s del endpoint /cuadre-caja que consolida todos los movimientos.\r\n          }\r\n          // Finalizar jornada (para exentos y para quienes ya cerraron cierres requeridos)\r\n          updateData.fecha_salida = new Date(fecha_salida);\r\n          updateData.estado = EstadoJornada.COMPLETADO;\r\n          // Al cerrar jornada, limpiar punto del usuario\r\n          await prisma.usuario.update({\r\n            where: { id: usuario_id },\r\n            data: { punto_atencion_id: null },\r\n          });\r\n        }\r\n        if (ubicacion_salida) {\r\n          updateData.ubicacion_salida =\r\n            ubicacion_salida as Prisma.InputJsonValue;\r\n        }\r\n\r\n        schedule = await prisma.jornada.update({\r\n          where: { id: existingSchedule.id },\r\n          data: updateData,\r\n          include: {\r\n            usuario: { select: { id: true, nombre: true, username: true } },\r\n            puntoAtencion: {\r\n              select: {\r\n                id: true,\r\n                nombre: true,\r\n                direccion: true,\r\n                ciudad: true,\r\n                provincia: true,\r\n                codigo_postal: true,\r\n                activo: true,\r\n                created_at: true,\r\n                updated_at: true,\r\n              },\r\n            },\r\n          },\r\n        });\r\n      } else {\r\n        // CREATE nueva jornada\r\n        schedule = await prisma.jornada.create({\r\n          data: {\r\n            usuario_id,\r\n            punto_atencion_id,\r\n            fecha_inicio: fecha_inicio ? new Date(fecha_inicio) : new Date(),\r\n            ubicacion_inicio:\r\n              (ubicacion_inicio ?? null) as Prisma.InputJsonValue | null,\r\n            estado: EstadoJornada.ACTIVO,\r\n          },\r\n          include: {\r\n            usuario: { select: { id: true, nombre: true, username: true } },\r\n            puntoAtencion: {\r\n              select: {\r\n                id: true,\r\n                nombre: true,\r\n                direccion: true,\r\n                ciudad: true,\r\n                provincia: true,\r\n                codigo_postal: true,\r\n                activo: true,\r\n                created_at: true,\r\n                updated_at: true,\r\n              },\r\n            },\r\n          },\r\n        });\r\n      }\r\n\r\n      // Si no es cierre, asociar el punto actual al usuario\r\n      if (!fecha_salida) {\r\n        await prisma.usuario.update({\r\n          where: { id: usuario_id },\r\n          data: { punto_atencion_id },\r\n        });\r\n      }\r\n\r\n      logger.info(\"Jornada procesada\", {\r\n        scheduleId: schedule.id,\r\n        userId: usuario_id,\r\n        action: existingSchedule ? \"updated\" : \"created\",\r\n        requestedBy: req.user?.id,\r\n        role: rol,\r\n        overrideUsed: !!override && esPrivilegiado,\r\n        exentoCaja: esExentoDeCaja(rol),\r\n      });\r\n\r\n      res.status(existingSchedule ? 200 : 201).json({\r\n        schedule: {\r\n          ...schedule,\r\n          fecha_inicio: schedule.fecha_inicio.toISOString(),\r\n          fecha_almuerzo: schedule.fecha_almuerzo?.toISOString() || null,\r\n          fecha_regreso: schedule.fecha_regreso?.toISOString() || null,\r\n          fecha_salida: schedule.fecha_salida?.toISOString() || null,\r\n        },\r\n        success: true,\r\n        timestamp: new Date().toISOString(),\r\n      });\r\n    } catch (error) {\r\n      logger.error(\"Error al procesar jornada\", {\r\n        error: error instanceof Error ? error.message : \"Unknown error\",\r\n        stack: error instanceof Error ? error.stack : undefined,\r\n        requestedBy: req.user?.id,\r\n      });\r\n\r\n      res.status(500).json({\r\n        error: \"Error al procesar jornada\",\r\n        success: false,\r\n        timestamp: new Date().toISOString(),\r\n      });\r\n    }\r\n  }\r\n);\r\n\r\n// ==============================\r\n// GET /schedules/active (jornada activa del usuario autenticado)\r\n// ==============================\r\nrouter.get(\"/active\", authenticateToken, async (req, res) => {\r\n  try {\r\n    const userId = req.user?.id;\r\n\r\n    if (!userId) {\r\n      res.status(401).json({\r\n        error: \"Usuario no autenticado\",\r\n        success: false,\r\n        timestamp: new Date().toISOString(),\r\n      });\r\n      return;\r\n    }\r\n\r\n    const { gte: hoy, lt: manana } = gyeDayRangeUtcFromDate(new Date());\r\n\r\n    const activeSchedule = await prisma.jornada.findFirst({\r\n      where: {\r\n        usuario_id: userId,\r\n        fecha_inicio: { gte: hoy, lt: manana },\r\n        OR: [\r\n          { estado: EstadoJornada.ACTIVO },\r\n          { estado: EstadoJornada.ALMUERZO },\r\n        ],\r\n      },\r\n      include: {\r\n        usuario: { select: { id: true, nombre: true, username: true } },\r\n        puntoAtencion: {\r\n          select: {\r\n            id: true,\r\n            nombre: true,\r\n            direccion: true,\r\n            ciudad: true,\r\n            provincia: true,\r\n            codigo_postal: true,\r\n            activo: true,\r\n            servientrega_agencia_codigo: true,\r\n            servientrega_agencia_nombre: true,\r\n            created_at: true,\r\n            updated_at: true,\r\n          },\r\n        },\r\n      },\r\n    });\r\n\r\n    if (!activeSchedule) {\r\n      res.status(200).json({\r\n        schedule: null,\r\n        success: true,\r\n        timestamp: new Date().toISOString(),\r\n      });\r\n      return;\r\n    }\r\n\r\n    res.status(200).json({\r\n      schedule: {\r\n        ...activeSchedule,\r\n        fecha_inicio: activeSchedule.fecha_inicio.toISOString(),\r\n        fecha_almuerzo: activeSchedule.fecha_almuerzo?.toISOString() || null,\r\n        fecha_regreso: activeSchedule.fecha_regreso?.toISOString() || null,\r\n        fecha_salida: activeSchedule.fecha_salida?.toISOString() || null,\r\n      },\r\n      success: true,\r\n      timestamp: new Date().toISOString(),\r\n    });\r\n  } catch (error) {\r\n    logger.error(\"Error al obtener jornada activa\", {\r\n      error: error instanceof Error ? error.message : \"Unknown error\",\r\n      stack: error instanceof Error ? error.stack : undefined,\r\n      requestedBy: req.user?.id,\r\n    });\r\n\r\n    res.status(500).json({\r\n      error: \"Error al obtener jornada activa\",\r\n      success: false,\r\n      timestamp: new Date().toISOString(),\r\n    });\r\n  }\r\n});\r\n\r\n// ==============================\r\n// GET /schedules/started-today (para admins)\r\n// ==============================\r\nrouter.get(\"/started-today\", authenticateToken, async (req, res) => {\r\n  try {\r\n    if (\r\n      !req.user ||\r\n      ![\"ADMIN\", \"SUPER_USUARIO\", \"ADMINISTRATIVO\"].includes(req.user.rol)\r\n    ) {\r\n      res.status(403).json({ success: false, error: \"Permisos insuficientes\" });\r\n      return;\r\n    }\r\n\r\n    const { gte: today, lt: tomorrow } = gyeDayRangeUtcFromDate(new Date());\r\n\r\n    const schedules = await prisma.jornada.findMany({\r\n      where: {\r\n        fecha_inicio: { gte: today, lt: tomorrow },\r\n        OR: [\r\n          { estado: EstadoJornada.ACTIVO },\r\n          { estado: EstadoJornada.ALMUERZO },\r\n        ],\r\n      },\r\n      include: {\r\n        usuario: { select: { id: true, nombre: true, username: true } },\r\n        puntoAtencion: { select: { id: true, nombre: true } },\r\n      },\r\n      orderBy: { fecha_inicio: \"desc\" },\r\n    });\r\n\r\n    res.json({\r\n      success: true,\r\n      schedules: schedules.map((s) => ({\r\n        ...s,\r\n        fecha_inicio: s.fecha_inicio.toISOString(),\r\n        fecha_almuerzo: s.fecha_almuerzo?.toISOString() || null,\r\n        fecha_regreso: s.fecha_regreso?.toISOString() || null,\r\n        fecha_salida: s.fecha_salida?.toISOString() || null,\r\n      })),\r\n    });\r\n  } catch (e) {\r\n    res.status(500).json({ success: false, error: \"Error interno\" });\r\n  }\r\n});\r\n\r\n// ==============================\r\n// GET /schedules/user/:id (historial de un usuario)\r\n// ==============================\r\nrouter.get(\"/user/:id\", authenticateToken, async (req, res) => {\r\n  try {\r\n    const userId = req.params.id;\r\n    const isSelf = req.user?.id === userId;\r\n    const isAdmin = [\"ADMIN\", \"SUPER_USUARIO\"].includes(req.user?.rol || \"\");\r\n    const isAdminist = req.user?.rol === \"ADMINISTRATIVO\";\r\n\r\n    if (!(isSelf || isAdmin || isAdminist)) {\r\n      res.status(403).json({ success: false, error: \"Permisos insuficientes\" });\r\n      return;\r\n    }\r\n\r\n    const { from, to, estados } = req.query as {\r\n      from?: string;\r\n      to?: string;\r\n      estados?: string;\r\n    };\r\n    const where: Prisma.JornadaWhereInput = { usuario_id: userId };\r\n\r\n    if (from || to) {\r\n      const gte = from ? new Date(from) : undefined;\r\n      let lt: Date | undefined;\r\n      if (to) {\r\n        const d = new Date(to);\r\n        lt = new Date(d);\r\n        lt.setDate(lt.getDate() + 1);\r\n      }\r\n      where.fecha_inicio = {\r\n        ...(gte ? { gte } : {}),\r\n        ...(lt ? { lt } : {}),\r\n      } as Prisma.DateTimeFilter;\r\n    }\r\n\r\n    if (estados) {\r\n      const list = estados\r\n        .split(\",\")\r\n        .map((s) => s.trim())\r\n        .filter(Boolean);\r\n      const valid = list.filter((e): e is EstadoJornada =>\r\n        Object.values(EstadoJornada).includes(e as EstadoJornada)\r\n      );\r\n      if (valid.length) where.estado = { in: valid };\r\n    }\r\n\r\n    const schedules = await prisma.jornada.findMany({\r\n      where,\r\n      include: {\r\n        usuario: { select: { id: true, nombre: true, username: true } },\r\n        puntoAtencion: { select: { id: true, nombre: true } },\r\n      },\r\n      orderBy: { fecha_inicio: \"desc\" },\r\n    });\r\n\r\n    res.json({\r\n      success: true,\r\n      schedules: schedules.map((s) => ({\r\n        ...s,\r\n        fecha_inicio: s.fecha_inicio.toISOString(),\r\n        fecha_almuerzo: s.fecha_almuerzo?.toISOString() || null,\r\n        fecha_regreso: s.fecha_regreso?.toISOString() || null,\r\n        fecha_salida: s.fecha_salida?.toISOString() || null,\r\n      })),\r\n    });\r\n  } catch (e) {\r\n    res.status(500).json({ success: false, error: \"Error interno\" });\r\n  }\r\n});\r\n\r\n// =============================================\r\n// POST /schedules/reassign-point (solo ADMIN/SUPER_USUARIO)\r\n// Reasigna la jornada ACTIVA/ALMUERZO de hoy de un usuario a otro punto\r\n// para liberar el punto originalmente ocupado por error.\r\n// - Si no se env├¡a destino_punto_atencion_id, se usa el punto principal.\r\n// - Registra historial y marca motivo/autoridad en la jornada.\r\n// =============================================\r\nconst reassignSchema = z.object({\r\n  usuario_id: z.string().uuid(),\r\n  destino_punto_atencion_id: z.string().uuid().optional(),\r\n  motivo: z.string().max(200).optional(),\r\n  observaciones: z.string().max(500).optional(),\r\n  finalizar: z.boolean().optional(), // si true: cierra/cancela la jornada y limpia punto del usuario\r\n});\r\n\r\nrouter.post(\r\n  \"/reassign-point\",\r\n  authenticateToken,\r\n  validate(reassignSchema),\r\n  async (req, res) => {\r\n    try {\r\n      if (\r\n        !req.user ||\r\n        ![\"ADMIN\", \"SUPER_USUARIO\", \"ADMINISTRATIVO\"].includes(req.user.rol)\r\n      ) {\r\n        res\r\n          .status(403)\r\n          .json({ success: false, error: \"Permisos insuficientes\" });\r\n        return;\r\n      }\r\n\r\n      const adminId = req.user.id;\r\n      const {\r\n        usuario_id,\r\n        destino_punto_atencion_id,\r\n        motivo,\r\n        observaciones,\r\n        finalizar,\r\n      } = req.body as {\r\n        usuario_id: string;\r\n        destino_punto_atencion_id?: string;\r\n        motivo?: string;\r\n        observaciones?: string;\r\n        finalizar?: boolean;\r\n      };\r\n\r\n      // Buscar jornada ACTIVA/ALMUERZO de HOY del usuario\r\n      const { gte: hoyGte, lt: hoyLt } = gyeDayRangeUtcFromDate(new Date());\r\n      const schedule = await prisma.jornada.findFirst({\r\n        where: {\r\n          usuario_id,\r\n          fecha_inicio: { gte: hoyGte, lt: hoyLt },\r\n          OR: [\r\n            { estado: EstadoJornada.ACTIVO },\r\n            { estado: EstadoJornada.ALMUERZO },\r\n          ],\r\n        },\r\n      });\r\n\r\n      if (!schedule) {\r\n        res.status(404).json({\r\n          success: false,\r\n          error: \"No se encontr├│ jornada activa de hoy para el usuario\",\r\n        });\r\n        return;\r\n      }\r\n\r\n      // Determinar punto destino\r\n      let newPointId = destino_punto_atencion_id || null;\r\n      if (!newPointId) {\r\n        const principal = await prisma.puntoAtencion.findFirst({\r\n          where: { es_principal: true },\r\n          select: { id: true },\r\n        });\r\n        if (!principal) {\r\n          res.status(400).json({\r\n            success: false,\r\n            error:\r\n              \"No se encontr├│ punto principal. Especifique destino_punto_atencion_id\",\r\n          });\r\n          return;\r\n        }\r\n        newPointId = principal.id;\r\n      } else {\r\n        const exists = await prisma.puntoAtencion.findUnique({\r\n          where: { id: newPointId },\r\n          select: { id: true },\r\n        });\r\n        if (!exists) {\r\n          res\r\n            .status(404)\r\n            .json({ success: false, error: \"Punto destino no existe\" });\r\n          return;\r\n        }\r\n      }\r\n\r\n      if (newPointId === schedule.punto_atencion_id) {\r\n        res.status(400).json({\r\n          success: false,\r\n          error: \"La jornada ya est├í asignada a ese punto\",\r\n        });\r\n        return;\r\n      }\r\n\r\n      if (!finalizar && !newPointId) {\r\n        res.status(400).json({\r\n          success: false,\r\n          error: \"Debe indicar destino_punto_atencion_id para reasignar\",\r\n        });\r\n        return;\r\n      }\r\n\r\n      // Transacci├│n: actualizar jornada y usuario + historial\r\n      const updatedSchedule = await prisma.$transaction(async (tx) => {\r\n        // Historial de asignaci├│n\r\n        await tx.historialAsignacionPunto.create({\r\n          data: {\r\n            usuario_id,\r\n            punto_atencion_anterior_id: schedule.punto_atencion_id,\r\n            punto_atencion_nuevo_id: finalizar\r\n              ? schedule.punto_atencion_id\r\n              : newPointId,\r\n            motivo_cambio:\r\n              motivo ||\r\n              (finalizar ? \"CANCELACION_ADMIN\" : \"REASIGNACION_ADMIN\"),\r\n            autorizado_por: adminId,\r\n            tipo_asignacion: \"MANUAL\",\r\n            observaciones: observaciones || null,\r\n          },\r\n        });\r\n\r\n        // Actualizar jornada del d├¡a\r\n        const j = await tx.jornada.update({\r\n          where: { id: schedule.id },\r\n          data: finalizar\r\n            ? {\r\n                // Cancelar/cerrar la jornada equivocada y dejar libre el punto (usuario sin punto)\r\n                fecha_salida: new Date(),\r\n                estado: EstadoJornada.CANCELADO,\r\n                motivo_cambio: motivo || \"CANCELACION_ADMIN\",\r\n                usuario_autorizo: adminId,\r\n              }\r\n            : {\r\n                // Reasignaci├│n a otro punto\r\n                punto_atencion_id: newPointId,\r\n                motivo_cambio: motivo || \"REASIGNACION_ADMIN\",\r\n                usuario_autorizo: adminId,\r\n              },\r\n          include: {\r\n            usuario: { select: { id: true, nombre: true, username: true } },\r\n            puntoAtencion: { select: { id: true, nombre: true } },\r\n          },\r\n        });\r\n\r\n        // Reflejar asignaci├│n actual del usuario\r\n        await tx.usuario.update({\r\n          where: { id: usuario_id },\r\n          data: finalizar\r\n            ? { punto_atencion_id: null }\r\n            : { punto_atencion_id: newPointId },\r\n        });\r\n\r\n        return j;\r\n      });\r\n\r\n      logger.info(\"Jornada reasignada por admin\", {\r\n        scheduleId: schedule.id,\r\n        usuarioId: usuario_id,\r\n        fromPoint: schedule.punto_atencion_id,\r\n        toPoint: newPointId,\r\n        autorizadoPor: adminId,\r\n      });\r\n\r\n      res.status(200).json({\r\n        success: true,\r\n        schedule: {\r\n          ...updatedSchedule,\r\n          fecha_inicio: updatedSchedule.fecha_inicio.toISOString(),\r\n          fecha_almuerzo: updatedSchedule.fecha_almuerzo?.toISOString() || null,\r\n          fecha_regreso: updatedSchedule.fecha_regreso?.toISOString() || null,\r\n          fecha_salida: updatedSchedule.fecha_salida?.toISOString() || null,\r\n        },\r\n        timestamp: new Date().toISOString(),\r\n      });\r\n    } catch (e) {\r\n      logger.error(\"Error en reasignaci├│n de jornada\", {\r\n        error: e instanceof Error ? e.message : String(e),\r\n        stack: e instanceof Error ? e.stack : undefined,\r\n        requestedBy: req.user?.id,\r\n      });\r\n      res.status(500).json({ success: false, error: \"Error interno\" });\r\n    }\r\n  }\r\n);\r\n\r\nexport default router;\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\oswal\\OneDrive\\Documentos\\Punto Cambio\\punto_cambio_new\\server\\routes\\servicios-externos.ts","messages":[{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'e' is defined but never used.","line":241,"column":14,"nodeType":null,"messageId":"unusedVar","endLine":241,"endColumn":15},{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'error' is defined but never used.","line":691,"column":14,"nodeType":null,"messageId":"unusedVar","endLine":691,"endColumn":19},{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'req' is defined but never used. Allowed unused args must match /^_/u.","line":864,"column":101,"nodeType":null,"messageId":"unusedVar","endLine":864,"endColumn":104},{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'res' is defined but never used. Allowed unused args must match /^_/u.","line":864,"column":106,"nodeType":null,"messageId":"unusedVar","endLine":864,"endColumn":109},{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'req' is defined but never used. Allowed unused args must match /^_/u.","line":869,"column":56,"nodeType":null,"messageId":"unusedVar","endLine":869,"endColumn":59},{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'res' is defined but never used. Allowed unused args must match /^_/u.","line":869,"column":61,"nodeType":null,"messageId":"unusedVar","endLine":869,"endColumn":64}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":6,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import express, { Request, Response, NextFunction } from \"express\";\nimport { authenticateToken, requireRole } from \"../middleware/auth.js\";\nimport prisma from \"../lib/prisma.js\";\nimport {\n  Prisma,\n  ServicioExterno,\n  TipoMovimiento as PrismaTipoMovimiento,\n  TipoViaTransferencia,\n  TipoAsignacionServicio,\n} from \"@prisma/client\";\nimport {\n  registrarMovimientoSaldo,\n  TipoMovimiento as TipoMov,\n  TipoReferencia,\n} from \"../services/movimientoSaldoService.js\";\n\nconst router = express.Router();\n\n/** === Tipos auxiliares TS === */\ntype RolUsuario =\n  | \"OPERADOR\"\n  | \"ADMIN\"\n  | \"SUPER_USUARIO\"\n  | \"ADMINISTRATIVO\"\n  | \"CONCESION\";\ninterface AuthenticatedUser {\n  id: string;\n  username: string;\n  nombre: string;\n  rol: RolUsuario;\n  activo: boolean;\n  punto_atencion_id: string | null;\n}\ntype AuthedRequest = Request & { user: AuthenticatedUser };\n\n/** Type guard: asegura que req.user existe y es OPERADOR */\nfunction isOperador(\n  req: Request\n): req is AuthedRequest & { user: AuthenticatedUser & { rol: \"OPERADOR\" } } {\n  const user = (req as Partial<AuthedRequest>).user;\n  return !!user && user.rol === \"OPERADOR\";\n}\n\nfunction isServicioExterno(v: unknown): v is ServicioExterno {\n  return (\n    typeof v === \"string\" &&\n    Object.values(ServicioExterno).includes(v as ServicioExterno)\n  );\n}\n\nfunction isTipoMovimientoInOut(\n  v: unknown\n): v is PrismaTipoMovimiento.INGRESO | PrismaTipoMovimiento.EGRESO {\n  return v === PrismaTipoMovimiento.INGRESO || v === PrismaTipoMovimiento.EGRESO;\n}\n\nfunction parseMetodoIngreso(v: unknown):\n  | TipoViaTransferencia.EFECTIVO\n  | TipoViaTransferencia.BANCO\n  | TipoViaTransferencia.MIXTO {\n  const raw = typeof v === \"string\" ? v.trim().toUpperCase() : \"\";\n  if (raw === \"BANCO\") return TipoViaTransferencia.BANCO;\n  if (raw === \"MIXTO\") return TipoViaTransferencia.MIXTO;\n  return TipoViaTransferencia.EFECTIVO;\n}\n\n/** Cat├ílogos v├ílidos (coinciden con Prisma enums) */\nconst SERVICIOS_VALIDOS: ServicioExterno[] = [\n  ServicioExterno.YAGANASTE,\n  ServicioExterno.BANCO_GUAYAQUIL,\n  ServicioExterno.WESTERN,\n  ServicioExterno.PRODUBANCO,\n  ServicioExterno.BANCO_PACIFICO,\n  ServicioExterno.SERVIENTREGA,\n  ServicioExterno.INSUMOS_OFICINA,\n  ServicioExterno.INSUMOS_LIMPIEZA,\n  ServicioExterno.OTROS,\n];\n\n// Servicios que tienen asignaci├│n de saldo propio (cr├®dito digital)\nconst SERVICIOS_CON_ASIGNACION: ServicioExterno[] = [\n  ServicioExterno.YAGANASTE,\n  ServicioExterno.BANCO_GUAYAQUIL,\n  ServicioExterno.WESTERN,\n  ServicioExterno.PRODUBANCO,\n  ServicioExterno.BANCO_PACIFICO,\n  ServicioExterno.SERVIENTREGA,\n];\n\n// Servicios que usan saldo general/efectivo (no tienen asignaci├│n)\nconst SERVICIOS_SALDO_GENERAL: ServicioExterno[] = [\n  ServicioExterno.INSUMOS_OFICINA,\n  ServicioExterno.INSUMOS_LIMPIEZA,\n  ServicioExterno.OTROS,\n];\n\nconst TIPOS_VALIDOS: Array<PrismaTipoMovimiento.INGRESO | PrismaTipoMovimiento.EGRESO> = [\n  PrismaTipoMovimiento.INGRESO,\n  PrismaTipoMovimiento.EGRESO,\n];\n\n/** Utils fecha GYE */\nasync function gyeTodayWindow() {\n  const { gyeDayRangeUtcFromDate } = await import(\"../utils/timezone.js\");\n  return gyeDayRangeUtcFromDate(new Date()); // { gte, lt }\n}\n\n/** Asegura que exista USD y devuelve su id (usa unique por codigo) */\nasync function ensureUsdMonedaId(): Promise<string> {\n  const existing = await prisma.moneda.findUnique({\n    where: { codigo: \"USD\" },\n    select: { id: true },\n  });\n  if (existing?.id) return existing.id;\n\n  const created = await prisma.moneda.create({\n    data: {\n      nombre: \"D├│lar estadounidense\",\n      simbolo: \"$\",\n      codigo: \"USD\",\n      activo: true,\n      orden_display: 0,\n      comportamiento_compra: \"MULTIPLICA\",\n      comportamiento_venta: \"DIVIDE\",\n    },\n    select: { id: true },\n  });\n  return created.id;\n}\n\n/* ==============================\n * Middleware personalizado para validar saldo en servicios externos\n * - Servicios con asignaci├│n (YaGanaste, Bancos, Western): validan su saldo asignado para INGRESO\n * - Servicios de saldo general (Insumos, Otros): validan saldo general para EGRESO\n * ============================== */\nasync function validarSaldoServicioExterno(\n  req: Request,\n  res: Response,\n  next: NextFunction\n) {\n  const body = (req.body ?? {}) as Record<string, unknown>;\n  const servicio = body.servicio;\n  const tipo_movimiento = body.tipo_movimiento;\n  const monto = body.monto;\n  const billetes = body.billetes;\n  const monedas_fisicas = body.monedas_fisicas;\n  const metodo_ingreso = body.metodo_ingreso;\n  \n  // Servicios con asignaci├│n: INGRESO necesita validar su propio saldo\n  if (\n    isServicioExterno(servicio) &&\n    SERVICIOS_CON_ASIGNACION.includes(servicio) &&\n    tipo_movimiento === PrismaTipoMovimiento.INGRESO\n  ) {\n    // La validaci├│n del saldo asignado se hace en la transacci├│n principal\n    return next();\n  }\n  \n  // Servicios de saldo general: INGRESO no requiere validaci├│n (cliente trae dinero)\n  if (\n    isServicioExterno(servicio) &&\n    SERVICIOS_SALDO_GENERAL.includes(servicio) &&\n    tipo_movimiento === PrismaTipoMovimiento.INGRESO\n  ) {\n    return next();\n  }\n  \n  // EGRESO siempre necesita validar saldo general (sale dinero del punto)\n  // Pero debe validarse por bucket (CAJA vs BANCOS) seg├║n metodo_ingreso.\n  if (tipo_movimiento === PrismaTipoMovimiento.EGRESO) {\n    try {\n      const montoNum = typeof monto === \"string\" ? parseFloat(monto) : Number(monto);\n      if (!isFinite(montoNum) || montoNum <= 0) {\n        res.status(400).json({ success: false, message: \"monto debe ser un n├║mero > 0\" });\n        return;\n      }\n\n      const metodoIngreso = parseMetodoIngreso(metodo_ingreso);\n      const billetesMonto =\n        typeof billetes === \"number\" && !isNaN(billetes) ? billetes : 0;\n      const monedasMonto =\n        typeof monedas_fisicas === \"number\" && !isNaN(monedas_fisicas)\n          ? monedas_fisicas\n          : 0;\n\n      let montoCaja = 0;\n      let montoBancos = 0;\n      if (metodoIngreso === TipoViaTransferencia.EFECTIVO) {\n        montoCaja = montoNum;\n      } else if (metodoIngreso === TipoViaTransferencia.BANCO) {\n        montoBancos = montoNum;\n      } else if (metodoIngreso === TipoViaTransferencia.MIXTO) {\n        montoCaja = Math.min(montoNum, Math.max(0, billetesMonto + monedasMonto));\n        montoBancos = Math.max(0, montoNum - montoCaja);\n      }\n\n      const usdId = await ensureUsdMonedaId();\n      const puntoId = (req as Partial<AuthedRequest>).user?.punto_atencion_id;\n      if (!puntoId) {\n        res.status(400).json({\n          success: false,\n          message:\n            \"Debes iniciar una jornada y tener un punto de atenci├│n asignado para registrar movimientos.\",\n        });\n        return;\n      }\n\n      const saldo = await prisma.saldo.findUnique({\n        where: {\n          punto_atencion_id_moneda_id: {\n            punto_atencion_id: puntoId,\n            moneda_id: usdId,\n          },\n        },\n        select: { cantidad: true, bancos: true },\n      });\n\n      const saldoCaja = Number(saldo?.cantidad || 0);\n      const saldoBancos = Number(saldo?.bancos || 0);\n\n      if (saldoCaja + 0.01 < montoCaja) {\n        res.status(400).json({\n          success: false,\n          message: `Saldo insuficiente en CAJA. Saldo: $${saldoCaja.toFixed(\n            2\n          )}, requerido: $${montoCaja.toFixed(2)}`,\n        });\n        return;\n      }\n      if (saldoBancos + 0.01 < montoBancos) {\n        res.status(400).json({\n          success: false,\n          message: `Saldo insuficiente en BANCOS. Saldo: $${saldoBancos.toFixed(\n            2\n          )}, requerido: $${montoBancos.toFixed(2)}`,\n        });\n        return;\n      }\n\n      return next();\n    } catch (e) {\n      res.status(500).json({ success: false, message: \"Error validando saldo\" });\n      return;\n    }\n  }\n  \n  return next();\n}\n\n/* ==============================\n * POST /servicios-externos/movimientos  (OPERADOR)\n * ============================== */\nrouter.post(\n  \"/movimientos\",\n  authenticateToken,\n  validarSaldoServicioExterno,\n  async (req: Request, res: Response) => {\n    try {\n      if (!isOperador(req)) {\n        res.status(403).json({\n          success: false,\n          message: \"Permisos insuficientes (solo OPERADOR)\",\n        });\n        return;\n      }\n\n      const body = (req.body ?? {}) as Record<string, unknown>;\n      const servicio = body.servicio;\n      const tipo_movimiento = body.tipo_movimiento;\n      const monto = body.monto;\n      const descripcion = body.descripcion;\n      const numero_referencia = body.numero_referencia;\n      const comprobante_url = body.comprobante_url;\n      const billetes = body.billetes;\n      const monedas_fisicas = body.monedas_fisicas;\n      const metodo_ingreso = body.metodo_ingreso;\n\n      const puntoId = req.user.punto_atencion_id;\n\n      if (!puntoId) {\n        res.status(400).json({\n          success: false,\n          message:\n            \"Debes iniciar una jornada y tener un punto de atenci├│n asignado para registrar movimientos.\",\n        });\n        return;\n      }\n      if (!isServicioExterno(servicio) || !SERVICIOS_VALIDOS.includes(servicio)) {\n        res.status(400).json({ success: false, message: \"servicio inv├ílido\" });\n        return;\n      }\n      if (!isTipoMovimientoInOut(tipo_movimiento) || !TIPOS_VALIDOS.includes(tipo_movimiento)) {\n        res\n          .status(400)\n          .json({ success: false, message: \"tipo_movimiento inv├ílido\" });\n        return;\n      }\n\n      // Validar metodo_ingreso (EFECTIVO, BANCO, MIXTO)\n      const metodoIngreso = parseMetodoIngreso(metodo_ingreso);\n\n      const montoNum = typeof monto === \"string\" ? parseFloat(monto) : Number(monto);\n      if (!isFinite(montoNum) || montoNum <= 0) {\n        res\n          .status(400)\n          .json({ success: false, message: \"monto debe ser un n├║mero > 0\" });\n        return;\n      }\n\n      const usdId = await ensureUsdMonedaId();\n\n      const movimiento = await prisma.$transaction(async (tx) => {\n        // Separar servicios con asignaci├│n vs saldo general\n        let saldoServicioAnterior: number | null = null;\n        let saldoServicioNuevo: number | null = null;\n        \n        const tieneAsignacion = SERVICIOS_CON_ASIGNACION.includes(servicio);\n\n        if (tieneAsignacion) {\n          // Obtener saldo del servicio externo espec├¡fico\n          const saldoServicio = await tx.servicioExternoSaldo.findUnique({\n            where: {\n              punto_atencion_id_servicio_moneda_id: {\n                punto_atencion_id: puntoId,\n                  servicio,\n                moneda_id: usdId,\n              },\n            },\n          });\n\n          saldoServicioAnterior = Number(saldoServicio?.cantidad || 0);\n          \n          // NUEVA L├ôGICA CORRECTA:\n          // INGRESO (Cliente paga servicio) -> RESTA del saldo asignado (se usa el cr├®dito)\n          // EGRESO (Operador repone dinero) -> SUMA al saldo asignado (se repone el cr├®dito)\n          const deltaDigital =\n            tipo_movimiento === PrismaTipoMovimiento.INGRESO ? -montoNum : montoNum;\n          saldoServicioNuevo = saldoServicioAnterior + deltaDigital;\n\n          // Validar saldo suficiente del SERVICIO para INGRESOS (usa cr├®dito)\n          if (\n            tipo_movimiento === PrismaTipoMovimiento.INGRESO &&\n            saldoServicioNuevo < 0\n          ) {\n            throw new Error(\n              `Saldo insuficiente en el servicio ${servicio}. Saldo actual: $${saldoServicioAnterior.toFixed(\n                2\n              )}, Monto requerido: $${montoNum.toFixed(2)}`\n            );\n          }\n\n          const billetesMonto =\n            typeof billetes === \"number\" && !isNaN(billetes) ? billetes : 0;\n          const monedasMonto =\n            typeof monedas_fisicas === \"number\" && !isNaN(monedas_fisicas)\n              ? monedas_fisicas\n              : 0;\n          \n          let bancosMonto = 0;\n          if (metodoIngreso === TipoViaTransferencia.BANCO) {\n            bancosMonto = montoNum;\n          } else if (metodoIngreso === TipoViaTransferencia.MIXTO) {\n            bancosMonto = Math.max(0, montoNum - (billetesMonto + monedasMonto));\n          }\n\n          // INGRESO resta (usa cr├®dito), EGRESO suma (repone cr├®dito)\n          const dBil =\n            tipo_movimiento === PrismaTipoMovimiento.INGRESO\n              ? -billetesMonto\n              : billetesMonto;\n          const dMon =\n            tipo_movimiento === PrismaTipoMovimiento.INGRESO\n              ? -monedasMonto\n              : monedasMonto;\n          const dBk =\n            tipo_movimiento === PrismaTipoMovimiento.INGRESO\n              ? -bancosMonto\n              : bancosMonto;\n\n          if (saldoServicio) {\n            await tx.servicioExternoSaldo.update({\n              where: { id: saldoServicio.id },\n              data: {\n                cantidad: { increment: deltaDigital },\n                billetes: { increment: dBil },\n                monedas_fisicas: { increment: dMon },\n                bancos: { increment: dBk },\n                updated_at: new Date(),\n              },\n            });\n          } else {\n            await tx.servicioExternoSaldo.create({\n              data: {\n                punto_atencion_id: puntoId,\n                servicio,\n                moneda_id: usdId,\n                cantidad: deltaDigital,\n                billetes: dBil,\n                monedas_fisicas: dMon,\n                bancos: dBk,\n                updated_at: new Date(),\n              },\n            });\n          }\n        }\n\n        // SALDO F├ìSICO GENERAL DEL PUNTO (efectivo de cambio de divisas)\n        const saldoGeneral = await tx.saldo.findUnique({\n          where: {\n            punto_atencion_id_moneda_id: {\n              punto_atencion_id: puntoId,\n              moneda_id: usdId,\n            },\n          },\n        });\n\n        const saldoGeneralAnterior = Number(saldoGeneral?.cantidad || 0);\n        const saldoBancosAnterior = Number(saldoGeneral?.bancos || 0);\n        const billetesMonto =\n          typeof billetes === \"number\" && !isNaN(billetes) ? billetes : 0;\n        const monedasMonto =\n          typeof monedas_fisicas === \"number\" && !isNaN(monedas_fisicas)\n            ? monedas_fisicas\n            : 0;\n\n        // Separar el movimiento f├¡sico en CAJA vs BANCOS (no mezclar en `Saldo.cantidad`)\n        let montoCaja = 0;\n        let bancosMonto = 0;\n        if (metodoIngreso === TipoViaTransferencia.EFECTIVO) {\n          montoCaja = montoNum;\n        } else if (metodoIngreso === TipoViaTransferencia.BANCO) {\n          bancosMonto = montoNum;\n        } else if (metodoIngreso === TipoViaTransferencia.MIXTO) {\n          montoCaja = Math.min(montoNum, Math.max(0, billetesMonto + monedasMonto));\n          bancosMonto = Math.max(0, montoNum - montoCaja);\n        }\n\n        // Validaciones b├ísicas de coherencia\n        if (metodoIngreso === TipoViaTransferencia.EFECTIVO) {\n          const efectivoDetallado = billetesMonto + monedasMonto;\n          if (efectivoDetallado > 0 && Math.abs(efectivoDetallado - montoNum) > 0.01) {\n            throw new Error(\n              `Detalle de efectivo inconsistente: billetes+monedas ($${efectivoDetallado.toFixed(\n                2\n              )}) debe igualar monto ($${montoNum.toFixed(2)}) en EFECTIVO.`\n            );\n          }\n        }\n        if (metodoIngreso === TipoViaTransferencia.MIXTO) {\n          const efectivoDetallado = billetesMonto + monedasMonto;\n          if (efectivoDetallado - montoNum > 0.01) {\n            throw new Error(\n              `Detalle MIXTO inconsistente: billetes+monedas ($${efectivoDetallado.toFixed(\n                2\n              )}) no puede exceder monto ($${montoNum.toFixed(2)}).`\n            );\n          }\n        }\n\n        const sign = tipo_movimiento === PrismaTipoMovimiento.INGRESO ? 1 : -1;\n        const deltaCaja = sign * montoCaja;\n        const deltaBancos = sign * bancosMonto;\n        const nuevoSaldoCaja = saldoGeneralAnterior + deltaCaja;\n        const nuevoSaldoBancos = saldoBancosAnterior + deltaBancos;\n\n        if (nuevoSaldoCaja < -0.01) {\n          throw new Error(\n            `Saldo insuficiente en CAJA. Saldo actual: $${saldoGeneralAnterior.toFixed(\n              2\n            )}, requerido: $${Math.abs(deltaCaja).toFixed(2)}`\n          );\n        }\n        if (nuevoSaldoBancos < -0.01) {\n          throw new Error(\n            `Saldo insuficiente en BANCOS. Saldo actual: $${saldoBancosAnterior.toFixed(\n              2\n            )}, requerido: $${Math.abs(deltaBancos).toFixed(2)}`\n          );\n        }\n\n        if (saldoGeneral) {\n          let dBil = 0;\n          let dMon = 0;\n          let dBk = 0;\n\n          if (metodoIngreso === \"EFECTIVO\") {\n            dBil =\n              tipo_movimiento === PrismaTipoMovimiento.INGRESO\n                ? billetesMonto\n                : -billetesMonto;\n            dMon =\n              tipo_movimiento === PrismaTipoMovimiento.INGRESO\n                ? monedasMonto\n                : -monedasMonto;\n          } else if (metodoIngreso === \"BANCO\") {\n            dBk =\n              tipo_movimiento === PrismaTipoMovimiento.INGRESO\n                ? montoNum\n                : -montoNum;\n          } else if (metodoIngreso === \"MIXTO\") {\n            dBil =\n              tipo_movimiento === PrismaTipoMovimiento.INGRESO\n                ? billetesMonto\n                : -billetesMonto;\n            dMon =\n              tipo_movimiento === PrismaTipoMovimiento.INGRESO\n                ? monedasMonto\n                : -monedasMonto;\n            const bM = Math.max(0, montoNum - (billetesMonto + monedasMonto));\n            dBk =\n              tipo_movimiento === PrismaTipoMovimiento.INGRESO ? bM : -bM;\n          }\n\n          await tx.saldo.update({\n            where: { id: saldoGeneral.id },\n            data: {\n              cantidad: nuevoSaldoCaja,\n              billetes: { increment: dBil },\n              monedas_fisicas: { increment: dMon },\n              bancos: { increment: dBk },\n              updated_at: new Date(),\n            },\n          });\n        } else {\n          // Crear saldo general si no existe\n          const initialBil = tipo_movimiento === \"INGRESO\" ? billetesMonto : -billetesMonto;\n          const initialMon = tipo_movimiento === \"INGRESO\" ? monedasMonto : -monedasMonto;\n          const initialBk = tipo_movimiento === \"INGRESO\" ? bancosMonto : -bancosMonto;\n\n          await tx.saldo.create({\n            data: {\n              punto_atencion_id: puntoId,\n              moneda_id: usdId,\n              cantidad: initialBil + initialMon,\n              billetes: initialBil,\n              monedas_fisicas: initialMon,\n              bancos: initialBk,\n              updated_at: new Date(),\n            },\n          });\n        }\n\n        // Registro del movimiento\n        const svcMov = await tx.servicioExternoMovimiento.create({\n          data: {\n            punto_atencion_id: puntoId,\n            servicio,\n            tipo_movimiento,\n            moneda_id: usdId,\n            monto: montoNum,\n            usuario_id: req.user.id,\n            fecha: new Date(),\n            descripcion: typeof descripcion === \"string\" ? descripcion : null,\n            numero_referencia:\n              typeof numero_referencia === \"string\" ? numero_referencia : null,\n            comprobante_url:\n              typeof comprobante_url === \"string\" ? comprobante_url : null,\n            billetes: billetes !== undefined ? Number(billetes) : undefined,\n            monedas_fisicas: monedas_fisicas !== undefined ? Number(monedas_fisicas) : undefined,\n            bancos: bancosMonto,\n            metodo_ingreso: metodoIngreso,\n          },\n        });\n\n        // Trazabilidad en MovimientoSaldo (separando CAJA vs BANCOS)\n        const tipoMovSaldo =\n          tipo_movimiento === PrismaTipoMovimiento.INGRESO\n            ? TipoMov.INGRESO\n            : TipoMov.EGRESO;\n\n        if (montoCaja > 0) {\n          await registrarMovimientoSaldo(\n            {\n              puntoAtencionId: puntoId,\n              monedaId: usdId,\n              tipoMovimiento: tipoMovSaldo,\n              monto: montoCaja,\n              saldoAnterior: saldoGeneralAnterior,\n              saldoNuevo: nuevoSaldoCaja,\n              tipoReferencia: TipoReferencia.SERVICIO_EXTERNO,\n              referenciaId: svcMov.id,\n              saldoBucket: \"CAJA\",\n              descripcion: `${servicio} - ${descripcion || tipo_movimiento} (CAJA)` ,\n              usuarioId: req.user.id,\n            },\n            tx\n          );\n        }\n\n        if (bancosMonto > 0) {\n          await registrarMovimientoSaldo(\n            {\n              puntoAtencionId: puntoId,\n              monedaId: usdId,\n              tipoMovimiento: tipoMovSaldo,\n              monto: bancosMonto,\n              saldoAnterior: saldoBancosAnterior,\n              saldoNuevo: nuevoSaldoBancos,\n              tipoReferencia: TipoReferencia.SERVICIO_EXTERNO,\n              referenciaId: svcMov.id,\n              saldoBucket: \"BANCOS\",\n              descripcion: `${servicio} - ${descripcion || tipo_movimiento} (BANCOS)` ,\n              usuarioId: req.user.id,\n            },\n            tx\n          );\n        }\n\n        return {\n          ...svcMov,\n          monto: Number(svcMov.monto),\n          ...(tieneAsignacion && {\n            saldo_anterior: saldoServicioAnterior,\n            saldo_nuevo: saldoServicioNuevo,\n          }),\n        };\n      });\n\n      res.status(201).json({ success: true, movimiento });\n    } catch (error) {\n      console.error(\"Error creando movimiento de servicios externos:\", error);\n      res.status(500).json({\n        success: false,\n        message: error instanceof Error ? error.message : \"Error desconocido\",\n      });\n    }\n  }\n);\n\n/* ==============================\n * GET /movimientos/:pointId  (OPERADOR ÔÇö solo su punto)\n * ============================== */\nrouter.get(\n  \"/movimientos/:pointId\",\n  authenticateToken,\n  async (req: Request, res: Response) => {\n    try {\n      if (!isOperador(req)) {\n        res.status(403).json({\n          success: false,\n          message: \"Permisos insuficientes (solo OPERADOR)\",\n        });\n        return;\n      }\n\n      const puntoAsignado = req.user.punto_atencion_id;\n      const { pointId } = req.params;\n      if (pointId !== puntoAsignado) {\n        res.status(403).json({\n          success: false,\n          message: \"Solo puedes consultar movimientos del punto asignado.\",\n        });\n        return;\n      }\n\n      const { servicio, tipo_movimiento, desde, hasta, limit } = req.query as {\n        servicio?: string;\n        tipo_movimiento?: string;\n        desde?: string;\n        hasta?: string;\n        limit?: string;\n      };\n      const take = Math.min(Math.max(parseInt(limit || \"100\", 10), 1), 500);\n\n      const where: Prisma.ServicioExternoMovimientoWhereInput = {\n        punto_atencion_id: pointId,\n      };\n      if (isServicioExterno(servicio) && SERVICIOS_VALIDOS.includes(servicio))\n        where.servicio = servicio;\n      if (isTipoMovimientoInOut(tipo_movimiento) && TIPOS_VALIDOS.includes(tipo_movimiento))\n        where.tipo_movimiento = tipo_movimiento;\n      if (desde || hasta) {\n        where.fecha = {\n          gte: desde ? new Date(`${desde}T00:00:00.000Z`) : undefined,\n          lte: hasta ? new Date(`${hasta}T23:59:59.999Z`) : undefined,\n        };\n      }\n\n      const rows = await prisma.servicioExternoMovimiento.findMany({\n        where,\n        orderBy: { fecha: \"desc\" },\n        take,\n        include: {\n          usuario: { select: { id: true, nombre: true } },\n          moneda: { select: { id: true, nombre: true, codigo: true, simbolo: true } },\n          puntoAtencion: { select: { id: true, nombre: true } },\n        },\n      });\n\n      res.json({ success: true, movimientos: rows });\n    } catch (error) {\n      res.status(500).json({ success: false, message: \"Error listando movimientos\" });\n    }\n  }\n);\n\n/* ==============================\n * DELETE /movimientos/:id  (ADMIN/SUPER_USUARIO)\n * Reversa saldos digital y f├¡sico\n * ============================== */\nrouter.delete(\n  \"/movimientos/:id\",\n  authenticateToken,\n  requireRole([\"ADMIN\", \"SUPER_USUARIO\"]),\n  async (req: Request, res: Response) => {\n    try {\n      const { id } = req.params;\n\n      const userId = (req as Partial<AuthedRequest>).user?.id;\n      if (!userId) {\n        res.status(401).json({ success: false, error: \"No autorizado\" });\n        return;\n      }\n\n      await prisma.$transaction(async (tx) => {\n        const mov = await tx.servicioExternoMovimiento.findUnique({\n          where: { id },\n        });\n        if (!mov) throw new Error(\"Movimiento no encontrado\");\n\n        const { gte, lt } = await gyeTodayWindow();\n        if (!(mov.fecha >= gte && mov.fecha < lt)) {\n          throw new Error(\"Solo se pueden eliminar movimientos del d├¡a actual\");\n        }\n\n        const tieneAsignacion = SERVICIOS_CON_ASIGNACION.includes(mov.servicio);\n\n        // 1. REVERTIR SALDO DIGITAL DEL SERVICIO (solo para servicios con asignaci├│n)\n        if (tieneAsignacion) {\n          const sSvc = await tx.servicioExternoSaldo.findUnique({\n            where: {\n              punto_atencion_id_servicio_moneda_id: {\n                punto_atencion_id: mov.punto_atencion_id,\n                servicio: mov.servicio,\n                moneda_id: mov.moneda_id,\n              },\n            },\n          });\n\n          if (sSvc) {\n            const montoNum = Number(mov.monto);\n            const billetes = Number(mov.billetes || 0);\n            const monedas = Number(mov.monedas_fisicas || 0);\n            \n            // Revertir: Si fue INGRESO (rest├│ digital), ahora sumamos\n            // Si fue EGRESO (sum├│ digital), ahora restamos\n            const mult = mov.tipo_movimiento === \"INGRESO\" ? 1 : -1;\n            \n            let bancos = 0;\n            if (mov.metodo_ingreso === \"BANCO\") bancos = montoNum;\n            else if (mov.metodo_ingreso === \"MIXTO\") bancos = Math.max(0, montoNum - (billetes + monedas));\n\n            await tx.servicioExternoSaldo.update({\n              where: { id: sSvc.id },\n              data: {\n                cantidad: { increment: montoNum * mult },\n                billetes: { increment: billetes * mult },\n                monedas_fisicas: { increment: monedas * mult },\n                bancos: { increment: bancos * mult },\n                updated_at: new Date(),\n              },\n            });\n          }\n        }\n\n        // 2. REVERTIR SALDO F├ìSICO GENERAL\n        const sGen = await tx.saldo.findUnique({\n          where: {\n            punto_atencion_id_moneda_id: {\n              punto_atencion_id: mov.punto_atencion_id,\n              moneda_id: mov.moneda_id,\n            },\n          },\n        });\n\n        if (sGen) {\n          const montoNum = Number(mov.monto);\n          const billetes = Number(mov.billetes || 0);\n          const monedas = Number(mov.monedas_fisicas || 0);\n          \n          const bancosMov = Number(mov.bancos || 0);\n          const montoCaja = Math.max(0, montoNum - bancosMov);\n          const montoBancos = Math.max(0, bancosMov);\n\n          // Si fue INGRESO (sum├│ f├¡sico), ahora restamos\n          // Si fue EGRESO (rest├│ f├¡sico), ahora sumamos\n          const mult = mov.tipo_movimiento === \"INGRESO\" ? -1 : 1;\n          const deltaCaja = montoCaja * mult;\n          const deltaBancos = montoBancos * mult;\n\n          let dBil = 0,\n            dMon = 0;\n          if (mov.metodo_ingreso === \"EFECTIVO\" || mov.metodo_ingreso === \"MIXTO\") {\n            dBil = billetes * mult;\n            dMon = monedas * mult;\n          }\n\n          const saldoCajaAnterior = Number(sGen.cantidad);\n          const saldoBancosAnterior = Number(sGen.bancos || 0);\n          const nuevoCaja = saldoCajaAnterior + deltaCaja;\n          const nuevoBancos = saldoBancosAnterior + deltaBancos;\n\n          await tx.saldo.update({\n            where: { id: sGen.id },\n            data: {\n              cantidad: nuevoCaja,\n              billetes: { increment: dBil },\n              monedas_fisicas: { increment: dMon },\n              bancos: { increment: deltaBancos },\n              updated_at: new Date(),\n            },\n          });\n\n          // Trazabilidad del ajuste (separando CAJA vs BANCOS)\n          if (Math.abs(deltaCaja) > 0.0001) {\n            await registrarMovimientoSaldo(\n              {\n                puntoAtencionId: mov.punto_atencion_id,\n                monedaId: mov.moneda_id,\n                tipoMovimiento: TipoMov.AJUSTE,\n                monto: deltaCaja,\n                saldoAnterior: saldoCajaAnterior,\n                saldoNuevo: nuevoCaja,\n                tipoReferencia: TipoReferencia.SERVICIO_EXTERNO,\n                referenciaId: mov.id,\n                saldoBucket: \"CAJA\",\n                descripcion: `Reverso eliminaci├│n ${mov.servicio} ${mov.tipo_movimiento} (CAJA)`,\n                usuarioId: userId,\n              },\n              tx\n            );\n          }\n          if (Math.abs(deltaBancos) > 0.0001) {\n            await registrarMovimientoSaldo(\n              {\n                puntoAtencionId: mov.punto_atencion_id,\n                monedaId: mov.moneda_id,\n                tipoMovimiento: TipoMov.AJUSTE,\n                monto: deltaBancos,\n                saldoAnterior: saldoBancosAnterior,\n                saldoNuevo: nuevoBancos,\n                tipoReferencia: TipoReferencia.SERVICIO_EXTERNO,\n                referenciaId: mov.id,\n                saldoBucket: \"BANCOS\",\n                descripcion: `Reverso eliminaci├│n ${mov.servicio} ${mov.tipo_movimiento} (BANCOS)`,\n                usuarioId: userId,\n              },\n              tx\n            );\n          }\n        }\n\n        await tx.servicioExternoMovimiento.delete({ where: { id: mov.id } });\n      });\n\n      res.json({ success: true });\n    } catch (error) {\n      res.status(500).json({ success: false, error: (error as Error).message });\n    }\n  }\n);\n\n/* Otros endpoints administrativos (Cierres, etc.) mantienen su l├│gica de fecha GYE */\nrouter.get(\"/admin/movimientos\", authenticateToken, requireRole([\"ADMIN\", \"SUPER_USUARIO\"]), async (req, res) => {\n  // ... similar a la anterior pero para admin\n});\n\n// Cierres\nrouter.post(\"/cierre/abrir\", authenticateToken, async (req, res) => {\n  // ... l├│gica de apertura\n});\n\n// (Se omiten los cierres para brevedad, pero deben usar gyeTodayWindow)\n\n// ==============================\n// POST /asignar-saldo  (ADMIN/SUPER_USUARIO)\n// Permite a administradores asignar / recargar saldo digital de un servicio externo\n// ==============================\nrouter.post(\n  \"/asignar-saldo\",\n  authenticateToken,\n  requireRole([\"ADMIN\", \"SUPER_USUARIO\"]),\n  async (req: Request, res: Response) => {\n    try {\n      const body = (req.body ?? {}) as Record<string, unknown>;\n      const punto_atencion_id = body.punto_atencion_id;\n      const servicio = body.servicio;\n      const monto_asignado = body.monto_asignado;\n      const tipo_asignacion = body.tipo_asignacion;\n      const creado_por = body.creado_por;\n\n      const userId = (req as Partial<AuthedRequest>).user?.id;\n      if (!userId) {\n        return res.status(401).json({ success: false, message: \"No autorizado\" });\n      }\n\n      if (\n        typeof punto_atencion_id !== \"string\" ||\n        !isServicioExterno(servicio) ||\n        monto_asignado === undefined ||\n        monto_asignado === null\n      ) {\n        return res.status(400).json({ success: false, message: \"Datos incompletos\" });\n      }\n\n      if (!SERVICIOS_VALIDOS.includes(servicio)) {\n        return res.status(400).json({ success: false, message: \"Servicio inv├ílido\" });\n      }\n\n      const montoNum = Number(monto_asignado);\n      if (!isFinite(montoNum) || montoNum <= 0) {\n        return res.status(400).json({ success: false, message: \"monto_asignado debe ser > 0\" });\n      }\n\n      const tipo =\n        tipo_asignacion === \"INICIAL\"\n          ? TipoAsignacionServicio.INICIAL\n          : TipoAsignacionServicio.RECARGA;\n\n      const usdId = await ensureUsdMonedaId();\n\n      const resultado = await prisma.$transaction(async (tx) => {\n        // 1) Crear registro de asignaci├│n\n        const asign = await tx.servicioExternoAsignacion.create({\n          data: {\n            punto_atencion_id,\n            servicio,\n            moneda_id: usdId,\n            monto: new Prisma.Decimal(montoNum),\n            tipo,\n            observaciones:\n              typeof creado_por === \"string\" && creado_por\n                ? `Asignado por ${creado_por}`\n                : undefined,\n            asignado_por: userId,\n          },\n        });\n\n        // 2) Upsert saldo del servicio\n        const existing = await tx.servicioExternoSaldo.findUnique({\n          where: {\n            punto_atencion_id_servicio_moneda_id: {\n              punto_atencion_id,\n              servicio,\n              moneda_id: usdId,\n            },\n          },\n        });\n\n        if (existing) {\n          const actualizado = await tx.servicioExternoSaldo.update({\n            where: { id: existing.id },\n            data: { cantidad: { increment: montoNum }, updated_at: new Date() },\n          });\n          return { asign, saldo: actualizado };\n        } else {\n          const creado = await tx.servicioExternoSaldo.create({\n            data: {\n              punto_atencion_id,\n              servicio,\n              moneda_id: usdId,\n              cantidad: new Prisma.Decimal(montoNum),\n              billetes: new Prisma.Decimal(0),\n              monedas_fisicas: new Prisma.Decimal(0),\n            },\n          });\n          return { asign, saldo: creado };\n        }\n      });\n\n      res.json({ success: true, resultado });\n    } catch (error) {\n      console.error(\"Error asignando saldo servicio externo:\", error);\n      res.status(500).json({ success: false, message: error instanceof Error ? error.message : \"Error desconocido\" });\n    }\n  }\n);\n\n// ============ Admin: resumen de saldos por servicio ============\nrouter.get(\n  \"/saldos\",\n  authenticateToken,\n  requireRole([\"ADMIN\", \"SUPER_USUARIO\"]),\n  async (_req: Request, res: Response) => {\n    try {\n      const usdId = await ensureUsdMonedaId();\n\n      const rows = await prisma.servicioExternoSaldo.findMany({\n        where: { moneda_id: usdId },\n        select: { servicio: true, cantidad: true },\n      });\n\n      const agg: Record<string, number> = {};\n      for (const r of rows) {\n        agg[r.servicio] = (agg[r.servicio] || 0) + Number(r.cantidad || 0);\n      }\n\n      const result = await Promise.all(\n        Object.keys(agg).map(async (servicioKey) => {\n          if (!isServicioExterno(servicioKey)) {\n            return {\n              servicio: servicioKey,\n              saldo_actual: Number(agg[servicioKey]),\n              ultimo_movimiento: null,\n            };\n          }\n          const servicio = servicioKey;\n          const ultimo = await prisma.servicioExternoMovimiento.findFirst({\n            where: { servicio },\n            orderBy: { fecha: \"desc\" },\n            select: { fecha: true },\n          });\n          return {\n            servicio,\n            saldo_actual: Number(agg[servicioKey]),\n            ultimo_movimiento: ultimo?.fecha || null,\n          };\n        })\n      );\n\n      res.json({ success: true, saldos: result });\n    } catch (error) {\n      console.error(\"Error obteniendo saldos servicios externos:\", error);\n      res.status(500).json({ success: false, message: \"Error obteniendo saldos\" });\n    }\n  }\n);\n\n// ============ Admin: saldos por punto ============\nrouter.get(\n  \"/saldos-por-punto\",\n  authenticateToken,\n  requireRole([\"ADMIN\", \"SUPER_USUARIO\"]),\n  async (_req: Request, res: Response) => {\n    try {\n      const usdId = await ensureUsdMonedaId();\n      const rows = await prisma.servicioExternoSaldo.findMany({\n        where: { moneda_id: usdId },\n        include: { puntoAtencion: { select: { id: true, nombre: true } } },\n      });\n\n      const mapped = rows.map((r) => ({\n        punto_atencion_id: r.punto_atencion_id,\n        punto_atencion_nombre: r.puntoAtencion?.nombre || null,\n        servicio: r.servicio,\n        saldo_actual: Number(r.cantidad || 0),\n      }));\n\n      res.json({ success: true, saldos: mapped });\n    } catch (error) {\n      console.error(\"Error obteniendo saldos por punto:\", error);\n      res.status(500).json({ success: false, message: \"Error obteniendo saldos por punto\" });\n    }\n  }\n);\n\n// ============ Admin: historial de asignaciones ============\nrouter.get(\n  \"/historial-asignaciones\",\n  authenticateToken,\n  requireRole([\"ADMIN\", \"SUPER_USUARIO\"]),\n  async (_req: Request, res: Response) => {\n    try {\n      const rows = (await prisma.servicioExternoAsignacion.findMany({\n        orderBy: { fecha: \"desc\" },\n        take: 200,\n        include: {\n          puntoAtencion: { select: { id: true, nombre: true } },\n          usuarioAsignador: { select: { id: true, nombre: true } },\n        },\n      }));\n\n      const mapped = rows.map((r) => ({\n        id: r.id,\n        punto_atencion_id: r.punto_atencion_id,\n        punto_atencion_nombre: r.puntoAtencion?.nombre || null,\n        servicio: r.servicio,\n        monto_asignado: Number(r.monto || 0),\n        creado_por: r.usuarioAsignador?.nombre || null,\n        creado_en: r.fecha,\n      }));\n\n      res.json({ success: true, historial: mapped });\n    } catch (error) {\n      console.error(\"Error historial asignaciones:\", error);\n      res.status(500).json({ success: false, message: \"Error obteniendo historial\" });\n    }\n  }\n);\n\n// ============ Admin: listar movimientos (query) ============\nrouter.get(\n  \"/movimientos\",\n  authenticateToken,\n  requireRole([\"ADMIN\", \"SUPER_USUARIO\"]),\n  async (req: Request, res: Response) => {\n    try {\n      const { pointId, servicio, tipo_movimiento, desde, hasta, limit } = req.query as {\n        pointId?: string;\n        servicio?: string;\n        tipo_movimiento?: string;\n        desde?: string;\n        hasta?: string;\n        limit?: string;\n      };\n      const take = Math.min(Math.max(parseInt(limit || \"100\", 10), 1), 1000);\n\n      const where: Prisma.ServicioExternoMovimientoWhereInput = {};\n      if (pointId && pointId !== \"ALL\") where.punto_atencion_id = pointId;\n      if (isServicioExterno(servicio) && SERVICIOS_VALIDOS.includes(servicio))\n        where.servicio = servicio;\n      if (isTipoMovimientoInOut(tipo_movimiento) && TIPOS_VALIDOS.includes(tipo_movimiento))\n        where.tipo_movimiento = tipo_movimiento;\n      if (desde || hasta) {\n        where.fecha = {\n          gte: desde ? new Date(`${desde}T00:00:00.000Z`) : undefined,\n          lte: hasta ? new Date(`${hasta}T23:59:59.999Z`) : undefined,\n        };\n      }\n\n      const rows = await prisma.servicioExternoMovimiento.findMany({\n        where,\n        orderBy: { fecha: \"desc\" },\n        take,\n        include: {\n          usuario: { select: { id: true, nombre: true } },\n          moneda: { select: { id: true, nombre: true, codigo: true, simbolo: true } },\n          puntoAtencion: { select: { id: true, nombre: true } },\n        },\n      });\n\n      res.json({ success: true, movimientos: rows });\n    } catch (error) {\n      console.error(\"Error listando movimientos admin:\", error);\n      res.status(500).json({ success: false, message: \"Error listando movimientos\" });\n    }\n  }\n);\n\n// ============ OPERADOR: saldos asignados por servicio (├║ltimo estado) ============\nrouter.get(\n  \"/saldos-asignados\",\n  authenticateToken,\n  async (req: Request, res: Response) => {\n    try {\n      if (!isOperador(req)) {\n        res.status(403).json({\n          success: false,\n          message: \"Permisos insuficientes (solo OPERADOR)\",\n        });\n        return;\n      }\n\n      const pointId = req.user.punto_atencion_id;\n      if (!pointId) {\n        res.status(400).json({\n          success: false,\n          message: \"No tienes un punto de atenci├│n asignado\",\n        });\n        return;\n      }\n\n      // Obtener informaci├│n del punto de atenci├│n\n      const punto = await prisma.puntoAtencion.findUnique({\n        where: { id: pointId },\n        select: { nombre: true },\n      });\n\n      if (!punto) {\n        res.status(404).json({\n          success: false,\n          message: \"Punto de atenci├│n no encontrado\",\n        });\n        return;\n      }\n\n      // Obtener saldos actuales por servicio\n      const usdId = await ensureUsdMonedaId();\n      const saldos = await prisma.servicioExternoSaldo.findMany({\n        where: { punto_atencion_id: pointId, moneda_id: usdId },\n        select: { servicio: true, cantidad: true, billetes: true, monedas_fisicas: true },\n      });\n\n      // Obtener ├║ltimas asignaciones solo para servicios con asignaci├│n\n      const saldosAsignados = await Promise.all(\n        SERVICIOS_CON_ASIGNACION.map(async (servicio) => {\n          const ultimaAsignacion = await prisma.servicioExternoAsignacion.findFirst({\n            where: { punto_atencion_id: pointId, servicio },\n            orderBy: { fecha: \"desc\" },\n            select: { monto: true, fecha: true },\n          });\n\n          const saldoActual = saldos.find((s) => s.servicio === servicio);\n\n          // Ô£à CORRECCI├ôN: El campo cantidad ya contiene el saldo correcto\n          // cantidad = monto_asignado + movimientos (INGRESO resta, EGRESO suma)\n          // Los campos billetes/monedas/bancos son solo para desglose, NO se suman al total\n          const saldoDisponible = Number(saldoActual?.cantidad || 0);\n          const billetes = Number(saldoActual?.billetes || 0);\n          const monedas = Number(saldoActual?.monedas_fisicas || 0);\n\n          return {\n            servicio,\n            saldo_asignado: saldoDisponible, // Saldo disponible actual (cantidad ya incluye todo)\n            monto_asignado_inicial: ultimaAsignacion ? Number(ultimaAsignacion.monto) : 0, // Monto inicial para referencia\n            actualizado_en: ultimaAsignacion?.fecha?.toISOString() || null,\n            billetes: billetes,\n            monedas_fisicas: monedas,\n          };\n        })\n      );\n\n      res.json({\n        success: true,\n        punto_nombre: punto.nombre,\n        saldos_asignados: saldosAsignados,\n      });\n    } catch (error) {\n      console.error(\"Error obteniendo saldos asignados:\", error);\n      res.status(500).json({ success: false, message: \"Error obteniendo saldos asignados\" });\n    }\n  }\n);\n\nexport default router;\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\oswal\\OneDrive\\Documentos\\Punto Cambio\\punto_cambio_new\\server\\routes\\servientrega.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\oswal\\OneDrive\\Documentos\\Punto Cambio\\punto_cambio_new\\server\\routes\\servientrega\\anulaciones.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\oswal\\OneDrive\\Documentos\\Punto Cambio\\punto_cambio_new\\server\\routes\\servientrega\\balances.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\oswal\\OneDrive\\Documentos\\Punto Cambio\\punto_cambio_new\\server\\routes\\servientrega\\index.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\oswal\\OneDrive\\Documentos\\Punto Cambio\\punto_cambio_new\\server\\routes\\servientrega\\informes.ts","messages":[{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'ServientregaAPIService' is defined but never used. Allowed unused vars must match /^_/u.","line":4,"column":10,"nodeType":null,"messageId":"unusedVar","endLine":4,"endColumn":32}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":1,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import express from \"express\";\nimport { authenticateToken } from \"../../middleware/auth.js\";\nimport { ServientregaDBService } from \"../../services/servientregaDBService.js\";\nimport { ServientregaAPIService } from \"../../services/servientregaAPIService.js\";\nimport ExcelJS from \"exceljs\";\nimport { format } from \"date-fns\";\nimport { es } from \"date-fns/locale\";\n\nconst router = express.Router();\nconst dbService = new ServientregaDBService();\n\n// GET /api/servientrega/informes/guias\nrouter.get(\n  \"/informes/guias\",\n  authenticateToken,\n  async (req: express.Request, res: express.Response) => {\n    try {\n      const { desde, hasta, estado, punto_atencion_id } = req.query;\n      const usuario_id = req.user?.id;\n\n      console.log(\"­ƒöì Obteniendo informes de gu├¡as:\", {\n        desde,\n        hasta,\n        estado,\n        punto_atencion_id,\n        usuario_id,\n      });\n\n      // Obtener gu├¡as de la base de datos\n      const guias = await dbService.obtenerGuiasConFiltros({\n        desde: desde as string,\n        hasta: hasta as string,\n        estado: estado as string,\n        punto_atencion_id: punto_atencion_id as string,\n        usuario_id,\n      });\n\n      // Transformar datos para el frontend\n      const guiasTransformadas = guias.map((guia) => ({\n        id: guia.id,\n        numero_guia: guia.numero_guia,\n        created_at: guia.created_at, // Mantener el nombre original para compatibilidad\n        fecha_creacion: guia.created_at,\n        estado: mapearEstadoGuia(guia.proceso),\n        punto_atencion_id: guia.punto_atencion_id || \"\",\n        punto_atencion_nombre: guia.punto_atencion?.nombre || \"N/A\",\n        agencia_codigo: guia.punto_atencion?.servientrega_agencia_codigo || \"N/A\",\n        agencia_nombre: guia.punto_atencion?.servientrega_agencia_nombre || \"N/A\",\n        alianza: guia.punto_atencion?.servientrega_alianza || \"N/A\",\n        oficina_alianza: guia.punto_atencion?.servientrega_oficina_alianza || \"N/A\",\n        destinatario_nombre: guia.destinatario?.nombre || \"N/A\",\n        destinatario_telefono: guia.destinatario?.telefono || \"N/A\",\n        destinatario_direccion: guia.destinatario?.direccion || \"N/A\",\n        valor_declarado: parseFloat(guia.valor_declarado?.toString() || \"0\"),\n        costo_envio: parseFloat(guia.costo_envio?.toString() || \"0\"),\n        base64_response: guia.base64_response || \"\", // Mantener el nombre original para compatibilidad\n        pdf_base64: guia.base64_response || \"\",\n      }));\n\n      res.json({\n        data: guiasTransformadas,\n        success: true,\n      });\n    } catch (error) {\n      console.error(\"ÔØî Error al obtener informes de gu├¡as:\", error);\n      res.status(500).json({\n        error: \"Error interno del servidor\",\n        message: error instanceof Error ? error.message : \"Error desconocido\",\n      });\n    }\n  }\n);\n\n// GET /api/servientrega/informes/estadisticas\nrouter.get(\n  \"/informes/estadisticas\",\n  authenticateToken,\n  async (req: express.Request, res: express.Response) => {\n    try {\n      const { desde, hasta } = req.query;\n\n      console.log(\"­ƒôè Obteniendo estad├¡sticas de gu├¡as:\", { desde, hasta });\n\n      const estadisticas = await dbService.obtenerEstadisticasGuias({\n        desde: desde as string,\n        hasta: hasta as string,\n      });\n\n      res.json({\n        data: estadisticas,\n        success: true,\n      });\n    } catch (error) {\n      console.error(\"ÔØî Error al obtener estad├¡sticas:\", error);\n      res.status(500).json({\n        error: \"Error interno del servidor\",\n        message: error instanceof Error ? error.message : \"Error desconocido\",\n      });\n    }\n  }\n);\n\n// GET /api/servientrega/informes/exportar\nrouter.get(\n  \"/informes/exportar\",\n  authenticateToken,\n  async (req: express.Request, res: express.Response) => {\n    try {\n      const { desde, hasta, estado, punto_atencion_id } = req.query;\n      const usuario_id = req.user?.id;\n\n      console.log(\"­ƒôÑ Exportando informes de gu├¡as:\", {\n        desde,\n        hasta,\n        estado,\n        punto_atencion_id,\n        usuario_id,\n      });\n\n      // Obtener gu├¡as\n      const guias = await dbService.obtenerGuiasConFiltros({\n        desde: desde as string,\n        hasta: hasta as string,\n        estado: estado as string,\n        punto_atencion_id: punto_atencion_id as string,\n        usuario_id,\n      });\n\n      // Crear archivo Excel\n      const workbook = new ExcelJS.Workbook();\n      const worksheet = workbook.addWorksheet(\"Informes Servientrega\");\n\n      // Configurar columnas\n      worksheet.columns = [\n        { header: \"N├║mero de Gu├¡a\", key: \"numero_guia\", width: 15 },\n        { header: \"Fecha Creaci├│n\", key: \"fecha_creacion\", width: 20 },\n        { header: \"Estado\", key: \"estado\", width: 20 },\n        { header: \"Punto de Atenci├│n\", key: \"punto_atencion\", width: 25 },\n        { header: \"Destinatario\", key: \"destinatario_nombre\", width: 30 },\n        { header: \"Tel├®fono\", key: \"destinatario_telefono\", width: 15 },\n        { header: \"Direcci├│n\", key: \"destinatario_direccion\", width: 40 },\n        { header: \"Valor Declarado\", key: \"valor_declarado\", width: 15 },\n        { header: \"Costo Env├¡o\", key: \"costo_envio\", width: 15 },\n      ];\n\n      // Agregar datos\n      guias.forEach((guia) => {\n        worksheet.addRow({\n          numero_guia: guia.numero_guia,\n          fecha_creacion: format(\n            new Date(guia.created_at),\n            \"dd/MM/yyyy HH:mm\",\n            {\n              locale: es,\n            }\n          ),\n          estado: mapearEstadoGuia(guia.proceso),\n          punto_atencion: guia.punto_atencion?.nombre || \"N/A\",\n          destinatario_nombre: guia.destinatario?.nombre || \"N/A\",\n          destinatario_telefono: guia.destinatario?.telefono || \"N/A\",\n          destinatario_direccion: guia.destinatario?.direccion || \"N/A\",\n          valor_declarado: parseFloat(guia.valor_declarado?.toString() || \"0\"),\n          costo_envio: parseFloat(guia.costo_envio?.toString() || \"0\"),\n        });\n      });\n\n      // Estilizar encabezados\n      worksheet.getRow(1).font = { bold: true };\n      worksheet.getRow(1).fill = {\n        type: \"pattern\",\n        pattern: \"solid\",\n        fgColor: { argb: \"FFE6E6FA\" },\n      };\n\n      // Configurar respuesta\n      res.setHeader(\n        \"Content-Type\",\n        \"application/vnd.openxmlformats-officedocument.spreadsheetml.sheet\"\n      );\n      res.setHeader(\n        \"Content-Disposition\",\n        `attachment; filename=informe_servientrega_${desde}_${hasta}.xlsx`\n      );\n\n      // Enviar archivo\n      await workbook.xlsx.write(res);\n      res.end();\n    } catch (error) {\n      console.error(\"ÔØî Error al exportar informes:\", error);\n      res.status(500).json({\n        error: \"Error interno del servidor\",\n        message: error instanceof Error ? error.message : \"Error desconocido\",\n      });\n    }\n  }\n);\n\n// Funci├│n auxiliar para mapear estados\nfunction mapearEstadoGuia(proceso: string): string {\n  switch (proceso?.toLowerCase()) {\n    case \"anulada\":\n      return \"ANULADA\";\n    case \"pendiente_anulacion\":\n      return \"PENDIENTE_ANULACION\";\n    default:\n      return \"ACTIVA\";\n  }\n}\n\nexport { router as informesRouter };\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\oswal\\OneDrive\\Documentos\\Punto Cambio\\punto_cambio_new\\server\\routes\\servientrega\\products.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\oswal\\OneDrive\\Documentos\\Punto Cambio\\punto_cambio_new\\server\\routes\\servientrega\\receipts.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\oswal\\OneDrive\\Documentos\\Punto Cambio\\punto_cambio_new\\server\\routes\\servientrega\\shipping.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\oswal\\OneDrive\\Documentos\\Punto Cambio\\punto_cambio_new\\server\\routes\\servientrega\\users.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\oswal\\OneDrive\\Documentos\\Punto Cambio\\punto_cambio_new\\server\\routes\\spontaneous-exits.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\oswal\\OneDrive\\Documentos\\Punto Cambio\\punto_cambio_new\\server\\routes\\transfer-approvals.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\oswal\\OneDrive\\Documentos\\Punto Cambio\\punto_cambio_new\\server\\routes\\transfers.ts","messages":[{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'transferAutoReconciliation' is defined but never used. Allowed unused vars must match /^_/u.","line":4,"column":10,"nodeType":null,"messageId":"unusedVar","endLine":4,"endColumn":36}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":1,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import express from \"express\";\r\nimport { authenticateToken } from \"../middleware/auth.js\";\r\nimport { validate } from \"../middleware/validation.js\";\r\nimport { transferAutoReconciliation } from \"../middleware/autoReconciliation.js\";\r\nimport { validarSaldoTransferencia } from \"../middleware/saldoValidation.js\";\r\nimport { z } from \"zod\";\r\nimport transferController from \"../controllers/transferController.js\";\r\nimport prisma from \"../lib/prisma.js\";\r\nimport logger from \"../utils/logger.js\";\r\n\r\nconst router = express.Router();\r\n\r\n// ÔòÉÔòÉÔòÉÔòÉÔòÉÔòÉÔòÉÔòÉÔòÉÔòÉÔòÉÔòÉÔòÉÔòÉÔòÉÔòÉÔòÉÔòÉÔòÉÔòÉÔòÉÔòÉÔòÉÔòÉÔòÉÔòÉÔòÉÔòÉÔòÉÔòÉÔòÉÔòÉÔòÉÔòÉÔòÉÔòÉÔòÉÔòÉÔòÉÔòÉÔòÉÔòÉÔòÉÔòÉÔòÉÔòÉÔòÉÔòÉÔòÉÔòÉÔòÉÔòÉÔòÉÔòÉÔòÉÔòÉÔòÉÔòÉÔòÉÔòÉÔòÉÔòÉÔòÉÔòÉÔòÉÔòÉÔòÉÔòÉÔòÉÔòÉÔòÉ\r\n// TRANSFERENCIAS ENTRE PUNTOS - L├ôGICA DE NEGOCIO\r\n// ÔòÉÔòÉÔòÉÔòÉÔòÉÔòÉÔòÉÔòÉÔòÉÔòÉÔòÉÔòÉÔòÉÔòÉÔòÉÔòÉÔòÉÔòÉÔòÉÔòÉÔòÉÔòÉÔòÉÔòÉÔòÉÔòÉÔòÉÔòÉÔòÉÔòÉÔòÉÔòÉÔòÉÔòÉÔòÉÔòÉÔòÉÔòÉÔòÉÔòÉÔòÉÔòÉÔòÉÔòÉÔòÉÔòÉÔòÉÔòÉÔòÉÔòÉÔòÉÔòÉÔòÉÔòÉÔòÉÔòÉÔòÉÔòÉÔòÉÔòÉÔòÉÔòÉÔòÉÔòÉÔòÉÔòÉÔòÉÔòÉÔòÉÔòÉÔòÉ\r\n// IMPORTANTE: Las transferencias son MOVIMIENTOS F├ìSICOS DE EFECTIVO\r\n// NO son transferencias bancarias.\r\n//\r\n// PROCESO REAL:\r\n// 1. Punto A necesita enviar $500 USD a Punto B\r\n// 2. Sistema resta $500 del saldo f├¡sico de Punto A\r\n// 3. Operador de Punto A toma el efectivo de la caja\r\n// 4. Operador se traslada f├¡sicamente (taxi, caminando, moto) al Punto B\r\n// 5. Entrega el efectivo al operador de Punto B\r\n// 6. Sistema suma $500 al saldo f├¡sico de Punto B\r\n// 7. Ambos puntos registran el movimiento en su cuadre de caja\r\n//\r\n// NOTA: El campo \"via\" puede ser:\r\n// - EFECTIVO: Movimiento f├¡sico normal (99% de los casos)\r\n// - BANCO: Solo para casos excepcionales de control administrativo\r\n// - MIXTO: Combinaci├│n de ambos\r\n// ÔòÉÔòÉÔòÉÔòÉÔòÉÔòÉÔòÉÔòÉÔòÉÔòÉÔòÉÔòÉÔòÉÔòÉÔòÉÔòÉÔòÉÔòÉÔòÉÔòÉÔòÉÔòÉÔòÉÔòÉÔòÉÔòÉÔòÉÔòÉÔòÉÔòÉÔòÉÔòÉÔòÉÔòÉÔòÉÔòÉÔòÉÔòÉÔòÉÔòÉÔòÉÔòÉÔòÉÔòÉÔòÉÔòÉÔòÉÔòÉÔòÉÔòÉÔòÉÔòÉÔòÉÔòÉÔòÉÔòÉÔòÉÔòÉÔòÉÔòÉÔòÉÔòÉÔòÉÔòÉÔòÉÔòÉÔòÉÔòÉÔòÉÔòÉÔòÉ\r\n\r\n// Schema para crear transferencias\r\nconst createTransferSchema = z.object({\r\n  origen_id: z.string().uuid().optional().nullable(),\r\n  destino_id: z.string().uuid(),\r\n  moneda_id: z.string().uuid(),\r\n  monto: z.number().positive(),\r\n\r\n  tipo_transferencia: z.enum([\r\n    \"ENTRE_PUNTOS\",\r\n    \"DEPOSITO_MATRIZ\",\r\n    \"RETIRO_GERENCIA\",\r\n    \"DEPOSITO_GERENCIA\",\r\n  ]),\r\n\r\n  // NUEVO: v├¡a de la transferencia\r\n  via: z.enum([\"EFECTIVO\", \"BANCO\", \"MIXTO\"]).optional().default(\"EFECTIVO\"),\r\n\r\n  // Desglose opcional para MIXTO (si no viene, se reparte 50/50)\r\n  monto_efectivo: z.number().min(0).optional(),\r\n  monto_banco: z.number().min(0).optional(),\r\n\r\n  descripcion: z.string().optional().nullable(),\r\n\r\n  // opcional: detalle f├¡sico para soporte de remisi├│n (no afecta l├│gica)\r\n  detalle_divisas: z\r\n    .object({\r\n      billetes: z.number().min(0),\r\n      monedas: z.number().min(0),\r\n      total: z.number().min(0),\r\n    })\r\n    .optional(),\r\n  responsable_movilizacion: z\r\n    .object({\r\n      nombre: z.string().min(1),\r\n      documento: z.string().min(1),\r\n      cedula: z.string().min(1),\r\n      telefono: z.string().optional(),\r\n    })\r\n    .optional(),\r\n});\r\n\r\n// Crear transferencia\r\nrouter.post(\r\n  \"/\",\r\n  authenticateToken,\r\n  validate(createTransferSchema),\r\n  validarSaldoTransferencia, // ­ƒøí´©Å Validar saldo suficiente antes de transferir\r\n  // transferAutoReconciliation, // ÔØî DESHABILITADO: Causaba doble actualizaci├│n de saldos\r\n  transferController.createTransfer\r\n);\r\n\r\n// Listar transferencias\r\nrouter.get(\"/\", authenticateToken, transferController.getAllTransfers);\r\n\r\n// Obtener transferencias EN_TRANSITO pendientes de aceptaci├│n para el punto actual\r\nrouter.get(\"/pending-acceptance\", authenticateToken, async (req, res) => {\r\n  try {\r\n    if (!req.user) {\r\n      return res.status(401).json({\r\n        error: \"Usuario no autenticado\",\r\n        success: false,\r\n        timestamp: new Date().toISOString(),\r\n      });\r\n    }\r\n\r\n    const puntoAtencionId = req.user.punto_atencion_id;\r\n\r\n    if (!puntoAtencionId) {\r\n      return res.status(400).json({\r\n        error: \"Usuario no tiene punto de atenci├│n asignado\",\r\n        success: false,\r\n        timestamp: new Date().toISOString(),\r\n      });\r\n    }\r\n\r\n    const pendingTransfers = await prisma.transferencia.findMany({\r\n      where: {\r\n        destino_id: puntoAtencionId,\r\n        estado: \"EN_TRANSITO\",\r\n      },\r\n      include: {\r\n        origen: { select: { id: true, nombre: true } },\r\n        destino: { select: { id: true, nombre: true } },\r\n        moneda: {\r\n          select: { id: true, codigo: true, nombre: true, simbolo: true },\r\n        },\r\n        usuarioSolicitante: {\r\n          select: { id: true, nombre: true, username: true },\r\n        },\r\n      },\r\n      orderBy: { fecha: \"desc\" },\r\n    });\r\n\r\n    const formattedTransfers = pendingTransfers.map((transfer) => ({\r\n      ...transfer,\r\n      monto: parseFloat(transfer.monto.toString()),\r\n      fecha: transfer.fecha.toISOString(),\r\n      fecha_envio: transfer.fecha_envio?.toISOString() || null,\r\n    }));\r\n\r\n    res.status(200).json({\r\n      transfers: formattedTransfers,\r\n      success: true,\r\n      timestamp: new Date().toISOString(),\r\n    });\r\n  } catch (error) {\r\n    logger.error(\"Error al obtener transferencias pendientes de aceptaci├│n\", {\r\n      error: error instanceof Error ? error.message : \"Unknown error\",\r\n      stack: error instanceof Error ? error.stack : undefined,\r\n      requestedBy: req.user?.id,\r\n    });\r\n\r\n    res.status(500).json({\r\n      error: \"Error al obtener transferencias pendientes de aceptaci├│n\",\r\n      success: false,\r\n      timestamp: new Date().toISOString(),\r\n    });\r\n  }\r\n});\r\n\r\nexport default router;\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\oswal\\OneDrive\\Documentos\\Punto Cambio\\punto_cambio_new\\server\\routes\\users.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\oswal\\OneDrive\\Documentos\\Punto Cambio\\punto_cambio_new\\server\\routes\\vista-saldos-puntos.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\oswal\\OneDrive\\Documentos\\Punto Cambio\\punto_cambio_new\\server\\schemas\\validation.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\oswal\\OneDrive\\Documentos\\Punto Cambio\\punto_cambio_new\\server\\services\\cierreService.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\oswal\\OneDrive\\Documentos\\Punto Cambio\\punto_cambio_new\\server\\services\\movimientoSaldoService.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\oswal\\OneDrive\\Documentos\\Punto Cambio\\punto_cambio_new\\server\\services\\reportDataService.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\oswal\\OneDrive\\Documentos\\Punto Cambio\\punto_cambio_new\\server\\services\\reportService.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\oswal\\OneDrive\\Documentos\\Punto Cambio\\punto_cambio_new\\server\\services\\saldoReconciliationService.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\oswal\\OneDrive\\Documentos\\Punto Cambio\\punto_cambio_new\\server\\services\\servientregaAPIService.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\oswal\\OneDrive\\Documentos\\Punto Cambio\\punto_cambio_new\\server\\services\\servientregaDBService.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\oswal\\OneDrive\\Documentos\\Punto Cambio\\punto_cambio_new\\server\\services\\servientregaValidationService.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\oswal\\OneDrive\\Documentos\\Punto Cambio\\punto_cambio_new\\server\\services\\transferCreationService.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\oswal\\OneDrive\\Documentos\\Punto Cambio\\punto_cambio_new\\server\\services\\transferValidationService.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\oswal\\OneDrive\\Documentos\\Punto Cambio\\punto_cambio_new\\server\\types\\express-augment.d.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\oswal\\OneDrive\\Documentos\\Punto Cambio\\punto_cambio_new\\server\\types\\reportTypes.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\oswal\\OneDrive\\Documentos\\Punto Cambio\\punto_cambio_new\\server\\utils\\logger.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\oswal\\OneDrive\\Documentos\\Punto Cambio\\punto_cambio_new\\server\\utils\\timezone.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\oswal\\OneDrive\\Documentos\\Punto Cambio\\punto_cambio_new\\src\\App.tsx","messages":[{"ruleId":"react-hooks/exhaustive-deps","severity":1,"message":"React Hook useEffect has a missing dependency: 'setSelectedPoint'. Either include it or remove the dependency array.","line":109,"column":6,"nodeType":"ArrayExpression","endLine":109,"endColumn":27,"suggestions":[{"desc":"Update the dependencies array to be: [user, selectedPoint, setSelectedPoint]","fix":{"range":[3845,3866],"text":"[user, selectedPoint, setSelectedPoint]"}}]}],"suppressedMessages":[{"ruleId":"react-hooks/exhaustive-deps","severity":1,"message":"React Hook useEffect has missing dependencies: 'selectedPoint' and 'setSelectedPoint'. Either include them or remove the dependency array.","line":80,"column":6,"nodeType":"ArrayExpression","endLine":80,"endColumn":12,"suggestions":[{"desc":"Update the dependencies array to be: [selectedPoint, setSelectedPoint, user]","fix":{"range":[2883,2889],"text":"[selectedPoint, setSelectedPoint, user]"}}],"suppressions":[{"kind":"directive","justification":""}]}],"errorCount":0,"fatalErrorCount":0,"warningCount":1,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import { BrowserRouter as Router, Routes, Route } from \"react-router-dom\";\nimport { useAuth } from \"./hooks/useAuth\";\nimport { Toaster } from \"@/components/ui/sonner\";\nimport LoginForm from \"./components/auth/LoginForm\";\nimport PointSelection from \"./components/auth/PointSelection\";\nimport Index from \"./pages/Index\";\nimport \"./App.css\";\nimport { useEffect, useState } from \"react\";\n// Cambia este import:\nimport axiosInstance from \"@/services/axiosInstance\";\nimport { pointService } from \"@/services/pointService\";\nimport { PuntoAtencion } from \"./types\";\n\ninterface JornadaActiveResponse {\n  success: boolean;\n  schedule: {\n    punto_atencion_id?: string;\n    puntoAtencion?: {\n      id: string;\n      nombre: string;\n      direccion: string;\n      ciudad: string;\n      provincia: string;\n      codigo_postal?: string;\n      telefono?: string;\n      servientrega_agencia_codigo?: string;\n      servientrega_agencia_nombre?: string;\n    };\n  } | null;\n}\n\nfunction App() {\n  const { user, selectedPoint, setSelectedPoint, isLoading, logout } =\n    useAuth();\n  const [points, setPoints] = useState<PuntoAtencion[]>([]);\n  const [verifyingJornada, setVerifyingJornada] = useState(false);\n\n  // Verifica si existe jornada activa para OPERADOR\n  useEffect(() => {\n    if (user && user.rol === \"OPERADOR\") {\n      setVerifyingJornada(true);\n      axiosInstance\n        .get<JornadaActiveResponse>(\"/schedules/active\")\n        .then(({ data }) => {\n          const active = data?.schedule;\n          if (!active) {\n            setSelectedPoint(null);\n            localStorage.removeItem(\"puntoAtencionSeleccionado\");\n          } else if (\n            active.punto_atencion_id &&\n            (!selectedPoint || selectedPoint.id !== active.punto_atencion_id)\n          ) {\n            setSelectedPoint({\n              id: active.puntoAtencion?.id || active.punto_atencion_id,\n              nombre: active.puntoAtencion?.nombre || \"\",\n              direccion: active.puntoAtencion?.direccion || \"\",\n              ciudad: active.puntoAtencion?.ciudad || \"\",\n              provincia: active.puntoAtencion?.provincia || \"\",\n              codigo_postal: active.puntoAtencion?.codigo_postal || \"\",\n              telefono: active.puntoAtencion?.telefono || \"\",\n              servientrega_agencia_codigo:\n                active.puntoAtencion?.servientrega_agencia_codigo,\n              servientrega_agencia_nombre:\n                active.puntoAtencion?.servientrega_agencia_nombre,\n              activo: true,\n              es_principal: false,\n              created_at: \"\",\n              updated_at: \"\",\n            });\n          }\n          setVerifyingJornada(false);\n        })\n        .catch(() => {\n          setSelectedPoint(null);\n          localStorage.removeItem(\"puntoAtencionSeleccionado\");\n          setVerifyingJornada(false);\n        });\n    }\n    // eslint-disable-next-line\n  }, [user]);\n\n  // Para ADMIN: preselecciona autom├íticamente el punto principal\n  useEffect(() => {\n    if (\n      user &&\n      (user.rol === \"ADMIN\" || user.rol === \"SUPER_USUARIO\") &&\n      !selectedPoint\n    ) {\n      pointService\n        .getAllPointsForAdmin()\n        .then((result) => {\n          const points = result.points || [];\n          const puntoPrincipal =\n            points.find((p) => p.es_principal) ||\n            points.find((p) => p.id === user.punto_atencion_id) ||\n            points.find(\n              (p) =>\n                p.nombre.toLowerCase().includes(\"principal\") ||\n                p.nombre.toLowerCase().includes(\"matriz\") ||\n                p.nombre.toLowerCase().includes(\"central\")\n            ) ||\n            points[0];\n          if (puntoPrincipal) setSelectedPoint(puntoPrincipal);\n        })\n        .catch((error) => {\n          console.error(\"Error al cargar punto principal para admin:\", error);\n        });\n    }\n  }, [user, selectedPoint]);\n\n  // Carga los puntos de atenci├│n libres si corresponde (para OPERADOR y ADMINISTRATIVO)\n  useEffect(() => {\n    if (\n      user &&\n      (user.rol === \"OPERADOR\" || user.rol === \"ADMINISTRATIVO\") &&\n      !selectedPoint &&\n      !verifyingJornada\n    ) {\n      axiosInstance\n        .get<{ points: PuntoAtencion[] }>(\"/points\")\n        .then(({ data }) => setPoints(data.points || []))\n        .catch(() => setPoints([]));\n    }\n  }, [user, selectedPoint, verifyingJornada]);\n\n  return (\n    <Router>\n      {isLoading || verifyingJornada ? (\n        <div className=\"min-h-screen flex items-center justify-center\">\n          <div className=\"text-center\">\n            <div className=\"animate-spin rounded-full h-32 w-32 border-b-2 border-blue-600 mx-auto\"></div>\n            <p className=\"mt-4 text-gray-600\">Cargando aplicaci├│n...</p>\n          </div>\n        </div>\n      ) : !user ? (\n        <>\n          <LoginForm />\n          <Toaster />\n        </>\n      ) : (user.rol === \"OPERADOR\" || user.rol === \"ADMINISTRATIVO\") && !selectedPoint ? (\n        <>\n          <PointSelection user={user} points={points} onLogout={logout} />\n          <Toaster />\n        </>\n      ) : (\n        <div className=\"App\">\n          <Routes>\n            <Route path=\"/*\" element={<Index />} />\n          </Routes>\n          <Toaster />\n        </div>\n      )}\n    </Router>\n  );\n}\n\nexport default App;\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\oswal\\OneDrive\\Documentos\\Punto Cambio\\punto_cambio_new\\src\\components\\admin\\ActivePointsReport.tsx","messages":[{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'setSortKey' is assigned a value but never used. Allowed unused vars must match /^_/u.","line":71,"column":19,"nodeType":null,"messageId":"unusedVar","endLine":71,"endColumn":29},{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'setSortDir' is assigned a value but never used. Allowed unused vars must match /^_/u.","line":72,"column":19,"nodeType":null,"messageId":"unusedVar","endLine":72,"endColumn":29},{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'columnDefs' is assigned a value but never used. Allowed unused vars must match /^_/u.","line":121,"column":9,"nodeType":null,"messageId":"unusedVar","endLine":121,"endColumn":19},{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'totalPages' is assigned a value but never used. Allowed unused vars must match /^_/u.","line":132,"column":9,"nodeType":null,"messageId":"unusedVar","endLine":132,"endColumn":19},{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'pagedData' is assigned a value but never used. Allowed unused vars must match /^_/u.","line":133,"column":9,"nodeType":null,"messageId":"unusedVar","endLine":133,"endColumn":18}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":5,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import { useState, useEffect, useCallback, useRef, useMemo } from \"react\";\r\nimport { Card, CardContent, CardHeader, CardTitle } from \"@/components/ui/card\";\r\nimport { Badge } from \"@/components/ui/badge\";\r\nimport { Button } from \"@/components/ui/button\";\r\nimport { Tabs, TabsContent, TabsList, TabsTrigger } from \"@/components/ui/tabs\";\r\nimport { MapPin, Clock, User, RefreshCw } from \"lucide-react\";\r\nimport { useToast } from \"@/hooks/use-toast\";\r\nimport { User as UserType } from \"../../types\";\r\nimport { scheduleService } from \"../../services/scheduleService\";\r\nimport FreePointButton from \"./FreePointButton\";\r\n\r\ninterface ActiveSchedule {\r\n  id: string;\r\n  fecha_inicio: string;\r\n  fecha_almuerzo?: string;\r\n  fecha_regreso?: string;\r\n  fecha_salida?: string;\r\n  ubicacion_inicio?: {\r\n    lat: number;\r\n    lng: number;\r\n    direccion?: string;\r\n  };\r\n  ubicacion_salida?: {\r\n    lat: number;\r\n    lng: number;\r\n    direccion?: string;\r\n  };\r\n  estado: string;\r\n  usuario: {\r\n    id: string;\r\n    nombre: string;\r\n    username: string;\r\n  };\r\n  puntoAtencion: {\r\n    id: string;\r\n    nombre: string;\r\n  };\r\n}\r\n\r\ninterface ActivePointsReportProps {\r\n  user: UserType;\r\n}\r\n\r\ntype ColKey =\r\n  | \"usuario\"\r\n  | \"username\"\r\n  | \"punto\"\r\n  | \"entrada\"\r\n  | \"almuerzo\"\r\n  | \"regreso\"\r\n  | \"salida\"\r\n  | \"estado\";\r\n\r\nconst AUTO_REFRESH_INTERVAL = 0; // Pon aqu├¡ los milisegundos si quieres refresco autom├ítico, ej: 60000 para 1 min.\r\n\r\nconst ActivePointsReport = ({ user: _user }: ActivePointsReportProps) => {\r\n  const [activeSchedules, setActiveSchedules] = useState<ActiveSchedule[]>([]);\r\n  const [loading, setLoading] = useState(true);\r\n  const [errorMsg, setErrorMsg] = useState<string | null>(null);\r\n\r\n  // Filtros\r\n  const todayStr = useMemo(() => new Date().toISOString().slice(0, 10), []);\r\n  const [fromDate, setFromDate] = useState<string>(todayStr);\r\n  const [toDate, setToDate] = useState<string>(todayStr);\r\n  const [onlyActive, setOnlyActive] = useState<boolean>(true);\r\n\r\n  // Paginaci├│n\r\n  const [page, setPage] = useState(1);\r\n  const [pageSize, setPageSize] = useState(20);\r\n  const [searchTerm, setSearchTerm] = useState(\"\");\r\n  const [sortKey, setSortKey] = useState<ColKey>(\"usuario\");\r\n  const [sortDir, setSortDir] = useState<\"asc\" | \"desc\">(\"asc\");\r\n\r\n  const filteredData = useMemo(() => {\r\n    const term = searchTerm.trim().toLowerCase();\r\n    if (!term) return activeSchedules;\r\n    return activeSchedules.filter((s) => {\r\n      const u = s.usuario.nombre.toLowerCase();\r\n      const un = s.usuario.username.toLowerCase();\r\n      const p = s.puntoAtencion.nombre.toLowerCase();\r\n      return u.includes(term) || un.includes(term) || p.includes(term);\r\n    });\r\n  }, [activeSchedules, searchTerm]);\r\n\r\n  const sortedData = useMemo(() => {\r\n    const data = [...filteredData];\r\n    const getTime = (v?: string) => (v ? new Date(v).getTime() : 0);\r\n    data.sort((a, b) => {\r\n      let comp = 0;\r\n      switch (sortKey) {\r\n        case \"usuario\":\r\n          comp = a.usuario.nombre.localeCompare(b.usuario.nombre);\r\n          break;\r\n        case \"username\":\r\n          comp = a.usuario.username.localeCompare(b.usuario.username);\r\n          break;\r\n        case \"punto\":\r\n          comp = a.puntoAtencion.nombre.localeCompare(b.puntoAtencion.nombre);\r\n          break;\r\n        case \"entrada\":\r\n          comp = getTime(a.fecha_inicio) - getTime(b.fecha_inicio);\r\n          break;\r\n        case \"almuerzo\":\r\n          comp = getTime(a.fecha_almuerzo) - getTime(b.fecha_almuerzo);\r\n          break;\r\n        case \"regreso\":\r\n          comp = getTime(a.fecha_regreso) - getTime(b.fecha_regreso);\r\n          break;\r\n        case \"salida\":\r\n          comp = getTime(a.fecha_salida) - getTime(b.fecha_salida);\r\n          break;\r\n        case \"estado\":\r\n          comp = a.estado.localeCompare(b.estado);\r\n          break;\r\n      }\r\n      return sortDir === \"asc\" ? comp : -comp;\r\n    });\r\n    return data;\r\n  }, [filteredData, sortKey, sortDir]);\r\n\r\n  const columnDefs: { key: ColKey; label: string }[] = [\r\n    { key: \"usuario\", label: \"Usuario\" },\r\n    { key: \"username\", label: \"Username\" },\r\n    { key: \"punto\", label: \"Punto\" },\r\n    { key: \"entrada\", label: \"Entrada\" },\r\n    { key: \"almuerzo\", label: \"Almuerzo\" },\r\n    { key: \"regreso\", label: \"Regreso\" },\r\n    { key: \"salida\", label: \"Salida\" },\r\n    { key: \"estado\", label: \"Estado\" },\r\n  ];\r\n\r\n  const totalPages = Math.max(1, Math.ceil(sortedData.length / pageSize));\r\n  const pagedData = useMemo(() => {\r\n    const start = (page - 1) * pageSize;\r\n    return sortedData.slice(start, start + pageSize);\r\n  }, [sortedData, page, pageSize]);\r\n  const { toast } = useToast();\r\n  const refreshTimeout = useRef<number | undefined>(undefined);\r\n\r\n  const loadActiveSchedules = useCallback(async () => {\r\n    setLoading(true);\r\n    setErrorMsg(null);\r\n    try {\r\n      const estados = onlyActive\r\n        ? [\"ACTIVO\", \"ALMUERZO\"]\r\n        : [\"ACTIVO\", \"ALMUERZO\", \"COMPLETADO\"];\r\n      const byDay = fromDate === toDate;\r\n      const { schedules, error } = await scheduleService.getAllSchedules({\r\n        ...(byDay ? { fecha: fromDate } : { from: fromDate, to: toDate }),\r\n        estados,\r\n        limit: 1000,\r\n      });\r\n      if (error) {\r\n        setErrorMsg(error);\r\n        toast({\r\n          title: \"Error\",\r\n          description: `Error al cargar horarios activos: ${error}`,\r\n          variant: \"destructive\",\r\n        });\r\n        setActiveSchedules([]);\r\n        return;\r\n      }\r\n\r\n      const filtered: ActiveSchedule[] = schedules.flatMap((schedule) => {\r\n        if (!schedule.usuario || !schedule.puntoAtencion) return [];\r\n        return [\r\n          {\r\n            id: schedule.id,\r\n            fecha_inicio: schedule.fecha_inicio,\r\n            fecha_almuerzo: schedule.fecha_almuerzo,\r\n            fecha_regreso: schedule.fecha_regreso,\r\n            fecha_salida: schedule.fecha_salida,\r\n            ubicacion_inicio: schedule.ubicacion_inicio,\r\n            ubicacion_salida: schedule.ubicacion_salida,\r\n            estado: schedule.estado,\r\n            usuario: {\r\n              id: schedule.usuario.id,\r\n              nombre: schedule.usuario.nombre,\r\n              username: schedule.usuario.username,\r\n            },\r\n            puntoAtencion: {\r\n              id: schedule.puntoAtencion.id,\r\n              nombre: schedule.puntoAtencion.nombre,\r\n            },\r\n          },\r\n        ];\r\n      });\r\n\r\n      setActiveSchedules(filtered);\r\n\r\n      toast({\r\n        title: \"Datos actualizados\",\r\n        description: `Se encontraron ${filtered.length} registros`,\r\n      });\r\n    } catch (err) {\r\n      const msg =\r\n        err instanceof Error\r\n          ? err.message\r\n          : \"No se pudieron cargar los datos de usuarios activos\";\r\n      setErrorMsg(msg);\r\n      toast({\r\n        title: \"Error de conexi├│n\",\r\n        description: msg,\r\n        variant: \"destructive\",\r\n      });\r\n      setActiveSchedules([]);\r\n    } finally {\r\n      setLoading(false);\r\n    }\r\n  }, [toast, fromDate, toDate, onlyActive]);\r\n\r\n  useEffect(() => {\r\n    loadActiveSchedules();\r\n\r\n    if (AUTO_REFRESH_INTERVAL > 0) {\r\n      refreshTimeout.current = window.setTimeout(\r\n        loadActiveSchedules,\r\n        AUTO_REFRESH_INTERVAL\r\n      );\r\n    }\r\n    return () => {\r\n      if (refreshTimeout.current) {\r\n        clearTimeout(refreshTimeout.current);\r\n      }\r\n    };\r\n  }, [loadActiveSchedules, fromDate, toDate, onlyActive]);\r\n\r\n  const formatTime = (dateString?: string) => {\r\n    if (!dateString) return \"No registrado\";\r\n    return new Date(dateString).toLocaleTimeString(\"es-ES\", {\r\n      hour: \"2-digit\",\r\n      minute: \"2-digit\",\r\n    });\r\n  };\r\n\r\n  const formatDate = (dateString: string) => {\r\n    return new Date(dateString).toLocaleDateString(\"es-ES\", {\r\n      day: \"2-digit\",\r\n      month: \"2-digit\",\r\n      year: \"numeric\",\r\n    });\r\n  };\r\n\r\n  const getWorkingHours = (startTime: string, endTime?: string) => {\r\n    const start = new Date(startTime);\r\n    const end = endTime ? new Date(endTime) : new Date();\r\n    const diff = end.getTime() - start.getTime();\r\n    const hours = Math.floor(diff / (1000 * 60 * 60));\r\n    const minutes = Math.floor((diff % (1000 * 60 * 60)) / (1000 * 60));\r\n    return `${hours}h ${minutes}m`;\r\n  };\r\n\r\n  const getLocationString = (location?: {\r\n    lat: number;\r\n    lng: number;\r\n    direccion?: string;\r\n  }) => {\r\n    if (!location) return \"No disponible\";\r\n    return (\r\n      location.direccion ||\r\n      `${location.lat.toFixed(6)}, ${location.lng.toFixed(6)}`\r\n    );\r\n  };\r\n\r\n  if (loading) {\r\n    return (\r\n      <div className=\"flex items-center justify-center h-64\">\r\n        <div className=\"animate-spin rounded-full h-8 w-8 border-b-2 border-primary\"></div>\r\n        <span className=\"ml-2\">Cargando usuarios activos...</span>\r\n      </div>\r\n    );\r\n  }\r\n\r\n  if (errorMsg) {\r\n    return (\r\n      <div className=\"flex items-center justify-center h-64\">\r\n        <p className=\"text-red-600\">{errorMsg}</p>\r\n      </div>\r\n    );\r\n  }\r\n\r\n  return (\r\n    <div className=\"space-y-6\">\r\n      <div className=\"flex flex-col gap-3\">\r\n        <div className=\"flex items-center justify-between\">\r\n          <div>\r\n            <h2 className=\"text-2xl font-bold text-gray-800\">\r\n              Usuarios Activos\r\n            </h2>\r\n            <p className=\"text-gray-600\">\r\n              Monitoreo en tiempo real de jornadas laborales -{\" \"}\r\n              {formatDate(new Date().toISOString())}\r\n            </p>\r\n          </div>\r\n          <div className=\"flex gap-2\">\r\n            <Button onClick={loadActiveSchedules} disabled={loading}>\r\n              <RefreshCw className=\"h-4 w-4 mr-2\" />\r\n              Actualizar\r\n            </Button>\r\n          </div>\r\n        </div>\r\n\r\n        {/* Filtros */}\r\n        <div className=\"grid grid-cols-1 md:grid-cols-5 gap-3\">\r\n          <div>\r\n            <label className=\"block text-sm text-gray-600 mb-1\">Desde</label>\r\n            <input\r\n              type=\"date\"\r\n              className=\"w-full border rounded px-2 py-1\"\r\n              value={fromDate}\r\n              max={toDate}\r\n              onChange={(e) => {\r\n                setPage(1);\r\n                setFromDate(e.target.value);\r\n              }}\r\n            />\r\n          </div>\r\n          <div>\r\n            <label className=\"block text-sm text-gray-600 mb-1\">Hasta</label>\r\n            <input\r\n              type=\"date\"\r\n              className=\"w-full border rounded px-2 py-1\"\r\n              value={toDate}\r\n              min={fromDate}\r\n              onChange={(e) => {\r\n                setPage(1);\r\n                setToDate(e.target.value);\r\n              }}\r\n            />\r\n          </div>\r\n          <div>\r\n            <label className=\"block text-sm text-gray-600 mb-1\">Buscar</label>\r\n            <input\r\n              type=\"text\"\r\n              placeholder=\"Usuario, username o punto\"\r\n              className=\"w-full border rounded px-2 py-1\"\r\n              value={searchTerm}\r\n              onChange={(e) => {\r\n                setPage(1);\r\n                setSearchTerm(e.target.value);\r\n              }}\r\n            />\r\n          </div>\r\n          <div>\r\n            <label className=\"block text-sm text-gray-600 mb-1\">\r\n              Tama├▒o de p├ígina\r\n            </label>\r\n            <select\r\n              className=\"w-full border rounded px-2 py-1\"\r\n              value={pageSize}\r\n              onChange={(e) => {\r\n                setPage(1);\r\n                setPageSize(Number(e.target.value));\r\n              }}\r\n            >\r\n              <option value={10}>10</option>\r\n              <option value={20}>20</option>\r\n              <option value={50}>50</option>\r\n              <option value={100}>100</option>\r\n            </select>\r\n          </div>\r\n          <div className=\"flex items-end justify-between gap-2\">\r\n            <label className=\"inline-flex items-center gap-2 text-sm\">\r\n              <input\r\n                type=\"checkbox\"\r\n                className=\"h-4 w-4\"\r\n                checked={onlyActive}\r\n                onChange={(e) => {\r\n                  setPage(1);\r\n                  setOnlyActive(e.target.checked);\r\n                }}\r\n              />\r\n              Solo activos del per├¡odo (incluye ALMUERZO)\r\n            </label>\r\n            <Button\r\n              variant=\"outline\"\r\n              onClick={() => {\r\n                setFromDate(todayStr);\r\n                setToDate(todayStr);\r\n                setOnlyActive(true);\r\n                setSearchTerm(\"\");\r\n                setPage(1);\r\n              }}\r\n            >\r\n              Limpiar filtros\r\n            </Button>\r\n          </div>\r\n        </div>\r\n      </div>\r\n\r\n      {activeSchedules.length === 0 ? (\r\n        <Card>\r\n          <CardContent className=\"flex items-center justify-center h-32\">\r\n            <div className=\"text-center\">\r\n              <User className=\"h-12 w-12 text-gray-400 mx-auto mb-2\" />\r\n              <p className=\"text-gray-500\">\r\n                No hay usuarios trabajando actualmente\r\n              </p>\r\n            </div>\r\n          </CardContent>\r\n        </Card>\r\n      ) : (\r\n        <>\r\n          <div className=\"grid gap-4\">\r\n            {activeSchedules.map((schedule) => (\r\n              <Card key={schedule.id} className=\"overflow-hidden\">\r\n                <CardHeader className=\"pb-3\">\r\n                  <div className=\"flex items-center justify-between\">\r\n                    <div className=\"flex items-center space-x-3\">\r\n                      <div className=\"w-10 h-10 bg-blue-100 rounded-full flex items-center justify-center\">\r\n                        <User className=\"h-5 w-5 text-blue-600\" />\r\n                      </div>\r\n                      <div>\r\n                        <CardTitle className=\"text-lg\">\r\n                          {schedule.usuario.nombre}\r\n                        </CardTitle>\r\n                        <p className=\"text-sm text-gray-600\">\r\n                          @{schedule.usuario.username}\r\n                        </p>\r\n                      </div>\r\n                    </div>\r\n                    <div className=\"text-right space-y-2\">\r\n                      <div>\r\n                        <Badge variant=\"secondary\" className=\"mb-1\">\r\n                          {schedule.puntoAtencion.nombre}\r\n                        </Badge>\r\n                        <p className=\"text-sm text-gray-600\">\r\n                          Trabajando: {getWorkingHours(schedule.fecha_inicio)}\r\n                        </p>\r\n                      </div>\r\n                      {/* Bot├│n visible solo para ADMIN/SUPER: libera el punto moviendo la jornada al principal */}\r\n                      <FreePointButton\r\n                        usuarioId={schedule.usuario.id}\r\n                        onDone={loadActiveSchedules}\r\n                      />\r\n                    </div>\r\n                  </div>\r\n                </CardHeader>\r\n\r\n                <CardContent>\r\n                  <Tabs defaultValue=\"schedule\" className=\"w-full\">\r\n                    <TabsList className=\"grid w-full grid-cols-2\">\r\n                      <TabsTrigger value=\"schedule\">Horarios</TabsTrigger>\r\n                      <TabsTrigger value=\"location\">Ubicaciones</TabsTrigger>\r\n                    </TabsList>\r\n\r\n                    <TabsContent\r\n                      value=\"schedule\"\r\n                      className=\"grid grid-cols-2 md:grid-cols-4 gap-4 pt-4\"\r\n                    >\r\n                      {[\r\n                        {\r\n                          label: \"Entrada\",\r\n                          value: schedule.fecha_inicio,\r\n                          color: \"text-green-600\",\r\n                        },\r\n                        {\r\n                          label: \"Almuerzo\",\r\n                          value: schedule.fecha_almuerzo,\r\n                          color: \"text-orange-600\",\r\n                        },\r\n                        {\r\n                          label: \"Regreso\",\r\n                          value: schedule.fecha_regreso,\r\n                          color: \"text-blue-600\",\r\n                        },\r\n                        {\r\n                          label: \"Salida\",\r\n                          value: schedule.fecha_salida,\r\n                          color: \"text-red-600\",\r\n                        },\r\n                      ].map(({ label, value, color }) => (\r\n                        <div key={label} className=\"space-y-1\">\r\n                          <div className=\"flex items-center text-sm text-gray-600\">\r\n                            <Clock className=\"h-4 w-4 mr-1\" />\r\n                            {label}\r\n                          </div>\r\n                          <p className={`font-medium ${color}`}>\r\n                            {formatTime(value)}\r\n                          </p>\r\n                        </div>\r\n                      ))}\r\n                    </TabsContent>\r\n\r\n                    <TabsContent\r\n                      value=\"location\"\r\n                      className=\"grid grid-cols-1 md:grid-cols-2 gap-4 pt-4\"\r\n                    >\r\n                      <div className=\"space-y-2\">\r\n                        <div className=\"flex items-center text-sm text-gray-600\">\r\n                          <MapPin className=\"h-4 w-4 mr-1\" />\r\n                          Ubicaci├│n de Entrada\r\n                        </div>\r\n                        <p className=\"text-sm bg-green-50 p-2 rounded border\">\r\n                          {getLocationString(schedule.ubicacion_inicio)}\r\n                        </p>\r\n                      </div>\r\n                      <div className=\"space-y-2\">\r\n                        <div className=\"flex items-center text-sm text-gray-600\">\r\n                          <MapPin className=\"h-4 w-4 mr-1\" />\r\n                          Ubicaci├│n de Salida\r\n                        </div>\r\n                        <p className=\"text-sm bg-red-50 p-2 rounded border\">\r\n                          {getLocationString(schedule.ubicacion_salida)}\r\n                        </p>\r\n                      </div>\r\n                    </TabsContent>\r\n                  </Tabs>\r\n                </CardContent>\r\n              </Card>\r\n            ))}\r\n          </div>\r\n        </>\r\n      )}\r\n    </div>\r\n  );\r\n};\r\n\r\nexport default ActivePointsReport;\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\oswal\\OneDrive\\Documentos\\Punto Cambio\\punto_cambio_new\\src\\components\\admin\\CierresDiariosResumen.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\oswal\\OneDrive\\Documentos\\Punto Cambio\\punto_cambio_new\\src\\components\\admin\\ContabilidadPorPunto.tsx","messages":[{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'gyeDayRangeUtcFromDate' is defined but never used. Allowed unused vars must match /^_/u.","line":28,"column":10,"nodeType":null,"messageId":"unusedVar","endLine":28,"endColumn":32},{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'user' is defined but never used. Allowed unused args must match /^_/u.","line":72,"column":40,"nodeType":null,"messageId":"unusedVar","endLine":72,"endColumn":44},{"ruleId":"no-console","severity":1,"message":"Unexpected console statement. Only these console methods are allowed: warn, error.","line":99,"column":9,"nodeType":"MemberExpression","messageId":"limited","endLine":99,"endColumn":20,"suggestions":[{"fix":{"range":[2852,2907],"text":""},"messageId":"removeConsole","data":{"propertyName":"log"},"desc":"Remove the console.log()."}]},{"ruleId":"no-console","severity":1,"message":"Unexpected console statement. Only these console methods are allowed: warn, error.","line":102,"column":9,"nodeType":"MemberExpression","messageId":"limited","endLine":102,"endColumn":20,"suggestions":[{"fix":{"range":[3020,3158],"text":""},"messageId":"removeConsole","data":{"propertyName":"log"},"desc":"Remove the console.log()."}]},{"ruleId":"no-console","severity":1,"message":"Unexpected console statement. Only these console methods are allowed: warn, error.","line":110,"column":11,"nodeType":"MemberExpression","messageId":"limited","endLine":110,"endColumn":22,"suggestions":[{"fix":{"range":[3309,3450],"text":""},"messageId":"removeConsole","data":{"propertyName":"log"},"desc":"Remove the console.log()."}]},{"ruleId":"no-console","severity":1,"message":"Unexpected console statement. Only these console methods are allowed: warn, error.","line":121,"column":9,"nodeType":"MemberExpression","messageId":"limited","endLine":121,"endColumn":20,"suggestions":[{"fix":{"range":[3647,3712],"text":""},"messageId":"removeConsole","data":{"propertyName":"log"},"desc":"Remove the console.log()."}]},{"ruleId":"react-hooks/exhaustive-deps","severity":1,"message":"React Hook useEffect has a missing dependency: 'loadContabilidadData'. Either include it or remove the dependency array.","line":135,"column":6,"nodeType":"ArrayExpression","endLine":135,"endColumn":61,"suggestions":[{"desc":"Update the dependencies array to be: [selectedPointId, selectedCurrency, startDate, endDate, loadContabilidadData]","fix":{"range":[4045,4100],"text":"[selectedPointId, selectedCurrency, startDate, endDate, loadContabilidadData]"}}]},{"ruleId":"no-console","severity":1,"message":"Unexpected console statement. Only these console methods are allowed: warn, error.","line":146,"column":7,"nodeType":"MemberExpression","messageId":"limited","endLine":146,"endColumn":18,"suggestions":[{"fix":{"range":[4419,4646],"text":""},"messageId":"removeConsole","data":{"propertyName":"log"},"desc":"Remove the console.log()."}]},{"ruleId":"no-console","severity":1,"message":"Unexpected console statement. Only these console methods are allowed: warn, error.","line":155,"column":9,"nodeType":"MemberExpression","messageId":"limited","endLine":155,"endColumn":20,"suggestions":[{"fix":{"range":[4706,4844],"text":""},"messageId":"removeConsole","data":{"propertyName":"log"},"desc":"Remove the console.log()."}]},{"ruleId":"no-console","severity":1,"message":"Unexpected console statement. Only these console methods are allowed: warn, error.","line":163,"column":9,"nodeType":"MemberExpression","messageId":"limited","endLine":163,"endColumn":20,"suggestions":[{"fix":{"range":[5020,5072],"text":""},"messageId":"removeConsole","data":{"propertyName":"log"},"desc":"Remove the console.log()."}]},{"ruleId":"no-console","severity":1,"message":"Unexpected console statement. Only these console methods are allowed: warn, error.","line":168,"column":9,"nodeType":"MemberExpression","messageId":"limited","endLine":168,"endColumn":20,"suggestions":[{"fix":{"range":[5269,5326],"text":""},"messageId":"removeConsole","data":{"propertyName":"log"},"desc":"Remove the console.log()."}]},{"ruleId":"no-console","severity":1,"message":"Unexpected console statement. Only these console methods are allowed: warn, error.","line":178,"column":9,"nodeType":"MemberExpression","messageId":"limited","endLine":178,"endColumn":20,"suggestions":[{"fix":{"range":[5791,5842],"text":""},"messageId":"removeConsole","data":{"propertyName":"log"},"desc":"Remove the console.log()."}]},{"ruleId":"no-console","severity":1,"message":"Unexpected console statement. Only these console methods are allowed: warn, error.","line":182,"column":9,"nodeType":"MemberExpression","messageId":"limited","endLine":182,"endColumn":20,"suggestions":[{"fix":{"range":[5964,6022],"text":""},"messageId":"removeConsole","data":{"propertyName":"log"},"desc":"Remove the console.log()."}]},{"ruleId":"no-console","severity":1,"message":"Unexpected console statement. Only these console methods are allowed: warn, error.","line":196,"column":9,"nodeType":"MemberExpression","messageId":"limited","endLine":196,"endColumn":20,"suggestions":[{"fix":{"range":[6526,6577],"text":""},"messageId":"removeConsole","data":{"propertyName":"log"},"desc":"Remove the console.log()."}]},{"ruleId":"no-console","severity":1,"message":"Unexpected console statement. Only these console methods are allowed: warn, error.","line":201,"column":9,"nodeType":"MemberExpression","messageId":"limited","endLine":201,"endColumn":20,"suggestions":[{"fix":{"range":[6771,6827],"text":""},"messageId":"removeConsole","data":{"propertyName":"log"},"desc":"Remove the console.log()."}]}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":15,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import { useState, useEffect, useMemo } from \"react\";\r\nimport { Card, CardContent, CardHeader, CardTitle } from \"@/components/ui/card\";\r\nimport { Button } from \"@/components/ui/button\";\r\nimport { Badge } from \"@/components/ui/badge\";\r\nimport {\r\n  Select,\r\n  SelectContent,\r\n  SelectItem,\r\n  SelectTrigger,\r\n  SelectValue,\r\n} from \"@/components/ui/select\";\r\nimport {\r\n  Calculator,\r\n  TrendingUp,\r\n  TrendingDown,\r\n  RefreshCw,\r\n  DollarSign,\r\n  Wallet,\r\n  ArrowUpCircle,\r\n  ArrowDownCircle,\r\n  BarChart3,\r\n  Calendar,\r\n} from \"lucide-react\";\r\nimport { User, PuntoAtencion, Moneda } from \"@/types\";\r\nimport { pointService } from \"@/services/pointService\";\r\nimport { currencyService } from \"@/services/currencyService\";\r\nimport { apiService } from \"@/services/apiService\";\r\nimport { gyeDayRangeUtcFromDate } from \"@/utils/timezone\";\r\n\r\ninterface ContabilidadPorPuntoProps {\r\n  user: User;\r\n}\r\n\r\ninterface SaldoInicial {\r\n  id: string;\r\n  punto_atencion_id: string;\r\n  moneda_id: string;\r\n  cantidad_inicial: number;\r\n  asignado_por: string;\r\n  observaciones?: string;\r\n  activo: boolean;\r\n  created_at: string;\r\n  moneda_nombre?: string;\r\n  moneda_codigo?: string;\r\n  moneda_simbolo?: string;\r\n  punto_nombre?: string;\r\n  ciudad?: string;\r\n}\r\n\r\ninterface MovimientoSaldo {\r\n  id: string;\r\n  punto_atencion_id: string;\r\n  moneda_codigo: string;\r\n  tipo_movimiento: string;\r\n  monto: number;\r\n  fecha: string;\r\n  descripcion?: string;\r\n  tipo_referencia?: string;\r\n  referencia_id?: string;\r\n}\r\n\r\ninterface SaldoActual {\r\n  moneda_id: string;\r\n  moneda_codigo: string | null;\r\n  moneda_nombre: string | null;\r\n  moneda_simbolo: string | null;\r\n  saldo: number;\r\n  saldo_calculado?: number;\r\n  diferencia?: number;\r\n}\r\n\r\nexport const ContabilidadPorPunto = ({ user }: ContabilidadPorPuntoProps) => {\r\n  const [points, setPoints] = useState<PuntoAtencion[]>([]);\r\n  const [currencies, setCurrencies] = useState<Moneda[]>([]);\r\n  const [selectedPointId, setSelectedPointId] = useState<string>(\"\");\r\n  const [selectedCurrency, setSelectedCurrency] = useState<string>(\"USD\");\r\n  const [startDate, setStartDate] = useState<string>(\"\");\r\n  const [endDate, setEndDate] = useState<string>(\"\");\r\n  const [isLoading, setIsLoading] = useState(false);\r\n\r\n  // Datos\r\n  const [saldoInicial, setSaldoInicial] = useState<number>(0);\r\n  const [movimientos, setMovimientos] = useState<MovimientoSaldo[]>([]);\r\n  const [saldoActual, setSaldoActual] = useState<number>(0);\r\n\r\n  // Inicializar fechas (hoy)\r\n  useEffect(() => {\r\n    const today = new Date();\r\n    const todayStr = today.toISOString().split(\"T\")[0];\r\n    setStartDate(todayStr);\r\n    setEndDate(todayStr);\r\n  }, []);\r\n\r\n  // Cargar puntos y monedas\r\n  useEffect(() => {\r\n    const loadInitialData = async () => {\r\n      try {\r\n        // Cargar puntos - usar endpoint espec├¡fico para gesti├│n de saldos\r\n        console.log(\"­ƒöì Cargando puntos para contabilidad...\");\r\n        const { points: pointsData } =\r\n          await pointService.getPointsForBalanceManagement();\r\n        console.log(\r\n          \"­ƒôì Puntos cargados:\",\r\n          pointsData?.length || 0,\r\n          pointsData?.map((p) => p.nombre)\r\n        );\r\n        setPoints(pointsData || []);\r\n        if (pointsData && pointsData.length > 0) {\r\n          setSelectedPointId(pointsData[0].id);\r\n          console.log(\r\n            \"Ô£à Punto seleccionado por defecto:\",\r\n            pointsData[0].nombre,\r\n            pointsData[0].id\r\n          );\r\n        }\r\n\r\n        // Cargar monedas\r\n        const { currencies: currenciesData } =\r\n          await currencyService.getAllCurrencies();\r\n        setCurrencies(currenciesData || []);\r\n        console.log(\"­ƒÆ▒ Monedas cargadas:\", currenciesData?.length || 0);\r\n      } catch (error) {\r\n        console.error(\"ÔØî Error cargando datos iniciales:\", error);\r\n      }\r\n    };\r\n\r\n    loadInitialData();\r\n  }, []);\r\n\r\n  // Cargar datos cuando cambian los filtros\r\n  useEffect(() => {\r\n    if (selectedPointId && selectedCurrency && startDate && endDate) {\r\n      loadContabilidadData();\r\n    }\r\n  }, [selectedPointId, selectedCurrency, startDate, endDate]);\r\n\r\n  const loadContabilidadData = async () => {\r\n    if (!selectedPointId || !selectedCurrency) return;\r\n\r\n    setIsLoading(true);\r\n    try {\r\n      // Obtener rango de fechas en UTC\r\n      const startDateTime = new Date(startDate + \"T00:00:00\");\r\n      const endDateTime = new Date(endDate + \"T23:59:59\");\r\n\r\n      console.log(\"­ƒöì Cargando datos de contabilidad:\", {\r\n        punto: selectedPointId,\r\n        moneda: selectedCurrency,\r\n        fechaInicio: startDateTime.toISOString(),\r\n        fechaFin: endDateTime.toISOString(),\r\n      });\r\n\r\n      // 1. Obtener saldo inicial\r\n      try {\r\n        console.log(\r\n          \"­ƒöæ Token en localStorage:\",\r\n          localStorage.getItem(\"authToken\") ? \"Ô£à Existe\" : \"ÔØî No existe\"\r\n        );\r\n        const data = await apiService.get<{\r\n          saldos: SaldoInicial[];\r\n          success: boolean;\r\n        }>(`/api/saldos-iniciales/${selectedPointId}`);\r\n        console.log(\"­ƒôè Saldos iniciales recibidos:\", data);\r\n        const saldosIniciales: SaldoInicial[] = data?.saldos || [];\r\n        const saldoMoneda = saldosIniciales.find(\r\n          (s) => s.moneda_codigo === selectedCurrency\r\n        );\r\n        console.log(\"­ƒÆ░ Saldo inicial encontrado:\", saldoMoneda);\r\n        setSaldoInicial(saldoMoneda?.cantidad_inicial || 0);\r\n      } catch (error) {\r\n        console.error(\"ÔØî Error al obtener saldos iniciales:\", error);\r\n        setSaldoInicial(0);\r\n      }\r\n\r\n      // 2. Obtener movimientos del per├¡odo\r\n      try {\r\n        const movimientosUrl = `/api/movimientos-saldo?puntoId=${selectedPointId}&monedaCodigo=${selectedCurrency}&fechaInicio=${startDateTime.toISOString()}&fechaFin=${endDateTime.toISOString()}`;\r\n        console.log(\"­ƒöù URL movimientos:\", movimientosUrl);\r\n        const movimientosData = await apiService.get<MovimientoSaldo[]>(\r\n          movimientosUrl\r\n        );\r\n        console.log(\"­ƒôê Movimientos recibidos:\", movimientosData);\r\n        // El endpoint devuelve directamente un array\r\n        setMovimientos(Array.isArray(movimientosData) ? movimientosData : []);\r\n      } catch (error) {\r\n        console.error(\"ÔØî Error al obtener movimientos:\", error);\r\n        setMovimientos([]);\r\n      }\r\n\r\n      // 3. Obtener saldo actual\r\n      try {\r\n        const data = await apiService.get<{\r\n          saldos: SaldoActual[];\r\n          success: boolean;\r\n        }>(`/api/saldos-actuales/${selectedPointId}?reconciliar=true`);\r\n        console.log(\"­ƒÆÁ Saldos actuales recibidos:\", data);\r\n        const saldosActuales: SaldoActual[] = data?.saldos || [];\r\n        const saldoMoneda = saldosActuales.find(\r\n          (s) => s.moneda_codigo === selectedCurrency\r\n        );\r\n        console.log(\"­ƒÆ© Saldo actual encontrado:\", saldoMoneda);\r\n        // Preferir saldo calculado (desde movimientos) cuando est├® presente\r\n        const saldoPreferido =\r\n          typeof saldoMoneda?.saldo_calculado === \"number\"\r\n            ? saldoMoneda.saldo_calculado\r\n            : saldoMoneda?.saldo;\r\n        setSaldoActual(saldoPreferido || 0);\r\n      } catch (error) {\r\n        console.error(\"ÔØî Error al obtener saldos actuales:\", error);\r\n        setSaldoActual(0);\r\n      }\r\n    } catch (error) {\r\n      console.error(\"ÔØî Error cargando datos de contabilidad:\", error);\r\n    } finally {\r\n      setIsLoading(false);\r\n    }\r\n  };\r\n\r\n  // Calcular estad├¡sticas\r\n  const estadisticas = useMemo(() => {\r\n    const ingresos = movimientos\r\n      .filter(\r\n        (m) =>\r\n          m.tipo_movimiento === \"INGRESO\" ||\r\n          m.tipo_movimiento === \"TRANSFERENCIA_ENTRANTE\"\r\n      )\r\n      .reduce((sum, m) => sum + Math.abs(m.monto), 0);\r\n\r\n    const egresos = movimientos\r\n      .filter(\r\n        (m) =>\r\n          m.tipo_movimiento === \"EGRESO\" ||\r\n          m.tipo_movimiento === \"TRANSFERENCIA_SALIENTE\"\r\n      )\r\n      .reduce((sum, m) => sum + Math.abs(m.monto), 0);\r\n\r\n    const balance = ingresos - egresos;\r\n\r\n    // Contar cambios ├║nicos\r\n    const cambiosSet = new Set<string>();\r\n    movimientos.forEach((m) => {\r\n      if (m.tipo_referencia === \"CAMBIO_DIVISA\" && m.referencia_id) {\r\n        cambiosSet.add(m.referencia_id);\r\n      }\r\n    });\r\n\r\n    return {\r\n      ingresos,\r\n      egresos,\r\n      balance,\r\n      cambios: cambiosSet.size,\r\n    };\r\n  }, [movimientos]);\r\n\r\n  const formatCurrency = (amount: number, codigo = selectedCurrency) => {\r\n    if (codigo === \"USD\") {\r\n      return new Intl.NumberFormat(\"en-US\", {\r\n        style: \"currency\",\r\n        currency: \"USD\",\r\n        minimumFractionDigits: 2,\r\n      }).format(amount);\r\n    }\r\n\r\n    return new Intl.NumberFormat(\"es-ES\", {\r\n      minimumFractionDigits: 2,\r\n      maximumFractionDigits: 2,\r\n    }).format(amount);\r\n  };\r\n\r\n  const selectedPoint = points.find((p) => p.id === selectedPointId);\r\n\r\n  return (\r\n    <div className=\"p-3 sm:p-4 md:p-6 space-y-4 sm:space-y-6\">\r\n      {/* Encabezado */}\r\n      <div className=\"flex items-center justify-between\">\r\n        <div>\r\n          <h1 className=\"text-2xl font-bold text-gray-800 flex items-center gap-2\">\r\n            <Calculator className=\"h-6 w-6 text-blue-600\" />\r\n            Control de Contabilidad por Punto\r\n          </h1>\r\n          <p className=\"text-gray-600 mt-1\">\r\n            Monitoreo detallado de ingresos, egresos y saldos por punto de\r\n            atenci├│n\r\n          </p>\r\n        </div>\r\n        <Button\r\n          onClick={loadContabilidadData}\r\n          disabled={isLoading}\r\n          variant=\"outline\"\r\n        >\r\n          <RefreshCw\r\n            className={`h-4 w-4 mr-2 ${isLoading ? \"animate-spin\" : \"\"}`}\r\n          />\r\n          Actualizar\r\n        </Button>\r\n      </div>\r\n\r\n      {/* Filtros */}\r\n      <Card>\r\n        <CardHeader>\r\n          <CardTitle className=\"text-lg flex items-center gap-2\">\r\n            <BarChart3 className=\"h-5 w-5\" />\r\n            Filtros de Consulta\r\n          </CardTitle>\r\n        </CardHeader>\r\n        <CardContent>\r\n          <div className=\"grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4\">\r\n            {/* Punto de Atenci├│n */}\r\n            <div className=\"space-y-2\">\r\n              <label className=\"text-sm font-medium text-gray-700\">\r\n                Punto de Atenci├│n\r\n              </label>\r\n              <Select\r\n                value={selectedPointId}\r\n                onValueChange={setSelectedPointId}\r\n              >\r\n                <SelectTrigger>\r\n                  <SelectValue placeholder=\"Seleccionar punto\" />\r\n                </SelectTrigger>\r\n                <SelectContent>\r\n                  {Array.isArray(points) &&\r\n                    points.map((point) => (\r\n                      <SelectItem key={point.id} value={point.id}>\r\n                        {point.nombre}\r\n                      </SelectItem>\r\n                    ))}\r\n                </SelectContent>\r\n              </Select>\r\n            </div>\r\n\r\n            {/* Moneda */}\r\n            <div className=\"space-y-2\">\r\n              <label className=\"text-sm font-medium text-gray-700\">\r\n                Moneda\r\n              </label>\r\n              <Select\r\n                value={selectedCurrency}\r\n                onValueChange={setSelectedCurrency}\r\n              >\r\n                <SelectTrigger>\r\n                  <SelectValue placeholder=\"Seleccionar moneda\" />\r\n                </SelectTrigger>\r\n                <SelectContent>\r\n                  {Array.isArray(currencies) &&\r\n                    currencies.map((currency) => (\r\n                      <SelectItem key={currency.codigo} value={currency.codigo}>\r\n                        {currency.codigo} - {currency.nombre}\r\n                      </SelectItem>\r\n                    ))}\r\n                </SelectContent>\r\n              </Select>\r\n            </div>\r\n\r\n            {/* Fecha Inicio */}\r\n            <div className=\"space-y-2\">\r\n              <label className=\"text-sm font-medium text-gray-700\">\r\n                Fecha Inicio\r\n              </label>\r\n              <div className=\"relative\">\r\n                <Calendar className=\"absolute left-3 top-1/2 transform -translate-y-1/2 h-4 w-4 text-gray-400\" />\r\n                <input\r\n                  type=\"date\"\r\n                  value={startDate}\r\n                  onChange={(e) => setStartDate(e.target.value)}\r\n                  className=\"w-full pl-10 pr-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500\"\r\n                />\r\n              </div>\r\n            </div>\r\n\r\n            {/* Fecha Fin */}\r\n            <div className=\"space-y-2\">\r\n              <label className=\"text-sm font-medium text-gray-700\">\r\n                Fecha Fin\r\n              </label>\r\n              <div className=\"relative\">\r\n                <Calendar className=\"absolute left-3 top-1/2 transform -translate-y-1/2 h-4 w-4 text-gray-400\" />\r\n                <input\r\n                  type=\"date\"\r\n                  value={endDate}\r\n                  onChange={(e) => setEndDate(e.target.value)}\r\n                  className=\"w-full pl-10 pr-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500\"\r\n                />\r\n              </div>\r\n            </div>\r\n          </div>\r\n        </CardContent>\r\n      </Card>\r\n\r\n      {/* Informaci├│n del Punto Seleccionado */}\r\n      {selectedPoint && (\r\n        <div className=\"bg-blue-50 border border-blue-200 rounded-lg p-4\">\r\n          <div className=\"flex items-center justify-between\">\r\n            <div>\r\n              <h3 className=\"font-semibold text-blue-900\">\r\n                {selectedPoint.nombre}\r\n              </h3>\r\n              <p className=\"text-sm text-blue-700\">\r\n                {selectedPoint.direccion || \"Sin direcci├│n\"}\r\n              </p>\r\n            </div>\r\n            <Badge variant=\"outline\" className=\"bg-white\">\r\n              {selectedPoint.activo ? \"Activo\" : \"Inactivo\"}\r\n            </Badge>\r\n          </div>\r\n        </div>\r\n      )}\r\n\r\n      {/* Alerta cuando no hay saldo inicial */}\r\n      {!isLoading &&\r\n        saldoInicial === 0 &&\r\n        saldoActual === 0 &&\r\n        movimientos.length === 0 && (\r\n          <div className=\"bg-yellow-50 border border-yellow-200 rounded-lg p-4\">\r\n            <div className=\"flex items-start gap-3\">\r\n              <div className=\"flex-shrink-0\">\r\n                <svg\r\n                  className=\"h-5 w-5 text-yellow-600\"\r\n                  fill=\"currentColor\"\r\n                  viewBox=\"0 0 20 20\"\r\n                >\r\n                  <path\r\n                    fillRule=\"evenodd\"\r\n                    d=\"M8.257 3.099c.765-1.36 2.722-1.36 3.486 0l5.58 9.92c.75 1.334-.213 2.98-1.742 2.98H4.42c-1.53 0-2.493-1.646-1.743-2.98l5.58-9.92zM11 13a1 1 0 11-2 0 1 1 0 012 0zm-1-8a1 1 0 00-1 1v3a1 1 0 002 0V6a1 1 0 00-1-1z\"\r\n                    clipRule=\"evenodd\"\r\n                  />\r\n                </svg>\r\n              </div>\r\n              <div className=\"flex-1\">\r\n                <h3 className=\"text-sm font-semibold text-yellow-800 mb-1\">\r\n                  No hay datos disponibles\r\n                </h3>\r\n                <p className=\"text-sm text-yellow-700\">\r\n                  No se encontr├│ saldo inicial ni movimientos para{\" \"}\r\n                  <strong>{selectedPoint?.nombre}</strong> en{\" \"}\r\n                  <strong>{selectedCurrency}</strong>. Es posible que necesites:\r\n                </p>\r\n                <ul className=\"mt-2 text-sm text-yellow-700 list-disc list-inside space-y-1\">\r\n                  <li>\r\n                    Asignar un saldo inicial para esta moneda en este punto\r\n                  </li>\r\n                  <li>\r\n                    Verificar que existan transacciones en el rango de fechas\r\n                    seleccionado\r\n                  </li>\r\n                  <li>\r\n                    Seleccionar una moneda diferente que tenga movimientos\r\n                  </li>\r\n                </ul>\r\n              </div>\r\n            </div>\r\n          </div>\r\n        )}\r\n\r\n      {/* Tarjetas de M├®tricas */}\r\n      <div className=\"grid grid-cols-1 md:grid-cols-2 lg:grid-cols-5 gap-4\">\r\n        {/* Saldo Inicial */}\r\n        <Card className=\"bg-gradient-to-br from-purple-50 to-purple-100 border-purple-200\">\r\n          <CardContent className=\"p-4\">\r\n            <div className=\"flex items-center justify-between\">\r\n              <div>\r\n                <p className=\"text-sm font-medium text-purple-700\">\r\n                  Saldo Inicial\r\n                </p>\r\n                <p className=\"text-2xl font-bold text-purple-900\">\r\n                  {formatCurrency(saldoInicial)}\r\n                </p>\r\n                <p className=\"text-xs text-purple-600 mt-1\">\r\n                  {selectedCurrency}\r\n                </p>\r\n              </div>\r\n              <Wallet className=\"h-8 w-8 text-purple-600\" />\r\n            </div>\r\n          </CardContent>\r\n        </Card>\r\n\r\n        {/* Ingresos */}\r\n        <Card className=\"bg-gradient-to-br from-green-50 to-green-100 border-green-200\">\r\n          <CardContent className=\"p-4\">\r\n            <div className=\"flex items-center justify-between\">\r\n              <div>\r\n                <p className=\"text-sm font-medium text-green-700\">Ingresos</p>\r\n                <p className=\"text-2xl font-bold text-green-900\">\r\n                  {formatCurrency(estadisticas.ingresos)}\r\n                </p>\r\n                <p className=\"text-xs text-green-600 mt-1\">\r\n                  {selectedCurrency}\r\n                </p>\r\n              </div>\r\n              <ArrowUpCircle className=\"h-8 w-8 text-green-600\" />\r\n            </div>\r\n          </CardContent>\r\n        </Card>\r\n\r\n        {/* Egresos */}\r\n        <Card className=\"bg-gradient-to-br from-red-50 to-red-100 border-red-200\">\r\n          <CardContent className=\"p-4\">\r\n            <div className=\"flex items-center justify-between\">\r\n              <div>\r\n                <p className=\"text-sm font-medium text-red-700\">Egresos</p>\r\n                <p className=\"text-2xl font-bold text-red-900\">\r\n                  {formatCurrency(estadisticas.egresos)}\r\n                </p>\r\n                <p className=\"text-xs text-red-600 mt-1\">{selectedCurrency}</p>\r\n              </div>\r\n              <ArrowDownCircle className=\"h-8 w-8 text-red-600\" />\r\n            </div>\r\n          </CardContent>\r\n        </Card>\r\n\r\n        {/* Balance del Per├¡odo */}\r\n        <Card\r\n          className={`bg-gradient-to-br ${\r\n            estadisticas.balance >= 0\r\n              ? \"from-blue-50 to-blue-100 border-blue-200\"\r\n              : \"from-orange-50 to-orange-100 border-orange-200\"\r\n          }`}\r\n        >\r\n          <CardContent className=\"p-4\">\r\n            <div className=\"flex items-center justify-between\">\r\n              <div>\r\n                <p\r\n                  className={`text-sm font-medium ${\r\n                    estadisticas.balance >= 0\r\n                      ? \"text-blue-700\"\r\n                      : \"text-orange-700\"\r\n                  }`}\r\n                >\r\n                  Balance Per├¡odo\r\n                </p>\r\n                <p\r\n                  className={`text-2xl font-bold ${\r\n                    estadisticas.balance >= 0\r\n                      ? \"text-blue-900\"\r\n                      : \"text-orange-900\"\r\n                  }`}\r\n                >\r\n                  {formatCurrency(estadisticas.balance)}\r\n                </p>\r\n                <p\r\n                  className={`text-xs mt-1 ${\r\n                    estadisticas.balance >= 0\r\n                      ? \"text-blue-600\"\r\n                      : \"text-orange-600\"\r\n                  }`}\r\n                >\r\n                  {selectedCurrency}\r\n                </p>\r\n              </div>\r\n              {estadisticas.balance >= 0 ? (\r\n                <TrendingUp className=\"h-8 w-8 text-blue-600\" />\r\n              ) : (\r\n                <TrendingDown className=\"h-8 w-8 text-orange-600\" />\r\n              )}\r\n            </div>\r\n          </CardContent>\r\n        </Card>\r\n\r\n        {/* Saldo Actual */}\r\n        <Card className=\"bg-gradient-to-br from-indigo-50 to-indigo-100 border-indigo-200\">\r\n          <CardContent className=\"p-4\">\r\n            <div className=\"flex items-center justify-between\">\r\n              <div>\r\n                <p className=\"text-sm font-medium text-indigo-700\">\r\n                  Saldo Actual\r\n                </p>\r\n                <p className=\"text-2xl font-bold text-indigo-900\">\r\n                  {formatCurrency(saldoActual)}\r\n                </p>\r\n                <p className=\"text-xs text-indigo-600 mt-1\">\r\n                  {selectedCurrency}\r\n                </p>\r\n              </div>\r\n              <DollarSign className=\"h-8 w-8 text-indigo-600\" />\r\n            </div>\r\n          </CardContent>\r\n        </Card>\r\n      </div>\r\n\r\n      {/* Resumen de Operaciones */}\r\n      <Card>\r\n        <CardHeader>\r\n          <CardTitle className=\"text-lg\">Resumen de Operaciones</CardTitle>\r\n        </CardHeader>\r\n        <CardContent>\r\n          <div className=\"grid grid-cols-1 md:grid-cols-2 xl:grid-cols-3 gap-3 sm:gap-4 md:gap-6\">\r\n            <div className=\"text-center p-4 bg-gray-50 rounded-lg\">\r\n              <p className=\"text-sm text-gray-600 mb-1\">Total Movimientos</p>\r\n              <p className=\"text-3xl font-bold text-gray-900\">\r\n                {movimientos.length}\r\n              </p>\r\n            </div>\r\n            <div className=\"text-center p-4 bg-gray-50 rounded-lg\">\r\n              <p className=\"text-sm text-gray-600 mb-1\">Cambios Realizados</p>\r\n              <p className=\"text-3xl font-bold text-blue-600\">\r\n                {estadisticas.cambios}\r\n              </p>\r\n            </div>\r\n            <div className=\"text-center p-4 bg-gray-50 rounded-lg\">\r\n              <p className=\"text-sm text-gray-600 mb-1\">Variaci├│n</p>\r\n              <p\r\n                className={`text-3xl font-bold ${\r\n                  estadisticas.balance >= 0 ? \"text-green-600\" : \"text-red-600\"\r\n                }`}\r\n              >\r\n                {estadisticas.balance >= 0 ? \"+\" : \"\"}\r\n                {((estadisticas.balance / (saldoInicial || 1)) * 100).toFixed(\r\n                  1\r\n                )}\r\n                %\r\n              </p>\r\n            </div>\r\n          </div>\r\n        </CardContent>\r\n      </Card>\r\n\r\n      {/* Tabla de Movimientos */}\r\n      <Card>\r\n        <CardHeader>\r\n          <CardTitle className=\"text-lg\">\r\n            Detalle de Movimientos ({movimientos.length})\r\n          </CardTitle>\r\n        </CardHeader>\r\n        <CardContent>\r\n          {movimientos.length === 0 ? (\r\n            <div className=\"text-center py-12 text-gray-500\">\r\n              <BarChart3 className=\"h-12 w-12 mx-auto mb-3 text-gray-400\" />\r\n              <p>No hay movimientos en el per├¡odo seleccionado</p>\r\n            </div>\r\n          ) : (\r\n            <div className=\"overflow-x-auto\">\r\n              <table className=\"w-full\">\r\n                <thead>\r\n                  <tr className=\"border-b border-gray-200\">\r\n                    <th className=\"text-left py-3 px-4 text-sm font-semibold text-gray-700\">\r\n                      Fecha\r\n                    </th>\r\n                    <th className=\"text-left py-3 px-4 text-sm font-semibold text-gray-700\">\r\n                      Tipo\r\n                    </th>\r\n                    <th className=\"text-left py-3 px-4 text-sm font-semibold text-gray-700\">\r\n                      Descripci├│n\r\n                    </th>\r\n                    <th className=\"text-right py-3 px-4 text-sm font-semibold text-gray-700\">\r\n                      Monto\r\n                    </th>\r\n                  </tr>\r\n                </thead>\r\n                <tbody>\r\n                  {Array.isArray(movimientos) &&\r\n                    movimientos.map((mov) => {\r\n                      const isIngreso =\r\n                        mov.tipo_movimiento === \"INGRESO\" ||\r\n                        mov.tipo_movimiento === \"TRANSFERENCIA_ENTRANTE\";\r\n                      return (\r\n                        <tr\r\n                          key={mov.id}\r\n                          className=\"border-b border-gray-100 hover:bg-gray-50\"\r\n                        >\r\n                          <td className=\"py-3 px-4 text-sm text-gray-600\">\r\n                            {new Date(mov.fecha).toLocaleString(\"es-EC\", {\r\n                              year: \"numeric\",\r\n                              month: \"2-digit\",\r\n                              day: \"2-digit\",\r\n                              hour: \"2-digit\",\r\n                              minute: \"2-digit\",\r\n                            })}\r\n                          </td>\r\n                          <td className=\"py-3 px-4\">\r\n                            <Badge\r\n                              variant={isIngreso ? \"default\" : \"destructive\"}\r\n                              className={\r\n                                isIngreso\r\n                                  ? \"bg-green-100 text-green-800\"\r\n                                  : \"bg-red-100 text-red-800\"\r\n                              }\r\n                            >\r\n                              {mov.tipo_movimiento.replace(/_/g, \" \")}\r\n                            </Badge>\r\n                          </td>\r\n                          <td className=\"py-3 px-4 text-sm text-gray-700\">\r\n                            {mov.descripcion || \"-\"}\r\n                          </td>\r\n                          <td\r\n                            className={`py-3 px-4 text-sm font-semibold text-right ${\r\n                              isIngreso ? \"text-green-600\" : \"text-red-600\"\r\n                            }`}\r\n                          >\r\n                            {isIngreso ? \"+\" : \"-\"}\r\n                            {formatCurrency(Math.abs(mov.monto))}\r\n                          </td>\r\n                        </tr>\r\n                      );\r\n                    })}\r\n                </tbody>\r\n              </table>\r\n            </div>\r\n          )}\r\n        </CardContent>\r\n      </Card>\r\n    </div>\r\n  );\r\n};\r\n\r\nexport default ContabilidadPorPunto;\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\oswal\\OneDrive\\Documentos\\Punto Cambio\\punto_cambio_new\\src\\components\\admin\\CurrencyBehaviorManager.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\oswal\\OneDrive\\Documentos\\Punto Cambio\\punto_cambio_new\\src\\components\\admin\\CurrencyManagement.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\oswal\\OneDrive\\Documentos\\Punto Cambio\\punto_cambio_new\\src\\components\\admin\\EditCurrencyDialog.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\oswal\\OneDrive\\Documentos\\Punto Cambio\\punto_cambio_new\\src\\components\\admin\\EditPointDialog.tsx","messages":[{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'Agencia' is defined but never used. Allowed unused vars must match /^_/u.","line":12,"column":25,"nodeType":null,"messageId":"unusedVar","endLine":12,"endColumn":32}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":1,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import { useState, useEffect } from \"react\";\r\nimport {\r\n  Dialog,\r\n  DialogContent,\r\n  DialogHeader,\r\n  DialogTitle,\r\n  DialogFooter,\r\n} from \"@/components/ui/dialog\";\r\nimport { Button } from \"@/components/ui/button\";\r\nimport { Input } from \"@/components/ui/input\";\r\nimport { Label } from \"@/components/ui/label\";\r\nimport { PuntoAtencion, Agencia } from \"../../types\";\r\nimport { pointService } from \"../../services/pointService\";\r\nimport { AgenciaSelector } from \"@/components/ui/AgenciaSelector\";\r\nimport { toast } from \"@/hooks/use-toast\";\r\n\r\ninterface EditPointDialogProps {\r\n  point: PuntoAtencion;\r\n  isOpen: boolean;\r\n  onClose: () => void;\r\n  onPointUpdated: () => void;\r\n}\r\n\r\nconst EditPointDialog = ({\r\n  point,\r\n  isOpen,\r\n  onClose,\r\n  onPointUpdated,\r\n}: EditPointDialogProps) => {\r\n  const [formData, setFormData] = useState({\r\n    nombre: point.nombre,\r\n    direccion: point.direccion,\r\n    ciudad: point.ciudad,\r\n    provincia: point.provincia,\r\n    codigo_postal: point.codigo_postal || \"\",\r\n    telefono: point.telefono || \"\",\r\n    servientrega_agencia_codigo: point.servientrega_agencia_codigo || \"\",\r\n    servientrega_agencia_nombre: point.servientrega_agencia_nombre || \"\",\r\n    servientrega_alianza: point.servientrega_alianza || \"\",\r\n    servientrega_oficina_alianza: point.servientrega_oficina_alianza || \"\",\r\n  });\r\n  const [loading, setLoading] = useState(false);\r\n\r\n  // Ô£à Resetear formulario al cambiar de punto o abrir modal\r\n  useEffect(() => {\r\n    if (isOpen) {\r\n      setFormData({\r\n        nombre: point.nombre,\r\n        direccion: point.direccion,\r\n        ciudad: point.ciudad,\r\n        provincia: point.provincia,\r\n        codigo_postal: point.codigo_postal || \"\",\r\n        telefono: point.telefono || \"\",\r\n        servientrega_agencia_codigo: point.servientrega_agencia_codigo || \"\",\r\n        servientrega_agencia_nombre: point.servientrega_agencia_nombre || \"\",\r\n        servientrega_alianza: point.servientrega_alianza || \"\",\r\n        servientrega_oficina_alianza: point.servientrega_oficina_alianza || \"\",\r\n      });\r\n    }\r\n  }, [point, isOpen]);\r\n\r\n  const handleChange = (e: React.ChangeEvent<HTMLInputElement>) => {\r\n    setFormData({ ...formData, [e.target.name]: e.target.value });\r\n  };\r\n\r\n  const handleSubmit = async (e: React.FormEvent) => {\r\n    e.preventDefault();\r\n    setLoading(true);\r\n\r\n    if (\r\n      !formData.nombre ||\r\n      !formData.direccion ||\r\n      !formData.ciudad ||\r\n      !formData.provincia\r\n    ) {\r\n      toast({\r\n        title: \"Error\",\r\n        description:\r\n          \"Los campos nombre, direcci├│n, ciudad y provincia son obligatorios\",\r\n        variant: \"destructive\",\r\n      });\r\n      setLoading(false);\r\n      return;\r\n    }\r\n\r\n    try {\r\n      const { point: updated } = await pointService.updatePoint(\r\n        point.id,\r\n        formData\r\n      );\r\n      if (!updated) throw new Error();\r\n\r\n      toast({\r\n        title: \"Punto actualizado\",\r\n        description: `Punto ${updated.nombre} actualizado correctamente`,\r\n      });\r\n      onPointUpdated();\r\n      onClose();\r\n    } catch {\r\n      toast({\r\n        title: \"Error\",\r\n        description: \"No se pudo actualizar el punto\",\r\n        variant: \"destructive\",\r\n      });\r\n    } finally {\r\n      setLoading(false);\r\n    }\r\n  };\r\n\r\n  return (\r\n    <Dialog open={isOpen} onOpenChange={onClose}>\r\n      <DialogContent className=\"max-w-2xl max-h-[90vh] flex flex-col\">\r\n        <DialogHeader className=\"flex-shrink-0\">\r\n          <DialogTitle>Editar Punto de Atenci├│n</DialogTitle>\r\n        </DialogHeader>\r\n\r\n        <div className=\"flex-1 overflow-y-auto pr-2\">\r\n          <form onSubmit={handleSubmit} className=\"space-y-4\">\r\n            {/* Informaci├│n b├ísica en grid */}\r\n            <div className=\"grid grid-cols-1 md:grid-cols-2 gap-4\">\r\n              <div className=\"space-y-2\">\r\n                <Label>Nombre *</Label>\r\n                <Input\r\n                  name=\"nombre\"\r\n                  value={formData.nombre}\r\n                  onChange={handleChange}\r\n                  disabled={loading}\r\n                  placeholder=\"Nombre del punto de atenci├│n\"\r\n                />\r\n              </div>\r\n              <div className=\"space-y-2\">\r\n                <Label>Ciudad *</Label>\r\n                <Input\r\n                  name=\"ciudad\"\r\n                  value={formData.ciudad}\r\n                  onChange={handleChange}\r\n                  disabled={loading}\r\n                  placeholder=\"Ciudad\"\r\n                />\r\n              </div>\r\n            </div>\r\n\r\n            {/* Direcci├│n completa */}\r\n            <div className=\"space-y-2\">\r\n              <Label>Direcci├│n *</Label>\r\n              <Input\r\n                name=\"direccion\"\r\n                value={formData.direccion}\r\n                onChange={handleChange}\r\n                disabled={loading}\r\n                placeholder=\"Direcci├│n completa\"\r\n              />\r\n            </div>\r\n\r\n            {/* Provincia, c├│digo postal y tel├®fono */}\r\n            <div className=\"grid grid-cols-1 md:grid-cols-3 gap-4\">\r\n              <div className=\"space-y-2\">\r\n                <Label>Provincia *</Label>\r\n                <Input\r\n                  name=\"provincia\"\r\n                  value={formData.provincia}\r\n                  onChange={handleChange}\r\n                  disabled={loading}\r\n                  placeholder=\"Provincia\"\r\n                />\r\n              </div>\r\n              <div className=\"space-y-2\">\r\n                <Label>C├│digo Postal</Label>\r\n                <Input\r\n                  name=\"codigo_postal\"\r\n                  value={formData.codigo_postal}\r\n                  onChange={handleChange}\r\n                  disabled={loading}\r\n                  placeholder=\"C├│digo postal\"\r\n                />\r\n              </div>\r\n              <div className=\"space-y-2\">\r\n                <Label>Tel├®fono</Label>\r\n                <Input\r\n                  name=\"telefono\"\r\n                  value={formData.telefono}\r\n                  onChange={handleChange}\r\n                  disabled={loading}\r\n                  placeholder=\"N├║mero de tel├®fono\"\r\n                />\r\n              </div>\r\n            </div>\r\n\r\n            {/* Selector de agencia */}\r\n            <div className=\"border-t pt-4\">\r\n              <AgenciaSelector\r\n                value={formData.servientrega_agencia_nombre}\r\n                onAgenciaSelect={(agencia) => {\r\n                  setFormData({\r\n                    ...formData,\r\n                    servientrega_agencia_codigo: agencia?.tipo_cs || \"\",\r\n                    servientrega_agencia_nombre: agencia?.nombre || \"\",\r\n                    servientrega_alianza: agencia?.agencia || \"\",\r\n                    servientrega_oficina_alianza:\r\n                      agencia?.codigo_establecimiento || \"\",\r\n                  });\r\n                }}\r\n                placeholder=\"Seleccionar agencia de Servientrega...\"\r\n                disabled={loading}\r\n              />\r\n            </div>\r\n          </form>\r\n        </div>\r\n\r\n        {/* Footer fijo */}\r\n        <DialogFooter className=\"flex-shrink-0 mt-4 pt-4 border-t bg-white\">\r\n          <div className=\"flex gap-2 justify-end w-full\">\r\n            <Button\r\n              type=\"button\"\r\n              variant=\"outline\"\r\n              onClick={onClose}\r\n              disabled={loading}\r\n            >\r\n              Cancelar\r\n            </Button>\r\n            <Button\r\n              type=\"submit\"\r\n              onClick={handleSubmit}\r\n              className=\"bg-blue-600 hover:bg-blue-700\"\r\n              disabled={loading}\r\n            >\r\n              {loading ? \"Guardando...\" : \"Guardar Cambios\"}\r\n            </Button>\r\n          </div>\r\n        </DialogFooter>\r\n      </DialogContent>\r\n    </Dialog>\r\n  );\r\n};\r\n\r\nexport default EditPointDialog;\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\oswal\\OneDrive\\Documentos\\Punto Cambio\\punto_cambio_new\\src\\components\\admin\\EditUserDialog.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\oswal\\OneDrive\\Documentos\\Punto Cambio\\punto_cambio_new\\src\\components\\admin\\FreePointButton.tsx","messages":[{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'e' is defined but never used.","line":52,"column":14,"nodeType":null,"messageId":"unusedVar","endLine":52,"endColumn":15}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":1,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import React, { useState } from \"react\";\r\nimport { scheduleService } from \"../../services/scheduleService\";\r\nimport { useAuth } from \"../../hooks/useAuth\";\r\nimport { Button } from \"../ui/button\";\r\nimport { toast } from \"react-hot-toast\";\r\n\r\ninterface Props {\r\n  usuarioId: string; // usuario a liberar del punto\r\n  destinoPuntoId?: string; // opcional, si no se pasa se usa el punto principal\r\n  onDone?: () => void; // callback tras ├®xito\r\n}\r\n\r\n/**\r\n * Bot├│n para ADMIN/SUPER que env├¡a la jornada activa del usuario al punto principal\r\n * (o a un punto destino), liberando as├¡ el punto en el que se qued├│ por error.\r\n */\r\nconst FreePointButton: React.FC<Props> = ({\r\n  usuarioId,\r\n  destinoPuntoId,\r\n  onDone,\r\n}) => {\r\n  const { user } = useAuth();\r\n  const [loading, setLoading] = useState(false);\r\n\r\n  const canUse = user && (user.rol === \"ADMIN\" || user.rol === \"SUPER_USUARIO\");\r\n\r\n  const handleClick = async () => {\r\n    if (!canUse) {\r\n      toast.error(\"No tiene permisos para esta acci├│n\");\r\n      return;\r\n    }\r\n    setLoading(true);\r\n    try {\r\n      const { error } = await scheduleService.reassignPoint({\r\n        usuario_id: usuarioId,\r\n        // Para liberar completamente y forzar nueva selecci├│n al reingreso:\r\n        finalizar: !destinoPuntoId, // si no se indica destino, cancelamos jornada y limpiamos punto\r\n        destino_punto_atencion_id: destinoPuntoId, // si se env├¡a, reasigna en lugar de cancelar\r\n        motivo: destinoPuntoId ? \"REASIGNACION_ADMIN\" : \"CANCELACION_ADMIN\",\r\n        observaciones: \"Liberar punto por selecci├│n equivocada\",\r\n      });\r\n      if (error) {\r\n        toast.error(error);\r\n      } else {\r\n        toast.success(\r\n          destinoPuntoId\r\n            ? \"Jornada reasignada\"\r\n            : \"Jornada cancelada y punto liberado\"\r\n        );\r\n        onDone?.();\r\n      }\r\n    } catch (e) {\r\n      toast.error(\"Error al liberar punto\");\r\n    } finally {\r\n      setLoading(false);\r\n    }\r\n  };\r\n\r\n  if (!canUse) return null;\r\n\r\n  return (\r\n    <Button\r\n      onClick={handleClick}\r\n      disabled={loading}\r\n      variant=\"destructive\"\r\n      size=\"sm\"\r\n      title=\"Mover jornada al punto principal para liberar\"\r\n    >\r\n      {loading ? \"Liberando...\" : \"Liberar Punto\"}\r\n    </Button>\r\n  );\r\n};\r\n\r\nexport default FreePointButton;\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\oswal\\OneDrive\\Documentos\\Punto Cambio\\punto_cambio_new\\src\\components\\admin\\PermissionApprovals.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\oswal\\OneDrive\\Documentos\\Punto Cambio\\punto_cambio_new\\src\\components\\admin\\ResetPasswordDialog.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\oswal\\OneDrive\\Documentos\\Punto Cambio\\punto_cambio_new\\src\\components\\admin\\SaldoInicialManagement.tsx","messages":[{"ruleId":"no-console","severity":1,"message":"Unexpected console statement. Only these console methods are allowed: warn, error.","line":44,"column":7,"nodeType":"MemberExpression","messageId":"limited","endLine":44,"endColumn":18,"suggestions":[{"fix":{"range":[1663,1733],"text":""},"messageId":"removeConsole","data":{"propertyName":"log"},"desc":"Remove the console.log()."}]},{"ruleId":"no-console","severity":1,"message":"Unexpected console statement. Only these console methods are allowed: warn, error.","line":51,"column":7,"nodeType":"MemberExpression","messageId":"limited","endLine":51,"endColumn":18,"suggestions":[{"fix":{"range":[1939,1987],"text":""},"messageId":"removeConsole","data":{"propertyName":"log"},"desc":"Remove the console.log()."}]},{"ruleId":"no-console","severity":1,"message":"Unexpected console statement. Only these console methods are allowed: warn, error.","line":52,"column":7,"nodeType":"MemberExpression","messageId":"limited","endLine":52,"endColumn":18,"suggestions":[{"fix":{"range":[1995,2048],"text":""},"messageId":"removeConsole","data":{"propertyName":"log"},"desc":"Remove the console.log()."}]},{"ruleId":"no-console","severity":1,"message":"Unexpected console statement. Only these console methods are allowed: warn, error.","line":75,"column":9,"nodeType":"MemberExpression","messageId":"limited","endLine":75,"endColumn":20,"suggestions":[{"fix":{"range":[2907,3022],"text":""},"messageId":"removeConsole","data":{"propertyName":"log"},"desc":"Remove the console.log()."}]},{"ruleId":"no-console","severity":1,"message":"Unexpected console statement. Only these console methods are allowed: warn, error.","line":81,"column":7,"nodeType":"MemberExpression","messageId":"limited","endLine":81,"endColumn":18,"suggestions":[{"fix":{"range":[3086,3129],"text":""},"messageId":"removeConsole","data":{"propertyName":"log"},"desc":"Remove the console.log()."}]},{"ruleId":"no-console","severity":1,"message":"Unexpected console statement. Only these console methods are allowed: warn, error.","line":100,"column":5,"nodeType":"MemberExpression","messageId":"limited","endLine":100,"endColumn":16,"suggestions":[{"fix":{"range":[3752,3956],"text":""},"messageId":"removeConsole","data":{"propertyName":"log"},"desc":"Remove the console.log()."}]},{"ruleId":"no-console","severity":1,"message":"Unexpected console statement. Only these console methods are allowed: warn, error.","line":135,"column":5,"nodeType":"MemberExpression","messageId":"limited","endLine":135,"endColumn":16,"suggestions":[{"fix":{"range":[4933,4981],"text":""},"messageId":"removeConsole","data":{"propertyName":"log"},"desc":"Remove the console.log()."}]},{"ruleId":"no-console","severity":1,"message":"Unexpected console statement. Only these console methods are allowed: warn, error.","line":143,"column":7,"nodeType":"MemberExpression","messageId":"limited","endLine":143,"endColumn":18,"suggestions":[{"fix":{"range":[5173,5283],"text":""},"messageId":"removeConsole","data":{"propertyName":"log"},"desc":"Remove the console.log()."}]},{"ruleId":"no-console","severity":1,"message":"Unexpected console statement. Only these console methods are allowed: warn, error.","line":147,"column":7,"nodeType":"MemberExpression","messageId":"limited","endLine":147,"endColumn":18,"suggestions":[{"fix":{"range":[5343,5439],"text":""},"messageId":"removeConsole","data":{"propertyName":"log"},"desc":"Remove the console.log()."}]},{"ruleId":"no-console","severity":1,"message":"Unexpected console statement. Only these console methods are allowed: warn, error.","line":207,"column":11,"nodeType":"MemberExpression","messageId":"limited","endLine":207,"endColumn":22,"suggestions":[{"fix":{"range":[7258,7317],"text":""},"messageId":"removeConsole","data":{"propertyName":"log"},"desc":"Remove the console.log()."}]},{"ruleId":"no-console","severity":1,"message":"Unexpected console statement. Only these console methods are allowed: warn, error.","line":222,"column":11,"nodeType":"MemberExpression","messageId":"limited","endLine":222,"endColumn":22,"suggestions":[{"fix":{"range":[7753,7819],"text":""},"messageId":"removeConsole","data":{"propertyName":"log"},"desc":"Remove the console.log()."}]}],"suppressedMessages":[{"ruleId":"react-hooks/exhaustive-deps","severity":1,"message":"React Hook useEffect has a missing dependency: 'loadInitialData'. Either include it or remove the dependency array.","line":39,"column":6,"nodeType":"ArrayExpression","endLine":39,"endColumn":8,"suggestions":[{"desc":"Update the dependencies array to be: [loadInitialData]","fix":{"range":[1568,1570],"text":"[loadInitialData]"}}],"suppressions":[{"kind":"directive","justification":""}]}],"errorCount":0,"fatalErrorCount":0,"warningCount":11,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import { useState, useEffect } from \"react\";\r\nimport { Button } from \"@/components/ui/button\";\r\nimport { Input } from \"@/components/ui/input\";\r\nimport { Label } from \"@/components/ui/label\";\r\nimport {\r\n  Select,\r\n  SelectContent,\r\n  SelectItem,\r\n  SelectTrigger,\r\n  SelectValue,\r\n} from \"@/components/ui/select\";\r\nimport { Card, CardHeader, CardTitle, CardContent } from \"@/components/ui/card\";\r\nimport { useConfirmationDialog } from \"@/components/ui/confirmation-dialog\";\r\nimport { toast } from \"sonner\";\r\nimport { PuntoAtencion, VistaSaldosPorPunto } from \"../../types\";\r\nimport { pointService } from \"../../services/pointService\";\r\nimport { saldoInicialService } from \"../../services/saldoInicialService\";\r\n\r\nconst SaldoInicialManagement = () => {\r\n  const { showConfirmation, ConfirmationDialog } = useConfirmationDialog();\r\n\r\n  // Estados principales\r\n  const [points, setPoints] = useState<PuntoAtencion[]>([]);\r\n  const [vistaSaldos, setVistaSaldos] = useState<VistaSaldosPorPunto[]>([]);\r\n  const [loadingData, setLoadingData] = useState(true);\r\n\r\n  // Estados del filtro de punto\r\n  const [selectedPointId, setSelectedPointId] = useState<string>(\"\");\r\n\r\n  // Estados por punto seleccionado\r\n  const [selectedCurrency, setSelectedCurrency] = useState<string>(\"\");\r\n  const [billetes, setBilletes] = useState<string>(\"\");\r\n  const [monedas, setMonedas] = useState<string>(\"\");\r\n  const [loadingAsignacion, setLoadingAsignacion] = useState(false);\r\n\r\n  useEffect(() => {\r\n    loadInitialData();\r\n    // eslint-disable-next-line react-hooks/exhaustive-deps\r\n  }, []);\r\n\r\n  const loadInitialData = async () => {\r\n    try {\r\n      setLoadingData(true);\r\n      console.log(\"­ƒöì SaldoInicialManagement: Iniciando carga de datos...\");\r\n\r\n      const [pointsResponse, vistaSaldosResponse] = await Promise.all([\r\n        pointService.getPointsForBalanceManagement(),\r\n        saldoInicialService.getVistaSaldosPorPunto(),\r\n      ]);\r\n\r\n      console.log(\"­ƒôì Puntos (raw):\", pointsResponse);\r\n      console.log(\"­ƒÆ░ Saldos (raw):\", vistaSaldosResponse);\r\n\r\n      if (pointsResponse.error) {\r\n        const msg = pointsResponse.error || \"Error al cargar puntos\";\r\n        console.error(\"ÔØî Error en respuesta de puntos:\", msg);\r\n        toast.error(`Error al cargar puntos: ${msg}`);\r\n        setPoints([]);\r\n      } else {\r\n        setPoints(pointsResponse.points || []);\r\n      }\r\n\r\n      if (vistaSaldosResponse.error) {\r\n        const msg = vistaSaldosResponse.error || \"Error al cargar saldos\";\r\n        console.error(\"ÔØî Error en respuesta de saldos:\", msg);\r\n        toast.error(`Error al cargar saldos: ${msg}`);\r\n        setVistaSaldos([]);\r\n      } else {\r\n        setVistaSaldos(vistaSaldosResponse.saldos || []);\r\n      }\r\n\r\n      const puntosObtenidos = pointsResponse.points || [];\r\n      if (puntosObtenidos.length > 0 && !selectedPointId) {\r\n        const primerPunto = puntosObtenidos[0];\r\n        console.log(\r\n          `­ƒÄ» Auto-seleccionando primer punto: ${primerPunto.nombre} (${primerPunto.id})`\r\n        );\r\n        setSelectedPointId(primerPunto.id);\r\n      }\r\n\r\n      console.log(\"Ô£à Carga de datos completada\");\r\n    } catch (error) {\r\n      console.error(\"ÔØî Error cr├¡tico al cargar datos:\", error);\r\n      toast.error(\r\n        error instanceof Error ? error.message : \"Error al cargar datos\"\r\n      );\r\n      setPoints([]);\r\n      setVistaSaldos([]);\r\n    } finally {\r\n      setLoadingData(false);\r\n    }\r\n  };\r\n\r\n  // Obtiene el punto seleccionado\r\n  const selectedPoint = points.find((p) => p.id === selectedPointId);\r\n\r\n  // Obtiene TODAS las monedas disponibles para el punto seleccionado\r\n  const getMonedasPorPunto = (puntoId: string) => {\r\n    const monedas = vistaSaldos.filter((s) => s.punto_atencion_id === puntoId);\r\n    console.log(\r\n      `­ƒÆ▒ Monedas disponibles para punto ${puntoId}:`,\r\n      monedas.length,\r\n      monedas.map(\r\n        (m) => `${m.moneda_codigo} (${m.moneda_simbolo}${m.saldo_actual})`\r\n      )\r\n    );\r\n    return monedas;\r\n  };\r\n\r\n  // Obtiene el saldo actual para el punto y moneda seleccionada\r\n  const getSaldoActual = (puntoId: string, monedaId: string) => {\r\n    const saldo = vistaSaldos.find(\r\n      (s) => s.punto_atencion_id === puntoId && s.moneda_id === monedaId\r\n    );\r\n    return saldo ? saldo.saldo_actual : 0;\r\n  };\r\n\r\n  // Obtiene el s├¡mbolo de la moneda seleccionada\r\n  const getMonedaSimbolo = (puntoId: string, monedaId: string) => {\r\n    const saldo = vistaSaldos.find(\r\n      (s) => s.punto_atencion_id === puntoId && s.moneda_id === monedaId\r\n    );\r\n    return saldo ? saldo.moneda_simbolo : \"\";\r\n  };\r\n\r\n  // Obtiene informaci├│n completa de la moneda seleccionada\r\n  const getMonedaInfo = (puntoId: string, monedaId: string) => {\r\n    return vistaSaldos.find(\r\n      (s) => s.punto_atencion_id === puntoId && s.moneda_id === monedaId\r\n    );\r\n  };\r\n\r\n  // Maneja el cambio de punto seleccionado\r\n  const handlePointChange = (pointId: string) => {\r\n    console.log(`­ƒÄ» Cambiando a punto: ${pointId}`);\r\n    setSelectedPointId(pointId);\r\n    setSelectedCurrency(\"\");\r\n    setBilletes(\"\");\r\n    setMonedas(\"\");\r\n\r\n    const punto = points.find((p) => p.id === pointId);\r\n    if (punto) {\r\n      console.log(\r\n        `­ƒôì Punto seleccionado: ${punto.nombre} - ${punto.ciudad}, ${punto.provincia}`\r\n      );\r\n      const monedas = getMonedasPorPunto(pointId);\r\n      console.log(\r\n        `­ƒÆ▒ Monedas disponibles para ${punto.nombre}: ${monedas.length}`\r\n      );\r\n    }\r\n  };\r\n\r\n  // Asignar saldo inicial (incremento)\r\n  const handleAsignarSaldo = async () => {\r\n    if (!selectedPointId || !selectedCurrency) {\r\n      toast.error(\"Seleccione punto y moneda\");\r\n      return;\r\n    }\r\n\r\n    const billetesNum = Number.parseFloat(billetes || \"0\");\r\n    const monedasNum = Number.parseFloat(monedas || \"0\");\r\n\r\n    if (\r\n      Number.isNaN(billetesNum) ||\r\n      billetesNum < 0 ||\r\n      Number.isNaN(monedasNum) ||\r\n      monedasNum < 0\r\n    ) {\r\n      toast.error(\"Billetes/Monedas deben ser n├║meros v├ílidos (>= 0)\");\r\n      return;\r\n    }\r\n\r\n    const cantidadNum = +(billetesNum + monedasNum).toFixed(2);\r\n    if (cantidadNum <= 0) {\r\n      toast.error(\"El total (billetes + monedas) debe ser mayor a 0\");\r\n      return;\r\n    }\r\n\r\n    const punto = selectedPoint;\r\n    const monedaInfo = getMonedaInfo(selectedPointId, selectedCurrency);\r\n\r\n    if (!punto || !monedaInfo) {\r\n      toast.error(\"Error: No se encontr├│ informaci├│n del punto o moneda\");\r\n      return;\r\n    }\r\n\r\n    showConfirmation(\r\n      \"Confirmar asignaci├│n de saldo\",\r\n      `┬┐Asignar ${\r\n        monedaInfo.moneda_simbolo\r\n      }${cantidadNum.toLocaleString()} (${billetesNum.toLocaleString()} billetes + ${monedasNum.toLocaleString()} monedas) de ${\r\n        monedaInfo.moneda_nombre\r\n      } al punto \"${punto.nombre}\"?`,\r\n      async () => {\r\n        setLoadingAsignacion(true);\r\n\r\n        // Payload EXACTO para la API (incremento)\r\n        const payload = {\r\n          punto_atencion_id: selectedPointId, // UUID del punto\r\n          moneda_id: selectedCurrency, // UUID de la moneda (value del Select)\r\n          cantidad_inicial: cantidadNum, // total (backend tambi├®n acepta desglose)\r\n          billetes: billetesNum,\r\n          monedas_fisicas: monedasNum,\r\n        };\r\n\r\n        try {\r\n          console.log(\"­ƒôª Payload POST /saldos-iniciales:\", payload);\r\n\r\n          // Llamada al servicio\r\n          const res = await saldoInicialService.asignarSaldoInicial(payload);\r\n\r\n          // Soporta ambos estilos: retorno con error o lanzar throw\r\n          if (res.error) {\r\n            console.error(\r\n              \"ÔØî Error al asignar saldo (respuesta controlada):\",\r\n              res.error\r\n            );\r\n            toast.error(res.error);\r\n            return;\r\n          }\r\n\r\n          console.log(\"Ô£à Saldo asignado correctamente:\", res?.saldo ?? res);\r\n          toast.success(\r\n            `Ô£à Saldo de ${\r\n              monedaInfo.moneda_simbolo\r\n            }${cantidadNum.toLocaleString()} asignado correctamente a ${\r\n              punto.nombre\r\n            }`\r\n          );\r\n\r\n          // Limpiar formulario + recargar data\r\n          setBilletes(\"\");\r\n          setMonedas(\"\");\r\n          setSelectedCurrency(\"\");\r\n          await loadInitialData();\r\n        } catch (e: unknown) {\r\n          // Aqu├¡ llegan los errores lanzados por apiService con el message del backend\r\n          const msg =\r\n            e instanceof Error\r\n              ? e.message\r\n              : \"Error inesperado al asignar saldo\";\r\n          console.error(\"ÔØî Error al asignar saldo (throw):\", e);\r\n          toast.error(msg);\r\n        } finally {\r\n          setLoadingAsignacion(false);\r\n        }\r\n      }\r\n    );\r\n  };\r\n\r\n  // Monedas del punto seleccionado\r\n  const monedasDelPuntoSeleccionado = selectedPointId\r\n    ? getMonedasPorPunto(selectedPointId)\r\n    : [];\r\n\r\n  if (loadingData) {\r\n    return (\r\n      <div className=\"p-6 space-y-6\">\r\n        <div className=\"flex justify-between items-center mb-4\">\r\n          <h1 className=\"text-2xl font-bold text-gray-800 flex items-center gap-3\">\r\n            ­ƒÆ▒ Gesti├│n de Saldos de Divisas\r\n          </h1>\r\n        </div>\r\n        <div className=\"text-center py-12\">\r\n          <div className=\"text-gray-400 text-6xl mb-4\">ÔÅ│</div>\r\n          <h3 className=\"text-lg font-semibold text-gray-600 mb-2\">\r\n            Cargando datos...\r\n          </h3>\r\n          <p className=\"text-gray-500\">\r\n            Obteniendo puntos de atenci├│n y saldos de divisas\r\n          </p>\r\n        </div>\r\n      </div>\r\n    );\r\n  }\r\n\r\n  return (\r\n    <div className=\"p-6 space-y-6\">\r\n      {/* Header */}\r\n      <div className=\"flex justify-between items-center mb-6\">\r\n        <h1 className=\"text-2xl font-bold text-gray-800 flex items-center gap-3\">\r\n          ­ƒÆ▒ Gesti├│n de Saldos de Divisas\r\n        </h1>\r\n        <div className=\"flex gap-2\">\r\n          <Button\r\n            variant=\"outline\"\r\n            size=\"sm\"\r\n            onClick={loadInitialData}\r\n            className=\"text-xs\"\r\n          >\r\n            ­ƒöä Actualizar\r\n          </Button>\r\n          <div className=\"text-sm text-gray-500 px-2 py-1 bg-gray-100 rounded\">\r\n            {points.length} puntos disponibles\r\n          </div>\r\n        </div>\r\n      </div>\r\n\r\n      {/* Filtro de Punto de Atenci├│n */}\r\n      <Card>\r\n        <CardHeader>\r\n          <CardTitle className=\"text-lg flex items-center gap-2\">\r\n            ­ƒôì Seleccionar Punto de Atenci├│n\r\n          </CardTitle>\r\n        </CardHeader>\r\n        <CardContent>\r\n          {points.length === 0 ? (\r\n            <div className=\"text-center py-8\">\r\n              <div className=\"text-gray-400 text-4xl mb-4\">­ƒôì</div>\r\n              <h3 className=\"text-lg font-semibold text-gray-600 mb-2\">\r\n                No se encontraron puntos de atenci├│n\r\n              </h3>\r\n              <p className=\"text-gray-500 mb-4\">\r\n                Verifica que existan puntos de atenci├│n activos en el sistema\r\n              </p>\r\n              <Button variant=\"outline\" onClick={loadInitialData}>\r\n                ­ƒöä Recargar puntos\r\n              </Button>\r\n            </div>\r\n          ) : (\r\n            <div className=\"space-y-4\">\r\n              <div>\r\n                <Label className=\"text-sm font-medium text-gray-700\">\r\n                  Punto de Atenci├│n\r\n                </Label>\r\n                <Select\r\n                  value={selectedPointId}\r\n                  onValueChange={handlePointChange}\r\n                >\r\n                  <SelectTrigger className=\"mt-1\">\r\n                    <SelectValue placeholder=\"Seleccione un punto de atenci├│n\" />\r\n                  </SelectTrigger>\r\n                  <SelectContent>\r\n                    {points.map((point) => (\r\n                      <SelectItem key={point.id} value={point.id}>\r\n                        {point.nombre} - {point.ciudad}, {point.provincia}\r\n                      </SelectItem>\r\n                    ))}\r\n                  </SelectContent>\r\n                </Select>\r\n              </div>\r\n\r\n              {selectedPoint && (\r\n                <div className=\"p-4 bg-blue-50 rounded-lg\">\r\n                  <div className=\"flex items-center gap-2 mb-2\">\r\n                    <span className=\"text-blue-600 font-semibold\">\r\n                      ­ƒôì {selectedPoint.nombre}\r\n                    </span>\r\n                  </div>\r\n                  <div className=\"text-sm text-gray-600\">\r\n                    <p>­ƒôì {selectedPoint.direccion}</p>\r\n                    <p>\r\n                      ­ƒÅÖ´©Å {selectedPoint.ciudad}, {selectedPoint.provincia}\r\n                    </p>\r\n                    {selectedPoint.telefono && (\r\n                      <p>­ƒô× {selectedPoint.telefono}</p>\r\n                    )}\r\n                  </div>\r\n                </div>\r\n              )}\r\n            </div>\r\n          )}\r\n        </CardContent>\r\n      </Card>\r\n\r\n      {/* Panel de Gesti├│n de Saldos */}\r\n      {selectedPointId && selectedPoint && (\r\n        <Card>\r\n          <CardHeader>\r\n            <CardTitle className=\"text-lg flex items-center gap-2\">\r\n              ­ƒÆ░ Gesti├│n de Saldos - {selectedPoint.nombre}\r\n            </CardTitle>\r\n          </CardHeader>\r\n          <CardContent className=\"space-y-6\">\r\n            {/* Monedas Disponibles */}\r\n            {monedasDelPuntoSeleccionado.length > 0 && (\r\n              <div>\r\n                <Label className=\"text-sm font-medium text-gray-700 mb-3 block\">\r\n                  ­ƒÆ▒ Monedas Disponibles ({monedasDelPuntoSeleccionado.length})\r\n                </Label>\r\n                <div className=\"grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-3\">\r\n                  {monedasDelPuntoSeleccionado.map((saldo) => (\r\n                    <div\r\n                      key={saldo.moneda_id}\r\n                      className=\"p-3 bg-gradient-to-r from-blue-50 to-indigo-50 border border-blue-200 rounded-lg\"\r\n                    >\r\n                      <div className=\"flex justify-between items-center\">\r\n                        <div>\r\n                          <span className=\"font-semibold text-blue-800\">\r\n                            {saldo.moneda_codigo}\r\n                          </span>\r\n                          <p className=\"text-xs text-gray-600\">\r\n                            {saldo.moneda_nombre}\r\n                          </p>\r\n                        </div>\r\n                        <div className=\"text-right\">\r\n                          <span className=\"font-bold text-green-700\">\r\n                            {saldo.moneda_simbolo}\r\n                            {saldo.saldo_actual.toLocaleString()}\r\n                          </span>\r\n                          <p className=\"text-xs text-gray-500\">Saldo actual</p>\r\n                        </div>\r\n                      </div>\r\n                    </div>\r\n                  ))}\r\n                </div>\r\n              </div>\r\n            )}\r\n\r\n            {/* Formulario de Asignaci├│n */}\r\n            <div className=\"border-t pt-6\">\r\n              <h3 className=\"text-lg font-semibold text-gray-800 mb-4\">\r\n                Ô×ò Asignar Nuevo Saldo\r\n              </h3>\r\n\r\n              <div className=\"grid grid-cols-1 md:grid-cols-3 gap-4\">\r\n                {/* Selector de Moneda */}\r\n                <div>\r\n                  <Label className=\"text-sm font-medium text-gray-700\">\r\n                    Moneda\r\n                  </Label>\r\n                  <Select\r\n                    value={selectedCurrency}\r\n                    onValueChange={setSelectedCurrency}\r\n                    disabled={monedasDelPuntoSeleccionado.length === 0}\r\n                  >\r\n                    <SelectTrigger className=\"mt-1\">\r\n                      <SelectValue\r\n                        placeholder={\r\n                          monedasDelPuntoSeleccionado.length === 0\r\n                            ? \"No hay monedas disponibles\"\r\n                            : \"Seleccionar moneda\"\r\n                        }\r\n                      />\r\n                    </SelectTrigger>\r\n                    <SelectContent>\r\n                      {monedasDelPuntoSeleccionado.map((saldo) => (\r\n                        <SelectItem\r\n                          key={saldo.moneda_id}\r\n                          value={saldo.moneda_id} // UUID de moneda\r\n                        >\r\n                          {saldo.moneda_codigo} - {saldo.moneda_nombre}\r\n                        </SelectItem>\r\n                      ))}\r\n                    </SelectContent>\r\n                  </Select>\r\n                </div>\r\n\r\n                {/* Inputs: Billetes y Monedas */}\r\n                <div>\r\n                  <Label className=\"text-sm font-medium text-gray-700\">\r\n                    Billetes\r\n                  </Label>\r\n                  <Input\r\n                    type=\"number\"\r\n                    step=\"0.01\"\r\n                    min=\"0\"\r\n                    value={billetes}\r\n                    onChange={(e) => setBilletes(e.target.value)}\r\n                    placeholder=\"0.00\"\r\n                    className=\"mt-1\"\r\n                    disabled={!selectedCurrency}\r\n                    inputMode=\"decimal\"\r\n                  />\r\n                </div>\r\n\r\n                <div>\r\n                  <Label className=\"text-sm font-medium text-gray-700\">\r\n                    Monedas\r\n                  </Label>\r\n                  <Input\r\n                    type=\"number\"\r\n                    step=\"0.01\"\r\n                    min=\"0\"\r\n                    value={monedas}\r\n                    onChange={(e) => setMonedas(e.target.value)}\r\n                    placeholder=\"0.00\"\r\n                    className=\"mt-1\"\r\n                    disabled={!selectedCurrency}\r\n                    inputMode=\"decimal\"\r\n                  />\r\n                </div>\r\n\r\n                {/* Bot├│n de Asignaci├│n */}\r\n                <div className=\"flex items-end\">\r\n                  <Button\r\n                    onClick={handleAsignarSaldo}\r\n                    disabled={\r\n                      loadingAsignacion ||\r\n                      !selectedCurrency ||\r\n                      Number.parseFloat(billetes || \"0\") +\r\n                        Number.parseFloat(monedas || \"0\") <=\r\n                        0\r\n                    }\r\n                    className=\"w-full\"\r\n                  >\r\n                    {loadingAsignacion ? (\r\n                      <>\r\n                        <span className=\"animate-spin mr-2\">ÔÅ│</span>\r\n                        Asignando...\r\n                      </>\r\n                    ) : (\r\n                      <>­ƒÆ░ Asignar Saldo</>\r\n                    )}\r\n                  </Button>\r\n                </div>\r\n              </div>\r\n\r\n              {/* Informaci├│n del Saldo Actual */}\r\n              {selectedCurrency && (\r\n                <div className=\"mt-4 p-4 bg-green-50 border border-green-200 rounded-lg\">\r\n                  <div className=\"flex justify-between items-center\">\r\n                    <span className=\"text-sm font-medium text-gray-700\">\r\n                      Saldo actual de{\" \"}\r\n                      {\r\n                        getMonedaInfo(selectedPointId, selectedCurrency)\r\n                          ?.moneda_nombre\r\n                      }\r\n                      :\r\n                    </span>\r\n                    <span className=\"font-bold text-green-700 text-lg\">\r\n                      {getMonedaSimbolo(selectedPointId, selectedCurrency)}\r\n                      {getSaldoActual(\r\n                        selectedPointId,\r\n                        selectedCurrency\r\n                      ).toLocaleString()}\r\n                    </span>\r\n                  </div>\r\n                </div>\r\n              )}\r\n            </div>\r\n\r\n            {/* Mensaje cuando no hay monedas */}\r\n            {monedasDelPuntoSeleccionado.length === 0 && (\r\n              <div className=\"text-center py-8\">\r\n                <div className=\"text-gray-400 text-4xl mb-4\">­ƒÆ▒</div>\r\n                <h3 className=\"text-lg font-semibold text-gray-600 mb-2\">\r\n                  No hay monedas configuradas\r\n                </h3>\r\n                <p className=\"text-gray-500\">\r\n                  Este punto de atenci├│n no tiene monedas configuradas para\r\n                  gestionar saldos\r\n                </p>\r\n              </div>\r\n            )}\r\n          </CardContent>\r\n        </Card>\r\n      )}\r\n\r\n      {/* Di├ílogo de confirmaci├│n */}\r\n      <ConfirmationDialog />\r\n    </div>\r\n  );\r\n};\r\n\r\nexport default SaldoInicialManagement;\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\oswal\\OneDrive\\Documentos\\Punto Cambio\\punto_cambio_new\\src\\components\\admin\\SaldoServientregaAdmin.tsx","messages":[{"ruleId":"no-console","severity":1,"message":"Unexpected console statement. Only these console methods are allowed: warn, error.","line":80,"column":7,"nodeType":"MemberExpression","messageId":"limited","endLine":80,"endColumn":18,"suggestions":[{"fix":{"range":[2282,2380],"text":""},"messageId":"removeConsole","data":{"propertyName":"log"},"desc":"Remove the console.log()."}]},{"ruleId":"no-console","severity":1,"message":"Unexpected console statement. Only these console methods are allowed: warn, error.","line":87,"column":7,"nodeType":"MemberExpression","messageId":"limited","endLine":87,"endColumn":18,"suggestions":[{"fix":{"range":[2507,2574],"text":""},"messageId":"removeConsole","data":{"propertyName":"log"},"desc":"Remove the console.log()."}]},{"ruleId":"no-console","severity":1,"message":"Unexpected console statement. Only these console methods are allowed: warn, error.","line":96,"column":7,"nodeType":"MemberExpression","messageId":"limited","endLine":96,"endColumn":18,"suggestions":[{"fix":{"range":[2814,3037],"text":""},"messageId":"removeConsole","data":{"propertyName":"log"},"desc":"Remove the console.log()."}]},{"ruleId":"no-console","severity":1,"message":"Unexpected console statement. Only these console methods are allowed: warn, error.","line":113,"column":7,"nodeType":"MemberExpression","messageId":"limited","endLine":113,"endColumn":18,"suggestions":[{"fix":{"range":[3249,3304],"text":""},"messageId":"removeConsole","data":{"propertyName":"log"},"desc":"Remove the console.log()."}]},{"ruleId":"no-console","severity":1,"message":"Unexpected console statement. Only these console methods are allowed: warn, error.","line":118,"column":11,"nodeType":"MemberExpression","messageId":"limited","endLine":118,"endColumn":22,"suggestions":[{"fix":{"range":[3449,3517],"text":""},"messageId":"removeConsole","data":{"propertyName":"log"},"desc":"Remove the console.log()."}]},{"ruleId":"no-console","severity":1,"message":"Unexpected console statement. Only these console methods are allowed: warn, error.","line":124,"column":11,"nodeType":"MemberExpression","messageId":"limited","endLine":124,"endColumn":22,"suggestions":[{"fix":{"range":[3758,3856],"text":""},"messageId":"removeConsole","data":{"propertyName":"log"},"desc":"Remove the console.log()."}]},{"ruleId":"no-console","severity":1,"message":"Unexpected console statement. Only these console methods are allowed: warn, error.","line":136,"column":7,"nodeType":"MemberExpression","messageId":"limited","endLine":136,"endColumn":18,"suggestions":[{"fix":{"range":[4218,4283],"text":""},"messageId":"removeConsole","data":{"propertyName":"log"},"desc":"Remove the console.log()."}]},{"ruleId":"no-console","severity":1,"message":"Unexpected console statement. Only these console methods are allowed: warn, error.","line":139,"column":7,"nodeType":"MemberExpression","messageId":"limited","endLine":139,"endColumn":18,"suggestions":[{"fix":{"range":[4323,4424],"text":""},"messageId":"removeConsole","data":{"propertyName":"log"},"desc":"Remove the console.log()."}]},{"ruleId":"no-console","severity":1,"message":"Unexpected console statement. Only these console methods are allowed: warn, error.","line":155,"column":7,"nodeType":"MemberExpression","messageId":"limited","endLine":155,"endColumn":18,"suggestions":[{"fix":{"range":[4837,4899],"text":""},"messageId":"removeConsole","data":{"propertyName":"log"},"desc":"Remove the console.log()."}]},{"ruleId":"no-console","severity":1,"message":"Unexpected console statement. Only these console methods are allowed: warn, error.","line":156,"column":7,"nodeType":"MemberExpression","messageId":"limited","endLine":156,"endColumn":18,"suggestions":[{"fix":{"range":[4907,4971],"text":""},"messageId":"removeConsole","data":{"propertyName":"log"},"desc":"Remove the console.log()."}]},{"ruleId":"no-console","severity":1,"message":"Unexpected console statement. Only these console methods are allowed: warn, error.","line":160,"column":9,"nodeType":"MemberExpression","messageId":"limited","endLine":160,"endColumn":20,"suggestions":[{"fix":{"range":[5064,5184],"text":""},"messageId":"removeConsole","data":{"propertyName":"log"},"desc":"Remove the console.log()."}]},{"ruleId":"no-console","severity":1,"message":"Unexpected console statement. Only these console methods are allowed: warn, error.","line":166,"column":9,"nodeType":"MemberExpression","messageId":"limited","endLine":166,"endColumn":20,"suggestions":[{"fix":{"range":[5210,5316],"text":""},"messageId":"removeConsole","data":{"propertyName":"log"},"desc":"Remove the console.log()."}]},{"ruleId":"no-console","severity":1,"message":"Unexpected console statement. Only these console methods are allowed: warn, error.","line":170,"column":9,"nodeType":"MemberExpression","messageId":"limited","endLine":170,"endColumn":20,"suggestions":[{"fix":{"range":[5326,5390],"text":""},"messageId":"removeConsole","data":{"propertyName":"log"},"desc":"Remove the console.log()."}]},{"ruleId":"no-console","severity":1,"message":"Unexpected console statement. Only these console methods are allowed: warn, error.","line":174,"column":11,"nodeType":"MemberExpression","messageId":"limited","endLine":174,"endColumn":22,"suggestions":[{"fix":{"range":[5567,5716],"text":""},"messageId":"removeConsole","data":{"propertyName":"log"},"desc":"Remove the console.log()."}]},{"ruleId":"no-console","severity":1,"message":"Unexpected console statement. Only these console methods are allowed: warn, error.","line":195,"column":7,"nodeType":"MemberExpression","messageId":"limited","endLine":195,"endColumn":18,"suggestions":[{"fix":{"range":[6115,6174],"text":""},"messageId":"removeConsole","data":{"propertyName":"log"},"desc":"Remove the console.log()."}]},{"ruleId":"no-console","severity":1,"message":"Unexpected console statement. Only these console methods are allowed: warn, error.","line":200,"column":9,"nodeType":"MemberExpression","messageId":"limited","endLine":200,"endColumn":20,"suggestions":[{"fix":{"range":[6348,6474],"text":""},"messageId":"removeConsole","data":{"propertyName":"log"},"desc":"Remove the console.log()."}]},{"ruleId":"no-console","severity":1,"message":"Unexpected console statement. Only these console methods are allowed: warn, error.","line":207,"column":9,"nodeType":"MemberExpression","messageId":"limited","endLine":207,"endColumn":20,"suggestions":[{"fix":{"range":[6556,6686],"text":""},"messageId":"removeConsole","data":{"propertyName":"log"},"desc":"Remove the console.log()."}]},{"ruleId":"no-console","severity":1,"message":"Unexpected console statement. Only these console methods are allowed: warn, error.","line":213,"column":9,"nodeType":"MemberExpression","messageId":"limited","endLine":213,"endColumn":20,"suggestions":[{"fix":{"range":[6712,6824],"text":""},"messageId":"removeConsole","data":{"propertyName":"log"},"desc":"Remove the console.log()."}]},{"ruleId":"no-console","severity":1,"message":"Unexpected console statement. Only these console methods are allowed: warn, error.","line":243,"column":9,"nodeType":"MemberExpression","messageId":"limited","endLine":243,"endColumn":20,"suggestions":[{"fix":{"range":[7791,7947],"text":""},"messageId":"removeConsole","data":{"propertyName":"log"},"desc":"Remove the console.log()."}]},{"ruleId":"no-console","severity":1,"message":"Unexpected console statement. Only these console methods are allowed: warn, error.","line":255,"column":11,"nodeType":"MemberExpression","messageId":"limited","endLine":255,"endColumn":22,"suggestions":[{"fix":{"range":[8164,8272],"text":""},"messageId":"removeConsole","data":{"propertyName":"log"},"desc":"Remove the console.log()."}]},{"ruleId":"no-console","severity":1,"message":"Unexpected console statement. Only these console methods are allowed: warn, error.","line":318,"column":3,"nodeType":"MemberExpression","messageId":"limited","endLine":318,"endColumn":14,"suggestions":[{"fix":{"range":[10041,10228],"text":""},"messageId":"removeConsole","data":{"propertyName":"log"},"desc":"Remove the console.log()."}]},{"ruleId":"no-console","severity":1,"message":"Unexpected console statement. Only these console methods are allowed: warn, error.","line":330,"column":7,"nodeType":"MemberExpression","messageId":"limited","endLine":330,"endColumn":18,"suggestions":[{"fix":{"range":[10417,10462],"text":""},"messageId":"removeConsole","data":{"propertyName":"log"},"desc":"Remove the console.log()."}]},{"ruleId":"no-console","severity":1,"message":"Unexpected console statement. Only these console methods are allowed: warn, error.","line":344,"column":7,"nodeType":"MemberExpression","messageId":"limited","endLine":344,"endColumn":18,"suggestions":[{"fix":{"range":[10892,10928],"text":""},"messageId":"removeConsole","data":{"propertyName":"log"},"desc":"Remove the console.log()."}]},{"ruleId":"no-console","severity":1,"message":"Unexpected console statement. Only these console methods are allowed: warn, error.","line":426,"column":21,"nodeType":"MemberExpression","messageId":"limited","endLine":426,"endColumn":32,"suggestions":[{"fix":{"range":[14125,14268],"text":""},"messageId":"removeConsole","data":{"propertyName":"log"},"desc":"Remove the console.log()."}]},{"ruleId":"no-console","severity":1,"message":"Unexpected console statement. Only these console methods are allowed: warn, error.","line":439,"column":21,"nodeType":"MemberExpression","messageId":"limited","endLine":439,"endColumn":32,"suggestions":[{"fix":{"range":[14639,14774],"text":""},"messageId":"removeConsole","data":{"propertyName":"log"},"desc":"Remove the console.log()."}]}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":25,"fixableErrorCount":0,"fixableWarningCount":0,"source":"\"use client\";\r\n\r\nimport { useEffect, useState } from \"react\";\r\nimport axiosInstance from \"@/services/axiosInstance\";\r\nimport { useAuth } from \"@/hooks/useAuth\";\r\nimport { useConfirmationDialog } from \"@/components/ui/confirmation-dialog\";\r\nimport { Card, CardHeader, CardTitle, CardContent } from \"@/components/ui/card\";\r\nimport { Input } from \"@/components/ui/input\";\r\nimport { Button } from \"@/components/ui/button\";\r\nimport { Label } from \"@/components/ui/label\";\r\nimport {\r\n  Select,\r\n  SelectItem,\r\n  SelectContent,\r\n  SelectTrigger,\r\n  SelectValue,\r\n} from \"@/components/ui/select\";\r\nimport { toast } from \"sonner\";\r\n\r\nconst UMBRAL_SALDO_BAJO = 5;\r\n\r\ninterface PuntoAtencion {\r\n  id: string;\r\n  nombre: string;\r\n  ciudad: string;\r\n  provincia: string;\r\n  servientrega_agencia_codigo?: string;\r\n  servientrega_agencia_nombre?: string;\r\n}\r\n\r\ninterface SaldoResponse {\r\n  disponible: number;\r\n}\r\n\r\ninterface HistorialAsignacion {\r\n  id: string;\r\n  punto_atencion_nombre: string;\r\n  monto_total: number;\r\n  creado_por: string;\r\n  creado_en: string;\r\n}\r\n\r\ninterface SolicitudSaldo {\r\n  id: string;\r\n  punto_atencion_id: string;\r\n  punto_atencion_nombre: string;\r\n  monto_requerido: number;\r\n  estado: string;\r\n  observaciones?: string;\r\n  creado_en: string;\r\n  aprobado_por?: string;\r\n  aprobado_en?: string;\r\n}\r\n\r\ninterface PuntosResponse {\r\n  success: boolean;\r\n  puntos: PuntoAtencion[];\r\n}\r\n\r\nexport default function SaldoServientregaAdmin() {\r\n  const { user } = useAuth();\r\n  const { showConfirmation, ConfirmationDialog } = useConfirmationDialog();\r\n  const esAdmin = user?.rol === \"ADMIN\";\r\n\r\n  const [puntos, setPuntos] = useState<PuntoAtencion[]>([]);\r\n  const [saldos, setSaldos] = useState<Record<string, number>>({});\r\n\r\n  const [historial, setHistorial] = useState<HistorialAsignacion[]>([]);\r\n  const [solicitudes, setSolicitudes] = useState<SolicitudSaldo[]>([]);\r\n  const [filtroFecha, setFiltroFecha] = useState<string>(\"\");\r\n  const [filtroPunto, setFiltroPunto] = useState<string>(\"todos\");\r\n  const [montosInput, setMontosInput] = useState<Record<string, string>>({});\r\n  const [loadingPuntos, setLoadingPuntos] = useState<Record<string, boolean>>(\r\n    {}\r\n  );\r\n\r\n  // Ô£à Obtener puntos y saldos\r\n  const obtenerPuntosYSaldo = async () => {\r\n    try {\r\n      console.log(\r\n        \"­ƒöì SaldoServientregaAdmin: Iniciando carga de puntos y saldos...\"\r\n      );\r\n\r\n      const { data } = await axiosInstance.get<PuntosResponse>(\r\n        \"/servientrega/remitente/puntos\"\r\n      );\r\n      console.log(\"­ƒôì Respuesta completa de puntos Servientrega:\", data);\r\n\r\n      if (!data.success) {\r\n        console.error(\"ÔØî Error en respuesta de puntos:\", data);\r\n        toast.error(\"Error al obtener puntos de atenci├│n\");\r\n        return;\r\n      }\r\n\r\n      const puntosActivos = data.puntos || [];\r\n      console.log(\r\n        `­ƒôì Puntos Servientrega encontrados: ${puntosActivos.length}`,\r\n        puntosActivos.map((p) => ({\r\n          id: p.id,\r\n          nombre: p.nombre,\r\n          ciudad: p.ciudad,\r\n        }))\r\n      );\r\n\r\n      setPuntos(puntosActivos);\r\n\r\n      if (puntosActivos.length === 0) {\r\n        console.warn(\"ÔÜá´©Å No se encontraron puntos de atenci├│n activos\");\r\n        setSaldos({});\r\n        return;\r\n      }\r\n\r\n      console.log(\"­ƒÆ░ Obteniendo saldos para cada punto...\");\r\n      const saldosTemp: Record<string, number> = {};\r\n\r\n      const saldoPromises = puntosActivos.map(async (p) => {\r\n        try {\r\n          console.log(`­ƒÆ░ Consultando saldo para: ${p.nombre} (ID: ${p.id})`);\r\n          const res = await axiosInstance.get<SaldoResponse>(\r\n            `/servientrega/saldo/${p.id}`\r\n          );\r\n          const saldoDisponible = res.data?.disponible ?? 0;\r\n          saldosTemp[p.id] = saldoDisponible;\r\n          console.log(\r\n            `Ô£à Saldo para ${p.nombre}: $${saldoDisponible.toFixed(2)}`\r\n          );\r\n          return { punto: p.nombre, saldo: saldoDisponible };\r\n        } catch (error) {\r\n          console.error(`ÔØî Error obteniendo saldo para ${p.nombre}:`, error);\r\n          saldosTemp[p.id] = 0;\r\n          return { punto: p.nombre, saldo: 0, error: true };\r\n        }\r\n      });\r\n\r\n      const resultadosSaldos = await Promise.all(saldoPromises);\r\n      console.log(\"­ƒÆ░ Resumen de saldos obtenidos:\", resultadosSaldos);\r\n\r\n      setSaldos(saldosTemp);\r\n      console.log(\r\n        \"Ô£à Proceso de carga completado. Saldos finales:\",\r\n        saldosTemp\r\n      );\r\n    } catch (error) {\r\n      console.error(\"ÔØî Error cr├¡tico al obtener puntos o saldos:\", error);\r\n      toast.error(\"Error al cargar informaci├│n de puntos y saldos\");\r\n      setPuntos([]);\r\n      setSaldos({});\r\n    }\r\n  };\r\n\r\n  // Ô£à Obtener historial de asignaciones\r\n  const obtenerHistorial = async () => {\r\n    try {\r\n      const response = await axiosInstance.get(\"/servientrega/saldo/historial\");\r\n      console.log(\"­ƒôè Respuesta completa del historial:\", response);\r\n      console.log(\"­ƒôè Datos del historial recibidos:\", response.data);\r\n\r\n      if (Array.isArray(response.data)) {\r\n        setHistorial(response.data);\r\n        console.log(\r\n          \"­ƒôè Historial establecido:\",\r\n          response.data.length,\r\n          \"registros\"\r\n        );\r\n      } else {\r\n        console.log(\r\n          \"ÔØî Los datos del historial no son un array:\",\r\n          response.data\r\n        );\r\n        console.log(\"ÔØî Tipo de datos recibidos:\", typeof response.data);\r\n        // Intentar extraer datos si est├ín anidados\r\n        if (response.data && Array.isArray(response.data.data)) {\r\n          setHistorial(response.data.data);\r\n          console.log(\r\n            \"­ƒôè Historial establecido desde data.data:\",\r\n            response.data.data.length,\r\n            \"registros\"\r\n          );\r\n        } else {\r\n          setHistorial([]);\r\n        }\r\n      }\r\n    } catch (error) {\r\n      console.error(\"ÔØî Error al obtener historial:\", error);\r\n      setHistorial([]);\r\n    }\r\n  };\r\n\r\n  // Ô£à Obtener solicitudes de saldo\r\n  const obtenerSolicitudes = async () => {\r\n    try {\r\n      const { data } = await axiosInstance.get(\r\n        \"/servientrega/solicitar-saldo/listar\"\r\n      );\r\n      console.log(\"­ƒôï Respuesta completa de solicitudes:\", data);\r\n\r\n      // Verificar si la respuesta tiene la estructura esperada\r\n      if (data && Array.isArray(data.solicitudes)) {\r\n        setSolicitudes(data.solicitudes);\r\n        console.log(\r\n          \"­ƒôï Solicitudes establecidas:\",\r\n          data.solicitudes.length,\r\n          \"registros\"\r\n        );\r\n      } else if (Array.isArray(data)) {\r\n        setSolicitudes(data);\r\n        console.log(\r\n          \"­ƒôï Solicitudes establecidas (array directo):\",\r\n          data.length,\r\n          \"registros\"\r\n        );\r\n      } else {\r\n        console.log(\r\n          \"ÔØî Los datos de solicitudes no tienen el formato esperado:\",\r\n          data\r\n        );\r\n        setSolicitudes([]);\r\n      }\r\n    } catch (error) {\r\n      console.error(\"ÔØî Error al obtener solicitudes de saldo:\", error);\r\n      setSolicitudes([]);\r\n    }\r\n  };\r\n\r\n  // Ô£à Aprobar/Rechazar solicitud\r\n  const responderSolicitud = async (\r\n    id: string,\r\n    estado: \"APROBADA\" | \"RECHAZADA\",\r\n    monto: number,\r\n    punto_id: string\r\n  ) => {\r\n    const solicitud = solicitudes.find((s) => s.id === id);\r\n    const nombrePunto = solicitud?.punto_atencion_nombre || \"punto desconocido\";\r\n\r\n    const accion = estado === \"APROBADA\" ? \"aprobar\" : \"rechazar\";\r\n    const mensaje =\r\n      estado === \"APROBADA\"\r\n        ? `┬┐Est├í seguro de aprobar la solicitud de $${monto.toLocaleString()} para ${nombrePunto}? Esto asignar├í autom├íticamente el saldo.`\r\n        : `┬┐Est├í seguro de rechazar la solicitud de $${monto.toLocaleString()} para ${nombrePunto}?`;\r\n\r\n    showConfirmation(`Confirmar ${accion} solicitud`, mensaje, async () => {\r\n      try {\r\n        console.log(\r\n          `­ƒôï ${\r\n            estado === \"APROBADA\" ? \"Aprobando\" : \"Rechazando\"\r\n          } solicitud ${id} para ${nombrePunto}`\r\n        );\r\n\r\n        await axiosInstance.put(`/servientrega/solicitar-saldo/${id}/estado`, {\r\n          estado,\r\n          aprobado_por: user?.nombre || \"admin\",\r\n        });\r\n\r\n        if (estado === \"APROBADA\") {\r\n          console.log(\r\n            `­ƒÆ░ Asignando saldo autom├íticamente: $${monto} al punto ${punto_id}`\r\n          );\r\n          // Actualiza el saldo autom├íticamente\r\n          await axiosInstance.post(\"/servientrega/saldo\", {\r\n            monto_total: monto,\r\n            creado_por: user?.nombre || \"admin\",\r\n            punto_atencion_id: punto_id,\r\n          });\r\n          toast.success(\r\n            `Ô£à Solicitud aprobada y saldo de $${monto.toLocaleString()} asignado a ${nombrePunto}`\r\n          );\r\n\r\n          // Actualizar todos los datos\r\n          await Promise.all([obtenerPuntosYSaldo(), obtenerHistorial()]);\r\n        } else {\r\n          toast.success(\r\n            `ÔØî Solicitud de ${nombrePunto} rechazada correctamente`\r\n          );\r\n        }\r\n\r\n        obtenerSolicitudes();\r\n      } catch (error) {\r\n        console.error(`ÔØî Error al ${accion} solicitud:`, error);\r\n        toast.error(`ÔØî Error al ${accion} la solicitud`);\r\n      }\r\n    });\r\n  };\r\n\r\n  useEffect(() => {\r\n    obtenerPuntosYSaldo();\r\n    obtenerHistorial();\r\n    if (esAdmin) obtenerSolicitudes();\r\n\r\n    // Auto-actualizar solicitudes cada 30 segundos para el admin\r\n    let interval: NodeJS.Timeout;\r\n    if (esAdmin) {\r\n      interval = setInterval(() => {\r\n        obtenerSolicitudes();\r\n      }, 30000); // 30 segundos\r\n    }\r\n\r\n    return () => {\r\n      if (interval) clearInterval(interval);\r\n    };\r\n  }, [esAdmin]);\r\n\r\n  // Ô£à Filtrar historial\r\n  const historialFiltrado = (historial || []).filter((h) => {\r\n    const coincidePunto =\r\n      !filtroPunto ||\r\n      filtroPunto === \"todos\" ||\r\n      puntos.find((p) => p.id === filtroPunto)?.nombre ===\r\n        h.punto_atencion_nombre;\r\n\r\n    const coincideFecha =\r\n      !filtroFecha ||\r\n      new Date(h.creado_en).toISOString().slice(0, 10) === filtroFecha;\r\n\r\n    return coincidePunto && coincideFecha;\r\n  });\r\n\r\n  // Debug logging\r\n  console.log(\"­ƒöì Estado del historial:\", {\r\n    historialTotal: historial.length,\r\n    historialFiltrado: historialFiltrado.length,\r\n    filtroFecha,\r\n    filtroPunto,\r\n    esAdmin,\r\n  });\r\n\r\n  // Ô£à Funci├│n de debug para verificar datos\r\n  const debugHistorial = async () => {\r\n    try {\r\n      const { data } = await axiosInstance.get(\"/servientrega/saldo/historial\");\r\n      console.log(\"­ƒöº Debug del historial:\", data);\r\n      toast.success(\r\n        `Debug completado. Ver consola. Total registros: ${data.length}`\r\n      );\r\n    } catch (error) {\r\n      console.error(\"ÔØî Error en debug:\", error);\r\n      toast.error(\"Error al ejecutar debug\");\r\n    }\r\n  };\r\n\r\n  // Ô£à Funci├│n para probar conexi├│n a la base de datos\r\n  const testDB = async () => {\r\n    try {\r\n      const { data } = await axiosInstance.get(\"/servientrega/saldo/historial\");\r\n      console.log(\"­ƒöº Test de DB:\", data);\r\n      toast.success(\"Test de DB completado. Ver consola.\");\r\n    } catch (error) {\r\n      console.error(\"ÔØî Error en test de DB:\", error);\r\n      toast.error(\"Error al probar conexi├│n a DB\");\r\n    }\r\n  };\r\n\r\n  return (\r\n    <div className=\"p-3 sm:p-4 md:p-6 space-y-4 sm:space-y-6\">\r\n      <div className=\"flex justify-between items-center mb-4\">\r\n        <h1 className=\"text-2xl font-bold text-gray-800 flex items-center gap-3\">\r\n          ­ƒÆ░ Gesti├│n de Saldos Servientrega\r\n          {esAdmin &&\r\n            (solicitudes || []).filter((s) => s.estado === \"PENDIENTE\").length >\r\n              0 && (\r\n              <span className=\"animate-pulse bg-red-500 text-white text-xs px-3 py-1 rounded-full font-medium\">\r\n                ­ƒöö{\" \"}\r\n                {\r\n                  (solicitudes || []).filter((s) => s.estado === \"PENDIENTE\")\r\n                    .length\r\n                }{\" \"}\r\n                solicitudes pendientes\r\n              </span>\r\n            )}\r\n        </h1>\r\n        <div className=\"flex gap-2\">\r\n          <Button\r\n            variant=\"outline\"\r\n            size=\"sm\"\r\n            onClick={obtenerPuntosYSaldo}\r\n            className=\"text-xs\"\r\n          >\r\n            ­ƒöä Actualizar\r\n          </Button>\r\n          <div className=\"text-sm text-gray-500 px-2 py-1 bg-gray-100 rounded\">\r\n            {puntos.length} puntos cargados\r\n          </div>\r\n        </div>\r\n      </div>\r\n\r\n      {/* Grid de puntos de atenci├│n */}\r\n      {puntos.length === 0 ? (\r\n        <div className=\"text-center py-12\">\r\n          <div className=\"text-gray-400 text-6xl mb-4\">­ƒôì</div>\r\n          <h3 className=\"text-lg font-semibold text-gray-600 mb-2\">\r\n            No se encontraron puntos de atenci├│n\r\n          </h3>\r\n          <p className=\"text-gray-500 mb-4\">\r\n            Verifica que existan puntos de atenci├│n activos en el sistema\r\n          </p>\r\n          <Button\r\n            variant=\"outline\"\r\n            onClick={obtenerPuntosYSaldo}\r\n            className=\"mx-auto\"\r\n          >\r\n            ­ƒöä Recargar puntos\r\n          </Button>\r\n        </div>\r\n      ) : (\r\n        <div className=\"grid grid-cols-1 md:grid-cols-2 xl:grid-cols-3 gap-3 sm:gap-4 md:gap-6\">\r\n          {(puntos || []).map((punto) => {\r\n            const saldoActualPunto = Number(saldos[punto.id] ?? 0);\r\n            const saldoBajoPunto = saldoActualPunto < UMBRAL_SALDO_BAJO;\r\n            const montoInput = montosInput[punto.id] || \"\";\r\n            const loadingPunto = loadingPuntos[punto.id] || false;\r\n\r\n            const handleAsignarSaldoPunto = async () => {\r\n              const monto = parseFloat(montoInput);\r\n              if (isNaN(monto) || monto <= 0) {\r\n                toast.error(\"Ingrese un monto v├ílido mayor a 0\");\r\n                return;\r\n              }\r\n\r\n              showConfirmation(\r\n                \"Confirmar asignaci├│n de saldo Servientrega\",\r\n                `┬┐Est├í seguro de asignar $${monto.toLocaleString()} al punto \"${\r\n                  punto.nombre\r\n                }\" para servicios de Servientrega?`,\r\n                async () => {\r\n                  setLoadingPuntos((prev) => ({ ...prev, [punto.id]: true }));\r\n                  try {\r\n                    console.log(\r\n                      `­ƒÆ░ Asignando saldo Servientrega: $${monto} al punto ${punto.nombre} (${punto.id})`\r\n                    );\r\n\r\n                    const response = await axiosInstance.post(\r\n                      \"/servientrega/saldo\",\r\n                      {\r\n                        monto_total: monto,\r\n                        creado_por: user?.nombre ?? \"admin\",\r\n                        punto_atencion_id: punto.id,\r\n                      }\r\n                    );\r\n\r\n                    console.log(\r\n                      \"Ô£à Respuesta de asignaci├│n de saldo:\",\r\n                      response.data\r\n                    );\r\n\r\n                    toast.success(\r\n                      `Ô£à Saldo de $${monto.toLocaleString()} asignado correctamente a ${\r\n                        punto.nombre\r\n                      }`\r\n                    );\r\n                    setMontosInput((prev) => ({ ...prev, [punto.id]: \"\" }));\r\n\r\n                    // Actualizar datos\r\n                    await Promise.all([\r\n                      obtenerPuntosYSaldo(),\r\n                      obtenerHistorial(),\r\n                    ]);\r\n                  } catch (error) {\r\n                    console.error(\r\n                      \"ÔØî Error al asignar saldo Servientrega:\",\r\n                      error\r\n                    );\r\n                    toast.error(\"Error al asignar saldo\");\r\n                  } finally {\r\n                    setLoadingPuntos((prev) => ({\r\n                      ...prev,\r\n                      [punto.id]: false,\r\n                    }));\r\n                  }\r\n                }\r\n              );\r\n            };\r\n\r\n            return (\r\n              <div\r\n                key={punto.id}\r\n                className=\"border rounded-lg p-6 bg-white shadow-sm space-y-4\"\r\n              >\r\n                <div className=\"mb-3\">\r\n                  <div className=\"flex items-center justify-between mb-1\">\r\n                    <span className=\"font-semibold text-lg\">\r\n                      {punto.nombre}\r\n                    </span>\r\n                    <span className=\"text-xs bg-cyan-100 text-cyan-700 px-2 py-1 rounded-full\">\r\n                      ­ƒôª Servientrega\r\n                    </span>\r\n                  </div>\r\n                  <div className=\"text-sm text-gray-600 space-y-1\">\r\n                    <div>\r\n                      ­ƒôì {punto.ciudad}, {punto.provincia}\r\n                    </div>\r\n                    {punto.servientrega_agencia_codigo && (\r\n                      <div className=\"flex items-center gap-2\">\r\n                        <span className=\"text-cyan-600 font-medium\">\r\n                          ­ƒÅó{\" \"}\r\n                          {punto.servientrega_agencia_nombre ||\r\n                            \"Agencia Servientrega\"}\r\n                        </span>\r\n                        <span className=\"text-xs bg-gray-100 px-2 py-1 rounded\">\r\n                          {punto.servientrega_agencia_codigo}\r\n                        </span>\r\n                      </div>\r\n                    )}\r\n                  </div>\r\n                </div>\r\n\r\n                {/* Saldo actual */}\r\n                <div>\r\n                  <Label className=\"text-sm font-medium text-gray-600\">\r\n                    Saldo Servientrega Disponible\r\n                  </Label>\r\n                  <div\r\n                    className={`font-semibold text-xl mb-2 ${\r\n                      saldoBajoPunto ? \"text-red-600\" : \"text-green-700\"\r\n                    }`}\r\n                  >\r\n                    $\r\n                    {saldoActualPunto.toLocaleString(\"es-ES\", {\r\n                      minimumFractionDigits: 2,\r\n                      maximumFractionDigits: 2,\r\n                    })}\r\n                    {saldoBajoPunto && (\r\n                      <span className=\"ml-2 text-xs bg-red-100 text-red-600 px-2 py-1 rounded-full animate-pulse\">\r\n                        ÔÜá´©Å Saldo bajo\r\n                      </span>\r\n                    )}\r\n                  </div>\r\n                  <div className=\"text-xs text-gray-500\">\r\n                    Umbral m├¡nimo: ${UMBRAL_SALDO_BAJO.toFixed(2)}\r\n                  </div>\r\n                </div>\r\n\r\n                {/* Asignaci├│n de saldo */}\r\n                {esAdmin && (\r\n                  <>\r\n                    <div>\r\n                      <Label className=\"text-sm font-medium text-gray-600\">\r\n                        Asignar Saldo para Servientrega\r\n                      </Label>\r\n                      <Input\r\n                        type=\"number\"\r\n                        step=\"0.01\"\r\n                        min=\"0\"\r\n                        value={montoInput}\r\n                        onChange={(e) =>\r\n                          setMontosInput((prev) => ({\r\n                            ...prev,\r\n                            [punto.id]: e.target.value,\r\n                          }))\r\n                        }\r\n                        placeholder=\"0.00\"\r\n                        className=\"mt-1\"\r\n                        disabled={loadingPunto}\r\n                      />\r\n                    </div>\r\n                    <Button\r\n                      className=\"w-full\"\r\n                      onClick={handleAsignarSaldoPunto}\r\n                      disabled={\r\n                        loadingPunto ||\r\n                        !montoInput.trim() ||\r\n                        parseFloat(montoInput) <= 0\r\n                      }\r\n                    >\r\n                      {loadingPunto ? (\r\n                        <>\r\n                          <span className=\"animate-spin mr-2\">ÔÅ│</span>\r\n                          Asignando...\r\n                        </>\r\n                      ) : (\r\n                        <>­ƒÆ░ Asignar Saldo</>\r\n                      )}\r\n                    </Button>\r\n                  </>\r\n                )}\r\n\r\n                {/* Informaci├│n adicional para no-admin */}\r\n                {!esAdmin && (\r\n                  <div className=\"text-center py-2 text-gray-500 text-sm\">\r\n                    ­ƒæñ Solo los administradores pueden asignar saldos\r\n                  </div>\r\n                )}\r\n              </div>\r\n            );\r\n          })}\r\n        </div>\r\n      )}\r\n\r\n      {/* Solicitudes de saldo */}\r\n      {esAdmin && (\r\n        <Card className=\"p-4\">\r\n          <CardHeader>\r\n            <CardTitle className=\"flex items-center justify-between text-lg\">\r\n              <div className=\"flex items-center gap-2\">\r\n                <span>­ƒôï Solicitudes de saldo</span>\r\n                {(solicitudes || []).filter((s) => s.estado === \"PENDIENTE\")\r\n                  .length > 0 && (\r\n                  <span className=\"bg-red-500 text-white text-xs px-2 py-1 rounded-full\">\r\n                    {\r\n                      (solicitudes || []).filter(\r\n                        (s) => s.estado === \"PENDIENTE\"\r\n                      ).length\r\n                    }{\" \"}\r\n                    pendientes\r\n                  </span>\r\n                )}\r\n              </div>\r\n              <Button\r\n                variant=\"outline\"\r\n                size=\"sm\"\r\n                onClick={obtenerSolicitudes}\r\n                className=\"text-xs\"\r\n              >\r\n                ­ƒöä Actualizar\r\n              </Button>\r\n            </CardTitle>\r\n          </CardHeader>\r\n          <CardContent>\r\n            {(solicitudes || []).length === 0 ? (\r\n              <div className=\"text-center py-8\">\r\n                <p className=\"text-gray-500 mb-2\">\r\n                  ­ƒô¡ No hay solicitudes de saldo\r\n                </p>\r\n                <p className=\"text-sm text-gray-400\">\r\n                  Las solicitudes aparecer├ín aqu├¡ cuando los operadores las\r\n                  env├¡en\r\n                </p>\r\n              </div>\r\n            ) : (\r\n              <div className=\"space-y-4\">\r\n                {/* Solicitudes pendientes primero */}\r\n                {(solicitudes || [])\r\n                  .filter((sol) => sol.estado === \"PENDIENTE\")\r\n                  .map((sol) => (\r\n                    <div\r\n                      key={sol.id}\r\n                      className=\"border-2 border-yellow-300 rounded-lg p-4 bg-yellow-50\"\r\n                    >\r\n                      <div className=\"flex justify-between items-start\">\r\n                        <div className=\"flex-1\">\r\n                          <div className=\"flex items-center gap-2 mb-2\">\r\n                            <h3 className=\"font-semibold text-lg text-gray-800\">\r\n                              {sol.punto_atencion_nombre}\r\n                            </h3>\r\n                            <span className=\"bg-yellow-500 text-white text-xs px-2 py-1 rounded-full\">\r\n                              PENDIENTE\r\n                            </span>\r\n                          </div>\r\n\r\n                          <div className=\"grid grid-cols-1 md:grid-cols-2 gap-4 mb-3\">\r\n                            <div>\r\n                              <p className=\"text-sm text-gray-600\">\r\n                                <strong>­ƒÆ░ Monto solicitado:</strong>\r\n                              </p>\r\n                              <p className=\"text-xl font-bold text-green-600\">\r\n                                ${Number(sol.monto_requerido).toFixed(2)}\r\n                              </p>\r\n                            </div>\r\n                            <div>\r\n                              <p className=\"text-sm text-gray-600\">\r\n                                <strong>­ƒôà Fecha de solicitud:</strong>\r\n                              </p>\r\n                              <p className=\"text-sm\">\r\n                                {new Date(sol.creado_en).toLocaleString()}\r\n                              </p>\r\n                            </div>\r\n                          </div>\r\n\r\n                          {sol.observaciones && (\r\n                            <div className=\"mb-3\">\r\n                              <p className=\"text-sm text-gray-600\">\r\n                                <strong>­ƒôØ Observaciones:</strong>\r\n                              </p>\r\n                              <p className=\"text-sm bg-white p-2 rounded border\">\r\n                                {sol.observaciones}\r\n                              </p>\r\n                            </div>\r\n                          )}\r\n\r\n                          <div className=\"text-xs text-gray-500\">\r\n                            <strong>ID:</strong> {sol.id}\r\n                          </div>\r\n                        </div>\r\n\r\n                        <div className=\"flex flex-col gap-2 ml-4\">\r\n                          <Button\r\n                            className=\"bg-green-600 hover:bg-green-700 text-white px-6\"\r\n                            onClick={() =>\r\n                              responderSolicitud(\r\n                                sol.id,\r\n                                \"APROBADA\",\r\n                                sol.monto_requerido,\r\n                                sol.punto_atencion_id\r\n                              )\r\n                            }\r\n                          >\r\n                            Ô£à Aprobar\r\n                          </Button>\r\n                          <Button\r\n                            className=\"bg-red-600 hover:bg-red-700 text-white px-6\"\r\n                            onClick={() =>\r\n                              responderSolicitud(\r\n                                sol.id,\r\n                                \"RECHAZADA\",\r\n                                sol.monto_requerido,\r\n                                sol.punto_atencion_id\r\n                              )\r\n                            }\r\n                          >\r\n                            ÔØî Rechazar\r\n                          </Button>\r\n                        </div>\r\n                      </div>\r\n                    </div>\r\n                  ))}\r\n\r\n                {/* Solicitudes procesadas */}\r\n                {(solicitudes || []).filter((sol) => sol.estado !== \"PENDIENTE\")\r\n                  .length > 0 && (\r\n                  <div className=\"mt-6\">\r\n                    <h4 className=\"font-semibold text-gray-700 mb-3 flex items-center gap-2\">\r\n                      ­ƒôï Historial de solicitudes procesadas\r\n                      <span className=\"text-xs bg-gray-200 px-2 py-1 rounded\">\r\n                        {\r\n                          (solicitudes || []).filter(\r\n                            (sol) => sol.estado !== \"PENDIENTE\"\r\n                          ).length\r\n                        }\r\n                      </span>\r\n                    </h4>\r\n\r\n                    <div className=\"space-y-3\">\r\n                      {(solicitudes || [])\r\n                        .filter((sol) => sol.estado !== \"PENDIENTE\")\r\n                        .sort(\r\n                          (a, b) =>\r\n                            new Date(b.creado_en).getTime() -\r\n                            new Date(a.creado_en).getTime()\r\n                        )\r\n                        .slice(0, 5) // Mostrar solo las ├║ltimas 5\r\n                        .map((sol) => (\r\n                          <div\r\n                            key={sol.id}\r\n                            className={`border rounded-lg p-3 ${\r\n                              sol.estado === \"APROBADA\"\r\n                                ? \"bg-green-50 border-green-200\"\r\n                                : \"bg-red-50 border-red-200\"\r\n                            }`}\r\n                          >\r\n                            <div className=\"flex justify-between items-center\">\r\n                              <div>\r\n                                <div className=\"flex items-center gap-2 mb-1\">\r\n                                  <span className=\"font-medium text-gray-800\">\r\n                                    {sol.punto_atencion_nombre}\r\n                                  </span>\r\n                                  <span\r\n                                    className={`text-xs px-2 py-1 rounded-full ${\r\n                                      sol.estado === \"APROBADA\"\r\n                                        ? \"bg-green-500 text-white\"\r\n                                        : \"bg-red-500 text-white\"\r\n                                    }`}\r\n                                  >\r\n                                    {sol.estado}\r\n                                  </span>\r\n                                </div>\r\n                                <p className=\"text-sm text-gray-600\">\r\n                                  <strong>Monto:</strong> $\r\n                                  {Number(sol.monto_requerido).toFixed(2)} |\r\n                                  <strong> Fecha:</strong>{\" \"}\r\n                                  {new Date(sol.creado_en).toLocaleDateString()}\r\n                                  {sol.aprobado_por && (\r\n                                    <span>\r\n                                      {\" \"}\r\n                                      | <strong>Por:</strong> {sol.aprobado_por}\r\n                                    </span>\r\n                                  )}\r\n                                </p>\r\n                                {sol.observaciones && (\r\n                                  <p className=\"text-xs text-gray-500 mt-1\">\r\n                                    <strong>Obs:</strong> {sol.observaciones}\r\n                                  </p>\r\n                                )}\r\n                              </div>\r\n                              <div className=\"text-right\">\r\n                                <span\r\n                                  className={`text-2xl ${\r\n                                    sol.estado === \"APROBADA\"\r\n                                      ? \"text-green-600\"\r\n                                      : \"text-red-600\"\r\n                                  }`}\r\n                                >\r\n                                  {sol.estado === \"APROBADA\" ? \"Ô£à\" : \"ÔØî\"}\r\n                                </span>\r\n                              </div>\r\n                            </div>\r\n                          </div>\r\n                        ))}\r\n                    </div>\r\n\r\n                    {(solicitudes || []).filter(\r\n                      (sol) => sol.estado !== \"PENDIENTE\"\r\n                    ).length > 5 && (\r\n                      <p className=\"text-xs text-gray-500 text-center mt-2\">\r\n                        Mostrando las ├║ltimas 5 solicitudes procesadas\r\n                      </p>\r\n                    )}\r\n                  </div>\r\n                )}\r\n              </div>\r\n            )}\r\n          </CardContent>\r\n        </Card>\r\n      )}\r\n\r\n      {/* Historial de asignaciones */}\r\n      {esAdmin && (\r\n        <Card className=\"p-4\">\r\n          <CardHeader>\r\n            <CardTitle className=\"text-lg flex justify-between items-center\">\r\n              <span>\r\n                Historial de asignaciones ({(historial || []).length} total,{\" \"}\r\n                {historialFiltrado.length} mostrados)\r\n              </span>\r\n              <div className=\"flex gap-1\">\r\n                <Button\r\n                  variant=\"outline\"\r\n                  size=\"sm\"\r\n                  onClick={testDB}\r\n                  className=\"text-xs\"\r\n                >\r\n                  ­ƒöî Test DB\r\n                </Button>\r\n                <Button\r\n                  variant=\"outline\"\r\n                  size=\"sm\"\r\n                  onClick={debugHistorial}\r\n                  className=\"text-xs\"\r\n                >\r\n                  ­ƒöº Debug\r\n                </Button>\r\n              </div>\r\n            </CardTitle>\r\n          </CardHeader>\r\n          <CardContent>\r\n            {/* Controles de filtro */}\r\n            <div className=\"grid grid-cols-1 md:grid-cols-3 gap-4 mb-4 p-4 bg-gray-50 rounded-lg\">\r\n              <div className=\"space-y-2\">\r\n                <Label>Filtrar por punto</Label>\r\n                <Select value={filtroPunto} onValueChange={setFiltroPunto}>\r\n                  <SelectTrigger>\r\n                    <SelectValue placeholder=\"Todos los puntos\" />\r\n                  </SelectTrigger>\r\n                  <SelectContent>\r\n                    <SelectItem value=\"todos\">Todos los puntos</SelectItem>\r\n                    {(puntos || []).map((p) => (\r\n                      <SelectItem key={p.id} value={p.id}>\r\n                        {p.nombre}\r\n                      </SelectItem>\r\n                    ))}\r\n                  </SelectContent>\r\n                </Select>\r\n              </div>\r\n              <div className=\"space-y-2\">\r\n                <Label>Filtrar por fecha</Label>\r\n                <Input\r\n                  type=\"date\"\r\n                  value={filtroFecha}\r\n                  onChange={(e) => setFiltroFecha(e.target.value)}\r\n                />\r\n              </div>\r\n              <div className=\"space-y-2\">\r\n                <Label>&nbsp;</Label>\r\n                <Button\r\n                  variant=\"outline\"\r\n                  onClick={() => {\r\n                    setFiltroPunto(\"todos\");\r\n                    setFiltroFecha(\"\");\r\n                  }}\r\n                  className=\"w-full\"\r\n                >\r\n                  Limpiar filtros\r\n                </Button>\r\n              </div>\r\n            </div>\r\n\r\n            {historialFiltrado.length === 0 ? (\r\n              <div className=\"text-center py-8\">\r\n                <p className=\"text-sm text-gray-500 italic\">\r\n                  {(historial || []).length === 0\r\n                    ? \"No hay asignaciones registradas.\"\r\n                    : \"No hay asignaciones que coincidan con los filtros aplicados.\"}\r\n                </p>\r\n                {(historial || []).length > 0 &&\r\n                  (filtroFecha || (filtroPunto && filtroPunto !== \"todos\")) && (\r\n                    <Button\r\n                      variant=\"outline\"\r\n                      onClick={() => {\r\n                        setFiltroPunto(\"todos\");\r\n                        setFiltroFecha(\"\");\r\n                      }}\r\n                      className=\"mt-2\"\r\n                    >\r\n                      Ver todas las asignaciones\r\n                    </Button>\r\n                  )}\r\n              </div>\r\n            ) : (\r\n              <ul className=\"space-y-2 max-h-[400px] overflow-auto pr-2\">\r\n                {historialFiltrado.map((h) => (\r\n                  <li\r\n                    key={h.id}\r\n                    className=\"border p-3 rounded-md bg-gray-50 hover:bg-gray-100 transition\"\r\n                  >\r\n                    <div className=\"flex flex-col sm:flex-row sm:justify-between sm:items-center\">\r\n                      <div className=\"flex-1 space-y-1\">\r\n                        <p className=\"text-base font-medium text-gray-800\">\r\n                          {h.punto_atencion_nombre}\r\n                        </p>\r\n                        <p className=\"text-xs text-gray-500\">\r\n                          Asignado por: {h.creado_por}\r\n                        </p>\r\n                      </div>\r\n                      <div className=\"flex flex-col sm:items-end mt-2 sm:mt-0\">\r\n                        <span className=\"text-green-700 font-bold\">\r\n                          +${Number(h.monto_total || 0).toFixed(2)}\r\n                        </span>\r\n                        <span className=\"text-gray-500 text-xs\">\r\n                          {new Date(h.creado_en).toLocaleString()}\r\n                        </span>\r\n                      </div>\r\n                    </div>\r\n                  </li>\r\n                ))}\r\n              </ul>\r\n            )}\r\n          </CardContent>\r\n        </Card>\r\n      )}\r\n\r\n      <ConfirmationDialog />\r\n    </div>\r\n  );\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\oswal\\OneDrive\\Documentos\\Punto Cambio\\punto_cambio_new\\src\\components\\admin\\ServiciosExternosAdmin.tsx","messages":[{"ruleId":"react-hooks/exhaustive-deps","severity":1,"message":"React Hook useEffect has a missing dependency: 'obtenerMovimientos'. Either include it or remove the dependency array.","line":355,"column":6,"nodeType":"ArrayExpression","endLine":355,"endColumn":24,"suggestions":[{"desc":"Update the dependencies array to be: [filtros, esAdmin, obtenerMovimientos]","fix":{"range":[10506,10524],"text":"[filtros, esAdmin, obtenerMovimientos]"}}]}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":1,"fixableErrorCount":0,"fixableWarningCount":0,"source":"\"use client\";\r\n\r\nimport { useEffect, useState } from \"react\";\r\nimport axios from \"axios\";\r\nimport axiosInstance from \"@/services/axiosInstance\";\r\nimport { useAuth } from \"@/hooks/useAuth\";\r\nimport { useConfirmationDialog } from \"@/hooks/useConfirmationDialog\";\r\nimport { Card, CardHeader, CardTitle, CardContent } from \"@/components/ui/card\";\r\nimport { Input } from \"@/components/ui/input\";\r\nimport { Button } from \"@/components/ui/button\";\r\nimport { Label } from \"@/components/ui/label\";\r\nimport {\r\n  Select,\r\n  SelectItem,\r\n  SelectContent,\r\n  SelectTrigger,\r\n  SelectValue,\r\n} from \"@/components/ui/select\";\r\nimport { toast } from \"sonner\";\r\n\r\nconst isRecord = (v: unknown): v is Record<string, unknown> =>\r\n  v !== null && typeof v === \"object\";\r\n\r\nconst getErrorMessage = (error: unknown, fallback: string): string => {\r\n  if (axios.isAxiosError(error)) {\r\n    const data = error.response?.data;\r\n    if (isRecord(data)) {\r\n      const err = data.error;\r\n      const msg = data.message;\r\n      if (typeof err === \"string\" && err.trim()) return err;\r\n      if (typeof msg === \"string\" && msg.trim()) return msg;\r\n    }\r\n    return error.message || fallback;\r\n  }\r\n\r\n  return error instanceof Error ? error.message : fallback;\r\n};\r\n\r\ninterface PuntoAtencion {\r\n  id: string;\r\n  nombre: string;\r\n  ciudad: string;\r\n  provincia: string;\r\n}\r\n\r\ninterface MovimientoServicioExterno {\r\n  id: string;\r\n  servicio: string;\r\n  tipo: \"INGRESO\" | \"EGRESO\";\r\n  monto: number;\r\n  descripcion?: string;\r\n  punto_atencion_nombre: string;\r\n  creado_por: string;\r\n  creado_en: string;\r\n}\r\n\r\ninterface SaldoServicioExterno {\r\n  servicio: string;\r\n  saldo_actual: number;\r\n  ultimo_movimiento?: string;\r\n}\r\n\r\ninterface SaldoPorPuntoServicio {\r\n  punto_atencion_id: string;\r\n  punto_atencion_nombre: string;\r\n  servicio: string;\r\n  saldo_actual: number;\r\n}\r\n\r\ninterface HistorialAsignacion {\r\n  id: string;\r\n  punto_atencion_nombre: string;\r\n  servicio: string;\r\n  monto_asignado: number;\r\n  creado_por: string;\r\n  creado_en: string;\r\n}\r\n\r\nconst SERVICIOS_EXTERNOS = [\r\n  \"YAGANASTE\",\r\n  \"BANCO_GUAYAQUIL\",\r\n  \"WESTERN\",\r\n  \"PRODUBANCO\",\r\n  \"BANCO_PACIFICO\",\r\n  \"SERVIENTREGA\",\r\n  \"INSUMOS_OFICINA\",\r\n  \"INSUMOS_LIMPIEZA\",\r\n  \"OTROS\",\r\n] as const;\r\n\r\ntype ServicioExterno = (typeof SERVICIOS_EXTERNOS)[number];\r\n\r\nconst UMBRAL_SALDO_BAJO = 10; // USD\r\n\r\nexport default function ServiciosExternosAdmin() {\r\n  const { user } = useAuth();\r\n  const { showConfirmation, ConfirmationDialog } = useConfirmationDialog();\r\n  const esAdmin = user?.rol === \"ADMIN\" || user?.rol === \"SUPER_USUARIO\";\r\n\r\n  const [puntos, setPuntos] = useState<PuntoAtencion[]>([]);\r\n  const [movimientos, setMovimientos] = useState<MovimientoServicioExterno[]>(\r\n    []\r\n  );\r\n  const [saldos, setSaldos] = useState<SaldoServicioExterno[]>([]);\r\n  const [saldosPorPunto, setSaldosPorPunto] = useState<SaldoPorPuntoServicio[]>(\r\n    []\r\n  );\r\n  const [historialAsignaciones, setHistorialAsignaciones] = useState<\r\n    HistorialAsignacion[]\r\n  >([]);\r\n  const [loading, setLoading] = useState(false);\r\n  const [saving, setSaving] = useState(false);\r\n  const [vistaActual, setVistaActual] = useState<\"asignacion\" | \"movimientos\">(\r\n    \"asignacion\"\r\n  );\r\n\r\n  // Estados para asignaci├│n de saldos\r\n  const [montosAsignacion, setMontosAsignacion] = useState<\r\n    Record<string, Record<string, string>>\r\n  >({});\r\n  const [tiposAsignacion, setTiposAsignacion] = useState<\r\n    Record<string, Record<string, \"INICIAL\" | \"RECARGA\">>\r\n  >({});\r\n  const [loadingAsignaciones, setLoadingAsignaciones] = useState<\r\n    Record<string, boolean>\r\n  >({});\r\n\r\n  // Formulario para nuevo movimiento\r\n  const [nuevoMovimiento, setNuevoMovimiento] = useState({\r\n    punto_atencion_id: \"\",\r\n    servicio: \"\" as ServicioExterno | \"\",\r\n    tipo: \"\" as \"INGRESO\" | \"EGRESO\" | \"\",\r\n    monto: \"\",\r\n    descripcion: \"\",\r\n  });\r\n\r\n  // Filtros\r\n  const [filtros, setFiltros] = useState({\r\n    punto_id: \"todos\",\r\n    servicio: \"todos\",\r\n    fecha_desde: \"\",\r\n    fecha_hasta: \"\",\r\n  });\r\n\r\n  const obtenerPuntos = async () => {\r\n    try {\r\n      const { data } = await axiosInstance.get(\"/puntos-atencion\");\r\n      setPuntos(data.puntos || []);\r\n    } catch (error) {\r\n      console.error(\"Error al obtener puntos:\", error);\r\n      toast.error(\"Error al cargar puntos de atenci├│n\");\r\n    }\r\n  };\r\n\r\n  const obtenerMovimientos = async () => {\r\n    try {\r\n      setLoading(true);\r\n      const params = new URLSearchParams();\r\n\r\n      if (filtros.punto_id !== \"todos\")\r\n        params.append(\"punto_id\", filtros.punto_id);\r\n      if (filtros.servicio !== \"todos\")\r\n        params.append(\"servicio\", filtros.servicio);\r\n      if (filtros.fecha_desde)\r\n        params.append(\"fecha_desde\", filtros.fecha_desde);\r\n      if (filtros.fecha_hasta)\r\n        params.append(\"fecha_hasta\", filtros.fecha_hasta);\r\n\r\n      const { data } = await axiosInstance.get(\r\n        `/servicios-externos/movimientos?${params}`\r\n      );\r\n      setMovimientos(data.movimientos || []);\r\n    } catch (error) {\r\n      console.error(\"Error al obtener movimientos:\", error);\r\n      toast.error(\"Error al cargar movimientos\");\r\n      setMovimientos([]);\r\n    } finally {\r\n      setLoading(false);\r\n    }\r\n  };\r\n\r\n  const obtenerSaldos = async () => {\r\n    try {\r\n      const { data } = await axiosInstance.get(\"/servicios-externos/saldos\");\r\n      setSaldos(data.saldos || []);\r\n    } catch (error) {\r\n      console.error(\"Error al obtener saldos:\", error);\r\n      toast.error(\"Error al cargar saldos\");\r\n      setSaldos([]);\r\n    }\r\n  };\r\n\r\n  const obtenerSaldosPorPunto = async () => {\r\n    try {\r\n      const { data } = await axiosInstance.get(\r\n        \"/servicios-externos/saldos-por-punto\"\r\n      );\r\n      setSaldosPorPunto(data.saldos || []);\r\n    } catch (error) {\r\n      console.error(\"Error al obtener saldos por punto:\", error);\r\n      toast.error(\"Error al cargar saldos por punto\");\r\n      setSaldosPorPunto([]);\r\n    }\r\n  };\r\n\r\n  const obtenerHistorialAsignaciones = async () => {\r\n    try {\r\n      const { data } = await axiosInstance.get(\r\n        \"/servicios-externos/historial-asignaciones\"\r\n      );\r\n      setHistorialAsignaciones(data.historial || []);\r\n    } catch (error) {\r\n      console.error(\"Error al obtener historial:\", error);\r\n      toast.error(\"Error al cargar historial de asignaciones\");\r\n      setHistorialAsignaciones([]);\r\n    }\r\n  };\r\n\r\n  const crearMovimiento = async () => {\r\n    if (\r\n      !nuevoMovimiento.punto_atencion_id ||\r\n      !nuevoMovimiento.servicio ||\r\n      !nuevoMovimiento.tipo ||\r\n      !nuevoMovimiento.monto\r\n    ) {\r\n      toast.error(\"Todos los campos son obligatorios\");\r\n      return;\r\n    }\r\n\r\n    const monto = parseFloat(nuevoMovimiento.monto);\r\n    if (isNaN(monto) || monto <= 0) {\r\n      toast.error(\"El monto debe ser un n├║mero positivo\");\r\n      return;\r\n    }\r\n\r\n    const punto = puntos.find(\r\n      (p) => p.id === nuevoMovimiento.punto_atencion_id\r\n    );\r\n    const mensaje = `┬┐Confirma crear un ${nuevoMovimiento.tipo.toLowerCase()} de $${monto.toFixed(\r\n      2\r\n    )} para ${nuevoMovimiento.servicio} en ${punto?.nombre}?`;\r\n\r\n    showConfirmation(\"Confirmar movimiento\", mensaje, async () => {\r\n      try {\r\n        setSaving(true);\r\n        await axiosInstance.post(\"/servicios-externos/movimientos\", {\r\n          punto_atencion_id: nuevoMovimiento.punto_atencion_id,\r\n          servicio: nuevoMovimiento.servicio,\r\n          tipo: nuevoMovimiento.tipo,\r\n          monto: monto,\r\n          descripcion: nuevoMovimiento.descripcion || undefined,\r\n        });\r\n\r\n        toast.success(\"Movimiento creado correctamente\");\r\n\r\n        // Limpiar formulario\r\n        setNuevoMovimiento({\r\n          punto_atencion_id: \"\",\r\n          servicio: \"\",\r\n          tipo: \"\",\r\n          monto: \"\",\r\n          descripcion: \"\",\r\n        });\r\n\r\n        // Recargar datos\r\n        await Promise.all([obtenerMovimientos(), obtenerSaldos()]);\r\n      } catch (error: unknown) {\r\n        console.error(\"Error al crear movimiento:\", error);\r\n        toast.error(getErrorMessage(error, \"Error al crear el movimiento\"));\r\n      } finally {\r\n        setSaving(false);\r\n      }\r\n    });\r\n  };\r\n\r\n  const asignarSaldo = async (\r\n    puntoId: string,\r\n    servicio: ServicioExterno,\r\n    monto: number,\r\n    tipoAsignacion: \"INICIAL\" | \"RECARGA\"\r\n  ) => {\r\n    const punto = puntos.find((p) => p.id === puntoId);\r\n    const tipoTexto = tipoAsignacion === \"INICIAL\" ? \"establecer\" : \"recargar\";\r\n    const mensaje = `┬┐Est├í seguro de ${tipoTexto} $${monto.toFixed(\r\n      2\r\n    )} de ${servicio} al punto \"${punto?.nombre}\"?${\r\n      tipoAsignacion === \"INICIAL\"\r\n        ? \" (Esto REEMPLAZAR├ü el saldo actual)\"\r\n        : \" (Esto se SUMAR├ü al saldo actual)\"\r\n    }`;\r\n\r\n    showConfirmation(\"Confirmar asignaci├│n de saldo\", mensaje, async () => {\r\n      const key = `${puntoId}-${servicio}`;\r\n      setLoadingAsignaciones((prev) => ({ ...prev, [key]: true }));\r\n\r\n      try {\r\n        await axiosInstance.post(\"/servicios-externos/asignar-saldo\", {\r\n          punto_atencion_id: puntoId,\r\n          servicio: servicio,\r\n          monto_asignado: monto,\r\n          tipo_asignacion: tipoAsignacion,\r\n          creado_por: user?.nombre || \"admin\",\r\n        });\r\n\r\n        toast.success(\r\n          `Ô£à Saldo de $${monto.toFixed(2)} asignado correctamente a ${\r\n            punto?.nombre\r\n          } para ${servicio}`\r\n        );\r\n\r\n        // Limpiar el input y el tipo\r\n        setMontosAsignacion((prev) => ({\r\n          ...prev,\r\n          [puntoId]: {\r\n            ...prev[puntoId],\r\n            [servicio]: \"\",\r\n          },\r\n        }));\r\n        setTiposAsignacion((prev) => ({\r\n          ...prev,\r\n          [puntoId]: {\r\n            ...prev[puntoId],\r\n            [servicio]: \"INICIAL\",\r\n          },\r\n        }));\r\n\r\n        // Recargar datos\r\n        await Promise.all([\r\n          obtenerSaldosPorPunto(),\r\n          obtenerHistorialAsignaciones(),\r\n          obtenerSaldos(),\r\n        ]);\r\n      } catch (error: unknown) {\r\n        console.error(\"Error al asignar saldo:\", error);\r\n        toast.error(getErrorMessage(error, \"Error al asignar el saldo\"));\r\n      } finally {\r\n        setLoadingAsignaciones((prev) => ({ ...prev, [key]: false }));\r\n      }\r\n    });\r\n  };\r\n\r\n  useEffect(() => {\r\n    if (esAdmin) {\r\n      obtenerPuntos();\r\n      obtenerSaldos();\r\n      obtenerSaldosPorPunto();\r\n      obtenerHistorialAsignaciones();\r\n    }\r\n  }, [esAdmin]);\r\n\r\n  useEffect(() => {\r\n    if (esAdmin) {\r\n      obtenerMovimientos();\r\n    }\r\n  }, [filtros, esAdmin]);\r\n\r\n  if (!esAdmin) {\r\n    return (\r\n      <div className=\"p-6\">\r\n        <Card>\r\n          <CardContent className=\"p-6 text-center\">\r\n            <h3 className=\"text-lg font-semibold text-gray-600 mb-2\">\r\n              Acceso Restringido\r\n            </h3>\r\n            <p className=\"text-gray-500\">\r\n              Solo los administradores pueden acceder a esta secci├│n\r\n            </p>\r\n          </CardContent>\r\n        </Card>\r\n      </div>\r\n    );\r\n  }\r\n\r\n  return (\r\n    <div className=\"h-full flex flex-col gap-4\">\r\n      {/* Header - Siempre visible */}\r\n      <div className=\"flex-shrink-0 flex justify-between items-center\">\r\n        <div>\r\n          <h1 className=\"text-lg font-bold text-gray-800 flex items-center gap-2\">\r\n            ­ƒÆ╝ Gesti├│n de Saldos - Servicios Externos\r\n          </h1>\r\n          <p className=\"text-xs text-gray-600\">\r\n            Administra saldos y movimientos de servicios externos por punto\r\n          </p>\r\n        </div>\r\n        <div className=\"flex gap-2\">\r\n          <div className=\"flex bg-gray-100 rounded-lg p-1\">\r\n            <Button\r\n              variant={vistaActual === \"asignacion\" ? \"default\" : \"ghost\"}\r\n              size=\"sm\"\r\n              onClick={() => setVistaActual(\"asignacion\")}\r\n            >\r\n              ­ƒÆ░ Asignaci├│n de Saldos\r\n            </Button>\r\n            <Button\r\n              variant={vistaActual === \"movimientos\" ? \"default\" : \"ghost\"}\r\n              size=\"sm\"\r\n              onClick={() => setVistaActual(\"movimientos\")}\r\n            >\r\n              ­ƒôï Movimientos\r\n            </Button>\r\n          </div>\r\n          <Button\r\n            variant=\"outline\"\r\n            size=\"sm\"\r\n            onClick={() => {\r\n              obtenerSaldosPorPunto();\r\n              obtenerHistorialAsignaciones();\r\n              obtenerSaldos();\r\n              if (vistaActual === \"movimientos\") obtenerMovimientos();\r\n            }}\r\n            className=\"text-xs\"\r\n          >\r\n            ­ƒöä Actualizar\r\n          </Button>\r\n          <div className=\"text-sm text-gray-500 px-2 py-1 bg-gray-100 rounded\">\r\n            {puntos.length} puntos cargados\r\n          </div>\r\n        </div>\r\n      </div>\r\n\r\n      {/* Contenido scrolleable */}\r\n      <div className=\"flex-1 min-h-0 overflow-y-auto space-y-4\">\r\n        {vistaActual === \"asignacion\" ? (\r\n          <>\r\n            {/* Resumen de Saldos Totales */}\r\n            <Card className=\"flex-shrink-0\">\r\n              <CardHeader className=\"p-3\">\r\n                <CardTitle className=\"text-sm\">\r\n                  ­ƒôè Saldos Totales por Servicio\r\n                </CardTitle>\r\n              </CardHeader>\r\n              <CardContent className=\"p-3\">\r\n                <div className=\"grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-3\">\r\n                  {saldos.map((saldo) => (\r\n                    <div key={saldo.servicio} className=\"p-3 border rounded-lg\">\r\n                      <h3 className=\"font-semibold text-xs text-gray-600 mb-1\">\r\n                        {saldo.servicio}\r\n                      </h3>\r\n                      <p className=\"text-lg font-bold text-green-600\">\r\n                        ${saldo.saldo_actual.toFixed(2)}\r\n                      </p>\r\n                      {saldo.ultimo_movimiento && (\r\n                        <p className=\"text-xs text-gray-500 mt-1\">\r\n                          ├Ültimo:{\" \"}\r\n                          {new Date(\r\n                            saldo.ultimo_movimiento\r\n                          ).toLocaleDateString()}\r\n                        </p>\r\n                      )}\r\n                    </div>\r\n                  ))}\r\n                </div>\r\n              </CardContent>\r\n            </Card>\r\n\r\n            {/* Grid de Puntos de Atenci├│n para Asignaci├│n */}\r\n            {puntos.length === 0 ? (\r\n              <div className=\"text-center py-12\">\r\n                <div className=\"text-gray-400 text-6xl mb-4\">­ƒôì</div>\r\n                <h3 className=\"text-lg font-semibold text-gray-600 mb-2\">\r\n                  No se encontraron puntos de atenci├│n\r\n                </h3>\r\n                <p className=\"text-gray-500 mb-4\">\r\n                  Verifica que existan puntos de atenci├│n activos en el sistema\r\n                </p>\r\n                <Button\r\n                  variant=\"outline\"\r\n                  onClick={obtenerPuntos}\r\n                  className=\"mx-auto\"\r\n                >\r\n                  ­ƒöä Recargar puntos\r\n                </Button>\r\n              </div>\r\n            ) : (\r\n              <div className=\"grid grid-cols-1 lg:grid-cols-2 xl:grid-cols-3 gap-4\">\r\n                {puntos.map((punto) => (\r\n                  <Card key={punto.id} className=\"p-4 bg-white shadow-sm\">\r\n                    <div className=\"mb-3\">\r\n                      <h3 className=\"font-semibold text-base text-gray-800\">\r\n                        {punto.nombre}\r\n                      </h3>\r\n                      <p className=\"text-gray-500 text-xs\">\r\n                        {punto.ciudad}, {punto.provincia}\r\n                      </p>\r\n                    </div>\r\n\r\n                    {/* Saldos actuales del punto */}\r\n                    <div className=\"mb-3\">\r\n                      <h4 className=\"font-medium text-sm text-gray-700 mb-2\">\r\n                        Saldos Asignados:\r\n                      </h4>\r\n                      <div className=\"space-y-2 max-h-32 overflow-y-auto\">\r\n                        {SERVICIOS_EXTERNOS.map((servicio) => {\r\n                          const saldoPunto = saldosPorPunto.find(\r\n                            (s) =>\r\n                              s.punto_atencion_id === punto.id &&\r\n                              s.servicio === servicio\r\n                          );\r\n                          const saldoActual = saldoPunto?.saldo_actual || 0;\r\n                          const saldoBajo = saldoActual < UMBRAL_SALDO_BAJO;\r\n\r\n                          return (\r\n                            <div\r\n                              key={servicio}\r\n                              className=\"flex justify-between items-center text-sm\"\r\n                            >\r\n                              <span className=\"text-gray-600\">{servicio}:</span>\r\n                              <span\r\n                                className={`font-semibold ${\r\n                                  saldoBajo ? \"text-red-600\" : \"text-green-600\"\r\n                                }`}\r\n                              >\r\n                                ${saldoActual.toFixed(2)}\r\n                                {saldoBajo && (\r\n                                  <span className=\"ml-1 text-xs\">ÔÜá´©Å</span>\r\n                                )}\r\n                              </span>\r\n                            </div>\r\n                          );\r\n                        })}\r\n                      </div>\r\n                    </div>\r\n\r\n                    {/* Formulario de asignaci├│n */}\r\n                    <div className=\"space-y-2\">\r\n                      <h4 className=\"font-medium text-sm text-gray-700\">\r\n                        Asignar Nuevo Saldo:\r\n                      </h4>\r\n                      {SERVICIOS_EXTERNOS.map((servicio) => {\r\n                        const key = `${punto.id}-${servicio}`;\r\n                        const loading = loadingAsignaciones[key] || false;\r\n                        const montoInput =\r\n                          montosAsignacion[punto.id]?.[servicio] || \"\";\r\n                        const tipoAsignacion =\r\n                          tiposAsignacion[punto.id]?.[servicio] || \"INICIAL\";\r\n\r\n                        return (\r\n                          <div key={servicio} className=\"flex gap-2 items-end\">\r\n                            <div className=\"flex-1\">\r\n                              <Label className=\"text-xs text-gray-600\">\r\n                                {servicio}\r\n                              </Label>\r\n                              <div className=\"flex gap-1\">\r\n                                <Input\r\n                                  type=\"number\"\r\n                                  step=\"0.01\"\r\n                                  min=\"0\"\r\n                                  value={montoInput}\r\n                                  onChange={(e) =>\r\n                                    setMontosAsignacion((prev) => ({\r\n                                      ...prev,\r\n                                      [punto.id]: {\r\n                                        ...prev[punto.id],\r\n                                        [servicio]: e.target.value,\r\n                                      },\r\n                                    }))\r\n                                  }\r\n                                  placeholder=\"0.00\"\r\n                                  className=\"text-sm flex-1\"\r\n                                  disabled={loading}\r\n                                />\r\n                                <Select\r\n                                  value={tipoAsignacion}\r\n                                  onValueChange={(\r\n                                    value: \"INICIAL\" | \"RECARGA\"\r\n                                  ) =>\r\n                                    setTiposAsignacion((prev) => ({\r\n                                      ...prev,\r\n                                      [punto.id]: {\r\n                                        ...prev[punto.id],\r\n                                        [servicio]: value,\r\n                                      },\r\n                                    }))\r\n                                  }\r\n                                  disabled={loading}\r\n                                >\r\n                                  <SelectTrigger className=\"text-xs w-24\">\r\n                                    <SelectValue />\r\n                                  </SelectTrigger>\r\n                                  <SelectContent>\r\n                                    <SelectItem\r\n                                      value=\"INICIAL\"\r\n                                      className=\"text-xs\"\r\n                                    >\r\n                                      Inicial\r\n                                    </SelectItem>\r\n                                    <SelectItem\r\n                                      value=\"RECARGA\"\r\n                                      className=\"text-xs\"\r\n                                    >\r\n                                      Recarga\r\n                                    </SelectItem>\r\n                                  </SelectContent>\r\n                                </Select>\r\n                              </div>\r\n                            </div>\r\n                            <Button\r\n                              size=\"sm\"\r\n                              onClick={() => {\r\n                                const monto = parseFloat(montoInput);\r\n                                if (isNaN(monto) || monto <= 0) {\r\n                                  toast.error(\r\n                                    \"Ingrese un monto v├ílido mayor a 0\"\r\n                                  );\r\n                                  return;\r\n                                }\r\n                                asignarSaldo(\r\n                                  punto.id,\r\n                                  servicio,\r\n                                  monto,\r\n                                  tipoAsignacion\r\n                                );\r\n                              }}\r\n                              disabled={\r\n                                loading ||\r\n                                !montoInput.trim() ||\r\n                                parseFloat(montoInput) <= 0\r\n                              }\r\n                              className=\"text-xs px-2\"\r\n                            >\r\n                              {loading ? (\r\n                                <span className=\"animate-spin\">ÔÅ│</span>\r\n                              ) : (\r\n                                \"­ƒÆ░\"\r\n                              )}\r\n                            </Button>\r\n                          </div>\r\n                        );\r\n                      })}\r\n                    </div>\r\n                  </Card>\r\n                ))}\r\n              </div>\r\n            )}\r\n\r\n            {/* Historial de Asignaciones */}\r\n            <Card>\r\n              <CardHeader className=\"p-3\">\r\n                <CardTitle className=\"text-sm\">\r\n                  ­ƒôï Historial de Asignaciones\r\n                </CardTitle>\r\n              </CardHeader>\r\n              <CardContent className=\"p-3\">\r\n                {historialAsignaciones.length === 0 ? (\r\n                  <div className=\"text-center py-8\">\r\n                    <p className=\"text-gray-500\">\r\n                      ­ƒô¡ No hay asignaciones registradas\r\n                    </p>\r\n                  </div>\r\n                ) : (\r\n                  <div className=\"overflow-x-auto\">\r\n                    <table className=\"w-full text-sm\">\r\n                      <thead>\r\n                        <tr className=\"border-b\">\r\n                          <th className=\"text-left p-2\">Fecha</th>\r\n                          <th className=\"text-left p-2\">Punto</th>\r\n                          <th className=\"text-left p-2\">Servicio</th>\r\n                          <th className=\"text-left p-2\">Monto</th>\r\n                          <th className=\"text-left p-2\">Creado por</th>\r\n                        </tr>\r\n                      </thead>\r\n                      <tbody>\r\n                        {historialAsignaciones\r\n                          .slice(0, 10)\r\n                          .map((asignacion) => (\r\n                            <tr\r\n                              key={asignacion.id}\r\n                              className=\"border-b hover:bg-gray-50\"\r\n                            >\r\n                              <td className=\"p-2\">\r\n                                {new Date(\r\n                                  asignacion.creado_en\r\n                                ).toLocaleDateString()}\r\n                              </td>\r\n                              <td className=\"p-2\">\r\n                                {asignacion.punto_atencion_nombre}\r\n                              </td>\r\n                              <td className=\"p-2\">{asignacion.servicio}</td>\r\n                              <td className=\"p-2 font-semibold text-green-600\">\r\n                                ${asignacion.monto_asignado.toFixed(2)}\r\n                              </td>\r\n                              <td className=\"p-2\">{asignacion.creado_por}</td>\r\n                            </tr>\r\n                          ))}\r\n                      </tbody>\r\n                    </table>\r\n                  </div>\r\n                )}\r\n              </CardContent>\r\n            </Card>\r\n          </>\r\n        ) : (\r\n          <>\r\n            {/* Vista de Movimientos */}\r\n            {/* Formulario para Nuevo Movimiento */}\r\n            <Card className=\"flex-shrink-0\">\r\n              <CardHeader className=\"p-3\">\r\n                <CardTitle className=\"text-sm\">\r\n                  Ô×ò Crear Nuevo Movimiento\r\n                </CardTitle>\r\n              </CardHeader>\r\n              <CardContent className=\"space-y-3 p-3\">\r\n                <div className=\"grid grid-cols-1 md:grid-cols-2 lg:grid-cols-5 gap-4\">\r\n                  <div>\r\n                    <Label>Punto de Atenci├│n</Label>\r\n                    <Select\r\n                      value={nuevoMovimiento.punto_atencion_id}\r\n                      onValueChange={(value) =>\r\n                        setNuevoMovimiento((prev) => ({\r\n                          ...prev,\r\n                          punto_atencion_id: value,\r\n                        }))\r\n                      }\r\n                    >\r\n                      <SelectTrigger>\r\n                        <SelectValue placeholder=\"Seleccionar punto\" />\r\n                      </SelectTrigger>\r\n                      <SelectContent>\r\n                        {puntos.map((punto) => (\r\n                          <SelectItem key={punto.id} value={punto.id}>\r\n                            {punto.nombre} - {punto.ciudad}\r\n                          </SelectItem>\r\n                        ))}\r\n                      </SelectContent>\r\n                    </Select>\r\n                  </div>\r\n\r\n                  <div>\r\n                    <Label>Servicio</Label>\r\n                    <Select\r\n                      value={nuevoMovimiento.servicio}\r\n                      onValueChange={(value) =>\r\n                        setNuevoMovimiento((prev) => ({\r\n                          ...prev,\r\n                          servicio: value as ServicioExterno,\r\n                        }))\r\n                      }\r\n                    >\r\n                      <SelectTrigger>\r\n                        <SelectValue placeholder=\"Seleccionar servicio\" />\r\n                      </SelectTrigger>\r\n                      <SelectContent>\r\n                        {SERVICIOS_EXTERNOS.map((servicio) => (\r\n                          <SelectItem key={servicio} value={servicio}>\r\n                            {servicio}\r\n                          </SelectItem>\r\n                        ))}\r\n                      </SelectContent>\r\n                    </Select>\r\n                  </div>\r\n\r\n                  <div>\r\n                    <Label>Tipo</Label>\r\n                    <Select\r\n                      value={nuevoMovimiento.tipo}\r\n                      onValueChange={(value) =>\r\n                        setNuevoMovimiento((prev) => ({\r\n                          ...prev,\r\n                          tipo: value as \"INGRESO\" | \"EGRESO\",\r\n                        }))\r\n                      }\r\n                    >\r\n                      <SelectTrigger>\r\n                        <SelectValue placeholder=\"Tipo\" />\r\n                      </SelectTrigger>\r\n                      <SelectContent>\r\n                        <SelectItem value=\"INGRESO\">INGRESO</SelectItem>\r\n                        <SelectItem value=\"EGRESO\">EGRESO</SelectItem>\r\n                      </SelectContent>\r\n                    </Select>\r\n                  </div>\r\n\r\n                  <div>\r\n                    <Label>Monto (USD)</Label>\r\n                    <Input\r\n                      type=\"number\"\r\n                      step=\"0.01\"\r\n                      min=\"0\"\r\n                      value={nuevoMovimiento.monto}\r\n                      onChange={(e) =>\r\n                        setNuevoMovimiento((prev) => ({\r\n                          ...prev,\r\n                          monto: e.target.value,\r\n                        }))\r\n                      }\r\n                      placeholder=\"0.00\"\r\n                    />\r\n                  </div>\r\n\r\n                  <div>\r\n                    <Label>Descripci├│n</Label>\r\n                    <Input\r\n                      value={nuevoMovimiento.descripcion}\r\n                      onChange={(e) =>\r\n                        setNuevoMovimiento((prev) => ({\r\n                          ...prev,\r\n                          descripcion: e.target.value,\r\n                        }))\r\n                      }\r\n                      placeholder=\"Opcional\"\r\n                    />\r\n                  </div>\r\n                </div>\r\n\r\n                <Button\r\n                  onClick={crearMovimiento}\r\n                  disabled={saving}\r\n                  className=\"w-full md:w-auto\"\r\n                >\r\n                  {saving ? \"Guardando...\" : \"­ƒÆ¥ Crear Movimiento\"}\r\n                </Button>\r\n              </CardContent>\r\n            </Card>\r\n\r\n            {/* Filtros */}\r\n            <Card className=\"flex-shrink-0\">\r\n              <CardHeader className=\"p-3\">\r\n                <CardTitle className=\"text-sm\">\r\n                  ­ƒöì Filtros de B├║squeda\r\n                </CardTitle>\r\n              </CardHeader>\r\n              <CardContent className=\"p-3\">\r\n                <div className=\"grid grid-cols-1 md:grid-cols-4 gap-4\">\r\n                  <div>\r\n                    <Label>Punto de Atenci├│n</Label>\r\n                    <Select\r\n                      value={filtros.punto_id}\r\n                      onValueChange={(value) =>\r\n                        setFiltros((prev) => ({ ...prev, punto_id: value }))\r\n                      }\r\n                    >\r\n                      <SelectTrigger>\r\n                        <SelectValue />\r\n                      </SelectTrigger>\r\n                      <SelectContent>\r\n                        <SelectItem value=\"todos\">Todos los puntos</SelectItem>\r\n                        {puntos.map((punto) => (\r\n                          <SelectItem key={punto.id} value={punto.id}>\r\n                            {punto.nombre}\r\n                          </SelectItem>\r\n                        ))}\r\n                      </SelectContent>\r\n                    </Select>\r\n                  </div>\r\n\r\n                  <div>\r\n                    <Label>Servicio</Label>\r\n                    <Select\r\n                      value={filtros.servicio}\r\n                      onValueChange={(value) =>\r\n                        setFiltros((prev) => ({ ...prev, servicio: value }))\r\n                      }\r\n                    >\r\n                      <SelectTrigger>\r\n                        <SelectValue />\r\n                      </SelectTrigger>\r\n                      <SelectContent>\r\n                        <SelectItem value=\"todos\">\r\n                          Todos los servicios\r\n                        </SelectItem>\r\n                        {SERVICIOS_EXTERNOS.map((servicio) => (\r\n                          <SelectItem key={servicio} value={servicio}>\r\n                            {servicio}\r\n                          </SelectItem>\r\n                        ))}\r\n                      </SelectContent>\r\n                    </Select>\r\n                  </div>\r\n\r\n                  <div>\r\n                    <Label>Fecha Desde</Label>\r\n                    <Input\r\n                      type=\"date\"\r\n                      value={filtros.fecha_desde}\r\n                      onChange={(e) =>\r\n                        setFiltros((prev) => ({\r\n                          ...prev,\r\n                          fecha_desde: e.target.value,\r\n                        }))\r\n                      }\r\n                    />\r\n                  </div>\r\n\r\n                  <div>\r\n                    <Label>Fecha Hasta</Label>\r\n                    <Input\r\n                      type=\"date\"\r\n                      value={filtros.fecha_hasta}\r\n                      onChange={(e) =>\r\n                        setFiltros((prev) => ({\r\n                          ...prev,\r\n                          fecha_hasta: e.target.value,\r\n                        }))\r\n                      }\r\n                    />\r\n                  </div>\r\n                </div>\r\n              </CardContent>\r\n            </Card>\r\n\r\n            {/* Historial de Movimientos */}\r\n            <Card>\r\n              <CardHeader className=\"p-3\">\r\n                <CardTitle className=\"text-sm\">\r\n                  ­ƒôï Historial de Movimientos\r\n                </CardTitle>\r\n              </CardHeader>\r\n              <CardContent className=\"p-3\">\r\n                {loading ? (\r\n                  <div className=\"text-center py-8\">\r\n                    <p>Cargando movimientos...</p>\r\n                  </div>\r\n                ) : movimientos.length === 0 ? (\r\n                  <div className=\"text-center py-8 text-gray-500\">\r\n                    <p>\r\n                      No se encontraron movimientos con los filtros aplicados\r\n                    </p>\r\n                  </div>\r\n                ) : (\r\n                  <div className=\"overflow-x-auto\">\r\n                    <table className=\"w-full text-sm\">\r\n                      <thead className=\"bg-gray-50\">\r\n                        <tr>\r\n                          <th className=\"px-3 py-2 text-left\">Fecha</th>\r\n                          <th className=\"px-3 py-2 text-left\">Punto</th>\r\n                          <th className=\"px-3 py-2 text-left\">Servicio</th>\r\n                          <th className=\"px-3 py-2 text-left\">Tipo</th>\r\n                          <th className=\"px-3 py-2 text-right\">Monto</th>\r\n                          <th className=\"px-3 py-2 text-left\">Descripci├│n</th>\r\n                          <th className=\"px-3 py-2 text-left\">Creado por</th>\r\n                        </tr>\r\n                      </thead>\r\n                      <tbody>\r\n                        {movimientos.map((mov) => (\r\n                          <tr key={mov.id} className=\"border-t\">\r\n                            <td className=\"px-3 py-2\">\r\n                              {new Date(mov.creado_en).toLocaleDateString()}\r\n                            </td>\r\n                            <td className=\"px-3 py-2\">\r\n                              {mov.punto_atencion_nombre}\r\n                            </td>\r\n                            <td className=\"px-3 py-2\">{mov.servicio}</td>\r\n                            <td className=\"px-3 py-2\">\r\n                              <span\r\n                                className={`px-2 py-1 rounded text-xs ${\r\n                                  mov.tipo === \"INGRESO\"\r\n                                    ? \"bg-green-100 text-green-800\"\r\n                                    : \"bg-red-100 text-red-800\"\r\n                                }`}\r\n                              >\r\n                                {mov.tipo}\r\n                              </span>\r\n                            </td>\r\n                            <td className=\"px-3 py-2 text-right font-mono\">\r\n                              ${mov.monto.toFixed(2)}\r\n                            </td>\r\n                            <td className=\"px-3 py-2\">\r\n                              {mov.descripcion || \"-\"}\r\n                            </td>\r\n                            <td className=\"px-3 py-2\">{mov.creado_por}</td>\r\n                          </tr>\r\n                        ))}\r\n                      </tbody>\r\n                    </table>\r\n                  </div>\r\n                )}\r\n              </CardContent>\r\n            </Card>\r\n          </>\r\n        )}\r\n\r\n        <ConfirmationDialog />\r\n      </div>\r\n    </div>\r\n  );\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\oswal\\OneDrive\\Documentos\\Punto Cambio\\punto_cambio_new\\src\\components\\admin\\ServientregaAnulaciones.tsx","messages":[{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'Eye' is defined but never used. Allowed unused vars must match /^_/u.","line":21,"column":3,"nodeType":null,"messageId":"unusedVar","endLine":21,"endColumn":6},{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'showConfirmation' is assigned a value but never used. Allowed unused vars must match /^_/u.","line":86,"column":11,"nodeType":null,"messageId":"unusedVar","endLine":86,"endColumn":27},{"ruleId":"react-hooks/exhaustive-deps","severity":1,"message":"React Hook useEffect has a missing dependency: 'fetchSolicitudes'. Either include it or remove the dependency array.","line":142,"column":6,"nodeType":"ArrayExpression","endLine":142,"endColumn":8,"suggestions":[{"desc":"Update the dependencies array to be: [fetchSolicitudes]","fix":{"range":[4814,4816],"text":"[fetchSolicitudes]"}}]}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":3,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import { useState, useEffect } from \"react\";\r\nimport { Button } from \"@/components/ui/button\";\r\nimport { Card, CardContent, CardHeader, CardTitle } from \"@/components/ui/card\";\r\nimport { Badge } from \"@/components/ui/badge\";\r\nimport { Input } from \"@/components/ui/input\";\r\nimport { Label } from \"@/components/ui/label\";\r\nimport { Textarea } from \"@/components/ui/textarea\";\r\nimport {\r\n  Dialog,\r\n  DialogContent,\r\n  DialogHeader,\r\n  DialogTitle,\r\n  DialogFooter,\r\n} from \"@/components/ui/dialog\";\r\nimport { toast } from \"sonner\";\r\nimport { format, parseISO, subDays } from \"date-fns\";\r\nimport {\r\n  CheckCircle,\r\n  XCircle,\r\n  Clock,\r\n  Eye,\r\n  RefreshCw,\r\n  AlertTriangle,\r\n} from \"lucide-react\";\r\nimport { useConfirmationDialog } from \"@/components/ui/confirmation-dialog\";\r\nimport { Loading } from \"@/components/ui/loading\";\r\nimport { SolicitudAnulacionGuia } from \"@/types/servientrega\";\r\nimport axiosInstance from \"@/services/axiosInstance\";\r\nimport { User, PuntoAtencion } from \"@/types\";\r\n\r\ninterface ServientregaAnulacionesProps {\r\n  user: User;\r\n  selectedPoint: PuntoAtencion | null;\r\n}\r\n\r\nexport const ServientregaAnulaciones = ({\r\n  user: _user,\r\n  selectedPoint: _selectedPoint,\r\n}: ServientregaAnulacionesProps) => {\r\n  const isRecord = (v: unknown): v is Record<string, unknown> =>\r\n    typeof v === \"object\" && v !== null && !Array.isArray(v);\r\n\r\n  const getAxiosStatus = (err: unknown): number | null => {\r\n    if (!isRecord(err)) return null;\r\n    const response = err.response;\r\n    if (!isRecord(response)) return null;\r\n    const status = response.status;\r\n    return typeof status === \"number\" ? status : null;\r\n  };\r\n\r\n  const extractErrorMessage = (err: unknown): string => {\r\n    if (!isRecord(err)) return \"Error desconocido\";\r\n    const response = err.response;\r\n    if (isRecord(response)) {\r\n      const data = response.data;\r\n      if (isRecord(data) && typeof data.message === \"string\") return data.message;\r\n    }\r\n    const message = err.message;\r\n    return typeof message === \"string\" ? message : \"Error desconocido\";\r\n  };\r\n\r\n  const isFiltroEstado = (\r\n    v: string\r\n  ): v is \"TODOS\" | \"PENDIENTE\" | \"APROBADA\" | \"RECHAZADA\" =>\r\n    v === \"TODOS\" || v === \"PENDIENTE\" || v === \"APROBADA\" || v === \"RECHAZADA\";\r\n\r\n  const hoy = new Date();\r\n  const [solicitudes, setSolicitudes] = useState<SolicitudAnulacionGuia[]>([]);\r\n  const [desde, setDesde] = useState(format(subDays(hoy, 30), \"yyyy-MM-dd\"));\r\n  const [hasta, setHasta] = useState(format(hoy, \"yyyy-MM-dd\"));\r\n  const [filtroEstado, setFiltroEstado] = useState<\r\n    \"TODOS\" | \"PENDIENTE\" | \"APROBADA\" | \"RECHAZADA\"\r\n  >(\"TODOS\");\r\n  const [loading, setLoading] = useState(false);\r\n  const [error, setError] = useState<string | null>(null);\r\n\r\n  // Estados para modal de respuesta\r\n  const [showRespuestaDialog, setShowRespuestaDialog] = useState(false);\r\n  const [solicitudSeleccionada, setSolicitudSeleccionada] =\r\n    useState<SolicitudAnulacionGuia | null>(null);\r\n  const [comentarioRespuesta, setComentarioRespuesta] = useState(\"\");\r\n  const [accionRespuesta, setAccionRespuesta] = useState<\r\n    \"APROBAR\" | \"RECHAZAR\"\r\n  >(\"APROBAR\");\r\n\r\n  const { showConfirmation, ConfirmationDialog } = useConfirmationDialog();\r\n\r\n  const fetchSolicitudes = async () => {\r\n    setLoading(true);\r\n    setError(null);\r\n\r\n    try {\r\n      const response = await axiosInstance.get(\r\n        \"/servientrega/solicitudes-anulacion\",\r\n        {\r\n          params: {\r\n            desde,\r\n            hasta,\r\n            estado: filtroEstado === \"TODOS\" ? undefined : filtroEstado,\r\n          },\r\n        }\r\n      );\r\n\r\n      // El backend devuelve { success: true, data: [...] }\r\n      const data = response.data?.data || response.data;\r\n\r\n      if (Array.isArray(data)) {\r\n        setSolicitudes(data);\r\n        if (data.length === 0) {\r\n          toast.info(\r\n            \"No se encontraron solicitudes en el per├¡odo seleccionado.\"\r\n          );\r\n        }\r\n      } else {\r\n        console.error(\"Respuesta inesperada del servidor:\", response.data);\r\n        setSolicitudes([]);\r\n        toast.warning(\"No se recibieron solicitudes del servidor.\");\r\n      }\r\n    } catch (err: unknown) {\r\n      console.error(\"Error al cargar solicitudes:\", err);\r\n\r\n      if (getAxiosStatus(err) === 404) {\r\n        setError(\r\n          \"Los endpoints de anulaciones de Servientrega no est├ín disponibles en el backend.\"\r\n        );\r\n        toast.warning(\r\n          \"Funcionalidad de anulaciones no disponible. Contacte al administrador.\"\r\n        );\r\n      } else {\r\n        setError(\"Error al cargar las solicitudes de anulaci├│n.\");\r\n        toast.error(\"No se pudieron cargar las solicitudes.\");\r\n      }\r\n\r\n      setSolicitudes([]);\r\n    } finally {\r\n      setLoading(false);\r\n    }\r\n  };\r\n\r\n  useEffect(() => {\r\n    fetchSolicitudes();\r\n  }, []);\r\n\r\n  const handleResponderSolicitud = (\r\n    solicitud: SolicitudAnulacionGuia,\r\n    accion: \"APROBAR\" | \"RECHAZAR\"\r\n  ) => {\r\n    setSolicitudSeleccionada(solicitud);\r\n    setAccionRespuesta(accion);\r\n    setComentarioRespuesta(\"\");\r\n    setShowRespuestaDialog(true);\r\n  };\r\n\r\n  const handleConfirmarRespuesta = async () => {\r\n    if (!solicitudSeleccionada) return;\r\n\r\n    try {\r\n      // Usar el endpoint correcto con el m├®todo y par├ímetros correctos\r\n      await axiosInstance.post(\"/servientrega/responder-solicitud-anulacion\", {\r\n        solicitud_id: solicitudSeleccionada.id,\r\n        accion: accionRespuesta,\r\n        comentario: comentarioRespuesta.trim() || undefined,\r\n      });\r\n\r\n      const mensaje =\r\n        accionRespuesta === \"APROBAR\"\r\n          ? \"Ô£à Solicitud aprobada y gu├¡a anulada exitosamente.\"\r\n          : \"ÔØî Solicitud rechazada.\";\r\n\r\n      toast.success(mensaje);\r\n      setShowRespuestaDialog(false);\r\n      setSolicitudSeleccionada(null);\r\n      setComentarioRespuesta(\"\");\r\n      fetchSolicitudes();\r\n    } catch (err: unknown) {\r\n      const errorMessage = extractErrorMessage(err);\r\n      console.error(\"Error al responder solicitud:\", err);\r\n      toast.error(`No se pudo procesar la respuesta: ${errorMessage}`);\r\n    }\r\n  };\r\n\r\n  const getEstadoBadge = (estado: string) => {\r\n    switch (estado) {\r\n      case \"PENDIENTE\":\r\n        return (\r\n          <Badge variant=\"secondary\" className=\"bg-yellow-100 text-yellow-800\">\r\n            <Clock className=\"w-3 h-3 mr-1\" />\r\n            Pendiente\r\n          </Badge>\r\n        );\r\n      case \"APROBADA\":\r\n        return (\r\n          <Badge variant=\"secondary\" className=\"bg-green-100 text-green-800\">\r\n            <CheckCircle className=\"w-3 h-3 mr-1\" />\r\n            Aprobada\r\n          </Badge>\r\n        );\r\n      case \"RECHAZADA\":\r\n        return (\r\n          <Badge variant=\"secondary\" className=\"bg-red-100 text-red-800\">\r\n            <XCircle className=\"w-3 h-3 mr-1\" />\r\n            Rechazada\r\n          </Badge>\r\n        );\r\n      default:\r\n        return <Badge variant=\"outline\">{estado}</Badge>;\r\n    }\r\n  };\r\n\r\n  const solicitudesFiltradas = solicitudes.filter(\r\n    (solicitud) => filtroEstado === \"TODOS\" || solicitud.estado === filtroEstado\r\n  );\r\n\r\n  return (\r\n    <div className=\"p-3 sm:p-4 md:p-6 space-y-4 sm:space-y-6\">\r\n      <div className=\"flex items-center justify-between\">\r\n        <h1 className=\"text-2xl font-bold text-gray-800\">\r\n          Gesti├│n de Anulaciones - Servientrega\r\n        </h1>\r\n      </div>\r\n\r\n      <Card>\r\n        <CardHeader>\r\n          <CardTitle>Solicitudes de Anulaci├│n de Gu├¡as</CardTitle>\r\n        </CardHeader>\r\n        <CardContent>\r\n          {/* Filtros */}\r\n          <div className=\"flex gap-4 mb-6 flex-wrap\">\r\n            <div className=\"flex-1 min-w-32\">\r\n              <Label className=\"text-sm\">Desde</Label>\r\n              <Input\r\n                type=\"date\"\r\n                value={desde}\r\n                onChange={(e) => setDesde(e.target.value)}\r\n                className=\"h-9\"\r\n              />\r\n            </div>\r\n            <div className=\"flex-1 min-w-32\">\r\n              <Label className=\"text-sm\">Hasta</Label>\r\n              <Input\r\n                type=\"date\"\r\n                value={hasta}\r\n                onChange={(e) => setHasta(e.target.value)}\r\n                className=\"h-9\"\r\n              />\r\n            </div>\r\n            <div className=\"flex-1 min-w-32\">\r\n              <Label className=\"text-sm\">Estado</Label>\r\n              <select\r\n                value={filtroEstado}\r\n                onChange={(e) => {\r\n                  const v = e.target.value;\r\n                  setFiltroEstado(isFiltroEstado(v) ? v : \"TODOS\");\r\n                }}\r\n                className=\"h-9 w-full rounded-md border border-input bg-background px-3 py-1 text-sm ring-offset-background\"\r\n              >\r\n                <option value=\"TODOS\">Todos</option>\r\n                <option value=\"PENDIENTE\">Pendientes</option>\r\n                <option value=\"APROBADA\">Aprobadas</option>\r\n                <option value=\"RECHAZADA\">Rechazadas</option>\r\n              </select>\r\n            </div>\r\n            <Button onClick={fetchSolicitudes} className=\"self-end h-9\">\r\n              Buscar\r\n            </Button>\r\n          </div>\r\n\r\n          {/* Lista de solicitudes */}\r\n          {loading ? (\r\n            <Loading text=\"Cargando solicitudes...\" className=\"py-8\" />\r\n          ) : error ? (\r\n            <div className=\"text-center py-8\">\r\n              {error.includes(\"no est├ín disponibles\") ? (\r\n                <Card className=\"border-yellow-200 bg-yellow-50 max-w-md mx-auto\">\r\n                  <CardContent className=\"p-6 text-center\">\r\n                    <div className=\"flex flex-col items-center space-y-4\">\r\n                      <div className=\"w-16 h-16 bg-yellow-100 rounded-full flex items-center justify-center\">\r\n                        <AlertTriangle className=\"w-8 h-8 text-yellow-600\" />\r\n                      </div>\r\n                      <div>\r\n                        <h3 className=\"text-lg font-semibold text-yellow-800 mb-2\">\r\n                          Funcionalidad en Desarrollo\r\n                        </h3>\r\n                        <p className=\"text-yellow-700 mb-4\">\r\n                          Las anulaciones de Servientrega a├║n no est├ín\r\n                          disponibles en el backend.\r\n                        </p>\r\n                        <p className=\"text-sm text-yellow-600\">\r\n                          Esta funcionalidad ser├í habilitada pr├│ximamente.\r\n                        </p>\r\n                      </div>\r\n                      <Button\r\n                        onClick={fetchSolicitudes}\r\n                        variant=\"outline\"\r\n                        className=\"border-yellow-300 text-yellow-700 hover:bg-yellow-100\"\r\n                      >\r\n                        <RefreshCw className=\"w-4 h-4 mr-2\" />\r\n                        Reintentar\r\n                      </Button>\r\n                    </div>\r\n                  </CardContent>\r\n                </Card>\r\n              ) : (\r\n                <div>\r\n                  <p className=\"text-destructive mb-4\">{error}</p>\r\n                  <Button onClick={fetchSolicitudes} variant=\"outline\">\r\n                    <RefreshCw className=\"w-4 h-4 mr-2\" />\r\n                    Reintentar\r\n                  </Button>\r\n                </div>\r\n              )}\r\n            </div>\r\n          ) : solicitudesFiltradas.length === 0 ? (\r\n            <p className=\"text-muted-foreground text-center py-8\">\r\n              No hay solicitudes en este periodo.\r\n            </p>\r\n          ) : (\r\n            <div className=\"space-y-4\">\r\n              {solicitudesFiltradas.map((solicitud) => (\r\n                <div\r\n                  key={solicitud.id}\r\n                  className=\"border rounded-lg p-4 space-y-3\"\r\n                >\r\n                  <div className=\"flex justify-between items-start\">\r\n                    <div className=\"space-y-2\">\r\n                      <div className=\"flex items-center gap-2\">\r\n                        <h3 className=\"font-semibold\">\r\n                          Gu├¡a: {solicitud.numero_guia}\r\n                        </h3>\r\n                        {getEstadoBadge(solicitud.estado)}\r\n                      </div>\r\n                      <div className=\"text-sm text-gray-600 space-y-1\">\r\n                        <p>\r\n                          <strong>Solicitado por:</strong>{\" \"}\r\n                          {solicitud.solicitado_por_nombre}\r\n                        </p>\r\n                        <p>\r\n                          <strong>Punto:</strong>{\" \"}\r\n                          {solicitud.punto_atencion_nombre}\r\n                        </p>\r\n                        <p>\r\n                          <strong>Fecha solicitud:</strong>{\" \"}\r\n                          {format(\r\n                            parseISO(solicitud.fecha_solicitud),\r\n                            \"yyyy-MM-dd HH:mm\"\r\n                          )}\r\n                        </p>\r\n                        <p>\r\n                          <strong>Motivo:</strong>{\" \"}\r\n                          {solicitud.motivo_anulacion || solicitud.motivo}\r\n                        </p>\r\n                      </div>\r\n                    </div>\r\n\r\n                    {solicitud.estado === \"PENDIENTE\" && (\r\n                      <div className=\"flex gap-2\">\r\n                        <Button\r\n                          size=\"sm\"\r\n                          variant=\"outline\"\r\n                          className=\"border-green-300 text-green-700 hover:bg-green-50\"\r\n                          onClick={() =>\r\n                            handleResponderSolicitud(solicitud, \"APROBAR\")\r\n                          }\r\n                        >\r\n                          <CheckCircle className=\"w-4 h-4 mr-1\" />\r\n                          Aprobar\r\n                        </Button>\r\n                        <Button\r\n                          size=\"sm\"\r\n                          variant=\"outline\"\r\n                          className=\"border-red-300 text-red-700 hover:bg-red-50\"\r\n                          onClick={() =>\r\n                            handleResponderSolicitud(solicitud, \"RECHAZAR\")\r\n                          }\r\n                        >\r\n                          <XCircle className=\"w-4 h-4 mr-1\" />\r\n                          Rechazar\r\n                        </Button>\r\n                      </div>\r\n                    )}\r\n                  </div>\r\n\r\n                  {/* Informaci├│n de respuesta si ya fue procesada */}\r\n                  {solicitud.estado !== \"PENDIENTE\" && (\r\n                    <div className=\"bg-gray-50 p-3 rounded text-sm\">\r\n                      <p>\r\n                        <strong>Respondido por:</strong>{\" \"}\r\n                        {solicitud.respondido_por_nombre}\r\n                      </p>\r\n                      <p>\r\n                        <strong>Fecha respuesta:</strong>{\" \"}\r\n                        {solicitud.fecha_respuesta &&\r\n                          format(\r\n                            parseISO(solicitud.fecha_respuesta),\r\n                            \"yyyy-MM-dd HH:mm\"\r\n                          )}\r\n                      </p>\r\n                      {(solicitud.comentario_respuesta ||\r\n                        solicitud.observaciones_respuesta) && (\r\n                        <p>\r\n                          <strong>Comentario:</strong>{\" \"}\r\n                          {solicitud.comentario_respuesta ||\r\n                            solicitud.observaciones_respuesta}\r\n                        </p>\r\n                      )}\r\n                    </div>\r\n                  )}\r\n                </div>\r\n              ))}\r\n            </div>\r\n          )}\r\n        </CardContent>\r\n      </Card>\r\n\r\n      {/* Modal para responder solicitud */}\r\n      <Dialog open={showRespuestaDialog} onOpenChange={setShowRespuestaDialog}>\r\n        <DialogContent>\r\n          <DialogHeader>\r\n            <DialogTitle>\r\n              {accionRespuesta === \"APROBAR\" ? \"Aprobar\" : \"Rechazar\"} Solicitud\r\n              de Anulaci├│n\r\n            </DialogTitle>\r\n          </DialogHeader>\r\n          <div className=\"space-y-4\">\r\n            <div className=\"bg-gray-50 p-3 rounded\">\r\n              <p>\r\n                <strong>Gu├¡a:</strong> {solicitudSeleccionada?.numero_guia}\r\n              </p>\r\n              <p>\r\n                <strong>Solicitado por:</strong>{\" \"}\r\n                {solicitudSeleccionada?.solicitado_por_nombre}\r\n              </p>\r\n              <p>\r\n                <strong>Motivo:</strong>{\" \"}\r\n                {solicitudSeleccionada?.motivo_anulacion ||\r\n                  solicitudSeleccionada?.motivo}\r\n              </p>\r\n            </div>\r\n            <div>\r\n              <Label htmlFor=\"comentario\">\r\n                Comentario{\" \"}\r\n                {accionRespuesta === \"RECHAZAR\" ? \"(requerido)\" : \"(opcional)\"}\r\n              </Label>\r\n              <Textarea\r\n                id=\"comentario\"\r\n                placeholder={\r\n                  accionRespuesta === \"APROBAR\"\r\n                    ? \"Comentario adicional sobre la aprobaci├│n...\"\r\n                    : \"Explique el motivo del rechazo...\"\r\n                }\r\n                value={comentarioRespuesta}\r\n                onChange={(e) => setComentarioRespuesta(e.target.value)}\r\n                rows={3}\r\n              />\r\n            </div>\r\n          </div>\r\n          <DialogFooter>\r\n            <Button\r\n              variant=\"outline\"\r\n              onClick={() => setShowRespuestaDialog(false)}\r\n            >\r\n              Cancelar\r\n            </Button>\r\n            <Button\r\n              onClick={handleConfirmarRespuesta}\r\n              disabled={\r\n                accionRespuesta === \"RECHAZAR\" && !comentarioRespuesta.trim()\r\n              }\r\n              variant={\r\n                accionRespuesta === \"APROBAR\" ? \"default\" : \"destructive\"\r\n              }\r\n            >\r\n              {accionRespuesta === \"APROBAR\"\r\n                ? \"Aprobar y Anular\"\r\n                : \"Rechazar Solicitud\"}\r\n            </Button>\r\n          </DialogFooter>\r\n        </DialogContent>\r\n      </Dialog>\r\n\r\n      <ConfirmationDialog />\r\n    </div>\r\n  );\r\n};\r\n\r\nexport default ServientregaAnulaciones;\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\oswal\\OneDrive\\Documentos\\Punto Cambio\\punto_cambio_new\\src\\components\\admin\\ServientregaInformes.tsx","messages":[{"ruleId":"react-hooks/exhaustive-deps","severity":1,"message":"React Hook useEffect has a missing dependency: 'fetchInformes'. Either include it or remove the dependency array.","line":136,"column":6,"nodeType":"ArrayExpression","endLine":136,"endColumn":8,"suggestions":[{"desc":"Update the dependencies array to be: [fetchInformes]","fix":{"range":[4454,4456],"text":"[fetchInformes]"}}]}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":1,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import { useState, useEffect } from \"react\";\r\nimport { Button } from \"@/components/ui/button\";\r\nimport { Card, CardContent, CardHeader, CardTitle } from \"@/components/ui/card\";\r\nimport { Badge } from \"@/components/ui/badge\";\r\nimport { Input } from \"@/components/ui/input\";\r\nimport { Label } from \"@/components/ui/label\";\r\nimport { toast } from \"sonner\";\r\nimport { format, parseISO, subDays } from \"date-fns\";\r\nimport { Download, Eye, FileText, BarChart3, RefreshCw } from \"lucide-react\";\r\nimport { Loading } from \"@/components/ui/loading\";\r\nimport { Guia } from \"@/types/servientrega\";\r\nimport axiosInstance from \"@/services/axiosInstance\";\r\nimport { User, PuntoAtencion } from \"@/types\";\r\n\r\ninterface ServientregaInformesProps {\r\n  user: User;\r\n  selectedPoint: PuntoAtencion | null;\r\n}\r\n\r\ninterface EstadisticasGuias {\r\n  total_guias: number;\r\n  guias_activas: number;\r\n  guias_anuladas: number;\r\n  guias_pendientes_anulacion: number;\r\n  total_por_punto: Array<{\r\n    punto_atencion_nombre: string;\r\n    total: number;\r\n    activas: number;\r\n    anuladas: number;\r\n  }>;\r\n}\r\n\r\nexport const ServientregaInformes = ({\r\n  user: _user,\r\n  selectedPoint: _selectedPoint,\r\n}: ServientregaInformesProps) => {\r\n  const isRecord = (v: unknown): v is Record<string, unknown> =>\r\n    typeof v === \"object\" && v !== null && !Array.isArray(v);\r\n\r\n  const getAxiosStatus = (err: unknown): number | null => {\r\n    if (!isRecord(err)) return null;\r\n    const response = err.response;\r\n    if (!isRecord(response)) return null;\r\n    const status = response.status;\r\n    return typeof status === \"number\" ? status : null;\r\n  };\r\n\r\n  const isFiltroEstado = (\r\n    v: string\r\n  ): v is \"TODOS\" | \"ACTIVA\" | \"ANULADA\" | \"PENDIENTE_ANULACION\" =>\r\n    v === \"TODOS\" ||\r\n    v === \"ACTIVA\" ||\r\n    v === \"ANULADA\" ||\r\n    v === \"PENDIENTE_ANULACION\";\r\n\r\n  const hoy = new Date();\r\n  const [guias, setGuias] = useState<Guia[]>([]);\r\n  const [estadisticas, setEstadisticas] = useState<EstadisticasGuias | null>(\r\n    null\r\n  );\r\n  const [desde, setDesde] = useState(format(subDays(hoy, 30), \"yyyy-MM-dd\"));\r\n  const [hasta, setHasta] = useState(format(hoy, \"yyyy-MM-dd\"));\r\n  const [filtroEstado, setFiltroEstado] = useState<\r\n    \"TODOS\" | \"ACTIVA\" | \"ANULADA\" | \"PENDIENTE_ANULACION\"\r\n  >(\"TODOS\");\r\n  const [filtroPunto, setFiltroPunto] = useState<string>(\"TODOS\");\r\n  const [loading, setLoading] = useState(false);\r\n  const [error, setError] = useState<string | null>(null);\r\n\r\n  const fetchInformes = async () => {\r\n    setLoading(true);\r\n    setError(null);\r\n\r\n    try {\r\n      const [guiasResponse, estadisticasResponse] = await Promise.all([\r\n        axiosInstance.get<{ data: Guia[]; success: boolean }>(\r\n          \"/servientrega/informes/guias\",\r\n          {\r\n            params: {\r\n              desde,\r\n              hasta,\r\n              estado: filtroEstado === \"TODOS\" ? undefined : filtroEstado,\r\n              punto_atencion_id:\r\n                filtroPunto === \"TODOS\" ? undefined : filtroPunto,\r\n            },\r\n          }\r\n        ),\r\n        axiosInstance.get<{ data: EstadisticasGuias; success: boolean }>(\r\n          \"/servientrega/informes/estadisticas\",\r\n          {\r\n            params: { desde, hasta },\r\n          }\r\n        ),\r\n      ]);\r\n\r\n      // Acceder a la propiedad 'data' de la respuesta del backend\r\n      if (Array.isArray(guiasResponse.data?.data)) {\r\n        setGuias(guiasResponse.data.data);\r\n      } else {\r\n        setGuias([]);\r\n      }\r\n\r\n      if (estadisticasResponse.data?.data) {\r\n        setEstadisticas(estadisticasResponse.data.data);\r\n      } else {\r\n        setEstadisticas(null);\r\n      }\r\n\r\n      if ((guiasResponse.data?.data || []).length === 0) {\r\n        toast.info(\"No se encontraron gu├¡as en el per├¡odo seleccionado.\");\r\n      }\r\n    } catch (err: unknown) {\r\n      console.error(\"Error al cargar informes:\", err);\r\n\r\n      if (getAxiosStatus(err) === 404) {\r\n        setError(\r\n          \"Los endpoints de informes de Servientrega no est├ín disponibles en el backend.\"\r\n        );\r\n        toast.warning(\r\n          \"Funcionalidad de informes no disponible. Contacte al administrador.\"\r\n        );\r\n      } else {\r\n        setError(\"Error al cargar los informes de Servientrega.\");\r\n        toast.error(\"No se pudieron cargar los informes.\");\r\n      }\r\n\r\n      setGuias([]);\r\n      setEstadisticas(null);\r\n    } finally {\r\n      setLoading(false);\r\n    }\r\n  };\r\n\r\n  useEffect(() => {\r\n    fetchInformes();\r\n  }, []);\r\n\r\n  const handleExportarExcel = async () => {\r\n    try {\r\n      const response = await axiosInstance.get(\r\n        \"/servientrega/informes/exportar\",\r\n        {\r\n          params: {\r\n            desde,\r\n            hasta,\r\n            estado: filtroEstado === \"TODOS\" ? undefined : filtroEstado,\r\n            punto_atencion_id:\r\n              filtroPunto === \"TODOS\" ? undefined : filtroPunto,\r\n          },\r\n          responseType: \"blob\",\r\n        }\r\n      );\r\n\r\n      const blob = new Blob([response.data], {\r\n        type: \"application/vnd.openxmlformats-officedocument.spreadsheetml.sheet\",\r\n      });\r\n      const url = window.URL.createObjectURL(blob);\r\n      const link = document.createElement(\"a\");\r\n      link.href = url;\r\n      link.download = `informe_servientrega_${desde}_${hasta}.xlsx`;\r\n      document.body.appendChild(link);\r\n      link.click();\r\n      document.body.removeChild(link);\r\n      window.URL.revokeObjectURL(url);\r\n\r\n      toast.success(\"Ô£à Informe exportado exitosamente\");\r\n    } catch (err: unknown) {\r\n      console.error(\"Error al exportar:\", err);\r\n\r\n      if (getAxiosStatus(err) === 404) {\r\n        toast.warning(\r\n          \"Funcionalidad de exportaci├│n no disponible. Contacte al administrador.\"\r\n        );\r\n      } else {\r\n        toast.error(\"Error al exportar el informe\");\r\n      }\r\n    }\r\n  };\r\n\r\n  const handleVerPDF = (base64: string) => {\r\n    try {\r\n      const pdfURL = `data:application/pdf;base64,${base64}`;\r\n      const win = window.open();\r\n      if (win) {\r\n        win.document.write(\r\n          `<iframe width=\"100%\" height=\"100%\" style=\"border:none;\" src=\"${pdfURL}\"></iframe>`\r\n        );\r\n      } else {\r\n        toast.error(\r\n          \"No se pudo abrir la ventana del PDF. Verifique que no est├® bloqueada por el navegador.\"\r\n        );\r\n      }\r\n    } catch (err) {\r\n      console.error(\"Error al mostrar PDF:\", err);\r\n      toast.error(\"Error al mostrar el PDF\");\r\n    }\r\n  };\r\n\r\n  const getEstadoBadge = (estado: string) => {\r\n    switch (estado) {\r\n      case \"ACTIVA\":\r\n        return <Badge className=\"bg-green-100 text-green-800\">Activa</Badge>;\r\n      case \"ANULADA\":\r\n        return <Badge className=\"bg-red-100 text-red-800\">Anulada</Badge>;\r\n      case \"PENDIENTE_ANULACION\":\r\n        return (\r\n          <Badge className=\"bg-yellow-100 text-yellow-800\">\r\n            Pendiente Anulaci├│n\r\n          </Badge>\r\n        );\r\n      default:\r\n        return <Badge variant=\"outline\">{estado}</Badge>;\r\n    }\r\n  };\r\n\r\n  const guiasFiltradas = (guias || []).filter((guia) => {\r\n    const cumpleEstado =\r\n      filtroEstado === \"TODOS\" || guia.estado === filtroEstado;\r\n    const cumplePunto =\r\n      filtroPunto === \"TODOS\" || guia.punto_atencion_id === filtroPunto;\r\n    return cumpleEstado && cumplePunto;\r\n  });\r\n\r\n  // Obtener lista ├║nica de puntos para el filtro\r\n  const puntosUnicos = Array.from(\r\n    new Set((guias || []).map((g) => g.punto_atencion_id))\r\n  ).map((id) => {\r\n    const guia = (guias || []).find((g) => g.punto_atencion_id === id);\r\n    return {\r\n      id,\r\n      nombre: guia?.punto_atencion_nombre || `Punto ${id}`,\r\n    };\r\n  });\r\n\r\n  // Si hay error 404, mostrar mensaje informativo\r\n  if (error && error.includes(\"no est├ín disponibles\")) {\r\n    return (\r\n      <div className=\"p-3 sm:p-4 md:p-6 space-y-4 sm:space-y-6\">\r\n        <div className=\"flex items-center justify-between\">\r\n          <h1 className=\"text-2xl font-bold text-gray-800\">\r\n            Informes de Servientrega\r\n          </h1>\r\n        </div>\r\n\r\n        <Card className=\"border-yellow-200 bg-yellow-50\">\r\n          <CardContent className=\"p-6 text-center\">\r\n            <div className=\"flex flex-col items-center space-y-4\">\r\n              <div className=\"w-16 h-16 bg-yellow-100 rounded-full flex items-center justify-center\">\r\n                <FileText className=\"w-8 h-8 text-yellow-600\" />\r\n              </div>\r\n              <div>\r\n                <h3 className=\"text-lg font-semibold text-yellow-800 mb-2\">\r\n                  Funcionalidad en Desarrollo\r\n                </h3>\r\n                <p className=\"text-yellow-700 mb-4\">\r\n                  Los informes de Servientrega a├║n no est├ín disponibles en el\r\n                  backend.\r\n                </p>\r\n                <p className=\"text-sm text-yellow-600\">\r\n                  Esta funcionalidad ser├í habilitada pr├│ximamente. Contacte al\r\n                  administrador del sistema para m├ís informaci├│n.\r\n                </p>\r\n              </div>\r\n              <Button\r\n                onClick={() => window.location.reload()}\r\n                variant=\"outline\"\r\n                className=\"border-yellow-300 text-yellow-700 hover:bg-yellow-100\"\r\n              >\r\n                <RefreshCw className=\"w-4 h-4 mr-2\" />\r\n                Reintentar\r\n              </Button>\r\n            </div>\r\n          </CardContent>\r\n        </Card>\r\n      </div>\r\n    );\r\n  }\r\n\r\n  return (\r\n    <div className=\"p-6 space-y-6\">\r\n      <div className=\"flex items-center justify-between\">\r\n        <h1 className=\"text-2xl font-bold text-gray-800\">\r\n          Informes de Servientrega\r\n        </h1>\r\n        <Button\r\n          onClick={handleExportarExcel}\r\n          className=\"bg-green-600 hover:bg-green-700\"\r\n          disabled={loading || error !== null}\r\n        >\r\n          <Download className=\"w-4 h-4 mr-2\" />\r\n          Exportar Excel\r\n        </Button>\r\n      </div>\r\n\r\n      {/* Estad├¡sticas generales */}\r\n      {estadisticas && (\r\n        <div className=\"grid grid-cols-1 md:grid-cols-4 gap-4\">\r\n          <Card>\r\n            <CardContent className=\"p-4\">\r\n              <div className=\"flex items-center justify-between\">\r\n                <div>\r\n                  <p className=\"text-sm font-medium text-gray-600\">\r\n                    Total Gu├¡as\r\n                  </p>\r\n                  <p className=\"text-2xl font-bold\">\r\n                    {estadisticas.total_guias}\r\n                  </p>\r\n                </div>\r\n                <FileText className=\"h-8 w-8 text-blue-600\" />\r\n              </div>\r\n            </CardContent>\r\n          </Card>\r\n          <Card>\r\n            <CardContent className=\"p-4\">\r\n              <div className=\"flex items-center justify-between\">\r\n                <div>\r\n                  <p className=\"text-sm font-medium text-gray-600\">Activas</p>\r\n                  <p className=\"text-2xl font-bold text-green-600\">\r\n                    {estadisticas.guias_activas}\r\n                  </p>\r\n                </div>\r\n                <BarChart3 className=\"h-8 w-8 text-green-600\" />\r\n              </div>\r\n            </CardContent>\r\n          </Card>\r\n          <Card>\r\n            <CardContent className=\"p-4\">\r\n              <div className=\"flex items-center justify-between\">\r\n                <div>\r\n                  <p className=\"text-sm font-medium text-gray-600\">Anuladas</p>\r\n                  <p className=\"text-2xl font-bold text-red-600\">\r\n                    {estadisticas.guias_anuladas}\r\n                  </p>\r\n                </div>\r\n                <BarChart3 className=\"h-8 w-8 text-red-600\" />\r\n              </div>\r\n            </CardContent>\r\n          </Card>\r\n          <Card>\r\n            <CardContent className=\"p-4\">\r\n              <div className=\"flex items-center justify-between\">\r\n                <div>\r\n                  <p className=\"text-sm font-medium text-gray-600\">\r\n                    Pendientes\r\n                  </p>\r\n                  <p className=\"text-2xl font-bold text-yellow-600\">\r\n                    {estadisticas.guias_pendientes_anulacion}\r\n                  </p>\r\n                </div>\r\n                <BarChart3 className=\"h-8 w-8 text-yellow-600\" />\r\n              </div>\r\n            </CardContent>\r\n          </Card>\r\n        </div>\r\n      )}\r\n\r\n      <Card>\r\n        <CardHeader>\r\n          <CardTitle>Listado de Gu├¡as</CardTitle>\r\n        </CardHeader>\r\n        <CardContent>\r\n          {/* Filtros */}\r\n          <div className=\"flex gap-4 mb-6 flex-wrap\">\r\n            <div className=\"flex-1 min-w-32\">\r\n              <Label className=\"text-sm\">Desde</Label>\r\n              <Input\r\n                type=\"date\"\r\n                value={desde}\r\n                onChange={(e) => setDesde(e.target.value)}\r\n                className=\"h-9\"\r\n              />\r\n            </div>\r\n            <div className=\"flex-1 min-w-32\">\r\n              <Label className=\"text-sm\">Hasta</Label>\r\n              <Input\r\n                type=\"date\"\r\n                value={hasta}\r\n                onChange={(e) => setHasta(e.target.value)}\r\n                className=\"h-9\"\r\n              />\r\n            </div>\r\n            <div className=\"flex-1 min-w-32\">\r\n              <Label className=\"text-sm\">Estado</Label>\r\n              <select\r\n                value={filtroEstado}\r\n                onChange={(e) => {\r\n                  const v = e.target.value;\r\n                  setFiltroEstado(isFiltroEstado(v) ? v : \"TODOS\");\r\n                }}\r\n                className=\"h-9 w-full rounded-md border border-input bg-background px-3 py-1 text-sm ring-offset-background\"\r\n              >\r\n                <option value=\"TODOS\">Todos</option>\r\n                <option value=\"ACTIVA\">Activas</option>\r\n                <option value=\"ANULADA\">Anuladas</option>\r\n                <option value=\"PENDIENTE_ANULACION\">\r\n                  Pendientes Anulaci├│n\r\n                </option>\r\n              </select>\r\n            </div>\r\n            <div className=\"flex-1 min-w-32\">\r\n              <Label className=\"text-sm\">Punto de Atenci├│n</Label>\r\n              <select\r\n                value={filtroPunto}\r\n                onChange={(e) => setFiltroPunto(e.target.value)}\r\n                className=\"h-9 w-full rounded-md border border-input bg-background px-3 py-1 text-sm ring-offset-background\"\r\n              >\r\n                <option value=\"TODOS\">Todos los puntos</option>\r\n                {puntosUnicos.map((punto) => (\r\n                  <option key={punto.id} value={punto.id}>\r\n                    {punto.nombre}\r\n                  </option>\r\n                ))}\r\n              </select>\r\n            </div>\r\n            <Button onClick={fetchInformes} className=\"self-end h-9\">\r\n              Buscar\r\n            </Button>\r\n          </div>\r\n\r\n          {/* Lista de gu├¡as */}\r\n          {loading ? (\r\n            <Loading text=\"Cargando informes...\" className=\"py-8\" />\r\n          ) : error ? (\r\n            <div className=\"text-center py-8\">\r\n              <p className=\"text-destructive mb-4\">{error}</p>\r\n              <Button onClick={fetchInformes} variant=\"outline\">\r\n                Reintentar\r\n              </Button>\r\n            </div>\r\n          ) : guiasFiltradas.length === 0 ? (\r\n            <p className=\"text-muted-foreground text-center py-8\">\r\n              No hay gu├¡as en este periodo con los filtros seleccionados.\r\n            </p>\r\n          ) : (\r\n            <div className=\"space-y-4\">\r\n              {guiasFiltradas.map((guia) => (\r\n                <div\r\n                  key={guia.id}\r\n                  className=\"border rounded-lg p-4 flex flex-col md:flex-row justify-between items-start md:items-center gap-4\"\r\n                >\r\n                  <div className=\"space-y-2\">\r\n                    <div className=\"flex items-center gap-2\">\r\n                      <h3 className=\"font-semibold\">\r\n                        Gu├¡a: {guia.numero_guia}\r\n                      </h3>\r\n                      {getEstadoBadge(guia.estado)}\r\n                    </div>\r\n                    <div className=\"text-sm text-gray-600 space-y-1\">\r\n                      <p>\r\n                        <strong>Fecha:</strong>{\" \"}\r\n                        {format(\r\n                          parseISO(\r\n                            guia.fecha_creacion ||\r\n                              guia.created_at ||\r\n                              new Date().toISOString()\r\n                          ),\r\n                          \"yyyy-MM-dd HH:mm\"\r\n                        )}\r\n                      </p>\r\n                      <p>\r\n                        <strong>Punto:</strong>{\" \"}\r\n                        {guia.punto_atencion_nombre || \"N/A\"}\r\n                      </p>\r\n                      {guia.usuario_nombre && (\r\n                        <p>\r\n                          <strong>Usuario:</strong> {guia.usuario_nombre}\r\n                        </p>\r\n                      )}\r\n                      {guia.destinatario_nombre && (\r\n                        <p>\r\n                          <strong>Destinatario:</strong>{\" \"}\r\n                          {guia.destinatario_nombre}\r\n                        </p>\r\n                      )}\r\n                      {guia.destinatario_telefono && (\r\n                        <p>\r\n                          <strong>Tel├®fono:</strong>{\" \"}\r\n                          {guia.destinatario_telefono}\r\n                        </p>\r\n                      )}\r\n                      {guia.valor_declarado && (\r\n                        <p>\r\n                          <strong>Valor Declarado:</strong> $\r\n                          {guia.valor_declarado.toLocaleString()}\r\n                        </p>\r\n                      )}\r\n                      {guia.costo_envio && (\r\n                        <p>\r\n                          <strong>Costo Env├¡o:</strong> $\r\n                          {guia.costo_envio.toLocaleString()}\r\n                        </p>\r\n                      )}\r\n                      {guia.motivo_anulacion && (\r\n                        <p>\r\n                          <strong>Motivo anulaci├│n:</strong>{\" \"}\r\n                          {guia.motivo_anulacion}\r\n                        </p>\r\n                      )}\r\n                      {guia.fecha_anulacion && (\r\n                        <p>\r\n                          <strong>Fecha anulaci├│n:</strong>{\" \"}\r\n                          {format(\r\n                            parseISO(guia.fecha_anulacion),\r\n                            \"yyyy-MM-dd HH:mm\"\r\n                          )}\r\n                        </p>\r\n                      )}\r\n                      {guia.anulada_por && (\r\n                        <p>\r\n                          <strong>Anulada por:</strong> {guia.anulada_por}\r\n                        </p>\r\n                      )}\r\n                    </div>\r\n                  </div>\r\n\r\n                  <div className=\"flex gap-2\">\r\n                    <Button\r\n                      size=\"sm\"\r\n                      variant=\"outline\"\r\n                      onClick={() =>\r\n                        handleVerPDF(\r\n                          guia.pdf_base64 || guia.base64_response || \"\"\r\n                        )\r\n                      }\r\n                      disabled={!guia.pdf_base64 && !guia.base64_response}\r\n                    >\r\n                      <Eye className=\"w-4 h-4 mr-1\" />\r\n                      Ver PDF\r\n                    </Button>\r\n                  </div>\r\n                </div>\r\n              ))}\r\n            </div>\r\n          )}\r\n        </CardContent>\r\n      </Card>\r\n\r\n      {/* Estad├¡sticas por punto */}\r\n      {estadisticas &&\r\n        estadisticas.total_por_punto &&\r\n        estadisticas.total_por_punto.length > 0 && (\r\n          <Card>\r\n            <CardHeader>\r\n              <CardTitle>Estad├¡sticas por Punto de Atenci├│n</CardTitle>\r\n            </CardHeader>\r\n            <CardContent>\r\n              <div className=\"space-y-4\">\r\n                {estadisticas.total_por_punto.map((punto, index) => (\r\n                  <div key={index} className=\"border rounded-lg p-4\">\r\n                    <h3 className=\"font-semibold mb-2\">\r\n                      {punto.punto_atencion_nombre}\r\n                    </h3>\r\n                    <div className=\"grid grid-cols-3 gap-4 text-sm\">\r\n                      <div>\r\n                        <p className=\"text-gray-600\">Total</p>\r\n                        <p className=\"text-lg font-bold\">{punto.total}</p>\r\n                      </div>\r\n                      <div>\r\n                        <p className=\"text-gray-600\">Activas</p>\r\n                        <p className=\"text-lg font-bold text-green-600\">\r\n                          {punto.activas}\r\n                        </p>\r\n                      </div>\r\n                      <div>\r\n                        <p className=\"text-gray-600\">Anuladas</p>\r\n                        <p className=\"text-lg font-bold text-red-600\">\r\n                          {punto.anuladas}\r\n                        </p>\r\n                      </div>\r\n                    </div>\r\n                  </div>\r\n                ))}\r\n              </div>\r\n            </CardContent>\r\n          </Card>\r\n        )}\r\n    </div>\r\n  );\r\n};\r\n\r\nexport default ServientregaInformes;\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\oswal\\OneDrive\\Documentos\\Punto Cambio\\punto_cambio_new\\src\\components\\admin\\TransferAcceptance.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\oswal\\OneDrive\\Documentos\\Punto Cambio\\punto_cambio_new\\src\\components\\admin\\TransferApprovals.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\oswal\\OneDrive\\Documentos\\Punto Cambio\\punto_cambio_new\\src\\components\\auth\\LoginForm.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\oswal\\OneDrive\\Documentos\\Punto Cambio\\punto_cambio_new\\src\\components\\auth\\PointSelection.tsx","messages":[{"ruleId":"no-console","severity":1,"message":"Unexpected console statement. Only these console methods are allowed: warn, error.","line":41,"column":5,"nodeType":"MemberExpression","messageId":"limited","endLine":41,"endColumn":16,"suggestions":[{"fix":{"range":[1202,1261],"text":""},"messageId":"removeConsole","data":{"propertyName":"log"},"desc":"Remove the console.log()."}]},{"ruleId":"no-console","severity":1,"message":"Unexpected console statement. Only these console methods are allowed: warn, error.","line":45,"column":7,"nodeType":"MemberExpression","messageId":"limited","endLine":45,"endColumn":18,"suggestions":[{"fix":{"range":[1357,1406],"text":""},"messageId":"removeConsole","data":{"propertyName":"log"},"desc":"Remove the console.log()."}]},{"ruleId":"no-console","severity":1,"message":"Unexpected console statement. Only these console methods are allowed: warn, error.","line":56,"column":9,"nodeType":"MemberExpression","messageId":"limited","endLine":56,"endColumn":20,"suggestions":[{"fix":{"range":[1781,1840],"text":""},"messageId":"removeConsole","data":{"propertyName":"log"},"desc":"Remove the console.log()."}]},{"ruleId":"no-console","severity":1,"message":"Unexpected console statement. Only these console methods are allowed: warn, error.","line":61,"column":9,"nodeType":"MemberExpression","messageId":"limited","endLine":61,"endColumn":20,"suggestions":[{"fix":{"range":[1962,2029],"text":""},"messageId":"removeConsole","data":{"propertyName":"log"},"desc":"Remove the console.log()."}]}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":4,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import { useState, useEffect } from \"react\";\r\nimport { useNavigate } from \"react-router-dom\";\r\nimport { Button } from \"@/components/ui/button\";\r\nimport {\r\n  Card,\r\n  CardContent,\r\n  CardDescription,\r\n  CardHeader,\r\n  CardTitle,\r\n} from \"@/components/ui/card\";\r\nimport { User, PuntoAtencion } from \"../../types\";\r\nimport { scheduleService } from \"../../services/scheduleService\";\r\nimport { toast } from \"@/hooks/use-toast\";\r\nimport { useAuth } from \"@/hooks/useAuth\";\r\n\r\ninterface PointSelectionProps {\r\n  user: User;\r\n  points: PuntoAtencion[];\r\n  onLogout: () => void;\r\n  onPointSelect?: (point: PuntoAtencion) => void;\r\n}\r\n\r\nconst PointSelection = ({\r\n  user,\r\n  points,\r\n  onLogout,\r\n  onPointSelect,\r\n}: PointSelectionProps) => {\r\n  const [isStartingShift, setIsStartingShift] = useState(false);\r\n  const { setSelectedPoint, selectedPoint } = useAuth();\r\n  const navigate = useNavigate();\r\n\r\n  // Redirige autom├íticamente si ya hay punto seleccionado\r\n  useEffect(() => {\r\n    if (selectedPoint) {\r\n      navigate(\"/\", { replace: true }); // ÔåÉ volver al ├¡ndice para que cargue Dashboard\r\n    }\r\n  }, [selectedPoint, navigate]);\r\n\r\n  const handlePointSelect = async (point: PuntoAtencion) => {\r\n    console.log(\"­ƒÄ» handlePointSelect START\", { user, point });\r\n    setIsStartingShift(true);\r\n    try {\r\n      const ubicacion = await getLocation();\r\n      console.log(\"­ƒôì Ubicaci├│n obtenida:\", ubicacion);\r\n\r\n      // Operadores y Administrativos: crear o actualizar jornada autom├íticamente\r\n      if (user.rol === \"OPERADOR\" || user.rol === \"ADMINISTRATIVO\") {\r\n        const scheduleData = {\r\n          usuario_id: user.id,\r\n          punto_atencion_id: point.id,\r\n          fecha_inicio: new Date().toISOString(),\r\n          ubicacion_inicio: ubicacion,\r\n        };\r\n\r\n        console.log(\"­ƒôà Creando jornada con datos:\", scheduleData);\r\n\r\n        const { schedule, error } =\r\n          await scheduleService.createOrUpdateSchedule(scheduleData);\r\n\r\n        console.log(\"­ƒôà Resultado de crear jornada:\", { schedule, error });\r\n\r\n        if (error) {\r\n          toast({\r\n            title: \"Error\",\r\n            description: `Error al iniciar jornada: ${error}`,\r\n            variant: \"destructive\",\r\n          });\r\n          return;\r\n        }\r\n\r\n        toast({\r\n          title: \"┬íJornada iniciada autom├íticamente!\",\r\n          description: `Conectado a ${point.nombre}. Tu jornada laboral ha comenzado.`,\r\n        });\r\n      } else {\r\n        // Otros roles: solo seleccionar punto sin crear jornada\r\n        toast({\r\n          title: \"Punto seleccionado\",\r\n          description: `Conectado a ${point.nombre}.`,\r\n        });\r\n      }\r\n\r\n      setSelectedPoint(point);\r\n\r\n      if (typeof onPointSelect === \"function\") {\r\n        onPointSelect(point);\r\n      }\r\n\r\n      // No navegar manualmente. Lo hace el useEffect al detectar selectedPoint\r\n    } catch {\r\n      toast({\r\n        title: \"Error\",\r\n        description: \"No se pudo obtener la ubicaci├│n\",\r\n        variant: \"destructive\",\r\n      });\r\n    } finally {\r\n      setIsStartingShift(false);\r\n    }\r\n  };\r\n\r\n  const getLocation = (): Promise<{\r\n    lat: number;\r\n    lng: number;\r\n    direccion?: string;\r\n  }> => {\r\n    return new Promise((resolve) => {\r\n      if (!navigator.geolocation) {\r\n        return resolve({\r\n          lat: 0,\r\n          lng: 0,\r\n          direccion: \"Ubicaci├│n no soportada\",\r\n        });\r\n      }\r\n\r\n      navigator.geolocation.getCurrentPosition(\r\n        (position) => {\r\n          resolve({\r\n            lat: position.coords.latitude,\r\n            lng: position.coords.longitude,\r\n            direccion: \"Ubicaci├│n de inicio de jornada\",\r\n          });\r\n        },\r\n        () => {\r\n          resolve({\r\n            lat: 0,\r\n            lng: 0,\r\n            direccion: \"Ubicaci├│n no disponible\",\r\n          });\r\n        },\r\n        { enableHighAccuracy: true, timeout: 10000, maximumAge: 60000 }\r\n      );\r\n    });\r\n  };\r\n\r\n  // Filtrar puntos seg├║n el rol del usuario\r\n  const getAvailablePoints = () => {\r\n    if (user.rol === \"OPERADOR\" || user.rol === \"CONCESION\") {\r\n      // Operadores y concesi├│n NO pueden usar el punto principal\r\n      return points.filter((point) => point.activo && !point.es_principal);\r\n    }\r\n    // Administrativos, Admins y Super Usuarios pueden usar todos los puntos activos\r\n    return points.filter((point) => point.activo);\r\n  };\r\n\r\n  const availablePoints = getAvailablePoints();\r\n\r\n  return (\r\n    <div className=\"min-h-screen bg-gray-50 flex items-center justify-center p-4\">\r\n      <Card className=\"w-full max-w-3xl\">\r\n        <CardHeader>\r\n          <CardTitle className=\"text-center\">\r\n            Seleccionar Punto de Atenci├│n\r\n          </CardTitle>\r\n          <CardDescription className=\"text-center\">\r\n            Hola {user.nombre}, selecciona el punto donde trabajar├ís hoy.\r\n          </CardDescription>\r\n        </CardHeader>\r\n        <CardContent>\r\n          <div className=\"space-y-4\">\r\n            {availablePoints.length === 0 ? (\r\n              <div className=\"text-center py-8 text-gray-500\">\r\n                {user.rol === \"OPERADOR\"\r\n                  ? \"No hay puntos operativos disponibles. Los operadores no pueden acceder al punto principal.\"\r\n                  : \"No hay puntos disponibles.\"}\r\n              </div>\r\n            ) : (\r\n              availablePoints.map((point) => (\r\n                <div\r\n                  key={point.id}\r\n                  className={`p-4 border rounded-lg transition-colors hover:bg-blue-50 cursor-pointer border-gray-200 ${\r\n                    isStartingShift ? \"opacity-50 pointer-events-none\" : \"\"\r\n                  }`}\r\n                  onClick={() => handlePointSelect(point)}\r\n                >\r\n                  <div className=\"flex items-center justify-between\">\r\n                    <div>\r\n                      <div className=\"flex items-center gap-2\">\r\n                        <h3 className=\"font-semibold text-lg\">\r\n                          {point.nombre}\r\n                        </h3>\r\n                        {point.es_principal && (\r\n                          <span className=\"bg-blue-100 text-blue-800 text-xs font-medium px-2 py-1 rounded\">\r\n                            Principal\r\n                          </span>\r\n                        )}\r\n                      </div>\r\n                      <p className=\"text-sm text-gray-600\">{point.direccion}</p>\r\n                      <p className=\"text-sm text-gray-600\">\r\n                        {point.ciudad}, {point.provincia}\r\n                      </p>\r\n                      {point.telefono && (\r\n                        <p className=\"text-sm text-gray-600\">\r\n                          {point.telefono}\r\n                        </p>\r\n                      )}\r\n                    </div>\r\n                    <div className=\"text-right\">\r\n                      <Button size=\"sm\" disabled={isStartingShift}>\r\n                        {isStartingShift ? \"Iniciando...\" : \"Seleccionar\"}\r\n                      </Button>\r\n                    </div>\r\n                  </div>\r\n                </div>\r\n              ))\r\n            )}\r\n          </div>\r\n          <div className=\"mt-6 pt-4 border-t flex justify-center\">\r\n            <Button\r\n              variant=\"outline\"\r\n              onClick={onLogout}\r\n              className=\"text-red-600 border-red-600 hover:bg-red-50\"\r\n              disabled={isStartingShift}\r\n            >\r\n              Cerrar Sesi├│n\r\n            </Button>\r\n          </div>\r\n        </CardContent>\r\n      </Card>\r\n    </div>\r\n  );\r\n};\r\n\r\nexport default PointSelection;\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\oswal\\OneDrive\\Documentos\\Punto Cambio\\punto_cambio_new\\src\\components\\caja\\CierreDialog.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\oswal\\OneDrive\\Documentos\\Punto Cambio\\punto_cambio_new\\src\\components\\caja\\CuadreCajaPage.tsx","messages":[{"ruleId":"no-console","severity":1,"message":"Unexpected console statement. Only these console methods are allowed: warn, error.","line":66,"column":5,"nodeType":"MemberExpression","messageId":"limited","endLine":66,"endColumn":16,"suggestions":[{"fix":{"range":[1844,1878],"text":""},"messageId":"removeConsole","data":{"propertyName":"log"},"desc":"Remove the console.log()."}]}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":1,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import * as React from \"react\";\r\nimport useCuadreCaja from \"../../hooks/useCuadreCaja\";\r\n\r\n// Alias corto para createElement\r\nconst h = React.createElement;\r\n\r\nfunction n2(v?: unknown) {\r\n  // Validaci├│n defensiva para evitar renderizar objetos\r\n  const n = typeof v === \"number\" && Number.isFinite(v) ? v : 0;\r\n  return n.toLocaleString(undefined, {\r\n    minimumFractionDigits: 2,\r\n    maximumFractionDigits: 2,\r\n  });\r\n}\r\n\r\ntype Props = { pointId?: string };\r\n\r\nexport default function CuadreCajaPage({ pointId }: Props) {\r\n  const [fecha, setFecha] = React.useState<string>(\r\n    new Date().toISOString().slice(0, 10)\r\n  );\r\n  const [allowMismatch, setAllowMismatch] = React.useState(false);\r\n\r\n  const {\r\n    loading,\r\n    saving,\r\n    error,\r\n    cuadre,\r\n    contabilidad,\r\n    parciales,\r\n    estado,\r\n    setObservaciones,\r\n    setFecha: setFechaHook,\r\n    updateConteo,\r\n    resetConteos,\r\n    totales,\r\n    diferencias,\r\n    puedeCerrar,\r\n    refresh,\r\n    guardarParcial,\r\n    guardarCerrado,\r\n  } = useCuadreCaja({ fecha, pointId, withContabilidad: !!pointId });\r\n\r\n  const hayFueraTolerancia = React.useMemo(\r\n    () => diferencias.some((d) => d.fueraDeTolerancia),\r\n    [diferencias]\r\n  );\r\n\r\n  const onGuardarParcial = async () => {\r\n    const resp = await guardarParcial({ allowMismatch });\r\n    if (!resp?.success && error)\r\n      alert(`No se pudo guardar el parcial: ${error}`);\r\n    else if (resp?.success)\r\n      alert(`Cierre parcial guardado. ID: ${resp.cuadre_id}`);\r\n  };\r\n\r\n  const onGuardarCerrado = async () => {\r\n    const resp = await guardarCerrado({ allowMismatch });\r\n    if (!resp?.success && error) alert(`No se pudo cerrar la caja: ${error}`);\r\n    else if (resp?.success)\r\n      alert(`Cierre de caja realizado. ID: ${resp.cuadre_id}`);\r\n  };\r\n\r\n  const onRefresh = async () => {\r\n    await refresh();\r\n    console.log(\"Datos actualizados\");\r\n  };\r\n\r\n  const onChangeFecha = (val: string) => {\r\n    setFecha(val);\r\n    setFechaHook(val);\r\n  };\r\n\r\n  // ---------- UI helpers sin JSX ----------\r\n  const Box = (props: {\r\n    style?: React.CSSProperties;\r\n    children?: React.ReactNode;\r\n  }) => h(\"div\", { style: props.style }, props.children);\r\n\r\n  const Label = (props: {\r\n    children?: React.ReactNode;\r\n    style?: React.CSSProperties;\r\n    htmlFor?: string;\r\n  }) =>\r\n    h(\"label\", { style: props.style, htmlFor: props.htmlFor }, props.children);\r\n\r\n  const Button = (props: {\r\n    onClick?: () => void;\r\n    disabled?: boolean;\r\n    children?: React.ReactNode;\r\n    style?: React.CSSProperties;\r\n  }) =>\r\n    h(\r\n      \"button\",\r\n      { onClick: props.onClick, disabled: props.disabled, style: props.style },\r\n      props.children\r\n    );\r\n\r\n  const Input = (props: React.InputHTMLAttributes<HTMLInputElement>) =>\r\n    h(\"input\", { ...props });\r\n  const Textarea = (props: React.TextareaHTMLAttributes<HTMLTextAreaElement>) =>\r\n    h(\"textarea\", { ...props });\r\n\r\n  const Table = (props: {\r\n    children?: React.ReactNode;\r\n    style?: React.CSSProperties;\r\n  }) =>\r\n    h(\r\n      \"table\",\r\n      {\r\n        style: {\r\n          width: \"100%\",\r\n          fontSize: 14,\r\n          borderCollapse: \"collapse\",\r\n          ...(props.style || {}),\r\n        },\r\n      },\r\n      props.children\r\n    );\r\n  const THead = (props: { children?: React.ReactNode }) =>\r\n    h(\"thead\", null, props.children);\r\n  const TBody = (props: { children?: React.ReactNode }) =>\r\n    h(\"tbody\", null, props.children);\r\n  const TR = (props: {\r\n    children?: React.ReactNode;\r\n    style?: React.CSSProperties;\r\n  }) => h(\"tr\", { style: props.style }, props.children);\r\n  const TH = (props: {\r\n    children?: React.ReactNode;\r\n    style?: React.CSSProperties;\r\n  }) => h(\"th\", { style: props.style }, props.children);\r\n  const TD = (props: {\r\n    children?: React.ReactNode;\r\n    style?: React.CSSProperties;\r\n    colSpan?: number;\r\n  }) => h(\"td\", { style: props.style, colSpan: props.colSpan }, props.children);\r\n  const HR = (props: { style?: React.CSSProperties }) =>\r\n    h(\"hr\", { style: props.style });\r\n\r\n  // ---------- Render ----------\r\n  return h(\r\n    Box,\r\n    { style: { maxWidth: 1200, margin: \"0 auto\", padding: 16 } },\r\n    // Filtros / Acciones\r\n    h(\r\n      Box,\r\n      {\r\n        style: {\r\n          display: \"flex\",\r\n          gap: 12,\r\n          alignItems: \"flex-end\",\r\n          justifyContent: \"space-between\",\r\n          flexWrap: \"wrap\",\r\n          marginBottom: 12,\r\n        },\r\n      },\r\n      h(\r\n        Box,\r\n        {\r\n          style: {\r\n            display: \"flex\",\r\n            gap: 12,\r\n            alignItems: \"flex-end\",\r\n            flexWrap: \"wrap\",\r\n          },\r\n        },\r\n        h(\r\n          Label,\r\n          { style: { display: \"grid\", gap: 4 } },\r\n          h(\"span\", { style: { fontSize: 12 } }, \"Fecha (GYE)\"),\r\n          h(Input, {\r\n            id: \"fecha\",\r\n            type: \"date\",\r\n            value: fecha,\r\n            onChange: (e: React.ChangeEvent<HTMLInputElement>) =>\r\n              onChangeFecha(e.target.value),\r\n            style: { width: 180, padding: \"6px 8px\" },\r\n          })\r\n        ),\r\n        h(\r\n          Button,\r\n          {\r\n            onClick: onRefresh,\r\n            disabled: loading,\r\n            style: { padding: \"6px 10px\" },\r\n          },\r\n          loading ? \"ActualizandoÔÇª\" : \"Actualizar\"\r\n        )\r\n      ),\r\n      h(\r\n        Box,\r\n        { style: { display: \"flex\", gap: 12, alignItems: \"center\" } },\r\n        h(\r\n          Label,\r\n          {\r\n            style: {\r\n              display: \"flex\",\r\n              alignItems: \"center\",\r\n              gap: 6,\r\n              fontSize: 14,\r\n            },\r\n          },\r\n          h(Input, {\r\n            type: \"checkbox\",\r\n            checked: allowMismatch,\r\n            onChange: (e: React.ChangeEvent<HTMLInputElement>) =>\r\n              setAllowMismatch(!!e.target.checked),\r\n          }),\r\n          \"Permitir diferencia\"\r\n        ),\r\n        h(\r\n          Button,\r\n          { onClick: resetConteos, style: { padding: \"6px 10px\" } },\r\n          \"Reset conteos\"\r\n        )\r\n      )\r\n    ),\r\n\r\n    // Error\r\n    error\r\n      ? h(\r\n          Box,\r\n          {\r\n            style: {\r\n              border: \"1px solid #ef4444\",\r\n              color: \"#ef4444\",\r\n              padding: 12,\r\n              borderRadius: 8,\r\n              marginBottom: 12,\r\n              fontSize: 14,\r\n            },\r\n          },\r\n          error\r\n        )\r\n      : null,\r\n\r\n    // Card Cuadre\r\n    h(\r\n      Box,\r\n      {\r\n        style: {\r\n          border: \"1px solid #e5e7eb\",\r\n          borderRadius: 12,\r\n          overflow: \"hidden\",\r\n        },\r\n      },\r\n      h(\r\n        Box,\r\n        {\r\n          style: {\r\n            padding: 12,\r\n            borderBottom: \"1px solid #e5e7eb\",\r\n            display: \"flex\",\r\n            alignItems: \"center\",\r\n            justifyContent: \"space-between\",\r\n            gap: 8,\r\n          },\r\n        },\r\n        h(Box, { style: { fontWeight: 600 } }, \"Cuadre de Caja\"),\r\n        h(\r\n          Box,\r\n          {\r\n            style: {\r\n              fontSize: 12,\r\n              padding: \"2px 8px\",\r\n              borderRadius: 999,\r\n              background: hayFueraTolerancia ? \"#fee2e2\" : \"#f3f4f6\",\r\n              color: hayFueraTolerancia ? \"#991b1b\" : \"#111827\",\r\n            },\r\n          },\r\n          hayFueraTolerancia\r\n            ? \"Diferencias fuera de tolerancia\"\r\n            : \"Sin diferencias relevantes\"\r\n        )\r\n      ),\r\n\r\n      h(\r\n        Box,\r\n        { style: { padding: 12 } },\r\n        h(\r\n          Box,\r\n          { style: { overflowX: \"auto\" } },\r\n          h(\r\n            Table,\r\n            null,\r\n            h(\r\n              THead,\r\n              null,\r\n              h(\r\n                TR,\r\n                { style: { textAlign: \"left\" as const } },\r\n                h(TH, { style: { padding: \"8px 4px\" } }, \"Moneda\"),\r\n                h(\r\n                  TH,\r\n                  {\r\n                    style: { padding: \"8px 4px\", textAlign: \"right\" as const },\r\n                  },\r\n                  \"Apertura\"\r\n                ),\r\n                h(\r\n                  TH,\r\n                  {\r\n                    style: { padding: \"8px 4px\", textAlign: \"right\" as const },\r\n                  },\r\n                  \"Ingresos\"\r\n                ),\r\n                h(\r\n                  TH,\r\n                  {\r\n                    style: { padding: \"8px 4px\", textAlign: \"right\" as const },\r\n                  },\r\n                  \"Egresos\"\r\n                ),\r\n                h(\r\n                  TH,\r\n                  {\r\n                    style: { padding: \"8px 4px\", textAlign: \"right\" as const },\r\n                  },\r\n                  \"Te├│rico\"\r\n                ),\r\n                h(\r\n                  TH,\r\n                  {\r\n                    style: { padding: \"8px 4px\", textAlign: \"right\" as const },\r\n                  },\r\n                  \"Bancos te├│rico\"\r\n                ),\r\n                h(\r\n                  TH,\r\n                  {\r\n                    style: { padding: \"8px 4px\", textAlign: \"right\" as const },\r\n                  },\r\n                  \"Conteo bancos\"\r\n                ),\r\n                h(\r\n                  TH,\r\n                  {\r\n                    style: { padding: \"8px 4px\", textAlign: \"right\" as const },\r\n                  },\r\n                  \"Conteo f├¡sico\"\r\n                ),\r\n                h(\r\n                  TH,\r\n                  {\r\n                    style: { padding: \"8px 4px\", textAlign: \"right\" as const },\r\n                  },\r\n                  \"Billetes\"\r\n                ),\r\n                h(\r\n                  TH,\r\n                  {\r\n                    style: { padding: \"8px 4px\", textAlign: \"right\" as const },\r\n                  },\r\n                  \"Monedas\"\r\n                ),\r\n                h(\r\n                  TH,\r\n                  {\r\n                    style: { padding: \"8px 4px\", textAlign: \"right\" as const },\r\n                  },\r\n                  \"Diferencia\"\r\n                )\r\n              )\r\n            ),\r\n            h(\r\n              TBody,\r\n              null,\r\n              estado.detalles.length > 0\r\n                ? estado.detalles.map((d) => {\r\n                    const conteoFisico =\r\n                      typeof d.conteo_fisico === \"number\" ? d.conteo_fisico : 0;\r\n                    const saldoCierre =\r\n                      typeof d.saldo_cierre === \"number\" ? d.saldo_cierre : 0;\r\n                    const diff = conteoFisico - saldoCierre;\r\n                    const fueraTol =\r\n                      Math.abs(diff) >\r\n                      (d.codigo?.toUpperCase() === \"USD\" ? 1 : 0.01);\r\n                    const diffColor = fueraTol\r\n                      ? \"#dc2626\"\r\n                      : diff === 0\r\n                      ? \"#6b7280\"\r\n                      : \"#b45309\";\r\n                    return h(\r\n                      TR,\r\n                      {\r\n                        key: d.moneda_id,\r\n                        style: { borderTop: \"1px solid #e5e7eb\" },\r\n                      },\r\n                      h(\r\n                        TD,\r\n                        { style: { padding: \"8px 4px\", whiteSpace: \"nowrap\" } },\r\n                        h(\r\n                          Box,\r\n                          {\r\n                            style: { display: \"flex\", flexDirection: \"column\" },\r\n                          },\r\n                          h(\"span\", { style: { fontWeight: 600 } }, d.nombre),\r\n                          h(\r\n                            \"span\",\r\n                            { style: { fontSize: 12, color: \"#6b7280\" } },\r\n                            `${d.codigo} ${d.simbolo}`\r\n                          )\r\n                        )\r\n                      ),\r\n                      h(\r\n                        TD,\r\n                        {\r\n                          style: {\r\n                            padding: \"8px 4px\",\r\n                            textAlign: \"right\" as const,\r\n                          },\r\n                        },\r\n                        n2(d.saldo_apertura)\r\n                      ),\r\n                      h(\r\n                        TD,\r\n                        {\r\n                          style: {\r\n                            padding: \"8px 4px\",\r\n                            textAlign: \"right\" as const,\r\n                          },\r\n                        },\r\n                        n2(d.ingresos_periodo)\r\n                      ),\r\n                      h(\r\n                        TD,\r\n                        {\r\n                          style: {\r\n                            padding: \"8px 4px\",\r\n                            textAlign: \"right\" as const,\r\n                          },\r\n                        },\r\n                        n2(d.egresos_periodo)\r\n                      ),\r\n                      h(\r\n                        TD,\r\n                        {\r\n                          style: {\r\n                            padding: \"8px 4px\",\r\n                            textAlign: \"right\" as const,\r\n                            fontWeight: 600,\r\n                          },\r\n                        },\r\n                        n2(d.saldo_cierre)\r\n                      ),\r\n                      h(\r\n                        TD,\r\n                        {\r\n                          style: {\r\n                            padding: \"8px 4px\",\r\n                            textAlign: \"right\" as const,\r\n                          },\r\n                        },\r\n                        n2(d.bancos_teorico)\r\n                      ),\r\n                      h(\r\n                        TD,\r\n                        {\r\n                          style: {\r\n                            padding: \"8px 4px\",\r\n                            textAlign: \"right\" as const,\r\n                          },\r\n                        },\r\n                        h(Input, {\r\n                          inputMode: \"decimal\",\r\n                          value:\r\n                            typeof d.conteo_bancos === \"number\" &&\r\n                            Number.isFinite(d.conteo_bancos)\r\n                              ? d.conteo_bancos\r\n                              : 0,\r\n                          onChange: (e: React.ChangeEvent<HTMLInputElement>) => {\r\n                            const val = parseFloat(e.target.value);\r\n                            updateConteo(d.moneda_id, {\r\n                              conteo_bancos: Number.isFinite(val) ? val : 0,\r\n                            });\r\n                          },\r\n                          style: {\r\n                            width: 120,\r\n                            padding: \"6px 8px\",\r\n                            textAlign: \"right\",\r\n                          },\r\n                        })\r\n                      ),\r\n                      h(\r\n                        TD,\r\n                        {\r\n                          style: {\r\n                            padding: \"8px 4px\",\r\n                            textAlign: \"right\" as const,\r\n                          },\r\n                        },\r\n                        h(Input, {\r\n                          inputMode: \"decimal\",\r\n                          value:\r\n                            typeof d.conteo_fisico === \"number\" &&\r\n                            Number.isFinite(d.conteo_fisico)\r\n                              ? d.conteo_fisico\r\n                              : 0,\r\n                          onChange: (e: React.ChangeEvent<HTMLInputElement>) => {\r\n                            const val = parseFloat(e.target.value);\r\n                            updateConteo(d.moneda_id, {\r\n                              conteo_fisico: Number.isFinite(val) ? val : 0,\r\n                            });\r\n                          },\r\n                          style: {\r\n                            width: 120,\r\n                            padding: \"6px 8px\",\r\n                            textAlign: \"right\",\r\n                          },\r\n                        })\r\n                      ),\r\n                      h(\r\n                        TD,\r\n                        {\r\n                          style: {\r\n                            padding: \"8px 4px\",\r\n                            textAlign: \"right\" as const,\r\n                          },\r\n                        },\r\n                        h(Input, {\r\n                          inputMode: \"numeric\",\r\n                          value:\r\n                            typeof d.billetes === \"number\" &&\r\n                            Number.isFinite(d.billetes)\r\n                              ? d.billetes\r\n                              : 0,\r\n                          onChange: (e: React.ChangeEvent<HTMLInputElement>) => {\r\n                            const val = parseFloat(e.target.value);\r\n                            updateConteo(d.moneda_id, {\r\n                              billetes: Number.isFinite(val) ? val : 0,\r\n                            });\r\n                          },\r\n                          style: {\r\n                            width: 90,\r\n                            padding: \"6px 8px\",\r\n                            textAlign: \"right\",\r\n                          },\r\n                        })\r\n                      ),\r\n                      h(\r\n                        TD,\r\n                        {\r\n                          style: {\r\n                            padding: \"8px 4px\",\r\n                            textAlign: \"right\" as const,\r\n                          },\r\n                        },\r\n                        h(Input, {\r\n                          inputMode: \"numeric\",\r\n                          value:\r\n                            typeof d.monedas === \"number\" &&\r\n                            Number.isFinite(d.monedas)\r\n                              ? d.monedas\r\n                              : 0,\r\n                          onChange: (e: React.ChangeEvent<HTMLInputElement>) => {\r\n                            const val = parseFloat(e.target.value);\r\n                            updateConteo(d.moneda_id, {\r\n                              monedas: Number.isFinite(val) ? val : 0,\r\n                            });\r\n                          },\r\n                          style: {\r\n                            width: 90,\r\n                            padding: \"6px 8px\",\r\n                            textAlign: \"right\",\r\n                          },\r\n                        })\r\n                      ),\r\n                      h(\r\n                        TD,\r\n                        {\r\n                          style: {\r\n                            padding: \"8px 4px\",\r\n                            textAlign: \"right\" as const,\r\n                            fontWeight: 600,\r\n                            color: diffColor,\r\n                          },\r\n                        },\r\n                        n2(diff)\r\n                      )\r\n                    );\r\n                  })\r\n                : h(\r\n                    TR,\r\n                    null,\r\n                    h(\r\n                      TD,\r\n                      {\r\n                        colSpan: 11,\r\n                        style: {\r\n                          padding: 24,\r\n                          textAlign: \"center\" as const,\r\n                          color: \"#6b7280\",\r\n                        },\r\n                      },\r\n                      loading ? \"CargandoÔÇª\" : \"No hay monedas para mostrar\"\r\n                    )\r\n                  )\r\n            )\r\n          )\r\n        ),\r\n        h(\r\n          Box,\r\n          { style: { marginTop: 8, fontSize: 14, color: \"#6b7280\" } },\r\n          `Totales ÔÇö Ingresos: ${n2(totales.ingresos)} ┬À Egresos: ${n2(\r\n            totales.egresos\r\n          )} ┬À Movs: ${totales.movimientos}`\r\n        ),\r\n        h(HR, { style: { margin: \"16px 0\", borderTop: \"1px solid #e5e7eb\" } }),\r\n        h(\r\n          Box,\r\n          { style: { display: \"grid\", gap: 8 } },\r\n          h(\r\n            Label,\r\n            { htmlFor: \"obs\", style: { fontSize: 14 } },\r\n            \"Observaciones\"\r\n          ),\r\n          h(Textarea, {\r\n            id: \"obs\",\r\n            placeholder: \"Notas del cierre, incidencias, soportesÔÇª\",\r\n            value: estado.observaciones,\r\n            onChange: (e: React.ChangeEvent<HTMLTextAreaElement>) =>\r\n              setObservaciones(e.target.value),\r\n            style: { minHeight: 90, padding: \"8px 10px\" },\r\n          })\r\n        ),\r\n        h(\r\n          Box,\r\n          {\r\n            style: {\r\n              marginTop: 16,\r\n              display: \"flex\",\r\n              gap: 8,\r\n              alignItems: \"center\",\r\n              justifyContent: \"space-between\",\r\n              flexWrap: \"wrap\",\r\n            },\r\n          },\r\n          h(\r\n            Box,\r\n            { style: { fontSize: 12, color: \"#6b7280\" } },\r\n            cuadre?.totales\r\n              ? `Cambios: ${\r\n                  typeof cuadre.totales.cambios?.cantidad === \"number\"\r\n                    ? cuadre.totales.cambios.cantidad\r\n                    : 0\r\n                } ┬À Transf. In: ${\r\n                  typeof cuadre.totales.transferencias_entrada?.cantidad ===\r\n                  \"number\"\r\n                    ? cuadre.totales.transferencias_entrada.cantidad\r\n                    : 0\r\n                } ┬À Transf. Out: ${\r\n                  typeof cuadre.totales.transferencias_salida?.cantidad ===\r\n                  \"number\"\r\n                    ? cuadre.totales.transferencias_salida.cantidad\r\n                    : 0\r\n                }`\r\n              : null\r\n          ),\r\n          h(\r\n            Box,\r\n            { style: { display: \"flex\", gap: 8 } },\r\n            h(\r\n              Button,\r\n              {\r\n                onClick: onGuardarParcial,\r\n                disabled: saving || loading,\r\n                style: { padding: \"8px 12px\" },\r\n              },\r\n              \"Guardar parcial\"\r\n            ),\r\n            h(\r\n              Button,\r\n              {\r\n                onClick: onGuardarCerrado,\r\n                disabled: saving || loading || !puedeCerrar,\r\n                style: { padding: \"8px 12px\" },\r\n              },\r\n              \"Cerrar caja\"\r\n            )\r\n          )\r\n        )\r\n      )\r\n    ),\r\n\r\n    // Paneles inferiores\r\n    h(\r\n      Box,\r\n      {\r\n        style: {\r\n          display: \"grid\",\r\n          gap: 16,\r\n          gridTemplateColumns: \"1fr\",\r\n          marginTop: 16,\r\n        },\r\n      },\r\n      // Resumen contable\r\n      h(\r\n        Box,\r\n        {\r\n          style: {\r\n            border: \"1px solid #e5e7eb\",\r\n            borderRadius: 12,\r\n            overflow: \"hidden\",\r\n          },\r\n        },\r\n        h(\r\n          Box,\r\n          {\r\n            style: {\r\n              padding: 12,\r\n              borderBottom: \"1px solid #e5e7eb\",\r\n              fontWeight: 600,\r\n              fontSize: 14,\r\n            },\r\n          },\r\n          \"Resumen contable del d├¡a\"\r\n        ),\r\n        h(\r\n          Box,\r\n          { style: { padding: 12 } },\r\n          !contabilidad\r\n            ? h(\r\n                \"p\",\r\n                { style: { fontSize: 14, color: \"#6b7280\" } },\r\n                \"Sin datos de contabilidad para esta vista.\"\r\n              )\r\n            : contabilidad.resumen.length === 0\r\n            ? h(\r\n                \"p\",\r\n                { style: { fontSize: 14, color: \"#6b7280\" } },\r\n                \"No hay movimientos.\"\r\n              )\r\n            : h(\r\n                Box,\r\n                { style: { overflowX: \"auto\" } },\r\n                h(\r\n                  Table,\r\n                  null,\r\n                  h(\r\n                    THead,\r\n                    null,\r\n                    h(\r\n                      TR,\r\n                      null,\r\n                      h(\r\n                        TH,\r\n                        {\r\n                          style: {\r\n                            padding: \"8px 4px\",\r\n                            textAlign: \"left\" as const,\r\n                          },\r\n                        },\r\n                        \"Moneda\"\r\n                      ),\r\n                      h(\r\n                        TH,\r\n                        {\r\n                          style: {\r\n                            padding: \"8px 4px\",\r\n                            textAlign: \"right\" as const,\r\n                          },\r\n                        },\r\n                        \"Ingresos\"\r\n                      ),\r\n                      h(\r\n                        TH,\r\n                        {\r\n                          style: {\r\n                            padding: \"8px 4px\",\r\n                            textAlign: \"right\" as const,\r\n                          },\r\n                        },\r\n                        \"Egresos\"\r\n                      ),\r\n                      h(\r\n                        TH,\r\n                        {\r\n                          style: {\r\n                            padding: \"8px 4px\",\r\n                            textAlign: \"right\" as const,\r\n                          },\r\n                        },\r\n                        \"Movs\"\r\n                      )\r\n                    )\r\n                  ),\r\n                  h(\r\n                    TBody,\r\n                    null,\r\n                    contabilidad.resumen.map((r) =>\r\n                      h(\r\n                        TR,\r\n                        {\r\n                          key: r.moneda_id,\r\n                          style: { borderTop: \"1px solid #e5e7eb\" },\r\n                        },\r\n                        h(\r\n                          TD,\r\n                          { style: { padding: \"8px 4px\" } },\r\n                          h(\r\n                            Box,\r\n                            {\r\n                              style: {\r\n                                display: \"flex\",\r\n                                flexDirection: \"column\",\r\n                              },\r\n                            },\r\n                            h(\r\n                              \"span\",\r\n                              { style: { fontWeight: 600 } },\r\n                              r.moneda?.nombre ?? r.moneda_id\r\n                            ),\r\n                            h(\r\n                              \"span\",\r\n                              { style: { fontSize: 12, color: \"#6b7280\" } },\r\n                              `${r.moneda?.codigo ?? \"\"} ${\r\n                                r.moneda?.simbolo ?? \"\"\r\n                              }`\r\n                            )\r\n                          )\r\n                        ),\r\n                        h(\r\n                          TD,\r\n                          {\r\n                            style: {\r\n                              padding: \"8px 4px\",\r\n                              textAlign: \"right\" as const,\r\n                            },\r\n                          },\r\n                          n2(r.ingresos)\r\n                        ),\r\n                        h(\r\n                          TD,\r\n                          {\r\n                            style: {\r\n                              padding: \"8px 4px\",\r\n                              textAlign: \"right\" as const,\r\n                            },\r\n                          },\r\n                          n2(r.egresos)\r\n                        ),\r\n                        h(\r\n                          TD,\r\n                          {\r\n                            style: {\r\n                              padding: \"8px 4px\",\r\n                              textAlign: \"right\" as const,\r\n                            },\r\n                          },\r\n                          r.movimientos\r\n                        )\r\n                      )\r\n                    )\r\n                  )\r\n                )\r\n              )\r\n        )\r\n      ),\r\n\r\n      // Cierres parciales\r\n      h(\r\n        Box,\r\n        {\r\n          style: {\r\n            border: \"1px solid #e5e7eb\",\r\n            borderRadius: 12,\r\n            overflow: \"hidden\",\r\n          },\r\n        },\r\n        h(\r\n          Box,\r\n          {\r\n            style: {\r\n              padding: 12,\r\n              borderBottom: \"1px solid #e5e7eb\",\r\n              fontWeight: 600,\r\n              fontSize: 14,\r\n            },\r\n          },\r\n          \"Cierres parciales del d├¡a\"\r\n        ),\r\n        h(\r\n          Box,\r\n          { style: { padding: 12 } },\r\n          !parciales || parciales.length === 0\r\n            ? h(\r\n                \"p\",\r\n                { style: { fontSize: 14, color: \"#6b7280\" } },\r\n                \"No hay cierres parciales registrados.\"\r\n              )\r\n            : h(\r\n                Box,\r\n                { style: { display: \"grid\", gap: 8 } },\r\n                parciales.map((p) =>\r\n                  h(\r\n                    Box,\r\n                    {\r\n                      key: p.id,\r\n                      style: {\r\n                        padding: 12,\r\n                        border: \"1px solid #e5e7eb\",\r\n                        borderRadius: 12,\r\n                      },\r\n                    },\r\n                    h(\r\n                      Box,\r\n                      {\r\n                        style: {\r\n                          display: \"flex\",\r\n                          alignItems: \"center\",\r\n                          justifyContent: \"space-between\",\r\n                        },\r\n                      },\r\n                      h(\r\n                        Box,\r\n                        { style: { fontSize: 14 } },\r\n                        h(\r\n                          Box,\r\n                          { style: { fontWeight: 600 } },\r\n                          p.puntoAtencion?.nombre ?? p.puntoAtencion?.id\r\n                        ),\r\n                        h(\r\n                          Box,\r\n                          { style: { color: \"#6b7280\", fontSize: 12 } },\r\n                          new Date(\r\n                            p.fecha_cierre ?? p.fecha\r\n                          ).toLocaleString()\r\n                        )\r\n                      ),\r\n                      h(\r\n                        Box,\r\n                        {\r\n                          style: {\r\n                            fontSize: 12,\r\n                            padding: \"2px 8px\",\r\n                            border: \"1px solid #e5e7eb\",\r\n                            borderRadius: 999,\r\n                          },\r\n                        },\r\n                        p.estado\r\n                      )\r\n                    )\r\n                  )\r\n                )\r\n              )\r\n        )\r\n      )\r\n    )\r\n  );\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\oswal\\OneDrive\\Documentos\\Punto Cambio\\punto_cambio_new\\src\\components\\caja\\MonedaRow.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\oswal\\OneDrive\\Documentos\\Punto Cambio\\punto_cambio_new\\src\\components\\caja\\PrintCuadre.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\oswal\\OneDrive\\Documentos\\Punto Cambio\\punto_cambio_new\\src\\components\\caja\\ResumenCuadre.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\oswal\\OneDrive\\Documentos\\Punto Cambio\\punto_cambio_new\\src\\components\\close\\DailyClose.tsx","messages":[{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'showConfirmation' is assigned a value but never used. Allowed unused vars must match /^_/u.","line":177,"column":11,"nodeType":null,"messageId":"unusedVar","endLine":177,"endColumn":27},{"ruleId":"no-console","severity":1,"message":"Unexpected console statement. Only these console methods are allowed: warn, error.","line":207,"column":9,"nodeType":"MemberExpression","messageId":"limited","endLine":207,"endColumn":20,"suggestions":[{"fix":{"range":[5897,6004],"text":""},"messageId":"removeConsole","data":{"propertyName":"log"},"desc":"Remove the console.log()."}]},{"ruleId":"no-console","severity":1,"message":"Unexpected console statement. Only these console methods are allowed: warn, error.","line":211,"column":9,"nodeType":"MemberExpression","messageId":"limited","endLine":211,"endColumn":20,"suggestions":[{"fix":{"range":[6013,6252],"text":""},"messageId":"removeConsole","data":{"propertyName":"log"},"desc":"Remove the console.log()."}]},{"ruleId":"no-console","severity":1,"message":"Unexpected console statement. Only these console methods are allowed: warn, error.","line":218,"column":11,"nodeType":"MemberExpression","messageId":"limited","endLine":218,"endColumn":22,"suggestions":[{"fix":{"range":[6286,6336],"text":""},"messageId":"removeConsole","data":{"propertyName":"log"},"desc":"Remove the console.log()."}]},{"ruleId":"no-console","severity":1,"message":"Unexpected console statement. Only these console methods are allowed: warn, error.","line":223,"column":9,"nodeType":"MemberExpression","messageId":"limited","endLine":223,"endColumn":20,"suggestions":[{"fix":{"range":[6412,6474],"text":""},"messageId":"removeConsole","data":{"propertyName":"log"},"desc":"Remove the console.log()."}]},{"ruleId":"no-console","severity":1,"message":"Unexpected console statement. Only these console methods are allowed: warn, error.","line":234,"column":9,"nodeType":"MemberExpression","messageId":"limited","endLine":234,"endColumn":20,"suggestions":[{"fix":{"range":[6785,6852],"text":""},"messageId":"removeConsole","data":{"propertyName":"log"},"desc":"Remove the console.log()."}]},{"ruleId":"no-console","severity":1,"message":"Unexpected console statement. Only these console methods are allowed: warn, error.","line":238,"column":11,"nodeType":"MemberExpression","messageId":"limited","endLine":238,"endColumn":22,"suggestions":[{"fix":{"range":[6937,6991],"text":""},"messageId":"removeConsole","data":{"propertyName":"log"},"desc":"Remove the console.log()."}]},{"ruleId":"no-console","severity":1,"message":"Unexpected console statement. Only these console methods are allowed: warn, error.","line":246,"column":11,"nodeType":"MemberExpression","messageId":"limited","endLine":246,"endColumn":22,"suggestions":[{"fix":{"range":[7251,7301],"text":""},"messageId":"removeConsole","data":{"propertyName":"log"},"desc":"Remove the console.log()."}]},{"ruleId":"no-console","severity":1,"message":"Unexpected console statement. Only these console methods are allowed: warn, error.","line":249,"column":15,"nodeType":"MemberExpression","messageId":"limited","endLine":249,"endColumn":26,"suggestions":[{"fix":{"range":[7376,7438],"text":""},"messageId":"removeConsole","data":{"propertyName":"log"},"desc":"Remove the console.log()."}]},{"ruleId":"no-console","severity":1,"message":"Unexpected console statement. Only these console methods are allowed: warn, error.","line":274,"column":9,"nodeType":"MemberExpression","messageId":"limited","endLine":274,"endColumn":20,"suggestions":[{"fix":{"range":[8068,8120],"text":""},"messageId":"removeConsole","data":{"propertyName":"log"},"desc":"Remove the console.log()."}]},{"ruleId":"no-console","severity":1,"message":"Unexpected console statement. Only these console methods are allowed: warn, error.","line":275,"column":9,"nodeType":"MemberExpression","messageId":"limited","endLine":275,"endColumn":20,"suggestions":[{"fix":{"range":[8129,8205],"text":""},"messageId":"removeConsole","data":{"propertyName":"log"},"desc":"Remove the console.log()."}]},{"ruleId":"no-console","severity":1,"message":"Unexpected console statement. Only these console methods are allowed: warn, error.","line":289,"column":9,"nodeType":"MemberExpression","messageId":"limited","endLine":289,"endColumn":20,"suggestions":[{"fix":{"range":[8687,8733],"text":""},"messageId":"removeConsole","data":{"propertyName":"log"},"desc":"Remove the console.log()."}]},{"ruleId":"no-console","severity":1,"message":"Unexpected console statement. Only these console methods are allowed: warn, error.","line":298,"column":9,"nodeType":"MemberExpression","messageId":"limited","endLine":298,"endColumn":20,"suggestions":[{"fix":{"range":[8933,8985],"text":""},"messageId":"removeConsole","data":{"propertyName":"log"},"desc":"Remove the console.log()."}]},{"ruleId":"no-console","severity":1,"message":"Unexpected console statement. Only these console methods are allowed: warn, error.","line":299,"column":9,"nodeType":"MemberExpression","messageId":"limited","endLine":299,"endColumn":20,"suggestions":[{"fix":{"range":[8994,9169],"text":""},"messageId":"removeConsole","data":{"propertyName":"log"},"desc":"Remove the console.log()."}]},{"ruleId":"no-console","severity":1,"message":"Unexpected console statement. Only these console methods are allowed: warn, error.","line":306,"column":11,"nodeType":"MemberExpression","messageId":"limited","endLine":306,"endColumn":22,"suggestions":[{"fix":{"range":[9254,9300],"text":""},"messageId":"removeConsole","data":{"propertyName":"log"},"desc":"Remove the console.log()."}]},{"ruleId":"no-console","severity":1,"message":"Unexpected console statement. Only these console methods are allowed: warn, error.","line":309,"column":13,"nodeType":"MemberExpression","messageId":"limited","endLine":309,"endColumn":24,"suggestions":[{"fix":{"range":[9357,9615],"text":""},"messageId":"removeConsole","data":{"propertyName":"log"},"desc":"Remove the console.log()."}]},{"ruleId":"no-console","severity":1,"message":"Unexpected console statement. Only these console methods are allowed: warn, error.","line":333,"column":15,"nodeType":"MemberExpression","messageId":"limited","endLine":333,"endColumn":26,"suggestions":[{"fix":{"range":[10514,10614],"text":""},"messageId":"removeConsole","data":{"propertyName":"log"},"desc":"Remove the console.log()."}]},{"ruleId":"no-console","severity":1,"message":"Unexpected console statement. Only these console methods are allowed: warn, error.","line":338,"column":13,"nodeType":"MemberExpression","messageId":"limited","endLine":338,"endColumn":24,"suggestions":[{"fix":{"range":[10774,10831],"text":""},"messageId":"removeConsole","data":{"propertyName":"log"},"desc":"Remove the console.log()."}]},{"ruleId":"no-console","severity":1,"message":"Unexpected console statement. Only these console methods are allowed: warn, error.","line":365,"column":7,"nodeType":"MemberExpression","messageId":"limited","endLine":365,"endColumn":18,"suggestions":[{"fix":{"range":[11666,11746],"text":""},"messageId":"removeConsole","data":{"propertyName":"log"},"desc":"Remove the console.log()."}]},{"ruleId":"no-console","severity":1,"message":"Unexpected console statement. Only these console methods are allowed: warn, error.","line":369,"column":7,"nodeType":"MemberExpression","messageId":"limited","endLine":369,"endColumn":18,"suggestions":[{"fix":{"range":[11818,11884],"text":""},"messageId":"removeConsole","data":{"propertyName":"log"},"desc":"Remove the console.log()."}]},{"ruleId":"react-hooks/exhaustive-deps","severity":1,"message":"React Hook useEffect has a missing dependency: 'validarCierresRequeridos'. Either include it or remove the dependency array.","line":457,"column":6,"nodeType":"ArrayExpression","endLine":457,"endColumn":21,"suggestions":[{"desc":"Update the dependencies array to be: [selectedPoint, validarCierresRequeridos]","fix":{"range":[14319,14334],"text":"[selectedPoint, validarCierresRequeridos]"}}]},{"ruleId":"no-console","severity":1,"message":"Unexpected console statement. Only these console methods are allowed: warn, error.","line":464,"column":7,"nodeType":"MemberExpression","messageId":"limited","endLine":464,"endColumn":18,"suggestions":[{"fix":{"range":[14516,14568],"text":""},"messageId":"removeConsole","data":{"propertyName":"log"},"desc":"Remove the console.log()."}]},{"ruleId":"no-console","severity":1,"message":"Unexpected console statement. Only these console methods are allowed: warn, error.","line":465,"column":7,"nodeType":"MemberExpression","messageId":"limited","endLine":465,"endColumn":18,"suggestions":[{"fix":{"range":[14575,14651],"text":""},"messageId":"removeConsole","data":{"propertyName":"log"},"desc":"Remove the console.log()."}]},{"ruleId":"no-console","severity":1,"message":"Unexpected console statement. Only these console methods are allowed: warn, error.","line":482,"column":7,"nodeType":"MemberExpression","messageId":"limited","endLine":482,"endColumn":18,"suggestions":[{"fix":{"range":[15161,15207],"text":""},"messageId":"removeConsole","data":{"propertyName":"log"},"desc":"Remove the console.log()."}]},{"ruleId":"no-console","severity":1,"message":"Unexpected console statement. Only these console methods are allowed: warn, error.","line":491,"column":7,"nodeType":"MemberExpression","messageId":"limited","endLine":491,"endColumn":18,"suggestions":[{"fix":{"range":[15393,15445],"text":""},"messageId":"removeConsole","data":{"propertyName":"log"},"desc":"Remove the console.log()."}]},{"ruleId":"no-console","severity":1,"message":"Unexpected console statement. Only these console methods are allowed: warn, error.","line":492,"column":7,"nodeType":"MemberExpression","messageId":"limited","endLine":492,"endColumn":18,"suggestions":[{"fix":{"range":[15452,15621],"text":""},"messageId":"removeConsole","data":{"propertyName":"log"},"desc":"Remove the console.log()."}]},{"ruleId":"no-console","severity":1,"message":"Unexpected console statement. Only these console methods are allowed: warn, error.","line":499,"column":9,"nodeType":"MemberExpression","messageId":"limited","endLine":499,"endColumn":20,"suggestions":[{"fix":{"range":[15700,15746],"text":""},"messageId":"removeConsole","data":{"propertyName":"log"},"desc":"Remove the console.log()."}]},{"ruleId":"no-console","severity":1,"message":"Unexpected console statement. Only these console methods are allowed: warn, error.","line":502,"column":11,"nodeType":"MemberExpression","messageId":"limited","endLine":502,"endColumn":22,"suggestions":[{"fix":{"range":[15799,16047],"text":""},"messageId":"removeConsole","data":{"propertyName":"log"},"desc":"Remove the console.log()."}]},{"ruleId":"no-console","severity":1,"message":"Unexpected console statement. Only these console methods are allowed: warn, error.","line":524,"column":13,"nodeType":"MemberExpression","messageId":"limited","endLine":524,"endColumn":24,"suggestions":[{"fix":{"range":[16741,16841],"text":""},"messageId":"removeConsole","data":{"propertyName":"log"},"desc":"Remove the console.log()."}]},{"ruleId":"no-console","severity":1,"message":"Unexpected console statement. Only these console methods are allowed: warn, error.","line":530,"column":11,"nodeType":"MemberExpression","messageId":"limited","endLine":530,"endColumn":22,"suggestions":[{"fix":{"range":[17022,17079],"text":""},"messageId":"removeConsole","data":{"propertyName":"log"},"desc":"Remove the console.log()."}]},{"ruleId":"no-console","severity":1,"message":"Unexpected console statement. Only these console methods are allowed: warn, error.","line":584,"column":7,"nodeType":"MemberExpression","messageId":"limited","endLine":584,"endColumn":18,"suggestions":[{"fix":{"range":[18971,19051],"text":""},"messageId":"removeConsole","data":{"propertyName":"log"},"desc":"Remove the console.log()."}]},{"ruleId":"no-console","severity":1,"message":"Unexpected console statement. Only these console methods are allowed: warn, error.","line":588,"column":7,"nodeType":"MemberExpression","messageId":"limited","endLine":588,"endColumn":18,"suggestions":[{"fix":{"range":[19123,19189],"text":""},"messageId":"removeConsole","data":{"propertyName":"log"},"desc":"Remove the console.log()."}]},{"ruleId":"no-console","severity":1,"message":"Unexpected console statement. Only these console methods are allowed: warn, error.","line":651,"column":5,"nodeType":"MemberExpression","messageId":"limited","endLine":651,"endColumn":16,"suggestions":[{"fix":{"range":[21438,21480],"text":""},"messageId":"removeConsole","data":{"propertyName":"log"},"desc":"Remove the console.log()."}]},{"ruleId":"no-console","severity":1,"message":"Unexpected console statement. Only these console methods are allowed: warn, error.","line":653,"column":5,"nodeType":"MemberExpression","messageId":"limited","endLine":653,"endColumn":16,"suggestions":[{"fix":{"range":[21507,21736],"text":""},"messageId":"removeConsole","data":{"propertyName":"log"},"desc":"Remove the console.log()."}]},{"ruleId":"no-console","severity":1,"message":"Unexpected console statement. Only these console methods are allowed: warn, error.","line":671,"column":9,"nodeType":"MemberExpression","messageId":"limited","endLine":671,"endColumn":20,"suggestions":[{"fix":{"range":[22154,22238],"text":""},"messageId":"removeConsole","data":{"propertyName":"log"},"desc":"Remove the console.log()."}]},{"ruleId":"no-console","severity":1,"message":"Unexpected console statement. Only these console methods are allowed: warn, error.","line":789,"column":7,"nodeType":"MemberExpression","messageId":"limited","endLine":789,"endColumn":18,"suggestions":[{"fix":{"range":[27829,27997],"text":""},"messageId":"removeConsole","data":{"propertyName":"log"},"desc":"Remove the console.log()."}]}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":36,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import { useState, useEffect, useCallback } from \"react\";\nimport { useNavigate } from \"react-router-dom\";\nimport { useAuth } from \"../../hooks/useAuth\";\nimport { Button } from \"@/components/ui/button\";\nimport { Input } from \"@/components/ui/input\";\nimport { Label } from \"@/components/ui/label\";\nimport { Textarea } from \"@/components/ui/textarea\";\nimport { Badge } from \"@/components/ui/badge\";\nimport {\n  Table,\n  TableBody,\n  TableCell,\n  TableHead,\n  TableHeader,\n  TableRow,\n} from \"@/components/ui/table\";\nimport {\n  Card,\n  CardContent,\n  CardDescription,\n  CardHeader,\n  CardTitle,\n} from \"@/components/ui/card\";\nimport {\n  Dialog,\n  DialogContent,\n  DialogDescription,\n  DialogFooter,\n  DialogHeader,\n  DialogTitle,\n} from \"@/components/ui/dialog\";\nimport { toast } from \"@/hooks/use-toast\";\nimport { useConfirmationDialog } from \"@/components/ui/confirmation-dialog\";\nimport { User, PuntoAtencion, CuadreCaja } from \"../../types\";\n// import ExternalServicesClose from \"./ExternalServicesClose\"; // Ya no se requiere cierre separado\nimport { contabilidadDiariaService } from \"../../services/contabilidadDiariaService\";\nimport cuatreCajaService from \"@/services/cuatreCajaService\";\n\ntype JsonRecord = Record<string, unknown>;\n\nfunction isRecord(value: unknown): value is JsonRecord {\n  return typeof value === \"object\" && value !== null && !Array.isArray(value);\n}\n\nfunction getCantidad(val: unknown): number {\n  if (typeof val === \"number\") return val;\n  if (isRecord(val) && typeof val.cantidad === \"number\") return val.cantidad;\n  return 0;\n}\n\ninterface ResumenUsuarioRef {\n  nombre?: string;\n  username?: string;\n}\n\ninterface ResumenMonedaRef {\n  codigo?: string;\n  nombre?: string;\n}\n\ninterface ResumenSaldoPrincipal {\n  moneda_codigo: string;\n  moneda_nombre: string;\n  moneda_simbolo: string;\n  tuvo_movimientos: boolean;\n  saldo_final: number;\n}\n\ninterface ResumenServicioExternoSaldo {\n  moneda_codigo: string;\n  moneda_simbolo: string;\n  saldo: number;\n}\n\ninterface ResumenServicioExterno {\n  servicio_nombre: string;\n  servicio_tipo: string;\n  saldos: ResumenServicioExternoSaldo[];\n}\n\ninterface ResumenCambioDivisaTx {\n  id: string;\n  fecha: string;\n  numero_recibo?: string;\n  tipo_operacion?: string;\n  usuario?: ResumenUsuarioRef;\n  moneda_origen?: ResumenMonedaRef;\n  moneda_destino?: ResumenMonedaRef;\n  monto_origen?: number;\n  monto_destino?: number;\n  tasa_cambio_billetes?: number;\n  tasa_cambio_monedas?: number;\n}\n\ninterface ResumenServicioExternoTx {\n  id: string;\n  fecha: string;\n  servicio?: string;\n  tipo_movimiento?: string;\n  usuario?: ResumenUsuarioRef;\n  moneda?: string;\n  monto?: number;\n  numero_referencia?: string;\n}\n\ninterface ResumenBalancePorMonedaRow {\n  moneda?: ResumenMonedaRef;\n  ingresos?: number;\n  egresos?: number;\n  neto?: number;\n}\n\ninterface ResumenCierre {\n  fecha?: string;\n  punto_atencion_id?: string;\n  total_transacciones: number;\n  saldos_principales: ResumenSaldoPrincipal[];\n  servicios_externos: ResumenServicioExterno[];\n  transacciones?: {\n    cambios_divisas?: ResumenCambioDivisaTx[];\n    servicios_externos?: ResumenServicioExternoTx[];\n  };\n  balance?: {\n    cambios_divisas?: { por_moneda?: ResumenBalancePorMonedaRow[] };\n    servicios_externos?: { por_moneda?: ResumenBalancePorMonedaRow[] };\n  };\n}\n\ninterface DailyCloseProps {\n  user: User;\n  selectedPoint: PuntoAtencion | null;\n}\n\ninterface CuadreDetalle {\n  moneda_id: string;\n  codigo: string;\n  nombre: string;\n  simbolo: string;\n  saldo_apertura: number;\n  saldo_cierre: number;\n  bancos_teorico?: number;\n  conteo_bancos?: number;\n  conteo_fisico: number;\n  billetes: number;\n  monedas: number;\n  ingresos_periodo: number;\n  egresos_periodo: number;\n  movimientos_periodo: number;\n}\n\nconst DailyClose = ({ user, selectedPoint }: DailyCloseProps) => {\n  const navigate = useNavigate();\n  const { logout } = useAuth();\n  const [cuadreData, setCuadreData] = useState<{\n    detalles: CuadreDetalle[];\n    observaciones: string;\n    cuadre_id?: string;\n    periodo_inicio?: string;\n    totales?: {\n      cambios: number | { cantidad: number };\n      servicios_externos?: number | { cantidad: number };\n      transferencias_entrada: number | { cantidad: number };\n      transferencias_salida: number | { cantidad: number };\n    };\n  } | null>(null);\n  const [userAdjustments, setUserAdjustments] = useState<{\n    [key: string]: { bills: string; coins: string; banks: string; note?: string };\n  }>({});\n  const [todayClose, setTodayClose] = useState<CuadreCaja | null>(null);\n  const [hasActiveJornada, setHasActiveJornada] = useState<boolean | null>(\n    null\n  );\n  const [jornadaFinalizada, setJornadaFinalizada] = useState(false);\n  const [loading, setLoading] = useState(false); // carga de cuadre\n  const [closing, setClosing] = useState(false); // estado de cierre en progreso\n  const [fetchError, setFetchError] = useState<string | null>(null);\n  const { showConfirmation, ConfirmationDialog } = useConfirmationDialog();\n  const [showResumenModal, setShowResumenModal] = useState(false);\n  const [resumenCierre, setResumenCierre] = useState<ResumenCierre | null>(null);\n  const [loadingResumen, setLoadingResumen] = useState(false);\n  const [validacionCierres, setValidacionCierres] = useState<\n    | {\n        cierres_requeridos: {\n          servicios_externos: boolean;\n          cambios_divisas: boolean;\n          cierre_diario: boolean;\n        };\n        estado_cierres: {\n          servicios_externos: boolean;\n          cambios_divisas: boolean;\n          cierre_diario: boolean;\n        };\n        cierres_completos: boolean;\n        conteos?: {\n          cambios_divisas: number;\n          servicios_externos: number;\n        };\n      }\n    | null\n  >(null);\n\n  // Verificar jornada activa\n  useEffect(() => {\n    const checkActiveJornada = async (): Promise<void> => {\n      try {\n        const token = localStorage.getItem(\"authToken\");\n        console.log(\n          \"­ƒöì DailyClose - localStorage keys:\",\n          Object.keys(localStorage)\n        );\n        console.log(\"­ƒöì DailyClose - token check:\", {\n          tokenExists: !!token,\n          tokenPreview: token ? token.substring(0, 30) + \"...\" : \"No token\",\n          userInfo: { id: user.id, rol: user.rol, nombre: user.nombre },\n        });\n\n        if (!token) {\n          console.log(\"ÔØî No token found for jornada check\");\n          setHasActiveJornada(false);\n          return;\n        }\n\n        console.log(\"­ƒöì Checking active jornada for user:\", user.rol);\n        const response = await fetch(\n          `${import.meta.env.VITE_API_URL || \"http://35.238.95.118/api\"}/schedules/active`,\n          {\n            headers: {\n              Authorization: `Bearer ${token}`,\n              \"Content-Type\": \"application/json\",\n            },\n          }\n        );\n\n        console.log(\"­ƒòÆ Active jornada response status:\", response.status);\n\n        if (response.ok) {\n          const data = await response.json();\n          console.log(\"­ƒòÆ Active jornada response data:\", data);\n\n          // Verificar que tenga schedule y que est├® ACTIVO\n          const hasJornada =\n            data.success &&\n            data.schedule &&\n            (data.schedule.estado === \"ACTIVO\" ||\n              data.schedule.estado === \"ALMUERZO\");\n          console.log(\"­ƒòÆ Has active jornada:\", hasJornada);\n          setHasActiveJornada(hasJornada);\n        } else {\n              console.log(\"ÔØî No active jornada or error:\", response.status);\n          setHasActiveJornada(false);\n        }\n      } catch (error) {\n        console.error(\"­ƒÆÑ Error checking active jornada:\", error);\n        setHasActiveJornada(false);\n      }\n    };\n\n    if (user.rol === \"OPERADOR\") {\n      checkActiveJornada();\n      const interval = setInterval(checkActiveJornada, 30000);\n      return () => clearInterval(interval);\n    } else {\n      setHasActiveJornada(true);\n    }\n    // Ensure all code paths return void\n    return;\n  }, [user]);\n\n  // Obtener datos de cuadre autom├ítico\n  useEffect(() => {\n    const fetchCuadreData = async () => {\n      try {\n        setLoading(true);\n        console.log(\"­ƒöä Fetching automated cuadre data...\");\n        console.log(\"­ƒôì Selected point:\", selectedPoint?.id, selectedPoint?.nombre);\n        const token = localStorage.getItem(\"authToken\");\n        if (!token) {\n          console.error(\"ÔØî No token found in localStorage\");\n          toast({\n            title: \"Sesi├│n Expirada\",\n            description: \"Por favor, inicie sesi├│n nuevamente.\",\n            variant: \"destructive\",\n          });\n          return;\n        }\n\n        const apiUrl = import.meta.env.VITE_API_URL || \"http://35.238.95.118/api\";\n        const endpoint = `${apiUrl}/cuadre-caja`;\n        console.log(\"­ƒîÉ Calling endpoint:\", endpoint);\n\n        const response = await fetch(endpoint, {\n          headers: {\n            Authorization: `Bearer ${token}`,\n            \"Content-Type\": \"application/json\",\n          },\n        });\n\n        console.log(\"­ƒôí Response status:\", response.status);\n        console.log(\"­ƒôí Response headers:\", {\n          contentType: response.headers.get(\"content-type\"),\n          contentLength: response.headers.get(\"content-length\"),\n        });\n\n        if (response.ok) {\n          const data = await response.json();\n          console.log(\"­ƒôè Cuadre data received:\", data);\n\n          if (data.success && data.data) {\n            console.log(\"Ô£à Cuadre data details:\", {\n              detallesCount: data.data.detalles?.length || 0,\n              detalles: data.data.detalles,\n              mensaje: data.data.mensaje,\n              periodoInicio: data.data.periodo_inicio,\n            });\n\n            setCuadreData(data.data);\n\n            // Inicializar ajustes del usuario con valores esperados (saldo de cierre)\n            const initialAdjustments: {\n              [key: string]: { bills: string; coins: string; banks: string; note?: string };\n            } = {};\n            if (data.data.detalles && data.data.detalles.length > 0) {\n              data.data.detalles.forEach((detalle: CuadreDetalle) => {\n                // Inicializar con el saldo esperado dividido entre billetes y monedas\n                // Por defecto asumimos todo en billetes, pero el usuario puede ajustar\n                initialAdjustments[detalle.moneda_id] = {\n                  bills: detalle.saldo_cierre.toFixed(2),\n                  coins: \"0.00\",\n                  banks: Number(detalle.bancos_teorico ?? 0).toFixed(2),\n                  note: \"\",\n                };\n              });\n              console.log(\"­ƒÆ░ Initial adjustments set for\", Object.keys(initialAdjustments).length, \"currencies\");\n            }\n            setUserAdjustments(initialAdjustments);\n          } else if (data.data?.mensaje) {\n            // No hay movimientos hoy\n            console.log(\"ÔÜá´©Å No hay movimientos:\", data.data.mensaje);\n            setCuadreData({ detalles: [], observaciones: \"\" });\n            setUserAdjustments({});\n          }\n        } else {\n          const errorText = await response.text();\n          console.error(\n            \"ÔØî Error response from cuadre API:\",\n            response.status,\n            response.statusText,\n            errorText\n          );\n          throw new Error(`Error al obtener datos de cuadre: ${response.status}`);\n        }\n      } catch (error) {\n        console.error(\"ÔØî Error al obtener datos de cuadre:\", error);\n        toast({\n          title: \"Error\",\n          description: error instanceof Error ? error.message : \"No se pudo cargar los datos de cuadre autom├ítico.\",\n          variant: \"destructive\",\n        });\n      } finally {\n        setLoading(false);\n      }\n    };\n\n    if (selectedPoint) {\n      console.log(\"­ƒöä useEffect triggered: selectedPoint changed\", selectedPoint?.id);\n      fetchCuadreData();\n      setTodayClose(null);\n    } else {\n      console.log(\"ÔÜá´©Å selectedPoint is null, skipping fetchCuadreData\");\n    }\n  }, [selectedPoint]);\n\n  const handleUserAdjustment = (\n    monedaId: string,\n    type: \"bills\" | \"coins\" | \"banks\" | \"note\",\n    value: string\n  ) => {\n    if (type === \"note\") {\n      setUserAdjustments((prev) => ({\n        ...prev,\n        [monedaId]: {\n          ...prev[monedaId],\n          note: value,\n        },\n      }));\n      return;\n    }\n\n    // No permitir valores negativos\n    const numValue = parseFloat(value);\n    if (numValue < 0) return;\n\n    setUserAdjustments((prev) => ({\n      ...prev,\n      [monedaId]: {\n        ...prev[monedaId],\n        [type]: value,\n      },\n    }));\n  };\n\n  const calculateUserTotal = (monedaId: string) => {\n    const bills = parseFloat(userAdjustments[monedaId]?.bills || \"0\");\n    const coins = parseFloat(userAdjustments[monedaId]?.coins || \"0\");\n    return bills + coins;\n  };\n\n  const calculateUserBanks = (monedaId: string) => {\n    const banks = parseFloat(userAdjustments[monedaId]?.banks || \"0\");\n    return banks;\n  };\n\n  // Permitir hasta ┬▒1.00 USD de ajuste; otras divisas deben cuadrar (┬▒0.01)\n  const getTolerance = (detalle: CuadreDetalle) =>\n    detalle.codigo === \"USD\" ? 1.0 : 0.01;\n\n  const validateBalance = (detalle: CuadreDetalle, userTotal: number) => {\n    const difference = Math.abs(userTotal - detalle.saldo_cierre);\n    const tolerance = getTolerance(detalle);\n    const okFisico = difference <= tolerance;\n\n    const esperadoBancos = Number(detalle.bancos_teorico ?? 0);\n    const userBancos = calculateUserBanks(detalle.moneda_id);\n    const diffBancos = Math.abs(userBancos - esperadoBancos);\n    const okBancos = diffBancos <= tolerance;\n\n    return okFisico && okBancos;\n  };\n\n  // Validar cierres requeridos\n  const validarCierresRequeridos = async () => {\n    if (!selectedPoint) return;\n\n    try {\n      const fechaHoy = new Date().toISOString().split(\"T\")[0]; // YYYY-MM-DD\n      const validacion =\n        await contabilidadDiariaService.validarCierresRequeridos(\n          selectedPoint.id,\n          fechaHoy\n        );\n\n      if (validacion.success) {\n        setValidacionCierres(validacion);\n      } else {\n        console.error(\"Error validando cierres:\", validacion.error);\n      }\n    } catch (error) {\n      console.error(\"Error validando cierres:\", error);\n    }\n  };\n\n  // Cargar validaci├│n de cierres cuando cambie el punto seleccionado\n  useEffect(() => {\n    if (selectedPoint) {\n      validarCierresRequeridos();\n    }\n  }, [selectedPoint]);\n\n  // Obtener datos de cuadre autom├ítico (reusable + retry)\n  const fetchCuadreData = useCallback(async () => {\n    try {\n      setLoading(true);\n      setFetchError(null);\n      console.log(\"­ƒöä Fetching automated cuadre data...\");\n      console.log(\"­ƒôì Selected point:\", selectedPoint?.id, selectedPoint?.nombre);\n\n      const token = localStorage.getItem(\"authToken\");\n      if (!token) {\n        console.error(\"ÔØî No token found in localStorage\");\n        const msg = \"Por favor, inicie sesi├│n nuevamente.\";\n        toast({\n          title: \"Sesi├│n Expirada\",\n          description: msg,\n          variant: \"destructive\",\n        });\n        setFetchError(msg);\n        return;\n      }\n\n      const apiUrl = import.meta.env.VITE_API_URL || \"http://35.238.95.118/api\";\n      const endpoint = `${apiUrl}/cuadre-caja`;\n      console.log(\"­ƒîÉ Calling endpoint:\", endpoint);\n\n      const response = await fetch(endpoint, {\n        headers: {\n          Authorization: `Bearer ${token}`,\n          \"Content-Type\": \"application/json\",\n        },\n      });\n\n      console.log(\"­ƒôí Response status:\", response.status);\n      console.log(\"­ƒôí Response headers:\", {\n        contentType: response.headers.get(\"content-type\"),\n        contentLength: response.headers.get(\"content-length\"),\n      });\n\n      if (response.ok) {\n        const data = await response.json();\n        console.log(\"­ƒôè Cuadre data received:\", data);\n\n        if (data.success && data.data) {\n          console.log(\"Ô£à Cuadre data details:\", {\n            detallesCount: data.data.detalles?.length || 0,\n            detalles: data.data.detalles,\n            mensaje: data.data.mensaje,\n            periodoInicio: data.data.periodo_inicio,\n          });\n\n          setCuadreData(data.data);\n\n          // Inicializar ajustes del usuario con valores esperados (saldo de cierre)\n          const initialAdjustments: {\n            [key: string]: { bills: string; coins: string; banks: string; note?: string };\n          } = {};\n          if (data.data.detalles && data.data.detalles.length > 0) {\n            data.data.detalles.forEach((detalle: CuadreDetalle) => {\n              initialAdjustments[detalle.moneda_id] = {\n                bills: detalle.saldo_cierre.toFixed(2),\n                coins: \"0.00\",\n                banks: Number(detalle.bancos_teorico ?? 0).toFixed(2),\n                note: \"\",\n              };\n            });\n            console.log(\"­ƒÆ░ Initial adjustments set for\", Object.keys(initialAdjustments).length, \"currencies\");\n          }\n          setUserAdjustments(initialAdjustments);\n          setFetchError(null);\n        } else if (data.data?.mensaje) {\n          // No hay movimientos hoy\n          console.log(\"ÔÜá´©Å No hay movimientos:\", data.data.mensaje);\n          setCuadreData({ detalles: [], observaciones: \"\" });\n          setUserAdjustments({});\n          setFetchError(null);\n        }\n      } else {\n        const errorText = await response.text();\n        console.error(\n          \"ÔØî Error response from cuadre API:\",\n          response.status,\n          response.statusText,\n          errorText\n        );\n        throw new Error(`Error al obtener datos de cuadre: ${response.status}`);\n      }\n    } catch (error) {\n      console.error(\"ÔØî Error al obtener datos de cuadre:\", error);\n      const msg = error instanceof Error ? error.message : \"No se pudo cargar los datos de cuadre autom├ítico.\";\n      setFetchError(msg);\n\n      // Fallback: si el backend de cuadre falla, intentar detectar \"sin movimientos\"\n      try {\n        if (selectedPoint) {\n          const fechaHoy = new Date().toISOString().split(\"T\")[0];\n          const valid = await contabilidadDiariaService.validarCierresRequeridos(\n            selectedPoint.id,\n            fechaHoy\n          );\n          if (\n            valid?.success &&\n            typeof valid.conteos?.cambios_divisas === \"number\" &&\n            valid.conteos.cambios_divisas === 0\n          ) {\n            // Proceder como \"sin movimientos de divisas\": permitir cierre\n            setCuadreData({ detalles: [], observaciones: \"\" });\n            setUserAdjustments({});\n            setFetchError(null);\n            toast({\n              title: \"Sin movimientos de divisas\",\n              description:\n                \"No se pudo obtener el cuadre autom├ítico, pero se detecta 0 cambios. Puede realizar el cierre diario sin conteo.\",\n            });\n          }\n        }\n      } catch (fbErr) {\n        console.warn(\"Fallback sin movimientos no disponible:\", fbErr);\n      }\n    } finally {\n      setLoading(false);\n    }\n  }, [selectedPoint]);\n\n  useEffect(() => {\n    if (selectedPoint) {\n      console.log(\"­ƒöä useEffect triggered: selectedPoint changed\", selectedPoint?.id);\n      fetchCuadreData();\n      setTodayClose(null);\n    } else {\n      console.log(\"ÔÜá´©Å selectedPoint is null, skipping fetchCuadreData\");\n    }\n  }, [selectedPoint, fetchCuadreData]);\n\n  // Construir y mostrar tarjeta de \"Cierre Completado\" a partir del cuadre/totales\n  const fetchTodayClose = useCallback(async () => {\n    try {\n      const fechaHoy = new Date().toISOString().split(\"T\")[0];\n      const resp = await cuatreCajaService.getCuadre({ fecha: fechaHoy });\n      if (resp?.success && resp.data) {\n        const tot = isRecord(resp.data.totales) ? resp.data.totales : {};\n        const observaciones =\n          typeof resp.data.observaciones === \"string\" ? resp.data.observaciones : null;\n        const cierre: CuadreCaja = {\n          id: resp.data.cuadre_id || \"cuadre-hoy\",\n          usuario_id: user.id,\n          punto_atencion_id: selectedPoint?.id || \"\",\n          fecha: fechaHoy,\n          estado: \"CERRADO\",\n          total_cambios: (tot.cambios as CuadreCaja[\"total_cambios\"]) ?? 0,\n          total_transferencias_entrada:\n            (tot.transferencias_entrada as CuadreCaja[\"total_transferencias_entrada\"]) ?? 0,\n          total_transferencias_salida:\n            (tot.transferencias_salida as CuadreCaja[\"total_transferencias_salida\"]) ?? 0,\n          fecha_cierre: new Date().toISOString(),\n          observaciones,\n        };\n        setTodayClose(cierre);\n      } else {\n        setTodayClose(null);\n      }\n    } catch (e) {\n      console.warn(\"No se pudo obtener cierre de hoy:\", e);\n      setTodayClose(null);\n    }\n  }, [selectedPoint?.id, user.id]);\n\n  // Si ya existe un cierre para hoy, mostrar tarjeta de \"Cierre Completado\"\n  useEffect(() => {\n    const checkTodayClose = async () => {\n      if (!selectedPoint) return;\n      try {\n        const fechaHoy = new Date().toISOString().split(\"T\")[0];\n        const res = await contabilidadDiariaService.getCierreDiario(\n          selectedPoint.id,\n          fechaHoy\n        );\n        if (res.success && res.cierre) {\n          await fetchTodayClose();\n        } else {\n          setTodayClose(null);\n        }\n      } catch (e) {\n        // Si falla, no bloquear la vista principal\n        console.warn(\"Error verificando cierre del d├¡a:\", e);\n        setTodayClose(null);\n      }\n    };\n\n    checkTodayClose();\n  }, [selectedPoint, fetchTodayClose]);\n\n  const performDailyClose = async () => {\n    console.log(\"­ƒöä performDailyClose START\");\n    setClosing(true);\n    console.log(\"­ƒôï State check:\", {\n      selectedPoint: selectedPoint?.id,\n      cuadreData: !!cuadreData,\n      detalles: cuadreData?.detalles?.length || 0,\n      userAdjustments: Object.keys(userAdjustments || {}).length,\n    });\n\n    if (!selectedPoint) {\n      console.error(\"ÔØî Missing selectedPoint for closing\");\n      toast({ title: \"Error\", description: \"Debe seleccionar un punto de atenci├│n\", variant: \"destructive\" });\n      setClosing(false);\n      return;\n    }\n\n    try {\n      // 1. Validar saldos solo si hay detalles de divisas\n      const tieneDetalles = (cuadreData?.detalles?.length ?? 0) > 0;\n      if (tieneDetalles) {\n        console.log(\"­ƒöì Validating balances for\", cuadreData.detalles.length, \"currencies\");\n        const incompleteBalances = cuadreData.detalles.some(\n          (detalle) =>\n            userAdjustments[detalle.moneda_id]?.bills === undefined ||\n            userAdjustments[detalle.moneda_id]?.bills === \"\" ||\n            userAdjustments[detalle.moneda_id]?.coins === undefined ||\n            userAdjustments[detalle.moneda_id]?.coins === \"\" ||\n            userAdjustments[detalle.moneda_id]?.banks === undefined ||\n            userAdjustments[detalle.moneda_id]?.banks === \"\"\n        );\n        if (incompleteBalances) {\n          console.error(\"ÔØî Incomplete balances found\");\n          toast({\n            title: \"Error\",\n            description: \"Debe completar todos los saldos antes del cierre\",\n            variant: \"destructive\",\n          });\n          setClosing(false);\n          return;\n        }\n\n        // Validaci├│n estricta con tolerancia\n        const invalidBalances = cuadreData.detalles.filter((detalle) => {\n          const bills = parseFloat(userAdjustments[detalle.moneda_id]?.bills || \"0\");\n          const coins = parseFloat(userAdjustments[detalle.moneda_id]?.coins || \"0\");\n          const total = bills + coins;\n          const diff = Math.abs(total - detalle.saldo_cierre);\n          const tol = detalle.codigo === \"USD\" ? 1.0 : 0.01;\n          const banks = parseFloat(userAdjustments[detalle.moneda_id]?.banks || \"0\");\n          const banksExpected = Number(detalle.bancos_teorico ?? 0);\n          const diffBanks = Math.abs(banks - banksExpected);\n          return diff > tol || diffBanks > tol;\n        });\n        if (invalidBalances.length > 0) {\n          const msg = `Los siguientes saldos no cuadran con los movimientos del d├¡a:\\n\\n${invalidBalances\n            .map((d) => {\n              const bills = parseFloat(userAdjustments[d.moneda_id]?.bills || \"0\");\n              const coins = parseFloat(userAdjustments[d.moneda_id]?.coins || \"0\");\n              const total = bills + coins;\n              const banks = parseFloat(userAdjustments[d.moneda_id]?.banks || \"0\");\n              const banksExpected = Number(d.bancos_teorico ?? 0);\n              const tolerance = (d.codigo === \"USD\" ? 1.0 : 0.01).toFixed(2);\n              return `${d.codigo}: F├¡sico esperado ${d.saldo_cierre.toFixed(2)}, f├¡sico ingresado ${total.toFixed(2)}; Bancos esperado ${banksExpected.toFixed(2)}, bancos ingresado ${banks.toFixed(2)} (tolerancia ┬▒${tolerance})`;\n            })\n            .join(\"\\n\")}\\n\\nÔÜá´©Å Revise el Resumen de Cierre para ver el listado de transacciones del d├¡a (cambios y servicios externos) y validar qu├® ocurri├│.`;\n          toast({ title: \"No cuadra\", description: msg, variant: \"destructive\" });\n          setClosing(false);\n          return;\n        }\n      }\n\n      // 2. Preparar detalles para enviar\n      const detalles = (cuadreData?.detalles || []).map((detalle) => {\n        const bills = parseFloat(userAdjustments[detalle.moneda_id]?.bills || \"0\");\n        const coins = parseFloat(userAdjustments[detalle.moneda_id]?.coins || \"0\");\n        const banks = parseFloat(userAdjustments[detalle.moneda_id]?.banks || \"0\");\n        const conteo = bills + coins;\n        return {\n          moneda_id: detalle.moneda_id,\n          saldo_apertura: detalle.saldo_apertura,\n          saldo_cierre: detalle.saldo_cierre,\n          conteo_fisico: conteo,\n          bancos_teorico: Number(detalle.bancos_teorico ?? 0),\n          conteo_bancos: banks,\n          billetes: bills,\n          monedas: coins,\n          ingresos_periodo: detalle.ingresos_periodo || 0,\n          egresos_periodo: detalle.egresos_periodo || 0,\n          movimientos_periodo: detalle.movimientos_periodo || 0,\n          observaciones_detalle: userAdjustments[detalle.moneda_id]?.note || \"\",\n        };\n      });\n\n      // 3. Ejecutar cierre\n      const token = localStorage.getItem(\"authToken\");\n      const fechaHoy = new Date().toISOString().split(\"T\")[0];\n      const apiUrl = import.meta.env.VITE_API_URL || \"http://35.238.95.118/api\";\n      const endpoint = `${apiUrl}/contabilidad-diaria/${selectedPoint.id}/${fechaHoy}/cerrar`;\n\n      const controller = new AbortController();\n      const timeoutId = setTimeout(() => controller.abort(), 60000);\n      let resultado: unknown;\n      try {\n        const response = await fetch(endpoint, {\n          method: \"POST\",\n          headers: {\n            \"Content-Type\": \"application/json\",\n            Authorization: `Bearer ${token}`,\n          },\n          body: JSON.stringify({ detalles, observaciones: cuadreData?.observaciones || \"\" }),\n          signal: controller.signal,\n        });\n        clearTimeout(timeoutId);\n        resultado = await response.json();\n        const resultRecord = isRecord(resultado) ? resultado : {};\n        if (!response.ok || resultRecord.success !== true) {\n          const errorText =\n            typeof resultRecord.error === \"string\"\n              ? resultRecord.error\n              : \"Error al realizar el cierre diario\";\n          throw new Error(errorText);\n        }\n      } catch (err) {\n        clearTimeout(timeoutId);\n        throw err;\n      }\n\n      const resultRecord = isRecord(resultado) ? resultado : {};\n      const cierreId =\n        typeof resultRecord.cierre_id === \"string\"\n          ? resultRecord.cierre_id\n          : isRecord(resultRecord.cierre) && typeof resultRecord.cierre.id === \"string\"\n            ? resultRecord.cierre.id\n            : undefined;\n      const cuadreId =\n        typeof resultRecord.cuadre_id === \"string\" ? resultRecord.cuadre_id : undefined;\n      const jornadaFinalizadaResp = resultRecord.jornada_finalizada === true;\n\n      console.log(\"Ô£à Cierre completado exitosamente\", {\n        cierre_id: cierreId,\n        cuadre_id: cuadreId,\n        jornada_finalizada: jornadaFinalizadaResp,\n      });\n      const mensaje = jornadaFinalizadaResp\n        ? \"Ô£à El cierre diario se ha completado correctamente y su jornada fue finalizada autom├íticamente.\"\n        : \"Ô£à El cierre diario se ha completado correctamente.\";\n      toast({ title: \"Cierre realizado\", description: mensaje });\n      // Marcar flags locales\n      if (jornadaFinalizadaResp) {\n        setJornadaFinalizada(true);\n        setHasActiveJornada(false);\n      }\n      // Requerimiento: tras cerrar, cerrar sesi├│n y salir a Login\n      // Evita llamadas posteriores (como GET /cuadre-caja?fecha) en esta vista\n      handleLogout();\n      return;\n    } catch (error) {\n      console.error(\"­ƒÆÑ Error en performDailyClose:\", error);\n      const errorMessage = error instanceof Error ? error.message : \"Error inesperado\";\n      toast({ title: \"Error\", description: errorMessage, variant: \"destructive\" });\n    } finally {\n      setLoading(false);\n      setClosing(false);\n    }\n  };\n\n  // Confirmaci├│n antes de cerrar - primero muestra resumen\n  const confirmDailyClose = async () => {\n    if (!selectedPoint) return;\n\n    setLoadingResumen(true);\n    try {\n      const fechaHoy = new Date().toISOString().split(\"T\")[0];\n      const resultado = await contabilidadDiariaService.getResumenCierre(\n        selectedPoint.id,\n        fechaHoy\n      );\n\n      if (resultado.success && resultado.resumen) {\n        setResumenCierre(resultado.resumen as ResumenCierre);\n        setShowResumenModal(true);\n      } else {\n        toast({\n          title: \"Error\",\n          description: resultado.error || \"No se pudo obtener el resumen de cierre\",\n          variant: \"destructive\",\n        });\n      }\n    } catch (error) {\n      console.error(\"Error obteniendo resumen:\", error);\n      toast({\n        title: \"Error\",\n        description: \"Error al obtener resumen de saldos\",\n        variant: \"destructive\",\n      });\n    } finally {\n      setLoadingResumen(false);\n    }\n  };\n\n  // Proceder con el cierre despu├®s de confirmar resumen\n  const proceedWithClose = () => {\n    setShowResumenModal(false);\n    performDailyClose();\n  };\n\n  const fmt2 = (n: unknown) => Number(n ?? 0).toFixed(2);\n\n  const printBalance = () => {\n    if (!resumenCierre) return;\n\n    const cambios = resumenCierre?.transacciones?.cambios_divisas || [];\n    const servicios = resumenCierre?.transacciones?.servicios_externos || [];\n    const balanceCambios = resumenCierre.balance?.cambios_divisas?.por_moneda || [];\n    const balanceServicios = resumenCierre.balance?.servicios_externos?.por_moneda || [];\n\n    const fmt = (n: unknown) => Number(n ?? 0).toFixed(2);\n    const fmtRate = (n: unknown) => Number(n ?? 0).toFixed(3);\n    const safe = (s: unknown) => (s == null ? \"\" : String(s));\n\n    const rowsCambios = cambios\n      .map((c) => {\n        const fecha = new Date(c.fecha);\n        const hora = isNaN(fecha.getTime()) ? safe(c.fecha) : fecha.toLocaleTimeString();\n        const mo = c.moneda_origen;\n        const md = c.moneda_destino;\n        const tasa =\n          (Number(c.tasa_cambio_billetes || 0) > 0\n            ? `B ${fmtRate(c.tasa_cambio_billetes)}`\n            : \"\") +\n          (Number(c.tasa_cambio_monedas || 0) > 0\n            ? `${Number(c.tasa_cambio_billetes || 0) > 0 ? \" | \" : \"\"}M ${fmtRate(\n                c.tasa_cambio_monedas\n              )}`\n            : \"\");\n\n        return `\n          <tr>\n            <td>${hora}</td>\n            <td>${safe(c.numero_recibo) || \"ÔÇö\"}</td>\n            <td>${safe(c.tipo_operacion)}</td>\n            <td>${safe(c.usuario?.nombre || c.usuario?.username) || \"ÔÇö\"}</td>\n            <td>${safe(mo?.codigo) || \"ÔÇö\"} ${safe(mo?.nombre) ? `(${safe(mo.nombre)})` : \"\"}</td>\n            <td>${fmt(c.monto_origen)}</td>\n            <td>${safe(md?.codigo) || \"ÔÇö\"} ${safe(md?.nombre) ? `(${safe(md.nombre)})` : \"\"}</td>\n            <td>${fmt(c.monto_destino)}</td>\n            <td>${tasa || \"ÔÇö\"}</td>\n          </tr>`;\n      })\n      .join(\"\");\n\n    const rowsServicios = servicios\n      .map((m) => {\n        const fecha = new Date(m.fecha);\n        const hora = isNaN(fecha.getTime()) ? safe(m.fecha) : fecha.toLocaleTimeString();\n        return `\n          <tr>\n            <td>${hora}</td>\n            <td>${safe(m.servicio)}</td>\n            <td>${safe(m.tipo_movimiento)}</td>\n            <td>${safe(m.usuario?.nombre || m.usuario?.username) || \"ÔÇö\"}</td>\n            <td>${safe(m.moneda) || \"ÔÇö\"}</td>\n            <td>${fmt(m.monto)}</td>\n            <td>${safe(m.numero_referencia) || \"ÔÇö\"}</td>\n          </tr>`;\n      })\n      .join(\"\");\n\n    const rowsBalanceCambios = balanceCambios\n      .map((r) => {\n        return `\n          <tr>\n            <td>${safe(r.moneda?.codigo) || \"ÔÇö\"}</td>\n            <td>${safe(r.moneda?.nombre) || \"\"}</td>\n            <td>${fmt(r.ingresos)}</td>\n            <td>${fmt(r.egresos)}</td>\n            <td>${fmt(r.neto)}</td>\n          </tr>`;\n      })\n      .join(\"\");\n\n    const rowsBalanceServicios = balanceServicios\n      .map((r) => {\n        return `\n          <tr>\n            <td>${safe(r.moneda?.codigo) || \"ÔÇö\"}</td>\n            <td>${safe(r.moneda?.nombre) || \"\"}</td>\n            <td>${fmt(r.ingresos)}</td>\n            <td>${fmt(r.egresos)}</td>\n            <td>${fmt(r.neto)}</td>\n          </tr>`;\n      })\n      .join(\"\");\n\n    const html = `\n      <html>\n        <head>\n          <title>Balance diario</title>\n          <style>\n            body{font-family: Arial, sans-serif; padding: 24px; color:#111}\n            h1,h2{margin:0 0 8px 0}\n            .muted{color:#555; font-size:12px}\n            .grid{display:grid; grid-template-columns: 1fr 1fr; gap:16px; margin-top:16px}\n            .card{border:1px solid #ddd; border-radius:8px; padding:12px}\n            table{width:100%; border-collapse:collapse; margin-top:8px}\n            th,td{border:1px solid #ddd; padding:6px; font-size:12px; text-align:left}\n            th{background:#f5f5f5}\n            .section{margin-top:18px}\n            @media print{ .no-print{display:none} }\n          </style>\n        </head>\n        <body>\n          <div class=\"no-print\" style=\"margin-bottom:12px\">\n            <button onclick=\"window.print()\">Imprimir</button>\n          </div>\n\n          <h1>Balance diario</h1>\n          <div class=\"muted\">Fecha: ${safe(resumenCierre.fecha)} | Punto: ${safe(resumenCierre.punto_atencion_id)}</div>\n\n          <div class=\"grid\">\n            <div class=\"card\">\n              <h2>Cambios de divisas</h2>\n              <div class=\"muted\">Cantidad: ${cambios.length}</div>\n            </div>\n            <div class=\"card\">\n              <h2>Servicios externos</h2>\n              <div class=\"muted\">Cantidad: ${servicios.length}</div>\n            </div>\n          </div>\n\n          <div class=\"section\">\n            <h2>Balance por moneda (Cambios)</h2>\n            <table>\n              <thead>\n                <tr>\n                  <th>Moneda</th>\n                  <th>Nombre</th>\n                  <th>Ingresos</th>\n                  <th>Egresos</th>\n                  <th>Neto</th>\n                </tr>\n              </thead>\n              <tbody>\n                ${rowsBalanceCambios || \"<tr><td colspan='5'>Sin datos</td></tr>\"}\n              </tbody>\n            </table>\n          </div>\n\n          <div class=\"section\">\n            <h2>Balance por moneda (Servicios externos)</h2>\n            <table>\n              <thead>\n                <tr>\n                  <th>Moneda</th>\n                  <th>Nombre</th>\n                  <th>Ingresos</th>\n                  <th>Egresos</th>\n                  <th>Neto</th>\n                </tr>\n              </thead>\n              <tbody>\n                ${rowsBalanceServicios || \"<tr><td colspan='5'>Sin datos</td></tr>\"}\n              </tbody>\n            </table>\n          </div>\n\n          <div class=\"section\">\n            <h2>Cambios (cliente entrega / cliente recibe)</h2>\n            <table>\n              <thead>\n                <tr>\n                  <th>Hora</th>\n                  <th>Recibo</th>\n                  <th>Operaci├│n</th>\n                  <th>Operador</th>\n                  <th>Moneda entrega</th>\n                  <th>Monto entrega</th>\n                  <th>Moneda recibe</th>\n                  <th>Monto recibe</th>\n                  <th>Tasa</th>\n                </tr>\n              </thead>\n              <tbody>\n                ${rowsCambios || \"<tr><td colspan='9'>Sin cambios</td></tr>\"}\n              </tbody>\n            </table>\n          </div>\n\n          <div class=\"section\">\n            <h2>Servicios externos</h2>\n            <table>\n              <thead>\n                <tr>\n                  <th>Hora</th>\n                  <th>Servicio</th>\n                  <th>Tipo</th>\n                  <th>Operador</th>\n                  <th>Moneda</th>\n                  <th>Monto</th>\n                  <th>Ref</th>\n                </tr>\n              </thead>\n              <tbody>\n                ${rowsServicios || \"<tr><td colspan='7'>Sin movimientos</td></tr>\"}\n              </tbody>\n            </table>\n          </div>\n\n          <div class=\"section muted\">\n            Generado desde el m├│dulo de cierre diario.\n          </div>\n        </body>\n      </html>\n    `;\n\n    const win = window.open(\"\", \"_blank\", \"noopener,noreferrer\");\n    if (!win) {\n      toast({\n        title: \"No se pudo abrir impresi├│n\",\n        description: \"Verifique si el navegador bloque├│ la ventana emergente.\",\n        variant: \"destructive\",\n      });\n      return;\n    }\n    win.document.open();\n    win.document.write(html);\n    win.document.close();\n    try {\n      win.focus();\n    } catch {\n      // noop: some browsers disallow focus\n    }\n  };\n\n  const generateCloseReport = () => {\n    if (!todayClose) return;\n\n    toast({\n      title: \"Reporte generado\",\n      description: \"El reporte de cierre diario se ha generado\",\n    });\n  };\n\n  const handleLogout = () => {\n    // Limpiar datos de autenticaci├│n\n    localStorage.removeItem(\"authToken\");\n    localStorage.removeItem(\"user\");\n    // Limpiar selecci├│n y vista activa para forzar selecci├│n de punto al reingresar\n    localStorage.removeItem(\"puntoAtencionSeleccionado\");\n    localStorage.removeItem(\"pc_selected_point_id\");\n    localStorage.removeItem(\"pc_active_view\");\n    // Forzar selecci├│n de punto en el pr├│ximo login (solo efecto inmediato)\n    try {\n      sessionStorage.setItem(\"pc_force_point_select\", \"1\");\n    } catch {\n      // noop: sessionStorage may be unavailable\n    }\n    \n    toast({\n      title: \"Sesi├│n cerrada\",\n      description: \"Ha cerrado sesi├│n exitosamente\",\n    });\n\n    // Redirigir al login\n    try {\n      logout();\n    } catch {\n      // noop: logout errors are non-fatal here\n    }\n    navigate(\"/login\", { replace: true });\n  };\n\n  if (!selectedPoint) {\n    return (\n      <div className=\"p-6\">\n        <div className=\"text-center py-12\">\n          <p className=\"text-gray-500 text-lg\">\n            Debe seleccionar un punto de atenci├│n para realizar el cierre\n          </p>\n        </div>\n      </div>\n    );\n  }\n\n  if (user.rol !== \"OPERADOR\") {\n    return (\n      <div className=\"p-6\">\n        <div className=\"text-center py-12\">\n          <p className=\"text-red-500 text-lg\">\n            Solo operadores pueden realizar cierres diarios\n          </p>\n        </div>\n      </div>\n    );\n  }\n\n  if (hasActiveJornada === false) {\n    return (\n      <div className=\"p-6\">\n        <div className=\"text-center py-12\">\n          <p className=\"text-red-500 text-lg\">\n            Debe tener una jornada activa para realizar el cierre diario\n          </p>\n          <p className=\"text-gray-500 text-sm mt-2\">\n            Inicie su jornada desde \"Gesti├│n de Horarios\" para continuar\n          </p>\n        </div>\n      </div>\n    );\n  }\n\n  if (hasActiveJornada === null) {\n    return (\n      <div className=\"p-6\">\n        <div className=\"text-center py-12\">\n          <div className=\"animate-spin rounded-full h-8 w-8 border-b-2 border-blue-600 mx-auto mb-4\"></div>\n          <p className=\"text-gray-600\">Verificando jornada activa...</p>\n        </div>\n      </div>\n    );\n  }\n\n  return (\n    <div className=\"p-6 space-y-6\">\n      <div className=\"flex items-center justify-between\">\n        <h1 className=\"text-2xl font-bold text-gray-800\">Cierre Diario</h1>\n        <div className=\"flex items-center gap-3\">\n          <div className=\"text-sm text-gray-500\">\n            Punto: {selectedPoint.nombre} - {new Date().toLocaleDateString()}\n          </div>\n          <Button\n            variant=\"outline\"\n            className=\"border-gray-300\"\n            onClick={fetchCuadreData}\n            disabled={loading}\n            title=\"Actualizar datos de cuadre\"\n          >\n            Actualizar\n          </Button>\n        </div>\n      </div>\n\n      {/* NOTA: El cierre de servicios externos ya NO es necesario como paso separado.\n          Los movimientos de servicios externos se incluyen autom├íticamente en el cierre diario. */}\n\n      {loading ? (\n        <Card>\n          <CardContent className=\"py-12\">\n            <div className=\"text-center\">\n              <div className=\"animate-spin rounded-full h-8 w-8 border-b-2 border-blue-600 mx-auto mb-4\"></div>\n              <p className=\"text-gray-600\">\n                Cargando datos de cuadre autom├ítico...\n              </p>\n            </div>\n          </CardContent>\n        </Card>\n      ) : !todayClose ? (\n        <Card>\n          <CardHeader>\n            <CardTitle>Cuadre de Caja Autom├ítico</CardTitle>\n            <CardDescription>\n              {(cuadreData?.detalles?.length ?? 0) === 0\n                ? \"No se han registrado movimientos de divisas hoy\"\n                : \"Revise y ajuste los conteos f├¡sicos. Los valores est├ín pre-calculados seg├║n los movimientos del d├¡a.\"}\n            </CardDescription>\n          </CardHeader>\n          <CardContent>\n            {fetchError && (\n              <div className=\"mb-4 p-4 rounded-md border border-red-200 bg-red-50 text-red-700 flex items-center justify-between gap-3\">\n                <span className=\"text-sm\">\n                  Ocurri├│ un problema al cargar el cuadre: {fetchError}\n                </span>\n                <Button onClick={fetchCuadreData} variant=\"destructive\">\n                  Reintentar\n                </Button>\n              </div>\n            )}\n            {/* Mostrar totales del d├¡a */}\n            {cuadreData?.totales && (\n              <div className=\"grid grid-cols-1 md:grid-cols-4 gap-4 mb-6 p-4 bg-gray-50 rounded-lg\">\n                <div className=\"text-center\">\n                  <h4 className=\"font-semibold text-blue-700\">Total Cambios</h4>\n                  <p className=\"text-2xl font-bold text-blue-600\">\n                    {getCantidad(cuadreData.totales.cambios)}\n                  </p>\n                </div>\n                <div className=\"text-center\">\n                  <h4 className=\"font-semibold text-purple-700\">\n                    Servicios Externos\n                  </h4>\n                  <p className=\"text-2xl font-bold text-purple-600\">\n                    {getCantidad(cuadreData.totales.servicios_externos)}\n                  </p>\n                </div>\n                <div className=\"text-center\">\n                  <h4 className=\"font-semibold text-green-700\">\n                    Transferencias Entrada\n                  </h4>\n                  <p className=\"text-2xl font-bold text-green-600\">\n                    {getCantidad(cuadreData.totales.transferencias_entrada)}\n                  </p>\n                </div>\n                <div className=\"text-center\">\n                  <h4 className=\"font-semibold text-orange-700\">\n                    Transferencias Salida\n                  </h4>\n                  <p className=\"text-2xl font-bold text-orange-600\">\n                    {getCantidad(cuadreData.totales.transferencias_salida)}\n                  </p>\n                </div>\n              </div>\n            )}\n\n            {(cuadreData?.detalles?.length ?? 0) === 0 ? (\n              <div className=\"space-y-6\">\n                <div className=\"text-center py-8\">\n                  <div className=\"bg-blue-50 border border-blue-200 rounded-lg p-6\">\n                    <h3 className=\"text-lg font-semibold text-blue-800 mb-2\">\n                      Ô£à Cierre sin Movimientos de Divisas\n                    </h3>\n                    <p className=\"text-blue-700 mb-4\">\n                      No se registraron cambios de divisas hoy, pero puede\n                      proceder con el cierre.\n                    </p>\n                    <p className=\"text-sm text-blue-600\">\n                      El cierre incluir├í todos los movimientos del d├¡a\n                      (servicios externos, transferencias, etc.).\n                    </p>\n                  </div>\n                </div>\n\n                {/* Bot├│n de cierre para d├¡as sin movimientos */}\n                <Button\n                  onClick={confirmDailyClose}\n                  className=\"w-full bg-green-600 hover:bg-green-700 text-white py-3\"\n                  size=\"lg\"\n                  disabled={loading || closing || !cuadreData}\n                >\n                  {closing ? (\n                    <span className=\"inline-flex items-center gap-2\">\n                      <span className=\"h-4 w-4 rounded-full border-2 border-white border-b-transparent animate-spin\"></span>\n                      Cerrando...\n                    </span>\n                  ) : (\n                    \"Realizar Cierre Diario\"\n                  )}\n                </Button>\n\n                <div className=\"mt-3 text-xs text-gray-600 text-center\">\n                  El cierre se realizar├í sin detalles de cuadre de caja, ya que\n                  no hubo movimientos de divisas.\n                </div>\n              </div>\n            ) : (\n              <div className=\"grid gap-6\">\n                {(cuadreData?.detalles ?? []).map((detalle) => {\n                  const userTotal = calculateUserTotal(detalle.moneda_id);\n                  const userBanks = calculateUserBanks(detalle.moneda_id);\n                  const isValid = validateBalance(detalle, userTotal);\n\n                  return (\n                    <Card\n                      key={detalle.moneda_id}\n                      className={`${\n                        !isValid\n                          ? \"border-red-300 bg-red-50\"\n                          : \"border-gray-200\"\n                      }`}\n                    >\n                      <CardHeader className=\"pb-3\">\n                        <div className=\"flex justify-between items-center\">\n                          <CardTitle className=\"text-xl flex items-center gap-2\">\n                            <span className=\"text-2xl\">{detalle.simbolo}</span>\n                            {detalle.codigo} - {detalle.nombre}\n                          </CardTitle>\n                          {!isValid && (\n                            <Badge variant=\"destructive\" className=\"text-xs\">\n                              ÔÜá´©Å No cuadra\n                            </Badge>\n                          )}\n                        </div>\n                      </CardHeader>\n                      <CardContent className=\"space-y-4\">\n                        {/* Resumen de movimientos */}\n                        <div className=\"grid grid-cols-2 md:grid-cols-4 gap-3 text-sm\">\n                          <Card className=\"bg-blue-50 border-blue-200\">\n                            <CardContent className=\"p-3\">\n                              <div className=\"text-blue-700 font-medium text-xs\">\n                                Saldo Apertura\n                              </div>\n                              <div className=\"text-blue-800 font-bold text-lg\">\n                                {detalle.simbolo}\n                                {detalle.saldo_apertura.toFixed(2)}\n                              </div>\n                              <div className=\"text-xs text-blue-600\">\n                                Dinero al inicio\n                              </div>\n                            </CardContent>\n                          </Card>\n\n                          <Card className=\"bg-green-50 border-green-200\">\n                            <CardContent className=\"p-3\">\n                              <div className=\"text-green-700 font-medium text-xs\">\n                                Ingresos (+)\n                              </div>\n                              <div className=\"text-green-800 font-bold text-lg\">\n                                +{detalle.simbolo}\n                                {detalle.ingresos_periodo.toFixed(2)}\n                              </div>\n                              <div className=\"text-xs text-green-600\">\n                                Divisas recibidas\n                              </div>\n                            </CardContent>\n                          </Card>\n\n                          <Card className=\"bg-red-50 border-red-200\">\n                            <CardContent className=\"p-3\">\n                              <div className=\"text-red-700 font-medium text-xs\">\n                                Egresos (-)\n                              </div>\n                              <div className=\"text-red-800 font-bold text-lg\">\n                                -{detalle.simbolo}\n                                {detalle.egresos_periodo.toFixed(2)}\n                              </div>\n                              <div className=\"text-xs text-red-600\">\n                                Divisas entregadas\n                              </div>\n                            </CardContent>\n                          </Card>\n\n                          <Card className=\"bg-purple-50 border-purple-200\">\n                            <CardContent className=\"p-3\">\n                              <div className=\"text-purple-700 font-medium text-xs\">\n                                Saldo Esperado\n                              </div>\n                              <div className=\"text-purple-800 font-bold text-lg\">\n                                {detalle.simbolo}\n                                {detalle.saldo_cierre.toFixed(2)}\n                              </div>\n                              <div className=\"text-xs text-purple-600\">\n                                Lo que debe quedar\n                              </div>\n                            </CardContent>\n                          </Card>\n                        </div>\n\n                        {/* Instrucciones claras */}\n                        <Card className=\"bg-yellow-50 border-yellow-200\">\n                          <CardContent className=\"p-4\">\n                            <div className=\"flex items-start gap-2\">\n                              <span className=\"text-yellow-600 text-lg\">\n                                ­ƒôØ\n                              </span>\n                              <div>\n                                <h4 className=\"font-medium text-yellow-800 mb-1\">\n                                  Instrucciones de Conteo\n                                </h4>\n                                <p className=\"text-sm text-yellow-700\">\n                                  Cuente f├¡sicamente el dinero que tiene en caja\n                                  y registre los valores. Debe tener exactamente{\" \"}\n                                  <strong>\n                                    {detalle.simbolo}\n                                    {detalle.saldo_cierre.toFixed(2)}\n                                  </strong>{\" \"}\n                                  en total.\n                                </p>\n                              </div>\n                            </div>\n                          </CardContent>\n                        </Card>\n\n                        {/* Conteo f├¡sico del usuario */}\n                        <Card className=\"border-gray-300\">\n                          <CardHeader className=\"pb-3\">\n                            <CardTitle className=\"text-lg\">\n                              ­ƒÆ░ Conteo F├¡sico\n                            </CardTitle>\n                            <CardDescription>\n                              Registre el dinero que tiene f├¡sicamente en caja\n                            </CardDescription>\n                          </CardHeader>\n                          <CardContent>\n                            <div className=\"grid grid-cols-1 md:grid-cols-3 gap-4\">\n                              <div className=\"space-y-2\">\n                                <Label className=\"text-sm font-medium flex items-center gap-1\">\n                                  ­ƒÆÁ Billetes\n                                  <span className=\"text-xs text-gray-500\">\n                                    ({detalle.simbolo})\n                                  </span>\n                                </Label>\n                                <Input\n                                  type=\"number\"\n                                  step=\"0.01\"\n                                  min=\"0\"\n                                  value={\n                                    userAdjustments[detalle.moneda_id]?.bills ||\n                                    \"\"\n                                  }\n                                  onChange={(e) =>\n                                    handleUserAdjustment(\n                                      detalle.moneda_id,\n                                      \"bills\",\n                                      e.target.value\n                                    )\n                                  }\n                                  placeholder=\"0.00\"\n                                  className={!isValid ? \"border-red-300\" : \"\"}\n                                />\n                              </div>\n\n                              <div className=\"space-y-2\">\n                                <Label className=\"text-sm font-medium flex items-center gap-1\">\n                                  ­ƒ¬Ö Monedas\n                                  <span className=\"text-xs text-gray-500\">\n                                    ({detalle.simbolo})\n                                  </span>\n                                </Label>\n                                <Input\n                                  type=\"number\"\n                                  step=\"0.01\"\n                                  min=\"0\"\n                                  value={\n                                    userAdjustments[detalle.moneda_id]?.coins ||\n                                    \"\"\n                                  }\n                                  onChange={(e) =>\n                                    handleUserAdjustment(\n                                      detalle.moneda_id,\n                                      \"coins\",\n                                      e.target.value\n                                    )\n                                  }\n                                  placeholder=\"0.00\"\n                                  className={!isValid ? \"border-red-300\" : \"\"}\n                                />\n                              </div>\n\n                              <div className=\"space-y-2\">\n                                <Label className=\"text-sm font-medium\">\n                                  ­ƒÆ░ Total Contado\n                                </Label>\n                                <div className=\"flex items-center gap-2\">\n                                  <div\n                                    className={`h-10 px-3 py-2 border rounded-md flex items-center font-bold text-lg ${\n                                      !isValid\n                                        ? \"bg-red-50 border-red-300 text-red-700\"\n                                        : \"bg-green-50 border-green-300 text-green-700\"\n                                    }`}\n                                  >\n                                    {detalle.simbolo}\n                                    {userTotal.toFixed(2)}\n                                  </div>\n                                  {(() => {\n                                    const diff = parseFloat(\n                                      (\n                                        userTotal - detalle.saldo_cierre\n                                      ).toFixed(2)\n                                    );\n                                    const abs = Math.abs(diff);\n                                    const tol = getTolerance(detalle);\n                                    const within = abs <= tol;\n                                    const sign =\n                                      diff > 0 ? \"+\" : diff < 0 ? \"-\" : \"\";\n                                    const color = within\n                                      ? diff === 0\n                                        ? \"bg-gray-200 text-gray-800 border-gray-300\"\n                                        : \"bg-green-100 text-green-800 border-green-300\"\n                                      : \"bg-red-100 text-red-800 border-red-300\";\n                                    const label = `${sign}${abs.toFixed(2)}`;\n                                    return (\n                                      <Badge\n                                        className={`border ${color} whitespace-nowrap`}\n                                        variant={\n                                          within ? \"secondary\" : \"destructive\"\n                                        }\n                                        title={`Diferencia vs esperado (tolerancia ┬▒${tol.toFixed(\n                                          2\n                                        )})`}\n                                      >\n                                        Diff: {label}\n                                      </Badge>\n                                    );\n                                  })()}\n                                </div>\n                              </div>\n                            </div>\n\n                            {/* Observaciones */}\n                            <div className=\"mt-4 space-y-2\">\n                              <Label className=\"text-sm font-medium\">\n                                ­ƒôØ Observaciones (opcional)\n                              </Label>\n                              <Textarea\n                                rows={2}\n                                placeholder=\"Ej: Diferencia por redondeo, conteo manual, etc.\"\n                                value={\n                                  userAdjustments[detalle.moneda_id]?.note || \"\"\n                                }\n                                onChange={(e) =>\n                                  handleUserAdjustment(\n                                    detalle.moneda_id,\n                                    \"note\",\n                                    e.target.value\n                                  )\n                                }\n                              />\n                            </div>\n                          </CardContent>\n                        </Card>\n\n                        {/* Conteo bancos */}\n                        <Card className=\"border-gray-300\">\n                          <CardHeader className=\"pb-3\">\n                            <CardTitle className=\"text-lg\">­ƒÅª Bancos</CardTitle>\n                            <CardDescription>\n                              Registre el saldo bancario (transferencias) por moneda\n                            </CardDescription>\n                          </CardHeader>\n                          <CardContent>\n                            <div className=\"grid grid-cols-1 md:grid-cols-3 gap-4\">\n                              <div className=\"space-y-2\">\n                                <Label className=\"text-sm font-medium\">\n                                  ­ƒÅª Saldo Bancos Esperado\n                                </Label>\n                                <div className=\"h-10 px-3 py-2 border rounded-md flex items-center font-bold text-lg bg-purple-50 border-purple-200 text-purple-800\">\n                                  {detalle.simbolo}\n                                  {Number(detalle.bancos_teorico ?? 0).toFixed(2)}\n                                </div>\n                              </div>\n\n                              <div className=\"space-y-2\">\n                                <Label className=\"text-sm font-medium flex items-center gap-1\">\n                                  ­ƒÅª Bancos (Ingresado)\n                                  <span className=\"text-xs text-gray-500\">\n                                    ({detalle.simbolo})\n                                  </span>\n                                </Label>\n                                <Input\n                                  type=\"number\"\n                                  step=\"0.01\"\n                                  min=\"0\"\n                                  value={\n                                    userAdjustments[detalle.moneda_id]?.banks ||\n                                    \"\"\n                                  }\n                                  onChange={(e) =>\n                                    handleUserAdjustment(\n                                      detalle.moneda_id,\n                                      \"banks\",\n                                      e.target.value\n                                    )\n                                  }\n                                  placeholder=\"0.00\"\n                                  className={!isValid ? \"border-red-300\" : \"\"}\n                                />\n                              </div>\n\n                              <div className=\"space-y-2\">\n                                <Label className=\"text-sm font-medium\">\n                                  ­ƒôè Diff Bancos\n                                </Label>\n                                <div className=\"flex items-center gap-2\">\n                                  <div className=\"h-10 px-3 py-2 border rounded-md flex items-center font-bold text-lg bg-gray-50 border-gray-200 text-gray-800\">\n                                    {detalle.simbolo}\n                                    {userBanks.toFixed(2)}\n                                  </div>\n                                  {(() => {\n                                    const esperado = Number(detalle.bancos_teorico ?? 0);\n                                    const diff = parseFloat((userBanks - esperado).toFixed(2));\n                                    const abs = Math.abs(diff);\n                                    const tol = getTolerance(detalle);\n                                    const within = abs <= tol;\n                                    const sign = diff > 0 ? \"+\" : diff < 0 ? \"-\" : \"\";\n                                    const color = within\n                                      ? diff === 0\n                                        ? \"bg-gray-200 text-gray-800 border-gray-300\"\n                                        : \"bg-green-100 text-green-800 border-green-300\"\n                                      : \"bg-red-100 text-red-800 border-red-300\";\n                                    const label = `${sign}${abs.toFixed(2)}`;\n                                    return (\n                                      <Badge\n                                        className={`border ${color} whitespace-nowrap`}\n                                        variant={within ? \"secondary\" : \"destructive\"}\n                                        title={`Diferencia bancos vs esperado (tolerancia ┬▒${tol.toFixed(2)})`}\n                                      >\n                                        Diff: {label}\n                                      </Badge>\n                                    );\n                                  })()}\n                                </div>\n                              </div>\n                            </div>\n                          </CardContent>\n                        </Card>\n                      </CardContent>\n                    </Card>\n                  );\n                })}\n\n                {/* Secci├│n de validaci├│n de cierres */}\n                {validacionCierres && (\n                  <Card className=\"border-blue-200 bg-blue-50\">\n                    <CardHeader className=\"pb-3\">\n                      <CardTitle className=\"text-lg text-blue-800\">\n                        ­ƒôï Validaci├│n de Cierres Requeridos\n                      </CardTitle>\n                    </CardHeader>\n                    <CardContent className=\"space-y-3\">\n                      <div className=\"grid gap-2\">\n                        {/* Servicios Externos */}\n                        {validacionCierres.cierres_requeridos\n                          .servicios_externos && (\n                          <div className=\"flex items-center justify-between p-2 bg-white rounded border\">\n                            <span className=\"text-sm font-medium\">\n                              Cierre de Servicios Externos\n                              <span className=\"text-xs text-gray-500 ml-1\">\n                                (\n                                {validacionCierres.conteos\n                                  ?.servicios_externos || 0}{\" \"}\n                                movimientos)\n                              </span>\n                            </span>\n                            <Badge\n                              variant={\n                                validacionCierres.estado_cierres\n                                  .servicios_externos\n                                  ? \"default\"\n                                  : \"destructive\"\n                              }\n                              className=\"text-xs\"\n                            >\n                              {validacionCierres.estado_cierres\n                                .servicios_externos\n                                ? \"Ô£à Completado\"\n                                : \"ÔÅ│ Pendiente\"}\n                            </Badge>\n                          </div>\n                        )}\n\n                        {/* Cambios de Divisas */}\n                        {validacionCierres.cierres_requeridos\n                          .cambios_divisas && (\n                          <div className=\"flex items-center justify-between p-2 bg-white rounded border\">\n                            <span className=\"text-sm font-medium\">\n                              Cambios de Divisas\n                              <span className=\"text-xs text-gray-500 ml-1\">\n                                (\n                                {validacionCierres.conteos?.cambios_divisas ||\n                                  0}{\" \"}\n                                movimientos)\n                              </span>\n                            </span>\n                            <Badge\n                              variant={\n                                validacionCierres.estado_cierres.cambios_divisas\n                                  ? \"default\"\n                                  : \"destructive\"\n                              }\n                              className=\"text-xs\"\n                            >\n                              {validacionCierres.estado_cierres.cambios_divisas\n                                ? \"Ô£à Incluido en cierre diario\"\n                                : \"ÔÅ│ Pendiente\"}\n                            </Badge>\n                          </div>\n                        )}\n\n                        {/* Cierre Diario */}\n                        <div className=\"flex items-center justify-between p-2 bg-white rounded border\">\n                          <span className=\"text-sm font-medium\">\n                            Cierre Diario\n                          </span>\n                          <Badge\n                            variant={\n                              validacionCierres.estado_cierres.cierre_diario\n                                ? \"default\"\n                                : \"secondary\"\n                            }\n                            className=\"text-xs\"\n                          >\n                            {validacionCierres.estado_cierres.cierre_diario\n                              ? \"Ô£à Completado\"\n                              : \"­ƒôØ Por realizar\"}\n                          </Badge>\n                        </div>\n                      </div>\n\n                      {/* Estado general */}\n                      <div className=\"pt-2 border-t\">\n                        <div className=\"flex items-center justify-between\">\n                          <span className=\"text-sm font-medium text-blue-800\">\n                            Estado General:\n                          </span>\n                          <Badge\n                            variant={\n                              validacionCierres.cierres_completos\n                                ? \"default\"\n                                : \"secondary\"\n                            }\n                          >\n                            {validacionCierres.cierres_completos\n                              ? \"Ô£à Todos los cierres completos\"\n                              : \"ÔÅ│ Cierres pendientes\"}\n                          </Badge>\n                        </div>\n                      </div>\n                    </CardContent>\n                  </Card>\n                )}\n\n                <Button\n                  onClick={confirmDailyClose}\n                  className=\"w-full bg-green-600 hover:bg-green-700 text-white py-3\"\n                  size=\"lg\"\n                  disabled={loading || closing || loadingResumen || !cuadreData}\n                >\n                  {loadingResumen ? (\n                    <span className=\"inline-flex items-center gap-2\">\n                      <span className=\"h-4 w-4 rounded-full border-2 border-white border-b-transparent animate-spin\"></span>\n                      Cargando resumen...\n                    </span>\n                  ) : closing ? (\n                    <span className=\"inline-flex items-center gap-2\">\n                      <span className=\"h-4 w-4 rounded-full border-2 border-white border-b-transparent animate-spin\"></span>\n                      Cerrando...\n                    </span>\n                  ) : (\n                    \"Realizar Cierre Diario\"\n                  )}\n                </Button>\n\n                {/* Sugerencia: accesos r├ípidos para cuadrar */}\n                <div className=\"mt-3 text-xs text-gray-600 text-center\">\n                  Si no cuadra, registre un movimiento en Servicios Externos\n                  (USD) o agregue el Cambio de Divisa faltante.\n                </div>\n              </div>\n            )}\n          </CardContent>\n        </Card>\n      ) : (\n        <Card>\n          <CardHeader>\n            <CardTitle>Cierre Completado</CardTitle>\n            <CardDescription>\n              Cierre diario realizado el{\" \"}\n              {todayClose.fecha_cierre &&\n                new Date(todayClose.fecha_cierre).toLocaleString()}\n            </CardDescription>\n          </CardHeader>\n          <CardContent>\n            <div className=\"space-y-6\">\n              <div className=\"grid grid-cols-1 md:grid-cols-3 gap-4\">\n                <div className=\"bg-blue-50 p-4 rounded-lg\">\n                  <h4 className=\"font-semibold text-blue-700\">Total Cambios</h4>\n                  <p className=\"text-2xl font-bold text-blue-600\">\n                    {getCantidad(todayClose.total_cambios)}\n                  </p>\n                </div>\n                <div className=\"bg-green-50 p-4 rounded-lg\">\n                  <h4 className=\"font-semibold text-green-700\">\n                    Transferencias Entrada\n                  </h4>\n                  <p className=\"text-2xl font-bold text-green-600\">\n                    {getCantidad(todayClose.total_transferencias_entrada)}\n                  </p>\n                </div>\n                <div className=\"bg-orange-50 p-4 rounded-lg\">\n                  <h4 className=\"font-semibold text-orange-700\">\n                    Transferencias Salida\n                  </h4>\n                  <p className=\"text-2xl font-bold text-orange-600\">\n                    {getCantidad(todayClose.total_transferencias_salida)}\n                  </p>\n                </div>\n              </div>\n\n              <div className=\"flex justify-between items-center gap-4\">\n                <Button\n                  onClick={generateCloseReport}\n                  variant=\"outline\"\n                  className=\"border-blue-600 text-blue-600 hover:bg-blue-50\"\n                >\n                  Generar Reporte\n                </Button>\n                \n                {jornadaFinalizada && (\n                  <div className=\"flex flex-col items-end gap-2\">\n                    <p className=\"text-sm text-orange-600 font-medium\">\n                      ÔÜá´©Å Su jornada ha sido finalizada\n                    </p>\n                    <Button\n                      onClick={handleLogout}\n                      variant=\"destructive\"\n                      className=\"bg-red-600 hover:bg-red-700\"\n                    >\n                      Cerrar Sesi├│n\n                    </Button>\n                  </div>\n                )}\n              </div>\n            </div>\n          </CardContent>\n        </Card>\n      )}\n\n      {/* Modal de Resumen de Cierre */}\n      <Dialog open={showResumenModal} onOpenChange={setShowResumenModal}>\n        <DialogContent className=\"max-w-3xl max-h-[80vh] overflow-y-auto\">\n          <DialogHeader>\n            <DialogTitle className=\"text-xl font-bold\">\n              ­ƒôè Resumen de Saldos - Cierre Diario\n            </DialogTitle>\n            <DialogDescription>\n              Verifique los saldos antes de confirmar el cierre\n            </DialogDescription>\n          </DialogHeader>\n\n          {resumenCierre && (\n            <div className=\"space-y-6 py-4\">\n              {/* Total de Transacciones */}\n              <div className=\"bg-blue-50 p-4 rounded-lg border border-blue-200\">\n                <h3 className=\"font-semibold text-blue-800 mb-2\">\n                  Total de Transacciones del D├¡a\n                </h3>\n                <p className=\"text-3xl font-bold text-blue-600\">\n                  {resumenCierre.total_transacciones}\n                </p>\n              </div>\n\n              {/* Saldos Principales */}\n              <div className=\"space-y-3\">\n                <h3 className=\"font-semibold text-gray-800 text-lg flex items-center gap-2\">\n                  ­ƒÆ░ Saldos Principales\n                </h3>\n                <div className=\"grid gap-3\">\n                  {resumenCierre.saldos_principales.map((saldo) => (\n                    <div\n                      key={saldo.moneda_codigo}\n                      className={`p-4 rounded-lg border-2 ${\n                        saldo.moneda_codigo === \"USD\"\n                          ? \"bg-green-50 border-green-300\"\n                          : saldo.tuvo_movimientos\n                          ? \"bg-blue-50 border-blue-300\"\n                          : \"bg-gray-50 border-gray-200\"\n                      }`}\n                    >\n                      <div className=\"flex justify-between items-center\">\n                        <div>\n                          <div className=\"flex items-center gap-2\">\n                            <span className=\"font-bold text-lg\">\n                              {saldo.moneda_codigo}\n                            </span>\n                            <span className=\"text-sm text-gray-600\">\n                              {saldo.moneda_nombre}\n                            </span>\n                            {saldo.tuvo_movimientos && (\n                              <Badge variant=\"secondary\" className=\"text-xs\">\n                                Con movimientos\n                              </Badge>\n                            )}\n                          </div>\n                        </div>\n                        <div className=\"text-right\">\n                          <div className=\"text-2xl font-bold\">\n                            {saldo.moneda_simbolo}{\" \"}\n                            {saldo.saldo_final.toLocaleString(\"es-EC\", {\n                              minimumFractionDigits: 2,\n                              maximumFractionDigits: 2,\n                            })}\n                          </div>\n                        </div>\n                      </div>\n                    </div>\n                  ))}\n                </div>\n              </div>\n\n              {/* Servicios Externos */}\n              {resumenCierre.servicios_externos.length > 0 && (\n                <div className=\"space-y-3\">\n                  <h3 className=\"font-semibold text-gray-800 text-lg flex items-center gap-2\">\n                    ­ƒÅª Saldos en Servicios Externos\n                  </h3>\n                  <div className=\"grid gap-3\">\n                      {resumenCierre.servicios_externos.map((servicio, idx: number) => (\n                      <div\n                        key={idx}\n                        className=\"p-4 rounded-lg border-2 bg-purple-50 border-purple-300\"\n                      >\n                        <div className=\"space-y-2\">\n                          <div className=\"font-bold text-purple-800\">\n                            {servicio.servicio_nombre}\n                            <Badge variant=\"outline\" className=\"ml-2 text-xs\">\n                              {servicio.servicio_tipo}\n                            </Badge>\n                          </div>\n                          <div className=\"grid grid-cols-2 md:grid-cols-3 gap-2\">\n                            {servicio.saldos.map((saldo, sidx: number) => (\n                              <div\n                                key={sidx}\n                                className=\"bg-white p-2 rounded border\"\n                              >\n                                <div className=\"text-xs text-gray-600\">\n                                  {saldo.moneda_codigo}\n                                </div>\n                                <div className=\"font-semibold\">\n                                  {saldo.moneda_simbolo}{\" \"}\n                                  {saldo.saldo.toLocaleString(\"es-EC\", {\n                                    minimumFractionDigits: 2,\n                                    maximumFractionDigits: 2,\n                                  })}\n                                </div>\n                              </div>\n                            ))}\n                          </div>\n                        </div>\n                      </div>\n                    ))}\n                  </div>\n                </div>\n              )}\n\n              {/* Listado de transacciones del d├¡a */}\n              {(resumenCierre.transacciones?.cambios_divisas?.length > 0 ||\n                resumenCierre.transacciones?.servicios_externos?.length > 0) && (\n                <div className=\"space-y-3\">\n                  <h3 className=\"font-semibold text-gray-800 text-lg flex items-center gap-2\">\n                    ­ƒôï Transacciones del D├¡a (auditor├¡a)\n                  </h3>\n\n                  {/* Mini balance */}\n                  <div className=\"grid grid-cols-1 md:grid-cols-2 gap-3\">\n                    <div className=\"p-4 rounded-lg border-2 bg-gray-50 border-gray-200\">\n                      <div className=\"flex items-center justify-between\">\n                        <div>\n                          <div className=\"font-semibold\">Cambios de divisas</div>\n                          <div className=\"text-xs text-gray-600\">\n                            Cantidad: {resumenCierre.transacciones?.cambios_divisas?.length || 0}\n                          </div>\n                        </div>\n                        <Badge variant=\"secondary\">Cambios</Badge>\n                      </div>\n                      {(resumenCierre.balance?.cambios_divisas?.por_moneda?.length ?? 0) > 0 && (\n                        <div className=\"mt-3\">\n                          <div className=\"text-xs font-medium text-gray-700 mb-1\">\n                            Ingresos/Egresos por moneda\n                          </div>\n                          <div className=\"grid grid-cols-1 gap-1\">\n                            {(resumenCierre.balance?.cambios_divisas?.por_moneda || []).map(\n                              (r) => (\n                                <div\n                                  key={r.moneda?.codigo}\n                                  className=\"flex items-center justify-between text-xs bg-white border rounded px-2 py-1\"\n                                >\n                                  <div className=\"text-gray-700\">\n                                    {r.moneda?.codigo}\n                                    {r.moneda?.nombre ? ` (${r.moneda.nombre})` : \"\"}\n                                  </div>\n                                  <div className=\"text-gray-800 tabular-nums\">\n                                    +{fmt2(r.ingresos)} / -{fmt2(r.egresos)}\n                                  </div>\n                                </div>\n                              )\n                            )}\n                          </div>\n                        </div>\n                      )}\n                      <div className=\"text-xs text-gray-600 mt-2\">\n                        Recomendaci├│n: revise la columna ÔÇ£Cliente recibe (sale)ÔÇØ para validar el egreso.\n                      </div>\n                    </div>\n                    <div className=\"p-4 rounded-lg border-2 bg-gray-50 border-gray-200\">\n                      <div className=\"flex items-center justify-between\">\n                        <div>\n                          <div className=\"font-semibold\">Servicios externos</div>\n                          <div className=\"text-xs text-gray-600\">\n                            Cantidad: {resumenCierre.transacciones?.servicios_externos?.length || 0}\n                          </div>\n                        </div>\n                        <Badge variant=\"secondary\">Servicios</Badge>\n                      </div>\n                      {(resumenCierre.balance?.servicios_externos?.por_moneda?.length ?? 0) > 0 && (\n                        <div className=\"mt-3\">\n                          <div className=\"text-xs font-medium text-gray-700 mb-1\">\n                            Ingresos/Egresos por moneda\n                          </div>\n                          <div className=\"grid grid-cols-1 gap-1\">\n                            {(resumenCierre.balance?.servicios_externos?.por_moneda || []).map(\n                              (r) => (\n                                <div\n                                  key={r.moneda?.codigo}\n                                  className=\"flex items-center justify-between text-xs bg-white border rounded px-2 py-1\"\n                                >\n                                  <div className=\"text-gray-700\">\n                                    {r.moneda?.codigo}\n                                    {r.moneda?.nombre ? ` (${r.moneda.nombre})` : \"\"}\n                                  </div>\n                                  <div className=\"text-gray-800 tabular-nums\">\n                                    +{fmt2(r.ingresos)} / -{fmt2(r.egresos)}\n                                  </div>\n                                </div>\n                              )\n                            )}\n                          </div>\n                        </div>\n                      )}\n                      <div className=\"text-xs text-gray-600 mt-2\">\n                        Incluye ingresos/egresos del d├¡a por servicio.\n                      </div>\n                    </div>\n                  </div>\n\n                  <Tabs defaultValue=\"cambios\" className=\"w-full\">\n                    <TabsList className=\"grid w-full grid-cols-2\">\n                      <TabsTrigger value=\"cambios\">\n                        Cambios ({resumenCierre.transacciones?.cambios_divisas?.length || 0})\n                      </TabsTrigger>\n                      <TabsTrigger value=\"servicios\">\n                        Servicios externos ({resumenCierre.transacciones?.servicios_externos?.length || 0})\n                      </TabsTrigger>\n                    </TabsList>\n\n                    <TabsContent value=\"cambios\" className=\"mt-3\">\n                      <div className=\"rounded-lg border bg-white\">\n                        <Table>\n                          <TableHeader>\n                            <TableRow>\n                              <TableHead>Hora</TableHead>\n                              <TableHead>Recibo</TableHead>\n                              <TableHead>Operaci├│n</TableHead>\n                              <TableHead>Operador</TableHead>\n                              <TableHead>Cliente entrega</TableHead>\n                              <TableHead>Cliente recibe (sale)</TableHead>\n                              <TableHead>Tasa</TableHead>\n                            </TableRow>\n                          </TableHeader>\n                          <TableBody>\n                            {(resumenCierre.transacciones?.cambios_divisas || []).map((c) => {\n                              const d = new Date(c.fecha);\n                              const hora = isNaN(d.getTime())\n                                ? String(c.fecha)\n                                : d.toLocaleTimeString();\n                              const mo = c.moneda_origen;\n                              const md = c.moneda_destino;\n                              const tasaText =\n                                (Number(c.tasa_cambio_billetes || 0) > 0\n                                  ? `B ${Number(c.tasa_cambio_billetes).toFixed(3)}`\n                                  : \"\") +\n                                (Number(c.tasa_cambio_monedas || 0) > 0\n                                  ? `${Number(c.tasa_cambio_billetes || 0) > 0 ? \" | \" : \"\"}M ${Number(c.tasa_cambio_monedas).toFixed(3)}`\n                                  : \"\");\n                              return (\n                                <TableRow key={c.id}>\n                                  <TableCell className=\"whitespace-nowrap\">{hora}</TableCell>\n                                  <TableCell className=\"whitespace-nowrap\">\n                                    {c.numero_recibo || \"ÔÇö\"}\n                                  </TableCell>\n                                  <TableCell>\n                                    <span className={`px-2 py-0.5 rounded text-xs font-medium border ${c.tipo_operacion === \"COMPRA\" ? \"bg-green-50 text-green-700 border-green-200\" : \"bg-blue-50 text-blue-700 border-blue-200\"}`}>\n                                      {c.tipo_operacion}\n                                    </span>\n                                  </TableCell>\n                                  <TableCell className=\"whitespace-nowrap\">\n                                    {c.usuario?.nombre || c.usuario?.username || \"ÔÇö\"}\n                                  </TableCell>\n                                  <TableCell className=\"whitespace-nowrap\">\n                                    {(mo?.codigo || \"ÔÇö\") + (mo?.nombre ? ` (${mo.nombre})` : \"\")} {Number(c.monto_origen || 0).toFixed(2)}\n                                  </TableCell>\n                                  <TableCell className=\"whitespace-nowrap\">\n                                    {(md?.codigo || \"ÔÇö\") + (md?.nombre ? ` (${md.nombre})` : \"\")} {Number(c.monto_destino || 0).toFixed(2)}\n                                  </TableCell>\n                                  <TableCell className=\"whitespace-nowrap\">\n                                    {tasaText || \"ÔÇö\"}\n                                  </TableCell>\n                                </TableRow>\n                              );\n                            })}\n                          </TableBody>\n                        </Table>\n                      </div>\n                      <p className=\"text-xs text-gray-500 mt-2\">\n                        Usa este listado para validar diferencias antes de cerrar.\n                      </p>\n                    </TabsContent>\n\n                    <TabsContent value=\"servicios\" className=\"mt-3\">\n                      <div className=\"rounded-lg border bg-white\">\n                        <Table>\n                          <TableHeader>\n                            <TableRow>\n                              <TableHead>Hora</TableHead>\n                              <TableHead>Servicio</TableHead>\n                              <TableHead>Tipo</TableHead>\n                              <TableHead>Operador</TableHead>\n                              <TableHead>Moneda</TableHead>\n                              <TableHead>Monto</TableHead>\n                              <TableHead>Ref</TableHead>\n                            </TableRow>\n                          </TableHeader>\n                          <TableBody>\n                            {(resumenCierre.transacciones?.servicios_externos || []).map((m) => {\n                              const d = new Date(m.fecha);\n                              const hora = isNaN(d.getTime())\n                                ? String(m.fecha)\n                                : d.toLocaleTimeString();\n                              return (\n                                <TableRow key={m.id}>\n                                  <TableCell className=\"whitespace-nowrap\">{hora}</TableCell>\n                                  <TableCell className=\"whitespace-nowrap\">{m.servicio}</TableCell>\n                                  <TableCell className=\"whitespace-nowrap\">\n                                    <span className={`px-2 py-0.5 rounded text-xs font-medium border ${m.tipo_movimiento === \"INGRESO\" ? \"bg-green-50 text-green-700 border-green-200\" : \"bg-red-50 text-red-700 border-red-200\"}`}>\n                                      {m.tipo_movimiento}\n                                    </span>\n                                  </TableCell>\n                                  <TableCell className=\"whitespace-nowrap\">\n                                    {m.usuario?.nombre || m.usuario?.username || \"ÔÇö\"}\n                                  </TableCell>\n                                  <TableCell className=\"whitespace-nowrap\">{m.moneda || \"ÔÇö\"}</TableCell>\n                                  <TableCell className=\"whitespace-nowrap\">{Number(m.monto || 0).toFixed(2)}</TableCell>\n                                  <TableCell className=\"whitespace-nowrap\">{m.numero_referencia || \"ÔÇö\"}</TableCell>\n                                </TableRow>\n                              );\n                            })}\n                          </TableBody>\n                        </Table>\n                      </div>\n                      <p className=\"text-xs text-gray-500 mt-2\">\n                        Incluye ingresos/egresos de servicios externos del d├¡a.\n                      </p>\n                    </TabsContent>\n                  </Tabs>\n                </div>\n              )}\n            </div>\n          )}\n\n          <DialogFooter className=\"flex gap-2\">\n            <Button\n              variant=\"outline\"\n              onClick={printBalance}\n              disabled={closing}\n            >\n              Imprimir balance\n            </Button>\n            <Button\n              variant=\"outline\"\n              onClick={() => setShowResumenModal(false)}\n              disabled={closing}\n            >\n              Cancelar\n            </Button>\n            <Button\n              onClick={proceedWithClose}\n              className=\"bg-green-600 hover:bg-green-700\"\n              disabled={closing}\n            >\n              {closing ? \"Cerrando...\" : \"Confirmar Cierre\"}\n            </Button>\n          </DialogFooter>\n        </DialogContent>\n      </Dialog>\n\n      <ConfirmationDialog />\n    </div>\n  );\n};\n\nexport default DailyClose;\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\oswal\\OneDrive\\Documentos\\Punto Cambio\\punto_cambio_new\\src\\components\\close\\ExternalServicesClose.tsx","messages":[{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'user' is defined but never used. Allowed unused args must match /^_/u.","line":31,"column":3,"nodeType":null,"messageId":"unusedVar","endLine":31,"endColumn":7}],"suppressedMessages":[{"ruleId":"react-hooks/exhaustive-deps","severity":1,"message":"React Hook useEffect has a missing dependency: 'cargarStatus'. Either include it or remove the dependency array.","line":123,"column":6,"nodeType":"ArrayExpression","endLine":123,"endColumn":15,"suggestions":[{"desc":"Update the dependencies array to be: [cargarStatus, pointId]","fix":{"range":[3919,3928],"text":"[cargarStatus, pointId]"}}],"suppressions":[{"kind":"directive","justification":""}]}],"errorCount":0,"fatalErrorCount":0,"warningCount":1,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import { useEffect, useMemo, useState } from \"react\";\r\nimport { Card, CardContent, CardHeader, CardTitle } from \"@/components/ui/card\";\r\nimport { Button } from \"@/components/ui/button\";\r\nimport { Input } from \"@/components/ui/input\";\r\nimport { Label } from \"@/components/ui/label\";\r\nimport { Badge } from \"@/components/ui/badge\";\r\nimport { toast } from \"@/hooks/use-toast\";\r\nimport type { PuntoAtencion, User } from \"@/types\";\r\nimport {\r\n  abrirCierreServiciosExternos,\r\n  cerrarCierreServiciosExternos,\r\n  statusCierreServiciosExternos,\r\n  type ServicioExterno,\r\n} from \"@/services/externalServicesService\";\r\n\r\ntype DetalleItem = {\r\n  servicio: string;\r\n  moneda_id: string;\r\n  monto_movimientos: number; // neto del d├¡a\r\n  monto_validado: number; // input usuario\r\n  diferencia: number; // calculado\r\n  observaciones?: string;\r\n};\r\n\r\ninterface ExternalServicesCloseProps {\r\n  user: User;\r\n  selectedPoint: PuntoAtencion | null;\r\n}\r\n\r\nexport default function ExternalServicesClose({\r\n  user,\r\n  selectedPoint,\r\n}: ExternalServicesCloseProps) {\r\n  const [loading, setLoading] = useState(false);\r\n  const [saving, setSaving] = useState(false);\r\n  const [estado, setEstado] = useState<\"SIN_APERTURA\" | \"ABIERTO\" | \"CERRADO\">(\r\n    \"SIN_APERTURA\"\r\n  );\r\n  const [cierreId, setCierreId] = useState<string | null>(null);\r\n  const [detalles, setDetalles] = useState<DetalleItem[]>([]);\r\n  const [observaciones, setObservaciones] = useState(\"\");\r\n\r\n  const pointId = selectedPoint?.id;\r\n\r\n  const puedeEditar = useMemo(() => estado === \"ABIERTO\", [estado]);\r\n\r\n  const totalNeto = useMemo(\r\n    () => detalles.reduce((acc, d) => acc + (d.monto_movimientos || 0), 0),\r\n    [detalles]\r\n  );\r\n\r\n  const totalValidado = useMemo(\r\n    () => detalles.reduce((acc, d) => acc + (Number(d.monto_validado) || 0), 0),\r\n    [detalles]\r\n  );\r\n\r\n  const totalDiff = useMemo(\r\n    () => Math.abs(totalValidado - totalNeto),\r\n    [totalValidado, totalNeto]\r\n  );\r\n\r\n  // Tolerancia global ┬▒1.00 USD\r\n  const dentroTolerancia = totalDiff <= 1.0 + 1e-9;\r\n\r\n  const cargarStatus = async () => {\r\n    if (!pointId) return;\r\n    try {\r\n      setLoading(true);\r\n      const data = await statusCierreServiciosExternos({ pointId });\r\n      if (!data.success) throw new Error(\"No se pudo obtener estado\");\r\n\r\n      const cierre = data.cierre;\r\n      setEstado(\r\n        cierre?.estado === \"CERRADO\"\r\n          ? \"CERRADO\"\r\n          : cierre\r\n          ? \"ABIERTO\"\r\n          : \"SIN_APERTURA\"\r\n      );\r\n      setCierreId(cierre?.id || null);\r\n\r\n      // Normalizar detalles a estructura editable\r\n      const items: DetalleItem[] = (data.detalles || []).map((d) => ({\r\n        servicio: d.servicio,\r\n        moneda_id: d.moneda_id,\r\n        monto_movimientos: Number(d.monto_movimientos || 0),\r\n        monto_validado: Number(d.monto_validado ?? d.monto_movimientos ?? 0),\r\n        diferencia: Number(d.diferencia ?? 0),\r\n        observaciones: d.observaciones || \"\",\r\n      }));\r\n\r\n      // Si backend no devuelve detalles pero hay resumen_movimientos, construir base\r\n      if (items.length === 0 && Array.isArray(data.resumen_movimientos)) {\r\n        data.resumen_movimientos.forEach((r) => {\r\n          items.push({\r\n            servicio: r.servicio,\r\n            moneda_id: \"USD\",\r\n            monto_movimientos: Number(r.neto || 0),\r\n            monto_validado: Number(r.neto || 0),\r\n            diferencia: 0,\r\n            observaciones: \"\",\r\n          });\r\n        });\r\n      }\r\n\r\n      setDetalles(items);\r\n      setObservaciones(\"\");\r\n    } catch (e) {\r\n      console.error(\"Error status servicios externos:\", e);\r\n      toast({\r\n        title: \"Error\",\r\n        description: \"No se pudo cargar el estado de servicios externos\",\r\n        variant: \"destructive\",\r\n      });\r\n    } finally {\r\n      setLoading(false);\r\n    }\r\n  };\r\n\r\n  useEffect(() => {\r\n    cargarStatus();\r\n    // eslint-disable-next-line react-hooks/exhaustive-deps\r\n  }, [pointId]);\r\n\r\n  const abrirCierre = async () => {\r\n    if (!pointId) return;\r\n    try {\r\n      setSaving(true);\r\n      const res = await abrirCierreServiciosExternos({ pointId });\r\n      if (!res.success) throw new Error(\"No se pudo abrir el cierre\");\r\n      toast({\r\n        title: \"Cierre abierto\",\r\n        description: \"Ahora puede validar montos\",\r\n      });\r\n      await cargarStatus();\r\n    } catch (e) {\r\n      console.error(e);\r\n      toast({\r\n        title: \"Error\",\r\n        description: \"No se pudo abrir el cierre de servicios externos\",\r\n        variant: \"destructive\",\r\n      });\r\n    } finally {\r\n      setSaving(false);\r\n    }\r\n  };\r\n\r\n  const actualizarMonto = (idx: number, value: string) => {\r\n    setDetalles((prev) => {\r\n      const copy = [...prev];\r\n      const v = Number(value || 0);\r\n      const base = Number(copy[idx].monto_movimientos || 0);\r\n      copy[idx] = {\r\n        ...copy[idx],\r\n        monto_validado: isNaN(v) ? 0 : v,\r\n        diferencia: Number(((isNaN(v) ? 0 : v) - base).toFixed(2)),\r\n      };\r\n      return copy;\r\n    });\r\n  };\r\n\r\n  const actualizarObs = (idx: number, value: string) => {\r\n    setDetalles((prev) => {\r\n      const copy = [...prev];\r\n      copy[idx] = { ...copy[idx], observaciones: value };\r\n      return copy;\r\n    });\r\n  };\r\n\r\n  const cerrarCierre = async () => {\r\n    if (!pointId) return;\r\n    if (estado !== \"ABIERTO\") {\r\n      toast({\r\n        title: \"No disponible\",\r\n        description: \"Debe abrir el cierre primero\",\r\n      });\r\n      return;\r\n    }\r\n\r\n    if (!dentroTolerancia) {\r\n      toast({\r\n        title: \"Fuera de tolerancia\",\r\n        description: \"La diferencia total excede ┬▒1.00 USD\",\r\n        variant: \"destructive\",\r\n      });\r\n      return;\r\n    }\r\n\r\n    try {\r\n      setSaving(true);\r\n      const payload = {\r\n        pointId,\r\n        detalles: detalles.map((d) => ({\r\n          servicio: d.servicio as ServicioExterno,\r\n          monto_validado: Number(d.monto_validado || 0),\r\n          observaciones: d.observaciones || undefined,\r\n        })),\r\n        observaciones: observaciones || undefined,\r\n      };\r\n      const res = await cerrarCierreServiciosExternos(payload);\r\n      if (!res.success) throw new Error(\"No se pudo cerrar el d├¡a\");\r\n      toast({\r\n        title: \"Cierre de servicios externos\",\r\n        description: \"Cerrado correctamente\",\r\n      });\r\n      await cargarStatus();\r\n    } catch (e) {\r\n      console.error(e);\r\n      toast({\r\n        title: \"Error\",\r\n        description: \"No se pudo cerrar el d├¡a\",\r\n        variant: \"destructive\",\r\n      });\r\n    } finally {\r\n      setSaving(false);\r\n    }\r\n  };\r\n\r\n  return (\r\n    <Card>\r\n      <CardHeader>\r\n        <div className=\"flex items-center justify-between\">\r\n          <div>\r\n            <CardTitle>Servicios Externos (USD)</CardTitle>\r\n            <p className=\"text-sm text-gray-500\">\r\n              Validaci├│n con tolerancia ┬▒1.00 USD sobre el neto de movimientos\r\n              del d├¡a\r\n            </p>\r\n          </div>\r\n          <div>\r\n            {estado === \"CERRADO\" ? (\r\n              <Badge variant=\"default\" className=\"bg-green-600\">\r\n                CERRADO\r\n              </Badge>\r\n            ) : estado === \"ABIERTO\" ? (\r\n              <Badge variant=\"secondary\">ABIERTO</Badge>\r\n            ) : (\r\n              <Badge variant=\"outline\">SIN APERTURA</Badge>\r\n            )}\r\n          </div>\r\n        </div>\r\n      </CardHeader>\r\n      <CardContent className=\"space-y-4\">\r\n        {!pointId ? (\r\n          <div className=\"text-gray-500\">\r\n            Seleccione un punto para continuar\r\n          </div>\r\n        ) : (\r\n          <>\r\n            <div className=\"flex items-center gap-2\">\r\n              <Button\r\n                onClick={cargarStatus}\r\n                variant=\"outline\"\r\n                disabled={loading || saving}\r\n              >\r\n                Refrescar\r\n              </Button>\r\n              {estado === \"SIN_APERTURA\" && (\r\n                <Button onClick={abrirCierre} disabled={saving || loading}>\r\n                  Abrir cierre\r\n                </Button>\r\n              )}\r\n              {estado === \"ABIERTO\" && (\r\n                <Button\r\n                  onClick={cerrarCierre}\r\n                  disabled={saving || loading || !dentroTolerancia}\r\n                >\r\n                  Guardar y Cerrar\r\n                </Button>\r\n              )}\r\n            </div>\r\n\r\n            <div className=\"overflow-auto border rounded\">\r\n              <table className=\"w-full text-sm\">\r\n                <thead className=\"bg-gray-50\">\r\n                  <tr>\r\n                    <th className=\"px-3 py-2 text-left\">Servicio</th>\r\n                    <th className=\"px-3 py-2 text-right\">\r\n                      Neto movimientos (USD)\r\n                    </th>\r\n                    <th className=\"px-3 py-2 text-right\">\r\n                      Monto validado (USD)\r\n                    </th>\r\n                    <th className=\"px-3 py-2 text-right\">Diferencia</th>\r\n                  </tr>\r\n                </thead>\r\n                <tbody>\r\n                  {detalles.length === 0 ? (\r\n                    <tr>\r\n                      <td\r\n                        colSpan={4}\r\n                        className=\"px-3 py-4 text-center text-gray-400\"\r\n                      >\r\n                        {loading\r\n                          ? \"Cargando...\"\r\n                          : \"No hay servicios registrados hoy\"}\r\n                      </td>\r\n                    </tr>\r\n                  ) : (\r\n                    detalles.map((d, idx) => {\r\n                      const diffAbs = Math.abs(\r\n                        Number(d.monto_validado || 0) -\r\n                          Number(d.monto_movimientos || 0)\r\n                      );\r\n                      const ok = diffAbs <= 1.0 + 1e-9;\r\n                      return (\r\n                        <tr key={`${d.servicio}-${idx}`} className=\"border-t\">\r\n                          <td className=\"px-3 py-2\">{d.servicio}</td>\r\n                          <td className=\"px-3 py-2 text-right\">\r\n                            {Number(d.monto_movimientos || 0).toFixed(2)}\r\n                          </td>\r\n                          <td className=\"px-3 py-2 text-right\">\r\n                            <Input\r\n                              type=\"number\"\r\n                              step=\"0.01\"\r\n                              inputMode=\"decimal\"\r\n                              value={String(d.monto_validado ?? \"\")}\r\n                              disabled={!puedeEditar}\r\n                              onChange={(e) =>\r\n                                actualizarMonto(idx, e.target.value)\r\n                              }\r\n                              className=\"text-right\"\r\n                            />\r\n                            <div className=\"mt-2\">\r\n                              <Label\r\n                                htmlFor={`obs-${idx}`}\r\n                                className=\"text-xs text-gray-500\"\r\n                              >\r\n                                Observaciones\r\n                              </Label>\r\n                              <Input\r\n                                id={`obs-${idx}`}\r\n                                value={d.observaciones || \"\"}\r\n                                disabled={!puedeEditar}\r\n                                onChange={(e) =>\r\n                                  actualizarObs(idx, e.target.value)\r\n                                }\r\n                              />\r\n                            </div>\r\n                          </td>\r\n                          <td className=\"px-3 py-2 text-right\">\r\n                            <span\r\n                              className={ok ? \"text-green-600\" : \"text-red-600\"}\r\n                            >\r\n                              {(\r\n                                Number(d.monto_validado || 0) -\r\n                                Number(d.monto_movimientos || 0)\r\n                              ).toFixed(2)}\r\n                            </span>\r\n                          </td>\r\n                        </tr>\r\n                      );\r\n                    })\r\n                  )}\r\n                </tbody>\r\n                {detalles.length > 0 && (\r\n                  <tfoot>\r\n                    <tr className=\"border-t bg-gray-50\">\r\n                      <td className=\"px-3 py-2 font-medium\">Totales</td>\r\n                      <td className=\"px-3 py-2 text-right font-mono\">\r\n                        {totalNeto.toFixed(2)}\r\n                      </td>\r\n                      <td className=\"px-3 py-2 text-right font-mono\">\r\n                        {totalValidado.toFixed(2)}\r\n                      </td>\r\n                      <td className=\"px-3 py-2 text-right\">\r\n                        <Badge\r\n                          variant={dentroTolerancia ? \"default\" : \"destructive\"}\r\n                          className={\r\n                            dentroTolerancia ? \"bg-green-600\" : undefined\r\n                          }\r\n                        >\r\n                          ┬▒{totalDiff.toFixed(2)}\r\n                        </Badge>\r\n                      </td>\r\n                    </tr>\r\n                  </tfoot>\r\n                )}\r\n              </table>\r\n            </div>\r\n\r\n            <div>\r\n              <Label className=\"mb-1 block\">Observaciones generales</Label>\r\n              <Input\r\n                placeholder=\"Opcional\"\r\n                value={observaciones}\r\n                onChange={(e) => setObservaciones(e.target.value)}\r\n                disabled={!puedeEditar}\r\n              />\r\n            </div>\r\n\r\n            {estado === \"CERRADO\" && (\r\n              <div className=\"text-sm text-gray-500\">Cierre ID: {cierreId}</div>\r\n            )}\r\n          </>\r\n        )}\r\n      </CardContent>\r\n    </Card>\r\n  );\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\oswal\\OneDrive\\Documentos\\Punto Cambio\\punto_cambio_new\\src\\components\\contabilidad\\ContabilidadDashboard.tsx","messages":[{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'error' is assigned a value but never used. Allowed unused vars must match /^_/u.","line":49,"column":43,"nodeType":null,"messageId":"unusedVar","endLine":49,"endColumn":48},{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'balanceCompleto' is assigned a value but never used. Allowed unused vars must match /^_/u.","line":92,"column":10,"nodeType":null,"messageId":"unusedVar","endLine":92,"endColumn":25},{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'setBalanceCompleto' is assigned a value but never used. Allowed unused vars must match /^_/u.","line":92,"column":27,"nodeType":null,"messageId":"unusedVar","endLine":92,"endColumn":45},{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'loadingBalanceCompleto' is assigned a value but never used. Allowed unused vars must match /^_/u.","line":93,"column":10,"nodeType":null,"messageId":"unusedVar","endLine":93,"endColumn":32},{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'setLoadingBalanceCompleto' is assigned a value but never used. Allowed unused vars must match /^_/u.","line":93,"column":34,"nodeType":null,"messageId":"unusedVar","endLine":93,"endColumn":59},{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'showBalanceCompleto' is assigned a value but never used. Allowed unused vars must match /^_/u.","line":94,"column":10,"nodeType":null,"messageId":"unusedVar","endLine":94,"endColumn":29},{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'setShowBalanceCompleto' is assigned a value but never used. Allowed unused vars must match /^_/u.","line":94,"column":31,"nodeType":null,"messageId":"unusedVar","endLine":94,"endColumn":53}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":7,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import { useState, useEffect } from \"react\";\r\nimport { Card, CardContent, CardHeader, CardTitle } from \"@/components/ui/card\";\r\n// Tabs removidos\r\nimport { Button } from \"@/components/ui/button\";\r\nimport { Badge } from \"@/components/ui/badge\";\r\nimport {\r\n  Calculator,\r\n  TrendingUp,\r\n  TrendingDown,\r\n  RefreshCw,\r\n  AlertTriangle,\r\n  CheckCircle,\r\n  DollarSign,\r\n  BarChart3,\r\n} from \"lucide-react\";\r\nimport { User, PuntoAtencion, Moneda } from \"@/types\";\r\nimport { useContabilidadDivisas } from \"@/hooks/useContabilidadDivisas\";\r\nimport { useContabilidadAdmin } from \"@/hooks/useContabilidadAdmin\";\r\nimport { currencyService } from \"@/services/currencyService\";\r\nimport { gyeDayRangeUtcFromDate } from \"@/utils/timezone\";\r\nimport SaldosDivisasEnTiempoReal from \"./SaldosDivisasEnTiempoReal\";\r\nimport HistorialMovimientos from \"./HistorialMovimientos\";\r\n\r\n// NUEVOS imports para colapsables y switch\r\nimport {\r\n  Collapsible,\r\n  CollapsibleContent,\r\n  CollapsibleTrigger,\r\n} from \"@/components/ui/collapsible\";\r\nimport { Switch } from \"@/components/ui/switch\";\r\n\r\ninterface ContabilidadDashboardProps {\r\n  user: User;\r\n  selectedPoint: PuntoAtencion | null;\r\n  currencies?: Moneda[];\r\n  isAdminView?: boolean;\r\n}\r\n\r\nexport const ContabilidadDashboard = ({\r\n  user,\r\n  selectedPoint,\r\n  currencies: propCurrencies,\r\n  isAdminView = false,\r\n}: ContabilidadDashboardProps) => {\r\n  // Usar hook apropiado seg├║n si es vista de administrador\r\n  const contabilidadNormal = useContabilidadDivisas({ user, selectedPoint });\r\n  const contabilidadAdmin = useContabilidadAdmin({ user });\r\n\r\n  const { saldos, movimientos, isLoading, error, refresh } = isAdminView\r\n    ? user.rol === \"ADMIN\" || user.rol === \"SUPER_USUARIO\"\r\n      ? {\r\n          saldos: contabilidadAdmin.saldosConsolidados,\r\n          movimientos: contabilidadAdmin.movimientosConsolidados,\r\n          isLoading: contabilidadAdmin.isLoading,\r\n          error: contabilidadAdmin.error,\r\n          refresh: contabilidadAdmin.refresh,\r\n        }\r\n      : {\r\n          saldos: [],\r\n          movimientos: [],\r\n          isLoading: false,\r\n          error: \"Permisos insuficientes\",\r\n          refresh: () => {},\r\n        }\r\n    : contabilidadNormal;\r\n\r\n  const [currencies, setCurrencies] = useState<Moneda[]>(propCurrencies || []);\r\n  const [loadingCurrencies, setLoadingCurrencies] = useState(!propCurrencies);\r\n\r\n  const [estadisticas, setEstadisticas] = useState({\r\n    totalIngresos: 0,\r\n    totalEgresos: 0,\r\n    totalCambios: 0,\r\n    saldoPositivo: 0,\r\n    saldoNegativo: 0,\r\n    monedaPrincipalSaldo: 0,\r\n    // Nuevos campos para desglose\r\n    ingresosPorMoneda: [] as { codigo: string; monto: number }[],\r\n    egresosPorMoneda: [] as { codigo: string; monto: number }[],\r\n  });\r\n\r\n  // Totales consolidados por moneda (solo relevante en vista admin)\r\n  const [totalesPorMoneda, setTotalesPorMoneda] = useState<\r\n    { codigo: string; total: number }[]\r\n  >([]);\r\n\r\n  // VISIBILIDAD de secciones (novedad)\r\n  const [showMovimientos, setShowMovimientos] = useState(true);\r\n  const [showSaldos, setShowSaldos] = useState(false); // saldos cerrado por defecto\r\n\r\n  // Estado para balance completo\r\n  const [balanceCompleto, setBalanceCompleto] = useState<unknown>(null);\r\n  const [loadingBalanceCompleto, setLoadingBalanceCompleto] = useState(false);\r\n  const [showBalanceCompleto, setShowBalanceCompleto] = useState(true);\r\n\r\n  // Cargar monedas si no se proporcionaron\r\n  useEffect(() => {\r\n    const loadCurrencies = async () => {\r\n      if (propCurrencies) {\r\n        setCurrencies(propCurrencies);\r\n        setLoadingCurrencies(false);\r\n        return;\r\n      }\r\n\r\n      try {\r\n        setLoadingCurrencies(true);\r\n        const { currencies: fetchedCurrencies, error: currencyError } =\r\n          await currencyService.getAllCurrencies();\r\n\r\n        if (currencyError) {\r\n          console.error(\"Error al cargar monedas:\", currencyError);\r\n        } else {\r\n          setCurrencies(fetchedCurrencies);\r\n        }\r\n      } catch (err) {\r\n        console.error(\"Error inesperado al cargar monedas:\", err);\r\n      } finally {\r\n        setLoadingCurrencies(false);\r\n      }\r\n    };\r\n\r\n    loadCurrencies();\r\n  }, [propCurrencies]);\r\n\r\n  // Calcular estad├¡sticas\r\n  useEffect(() => {\r\n    // Usar timezone de Guayaquil para determinar \"hoy\"\r\n    const hoy = new Date();\r\n    const { gte: inicioHoy, lt: finHoy } = gyeDayRangeUtcFromDate(hoy);\r\n\r\n    if (movimientos.length > 0 || saldos.length > 0) {\r\n      const movimientosHoy = movimientos.filter((mov) => {\r\n        const fechaMov = new Date(mov.fecha);\r\n        return fechaMov >= inicioHoy && fechaMov < finHoy;\r\n      });\r\n\r\n      // Agrupar ingresos por moneda\r\n      const ingresosMap = new Map<string, number>();\r\n      movimientosHoy\r\n        .filter(\r\n          (mov) =>\r\n            mov.tipo_movimiento === \"INGRESO\" ||\r\n            mov.tipo_movimiento === \"TRANSFERENCIA_ENTRANTE\" ||\r\n            mov.tipo_movimiento === \"TRANSFERENCIA_ENTRADA\"\r\n        )\r\n        .forEach((mov) => {\r\n          const codigo = mov.moneda_codigo || \"USD\";\r\n          ingresosMap.set(\r\n            codigo,\r\n            (ingresosMap.get(codigo) || 0) + Math.abs(mov.monto)\r\n          );\r\n        });\r\n\r\n      // Agrupar egresos por moneda\r\n      const egresosMap = new Map<string, number>();\r\n      movimientosHoy\r\n        .filter(\r\n          (mov) =>\r\n            mov.tipo_movimiento === \"EGRESO\" ||\r\n            mov.tipo_movimiento === \"TRANSFERENCIA_SALIENTE\" ||\r\n            mov.tipo_movimiento === \"TRANSFERENCIA_SALIDA\"\r\n        )\r\n        .forEach((mov) => {\r\n          const codigo = mov.moneda_codigo || \"USD\";\r\n          egresosMap.set(\r\n            codigo,\r\n            (egresosMap.get(codigo) || 0) + Math.abs(mov.monto)\r\n          );\r\n        });\r\n\r\n      // Convertir a arrays para mostrar\r\n      const ingresosPorMoneda = Array.from(ingresosMap.entries())\r\n        .map(([codigo, monto]) => ({ codigo, monto }))\r\n        .sort((a, b) => b.monto - a.monto);\r\n\r\n      const egresosPorMoneda = Array.from(egresosMap.entries())\r\n        .map(([codigo, monto]) => ({ codigo, monto }))\r\n        .sort((a, b) => b.monto - a.monto);\r\n\r\n      // Solo sumar USD para el total (evitar mezclar monedas)\r\n      const ingresos = ingresosMap.get(\"USD\") || 0;\r\n      const egresos = egresosMap.get(\"USD\") || 0;\r\n\r\n      // Contar cambios como cantidad de transacciones ├║nicas (referencia_id) con tipo_referencia CAMBIO_DIVISA\r\n      const cambios = (() => {\r\n        const setRefs = new Set<string>();\r\n        for (const mov of movimientosHoy) {\r\n          if (mov.tipo_referencia === \"CAMBIO_DIVISA\" && mov.referencia_id) {\r\n            setRefs.add(mov.referencia_id);\r\n          }\r\n        }\r\n        return setRefs.size;\r\n      })();\r\n\r\n      const saldosPositivos = saldos.filter((s) => s.saldo > 0).length;\r\n      const saldosNegativos = saldos.filter((s) => s.saldo < 0).length;\r\n\r\n      // Suma USD en todos los puntos (vista admin) o solo del punto (vista normal)\r\n      const saldosUSD = saldos.filter((s) => s.moneda_codigo === \"USD\");\r\n      const usdSaldo = isAdminView\r\n        ? saldosUSD.reduce((acc, s) => acc + s.saldo, 0)\r\n        : saldos.find((s) => s.moneda_codigo === \"USD\")?.saldo || 0;\r\n\r\n      // Totales por moneda (para tarjetas por divisa)\r\n      const map = new Map<string, number>();\r\n      for (const s of saldos) {\r\n        map.set(s.moneda_codigo, (map.get(s.moneda_codigo) || 0) + s.saldo);\r\n      }\r\n      const totales = Array.from(map.entries()).map(([codigo, total]) => ({\r\n        codigo,\r\n        total,\r\n      }));\r\n      setTotalesPorMoneda(totales);\r\n\r\n      setEstadisticas({\r\n        totalIngresos: ingresos,\r\n        totalEgresos: egresos,\r\n        totalCambios: cambios,\r\n        saldoPositivo: saldosPositivos,\r\n        saldoNegativo: saldosNegativos,\r\n        monedaPrincipalSaldo: usdSaldo,\r\n        ingresosPorMoneda,\r\n        egresosPorMoneda,\r\n      });\r\n    }\r\n  }, [movimientos, saldos, isAdminView]);\r\n\r\n  // Escuchar eventos de actualizaci├│n de saldos\r\n  useEffect(() => {\r\n    const handleSaldosUpdated = () => {\r\n      refresh();\r\n    };\r\n\r\n    window.addEventListener(\"saldosUpdated\", handleSaldosUpdated);\r\n    window.addEventListener(\"exchangeCompleted\", handleSaldosUpdated);\r\n\r\n    return () => {\r\n      window.removeEventListener(\"saldosUpdated\", handleSaldosUpdated);\r\n      window.removeEventListener(\"exchangeCompleted\", handleSaldosUpdated);\r\n    };\r\n  }, [refresh]);\r\n\r\n  const formatCurrency = (amount: number, codigo = \"USD\") => {\r\n    if (codigo === \"USD\") {\r\n      return new Intl.NumberFormat(\"en-US\", {\r\n        style: \"currency\",\r\n        currency: \"USD\",\r\n        minimumFractionDigits: 2,\r\n      }).format(amount);\r\n    }\r\n\r\n    return new Intl.NumberFormat(\"es-ES\", {\r\n      minimumFractionDigits: 2,\r\n      maximumFractionDigits: 2,\r\n    }).format(amount);\r\n  };\r\n\r\n  if (!selectedPoint && !isAdminView) {\r\n    return (\r\n      <div className=\"p-6 text-center py-12\">\r\n        <Calculator className=\"h-16 w-16 mx-auto mb-4 text-gray-400\" />\r\n        <h2 className=\"text-xl font-semibold text-gray-600 mb-2\">\r\n          Sistema Contable de Divisas\r\n        </h2>\r\n        <p className=\"text-gray-500\">\r\n          Seleccione un punto de atenci├│n para ver la informaci├│n contable\r\n        </p>\r\n      </div>\r\n    );\r\n  }\r\n\r\n  if (loadingCurrencies) {\r\n    return (\r\n      <div className=\"p-6 text-center py-12\">\r\n        <div className=\"animate-spin rounded-full h-12 w-12 border-b-2 border-blue-600 mx-auto mb-4\"></div>\r\n        <p className=\"text-gray-600\">Cargando informaci├│n contable...</p>\r\n      </div>\r\n    );\r\n  }\r\n\r\n  return (\r\n    <div className=\"h-full flex flex-col gap-4\">\r\n      {/* Encabezado + bot├│n de refresco - Compacto */}\r\n      <div className=\"flex items-center justify-between flex-shrink-0\">\r\n        <div>\r\n          <h1 className=\"text-lg font-bold text-gray-800 flex items-center gap-2\">\r\n            <Calculator className=\"h-5 w-5 text-blue-600\" />\r\n            {isAdminView ? \"Contabilidad General\" : \"Contabilidad de Divisas\"}\r\n          </h1>\r\n          <p className=\"text-xs text-gray-600\">\r\n            {isAdminView\r\n              ? \"Vista consolidada de todos los puntos\"\r\n              : `${selectedPoint?.nombre}`}\r\n          </p>\r\n        </div>\r\n        <Button\r\n          onClick={refresh}\r\n          disabled={isLoading}\r\n          variant=\"outline\"\r\n          size=\"sm\"\r\n        >\r\n          <RefreshCw\r\n            className={`h-4 w-4 mr-2 ${isLoading ? \"animate-spin\" : \"\"}`}\r\n          />\r\n          Actualizar\r\n        </Button>\r\n      </div>\r\n\r\n      {/* Estad├¡sticas del d├¡a - Compactas */}\r\n      <div className=\"grid grid-cols-2 lg:grid-cols-4 gap-3 flex-shrink-0\">\r\n        <Card>\r\n          <CardContent className=\"p-3\">\r\n            <div className=\"flex items-center justify-between\">\r\n              <div className=\"flex-1 min-w-0\">\r\n                <p className=\"text-xs font-medium text-gray-600 truncate\">\r\n                  Ingresos Hoy\r\n                </p>\r\n                <p className=\"text-lg font-bold text-green-600 truncate\">\r\n                  {formatCurrency(estadisticas.totalIngresos)}\r\n                </p>\r\n              </div>\r\n              <TrendingUp className=\"h-6 w-6 text-green-600 flex-shrink-0 ml-2\" />\r\n            </div>\r\n            {estadisticas.ingresosPorMoneda.length > 1 && (\r\n              <div className=\"mt-2 pt-2 border-t border-gray-200\">\r\n                <p className=\"text-xs text-gray-500 mb-1\">Otras monedas:</p>\r\n                <div className=\"space-y-1\">\r\n                  {estadisticas.ingresosPorMoneda\r\n                    .filter((item) => item.codigo !== \"USD\")\r\n                    .slice(0, 3)\r\n                    .map((item) => (\r\n                      <div\r\n                        key={item.codigo}\r\n                        className=\"flex justify-between text-xs\"\r\n                      >\r\n                        <span className=\"text-gray-600\">{item.codigo}:</span>\r\n                        <span className=\"font-semibold text-green-700\">\r\n                          {formatCurrency(item.monto, item.codigo)}\r\n                        </span>\r\n                      </div>\r\n                    ))}\r\n                </div>\r\n              </div>\r\n            )}\r\n          </CardContent>\r\n        </Card>\r\n\r\n        <Card>\r\n          <CardContent className=\"p-3\">\r\n            <div className=\"flex items-center justify-between\">\r\n              <div className=\"flex-1 min-w-0\">\r\n                <p className=\"text-xs font-medium text-gray-600 truncate\">\r\n                  Egresos Hoy\r\n                </p>\r\n                <p className=\"text-lg font-bold text-red-600 truncate\">\r\n                  {formatCurrency(estadisticas.totalEgresos)}\r\n                </p>\r\n              </div>\r\n              <TrendingDown className=\"h-6 w-6 text-red-600 flex-shrink-0 ml-2\" />\r\n            </div>\r\n            {estadisticas.egresosPorMoneda.length > 1 && (\r\n              <div className=\"mt-2 pt-2 border-t border-gray-200\">\r\n                <p className=\"text-xs text-gray-500 mb-1\">Otras monedas:</p>\r\n                <div className=\"space-y-1\">\r\n                  {estadisticas.egresosPorMoneda\r\n                    .filter((item) => item.codigo !== \"USD\")\r\n                    .slice(0, 3)\r\n                    .map((item) => (\r\n                      <div\r\n                        key={item.codigo}\r\n                        className=\"flex justify-between text-xs\"\r\n                      >\r\n                        <span className=\"text-gray-600\">{item.codigo}:</span>\r\n                        <span className=\"font-semibold text-red-700\">\r\n                          {formatCurrency(item.monto, item.codigo)}\r\n                        </span>\r\n                      </div>\r\n                    ))}\r\n                </div>\r\n              </div>\r\n            )}\r\n          </CardContent>\r\n        </Card>\r\n\r\n        <Card>\r\n          <CardContent className=\"p-3\">\r\n            <div className=\"flex items-center justify-between\">\r\n              <div className=\"flex-1 min-w-0\">\r\n                <p className=\"text-xs font-medium text-gray-600 truncate\">\r\n                  Cambios Hoy\r\n                </p>\r\n                <p className=\"text-lg font-bold text-blue-600 truncate\">\r\n                  {estadisticas.totalCambios}\r\n                </p>\r\n              </div>\r\n              <BarChart3 className=\"h-6 w-6 text-blue-600 flex-shrink-0 ml-2\" />\r\n            </div>\r\n          </CardContent>\r\n        </Card>\r\n\r\n        <Card>\r\n          <CardContent className=\"p-3\">\r\n            <div className=\"flex items-center justify-between\">\r\n              <div className=\"flex-1 min-w-0\">\r\n                <p className=\"text-xs font-medium text-gray-600 truncate\">\r\n                  USD (Principal)\r\n                </p>\r\n                <p\r\n                  className={`text-lg font-bold truncate ${\r\n                    estadisticas.monedaPrincipalSaldo >= 0\r\n                      ? \"text-green-600\"\r\n                      : \"text-red-600\"\r\n                  }`}\r\n                >\r\n                  {formatCurrency(estadisticas.monedaPrincipalSaldo)}\r\n                </p>\r\n              </div>\r\n              <DollarSign className=\"h-6 w-6 text-green-600 flex-shrink-0 ml-2\" />\r\n            </div>\r\n          </CardContent>\r\n        </Card>\r\n      </div>\r\n\r\n      {/* Contenido scrolleable */}\r\n      <div className=\"flex-1 min-h-0 overflow-y-auto space-y-4\">\r\n        {/* Estado general del sistema */}\r\n        <Card>\r\n          <CardHeader className=\"pb-2\">\r\n            <CardTitle className=\"text-sm\">\r\n              Estado del Sistema Contable\r\n            </CardTitle>\r\n          </CardHeader>\r\n          <CardContent>\r\n            <div className=\"grid grid-cols-1 md:grid-cols-3 gap-4\">\r\n              <div className=\"flex items-center gap-3\">\r\n                {estadisticas.saldoNegativo === 0 ? (\r\n                  <CheckCircle className=\"h-5 w-5 text-green-600\" />\r\n                ) : (\r\n                  <AlertTriangle className=\"h-5 w-5 text-red-600\" />\r\n                )}\r\n                <div>\r\n                  <p className=\"font-medium\">Saldos Negativos</p>\r\n                  <p className=\"text-sm text-gray-600\">\r\n                    {estadisticas.saldoNegativo} de {saldos.length} monedas\r\n                  </p>\r\n                </div>\r\n              </div>\r\n\r\n              <div className=\"flex items-center gap-3\">\r\n                <CheckCircle className=\"h-5 w-5 text-green-600\" />\r\n                <div>\r\n                  <p className=\"font-medium\">Saldos Positivos</p>\r\n                  <p className=\"text-sm text-gray-600\">\r\n                    {estadisticas.saldoPositivo} de {saldos.length} monedas\r\n                  </p>\r\n                </div>\r\n              </div>\r\n\r\n              <div className=\"flex items-center gap-3\">\r\n                <BarChart3 className=\"h-5 w-5 text-blue-600\" />\r\n                <div>\r\n                  <p className=\"font-medium\">Balance del D├¡a</p>\r\n                  <p\r\n                    className={`text-sm font-semibold ${\r\n                      estadisticas.totalIngresos - estadisticas.totalEgresos >=\r\n                      0\r\n                        ? \"text-green-600\"\r\n                        : \"text-red-600\"\r\n                    }`}\r\n                  >\r\n                    {formatCurrency(\r\n                      estadisticas.totalIngresos - estadisticas.totalEgresos\r\n                    )}\r\n                  </p>\r\n                </div>\r\n              </div>\r\n            </div>\r\n\r\n            {isAdminView && totalesPorMoneda.length > 0 && (\r\n              <div className=\"mt-6\">\r\n                <h4 className=\"font-semibold mb-3\">\r\n                  Totales por Divisa (Consolidado)\r\n                </h4>\r\n                <div className=\"grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-3\">\r\n                  {totalesPorMoneda\r\n                    .sort((a, b) =>\r\n                      a.codigo === \"USD\" ? -1 : a.codigo.localeCompare(b.codigo)\r\n                    )\r\n                    .map((t) => (\r\n                      <Card key={t.codigo}>\r\n                        <CardContent className=\"p-3\">\r\n                          <div className=\"flex items-center justify-between\">\r\n                            <div>\r\n                              <p className=\"text-xs text-gray-500\">\r\n                                {t.codigo}\r\n                              </p>\r\n                              <p className=\"text-lg font-semibold\">\r\n                                {formatCurrency(t.total, t.codigo)}\r\n                              </p>\r\n                            </div>\r\n                            <DollarSign className=\"h-5 w-5 text-gray-400\" />\r\n                          </div>\r\n                        </CardContent>\r\n                      </Card>\r\n                    ))}\r\n                </div>\r\n              </div>\r\n            )}\r\n          </CardContent>\r\n        </Card>\r\n\r\n        {/* =========================\r\n          TOOLBAR PEGAJOSO DE FILTROS\r\n          ========================= */}\r\n        <div className=\"sticky top-0 z-10 -mx-2 px-2 py-2 bg-white/70 backdrop-blur supports-[backdrop-filter]:bg-white/50 border rounded-md\">\r\n          <div className=\"flex flex-wrap items-center gap-4\">\r\n            <div className=\"flex items-center gap-2\">\r\n              <span className=\"text-sm text-muted-foreground\">Mostrar</span>\r\n              {/* Switches de visibilidad */}\r\n              <div className=\"flex items-center gap-4\">\r\n                <label className=\"flex items-center gap-2 text-sm\">\r\n                  <Switch\r\n                    checked={showMovimientos}\r\n                    onCheckedChange={setShowMovimientos}\r\n                  />\r\n                  <span>Movimientos</span>\r\n                </label>\r\n                <label className=\"flex items-center gap-2 text-sm\">\r\n                  <Switch\r\n                    checked={showSaldos}\r\n                    onCheckedChange={setShowSaldos}\r\n                  />\r\n                  <span>Saldos por divisa</span>\r\n                </label>\r\n              </div>\r\n            </div>\r\n\r\n            <div className=\"ml-auto flex items-center gap-2\">\r\n              <Button\r\n                variant=\"outline\"\r\n                size=\"sm\"\r\n                onClick={() => {\r\n                  refresh?.();\r\n                }}\r\n              >\r\n                <RefreshCw\r\n                  className={`h-4 w-4 ${isLoading ? \"animate-spin\" : \"\"}`}\r\n                />\r\n              </Button>\r\n            </div>\r\n          </div>\r\n        </div>\r\n\r\n        {/* Secci├│n: Historial de Movimientos (abierta por defecto) */}\r\n        <Collapsible open={showMovimientos} onOpenChange={setShowMovimientos}>\r\n          <Card className=\"mt-3\">\r\n            <CardHeader className=\"flex flex-row items-center justify-between py-3\">\r\n              <CardTitle className=\"text-base font-semibold flex items-center gap-2\">\r\n                <BarChart3 className=\"h-5 w-5\" />\r\n                Historial de Movimientos\r\n              </CardTitle>\r\n              <CollapsibleTrigger asChild>\r\n                <Button variant=\"ghost\" size=\"sm\">\r\n                  {showMovimientos ? \"Ocultar\" : \"Mostrar\"}\r\n                </Button>\r\n              </CollapsibleTrigger>\r\n            </CardHeader>\r\n            <CollapsibleContent>\r\n              <CardContent className=\"pt-0\">\r\n                <HistorialMovimientos\r\n                  user={user}\r\n                  selectedPoint={selectedPoint}\r\n                  currencies={currencies}\r\n                  isAdminView={isAdminView}\r\n                />\r\n              </CardContent>\r\n            </CollapsibleContent>\r\n          </Card>\r\n        </Collapsible>\r\n\r\n        {/* Secci├│n: Saldos por divisa (cerrada por defecto) */}\r\n        <Collapsible open={showSaldos} onOpenChange={setShowSaldos}>\r\n          <Card className=\"mt-3\">\r\n            <CardHeader className=\"flex flex-row items-center justify-between py-3\">\r\n              <CardTitle className=\"text-base font-semibold flex items-center gap-2\">\r\n                <DollarSign className=\"h-5 w-5\" />\r\n                Saldos por divisa (en tiempo real)\r\n                {isAdminView && (\r\n                  <Badge variant=\"secondary\" className=\"ml-2\">\r\n                    Vista Admin\r\n                  </Badge>\r\n                )}\r\n              </CardTitle>\r\n              <CollapsibleTrigger asChild>\r\n                <Button variant=\"ghost\" size=\"sm\">\r\n                  {showSaldos ? \"Ocultar\" : \"Mostrar\"}\r\n                </Button>\r\n              </CollapsibleTrigger>\r\n            </CardHeader>\r\n            <CollapsibleContent>\r\n              <CardContent className=\"pt-0\">\r\n                <SaldosDivisasEnTiempoReal\r\n                  user={user}\r\n                  selectedPoint={selectedPoint}\r\n                  isAdminView={isAdminView}\r\n                  // Si luego quieres vista resumida primero, puedes pasar \"compact\"\r\n                  // compact\r\n                />\r\n              </CardContent>\r\n            </CollapsibleContent>\r\n          </Card>\r\n        </Collapsible>\r\n\r\n        {/* Informaci├│n adicional */}\r\n        <Card>\r\n          <CardHeader>\r\n            <CardTitle className=\"text-lg\">Informaci├│n del Sistema</CardTitle>\r\n          </CardHeader>\r\n          <CardContent>\r\n            <div className=\"grid grid-cols-1 md:grid-cols-2 gap-6\">\r\n              <div>\r\n                <h4 className=\"font-semibold mb-2\">\r\n                  Funcionamiento Autom├ítico\r\n                </h4>\r\n                <ul className=\"text-sm text-gray-600 space-y-1\">\r\n                  <li>\r\n                    ÔÇó Los saldos se actualizan autom├íticamente con cada cambio\r\n                  </li>\r\n                  <li>ÔÇó Se registra cada movimiento de entrada y salida</li>\r\n                  <li>\r\n                    ÔÇó La moneda principal (USD) es la referencia del sistema\r\n                  </li>\r\n                  <li>ÔÇó Los movimientos se auditan completamente</li>\r\n                </ul>\r\n              </div>\r\n              <div>\r\n                <h4 className=\"font-semibold mb-2\">Tipos de Movimientos</h4>\r\n                <div className=\"space-y-2\">\r\n                  <Badge className=\"bg-green-100 text-green-800\">Ingreso</Badge>\r\n                  <Badge className=\"bg-red-100 text-red-800\">Egreso</Badge>\r\n                  <Badge className=\"bg-blue-100 text-blue-800\">\r\n                    Cambio de Divisa\r\n                  </Badge>\r\n                  <Badge className=\"bg-purple-100 text-purple-800\">\r\n                    Transferencia\r\n                  </Badge>\r\n                </div>\r\n              </div>\r\n            </div>\r\n          </CardContent>\r\n        </Card>\r\n      </div>\r\n    </div>\r\n  );\r\n};\r\n\r\nexport default ContabilidadDashboard;\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\oswal\\OneDrive\\Documentos\\Punto Cambio\\punto_cambio_new\\src\\components\\contabilidad\\HistorialMovimientos.tsx","messages":[{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'Badge' is defined but never used. Allowed unused vars must match /^_/u.","line":5,"column":10,"nodeType":null,"messageId":"unusedVar","endLine":5,"endColumn":15},{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'refresh' is assigned a value but never used. Allowed unused vars must match /^_/u.","line":70,"column":42,"nodeType":null,"messageId":"unusedVar","endLine":70,"endColumn":49}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":2,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import { useEffect, useMemo, useState } from \"react\";\r\nimport { Card, CardContent, CardHeader, CardTitle } from \"@/components/ui/card\";\r\nimport { Input } from \"@/components/ui/input\";\r\nimport { Button } from \"@/components/ui/button\";\r\nimport { Badge } from \"@/components/ui/badge\";\r\nimport {\r\n  Select,\r\n  SelectContent,\r\n  SelectItem,\r\n  SelectTrigger,\r\n  SelectValue,\r\n} from \"@/components/ui/select\";\r\nimport {\r\n  ArrowDownWideNarrow,\r\n  ArrowUpNarrowWide,\r\n  CalendarDays,\r\n  Loader2,\r\n  RefreshCw,\r\n  Search,\r\n  Wallet,\r\n  Download,\r\n} from \"lucide-react\";\r\nimport { User, PuntoAtencion, Moneda } from \"@/types\";\r\nimport { useContabilidadDivisas } from \"@/hooks/useContabilidadDivisas\";\r\nimport { useContabilidadAdmin } from \"@/hooks/useContabilidadAdmin\";\r\nimport { Loading } from \"@/components/ui/loading\";\r\n\r\n// Dropdown con checkboxes (shadcn)\r\nimport {\r\n  DropdownMenu,\r\n  DropdownMenuTrigger,\r\n  DropdownMenuContent,\r\n  DropdownMenuLabel,\r\n  DropdownMenuSeparator,\r\n  DropdownMenuCheckboxItem,\r\n} from \"@/components/ui/dropdown-menu\";\r\n\r\ninterface HistorialMovimientosProps {\r\n  user: User;\r\n  selectedPoint: PuntoAtencion | null;\r\n  currencies?: Moneda[];\r\n  isAdminView?: boolean;\r\n}\r\n\r\ntype Movimiento = {\r\n  id: string;\r\n  fecha: string | Date;\r\n  tipo_movimiento:\r\n    | \"INGRESO\"\r\n    | \"EGRESO\"\r\n    | \"TRANSFERENCIA_ENTRANTE\"\r\n    | \"TRANSFERENCIA_SALIENTE\";\r\n  tipo_referencia?: string | null;\r\n  referencia_id?: string | null;\r\n  moneda_codigo: string;\r\n  monto: number;\r\n  punto_nombre?: string;\r\n  descripcion?: string | null;\r\n};\r\n\r\nexport default function HistorialMovimientos({\r\n  user,\r\n  selectedPoint,\r\n  currencies,\r\n  isAdminView = false,\r\n}: HistorialMovimientosProps) {\r\n  const normal = useContabilidadDivisas({ user, selectedPoint });\r\n  const admin = useContabilidadAdmin({ user });\r\n\r\n  const { movimientos, isLoading, error, refresh } = isAdminView\r\n    ? {\r\n        movimientos: admin.movimientosConsolidados as Movimiento[],\r\n        isLoading: admin.isLoading,\r\n        error: admin.error,\r\n        refresh: admin.refresh,\r\n      }\r\n    : {\r\n        movimientos: normal.movimientos as unknown as Movimiento[],\r\n        isLoading: normal.isLoading,\r\n        error: normal.error,\r\n        refresh: normal.refresh,\r\n      };\r\n\r\n  // ===== UI State =====\r\n  const [query, setQuery] = useState(\"\");\r\n  const [pageSize, setPageSize] = useState(25);\r\n  const [page, setPage] = useState(1);\r\n  const [sortKey, setSortKey] = useState<\"fecha\" | \"monto\">(\"fecha\");\r\n  const [sortDir, setSortDir] = useState<\"asc\" | \"desc\">(\"desc\");\r\n  const [tipo, setTipo] = useState<\"ALL\" | Movimiento[\"tipo_movimiento\"]>(\r\n    \"ALL\"\r\n  );\r\n  const [moneda, setMoneda] = useState<string>(\"ALL\");\r\n\r\n  // Filtros de fecha (opcional): d├¡a exacto o rango\r\n  const [date, setDate] = useState<string>(\"\");\r\n  const [fromDate, setFromDate] = useState<string>(\"\");\r\n  const [toDate, setToDate] = useState<string>(\"\");\r\n\r\n  // Columnas opcionales para CSV\r\n  const [csvCols, setCsvCols] = useState({\r\n    id: false,\r\n    tipoRef: false,\r\n    refId: false,\r\n  });\r\n\r\n  // Reset paginaci├│n si cambian filtros\r\n  useEffect(() => {\r\n    setPage(1);\r\n  }, [query, pageSize, sortKey, sortDir, tipo, moneda]);\r\n\r\n  const buildDateOpts = () => {\r\n    if (date) return { date } as const;\r\n    if (fromDate || toDate)\r\n      return { from: fromDate || undefined, to: toDate || undefined } as const;\r\n    return undefined;\r\n  };\r\n\r\n  // ===== Opciones de divisa usando currencies si est├í disponible =====\r\n  const monedaOptions = useMemo(() => {\r\n    const set = new Set<string>();\r\n    (movimientos ?? []).forEach((m) => set.add(m.moneda_codigo));\r\n    const list = Array.from(set);\r\n\r\n    // Si tenemos currencies, usamos su orden\r\n    if (currencies?.length) {\r\n      const order = new Map<string, number>();\r\n      currencies.forEach((c, i) => order.set(c.codigo, i));\r\n      list.sort((a, b) => {\r\n        const ia = a === \"USD\" ? -1 : order.get(a) ?? Number.MAX_SAFE_INTEGER;\r\n        const ib = b === \"USD\" ? -1 : order.get(b) ?? Number.MAX_SAFE_INTEGER;\r\n        return ia - ib || a.localeCompare(b);\r\n      });\r\n    } else {\r\n      // Si no hay currencies, USD primero y resto alfab├®tico\r\n      list.sort((a, b) => (a === \"USD\" ? -1 : a.localeCompare(b)));\r\n    }\r\n\r\n    return [\"ALL\", ...list];\r\n  }, [movimientos, currencies]);\r\n\r\n  // ===== Filtrado y orden =====\r\n  const filtered = useMemo(() => {\r\n    const q = query.trim().toLowerCase();\r\n    const arr = (movimientos ?? []) as Movimiento[];\r\n    const base = arr.filter((m) => {\r\n      if (tipo !== \"ALL\" && m.tipo_movimiento !== tipo) return false;\r\n      if (moneda !== \"ALL\" && m.moneda_codigo !== moneda) return false;\r\n      if (!q) return true;\r\n      const hay = `${m.descripcion ?? \"\"} ${m.tipo_movimiento} ${\r\n        m.tipo_referencia ?? \"\"\r\n      } ${m.moneda_codigo} ${m.punto_nombre ?? \"\"}`.toLowerCase();\r\n      return hay.includes(q);\r\n    });\r\n\r\n    base.sort((a, b) => {\r\n      if (sortKey === \"fecha\") {\r\n        const da = new Date(a.fecha).getTime();\r\n        const db = new Date(b.fecha).getTime();\r\n        return sortDir === \"asc\" ? da - db : db - da;\r\n      } else {\r\n        return sortDir === \"asc\" ? a.monto - b.monto : b.monto - a.monto;\r\n      }\r\n    });\r\n\r\n    return base;\r\n  }, [movimientos, query, tipo, moneda, sortKey, sortDir]);\r\n\r\n  // ===== Paginaci├│n =====\r\n  const total = filtered.length;\r\n  const totalPages = Math.max(1, Math.ceil(total / pageSize));\r\n  const current = useMemo(() => {\r\n    const start = (page - 1) * pageSize;\r\n    return filtered.slice(start, start + pageSize);\r\n  }, [filtered, page, pageSize]);\r\n\r\n  // ===== Helpers =====\r\n  const fmtMoney = (n: number, code: string) =>\r\n    code === \"USD\"\r\n      ? new Intl.NumberFormat(\"en-US\", {\r\n          style: \"currency\",\r\n          currency: \"USD\",\r\n        }).format(n)\r\n      : new Intl.NumberFormat(\"es-ES\", {\r\n          minimumFractionDigits: 2,\r\n          maximumFractionDigits: 2,\r\n        }).format(n);\r\n\r\n  const tipoBadgeClass = (t: Movimiento[\"tipo_movimiento\"]) =>\r\n    t === \"INGRESO\" || t === \"TRANSFERENCIA_ENTRANTE\"\r\n      ? \"bg-green-100 text-green-700\"\r\n      : \"bg-red-100 text-red-700\";\r\n\r\n  // ===== CSV Export =====\r\n  const csvEscape = (val: unknown) => {\r\n    if (val === null || val === undefined) return \"\";\r\n    const s = String(val);\r\n    if (/[\",\\n]/.test(s)) {\r\n      return `\"${s.replace(/\"/g, '\"\"')}\"`;\r\n    }\r\n    return s;\r\n  };\r\n\r\n  const buildCsv = (rows: Movimiento[], admin: boolean) => {\r\n    const headersBase = [\"Fecha\", \"Tipo\", \"Moneda\", \"Monto\"];\r\n    const headersExtra = [\r\n      ...(admin ? [\"Punto\"] : []),\r\n      \"Descripci├│n\",\r\n      ...(csvCols.id ? [\"ID\"] : []),\r\n      ...(csvCols.tipoRef ? [\"Tipo referencia\"] : []),\r\n      ...(csvCols.refId ? [\"Referencia ID\"] : []),\r\n    ];\r\n    const headers = [...headersBase, ...headersExtra];\r\n\r\n    const lines = rows.map((m) => {\r\n      const fecha = new Date(m.fecha).toISOString(); // formato estable\r\n      const base = [\r\n        csvEscape(fecha),\r\n        csvEscape(m.tipo_movimiento),\r\n        csvEscape(m.moneda_codigo),\r\n        String(m.monto),\r\n      ];\r\n      const extra = [\r\n        ...(admin ? [csvEscape(m.punto_nombre ?? \"\")] : []),\r\n        csvEscape(m.descripcion ?? \"\"),\r\n        ...(csvCols.id ? [csvEscape(m.id)] : []),\r\n        ...(csvCols.tipoRef ? [csvEscape(m.tipo_referencia ?? \"\")] : []),\r\n        ...(csvCols.refId ? [csvEscape(m.referencia_id ?? \"\")] : []),\r\n      ];\r\n      return [...base, ...extra].join(\",\");\r\n    });\r\n\r\n    return [headers.join(\",\"), ...lines].join(\"\\n\");\r\n  };\r\n\r\n  const downloadCsv = (filename: string, csv: string) => {\r\n    // BOM para Excel UTF-8\r\n    const blob = new Blob([\"\\uFEFF\" + csv], {\r\n      type: \"text/csv;charset=utf-8;\",\r\n    });\r\n    const url = URL.createObjectURL(blob);\r\n    const a = document.createElement(\"a\");\r\n    a.href = url;\r\n    a.download = filename;\r\n    a.style.display = \"none\";\r\n    document.body.appendChild(a);\r\n    a.click();\r\n    a.remove();\r\n    URL.revokeObjectURL(url);\r\n  };\r\n\r\n  const handleExportPage = () => {\r\n    const csv = buildCsv(current, !!isAdminView);\r\n    const ts = new Date().toISOString().slice(0, 19).replace(/[:T]/g, \"-\");\r\n    downloadCsv(`movimientos_pagina_${page}_${ts}.csv`, csv);\r\n  };\r\n\r\n  const handleExportAll = () => {\r\n    const csv = buildCsv(filtered, !!isAdminView);\r\n    const ts = new Date().toISOString().slice(0, 19).replace(/[:T]/g, \"-\");\r\n    downloadCsv(`movimientos_filtrados_${ts}.csv`, csv);\r\n  };\r\n\r\n  return (\r\n    <Card>\r\n      <CardHeader className=\"pb-2 sticky top-0 z-[1] bg-white/80 backdrop-blur supports-[backdrop-filter]:bg-white/60 rounded-t-md\">\r\n        <div className=\"flex items-center justify-between gap-2 flex-wrap\">\r\n          <CardTitle className=\"text-base font-semibold flex items-center gap-2\">\r\n            <Wallet className=\"h-5 w-5\" />\r\n            Historial de Movimientos\r\n          </CardTitle>\r\n\r\n          <div className=\"flex items-center gap-2 flex-wrap\">\r\n            {/* Buscar */}\r\n            <div className=\"relative\">\r\n              <Search className=\"h-4 w-4 absolute left-2 top-2.5 text-gray-400\" />\r\n              <Input\r\n                value={query}\r\n                onChange={(e) => setQuery(e.target.value)}\r\n                placeholder=\"Buscar descripci├│n, punto, tipoÔÇª\"\r\n                className=\"pl-8 w-64 h-9\"\r\n              />\r\n            </div>\r\n\r\n            {/* Tipo */}\r\n            <Select\r\n              value={tipo}\r\n              onValueChange={(v) => {\r\n                const allowed: Array<\"ALL\" | Movimiento[\"tipo_movimiento\"]> = [\r\n                  \"ALL\",\r\n                  \"INGRESO\",\r\n                  \"EGRESO\",\r\n                  \"TRANSFERENCIA_ENTRANTE\",\r\n                  \"TRANSFERENCIA_SALIENTE\",\r\n                ];\r\n                if (\r\n                  allowed.includes(\r\n                    v as \"ALL\" | Movimiento[\"tipo_movimiento\"]\r\n                  )\r\n                ) {\r\n                  setTipo(v as \"ALL\" | Movimiento[\"tipo_movimiento\"]);\r\n                }\r\n              }}\r\n            >\r\n              <SelectTrigger className=\"w-40 h-9\">\r\n                <SelectValue placeholder=\"Tipo\" />\r\n              </SelectTrigger>\r\n              <SelectContent>\r\n                <SelectItem value=\"ALL\">Todos</SelectItem>\r\n                <SelectItem value=\"INGRESO\">Ingreso</SelectItem>\r\n                <SelectItem value=\"EGRESO\">Egreso</SelectItem>\r\n                <SelectItem value=\"TRANSFERENCIA_ENTRANTE\">\r\n                  Transf. entrante\r\n                </SelectItem>\r\n                <SelectItem value=\"TRANSFERENCIA_SALIENTE\">\r\n                  Transf. saliente\r\n                </SelectItem>\r\n              </SelectContent>\r\n            </Select>\r\n\r\n            {/* Moneda */}\r\n            <Select value={moneda} onValueChange={setMoneda}>\r\n              <SelectTrigger className=\"w-36 h-9\">\r\n                <SelectValue placeholder=\"Moneda\" />\r\n              </SelectTrigger>\r\n              <SelectContent>\r\n                {monedaOptions.map((m) => (\r\n                  <SelectItem key={m} value={m}>\r\n                    {m === \"ALL\" ? \"Todas\" : m}\r\n                  </SelectItem>\r\n                ))}\r\n              </SelectContent>\r\n            </Select>\r\n\r\n            {/* Orden */}\r\n            <Select\r\n              value={sortKey}\r\n              onValueChange={(v) => {\r\n                if (v === \"fecha\" || v === \"monto\") setSortKey(v);\r\n              }}\r\n            >\r\n              <SelectTrigger className=\"w-36 h-9\">\r\n                <SelectValue placeholder=\"Ordenar por\" />\r\n              </SelectTrigger>\r\n              <SelectContent>\r\n                <SelectItem value=\"fecha\">Fecha</SelectItem>\r\n                <SelectItem value=\"monto\">Monto</SelectItem>\r\n              </SelectContent>\r\n            </Select>\r\n\r\n            <Button\r\n              size=\"icon\"\r\n              variant=\"outline\"\r\n              className=\"h-9 w-9\"\r\n              onClick={() => setSortDir((d) => (d === \"asc\" ? \"desc\" : \"asc\"))}\r\n              title={sortDir === \"asc\" ? \"Ascendente\" : \"Descendente\"}\r\n            >\r\n              {sortDir === \"asc\" ? (\r\n                <ArrowUpNarrowWide className=\"h-4 w-4\" />\r\n              ) : (\r\n                <ArrowDownWideNarrow className=\"h-4 w-4\" />\r\n              )}\r\n            </Button>\r\n\r\n            {/* Filtros de fecha: d├¡a exacto o rango */}\r\n            <div className=\"flex items-center gap-2\">\r\n              <Input\r\n                type=\"date\"\r\n                placeholder=\"YYYY-MM-DD\"\r\n                value={date}\r\n                onChange={(e) => setDate(e.target.value)}\r\n                className=\"h-9 w-[150px]\"\r\n              />\r\n              <span className=\"text-muted-foreground text-xs\">o</span>\r\n              <Input\r\n                type=\"date\"\r\n                placeholder=\"Desde\"\r\n                value={fromDate}\r\n                onChange={(e) => setFromDate(e.target.value)}\r\n                className=\"h-9 w-[150px]\"\r\n              />\r\n              <span className=\"text-muted-foreground text-xs\">a</span>\r\n              <Input\r\n                type=\"date\"\r\n                placeholder=\"Hasta\"\r\n                value={toDate}\r\n                onChange={(e) => setToDate(e.target.value)}\r\n                className=\"h-9 w-[150px]\"\r\n              />\r\n              <Button\r\n                variant=\"secondary\"\r\n                size=\"sm\"\r\n                className=\"h-9\"\r\n                onClick={() => {\r\n                  if (date) {\r\n                    setFromDate(\"\");\r\n                    setToDate(\"\");\r\n                  }\r\n                  // Usar hooks de datos para recargar con filtros\r\n                  if (isAdminView) {\r\n                    admin.cargarMovimientosConsolidados(\r\n                      undefined,\r\n                      100,\r\n                      buildDateOpts()\r\n                    );\r\n                  } else {\r\n                    normal.cargarMovimientos(undefined, 50, buildDateOpts());\r\n                  }\r\n                }}\r\n              >\r\n                Aplicar\r\n              </Button>\r\n              <Button\r\n                variant=\"ghost\"\r\n                size=\"sm\"\r\n                className=\"h-9\"\r\n                onClick={() => {\r\n                  setDate(\"\");\r\n                  setFromDate(\"\");\r\n                  setToDate(\"\");\r\n                  if (isAdminView) {\r\n                    admin.cargarMovimientosConsolidados(\r\n                      undefined,\r\n                      100,\r\n                      undefined\r\n                    );\r\n                  } else {\r\n                    normal.cargarMovimientos(undefined, 50, undefined);\r\n                  }\r\n                }}\r\n              >\r\n                Limpiar\r\n              </Button>\r\n            </div>\r\n\r\n            <Button\r\n              variant=\"outline\"\r\n              size=\"sm\"\r\n              onClick={() => {\r\n                if (isAdminView) {\r\n                  admin.refresh();\r\n                } else {\r\n                  normal.cargarMovimientos();\r\n                }\r\n              }}\r\n              disabled={isLoading}\r\n              className=\"h-9\"\r\n            >\r\n              {isLoading ? (\r\n                <Loader2 className=\"h-4 w-4 animate-spin\" />\r\n              ) : (\r\n                <RefreshCw className=\"h-4 w-4\" />\r\n              )}\r\n            </Button>\r\n\r\n            {/* Exportar CSV - P├ígina / Todos + Campos */}\r\n            <div className=\"flex items-center gap-1\">\r\n              <DropdownMenu>\r\n                <DropdownMenuTrigger asChild>\r\n                  <Button variant=\"outline\" size=\"sm\" className=\"h-9\">\r\n                    Campos CSV\r\n                  </Button>\r\n                </DropdownMenuTrigger>\r\n                <DropdownMenuContent align=\"end\" className=\"w-56\">\r\n                  <DropdownMenuLabel>Incluir columnas</DropdownMenuLabel>\r\n                  <DropdownMenuSeparator />\r\n                  <DropdownMenuCheckboxItem\r\n                    checked={csvCols.id}\r\n                    onCheckedChange={(v) =>\r\n                      setCsvCols((s) => ({ ...s, id: Boolean(v) }))\r\n                    }\r\n                  >\r\n                    ID\r\n                  </DropdownMenuCheckboxItem>\r\n                  <DropdownMenuCheckboxItem\r\n                    checked={csvCols.tipoRef}\r\n                    onCheckedChange={(v) =>\r\n                      setCsvCols((s) => ({ ...s, tipoRef: Boolean(v) }))\r\n                    }\r\n                  >\r\n                    Tipo de referencia\r\n                  </DropdownMenuCheckboxItem>\r\n                  <DropdownMenuCheckboxItem\r\n                    checked={csvCols.refId}\r\n                    onCheckedChange={(v) =>\r\n                      setCsvCols((s) => ({ ...s, refId: Boolean(v) }))\r\n                    }\r\n                  >\r\n                    Referencia ID\r\n                  </DropdownMenuCheckboxItem>\r\n                </DropdownMenuContent>\r\n              </DropdownMenu>\r\n\r\n              <Button\r\n                variant=\"outline\"\r\n                size=\"sm\"\r\n                className=\"h-9\"\r\n                onClick={handleExportPage}\r\n                disabled={current.length === 0}\r\n                title=\"Exportar CSV (p├ígina actual)\"\r\n              >\r\n                <Download className=\"h-4 w-4 mr-1\" />\r\n                P├ígina\r\n              </Button>\r\n              <Button\r\n                variant=\"outline\"\r\n                size=\"sm\"\r\n                className=\"h-9\"\r\n                onClick={handleExportAll}\r\n                disabled={filtered.length === 0}\r\n                title=\"Exportar CSV (todos los resultados)\"\r\n              >\r\n                <Download className=\"h-4 w-4 mr-1\" />\r\n                Todo\r\n              </Button>\r\n            </div>\r\n          </div>\r\n        </div>\r\n      </CardHeader>\r\n\r\n      <CardContent className=\"pt-3\">\r\n        {isLoading && (movimientos?.length ?? 0) === 0 ? (\r\n          <Loading text=\"Cargando movimientos...\" className=\"py-10\" />\r\n        ) : error ? (\r\n          <div className=\"text-center py-10 text-red-600\">{error}</div>\r\n        ) : (movimientos?.length ?? 0) === 0 ? (\r\n          <div className=\"text-center py-10 text-muted-foreground\">\r\n            No hay movimientos\r\n          </div>\r\n        ) : (\r\n          <>\r\n            {/* Tabla */}\r\n            <div className=\"w-full overflow-auto rounded-md border\">\r\n              <table className=\"w-full text-sm\">\r\n                <thead className=\"bg-gray-50 sticky top-0 z-[1]\">\r\n                  <tr className=\"text-left\">\r\n                    <th className=\"px-3 py-2 font-medium\">\r\n                      <CalendarDays className=\"inline h-4 w-4 mr-1\" />\r\n                      Fecha\r\n                    </th>\r\n                    <th className=\"px-3 py-2 font-medium\">Tipo</th>\r\n                    <th className=\"px-3 py-2 font-medium\">Moneda</th>\r\n                    <th className=\"px-3 py-2 font-medium text-right\">Monto</th>\r\n                    {isAdminView && (\r\n                      <th className=\"px-3 py-2 font-medium\">Punto</th>\r\n                    )}\r\n                    <th className=\"px-3 py-2 font-medium\">Descripci├│n</th>\r\n                  </tr>\r\n                </thead>\r\n                <tbody>\r\n                  {current.map((m) => (\r\n                    <tr key={m.id} className=\"border-t hover:bg-gray-50\">\r\n                      <td className=\"px-3 py-2 whitespace-nowrap\">\r\n                        {new Date(m.fecha).toLocaleString()}\r\n                      </td>\r\n                      <td className=\"px-3 py-2\">\r\n                        <span\r\n                          className={`px-2 py-0.5 rounded text-xs ${tipoBadgeClass(\r\n                            m.tipo_movimiento\r\n                          )}`}\r\n                        >\r\n                          {m.tipo_movimiento.replace(\"_\", \" \")}\r\n                        </span>\r\n                      </td>\r\n                      <td className=\"px-3 py-2\">{m.moneda_codigo}</td>\r\n                      <td className=\"px-3 py-2 text-right font-semibold\">\r\n                        {fmtMoney(m.monto, m.moneda_codigo)}\r\n                      </td>\r\n                      {isAdminView && (\r\n                        <td className=\"px-3 py-2\">{m.punto_nombre ?? \"ÔÇö\"}</td>\r\n                      )}\r\n                      <td className=\"px-3 py-2 max-w-[320px]\">\r\n                        <div className=\"line-clamp-2 text-muted-foreground\">\r\n                          {m.descripcion ?? \"ÔÇö\"}\r\n                        </div>\r\n                      </td>\r\n                    </tr>\r\n                  ))}\r\n                </tbody>\r\n              </table>\r\n            </div>\r\n\r\n            {/* Paginaci├│n */}\r\n            <div className=\"flex items-center justify-between mt-3 flex-wrap gap-2\">\r\n              <div className=\"text-xs text-gray-600\">\r\n                Mostrando <b>{current.length}</b> de <b>{total}</b> registros ÔÇó\r\n                P├ígina <b>{page}</b> de <b>{totalPages}</b>\r\n              </div>\r\n\r\n              <div className=\"flex items-center gap-2\">\r\n                <Select\r\n                  value={String(pageSize)}\r\n                  onValueChange={(v) => setPageSize(Number(v))}\r\n                >\r\n                  <SelectTrigger className=\"h-8 w-28\">\r\n                    <SelectValue placeholder=\"Tama├▒o\" />\r\n                  </SelectTrigger>\r\n                  <SelectContent>\r\n                    {[10, 25, 50, 100].map((n) => (\r\n                      <SelectItem key={n} value={String(n)}>\r\n                        {n} / p├íg\r\n                      </SelectItem>\r\n                    ))}\r\n                  </SelectContent>\r\n                </Select>\r\n\r\n                <div className=\"flex items-center gap-1\">\r\n                  <Button\r\n                    variant=\"outline\"\r\n                    size=\"sm\"\r\n                    disabled={page === 1}\r\n                    onClick={() => setPage(1)}\r\n                  >\r\n                    ÔÅ«\r\n                  </Button>\r\n                  <Button\r\n                    variant=\"outline\"\r\n                    size=\"sm\"\r\n                    disabled={page === 1}\r\n                    onClick={() => setPage((p) => Math.max(1, p - 1))}\r\n                  >\r\n                    ÔùÇ\r\n                  </Button>\r\n                  <Button\r\n                    variant=\"outline\"\r\n                    size=\"sm\"\r\n                    disabled={page === totalPages}\r\n                    onClick={() => setPage((p) => Math.min(totalPages, p + 1))}\r\n                  >\r\n                    ÔûÂ\r\n                  </Button>\r\n                  <Button\r\n                    variant=\"outline\"\r\n                    size=\"sm\"\r\n                    disabled={page === totalPages}\r\n                    onClick={() => setPage(totalPages)}\r\n                  >\r\n                    ÔÅ¡\r\n                  </Button>\r\n                </div>\r\n              </div>\r\n            </div>\r\n          </>\r\n        )}\r\n      </CardContent>\r\n    </Card>\r\n  );\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\oswal\\OneDrive\\Documentos\\Punto Cambio\\punto_cambio_new\\src\\components\\contabilidad\\SaldosDivisasEnTiempoReal.tsx","messages":[{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'SaldoConsolidado' is defined but never used. Allowed unused vars must match /^_/u.","line":12,"column":31,"nodeType":null,"messageId":"unusedVar","endLine":12,"endColumn":47}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":1,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import { useEffect, useMemo, useState } from \"react\";\r\nimport { Card, CardContent, CardHeader, CardTitle } from \"@/components/ui/card\";\r\nimport { Badge } from \"@/components/ui/badge\";\r\nimport { Button } from \"@/components/ui/button\";\r\nimport {\r\n  RefreshCw,\r\n  TrendingUp,\r\n  TrendingDown,\r\n  DollarSign,\r\n  AlertTriangle,\r\n} from \"lucide-react\";\r\nimport { User, PuntoAtencion, SaldoConsolidado } from \"@/types\";\r\nimport { useContabilidadDivisas } from \"@/hooks/useContabilidadDivisas\";\r\nimport { useContabilidadAdmin } from \"@/hooks/useContabilidadAdmin\";\r\nimport { Loading } from \"@/components/ui/loading\";\r\nimport {\r\n  Select,\r\n  SelectContent,\r\n  SelectItem,\r\n  SelectTrigger,\r\n  SelectValue,\r\n} from \"@/components/ui/select\";\r\n\r\ninterface SaldosDivisasEnTiempoRealProps {\r\n  user: User;\r\n  selectedPoint: PuntoAtencion | null;\r\n  className?: string;\r\n  isAdminView?: boolean;\r\n  compact?: boolean;\r\n}\r\n\r\ntype AnySaldo = {\r\n  moneda_id: string;\r\n  moneda_codigo: string;\r\n  saldo: number;\r\n  punto_id?: string;\r\n  punto_nombre?: string;\r\n  billetes?: number;\r\n  monedas_fisicas?: number;\r\n};\r\n\r\nexport const SaldosDivisasEnTiempoReal = ({\r\n  user,\r\n  selectedPoint,\r\n  className = \"\",\r\n  isAdminView = false,\r\n  compact = true, // por defecto compacto\r\n}: SaldosDivisasEnTiempoRealProps) => {\r\n  // Hooks de datos\r\n  const contabilidadNormal = useContabilidadDivisas({ user, selectedPoint });\r\n  const contabilidadAdmin = useContabilidadAdmin({ user });\r\n\r\n  const { saldos, isLoading, error, refresh } = isAdminView\r\n    ? {\r\n        saldos: contabilidadAdmin.saldosConsolidados,\r\n        isLoading: contabilidadAdmin.isLoading,\r\n        error: contabilidadAdmin.error,\r\n        refresh: contabilidadAdmin.refresh,\r\n      }\r\n    : contabilidadNormal;\r\n\r\n  // Estado UI\r\n  const [autoRefresh, setAutoRefresh] = useState(true);\r\n  const [expanded, setExpanded] = useState(!compact);\r\n  const [selectedPointId, setSelectedPointId] = useState<string>(\"ALL\");\r\n  const [selectedCurrencyId, setSelectedCurrencyId] = useState<string>(\"ALL\");\r\n\r\n  // Opciones para filtros (admin)\r\n  const pointOptions = useMemo(() => {\r\n    if (!isAdminView) return [] as { id: string; nombre: string }[];\r\n    const map = new Map<string, string>();\r\n    (saldos as AnySaldo[]).forEach((s) => {\r\n      if (typeof s.punto_id === \"string\" && typeof s.punto_nombre === \"string\") {\r\n        map.set(s.punto_id, s.punto_nombre);\r\n      }\r\n    });\r\n    return Array.from(map.entries()).map(([id, nombre]) => ({ id, nombre }));\r\n  }, [saldos, isAdminView]);\r\n\r\n  const currencyOptions = useMemo(() => {\r\n    const map = new Map<string, string>();\r\n    (saldos as AnySaldo[]).forEach((s) =>\r\n      map.set(s.moneda_id, s.moneda_codigo)\r\n    );\r\n    return Array.from(map.entries())\r\n      .map(([id, codigo]) => ({ id, codigo }))\r\n      .sort((a, b) =>\r\n        a.codigo === \"USD\" ? -1 : a.codigo.localeCompare(b.codigo)\r\n      );\r\n  }, [saldos]);\r\n\r\n  // Filtro aplicado\r\n  const filteredSaldos = useMemo(() => {\r\n    let list = saldos as AnySaldo[];\r\n    if (isAdminView && selectedPointId !== \"ALL\") {\r\n      list = list.filter((s) => s.punto_id === selectedPointId);\r\n    }\r\n    if (selectedCurrencyId !== \"ALL\") {\r\n      list = list.filter((s) => s.moneda_id === selectedCurrencyId);\r\n    }\r\n    // Orden: USD primero; luego alfab├®tico de c├│digo\r\n    return [...list].sort((a, b) => {\r\n      if (a.moneda_codigo === \"USD\" && b.moneda_codigo !== \"USD\") return -1;\r\n      if (b.moneda_codigo === \"USD\" && a.moneda_codigo !== \"USD\") return 1;\r\n      return a.moneda_codigo.localeCompare(b.moneda_codigo);\r\n    });\r\n  }, [saldos, isAdminView, selectedPointId, selectedCurrencyId]);\r\n\r\n  // Resumen por divisa\r\n  const resumenPorDivisa = useMemo(() => {\r\n    const map = new Map<string, number>();\r\n    filteredSaldos.forEach((s) =>\r\n      map.set(s.moneda_codigo, (map.get(s.moneda_codigo) || 0) + s.saldo)\r\n    );\r\n    return Array.from(map.entries())\r\n      .map(([codigo, total]) => ({ codigo, total }))\r\n      .sort((a, b) =>\r\n        a.codigo === \"USD\" ? -1 : a.codigo.localeCompare(b.codigo)\r\n      );\r\n  }, [filteredSaldos]);\r\n\r\n  // Auto-refresh inteligente\r\n  useEffect(() => {\r\n    let interval: number | undefined;\r\n    const run = () => autoRefresh && !document.hidden && refresh();\r\n    if (autoRefresh) interval = window.setInterval(run, 30000);\r\n    const onVis = () => {\r\n      if (!document.hidden && autoRefresh) refresh();\r\n    };\r\n    document.addEventListener(\"visibilitychange\", onVis);\r\n    return () => {\r\n      if (interval) clearInterval(interval);\r\n      document.removeEventListener(\"visibilitychange\", onVis);\r\n    };\r\n  }, [autoRefresh, refresh]);\r\n\r\n  const formatCurrency = (amount: number, codigo: string) => {\r\n    if (codigo === \"USD\") {\r\n      return new Intl.NumberFormat(\"en-US\", {\r\n        style: \"currency\",\r\n        currency: \"USD\",\r\n        minimumFractionDigits: 2,\r\n      }).format(amount);\r\n    }\r\n    return new Intl.NumberFormat(\"es-ES\", {\r\n      minimumFractionDigits: 2,\r\n      maximumFractionDigits: 2,\r\n    }).format(amount);\r\n  };\r\n\r\n  const getSaldoStatus = (saldo: number) => {\r\n    if (saldo <= 0)\r\n      return { tone: \"red\", text: \"Sin saldo\", Icon: AlertTriangle };\r\n    if (saldo < 1000)\r\n      return { tone: \"yellow\", text: \"Saldo bajo\", Icon: TrendingDown };\r\n    return { tone: \"green\", text: \"Saldo normal\", Icon: TrendingUp };\r\n  };\r\n\r\n  if (!selectedPoint && !isAdminView) {\r\n    return (\r\n      <Card className={className}>\r\n        <CardContent className=\"p-6 text-center text-muted-foreground\">\r\n          Seleccione un punto de atenci├│n para ver los saldos\r\n        </CardContent>\r\n      </Card>\r\n    );\r\n  }\r\n\r\n  return (\r\n    <Card className={className}>\r\n      <CardHeader className=\"pb-3\">\r\n        <div className=\"flex items-center justify-between gap-4 flex-wrap\">\r\n          <CardTitle className=\"text-lg font-semibold flex items-center gap-2\">\r\n            <DollarSign className=\"h-5 w-5 text-green-600\" />\r\n            {isAdminView\r\n              ? \"Saldos de Divisas - Contabilidad General\"\r\n              : `Saldos de Divisas - ${selectedPoint?.nombre}`}\r\n          </CardTitle>\r\n\r\n          <div className=\"flex items-center gap-2 flex-wrap\">\r\n            {isAdminView && (\r\n              <div className=\"flex items-center gap-2\">\r\n                <div className=\"w-56\">\r\n                  <Select\r\n                    value={selectedPointId}\r\n                    onValueChange={setSelectedPointId}\r\n                  >\r\n                    <SelectTrigger>\r\n                      <SelectValue placeholder=\"Filtrar por punto\" />\r\n                    </SelectTrigger>\r\n                    <SelectContent>\r\n                      <SelectItem value=\"ALL\">Todos los puntos</SelectItem>\r\n                      {pointOptions.map((p) => (\r\n                        <SelectItem key={p.id} value={p.id}>\r\n                          {p.nombre}\r\n                        </SelectItem>\r\n                      ))}\r\n                    </SelectContent>\r\n                  </Select>\r\n                </div>\r\n                <div className=\"w-48\">\r\n                  <Select\r\n                    value={selectedCurrencyId}\r\n                    onValueChange={setSelectedCurrencyId}\r\n                  >\r\n                    <SelectTrigger>\r\n                      <SelectValue placeholder=\"Filtrar por divisa\" />\r\n                    </SelectTrigger>\r\n                    <SelectContent>\r\n                      <SelectItem value=\"ALL\">Todas las divisas</SelectItem>\r\n                      {currencyOptions.map((c) => (\r\n                        <SelectItem key={c.id} value={c.id}>\r\n                          {c.codigo}\r\n                        </SelectItem>\r\n                      ))}\r\n                    </SelectContent>\r\n                  </Select>\r\n                </div>\r\n              </div>\r\n            )}\r\n\r\n            <Button\r\n              variant=\"outline\"\r\n              size=\"sm\"\r\n              onClick={refresh}\r\n              disabled={isLoading}\r\n              className=\"h-8\"\r\n              title=\"Actualizar\"\r\n            >\r\n              <RefreshCw\r\n                className={`h-4 w-4 ${isLoading ? \"animate-spin\" : \"\"}`}\r\n              />\r\n            </Button>\r\n\r\n            <Badge\r\n              variant={autoRefresh ? \"default\" : \"outline\"}\r\n              className=\"cursor-pointer\"\r\n              onClick={() => setAutoRefresh((v) => !v)}\r\n            >\r\n              Auto-refresh {autoRefresh ? \"ON\" : \"OFF\"}\r\n            </Badge>\r\n\r\n            {compact && (\r\n              <Badge\r\n                variant={expanded ? \"default\" : \"outline\"}\r\n                className=\"cursor-pointer\"\r\n                onClick={() => setExpanded((v) => !v)}\r\n              >\r\n                {expanded ? \"Detalle\" : \"Resumen\"}\r\n              </Badge>\r\n            )}\r\n          </div>\r\n        </div>\r\n      </CardHeader>\r\n\r\n      <CardContent>\r\n        {isLoading && (saldos?.length ?? 0) === 0 ? (\r\n          <Loading text=\"Cargando saldos...\" className=\"py-8\" />\r\n        ) : error ? (\r\n          <div className=\"text-center py-8\">\r\n            <AlertTriangle className=\"h-12 w-12 text-destructive mx-auto mb-4\" />\r\n            <p className=\"text-destructive mb-4\">{error}</p>\r\n            <Button onClick={refresh} variant=\"outline\">\r\n              Reintentar\r\n            </Button>\r\n          </div>\r\n        ) : (filteredSaldos?.length ?? 0) === 0 ? (\r\n          <div className=\"text-center py-8 text-muted-foreground\">\r\n            <DollarSign className=\"h-12 w-12 mx-auto mb-4 opacity-50\" />\r\n            <p>No hay saldos para los filtros seleccionados</p>\r\n          </div>\r\n        ) : (\r\n          <div className=\"space-y-4\">\r\n            {/* Resumen por divisa (chips/cards peque├▒as) */}\r\n            {resumenPorDivisa.length > 0 && (\r\n              <div className=\"grid grid-cols-2 sm:grid-cols-3 lg:grid-cols-6 gap-2\">\r\n                {resumenPorDivisa.map((t) => (\r\n                  <div\r\n                    key={t.codigo}\r\n                    className=\"p-2 border rounded-md bg-white\"\r\n                  >\r\n                    <div className=\"flex items-center justify-between\">\r\n                      <span className=\"text-[11px] uppercase tracking-wide text-gray-500\">\r\n                        {t.codigo}\r\n                      </span>\r\n                      <DollarSign className=\"h-3.5 w-3.5 text-gray-400\" />\r\n                    </div>\r\n                    <div className=\"mt-1 text-[13px] font-semibold\">\r\n                      {formatCurrency(t.total, t.codigo)}\r\n                    </div>\r\n                  </div>\r\n                ))}\r\n              </div>\r\n            )}\r\n\r\n            {/* Si compacto y no expandido, termina aqu├¡ */}\r\n            {compact && !expanded ? (\r\n              <div className=\"text-right text-xs text-gray-500\">\r\n                ├Ültima actualizaci├│n: {new Date().toLocaleTimeString()}\r\n              </div>\r\n            ) : (\r\n              <>\r\n                {/* Tarjetas peque├▒as por saldo (grid responsivo) */}\r\n                <div className=\"grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 xl:grid-cols-4 2xl:grid-cols-5 gap-3\">\r\n                  {filteredSaldos.map((saldo) => {\r\n                    const { tone, text, Icon } = getSaldoStatus(saldo.saldo);\r\n                    const toneClasses =\r\n                      tone === \"green\"\r\n                        ? \"border-green-200 bg-green-50/60\"\r\n                        : tone === \"yellow\"\r\n                        ? \"border-yellow-200 bg-yellow-50/60\"\r\n                        : \"border-red-200 bg-red-50/60\";\r\n\r\n                    return (\r\n                      <div\r\n                        key={`${saldo.moneda_id}-${saldo.punto_id ?? \"single\"}`}\r\n                        className={`rounded-lg border ${toneClasses} p-3 hover:shadow-sm transition-shadow`}\r\n                      >\r\n                        <div className=\"flex items-center justify-between\">\r\n                          <div className=\"flex items-center gap-2\">\r\n                            <div className=\"p-1.5 rounded-full bg-white/70 border\">\r\n                              <DollarSign\r\n                                className={`h-4 w-4 ${\r\n                                  tone === \"red\"\r\n                                    ? \"text-red-600\"\r\n                                    : tone === \"yellow\"\r\n                                    ? \"text-yellow-600\"\r\n                                    : \"text-green-600\"\r\n                                }`}\r\n                              />\r\n                            </div>\r\n                            <div className=\"text-sm font-medium\">\r\n                              {saldo.moneda_codigo}\r\n                              {saldo.moneda_codigo === \"USD\" && (\r\n                                <span className=\"ml-1 text-[10px] px-1 py-0.5 rounded bg-white/80 border text-green-700\">\r\n                                  Principal\r\n                                </span>\r\n                              )}\r\n                            </div>\r\n                          </div>\r\n                          <Badge variant=\"outline\" className=\"gap-1\">\r\n                            <Icon className=\"h-3.5 w-3.5\" />\r\n                            <span\r\n                              className={\r\n                                tone === \"red\"\r\n                                  ? \"text-red-700\"\r\n                                  : tone === \"yellow\"\r\n                                  ? \"text-yellow-700\"\r\n                                  : \"text-green-700\"\r\n                              }\r\n                            >\r\n                              {text}\r\n                            </span>\r\n                          </Badge>\r\n                        </div>\r\n\r\n                        <div\r\n                          className={`mt-2 ${\r\n                            saldo.moneda_codigo === \"USD\"\r\n                              ? \"text-2xl\"\r\n                              : \"text-xl\"\r\n                          } font-bold ${\r\n                            tone === \"red\"\r\n                              ? \"text-red-700\"\r\n                              : tone === \"yellow\"\r\n                              ? \"text-yellow-700\"\r\n                              : \"text-green-800\"\r\n                          }`}\r\n                        >\r\n                          {formatCurrency(saldo.saldo, saldo.moneda_codigo)}\r\n                        </div>\r\n\r\n                        {/* Stock f├¡sico */}\r\n                        {(saldo.billetes !== undefined ||\r\n                          saldo.monedas_fisicas !== undefined) && (\r\n                          <div className=\"mt-2 rounded-md bg-gray-50 p-1.5 text-[11px] text-gray-600\">\r\n                            Stock: <b>{saldo.billetes || 0}</b> billetes ÔÇó{\" \"}\r\n                            <b>{saldo.monedas_fisicas || 0}</b> monedas\r\n                          </div>\r\n                        )}\r\n\r\n                        {isAdminView && saldo.punto_nombre && (\r\n                          <div className=\"mt-1 text-xs text-gray-600 line-clamp-1\">\r\n                            {saldo.punto_nombre}\r\n                          </div>\r\n                        )}\r\n                      </div>\r\n                    );\r\n                  })}\r\n                </div>\r\n\r\n                <div className=\"flex items-center justify-between mt-2\">\r\n                  <div className=\"text-xs text-gray-500\">\r\n                    {filteredSaldos.length} saldo\r\n                    {filteredSaldos.length !== 1 ? \"s\" : \"\"} ÔÇó ├║ltima\r\n                    actualizaci├│n: {new Date().toLocaleTimeString()}\r\n                  </div>\r\n                  <div className=\"flex items-center gap-2\">\r\n                    <Button size=\"sm\" variant=\"outline\" onClick={refresh}>\r\n                      <RefreshCw\r\n                        className={`h-4 w-4 ${isLoading ? \"animate-spin\" : \"\"}`}\r\n                      />\r\n                    </Button>\r\n                    <Badge\r\n                      variant=\"outline\"\r\n                      className=\"cursor-pointer\"\r\n                      onClick={() =>\r\n                        window.scrollTo({ top: 0, behavior: \"smooth\" })\r\n                      }\r\n                    >\r\n                      Ir arriba\r\n                    </Badge>\r\n                  </div>\r\n                </div>\r\n              </>\r\n            )}\r\n          </div>\r\n        )}\r\n      </CardContent>\r\n    </Card>\r\n  );\r\n};\r\n\r\nexport default SaldosDivisasEnTiempoReal;\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\oswal\\OneDrive\\Documentos\\Punto Cambio\\punto_cambio_new\\src\\components\\contabilidad\\ServiciosExternosForm.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\oswal\\OneDrive\\Documentos\\Punto Cambio\\punto_cambio_new\\src\\components\\contabilidad\\ServiciosExternosHistory.tsx","messages":[],"suppressedMessages":[{"ruleId":"react-hooks/exhaustive-deps","severity":1,"message":"React Hook useEffect has a missing dependency: 'fetchData'. Either include it or remove the dependency array.","line":114,"column":6,"nodeType":"ArrayExpression","endLine":114,"endColumn":31,"suggestions":[{"desc":"Update the dependencies array to be: [servicio, tipo, pointId, fetchData]","fix":{"range":[3891,3916],"text":"[servicio, tipo, pointId, fetchData]"}}],"suppressions":[{"kind":"directive","justification":""}]}],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\oswal\\OneDrive\\Documentos\\Punto Cambio\\punto_cambio_new\\src\\components\\contabilidad\\ServiciosExternosPage.tsx","messages":[{"ruleId":"react-hooks/exhaustive-deps","severity":1,"message":"React Hook useEffect has a missing dependency: 'cargarSaldos'. Either include it or remove the dependency array.","line":49,"column":6,"nodeType":"ArrayExpression","endLine":49,"endColumn":43,"suggestions":[{"desc":"Update the dependencies array to be: [user.punto_atencion_id, refreshKey, cargarSaldos]","fix":{"range":[1643,1680],"text":"[user.punto_atencion_id, refreshKey, cargarSaldos]"}}]}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":1,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import React, { useState, useEffect } from \"react\";\r\nimport ServiciosExternosForm from \"./ServiciosExternosForm\";\r\nimport ServiciosExternosHistory from \"./ServiciosExternosHistory\";\r\nimport { Card, CardContent, CardHeader, CardTitle } from \"@/components/ui/card\";\r\nimport { Badge } from \"@/components/ui/badge\";\r\nimport { useAuth } from \"@/hooks/useAuth\";\r\nimport {\r\n  obtenerSaldosAsignados,\r\n  SaldoAsignado,\r\n} from \"@/services/externalServicesService\";\r\nimport { toast } from \"sonner\";\r\nimport { Button } from \"@/components/ui/button\";\r\n\r\nconst SERVICIOS_LABELS: Record<string, string> = {\r\n  YAGANASTE: \"YaGanaste\",\r\n  BANCO_GUAYAQUIL: \"Banco Guayaquil\",\r\n  WESTERN: \"Western Union\",\r\n  PRODUBANCO: \"Produbanco\",\r\n  BANCO_PACIFICO: \"Banco del Pac├¡fico\",\r\n  SERVIENTREGA: \"Servientrega\",\r\n  INSUMOS_OFICINA: \"Insumos de oficina\",\r\n  INSUMOS_LIMPIEZA: \"Insumos de limpieza\",\r\n  OTROS: \"Otros\",\r\n};\r\n\r\nexport default function ServiciosExternosPage() {\r\n  const { user } = useAuth();\r\n  const [saldosAsignados, setSaldosAsignados] = useState<SaldoAsignado[]>([]);\r\n  const [loading, setLoading] = useState(false);\r\n  const [refreshKey, setRefreshKey] = useState(0);\r\n\r\n  const cargarSaldos = async () => {\r\n    if (!user?.punto_atencion_id) return;\r\n\r\n    setLoading(true);\r\n    try {\r\n      const response = await obtenerSaldosAsignados();\r\n      setSaldosAsignados(response.saldos_asignados || []);\r\n    } catch (error) {\r\n      console.error(\"Error al cargar saldos:\", error);\r\n      toast.error(\"Error al cargar saldos asignados\");\r\n    } finally {\r\n      setLoading(false);\r\n    }\r\n  };\r\n\r\n  useEffect(() => {\r\n    cargarSaldos();\r\n  }, [user?.punto_atencion_id, refreshKey]);\r\n\r\n  const handleRefresh = () => {\r\n    setRefreshKey((prev) => prev + 1);\r\n  };\r\n\r\n  return (\r\n    <div className=\"p-4 md:p-6 h-full flex flex-col gap-4 overflow-auto\">\r\n      {/* Encabezado de la p├ígina - Compacto */}\r\n      <div className=\"flex items-center justify-between gap-4 flex-shrink-0\">\r\n        <div>\r\n          <h2 className=\"text-lg md:text-xl font-semibold\">Servicios Externos (USD)</h2>\r\n          <p className=\"text-xs md:text-sm text-gray-600\">\r\n            Registre ingresos/egresos de servicios externos e insumos\r\n          </p>\r\n        </div>\r\n        <Badge variant=\"outline\" className=\"text-xs md:text-sm\">\r\n          USD\r\n        </Badge>\r\n      </div>\r\n\r\n      {/* Saldos Asignados - Card compacto */}\r\n      {user?.punto_atencion_id && (\r\n        <Card className=\"border flex-shrink-0\">\r\n          <CardHeader className=\"pb-2\">\r\n            <div className=\"flex items-center justify-between\">\r\n              <CardTitle className=\"text-sm font-semibold\">\r\n                ­ƒÆ░ Saldos Asignados\r\n              </CardTitle>\r\n              <Button\r\n                variant=\"ghost\"\r\n                size=\"sm\"\r\n                onClick={handleRefresh}\r\n                disabled={loading}\r\n                className=\"h-7 text-xs\"\r\n              >\r\n                {loading ? \"ÔÅ│\" : \"­ƒöä\"} Actualizar\r\n              </Button>\r\n            </div>\r\n          </CardHeader>\r\n          <CardContent className=\"pt-0\">\r\n            {loading && saldosAsignados.length === 0 ? (\r\n              <p className=\"text-xs text-gray-500\">Cargando saldos...</p>\r\n            ) : saldosAsignados.length === 0 ? (\r\n              <p className=\"text-xs text-gray-500\">\r\n                No hay saldos asignados para este punto\r\n              </p>\r\n            ) : (\r\n              <div className=\"grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 lg:grid-cols-6 xl:grid-cols-7 gap-2 md:gap-3\">\r\n                {saldosAsignados.map((saldo) => (\r\n                  <div\r\n                    key={saldo.servicio}\r\n                    className=\"p-2 md:p-3 border rounded-lg bg-gray-50 hover:bg-gray-100 transition-colors\"\r\n                  >\r\n                    <p className=\"text-xs font-medium text-gray-600 truncate\" title={SERVICIOS_LABELS[saldo.servicio] || saldo.servicio}>\r\n                      {SERVICIOS_LABELS[saldo.servicio] || saldo.servicio}\r\n                    </p>\r\n                    <p className=\"text-sm md:text-base font-bold text-green-600 mt-1\">\r\n                      ${(Number(saldo.saldo_asignado) || 0).toFixed(2)}\r\n                    </p>\r\n                    <div className=\"text-[10px] md:text-xs text-gray-500 mt-1 space-y-0.5\">\r\n                      <div>Billetes: <b>${(Number(saldo.billetes) || 0).toFixed(2)}</b></div>\r\n                      <div>Monedas: <b>${(Number(saldo.monedas_fisicas) || 0).toFixed(2)}</b></div>\r\n                    </div>\r\n                  </div>\r\n                ))}\r\n              </div>\r\n            )}\r\n          </CardContent>\r\n        </Card>\r\n      )}\r\n\r\n      {/* Dos columnas en desktop, una columna en mobile - Con altura controlada */}\r\n      <div className=\"grid grid-cols-1 xl:grid-cols-2 gap-4 flex-shrink-0\">\r\n        {/* Columna izquierda: Formulario */}\r\n        <Card className=\"border flex flex-col\">\r\n          <CardHeader className=\"pb-3\">\r\n            <CardTitle className=\"text-sm md:text-base font-semibold\">\r\n              ­ƒôØ Nuevo movimiento\r\n            </CardTitle>\r\n            <p className=\"text-xs md:text-sm text-muted-foreground\">\r\n              Completa los campos y guarda para registrar un movimiento\r\n            </p>\r\n          </CardHeader>\r\n          <CardContent className=\"pt-0\">\r\n            <ServiciosExternosForm onMovimientoCreado={handleRefresh} />\r\n          </CardContent>\r\n        </Card>\r\n\r\n        {/* Columna derecha: Historial */}\r\n        <Card className=\"border flex flex-col\">\r\n          <CardHeader className=\"pb-3\">\r\n            <CardTitle className=\"text-sm md:text-base font-semibold\">\r\n              ­ƒôè ├Ültimos movimientos\r\n            </CardTitle>\r\n            <p className=\"text-xs md:text-sm text-muted-foreground\">\r\n              Revisa y exporta tus registros recientes\r\n            </p>\r\n          </CardHeader>\r\n          <CardContent className=\"pt-0\">\r\n            <ServiciosExternosHistory />\r\n          </CardContent>\r\n        </Card>\r\n      </div>\r\n    </div>\r\n  );\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\oswal\\OneDrive\\Documentos\\Punto Cambio\\punto_cambio_new\\src\\components\\dashboard\\BalanceCard.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\oswal\\OneDrive\\Documentos\\Punto Cambio\\punto_cambio_new\\src\\components\\dashboard\\BalanceDashboard.tsx","messages":[{"ruleId":"prefer-const","severity":1,"message":"'interval' is never reassigned. Use 'const' instead.","line":218,"column":5,"nodeType":"Identifier","messageId":"useConst","endLine":218,"endColumn":13}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":1,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import React, { useState, useEffect, useMemo, useCallback } from \"react\";\r\nimport { Card, CardContent, CardHeader, CardTitle } from \"@/components/ui/card\";\r\nimport { Badge } from \"@/components/ui/badge\";\r\nimport { Button } from \"@/components/ui/button\";\r\nimport { Tabs, TabsContent, TabsList, TabsTrigger } from \"@/components/ui/tabs\";\r\nimport {\r\n  RefreshCw,\r\n  TrendingUp,\r\n  TrendingDown,\r\n  DollarSign,\r\n  Calculator,\r\n  BarChart3,\r\n  AlertTriangle,\r\n  ArrowUp,\r\n} from \"lucide-react\";\r\nimport { toast } from \"@/hooks/use-toast\";\r\nimport { User, PuntoAtencion, VistaSaldosPorPunto } from \"../../types\";\r\nimport { saldoInicialService } from \"../../services/saldoInicialService\";\r\nimport { apiService } from \"../../services/apiService\";\r\nimport ContabilidadDiaria from \"./ContabilidadDiaria\";\r\nimport {\r\n  Select,\r\n  SelectContent,\r\n  SelectItem,\r\n  SelectTrigger,\r\n  SelectValue,\r\n} from \"@/components/ui/select\";\r\n\r\n/** =========================\r\n *  Props\r\n *  ========================= */\r\ninterface BalanceDashboardProps {\r\n  user: User;\r\n  selectedPoint: PuntoAtencion | null;\r\n}\r\n\r\ntype BalanceDashboardTab = \"saldos\" | \"contabilidad\";\r\n\r\ntype BalancePorMoneda = {\r\n  moneda_codigo: string;\r\n  balance: number;\r\n  detalles: {\r\n    cambiosDivisasOrigen: number;\r\n    cambiosDivisasDestino: number;\r\n    serviciosExternosIngresos: number;\r\n    serviciosExternosEgresos: number;\r\n    transferenciasNetas: number;\r\n  };\r\n};\r\n\r\ntype BalanceCompletoData = {\r\n  actividad: {\r\n    cambiosDivisas: number;\r\n    serviciosExternos: number;\r\n    transferenciasOrigen: number;\r\n    transferenciasDestino: number;\r\n    totalMovimientos: number;\r\n  };\r\n  balancesPorMoneda?: BalancePorMoneda[];\r\n};\r\n\r\nconst isTab = (v: string): v is BalanceDashboardTab =>\r\n  v === \"saldos\" || v === \"contabilidad\";\r\n\r\nconst extractErrorMessage = (err: unknown): string => {\r\n  if (typeof err === \"string\") return err;\r\n  if (err instanceof Error) return err.message;\r\n  if (err && typeof err === \"object\" && \"message\" in err) {\r\n    const msg = (err as { message?: unknown }).message;\r\n    if (typeof msg === \"string\") return msg;\r\n  }\r\n  return \"\";\r\n};\r\n\r\n/** =========================\r\n *  Helpers\r\n *  ========================= */\r\nconst formatMoney = (n: number, symbol = \"$\") =>\r\n  `${symbol}${new Intl.NumberFormat(\"en-US\", {\r\n    minimumFractionDigits: 2,\r\n    maximumFractionDigits: 2,\r\n  }).format(Number(n || 0))}`;\r\n\r\nconst getStatus = (s: VistaSaldosPorPunto) => {\r\n  if (Number(s.saldo_inicial) === 0) return \"Sin configurar\";\r\n  if (Number(s.diferencia) > 0) return \"Excedente\";\r\n  if (Number(s.diferencia) < 0) return \"D├®ficit\";\r\n  return \"Equilibrado\";\r\n};\r\n\r\nconst getStatusBadge = (status: string) => {\r\n  switch (status) {\r\n    case \"Sin configurar\":\r\n      return { variant: \"secondary\" as const, tone: \"text-gray-600\" };\r\n    case \"Excedente\":\r\n      return { variant: \"default\" as const, tone: \"text-green-700\" };\r\n    case \"D├®ficit\":\r\n      return { variant: \"destructive\" as const, tone: \"text-red-700\" };\r\n    case \"Equilibrado\":\r\n      return { variant: \"outline\" as const, tone: \"text-amber-700\" };\r\n    default:\r\n      return { variant: \"secondary\" as const, tone: \"text-gray-600\" };\r\n  }\r\n};\r\n\r\nconst diffIcon = (d: number) =>\r\n  d > 0 ? (\r\n    <TrendingUp className=\"h-4 w-4 text-green-600\" />\r\n  ) : d < 0 ? (\r\n    <TrendingDown className=\"h-4 w-4 text-red-600\" />\r\n  ) : (\r\n    <DollarSign className=\"h-4 w-4 text-gray-600\" />\r\n  );\r\n\r\n/** =========================\r\n *  Component\r\n *  ========================= */\r\nconst BalanceDashboard = ({ user, selectedPoint }: BalanceDashboardProps) => {\r\n  const [saldos, setSaldos] = useState<VistaSaldosPorPunto[]>([]);\r\n  const [loading, setLoading] = useState(false);\r\n  const [lastUpdate, setLastUpdate] = useState<Date | null>(null);\r\n\r\n  // Estado para balance completo\r\n  const [balanceCompleto, setBalanceCompleto] =\r\n    useState<BalanceCompletoData | null>(null);\r\n  const [loadingBalanceCompleto, setLoadingBalanceCompleto] = useState(false);\r\n\r\n  // UX: auto-refresh y controles de filtro\r\n  const [autoRefresh, setAutoRefresh] = useState(true);\r\n  const [tab, setTab] = useState<BalanceDashboardTab>(\"saldos\");\r\n  const isPrivileged = user.rol === \"ADMIN\" || user.rol === \"SUPER_USUARIO\";\r\n\r\n  // En roles no privilegiados, forzar pesta├▒a 'saldos'\r\n  useEffect(() => {\r\n    if (!isPrivileged && tab === \"contabilidad\") {\r\n      setTab(\"saldos\");\r\n    }\r\n  }, [isPrivileged, tab]);\r\n\r\n  // Moneda seleccionada: por requerimiento, USD (principal) por defecto\r\n  const [selectedCurrency, setSelectedCurrency] = useState<string>(\"USD\");\r\n  const [onlyNonZeroDiff, setOnlyNonZeroDiff] = useState<boolean>(false);\r\n\r\n  /** ===== Fetch ===== */\r\n  const loadSaldos = useCallback(async () => {\r\n    if (!selectedPoint) return;\r\n    setLoading(true);\r\n    try {\r\n      const resp = await saldoInicialService.getVistaSaldosPorPunto({\r\n        pointId: selectedPoint.id,\r\n        reconciliar: true,\r\n      });\r\n      if (resp.error) {\r\n        toast({\r\n          title: \"Error\",\r\n          description: resp.error,\r\n          variant: \"destructive\",\r\n        });\r\n        return;\r\n      }\r\n      const items = (resp.saldos || []).filter(\r\n        (s: VistaSaldosPorPunto) => s.punto_atencion_id === selectedPoint.id\r\n      );\r\n      setSaldos(items);\r\n      setLastUpdate(new Date());\r\n    } catch (e: unknown) {\r\n      toast({\r\n        title: \"Error\",\r\n        description:\r\n          extractErrorMessage(e) ||\r\n          \"Error inesperado al cargar los saldos del punto.\",\r\n        variant: \"destructive\",\r\n      });\r\n    } finally {\r\n      setLoading(false);\r\n    }\r\n  }, [selectedPoint]);\r\n\r\n  /** ===== Fetch Balance Completo ===== */\r\n  const loadBalanceCompleto = useCallback(async () => {\r\n    if (!selectedPoint) return;\r\n    setLoadingBalanceCompleto(true);\r\n    try {\r\n      const data = await apiService.get(\r\n        `/balance-completo/punto/${selectedPoint.id}`\r\n      );\r\n      if (data.success) {\r\n        setBalanceCompleto(data.data);\r\n      } else {\r\n        throw new Error(data.error || \"Error al cargar balance completo\");\r\n      }\r\n    } catch (e: unknown) {\r\n      toast({\r\n        title: \"Error\",\r\n        description:\r\n          extractErrorMessage(e) ||\r\n          \"Error inesperado al cargar el balance completo.\",\r\n        variant: \"destructive\",\r\n      });\r\n    } finally {\r\n      setLoadingBalanceCompleto(false);\r\n    }\r\n  }, [selectedPoint]);\r\n\r\n  /** ===== Auto refresh (30s) + visibilidad ===== */\r\n  useEffect(() => {\r\n    if (!selectedPoint) return;\r\n    loadSaldos();\r\n    loadBalanceCompleto();\r\n\r\n    let interval: number | undefined;\r\n    const tick = () => {\r\n      if (autoRefresh && !document.hidden) {\r\n        loadSaldos();\r\n        loadBalanceCompleto();\r\n      }\r\n    };\r\n    interval = window.setInterval(tick, 30000);\r\n\r\n    const onVis = () => {\r\n      if (!document.hidden && autoRefresh) {\r\n        loadSaldos();\r\n        loadBalanceCompleto();\r\n      }\r\n    };\r\n    document.addEventListener(\"visibilitychange\", onVis);\r\n\r\n    return () => {\r\n      if (interval) clearInterval(interval);\r\n      document.removeEventListener(\"visibilitychange\", onVis);\r\n    };\r\n  }, [selectedPoint, autoRefresh, loadSaldos, loadBalanceCompleto]);\r\n\r\n  /** ===== Eventos globales ===== */\r\n  useEffect(() => {\r\n    const onExchange = () => {\r\n      loadSaldos();\r\n      loadBalanceCompleto();\r\n    };\r\n    const onTransfer = () => {\r\n      loadSaldos();\r\n      loadBalanceCompleto();\r\n    };\r\n    window.addEventListener(\"exchangeCompleted\", onExchange);\r\n    window.addEventListener(\"transferApproved\", onTransfer);\r\n    return () => {\r\n      window.removeEventListener(\"exchangeCompleted\", onExchange);\r\n      window.removeEventListener(\"transferApproved\", onTransfer);\r\n    };\r\n  }, [loadSaldos, loadBalanceCompleto]);\r\n\r\n  /** ===== Opciones de moneda (para selector) ===== */\r\n  const currencyOptions = useMemo(() => {\r\n    const set = new Set<string>();\r\n    saldos.forEach((s) => set.add(s.moneda_codigo));\r\n    const list = Array.from(set);\r\n    // USD primero, luego alfab├®tico\r\n    list.sort((a, b) =>\r\n      a === \"USD\" ? -1 : b === \"USD\" ? 1 : a.localeCompare(b)\r\n    );\r\n    return list;\r\n  }, [saldos]);\r\n\r\n  /** ===== Derivados por filtros ===== */\r\n  const sortedSaldos = useMemo(() => {\r\n    const base = saldos.filter((s) => s.moneda_codigo === selectedCurrency);\r\n    // (Opcional) en el futuro podr├¡as tener m├║ltiples por misma moneda; ordena por s├¡mbolo/alfab├®tico si aplica\r\n    return [...base].sort((a, b) =>\r\n      a.moneda_nombre.localeCompare(b.moneda_nombre)\r\n    );\r\n  }, [saldos, selectedCurrency]);\r\n\r\n  const filteredSaldos = useMemo(() => {\r\n    if (!onlyNonZeroDiff) return sortedSaldos;\r\n    return sortedSaldos.filter((s) => Number(s.diferencia || 0) !== 0);\r\n  }, [sortedSaldos, onlyNonZeroDiff]);\r\n\r\n  const totalDiff = useMemo(\r\n    () => filteredSaldos.reduce((acc, s) => acc + Number(s.diferencia || 0), 0),\r\n    [filteredSaldos]\r\n  );\r\n\r\n  /** ===== Guard ===== */\r\n  if (!selectedPoint) {\r\n    return (\r\n      <div className=\"p-6\">\r\n        <div className=\"text-center py-12\">\r\n          <p className=\"text-gray-500 text-lg\">\r\n            Debe seleccionar un punto de atenci├│n para ver los saldos.\r\n          </p>\r\n        </div>\r\n      </div>\r\n    );\r\n  }\r\n\r\n  /** ===== UI ===== */\r\n  return (\r\n    <div className=\"space-y-6\">\r\n      {/* Header */}\r\n      <div className=\"flex items-center justify-between flex-wrap gap-3\">\r\n        <div>\r\n          <h2 className=\"text-2xl font-bold text-gray-800\">\r\n            Dashboard Operativo\r\n          </h2>\r\n          <div className=\"flex items-center gap-2 text-gray-600\">\r\n            <span>\r\n              {selectedPoint.nombre} ÔÇó {selectedPoint.ciudad}\r\n            </span>\r\n            {lastUpdate && (\r\n              <span className=\"text-xs text-gray-500\">\r\n                ÔÇó Actualizado: {lastUpdate.toLocaleTimeString()}\r\n              </span>\r\n            )}\r\n          </div>\r\n        </div>\r\n\r\n        <div className=\"flex items-center gap-2\">\r\n          {/* Moneda principal por defecto (USD) + selector de divisa */}\r\n          <div className=\"flex items-center gap-2\">\r\n            <span className=\"text-xs text-gray-600\">Moneda</span>\r\n            <Select\r\n              value={selectedCurrency}\r\n              onValueChange={(v) => setSelectedCurrency(v)}\r\n            >\r\n              <SelectTrigger className=\"h-8 w-44\">\r\n                <SelectValue placeholder=\"Selecciona divisa\" />\r\n              </SelectTrigger>\r\n              <SelectContent>\r\n                {currencyOptions.map((c) => (\r\n                  <SelectItem key={c} value={c}>\r\n                    {c}\r\n                    {c === \"USD\" ? \" (principal)\" : \"\"}\r\n                  </SelectItem>\r\n                ))}\r\n              </SelectContent>\r\n            </Select>\r\n          </div>\r\n\r\n          <Badge\r\n            variant={onlyNonZeroDiff ? \"default\" : \"outline\"}\r\n            className=\"cursor-pointer\"\r\n            onClick={() => setOnlyNonZeroDiff((v) => !v)}\r\n            title=\"Mostrar solo saldos con diferencia Ôëá 0\"\r\n          >\r\n            Ôëá 0\r\n          </Badge>\r\n\r\n          <Badge\r\n            variant={autoRefresh ? \"default\" : \"outline\"}\r\n            className=\"cursor-pointer\"\r\n            onClick={() => setAutoRefresh((v) => !v)}\r\n            title=\"Conmuta auto-actualizaci├│n (30s)\"\r\n          >\r\n            ­ƒöä Auto {autoRefresh ? \"ON\" : \"OFF\"}\r\n          </Badge>\r\n\r\n          <Button\r\n            onClick={() => {\r\n              loadSaldos();\r\n              loadBalanceCompleto();\r\n            }}\r\n            disabled={loading || loadingBalanceCompleto}\r\n            variant=\"outline\"\r\n            size=\"sm\"\r\n          >\r\n            <RefreshCw\r\n              className={`h-4 w-4 mr-2 ${\r\n                loading || loadingBalanceCompleto ? \"animate-spin\" : \"\"\r\n              }`}\r\n            />\r\n            Actualizar\r\n          </Button>\r\n          <Button\r\n            variant=\"outline\"\r\n            size=\"icon\"\r\n            className=\"h-8 w-8\"\r\n            onClick={() => window.scrollTo({ top: 0, behavior: \"smooth\" })}\r\n            title=\"Ir arriba\"\r\n          >\r\n            <ArrowUp className=\"h-4 w-4\" />\r\n          </Button>\r\n        </div>\r\n      </div>\r\n\r\n      <Tabs\r\n        defaultValue=\"saldos\"\r\n        value={tab}\r\n        onValueChange={(v) => {\r\n          if (isTab(v)) setTab(v);\r\n        }}\r\n        className=\"w-full\"\r\n      >\r\n        <TabsList\r\n          className={`grid w-full ${\r\n            isPrivileged ? \"grid-cols-2\" : \"grid-cols-1\"\r\n          }`}\r\n        >\r\n          <TabsTrigger value=\"saldos\" className=\"flex items-center gap-2\">\r\n            <BarChart3 className=\"h-4 w-4\" />\r\n            Saldos por Moneda\r\n          </TabsTrigger>\r\n          {isPrivileged && (\r\n            <TabsTrigger\r\n              value=\"contabilidad\"\r\n              className=\"flex items-center gap-2\"\r\n            >\r\n              <Calculator className=\"h-4 w-4\" />\r\n              Contabilidad Diaria\r\n            </TabsTrigger>\r\n          )}\r\n        </TabsList>\r\n\r\n        {/* ================= SALDOS ================= */}\r\n        <TabsContent value=\"saldos\" className=\"space-y-6\">\r\n          {/* Resumen: basado en lo que se ve (moneda seleccionada y filtro) */}\r\n          <div className=\"grid grid-cols-1 md:grid-cols-3 gap-4\">\r\n            <Card>\r\n              <CardHeader className=\"flex flex-row items-center justify-between space-y-0 pb-2\">\r\n                <CardTitle className=\"text-sm font-medium\">\r\n                  Moneda seleccionada\r\n                </CardTitle>\r\n                <DollarSign className=\"h-4 w-4 text-muted-foreground\" />\r\n              </CardHeader>\r\n              <CardContent>\r\n                <div className=\"text-2xl font-bold\">\r\n                  {selectedCurrency}{\" \"}\r\n                  {selectedCurrency === \"USD\" ? \"ÔÇó Principal\" : \"\"}\r\n                </div>\r\n                <p className=\"text-xs text-muted-foreground\">\r\n                  Cambia la divisa desde el selector\r\n                </p>\r\n              </CardContent>\r\n            </Card>\r\n\r\n            <Card>\r\n              <CardHeader className=\"flex flex-row items-center justify-between space-y-0 pb-2\">\r\n                <CardTitle className=\"text-sm font-medium\">\r\n                  Balance General ({selectedCurrency})\r\n                </CardTitle>\r\n                {diffIcon(totalDiff)}\r\n              </CardHeader>\r\n              <CardContent>\r\n                <div\r\n                  className={`text-2xl font-bold ${\r\n                    totalDiff >= 0 ? \"text-green-700\" : \"text-red-700\"\r\n                  }`}\r\n                >\r\n                  {totalDiff >= 0 ? \"+\" : \"\"}\r\n                  {formatMoney(Math.abs(totalDiff))}\r\n                </div>\r\n                <p className=\"text-xs text-muted-foreground\">\r\n                  Diferencia total vs inicial (filtrados)\r\n                </p>\r\n              </CardContent>\r\n            </Card>\r\n\r\n            <Card>\r\n              <CardHeader className=\"flex flex-row items-center justify-between space-y-0 pb-2\">\r\n                <CardTitle className=\"text-sm font-medium\">\r\n                  ├Ültima Actualizaci├│n\r\n                </CardTitle>\r\n                <RefreshCw className=\"h-4 w-4 text-muted-foreground\" />\r\n              </CardHeader>\r\n              <CardContent>\r\n                <div className=\"text-2xl font-bold\">\r\n                  {lastUpdate ? lastUpdate.toLocaleTimeString() : \"--:--\"}\r\n                </div>\r\n                <p className=\"text-xs text-muted-foreground\">\r\n                  {lastUpdate\r\n                    ? lastUpdate.toLocaleDateString()\r\n                    : \"No actualizado\"}\r\n                </p>\r\n              </CardContent>\r\n            </Card>\r\n          </div>\r\n\r\n          {/* Balance Completo del Punto */}\r\n          {balanceCompleto && (\r\n            <Card>\r\n              <CardHeader>\r\n                <CardTitle className=\"flex items-center gap-2\">\r\n                  <Calculator className=\"h-5 w-5\" />\r\n                  Balance Completo - {selectedPoint.nombre}\r\n                  {loadingBalanceCompleto && (\r\n                    <div className=\"animate-spin rounded-full h-4 w-4 border-b-2 border-blue-600\" />\r\n                  )}\r\n                </CardTitle>\r\n              </CardHeader>\r\n              <CardContent>\r\n                <div className=\"grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4 mb-6\">\r\n                  <div className=\"bg-blue-50 p-4 rounded-lg\">\r\n                    <p className=\"text-sm text-blue-600 font-medium\">\r\n                      Cambios de Divisas\r\n                    </p>\r\n                    <p className=\"text-2xl font-bold text-blue-800\">\r\n                      {balanceCompleto.actividad.cambiosDivisas}\r\n                    </p>\r\n                  </div>\r\n                  <div className=\"bg-green-50 p-4 rounded-lg\">\r\n                    <p className=\"text-sm text-green-600 font-medium\">\r\n                      Servicios Externos\r\n                    </p>\r\n                    <p className=\"text-2xl font-bold text-green-800\">\r\n                      {balanceCompleto.actividad.serviciosExternos}\r\n                    </p>\r\n                  </div>\r\n                  <div className=\"bg-purple-50 p-4 rounded-lg\">\r\n                    <p className=\"text-sm text-purple-600 font-medium\">\r\n                      Transferencias\r\n                    </p>\r\n                    <p className=\"text-2xl font-bold text-purple-800\">\r\n                      {balanceCompleto.actividad.transferenciasOrigen +\r\n                        balanceCompleto.actividad.transferenciasDestino}\r\n                    </p>\r\n                  </div>\r\n                  <div className=\"bg-gray-50 p-4 rounded-lg\">\r\n                    <p className=\"text-sm text-gray-600 font-medium\">\r\n                      Total Movimientos\r\n                    </p>\r\n                    <p className=\"text-2xl font-bold text-gray-800\">\r\n                      {balanceCompleto.actividad.totalMovimientos}\r\n                    </p>\r\n                  </div>\r\n                </div>\r\n\r\n                {balanceCompleto.balancesPorMoneda &&\r\n                  balanceCompleto.balancesPorMoneda.length > 0 && (\r\n                    <div>\r\n                      <h4 className=\"text-lg font-semibold mb-3\">\r\n                        Balance por Moneda\r\n                      </h4>\r\n                      <div className=\"grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-3\">\r\n                        {balanceCompleto.balancesPorMoneda.map(\r\n                          (balance) => (\r\n                            <div\r\n                              key={balance.moneda_codigo}\r\n                              className=\"border rounded-lg p-3\"\r\n                            >\r\n                              <div className=\"flex items-center justify-between mb-2\">\r\n                                <span className=\"font-medium\">\r\n                                  {balance.moneda_codigo}\r\n                                </span>\r\n                                <span\r\n                                  className={`font-bold ${\r\n                                    balance.balance >= 0\r\n                                      ? \"text-green-600\"\r\n                                      : \"text-red-600\"\r\n                                  }`}\r\n                                >\r\n                                  {balance.balance >= 0 ? \"+\" : \"\"}\r\n                                  {formatMoney(balance.balance)}\r\n                                </span>\r\n                              </div>\r\n                              <div className=\"text-xs text-gray-600 space-y-1\">\r\n                                <div>\r\n                                  Cambios: -\r\n                                  {formatMoney(\r\n                                    balance.detalles.cambiosDivisasOrigen\r\n                                  )}{\" \"}\r\n                                  / +\r\n                                  {formatMoney(\r\n                                    balance.detalles.cambiosDivisasDestino\r\n                                  )}\r\n                                </div>\r\n                                <div>\r\n                                  Servicios: +\r\n                                  {formatMoney(\r\n                                    balance.detalles.serviciosExternosIngresos\r\n                                  )}{\" \"}\r\n                                  / -\r\n                                  {formatMoney(\r\n                                    balance.detalles.serviciosExternosEgresos\r\n                                  )}\r\n                                </div>\r\n                                <div>\r\n                                  Transferencias:{\" \"}\r\n                                  {formatMoney(\r\n                                    balance.detalles.transferenciasNetas\r\n                                  )}\r\n                                </div>\r\n                              </div>\r\n                            </div>\r\n                          )\r\n                        )}\r\n                      </div>\r\n                    </div>\r\n                  )}\r\n              </CardContent>\r\n            </Card>\r\n          )}\r\n\r\n          {/* Detalle por Moneda (s├│lo la seleccionada) */}\r\n          {loading && filteredSaldos.length === 0 ? (\r\n            <Card>\r\n              <CardContent className=\"flex items-center justify-center py-16\">\r\n                <div className=\"text-center\">\r\n                  <div className=\"animate-spin rounded-full h-12 w-12 border-b-2 border-blue-600 mx-auto mb-4\" />\r\n                  <p className=\"text-gray-600\">Cargando saldosÔÇª</p>\r\n                </div>\r\n              </CardContent>\r\n            </Card>\r\n          ) : filteredSaldos.length === 0 ? (\r\n            <Card>\r\n              <CardContent className=\"flex items-center justify-center py-12\">\r\n                <div className=\"text-center\">\r\n                  <AlertTriangle className=\"h-12 w-12 text-amber-500 mx-auto mb-3\" />\r\n                  <p className=\"text-gray-600 text-base\">\r\n                    No hay saldos que coincidan con los filtros.\r\n                  </p>\r\n                  <p className=\"text-gray-400 text-sm\">\r\n                    Revisa la divisa seleccionada o desactiva ÔÇ£Ôëá 0ÔÇØ.\r\n                  </p>\r\n                </div>\r\n              </CardContent>\r\n            </Card>\r\n          ) : (\r\n            <div className=\"grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 2xl:grid-cols-5 gap-3\">\r\n              {filteredSaldos.map((s) => {\r\n                const status = getStatus(s);\r\n                const badge = getStatusBadge(status);\r\n                const diff = Number(s.diferencia || 0);\r\n\r\n                return (\r\n                  <Card\r\n                    key={`${s.punto_atencion_id}-${s.moneda_id}`}\r\n                    className=\"transition-all duration-200 hover:shadow-lg rounded-xl border\"\r\n                  >\r\n                    <CardHeader className=\"pb-2\">\r\n                      <div className=\"flex items-center justify-between gap-2\">\r\n                        <CardTitle\r\n                          className=\"text-sm font-semibold truncate\"\r\n                          title={`${s.moneda_codigo} ÔÇó ${s.moneda_nombre}`}\r\n                        >\r\n                          {s.moneda_codigo} ÔÇó {s.moneda_nombre}\r\n                        </CardTitle>\r\n                        <Badge variant={badge.variant} className=\"text-[11px]\">\r\n                          {status}\r\n                        </Badge>\r\n                      </div>\r\n                    </CardHeader>\r\n                    <CardContent>\r\n                      <div className=\"space-y-2\">\r\n                        <div className=\"grid grid-cols-2 gap-2\">\r\n                          <div className=\"rounded-md border bg-blue-50/60 p-2\">\r\n                            <p className=\"text-[11px] text-blue-700\">\r\n                              Saldo Inicial\r\n                            </p>\r\n                            <p className=\"text-lg font-bold text-blue-900\">\r\n                              {formatMoney(\r\n                                Number(s.saldo_inicial || 0),\r\n                                s.moneda_simbolo\r\n                              )}\r\n                            </p>\r\n                          </div>\r\n                          <div className=\"rounded-md border bg-green-50/60 p-2\">\r\n                            <p className=\"text-[11px] text-green-700\">\r\n                              Saldo Actual\r\n                            </p>\r\n                            <p className=\"text-lg font-bold text-green-900\">\r\n                              {formatMoney(\r\n                                Number(s.saldo_actual || 0),\r\n                                s.moneda_simbolo\r\n                              )}\r\n                            </p>\r\n                          </div>\r\n                        </div>\r\n\r\n                        <div\r\n                          className={`rounded-md border p-2 flex items-center justify-between ${\r\n                            diff >= 0 ? \"bg-green-50/70\" : \"bg-red-50/70\"\r\n                          }`}\r\n                        >\r\n                          <div>\r\n                            <p\r\n                              className={`text-[11px] font-medium ${\r\n                                diff >= 0 ? \"text-green-700\" : \"text-red-700\"\r\n                              }`}\r\n                            >\r\n                              Diferencia\r\n                            </p>\r\n                            <p\r\n                              className={`text-base font-bold ${\r\n                                diff >= 0 ? \"text-green-800\" : \"text-red-800\"\r\n                              }`}\r\n                            >\r\n                              {diff >= 0 ? \"+\" : \"\"}\r\n                              {formatMoney(Math.abs(diff), s.moneda_simbolo)}\r\n                            </p>\r\n                          </div>\r\n                          {diffIcon(diff)}\r\n                        </div>\r\n\r\n                        <div className=\"rounded-md bg-gray-50 p-2 text-xs text-gray-600\">\r\n                          F├¡sico: <b>{s.billetes}</b> billetes ÔÇó{\" \"}\r\n                          <b>{s.monedas_fisicas}</b> monedas\r\n                        </div>\r\n\r\n                        {s.ultima_actualizacion && (\r\n                          <div className=\"pt-1 text-[11px] text-gray-500\">\r\n                            ├Ültima actualizaci├│n:{\" \"}\r\n                            {new Date(s.ultima_actualizacion).toLocaleString()}\r\n                          </div>\r\n                        )}\r\n                      </div>\r\n                    </CardContent>\r\n                  </Card>\r\n                );\r\n              })}\r\n            </div>\r\n          )}\r\n        </TabsContent>\r\n\r\n        {/* ============== CONTABILIDAD ============== */}\r\n        {isPrivileged && (\r\n          <TabsContent value=\"contabilidad\">\r\n            <ContabilidadDiaria user={user} selectedPoint={selectedPoint} />\r\n          </TabsContent>\r\n        )}\r\n      </Tabs>\r\n    </div>\r\n  );\r\n};\r\n\r\nexport default BalanceDashboard;\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\oswal\\OneDrive\\Documentos\\Punto Cambio\\punto_cambio_new\\src\\components\\dashboard\\ContabilidadDiaria.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\oswal\\OneDrive\\Documentos\\Punto Cambio\\punto_cambio_new\\src\\components\\dashboard\\Dashboard.tsx","messages":[],"suppressedMessages":[{"ruleId":"react-hooks/exhaustive-deps","severity":1,"message":"React Hook useEffect has missing dependencies: 'searchParams' and 'setQueryParam'. Either include them or remove the dependency array.","line":193,"column":6,"nodeType":"ArrayExpression","endLine":193,"endColumn":18,"suggestions":[{"desc":"Update the dependencies array to be: [activeView, searchParams, setQueryParam]","fix":{"range":[5966,5978],"text":"[activeView, searchParams, setQueryParam]"}}],"suppressions":[{"kind":"directive","justification":""}]}],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\oswal\\OneDrive\\Documentos\\Punto Cambio\\punto_cambio_new\\src\\components\\dashboard\\Header.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\oswal\\OneDrive\\Documentos\\Punto Cambio\\punto_cambio_new\\src\\components\\dashboard\\OldPointSelector.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\oswal\\OneDrive\\Documentos\\Punto Cambio\\punto_cambio_new\\src\\components\\dashboard\\QuickStats.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\oswal\\OneDrive\\Documentos\\Punto Cambio\\punto_cambio_new\\src\\components\\dashboard\\RecentTransfers.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\oswal\\OneDrive\\Documentos\\Punto Cambio\\punto_cambio_new\\src\\components\\dashboard\\Sidebar.tsx","messages":[{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'isConcesion' is assigned a value but never used. Allowed unused vars must match /^_/u.","line":46,"column":9,"nodeType":null,"messageId":"unusedVar","endLine":46,"endColumn":20}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":1,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import { useState, useEffect } from \"react\";\nimport { Button } from \"@/components/ui/button\";\nimport { ScrollArea } from \"@/components/ui/scroll-area\";\nimport { Separator } from \"@/components/ui/separator\";\nimport { Badge } from \"@/components/ui/badge\";\nimport { X, Menu, ChevronDown, ChevronRight, BarChart3 } from \"lucide-react\";\nimport { User, PuntoAtencion } from \"../../types\";\n\ninterface SidebarProps {\n  user: User;\n  selectedPoint: PuntoAtencion | null;\n  activeView: string;\n  onViewChange: (view: string) => void;\n  isOpen: boolean;\n  onToggle: () => void;\n}\n\ninterface MenuItem {\n  id: string;\n  label: string;\n  color: string;\n  roles?: string[];\n}\n\nconst Sidebar = ({\n  user,\n  selectedPoint,\n  activeView,\n  onViewChange,\n  isOpen,\n  onToggle,\n}: SidebarProps) => {\n  const [adminExpanded, setAdminExpanded] = useState(false);\n  const [isMobile, setIsMobile] = useState(false);\n\n  useEffect(() => {\n    const handleResize = () => {\n      setIsMobile(window.innerWidth < 1024);\n    };\n    handleResize();\n    window.addEventListener(\"resize\", handleResize);\n    return () => window.removeEventListener(\"resize\", handleResize);\n  }, []);\n\n  const isAdmin = user.rol === \"ADMIN\" || user.rol === \"SUPER_USUARIO\";\n  const isConcesion = user.rol === \"CONCESION\";\n\n  const menuItems: MenuItem[] = [\n    {\n      id: \"exchanges\",\n      label: \"Cambio de Divisas\",\n      color: \"text-blue-600\",\n      roles: [\"OPERADOR\"],\n    },\n    {\n      id: \"pending-exchanges\",\n      label: \"Cambios Pendientes\",\n      color: \"text-red-600\",\n      roles: [\"OPERADOR\"],\n    },\n    {\n      id: \"transfers\",\n      label: \"Transferencias\",\n      color: \"text-green-600\",\n      roles: [\"OPERADOR\"],\n    },\n    {\n      id: \"transfer-acceptance\",\n      label: \"Recibir Transferencias\",\n      color: \"text-blue-600\",\n      roles: [\"OPERADOR\", \"CONCESION\"],\n    },\n    {\n      id: \"operator-time-management\",\n      label: \"Gesti├│n de Horarios\",\n      color: \"text-purple-600\",\n      roles: [\"OPERADOR\", \"ADMINISTRATIVO\"],\n    },\n    {\n      id: \"permission-request\",\n      label: \"Permisos de Salida\",\n      color: \"text-pink-600\",\n      roles: [\"OPERADOR\", \"ADMINISTRATIVO\"],\n    },\n    {\n      id: \"daily-close\",\n      label: \"Cierre Diario\",\n      color: \"text-orange-600\",\n      roles: [\"OPERADOR\"],\n    },\n    {\n      id: \"servientrega\",\n      label: \"Gu├¡a Servientrega\",\n      color: \"text-cyan-600\",\n      roles: [\"OPERADOR\", \"CONCESION\"],\n    },\n    {\n      id: \"contabilidad-divisas\",\n      label: \"Contabilidad por Punto\",\n      color: \"text-emerald-600\",\n      roles: [\"OPERADOR\"],\n    },\n    {\n      id: \"servicios-externos\",\n      label: \"Servicios Externos\",\n      color: \"text-emerald-700\",\n      roles: [\"OPERADOR\"],\n    },\n    {\n      id: \"transfer-approvals\",\n      label: \"Aprobaciones\",\n      color: \"text-yellow-600\",\n      roles: [\"CONCESION\"],\n    },\n  ];\n\n  const adminMenuItems: MenuItem[] = [\n    // Supervisi├│n y contabilidad\n    {\n      id: \"contabilidad-general\",\n      label: \"Contabilidad General\",\n      color: \"text-emerald-600\",\n    },\n    {\n      id: \"contabilidad-por-punto\",\n      label: \"Control por Punto\",\n      color: \"text-teal-600\",\n    },\n    {\n      id: \"reports\",\n      label: \"Reportes Generales\",\n      color: \"text-red-600\",\n    },\n    // Acceso a cambios para ver/eliminar\n    {\n      id: \"exchanges\",\n      label: \"Cambios (admin)\",\n      color: \"text-blue-700\",\n    },\n    // Separador visual\n    {\n      id: \"separator-1\",\n      label: \"---\",\n      color: \"\",\n    },\n    // Gesti├│n de usuarios y puntos\n    {\n      id: \"users\",\n      label: \"Usuarios\",\n      color: \"text-blue-600\",\n    },\n    {\n      id: \"points\",\n      label: \"Puntos de Atenci├│n\",\n      color: \"text-green-600\",\n    },\n    {\n      id: \"admin-time-management\",\n      label: \"Control de Horarios\",\n      color: \"text-purple-600\",\n    },\n    // Separador visual\n    {\n      id: \"separator-2\",\n      label: \"---\",\n      color: \"\",\n    },\n    // Gesti├│n financiera\n    {\n      id: \"currencies\",\n      label: \"Gesti├│n de Monedas\",\n      color: \"text-indigo-600\",\n    },\n    {\n      id: \"currency-behaviors\",\n      label: \"Comportamientos de Divisas\",\n      color: \"text-indigo-500\",\n    },\n    {\n      id: \"balance-management\",\n      label: \"Gesti├│n de Saldos\",\n      color: \"text-blue-600\",\n    },\n    {\n      id: \"transfer-approvals\",\n      label: \"Aprobaciones\",\n      color: \"text-yellow-600\",\n    },\n    {\n      id: \"permission-approvals\",\n      label: \"Aprobaci├│n de Permisos\",\n      color: \"text-pink-700\",\n    },\n    {\n      id: \"cierres-diarios\",\n      label: \"Resumen Cierres Diarios\",\n      color: \"text-orange-600\",\n    },\n    // Separador visual\n    {\n      id: \"separator-3\",\n      label: \"---\",\n      color: \"\",\n    },\n    // Gesti├│n de Servientrega\n    {\n      id: \"servientrega-saldo\",\n      label: \"Saldo Servientrega\",\n      color: \"text-cyan-600\",\n    },\n    {\n      id: \"servientrega-anulaciones\",\n      label: \"Anulaciones Servientrega\",\n      color: \"text-orange-600\",\n    },\n    {\n      id: \"servientrega-informes\",\n      label: \"Informes Servientrega\",\n      color: \"text-purple-600\",\n    },\n    // Separador visual\n    {\n      id: \"separator-4\",\n      label: \"---\",\n      color: \"\",\n    },\n    // Administraci├│n de servicios externos\n    {\n      id: \"servicios-externos-admin\",\n      label: \"Admin Servicios Externos\",\n      color: \"text-emerald-700\",\n    },\n  ];\n\n  const renderMenuItem = (item: MenuItem) => {\n    // Renderizar separadores\n    if (item.id.startsWith(\"separator\")) {\n      return isOpen ? <Separator key={item.id} className=\"my-2\" /> : null;\n    }\n\n    const isActive = activeView === item.id;\n    return (\n      <Button\n        key={item.id}\n        variant={isActive ? \"default\" : \"ghost\"}\n        className={`w-full justify-start h-8 px-3 text-sm ${\n          isActive ? \"bg-primary text-primary-foreground\" : \"hover:bg-muted\"\n        } ${!isOpen ? \"px-2\" : \"\"} transition-all`}\n        onClick={() => onViewChange(item.id)}\n      >\n        {isOpen && <span className=\"font-medium truncate\">{item.label}</span>}\n        {!isOpen && (\n          <span className=\"text-xs font-bold mx-auto\">\n            {item.label.charAt(0)}\n          </span>\n        )}\n      </Button>\n    );\n  };\n\n  return (\n    <>\n      {isMobile && isOpen && (\n        <div\n          className=\"fixed inset-0 bg-black bg-opacity-50 z-40\"\n          onClick={onToggle}\n        />\n      )}\n\n      <aside\n        className={`\n          fixed top-0 left-0 h-screen bg-white border-r z-50 transition-all duration-300\n          flex flex-col\n          ${isOpen ? \"w-64 sm:w-72 lg:w-64\" : \"w-12 sm:w-14\"}\n          ${isMobile ? \"shadow-xl\" : \"\"}\n          lg:relative lg:z-auto\n        `}\n      >\n        <div className=\"flex items-center justify-between p-3 border-b\">\n          {isOpen && (\n            <div className=\"flex-1 min-w-0\">\n              <h1 className=\"text-sm font-bold text-primary\">PuntoCambio</h1>\n              <p className=\"text-xs text-muted-foreground\">\n                Sistema de Gesti├│n\n              </p>\n            </div>\n          )}\n          <Button\n            variant=\"ghost\"\n            size=\"sm\"\n            onClick={onToggle}\n            className=\"p-1 h-8 w-8 ml-2\"\n          >\n            {isOpen ? <X className=\"h-4 w-4\" /> : <Menu className=\"h-4 w-4\" />}\n          </Button>\n        </div>\n\n        <ScrollArea className=\"flex-1 px-2 py-4\">\n          <div className=\"space-y-2\">\n            {isOpen && (\n              <div className=\"mb-4\">\n                <div className=\"bg-blue-50 rounded-lg p-3\">\n                  <p className=\"font-medium text-sm text-blue-900\">\n                    {user.nombre}\n                  </p>\n                  <p className=\"text-xs text-gray-600 capitalize\">\n                    {user.rol?.replace(\"_\", \" \").toLowerCase()}\n                  </p>\n                  {selectedPoint && (\n                    <div className=\"mt-2\">\n                      <Badge variant=\"outline\" className=\"text-xs\">\n                        {selectedPoint.nombre}\n                      </Badge>\n                    </div>\n                  )}\n                </div>\n              </div>\n            )}\n\n            <Button\n              variant={activeView === \"dashboard\" ? \"default\" : \"ghost\"}\n              className={`w-full justify-start h-10 px-3 ${\n                activeView === \"dashboard\"\n                  ? \"bg-blue-700 text-white shadow\"\n                  : \"hover:bg-gray-100\"\n              } ${!isOpen ? \"px-2\" : \"\"} transition-all`}\n              onClick={() => onViewChange(\"dashboard\")}\n            >\n              <BarChart3\n                className={`h-4 w-4 text-blue-700 ${\n                  activeView === \"dashboard\" ? \"text-white\" : \"\"\n                } ${!isOpen ? \"mx-auto\" : \"mr-3\"}`}\n              />\n              {isOpen && <span className=\"text-sm font-medium\">Dashboard</span>}\n            </Button>\n\n            <Separator className=\"my-2\" />\n\n            {menuItems\n              .filter((item) => {\n                // Filtrar por rol\n                if (!item.roles?.includes(user.rol || \"\")) return false;\n\n                // Para opciones de Servientrega, verificar que el punto tenga agencia asignada\n                if (item.id === \"servientrega\") {\n                  return selectedPoint?.servientrega_agencia_codigo\n                    ? true\n                    : false;\n                }\n\n                return true;\n              })\n              .map(renderMenuItem)}\n\n            {isAdmin && (\n              <>\n                <Separator className=\"my-3\" />\n\n                {isOpen && (\n                  <Button\n                    variant=\"ghost\"\n                    className=\"w-full justify-between h-8 px-3 text-blue-900 hover:bg-gray-100\"\n                    onClick={() => setAdminExpanded(!adminExpanded)}\n                  >\n                    <span className=\"text-sm font-medium\">Administraci├│n</span>\n                    {adminExpanded ? (\n                      <ChevronDown className=\"h-4 w-4\" />\n                    ) : (\n                      <ChevronRight className=\"h-4 w-4\" />\n                    )}\n                  </Button>\n                )}\n\n                {(adminExpanded || !isOpen) && (\n                  <div className={`space-y-1 ${isOpen ? \"ml-2\" : \"\"}`}>\n                    {adminMenuItems.map(renderMenuItem)}\n                  </div>\n                )}\n              </>\n            )}\n          </div>\n        </ScrollArea>\n\n        {isOpen && (\n          <div className=\"p-3 border-t border-gray-200\">\n            <p className=\"text-xs text-gray-400 text-center\">\n              ┬® 2025 PuntoCambio\n            </p>\n          </div>\n        )}\n      </aside>\n    </>\n  );\n};\n\nexport default Sidebar;\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\oswal\\OneDrive\\Documentos\\Punto Cambio\\punto_cambio_new\\src\\components\\exchange\\AdminExchangeBrowser.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\oswal\\OneDrive\\Documentos\\Punto Cambio\\punto_cambio_new\\src\\components\\exchange\\CompletePaymentForm.tsx","messages":[{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'error' is defined but never used.","line":160,"column":14,"nodeType":null,"messageId":"unusedVar","endLine":160,"endColumn":19}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":1,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import { useState } from \"react\";\r\nimport { Button } from \"@/components/ui/button\";\r\nimport { Card, CardContent, CardHeader, CardTitle } from \"@/components/ui/card\";\r\nimport { toast } from \"sonner\";\r\nimport { CambioDivisa, User, PuntoAtencion } from \"../../types\";\r\nimport { exchangeService } from \"../../services/exchangeService\";\r\nimport { ReceiptService } from \"../../services/receiptService\";\r\nimport { movimientosContablesService } from \"../../services/movimientosContablesService\";\r\nimport DeliveryDetailsForm from \"./DeliveryDetailsForm\";\r\n\r\ninterface CompletePaymentFormProps {\r\n  exchange: CambioDivisa;\r\n  user: User;\r\n  selectedPoint: PuntoAtencion | null;\r\n  onComplete: () => void;\r\n  onCancel: () => void;\r\n}\r\n\r\ntype MetodoEntrega = \"efectivo\" | \"transferencia\";\r\n\r\ntype DeliveryDetails = {\r\n  metodoEntrega: MetodoEntrega;\r\n  transferenciaNumero?: string;\r\n  transferenciaBanco?: string;\r\n  transferenciaImagen?: File | null;\r\n  // Opcionalmente puede traer desglose de lo que el cliente recibe (por compatibilidad)\r\n  divisasRecibidas?: { billetes: number; monedas: number; total: number };\r\n};\r\n\r\nconst formatMoney = (n: number | null | undefined) => {\r\n  const v = Number(n);\r\n  return Number.isFinite(v)\r\n    ? v.toLocaleString(\"es-EC\", {\r\n        minimumFractionDigits: 2,\r\n        maximumFractionDigits: 2,\r\n      })\r\n    : \"0,00\";\r\n};\r\n\r\nconst CompletePaymentForm = ({\r\n  exchange,\r\n  user,\r\n  selectedPoint,\r\n  onComplete,\r\n  onCancel,\r\n}: CompletePaymentFormProps) => {\r\n  const [step, setStep] = useState<\"details\" | \"confirm\">(\"details\");\r\n  const [deliveryDetails, setDeliveryDetails] =\r\n    useState<DeliveryDetails | null>(null);\r\n  const [isProcessing, setIsProcessing] = useState(false);\r\n\r\n  const clienteStr = exchange.cliente || \"\"; // respaldo si no viene datos_cliente\r\n  const nombreCliente =\r\n    exchange.datos_cliente?.nombre ||\r\n    (clienteStr ? clienteStr.split(\" \")[0] : \"Cliente\");\r\n  const apellidoCliente =\r\n    exchange.datos_cliente?.apellido ||\r\n    (clienteStr ? clienteStr.split(\" \").slice(1).join(\" \") : \"\");\r\n\r\n  const montoDestino = Number(exchange.monto_destino || 0);\r\n  const saldoPendiente = Number(exchange.saldo_pendiente ?? 0);\r\n  const codigoMonedaDestino = exchange.monedaDestino?.codigo || \"\";\r\n\r\n  const handleDeliveryDetailsSubmit = (details: DeliveryDetails) => {\r\n    // Blindaje m├¡nimo aqu├¡ (DeliveryDetailsForm ya valida, pero reforzamos)\r\n    if (\r\n      details.metodoEntrega === \"transferencia\" &&\r\n      (!details.transferenciaNumero?.trim() ||\r\n        !details.transferenciaBanco?.trim())\r\n    ) {\r\n      toast.error(\"Debe indicar n├║mero y banco para la transferencia.\");\r\n      return;\r\n    }\r\n    setDeliveryDetails(details);\r\n    setStep(\"confirm\");\r\n  };\r\n\r\n  const handleCompletePayment = async () => {\r\n    if (!deliveryDetails) {\r\n      toast.error(\"Datos de entrega incompletos\");\r\n      return;\r\n    }\r\n\r\n    // Validaci├│n de transferencia (doble seguro)\r\n    if (\r\n      deliveryDetails.metodoEntrega === \"transferencia\" &&\r\n      (!deliveryDetails.transferenciaNumero?.trim() ||\r\n        !deliveryDetails.transferenciaBanco?.trim())\r\n    ) {\r\n      toast.error(\"Debe indicar n├║mero y banco para la transferencia.\");\r\n      return;\r\n    }\r\n\r\n    setIsProcessing(true);\r\n    try {\r\n      // 1) Completar el cambio pendiente en el backend\r\n      const { exchange: completedExchange, error } =\r\n        await exchangeService.completeExchange(exchange.id, deliveryDetails);\r\n\r\n      if (error || !completedExchange) {\r\n        toast.error(`Error al completar el cambio: ${error || \"sin detalles\"}`);\r\n        return;\r\n      }\r\n\r\n      // 2) Procesar contabilidad (no bloquea el flujo si falla)\r\n      try {\r\n        const { result, error: contabError } =\r\n          await movimientosContablesService.procesarMovimientosCambio(\r\n            completedExchange,\r\n            user.id\r\n          );\r\n\r\n        if (contabError) {\r\n          toast.warning(\r\n            `ÔÜá´©Å Cambio completado pero error en contabilidad: ${contabError}`\r\n          );\r\n        } else if (result?.success) {\r\n          const resumen = (result.saldos_actualizados || [])\r\n            .map(\r\n              (s) =>\r\n                `${s.moneda_id}: ${Number(s.saldo_anterior || 0).toFixed(\r\n                  2\r\n                )} ÔåÆ ${Number(s.saldo_nuevo || 0).toFixed(2)}`\r\n            )\r\n            .join(\", \");\r\n          if (resumen) toast.success(`Ô£à Saldos actualizados: ${resumen}`);\r\n        }\r\n      } catch (e) {\r\n        console.error(\r\n          \"Error inesperado al procesar contabilidad al completar cambio\",\r\n          e\r\n        );\r\n        toast.warning(\r\n          \"ÔÜá´©Å Cambio completado pero no se pudo actualizar contabilidad\"\r\n        );\r\n      }\r\n\r\n      // 3) Recibo de completaci├│n\r\n      try {\r\n        // Mantener firma consistente con otros usos:\r\n        // generatePartialExchangeReceipt(exchange, pointName, operador, isInitialPayment, details?)\r\n        const receiptData = ReceiptService.generatePartialExchangeReceipt(\r\n          completedExchange,\r\n          selectedPoint?.nombre || \"N/A\",\r\n          user.nombre,\r\n          false,\r\n          undefined // para completaci├│n no enviamos payload extra\r\n        );\r\n        ReceiptService.printReceipt(receiptData, 2);\r\n      } catch (printErr) {\r\n        console.warn(\"Fallo al imprimir recibo de completaci├│n:\", printErr);\r\n        toast.warning(\"ÔÜá´©Å Cambio completado. No se pudo imprimir el recibo.\");\r\n      }\r\n\r\n      // 4) Eventos para refrescar UI\r\n      window.dispatchEvent(new CustomEvent(\"exchangeCompleted\"));\r\n      window.dispatchEvent(new CustomEvent(\"saldosUpdated\"));\r\n\r\n      onComplete();\r\n    } catch (error) {\r\n      toast.error(\"Error al completar el cambio\");\r\n    } finally {\r\n      setIsProcessing(false);\r\n    }\r\n  };\r\n\r\n  if (step === \"details\") {\r\n    return (\r\n      <div className=\"space-y-6\">\r\n        <Card>\r\n          <CardHeader>\r\n            <CardTitle>Completar Cambio Pendiente</CardTitle>\r\n            <div className=\"text-sm text-gray-600\">\r\n              Cliente: {nombreCliente} {apellidoCliente}\r\n              <br />\r\n              Monto a entregar: {formatMoney(montoDestino)}{\" \"}\r\n              {codigoMonedaDestino}\r\n              {saldoPendiente > 0 && (\r\n                <>\r\n                  <br />\r\n                  Saldo pendiente: {formatMoney(saldoPendiente)}{\" \"}\r\n                  {codigoMonedaDestino}\r\n                </>\r\n              )}\r\n            </div>\r\n          </CardHeader>\r\n        </Card>\r\n\r\n        <DeliveryDetailsForm\r\n          exchange={exchange}\r\n          onSubmit={handleDeliveryDetailsSubmit}\r\n          onCancel={onCancel}\r\n          isCompletion={true}\r\n        />\r\n      </div>\r\n    );\r\n  }\r\n\r\n  // Paso de confirmaci├│n\r\n  return (\r\n    <div className=\"space-y-6\">\r\n      <Card>\r\n        <CardHeader>\r\n          <CardTitle>Confirmar Completaci├│n del Cambio</CardTitle>\r\n          <div className=\"text-sm text-gray-600\">\r\n            Cliente: {nombreCliente} {apellidoCliente}\r\n          </div>\r\n        </CardHeader>\r\n        <CardContent>\r\n          <div className=\"space-y-4\">\r\n            <div className=\"bg-green-50 p-4 rounded-lg border border-green-200\">\r\n              <h3 className=\"font-semibold text-green-800 mb-2\">\r\n                Resumen de la operaci├│n\r\n              </h3>\r\n              <div className=\"grid grid-cols-2 gap-4 text-sm\">\r\n                <div>\r\n                  <span className=\"text-gray-600\">Monto total:</span>\r\n                  <div className=\"font-bold text-green-700\">\r\n                    {formatMoney(montoDestino)} {codigoMonedaDestino}\r\n                  </div>\r\n                </div>\r\n                <div>\r\n                  <span className=\"text-gray-600\">M├®todo de entrega:</span>\r\n                  <div className=\"font-bold text-green-700\">\r\n                    {deliveryDetails?.metodoEntrega === \"efectivo\"\r\n                      ? \"Efectivo\"\r\n                      : \"Transferencia\"}\r\n                  </div>\r\n                </div>\r\n              </div>\r\n\r\n              {deliveryDetails?.metodoEntrega === \"transferencia\" && (\r\n                <div className=\"mt-3 pt-3 border-t border-green-200\">\r\n                  <div className=\"text-sm\">\r\n                    <div>\r\n                      <strong>Banco:</strong>{\" \"}\r\n                      {deliveryDetails.transferenciaBanco || \"ÔÇö\"}\r\n                    </div>\r\n                    <div>\r\n                      <strong>N├║mero:</strong>{\" \"}\r\n                      {deliveryDetails.transferenciaNumero || \"ÔÇö\"}\r\n                    </div>\r\n                  </div>\r\n                </div>\r\n              )}\r\n            </div>\r\n\r\n            <div className=\"flex gap-2 pt-4\">\r\n              <Button\r\n                variant=\"outline\"\r\n                onClick={() => setStep(\"details\")}\r\n                disabled={isProcessing}\r\n                className=\"flex-1\"\r\n              >\r\n                Volver\r\n              </Button>\r\n              <Button\r\n                onClick={handleCompletePayment}\r\n                disabled={isProcessing}\r\n                className=\"flex-1\"\r\n              >\r\n                {isProcessing ? \"Procesando...\" : \"Completar Cambio\"}\r\n              </Button>\r\n            </div>\r\n          </div>\r\n        </CardContent>\r\n      </Card>\r\n    </div>\r\n  );\r\n};\r\n\r\nexport default CompletePaymentForm;\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\oswal\\OneDrive\\Documentos\\Punto Cambio\\punto_cambio_new\\src\\components\\exchange\\CurrencyBehaviorInfo.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\oswal\\OneDrive\\Documentos\\Punto Cambio\\punto_cambio_new\\src\\components\\exchange\\CurrencyDetailForm.tsx","messages":[],"suppressedMessages":[{"ruleId":"react-hooks/exhaustive-deps","severity":1,"message":"React Hook useEffect has missing dependencies: 'initialData' and 'onDetailData'. Either include them or remove the dependency array. If 'onDetailData' changes too often, find the parent component that defines it and wrap that definition in useCallback.","line":64,"column":6,"nodeType":"ArrayExpression","endLine":64,"endColumn":51,"suggestions":[{"desc":"Update the dependencies array to be: [initialData, initialData.billetes, initialData.monedas, onDetailData]","fix":{"range":[1964,2009],"text":"[initialData, initialData.billetes, initialData.monedas, onDetailData]"}}],"suppressions":[{"kind":"directive","justification":""}]},{"ruleId":"react-hooks/exhaustive-deps","severity":1,"message":"React Hook useEffect has missing dependencies: 'initialData' and 'onDetailData'. Either include them or remove the dependency array. If 'onDetailData' changes too often, find the parent component that defines it and wrap that definition in useCallback.","line":73,"column":6,"nodeType":"ArrayExpression","endLine":73,"endColumn":20,"suggestions":[{"desc":"Update the dependencies array to be: [currency.id, initialData, onDetailData]","fix":{"range":[2274,2288],"text":"[currency.id, initialData, onDetailData]"}}],"suppressions":[{"kind":"directive","justification":""}]}],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\oswal\\OneDrive\\Documentos\\Punto Cambio\\punto_cambio_new\\src\\components\\exchange\\CustomerDataForm.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\oswal\\OneDrive\\Documentos\\Punto Cambio\\punto_cambio_new\\src\\components\\exchange\\DeliveryDetailsForm.tsx","messages":[],"suppressedMessages":[{"ruleId":"react-hooks/exhaustive-deps","severity":1,"message":"React Hook useEffect has a missing dependency: 'montoAEntregar'. Either include it or remove the dependency array.","line":81,"column":6,"nodeType":"ArrayExpression","endLine":81,"endColumn":21,"suggestions":[{"desc":"Update the dependencies array to be: [metodoEntrega, montoAEntregar]","fix":{"range":[2957,2972],"text":"[metodoEntrega, montoAEntregar]"}}],"suppressions":[{"kind":"directive","justification":""}]},{"ruleId":"react-hooks/exhaustive-deps","severity":1,"message":"React Hook useEffect has a missing dependency: 'metodoEntrega'. Either include it or remove the dependency array. You can also replace multiple useState variables with useReducer if 'setDivisasRecibidas' needs the current value of 'metodoEntrega'.","line":91,"column":6,"nodeType":"ArrayExpression","endLine":91,"endColumn":22,"suggestions":[{"desc":"Update the dependencies array to be: [metodoEntrega, montoAEntregar]","fix":{"range":[3355,3371],"text":"[metodoEntrega, montoAEntregar]"}}],"suppressions":[{"kind":"directive","justification":""}]}],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\oswal\\OneDrive\\Documentos\\Punto Cambio\\punto_cambio_new\\src\\components\\exchange\\ExchangeDetailsForm.tsx","messages":[],"suppressedMessages":[{"ruleId":"react-hooks/exhaustive-deps","severity":1,"message":"React Hook useEffect has missing dependencies: 'onTransferenciaBancoChange', 'onTransferenciaImagenChange', and 'onTransferenciaNumeroChange'. Either include them or remove the dependency array. If 'onTransferenciaNumeroChange' changes too often, find the parent component that defines it and wrap that definition in useCallback.","line":124,"column":6,"nodeType":"ArrayExpression","endLine":124,"endColumn":21,"suggestions":[{"desc":"Update the dependencies array to be: [metodoEntrega, onTransferenciaBancoChange, onTransferenciaImagenChange, onTransferenciaNumeroChange]","fix":{"range":[4610,4625],"text":"[metodoEntrega, onTransferenciaBancoChange, onTransferenciaImagenChange, onTransferenciaNumeroChange]"}}],"suppressions":[{"kind":"directive","justification":""}]}],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\oswal\\OneDrive\\Documentos\\Punto Cambio\\punto_cambio_new\\src\\components\\exchange\\ExchangeForm.tsx","messages":[],"suppressedMessages":[{"ruleId":"react-hooks/exhaustive-deps","severity":1,"message":"React Hook useEffect has missing dependencies: 'rateBilletes' and 'rateMonedas'. Either include them or remove the dependency array.","line":176,"column":6,"nodeType":"ArrayExpression","endLine":176,"endColumn":43,"suggestions":[{"desc":"Update the dependencies array to be: [amountBilletesNum, amountMonedasNum, rateBilletes, rateMonedas]","fix":{"range":[5289,5326],"text":"[amountBilletesNum, amountMonedasNum, rateBilletes, rateMonedas]"}}],"suppressions":[{"kind":"directive","justification":""}]}],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\oswal\\OneDrive\\Documentos\\Punto Cambio\\punto_cambio_new\\src\\components\\exchange\\ExchangeFormFields.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\oswal\\OneDrive\\Documentos\\Punto Cambio\\punto_cambio_new\\src\\components\\exchange\\ExchangeList.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\oswal\\OneDrive\\Documentos\\Punto Cambio\\punto_cambio_new\\src\\components\\exchange\\ExchangeManagement.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\oswal\\OneDrive\\Documentos\\Punto Cambio\\punto_cambio_new\\src\\components\\exchange\\ExchangeSteps.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\oswal\\OneDrive\\Documentos\\Punto Cambio\\punto_cambio_new\\src\\components\\exchange\\PartialExchangeForm.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\oswal\\OneDrive\\Documentos\\Punto Cambio\\punto_cambio_new\\src\\components\\exchange\\PartialExchangesList.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\oswal\\OneDrive\\Documentos\\Punto Cambio\\punto_cambio_new\\src\\components\\exchange\\PartialPaymentForm.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\oswal\\OneDrive\\Documentos\\Punto Cambio\\punto_cambio_new\\src\\components\\exchange\\PendingExchangesList.tsx","messages":[],"suppressedMessages":[{"ruleId":"react-hooks/exhaustive-deps","severity":1,"message":"React Hook useEffect has a missing dependency: 'loadPendingExchanges'. Either include it or remove the dependency array.","line":73,"column":6,"nodeType":"ArrayExpression","endLine":73,"endColumn":25,"suggestions":[{"desc":"Update the dependencies array to be: [loadPendingExchanges, selectedPoint?.id]","fix":{"range":[2501,2520],"text":"[loadPendingExchanges, selectedPoint?.id]"}}],"suppressions":[{"kind":"directive","justification":""}]}],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\oswal\\OneDrive\\Documentos\\Punto Cambio\\punto_cambio_new\\src\\components\\layout\\PointSelector.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\oswal\\OneDrive\\Documentos\\Punto Cambio\\punto_cambio_new\\src\\components\\management\\CurrencyManagement.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\oswal\\OneDrive\\Documentos\\Punto Cambio\\punto_cambio_new\\src\\components\\management\\PointManagement.tsx","messages":[{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'Agencia' is defined but never used. Allowed unused vars must match /^_/u.","line":21,"column":25,"nodeType":null,"messageId":"unusedVar","endLine":21,"endColumn":32}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":1,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import { useState, useEffect } from \"react\";\r\nimport { Button } from \"@/components/ui/button\";\r\nimport { Input } from \"@/components/ui/input\";\r\nimport { Label } from \"@/components/ui/label\";\r\nimport {\r\n  Card,\r\n  CardContent,\r\n  CardDescription,\r\n  CardHeader,\r\n  CardTitle,\r\n} from \"@/components/ui/card\";\r\nimport {\r\n  Table,\r\n  TableBody,\r\n  TableCell,\r\n  TableHead,\r\n  TableHeader,\r\n  TableRow,\r\n} from \"@/components/ui/table\";\r\nimport { toast } from \"@/hooks/use-toast\";\r\nimport { PuntoAtencion, Agencia } from \"../../types\";\r\nimport { pointService } from \"../../services/pointService\";\r\nimport EditPointDialog from \"@/components/admin/EditPointDialog\";\r\nimport { AgenciaSelector } from \"@/components/ui/AgenciaSelector\";\r\nimport { Edit } from \"lucide-react\";\r\n\r\nexport const PointManagement = () => {\r\n  const [points, setPoints] = useState<PuntoAtencion[]>([]);\r\n  const [showForm, setShowForm] = useState(false);\r\n  const [isLoading, setIsLoading] = useState(true);\r\n  const [error, setError] = useState<string | null>(null);\r\n  const [formData, setFormData] = useState({\r\n    nombre: \"\",\r\n    direccion: \"\",\r\n    ciudad: \"\",\r\n    provincia: \"\",\r\n    codigo_postal: \"\",\r\n    telefono: \"\",\r\n    servientrega_agencia_codigo: \"\",\r\n    servientrega_agencia_nombre: \"\",\r\n    servientrega_alianza: \"\",\r\n    servientrega_oficina_alianza: \"\",\r\n  });\r\n  const [editingPoint, setEditingPoint] = useState<PuntoAtencion | null>(null);\r\n\r\n  const loadPoints = async () => {\r\n    setIsLoading(true);\r\n    setError(null);\r\n    try {\r\n      const { points: fetchedPoints } =\r\n        await pointService.getAllPointsForAdmin();\r\n      setPoints(fetchedPoints);\r\n    } catch {\r\n      const errorMessage = \"Error al cargar puntos de atenci├│n\";\r\n      setError(errorMessage);\r\n      toast({\r\n        title: \"Error\",\r\n        description: errorMessage,\r\n        variant: \"destructive\",\r\n      });\r\n    } finally {\r\n      setIsLoading(false);\r\n    }\r\n  };\r\n\r\n  useEffect(() => {\r\n    loadPoints();\r\n  }, []);\r\n\r\n  const handleSubmit = async (e: React.FormEvent) => {\r\n    e.preventDefault();\r\n\r\n    if (\r\n      !formData.nombre ||\r\n      !formData.direccion ||\r\n      !formData.ciudad ||\r\n      !formData.provincia\r\n    ) {\r\n      toast({\r\n        title: \"Error\",\r\n        description:\r\n          \"Los campos nombre, direcci├│n, ciudad y provincia son obligatorios\",\r\n        variant: \"destructive\",\r\n      });\r\n      return;\r\n    }\r\n\r\n    try {\r\n      const { point: newPoint } = await pointService.createPoint(formData);\r\n\r\n      if (!newPoint) {\r\n        toast({\r\n          title: \"Error\",\r\n          description: \"Error al crear punto de atenci├│n\",\r\n          variant: \"destructive\",\r\n        });\r\n        return;\r\n      }\r\n\r\n      await loadPoints();\r\n      setFormData({\r\n        nombre: \"\",\r\n        direccion: \"\",\r\n        ciudad: \"\",\r\n        provincia: \"\",\r\n        codigo_postal: \"\",\r\n        telefono: \"\",\r\n        servientrega_agencia_codigo: \"\",\r\n        servientrega_agencia_nombre: \"\",\r\n        servientrega_alianza: \"\",\r\n        servientrega_oficina_alianza: \"\",\r\n      });\r\n      setShowForm(false);\r\n\r\n      toast({\r\n        title: \"Punto creado\",\r\n        description: `Punto de atenci├│n ${newPoint.nombre} creado exitosamente`,\r\n      });\r\n    } catch {\r\n      toast({\r\n        title: \"Error\",\r\n        description: \"Error interno del servidor\",\r\n        variant: \"destructive\",\r\n      });\r\n    }\r\n  };\r\n\r\n  // --- ACTIVAR/DESACTIVAR ---\r\n  const togglePointStatus = async (pointId: string) => {\r\n    try {\r\n      await pointService.togglePointStatus(pointId);\r\n      await loadPoints();\r\n      const targetPoint = points.find((p) => p.id === pointId);\r\n      toast({\r\n        title: \"Estado actualizado\",\r\n        description: `Punto ${targetPoint?.nombre} ${\r\n          targetPoint?.activo ? \"desactivado\" : \"activado\"\r\n        }`,\r\n      });\r\n    } catch {\r\n      toast({\r\n        title: \"Error\",\r\n        description: \"No se pudo cambiar el estado del punto\",\r\n        variant: \"destructive\",\r\n      });\r\n    }\r\n  };\r\n\r\n  // --- UI ---\r\n  if (isLoading) {\r\n    return (\r\n      <div className=\"p-6 text-center py-12\">\r\n        <div className=\"animate-spin rounded-full h-32 w-32 border-b-2 border-blue-600 mx-auto\"></div>\r\n        <p className=\"mt-4 text-gray-600\">Cargando puntos de atenci├│n...</p>\r\n      </div>\r\n    );\r\n  }\r\n\r\n  if (error) {\r\n    return (\r\n      <div className=\"p-6 text-center py-12\">\r\n        <p className=\"text-red-500 text-lg\">\r\n          Error al cargar puntos de atenci├│n\r\n        </p>\r\n        <p className=\"text-gray-500 mt-2\">{error}</p>\r\n        <Button onClick={loadPoints} className=\"mt-4\" variant=\"outline\">\r\n          Reintentar\r\n        </Button>\r\n      </div>\r\n    );\r\n  }\r\n\r\n  return (\r\n    <div className=\"h-full flex flex-col gap-4\">\r\n      {/* Header - Siempre visible */}\r\n      <div className=\"flex-shrink-0 flex items-center justify-between\">\r\n        <h1 className=\"text-lg font-bold text-gray-800\">\r\n          Gesti├│n de Puntos de Atenci├│n\r\n        </h1>\r\n        <Button\r\n          onClick={() => setShowForm(!showForm)}\r\n          className=\"bg-blue-600 hover:bg-blue-700\"\r\n        >\r\n          {showForm ? \"Cancelar\" : \"Nuevo Punto\"}\r\n        </Button>\r\n      </div>\r\n\r\n      {/* Contenido scrolleable */}\r\n      <div className=\"flex-1 min-h-0 overflow-y-auto space-y-4\">\r\n        {showForm && (\r\n          <Card>\r\n            <CardHeader>\r\n              <CardTitle>Crear Nuevo Punto de Atenci├│n</CardTitle>\r\n              <CardDescription>\r\n                Complete la informaci├│n del nuevo punto de atenci├│n\r\n              </CardDescription>\r\n            </CardHeader>\r\n            <CardContent className=\"max-h-[70vh] overflow-y-auto\">\r\n              <form onSubmit={handleSubmit} className=\"space-y-6\">\r\n                {/* Informaci├│n b├ísica */}\r\n                <div className=\"grid grid-cols-1 md:grid-cols-2 gap-4\">\r\n                  <div className=\"space-y-2\">\r\n                    <Label>Nombre *</Label>\r\n                    <Input\r\n                      value={formData.nombre}\r\n                      onChange={(e) =>\r\n                        setFormData({ ...formData, nombre: e.target.value })\r\n                      }\r\n                      placeholder=\"Nombre del punto de atenci├│n\"\r\n                    />\r\n                  </div>\r\n                  <div className=\"space-y-2\">\r\n                    <Label>Ciudad *</Label>\r\n                    <Input\r\n                      value={formData.ciudad}\r\n                      onChange={(e) =>\r\n                        setFormData({ ...formData, ciudad: e.target.value })\r\n                      }\r\n                      placeholder=\"Ciudad\"\r\n                    />\r\n                  </div>\r\n                </div>\r\n\r\n                {/* Direcci├│n completa */}\r\n                <div className=\"space-y-2\">\r\n                  <Label>Direcci├│n *</Label>\r\n                  <Input\r\n                    value={formData.direccion}\r\n                    onChange={(e) =>\r\n                      setFormData({ ...formData, direccion: e.target.value })\r\n                    }\r\n                    placeholder=\"Direcci├│n completa\"\r\n                  />\r\n                </div>\r\n\r\n                {/* Informaci├│n adicional */}\r\n                <div className=\"grid grid-cols-1 md:grid-cols-3 gap-4\">\r\n                  <div className=\"space-y-2\">\r\n                    <Label>Provincia *</Label>\r\n                    <Input\r\n                      value={formData.provincia}\r\n                      onChange={(e) =>\r\n                        setFormData({ ...formData, provincia: e.target.value })\r\n                      }\r\n                      placeholder=\"Provincia\"\r\n                    />\r\n                  </div>\r\n                  <div className=\"space-y-2\">\r\n                    <Label>C├│digo Postal</Label>\r\n                    <Input\r\n                      value={formData.codigo_postal}\r\n                      onChange={(e) =>\r\n                        setFormData({\r\n                          ...formData,\r\n                          codigo_postal: e.target.value,\r\n                        })\r\n                      }\r\n                      placeholder=\"C├│digo postal\"\r\n                    />\r\n                  </div>\r\n                  <div className=\"space-y-2\">\r\n                    <Label>Tel├®fono</Label>\r\n                    <Input\r\n                      value={formData.telefono}\r\n                      onChange={(e) =>\r\n                        setFormData({ ...formData, telefono: e.target.value })\r\n                      }\r\n                      placeholder=\"N├║mero de tel├®fono\"\r\n                    />\r\n                  </div>\r\n                </div>\r\n\r\n                {/* Selector de agencia */}\r\n                <div className=\"border-t pt-4\">\r\n                  <AgenciaSelector\r\n                    value={formData.servientrega_agencia_nombre}\r\n                    onAgenciaSelect={(agencia) => {\r\n                      setFormData({\r\n                        ...formData,\r\n                        servientrega_agencia_codigo: agencia?.tipo_cs || \"\",\r\n                        servientrega_agencia_nombre: agencia?.nombre || \"\",\r\n                        servientrega_alianza: agencia?.agencia || \"\",\r\n                        servientrega_oficina_alianza:\r\n                          agencia?.codigo_establecimiento || \"\",\r\n                      });\r\n                    }}\r\n                    placeholder=\"Seleccionar agencia de Servientrega...\"\r\n                  />\r\n                </div>\r\n\r\n                {/* Botones de acci├│n */}\r\n                <div className=\"flex gap-3 pt-4 border-t bg-gray-50 -mx-6 px-6 py-4 mt-6\">\r\n                  <Button\r\n                    type=\"submit\"\r\n                    className=\"bg-blue-600 hover:bg-blue-700\"\r\n                  >\r\n                    Crear Punto\r\n                  </Button>\r\n                  <Button\r\n                    type=\"button\"\r\n                    variant=\"outline\"\r\n                    onClick={() => setShowForm(false)}\r\n                  >\r\n                    Cancelar\r\n                  </Button>\r\n                </div>\r\n              </form>\r\n            </CardContent>\r\n          </Card>\r\n        )}\r\n\r\n        <Card>\r\n          <CardHeader>\r\n            <CardTitle>Puntos de Atenci├│n del Sistema</CardTitle>\r\n            <CardDescription>\r\n              Lista de todos los puntos de atenci├│n registrados\r\n            </CardDescription>\r\n          </CardHeader>\r\n          <CardContent>\r\n            {points.length === 0 ? (\r\n              <div className=\"text-center py-12\">\r\n                <p className=\"text-gray-500 text-lg\">\r\n                  No hay puntos registrados\r\n                </p>\r\n                <p className=\"text-gray-400 mt-2\">\r\n                  Cree uno haciendo clic en \"Nuevo Punto\"\r\n                </p>\r\n              </div>\r\n            ) : (\r\n              <Table>\r\n                <TableHeader>\r\n                  <TableRow>\r\n                    <TableHead>Nombre</TableHead>\r\n                    <TableHead>Direcci├│n</TableHead>\r\n                    <TableHead>Ciudad</TableHead>\r\n                    <TableHead>Provincia</TableHead>\r\n                    <TableHead>Tel├®fono</TableHead>\r\n                    <TableHead>Agencia Servientrega</TableHead>\r\n                    <TableHead>Estado</TableHead>\r\n                    <TableHead>Fecha Creaci├│n</TableHead>\r\n                    <TableHead>Acciones</TableHead>\r\n                  </TableRow>\r\n                </TableHeader>\r\n                <TableBody>\r\n                  {points.map((point) => (\r\n                    <TableRow key={point.id}>\r\n                      <TableCell className=\"font-medium\">\r\n                        {point.nombre}\r\n                      </TableCell>\r\n                      <TableCell>{point.direccion}</TableCell>\r\n                      <TableCell>{point.ciudad}</TableCell>\r\n                      <TableCell>{point.provincia}</TableCell>\r\n                      <TableCell>{point.telefono || \"N/A\"}</TableCell>\r\n                      <TableCell>\r\n                        {point.servientrega_agencia_nombre || \"No asignada\"}\r\n                      </TableCell>\r\n                      <TableCell>\r\n                        <span\r\n                          className={`px-2 py-1 rounded text-xs font-medium ${\r\n                            point.activo\r\n                              ? \"bg-green-100 text-green-800\"\r\n                              : \"bg-red-100 text-red-800\"\r\n                          }`}\r\n                        >\r\n                          {point.activo ? \"Activo\" : \"Inactivo\"}\r\n                        </span>\r\n                      </TableCell>\r\n                      <TableCell>\r\n                        {new Date(point.created_at).toLocaleDateString()}\r\n                      </TableCell>\r\n                      <TableCell>\r\n                        <div className=\"flex gap-2\">\r\n                          <Button\r\n                            size=\"sm\"\r\n                            variant=\"outline\"\r\n                            onClick={() => setEditingPoint(point)}\r\n                            title=\"Editar punto\"\r\n                          >\r\n                            <Edit className=\"h-4 w-4\" />\r\n                          </Button>\r\n                          <Button\r\n                            size=\"sm\"\r\n                            variant={point.activo ? \"destructive\" : \"default\"}\r\n                            onClick={() => togglePointStatus(point.id)}\r\n                          >\r\n                            {point.activo ? \"Desactivar\" : \"Activar\"}\r\n                          </Button>\r\n                        </div>\r\n                      </TableCell>\r\n                    </TableRow>\r\n                  ))}\r\n                </TableBody>\r\n              </Table>\r\n            )}\r\n          </CardContent>\r\n        </Card>\r\n\r\n        {/* MODAL de edici├│n */}\r\n        {editingPoint && (\r\n          <EditPointDialog\r\n            point={editingPoint}\r\n            isOpen={!!editingPoint}\r\n            onClose={() => setEditingPoint(null)}\r\n            onPointUpdated={loadPoints}\r\n          />\r\n        )}\r\n      </div>\r\n    </div>\r\n  );\r\n};\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\oswal\\OneDrive\\Documentos\\Punto Cambio\\punto_cambio_new\\src\\components\\management\\PointSelectModal.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\oswal\\OneDrive\\Documentos\\Punto Cambio\\punto_cambio_new\\src\\components\\management\\UserManagement.tsx","messages":[{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'UserPlus' is defined but never used. Allowed unused vars must match /^_/u.","line":34,"column":21,"nodeType":null,"messageId":"unusedVar","endLine":34,"endColumn":29},{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'points' is assigned a value but never used. Allowed unused vars must match /^_/u.","line":43,"column":10,"nodeType":null,"messageId":"unusedVar","endLine":43,"endColumn":16},{"ruleId":"react-hooks/exhaustive-deps","severity":1,"message":"React Hook useEffect has a missing dependency: 'loadData'. Either include it or remove the dependency array.","line":111,"column":6,"nodeType":"ArrayExpression","endLine":111,"endColumn":8,"suggestions":[{"desc":"Update the dependencies array to be: [loadData]","fix":{"range":[3681,3683],"text":"[loadData]"}}]}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":3,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import { useState, useEffect, useRef } from \"react\";\r\nimport { Button } from \"@/components/ui/button\";\r\nimport { Input } from \"@/components/ui/input\";\r\nimport { Label } from \"@/components/ui/label\";\r\nimport {\r\n  Select,\r\n  SelectContent,\r\n  SelectItem,\r\n  SelectTrigger,\r\n  SelectValue,\r\n} from \"@/components/ui/select\";\r\nimport {\r\n  Card,\r\n  CardContent,\r\n  CardDescription,\r\n  CardHeader,\r\n  CardTitle,\r\n} from \"@/components/ui/card\";\r\nimport {\r\n  Table,\r\n  TableBody,\r\n  TableCell,\r\n  TableHead,\r\n  TableHeader,\r\n  TableRow,\r\n} from \"@/components/ui/table\";\r\nimport { toast } from \"sonner\";\r\nimport { Usuario, PuntoAtencion } from \"../../types\";\r\nimport { PointSelectModal } from \"./PointSelectModal\";\r\nimport { userService } from \"../../services/userService\";\r\nimport { pointService } from \"../../services/pointService\";\r\nimport EditUserDialog from \"../../components/admin/EditUserDialog\";\r\nimport ResetPasswordDialog from \"../../components/admin/ResetPasswordDialog\";\r\nimport { Edit, Key, UserPlus, UserX, UserCheck } from \"lucide-react\";\r\nimport { useAuth } from \"../../hooks/useAuth\";\r\nimport { useConfirmationDialog } from \"@/components/ui/confirmation-dialog\";\r\n\r\nexport const UserManagement = () => {\r\n  const { user: currentUser } = useAuth();\r\n  const { showConfirmation, ConfirmationDialog } = useConfirmationDialog();\r\n\r\n  const [users, setUsers] = useState<Usuario[]>([]);\r\n  const [points, setPoints] = useState<PuntoAtencion[]>([]);\r\n  const [showForm, setShowForm] = useState(false);\r\n  const [isLoading, setIsLoading] = useState(true);\r\n  const [error, setError] = useState<string | null>(null);\r\n  const [editingUser, setEditingUser] = useState<Usuario | null>(null);\r\n  const [resetPasswordUser, setResetPasswordUser] = useState<Usuario | null>(\r\n    null\r\n  );\r\n  const [formData, setFormData] = useState({\r\n    username: \"\",\r\n    correo: \"\",\r\n    nombre: \"\",\r\n    rol: \"OPERADOR\" as Usuario[\"rol\"],\r\n    password: \"\",\r\n    punto_atencion_id: \"\",\r\n  });\r\n\r\n  // Caches para evitar llamar de nuevo si ya se carg├│ en esta sesi├│n\r\n  const usersCacheRef = useRef<Usuario[] | null>(null);\r\n  const pointsCacheRef = useRef<PuntoAtencion[] | null>(null);\r\n  const mountedRef = useRef<boolean>(false);\r\n\r\n  const sleep = (ms: number) => new Promise((r) => setTimeout(r, ms));\r\n\r\n  const loadData = async () => {\r\n    if (!mountedRef.current) return;\r\n    setIsLoading(true);\r\n    setError(null);\r\n\r\n    try {\r\n      // 1) Users (usar cache si existe)\r\n      let loadedUsers: Usuario[] | null = usersCacheRef.current;\r\n      if (!loadedUsers) {\r\n        const usersResult = await userService.getAllUsers();\r\n        loadedUsers = usersResult.users;\r\n        usersCacheRef.current = loadedUsers;\r\n      }\r\n      if (!mountedRef.current) return;\r\n      setUsers(loadedUsers || []);\r\n\r\n      // peque├▒o respiro para no disparar al rate-limit\r\n      await sleep(300);\r\n\r\n      // 2) Points (usar cache si existe)\r\n      let loadedPoints: PuntoAtencion[] | null = pointsCacheRef.current;\r\n      if (!loadedPoints) {\r\n        const pointsResult = await pointService.getAllPoints();\r\n        loadedPoints = pointsResult.points;\r\n        pointsCacheRef.current = loadedPoints;\r\n      }\r\n      if (!mountedRef.current) return;\r\n      setPoints(loadedPoints || []);\r\n    } catch (err) {\r\n      console.error(\"Error loading data:\", err);\r\n      const errorMessage = \"Error al cargar datos\";\r\n      setError(errorMessage);\r\n      toast.error(errorMessage);\r\n    } finally {\r\n      if (mountedRef.current) setIsLoading(false);\r\n    }\r\n  };\r\n\r\n  useEffect(() => {\r\n    mountedRef.current = true;\r\n    loadData();\r\n    return () => {\r\n      mountedRef.current = false;\r\n    };\r\n  }, []);\r\n\r\n  const [showPointModal, setShowPointModal] = useState(false);\r\n\r\n  // Cuando cambia el rol a CONCESION, mostrar modal\r\n  useEffect(() => {\r\n    if (formData.rol === \"CONCESION\") {\r\n      setShowPointModal(true);\r\n    }\r\n  }, [formData.rol]);\r\n\r\n  const handlePointSelect = (point: PuntoAtencion) => {\r\n    setFormData((prev) => ({ ...prev, punto_atencion_id: point.id }));\r\n    setShowPointModal(false);\r\n  };\r\n\r\n  const handleSubmit = async (e: React.FormEvent) => {\r\n    e.preventDefault();\r\n\r\n    if (!formData.username || !formData.nombre || !formData.password) {\r\n      toast.error(\"Los campos usuario, nombre y contrase├▒a son obligatorios\");\r\n      return;\r\n    }\r\n\r\n    // Validar contrase├▒a fuerte\r\n    const passwordRegex =\r\n      /^(?=.*[a-z])(?=.*[A-Z])(?=.*\\d)(?=.*[@$!%*?&])[A-Za-z\\d@$!%*?&]/;\r\n\r\n    if (formData.password.length < 8) {\r\n      toast.error(\"La contrase├▒a debe tener al menos 8 caracteres\");\r\n      return;\r\n    }\r\n\r\n    if (!passwordRegex.test(formData.password)) {\r\n      toast.error(\r\n        \"La contrase├▒a debe contener al menos: 1 may├║scula, 1 min├║scula, 1 n├║mero y 1 s├¡mbolo (@$!%*?&)\"\r\n      );\r\n      return;\r\n    }\r\n\r\n    if (formData.rol === \"CONCESION\" && !formData.punto_atencion_id) {\r\n      toast.error(\"Debes seleccionar un punto para el usuario concesi├│n\");\r\n      setShowPointModal(true);\r\n      return;\r\n    }\r\n\r\n    try {\r\n      const { user: newUser } = await userService.createUser({\r\n        username: formData.username,\r\n        password: formData.password,\r\n        nombre: formData.nombre,\r\n        correo: formData.correo,\r\n        rol: formData.rol,\r\n        punto_atencion_id: formData.rol === \"CONCESION\" ? formData.punto_atencion_id : undefined,\r\n      });\r\n\r\n      if (!newUser) {\r\n        toast.error(\"Error al crear usuario\");\r\n        return;\r\n      }\r\n\r\n      // Invalida caches para forzar recarga fresca\r\n      usersCacheRef.current = null;\r\n      pointsCacheRef.current = null;\r\n\r\n      await loadData();\r\n      setFormData({\r\n        username: \"\",\r\n        correo: \"\",\r\n        nombre: \"\",\r\n        rol: \"OPERADOR\",\r\n        password: \"\",\r\n        punto_atencion_id: \"\",\r\n      });\r\n      setShowForm(false);\r\n\r\n      toast.success(`Ô£à Usuario ${newUser.nombre} creado exitosamente`);\r\n    } catch (err) {\r\n      console.error(\"Error creating user:\", err);\r\n      toast.error(\r\n        \"Error al crear usuario. Verifique que el nombre de usuario no est├® en uso.\"\r\n      );\r\n    }\r\n  };\r\n\r\n  const handleToggleUserStatus = (user: Usuario) => {\r\n    if (user.id === currentUser?.id) {\r\n      toast.error(\"No puedes desactivar tu propio usuario\");\r\n      return;\r\n    }\r\n\r\n    const action = user.activo ? \"desactivar\" : \"activar\";\r\n    showConfirmation(\r\n      `Confirmar ${action} usuario`,\r\n      `┬┐Est├í seguro de que desea ${action} al usuario ${user.nombre}?`,\r\n      async () => {\r\n        try {\r\n          await userService.toggleUserStatus(user.id);\r\n\r\n          // Invalida caches y recarga\r\n          usersCacheRef.current = null;\r\n          pointsCacheRef.current = null;\r\n\r\n          await loadData();\r\n          toast.success(\r\n            `Ô£à Usuario ${user.nombre} ${\r\n              user.activo ? \"desactivado\" : \"activado\"\r\n            } exitosamente`\r\n          );\r\n        } catch (err) {\r\n          console.error(\"Error toggling user status:\", err);\r\n          toast.error(\"Error al cambiar el estado del usuario\");\r\n        }\r\n      }\r\n    );\r\n  };\r\n\r\n  const getRoleLabel = (rol: string) => {\r\n    const roles: Record<string, string> = {\r\n      SUPER_USUARIO: \"Super Usuario\",\r\n      ADMIN: \"Administrador\",\r\n      OPERADOR: \"Operador\",\r\n      CONCESION: \"Concesi├│n\",\r\n      ADMINISTRATIVO: \"Administrativo\",\r\n    };\r\n    return roles[rol] || rol;\r\n  };\r\n\r\n  // Solo ADMIN o SUPER_USUARIO pueden ver el componente\r\n  if (currentUser?.rol !== \"ADMIN\" && currentUser?.rol !== \"SUPER_USUARIO\") {\r\n    return (\r\n      <div className=\"p-6\">\r\n        <div className=\"text-center py-12\">\r\n          <p className=\"text-red-500 text-lg\">\r\n            No tiene permisos para acceder a esta secci├│n\r\n          </p>\r\n        </div>\r\n      </div>\r\n    );\r\n  }\r\n\r\n  if (isLoading) {\r\n    return (\r\n      <div className=\"p-6\">\r\n        <div className=\"text-center py-12\">\r\n          <div className=\"animate-spin rounded-full h-32 w-32 border-b-2 border-blue-600 mx-auto\"></div>\r\n          <p className=\"mt-4 text-gray-600\">Cargando usuarios...</p>\r\n        </div>\r\n      </div>\r\n    );\r\n  }\r\n\r\n  if (error) {\r\n    return (\r\n      <div className=\"p-6\">\r\n        <div className=\"text-center py-12\">\r\n          <p className=\"text-red-500 text-lg\">Error al cargar usuarios</p>\r\n          <p className=\"text-gray-500 mt-2\">{error}</p>\r\n          <Button onClick={loadData} className=\"mt-4\" variant=\"outline\">\r\n            Reintentar\r\n          </Button>\r\n        </div>\r\n      </div>\r\n    );\r\n  }\r\n\r\n  return (\r\n    <>\r\n      {/* Header - Siempre visible */}\r\n      <div className=\"flex-shrink-0 flex items-center justify-between\">\r\n        <h1 className=\"text-lg font-bold text-gray-800\">Gesti├│n de Usuarios</h1>\r\n        <Button\r\n          onClick={() => setShowForm(!showForm)}\r\n          className=\"bg-blue-600 hover:bg-blue-700\"\r\n        >\r\n          {showForm ? \"Cancelar\" : \"Nuevo Usuario\"}\r\n        </Button>\r\n      </div>\r\n      {/* Contenido scrolleable */}\r\n      <div className=\"flex-1 min-h-0 overflow-y-auto space-y-4\">\r\n        {showForm && (\r\n          <>\r\n            <PointSelectModal\r\n              open={showPointModal}\r\n              onClose={() => setShowPointModal(false)}\r\n              onSelect={handlePointSelect}\r\n            />\r\n            <Card>\r\n              <CardHeader>\r\n                <CardTitle>Crear Nuevo Usuario</CardTitle>\r\n                <CardDescription>\r\n                  Complete la informaci├│n del nuevo usuario\r\n                </CardDescription>\r\n              </CardHeader>\r\n              <CardContent>\r\n                <form onSubmit={handleSubmit} className=\"space-y-4\">\r\n                  <div className=\"grid grid-cols-2 gap-4\">\r\n                    <div className=\"space-y-2\">\r\n                      <Label>Nombre Completo</Label>\r\n                      <Input\r\n                        value={formData.nombre}\r\n                        onChange={(e) =>\r\n                          setFormData((prev) => ({\r\n                            ...prev,\r\n                            nombre: e.target.value,\r\n                          }))\r\n                        }\r\n                        placeholder=\"Nombre completo\"\r\n                      />\r\n                    </div>\r\n                    <div className=\"space-y-2\">\r\n                      <Label>Rol</Label>\r\n                      <Select\r\n                        value={formData.rol}\r\n                        onValueChange={(value: Usuario[\"rol\"]) =>\r\n                          setFormData((prev) => ({ ...prev, rol: value }))\r\n                        }\r\n                      >\r\n                        <SelectTrigger>\r\n                          <SelectValue />\r\n                        </SelectTrigger>\r\n                        <SelectContent>\r\n                          <SelectItem value=\"OPERADOR\">Operador</SelectItem>\r\n                          <SelectItem value=\"ADMINISTRATIVO\">\r\n                            Administrativo\r\n                          </SelectItem>\r\n                          <SelectItem value=\"CONCESION\">Concesi├│n</SelectItem>\r\n                          <SelectItem value=\"ADMIN\">Administrador</SelectItem>\r\n                          <SelectItem value=\"SUPER_USUARIO\">\r\n                            Super Usuario\r\n                          </SelectItem>\r\n                        </SelectContent>\r\n                      </Select>\r\n                    </div>\r\n                  </div>\r\n                  <div className=\"grid grid-cols-2 gap-4\">\r\n                    <div className=\"space-y-2\">\r\n                      <Label>Usuario</Label>\r\n                      <Input\r\n                        value={formData.username}\r\n                        onChange={(e) =>\r\n                          setFormData((prev) => ({\r\n                            ...prev,\r\n                            username: e.target.value,\r\n                          }))\r\n                        }\r\n                        placeholder=\"Nombre de usuario\"\r\n                      />\r\n                    </div>\r\n                    <div className=\"space-y-2\">\r\n                      <Label>Email</Label>\r\n                      <Input\r\n                        type=\"email\"\r\n                        value={formData.correo}\r\n                        onChange={(e) =>\r\n                          setFormData((prev) => ({\r\n                            ...prev,\r\n                            correo: e.target.value,\r\n                          }))\r\n                        }\r\n                        placeholder=\"email@ejemplo.com\"\r\n                      />\r\n                    </div>\r\n                  </div>\r\n                  <div className=\"space-y-2\">\r\n                    <Label>Contrase├▒a Temporal</Label>\r\n                    <Input\r\n                      type=\"password\"\r\n                      value={formData.password}\r\n                      onChange={(e) =>\r\n                        setFormData((prev) => ({\r\n                          ...prev,\r\n                          password: e.target.value,\r\n                        }))\r\n                      }\r\n                      placeholder=\"M├¡n. 8 caracteres: A-z, 0-9, @$!%*?&\"\r\n                    />\r\n                    <div className=\"text-xs text-gray-600 bg-yellow-50 p-2 rounded\">\r\n                      <p>\r\n                        <strong>Requisitos de contrase├▒a:</strong>\r\n                      </p>\r\n                      <ul className=\"list-disc list-inside mt-1\">\r\n                        <li>M├¡nimo 8 caracteres</li>\r\n                        <li>Al menos 1 may├║scula (A-Z)</li>\r\n                        <li>Al menos 1 min├║scula (a-z)</li>\r\n                        <li>Al menos 1 n├║mero (0-9)</li>\r\n                        <li>Al menos 1 s├¡mbolo (@$!%*?&)</li>\r\n                      </ul>\r\n                    </div>\r\n                  </div>\r\n                  <div className=\"flex gap-2\">\r\n                    <Button\r\n                      type=\"submit\"\r\n                      className=\"bg-blue-600 hover:bg-blue-700\"\r\n                    >\r\n                      Crear Usuario\r\n                    </Button>\r\n                    <Button\r\n                      type=\"button\"\r\n                      variant=\"outline\"\r\n                      onClick={() => setShowForm(false)}\r\n                    >\r\n                      Cancelar\r\n                    </Button>\r\n                  </div>\r\n                </form>\r\n              </CardContent>\r\n            </Card>\r\n          </>\r\n        )}\r\n        <Card>\r\n          <CardHeader>\r\n            <CardTitle>Usuarios del Sistema</CardTitle>\r\n            <CardDescription>\r\n              Lista de todos los usuarios registrados\r\n            </CardDescription>\r\n          </CardHeader>\r\n          <CardContent>\r\n            {users.length === 0 ? (\r\n              <div className=\"text-center py-12\">\r\n                <p className=\"text-gray-500 text-lg\">\r\n                  No hay usuarios registrados\r\n                </p>\r\n                <p className=\"text-gray-400 mt-2\">\r\n                  Cree el primer usuario haciendo clic en \"Nuevo Usuario\"\r\n                </p>\r\n              </div>\r\n            ) : (\r\n              <Table>\r\n                <TableHeader>\r\n                  <TableRow>\r\n                    <TableHead>Nombre</TableHead>\r\n                    <TableHead>Usuario</TableHead>\r\n                    <TableHead>Email</TableHead>\r\n                    <TableHead>Rol</TableHead>\r\n                    <TableHead>Estado</TableHead>\r\n                    <TableHead>Fecha Creaci├│n</TableHead>\r\n                    <TableHead>Acciones</TableHead>\r\n                  </TableRow>\r\n                </TableHeader>\r\n                <TableBody>\r\n                  {users.map((userItem) => (\r\n                    <TableRow key={userItem.id}>\r\n                      <TableCell className=\"font-medium\">\r\n                        {userItem.nombre}\r\n                      </TableCell>\r\n                      <TableCell>{userItem.username}</TableCell>\r\n                      <TableCell>{userItem.correo}</TableCell>\r\n                      <TableCell>{getRoleLabel(userItem.rol)}</TableCell>\r\n                      <TableCell>\r\n                        <span\r\n                          className={`px-2 py-1 rounded text-xs font-medium ${\r\n                            userItem.activo\r\n                              ? \"bg-green-100 text-green-800\"\r\n                              : \"bg-red-100 text-red-800\"\r\n                          }`}\r\n                        >\r\n                          {userItem.activo ? \"Activo\" : \"Inactivo\"}\r\n                        </span>\r\n                      </TableCell>\r\n                      <TableCell>\r\n                        {new Date(userItem.created_at).toLocaleDateString()}\r\n                      </TableCell>\r\n                      <TableCell>\r\n                        <div className=\"flex gap-2\">\r\n                          <Button\r\n                            size=\"sm\"\r\n                            variant=\"outline\"\r\n                            onClick={() => setEditingUser(userItem)}\r\n                          >\r\n                            <Edit className=\"h-4 w-4\" />\r\n                          </Button>\r\n                          <Button\r\n                            size=\"sm\"\r\n                            variant=\"outline\"\r\n                            onClick={() => setResetPasswordUser(userItem)}\r\n                          >\r\n                            <Key className=\"h-4 w-4\" />\r\n                          </Button>\r\n                          <Button\r\n                            size=\"sm\"\r\n                            variant={\r\n                              userItem.activo ? \"destructive\" : \"default\"\r\n                            }\r\n                            onClick={() => handleToggleUserStatus(userItem)}\r\n                            disabled={userItem.id === currentUser?.id}\r\n                          >\r\n                            {userItem.activo ? (\r\n                              <>\r\n                                <UserX className=\"h-4 w-4 mr-1\" />\r\n                                Desactivar\r\n                              </>\r\n                            ) : (\r\n                              <>\r\n                                <UserCheck className=\"h-4 w-4 mr-1\" />\r\n                                Activar\r\n                              </>\r\n                            )}\r\n                          </Button>\r\n                        </div>\r\n                      </TableCell>\r\n                    </TableRow>\r\n                  ))}\r\n                </TableBody>\r\n              </Table>\r\n            )}\r\n          </CardContent>\r\n        </Card>\r\n        {/* Di├ílogos */}\r\n        {editingUser && currentUser && (\r\n          <EditUserDialog\r\n            user={editingUser}\r\n            isOpen={true}\r\n            onClose={() => setEditingUser(null)}\r\n            onUserUpdated={() => {\r\n              usersCacheRef.current = null;\r\n              pointsCacheRef.current = null;\r\n              loadData();\r\n            }}\r\n            currentUser={currentUser}\r\n          />\r\n        )}\r\n        {resetPasswordUser && (\r\n          <ResetPasswordDialog\r\n            user={resetPasswordUser}\r\n            isOpen={true}\r\n            onClose={() => setResetPasswordUser(null)}\r\n          />\r\n        )}\r\n        <ConfirmationDialog />\r\n      </div>\r\n    </>\r\n  );\r\n}\r\n\r\nexport default UserManagement;\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\oswal\\OneDrive\\Documentos\\Punto Cambio\\punto_cambio_new\\src\\components\\maps\\SimpleMap.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\oswal\\OneDrive\\Documentos\\Punto Cambio\\punto_cambio_new\\src\\components\\notifications\\TransferNotifications.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\oswal\\OneDrive\\Documentos\\Punto Cambio\\punto_cambio_new\\src\\components\\reports\\ReportChart.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\oswal\\OneDrive\\Documentos\\Punto Cambio\\punto_cambio_new\\src\\components\\reports\\ReportFilters.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\oswal\\OneDrive\\Documentos\\Punto Cambio\\punto_cambio_new\\src\\components\\reports\\ReportTable.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\oswal\\OneDrive\\Documentos\\Punto Cambio\\punto_cambio_new\\src\\components\\reports\\Reports.tsx","messages":[{"ruleId":"no-console","severity":1,"message":"Unexpected console statement. Only these console methods are allowed: warn, error.","line":146,"column":9,"nodeType":"MemberExpression","messageId":"limited","endLine":146,"endColumn":20,"suggestions":[{"fix":{"range":[4371,4641],"text":""},"messageId":"removeConsole","data":{"propertyName":"log"},"desc":"Remove the console.log()."}]},{"ruleId":"no-console","severity":1,"message":"Unexpected console statement. Only these console methods are allowed: warn, error.","line":158,"column":13,"nodeType":"MemberExpression","messageId":"limited","endLine":158,"endColumn":24,"suggestions":[{"fix":{"range":[4726,4765],"text":""},"messageId":"removeConsole","data":{"propertyName":"log"},"desc":"Remove the console.log()."}]},{"ruleId":"no-console","severity":1,"message":"Unexpected console statement. Only these console methods are allowed: warn, error.","line":160,"column":13,"nodeType":"MemberExpression","messageId":"limited","endLine":160,"endColumn":24,"suggestions":[{"fix":{"range":[4842,5004],"text":""},"messageId":"removeConsole","data":{"propertyName":"log"},"desc":"Remove the console.log()."}]},{"ruleId":"no-console","severity":1,"message":"Unexpected console statement. Only these console methods are allowed: warn, error.","line":166,"column":15,"nodeType":"MemberExpression","messageId":"limited","endLine":166,"endColumn":26,"suggestions":[{"fix":{"range":[5097,5156],"text":""},"messageId":"removeConsole","data":{"propertyName":"log"},"desc":"Remove the console.log()."}]},{"ruleId":"no-console","severity":1,"message":"Unexpected console statement. Only these console methods are allowed: warn, error.","line":172,"column":13,"nodeType":"MemberExpression","messageId":"limited","endLine":172,"endColumn":24,"suggestions":[{"fix":{"range":[5335,5384],"text":""},"messageId":"removeConsole","data":{"propertyName":"log"},"desc":"Remove the console.log()."}]},{"ruleId":"no-console","severity":1,"message":"Unexpected console statement. Only these console methods are allowed: warn, error.","line":174,"column":13,"nodeType":"MemberExpression","messageId":"limited","endLine":174,"endColumn":24,"suggestions":[{"fix":{"range":[5464,5628],"text":""},"messageId":"removeConsole","data":{"propertyName":"log"},"desc":"Remove the console.log()."}]},{"ruleId":"no-console","severity":1,"message":"Unexpected console statement. Only these console methods are allowed: warn, error.","line":184,"column":15,"nodeType":"MemberExpression","messageId":"limited","endLine":184,"endColumn":26,"suggestions":[{"fix":{"range":[5870,5918],"text":""},"messageId":"removeConsole","data":{"propertyName":"log"},"desc":"Remove the console.log()."}]},{"ruleId":"no-console","severity":1,"message":"Unexpected console statement. Only these console methods are allowed: warn, error.","line":370,"column":7,"nodeType":"MemberExpression","messageId":"limited","endLine":370,"endColumn":18,"suggestions":[{"fix":{"range":[11503,11577],"text":""},"messageId":"removeConsole","data":{"propertyName":"log"},"desc":"Remove the console.log()."}]},{"ruleId":"no-console","severity":1,"message":"Unexpected console statement. Only these console methods are allowed: warn, error.","line":371,"column":7,"nodeType":"MemberExpression","messageId":"limited","endLine":371,"endColumn":18,"suggestions":[{"fix":{"range":[11585,11630],"text":""},"messageId":"removeConsole","data":{"propertyName":"log"},"desc":"Remove the console.log()."}]},{"ruleId":"no-console","severity":1,"message":"Unexpected console statement. Only these console methods are allowed: warn, error.","line":372,"column":7,"nodeType":"MemberExpression","messageId":"limited","endLine":372,"endColumn":18,"suggestions":[{"fix":{"range":[11638,11743],"text":""},"messageId":"removeConsole","data":{"propertyName":"log"},"desc":"Remove the console.log()."}]},{"ruleId":"no-console","severity":1,"message":"Unexpected console statement. Only these console methods are allowed: warn, error.","line":386,"column":7,"nodeType":"MemberExpression","messageId":"limited","endLine":386,"endColumn":18,"suggestions":[{"fix":{"range":[12018,12086],"text":""},"messageId":"removeConsole","data":{"propertyName":"log"},"desc":"Remove the console.log()."}]},{"ruleId":"no-console","severity":1,"message":"Unexpected console statement. Only these console methods are allowed: warn, error.","line":387,"column":7,"nodeType":"MemberExpression","messageId":"limited","endLine":387,"endColumn":18,"suggestions":[{"fix":{"range":[12094,12197],"text":""},"messageId":"removeConsole","data":{"propertyName":"log"},"desc":"Remove the console.log()."}]},{"ruleId":"no-console","severity":1,"message":"Unexpected console statement. Only these console methods are allowed: warn, error.","line":395,"column":7,"nodeType":"MemberExpression","messageId":"limited","endLine":395,"endColumn":18,"suggestions":[{"fix":{"range":[12343,12398],"text":""},"messageId":"removeConsole","data":{"propertyName":"log"},"desc":"Remove the console.log()."}]},{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'error' is defined but never used.","line":482,"column":14,"nodeType":null,"messageId":"unusedVar","endLine":482,"endColumn":19}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":14,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import React, { useEffect, useMemo, useState } from \"react\";\r\nimport { Button } from \"@/components/ui/button\";\r\nimport { Input } from \"@/components/ui/input\";\r\nimport { Label } from \"@/components/ui/label\";\r\nimport {\r\n  Select,\r\n  SelectContent,\r\n  SelectItem,\r\n  SelectTrigger,\r\n  SelectValue,\r\n} from \"@/components/ui/select\";\r\nimport {\r\n  Card,\r\n  CardContent,\r\n  CardDescription,\r\n  CardHeader,\r\n  CardTitle,\r\n} from \"@/components/ui/card\";\r\nimport { Separator } from \"@/components/ui/separator\";\r\nimport { Badge } from \"@/components/ui/badge\";\r\nimport { toast } from \"@/hooks/use-toast\";\r\nimport type { User, Usuario } from \"../../types\";\r\nimport { userService } from \"@/services/userService\";\r\nimport { pointService } from \"@/services/pointService\";\r\nimport { currencyService } from \"@/services/currencyService\";\r\nimport { exportToExcel } from \"@/utils/exportToExcel\";\r\nimport {\r\n  Loader2,\r\n  Filter,\r\n  Download,\r\n  BarChart2,\r\n  Calendar,\r\n  Users,\r\n  MapPin,\r\n  Coins,\r\n  TrendingUp,\r\n  FileText,\r\n  RefreshCw,\r\n  AlertCircle,\r\n} from \"lucide-react\";\r\nimport { Alert, AlertDescription } from \"@/components/ui/alert\";\r\n\r\ninterface ReportsProps {\r\n  user: User;\r\n  selectedPoint?: unknown;\r\n}\r\n\r\ntype MainReportType =\r\n  | \"exchanges\"\r\n  | \"transfers\"\r\n  | \"balances\"\r\n  | \"users\"\r\n  | \"worktime\"\r\n  | \"accounting_movements\"\r\n  | \"point_assignments\"\r\n  | \"summary\"\r\n  | \"\";\r\n\r\ntype MetodoEntrega = \"efectivo\" | \"transferencia\";\r\n\r\ntype ReportRow = Record<string, unknown>;\r\n\r\nconst isMainReportType = (v: string): v is MainReportType =>\r\n  v === \"\" ||\r\n  v === \"exchanges\" ||\r\n  v === \"transfers\" ||\r\n  v === \"balances\" ||\r\n  v === \"users\" ||\r\n  v === \"worktime\" ||\r\n  v === \"accounting_movements\" ||\r\n  v === \"point_assignments\" ||\r\n  v === \"summary\";\r\n\r\nconst isMetodoEntrega = (v: string): v is MetodoEntrega =>\r\n  v === \"efectivo\" || v === \"transferencia\";\r\n\r\nconst getRowNumber = (row: ReportRow, key: string): number => {\r\n  const value = row[key];\r\n  if (typeof value === \"number\") return value;\r\n  if (typeof value === \"string\") {\r\n    const n = Number(value);\r\n    return Number.isFinite(n) ? n : 0;\r\n  }\r\n  return 0;\r\n};\r\n\r\nconst ReportsImproved: React.FC<ReportsProps> = ({ user: _user }) => {\r\n  // Estados principales\r\n  const [mainType, setMainType] = useState<MainReportType>(\"\");\r\n\r\n  const [isDetailed, setIsDetailed] = useState<boolean>(false);\r\n  const [corte, setCorte] = useState<\"actual\" | \"eod\">(\"actual\");\r\n\r\n  // Fechas\r\n  const [dateFrom, setDateFrom] = useState(\"\");\r\n  const [dateTo, setDateTo] = useState(\"\");\r\n\r\n  // Estados de carga y datos\r\n  const [loading, setLoading] = useState(false);\r\n  const [reportData, setReportData] = useState<ReportRow[]>([]);\r\n  const [error, setError] = useState<string | null>(null);\r\n\r\n  // Filtros\r\n  const [users, setUsers] = useState<Usuario[]>([]);\r\n  const [userSearch, setUserSearch] = useState(\"\");\r\n  const [selectedUserId, setSelectedUserId] = useState<string | null>(null);\r\n  const [points, setPoints] = useState<{ id: string; nombre: string }[]>([]);\r\n  const [selectedPointId, setSelectedPointId] = useState<string | null>(null);\r\n\r\n  // Filtros adicionales\r\n  const [currencies, setCurrencies] = useState<\r\n    { id: string; codigo: string }[]\r\n  >([]);\r\n  const [selectedCurrencyId, setSelectedCurrencyId] = useState<string | null>(\r\n    null\r\n  );\r\n  const [estado, setEstado] = useState<string | null>(null);\r\n  const [metodoEntrega, setMetodoEntrega] = useState<\r\n    \"efectivo\" | \"transferencia\" | null\r\n  >(null);\r\n\r\n  // Configuraci├│n inicial de fechas (├║ltimos 7 d├¡as)\r\n  useEffect(() => {\r\n    const today = new Date();\r\n    const start = new Date(today);\r\n    start.setDate(today.getDate() - 6);\r\n    setDateFrom(start.toISOString().slice(0, 10));\r\n    setDateTo(today.toISOString().slice(0, 10));\r\n  }, []);\r\n\r\n  // Cargar cat├ílogos seg├║n el tipo de reporte\r\n  useEffect(() => {\r\n    const loadCatalogs = async () => {\r\n      try {\r\n        const needUsersPoints =\r\n          mainType === \"worktime\" ||\r\n          (mainType === \"exchanges\" && isDetailed) ||\r\n          (mainType === \"transfers\" && isDetailed) ||\r\n          mainType === \"accounting_movements\" ||\r\n          (mainType === \"balances\" && corte === \"eod\");\r\n\r\n        const needCurrencies =\r\n          (mainType === \"exchanges\" && isDetailed) ||\r\n          (mainType === \"transfers\" && isDetailed);\r\n\r\n        console.log(\"­ƒôè REPORTES - Cargando cat├ílogos:\", {\r\n          mainType,\r\n          isDetailed,\r\n          corte,\r\n          needUsersPoints,\r\n          needCurrencies,\r\n          currentUsersCount: users.length,\r\n          currentPointsCount: points.length,\r\n        });\r\n\r\n        if (needUsersPoints) {\r\n          if (users.length === 0) {\r\n            console.log(\"­ƒæÑ Cargando usuarios...\");\r\n            const usersRes = await userService.getAllUsers();\r\n            console.log(\"­ƒæÑ Resultado de carga de usuarios:\", {\r\n              error: usersRes.error,\r\n              usersCount: usersRes.users?.length || 0,\r\n            });\r\n            if (!usersRes.error) {\r\n              setUsers(usersRes.users);\r\n              console.log(\"Ô£à Usuarios cargados:\", usersRes.users.length);\r\n            } else {\r\n              console.error(\"ÔØî Error al cargar usuarios:\", usersRes.error);\r\n            }\r\n          }\r\n          if (points.length === 0) {\r\n            console.log(\"­ƒôì Cargando puntos de atenci├│n...\");\r\n            const pointsRes = await pointService.getAllPoints();\r\n            console.log(\"­ƒôì Resultado de carga de puntos:\", {\r\n              error: pointsRes.error,\r\n              pointsCount: pointsRes.points?.length || 0,\r\n            });\r\n            if (!pointsRes.error) {\r\n              const mappedPoints = pointsRes.points.map((p) => ({\r\n                id: p.id,\r\n                nombre: p.nombre,\r\n              }));\r\n              setPoints(mappedPoints);\r\n              console.log(\"Ô£à Puntos cargados:\", mappedPoints);\r\n            } else {\r\n              console.error(\"ÔØî Error al cargar puntos:\", pointsRes.error);\r\n            }\r\n          }\r\n        }\r\n\r\n        if (needCurrencies && currencies.length === 0) {\r\n          const currenciesRes = await currencyService.getAllCurrencies();\r\n          if (!currenciesRes.error) {\r\n            setCurrencies(\r\n              currenciesRes.currencies.map((c) => ({\r\n                id: c.id,\r\n                codigo: c.codigo,\r\n              }))\r\n            );\r\n          }\r\n        }\r\n      } catch (error) {\r\n        console.warn(\"Error cargando cat├ílogos:\", error);\r\n      }\r\n    };\r\n\r\n    loadCatalogs();\r\n  }, [\r\n    mainType,\r\n    isDetailed,\r\n    corte,\r\n    users.length,\r\n    points.length,\r\n    currencies.length,\r\n  ]);\r\n\r\n  // Filtrar usuarios por b├║squeda\r\n  const filteredUsers = useMemo(() => {\r\n    const term = userSearch.trim().toLowerCase();\r\n    if (!term) return users;\r\n    return users.filter(\r\n      (u) =>\r\n        u.nombre.toLowerCase().includes(term) ||\r\n        u.username.toLowerCase().includes(term)\r\n    );\r\n  }, [users, userSearch]);\r\n\r\n  // Tipo efectivo para el backend\r\n  const effectiveReportType = useMemo(() => {\r\n    if (mainType === \"exchanges\")\r\n      return isDetailed ? \"exchanges_detailed\" : \"exchanges\";\r\n    if (mainType === \"transfers\")\r\n      return isDetailed ? \"transfers_detailed\" : \"transfers\";\r\n    if (mainType === \"balances\")\r\n      return corte === \"eod\" ? \"eod_balances\" : \"balances\";\r\n    return mainType || \"\";\r\n  }, [mainType, isDetailed, corte]);\r\n\r\n  // Calcular KPIs\r\n  const kpis = useMemo(() => {\r\n    const sumByKeys = (arr: ReportRow[], keys: string[]) =>\r\n      arr.reduce(\r\n        (acc, r) => acc + keys.reduce((s, k) => s + getRowNumber(r, k), 0),\r\n        0\r\n      );\r\n    const countBy = (arr: ReportRow[], key: string, val: unknown) =>\r\n      arr.filter((r) => r[key] === val).length;\r\n\r\n    const k: Array<{\r\n      label: string;\r\n      value: number | string;\r\n      icon: React.ReactNode;\r\n    }> = [\r\n      {\r\n        label: \"Total Registros\",\r\n        value: reportData.length,\r\n        icon: <FileText className=\"w-4 h-4\" />,\r\n      },\r\n    ];\r\n\r\n    const amount = sumByKeys(reportData, [\r\n      \"monto\",\r\n      \"monto_destino\",\r\n      \"monto_origen\",\r\n      \"amount\",\r\n      \"total\",\r\n      \"balance\",\r\n    ]);\r\n\r\n    if (amount > 0) {\r\n      k.push({\r\n        label: \"Monto Total\",\r\n        value: `$${amount.toLocaleString(\"es-EC\", {\r\n          minimumFractionDigits: 2,\r\n        })}`,\r\n        icon: <TrendingUp className=\"w-4 h-4\" />,\r\n      });\r\n    }\r\n\r\n    if (effectiveReportType === \"transfers_detailed\") {\r\n      k.push({\r\n        label: \"Aprobadas\",\r\n        value: countBy(reportData, \"estado\", \"APROBADO\"),\r\n        icon: <Badge className=\"w-4 h-4\" />,\r\n      });\r\n      k.push({\r\n        label: \"Rechazadas\",\r\n        value: countBy(reportData, \"estado\", \"RECHAZADO\"),\r\n        icon: <AlertCircle className=\"w-4 h-4\" />,\r\n      });\r\n    }\r\n\r\n    if (effectiveReportType === \"exchanges_detailed\") {\r\n      k.push({\r\n        label: \"Completadas\",\r\n        value: countBy(reportData, \"estado\", \"COMPLETADO\"),\r\n        icon: <Badge className=\"w-4 h-4\" />,\r\n      });\r\n      const margen = sumByKeys(reportData, [\"margen_bruto\"]);\r\n      if (margen > 0) {\r\n        k.push({\r\n          label: \"Margen Bruto\",\r\n          value: `$${margen.toLocaleString(\"es-EC\", {\r\n            minimumFractionDigits: 2,\r\n          })}`,\r\n          icon: <TrendingUp className=\"w-4 h-4\" />,\r\n        });\r\n      }\r\n    }\r\n\r\n    return k;\r\n  }, [reportData, effectiveReportType]);\r\n\r\n  // Generar reporte\r\n  const generateReport = async () => {\r\n    if (!effectiveReportType || !dateFrom || !dateTo) {\r\n      toast({\r\n        title: \"Campos requeridos\",\r\n        description: \"Debe seleccionar el tipo de reporte y las fechas\",\r\n        variant: \"destructive\",\r\n      });\r\n      return;\r\n    }\r\n\r\n    setLoading(true);\r\n    setError(null);\r\n\r\n    try {\r\n      const token = localStorage.getItem(\"authToken\");\r\n      const apiUrl =\r\n        import.meta.env.VITE_API_URL || \"http://34.122.108.114:3001/api\";\r\n\r\n      const requestBody = {\r\n        reportType: effectiveReportType,\r\n        dateFrom,\r\n        dateTo,\r\n        // Filtros opcionales\r\n        ...((effectiveReportType === \"worktime\" ||\r\n          effectiveReportType === \"exchanges_detailed\" ||\r\n          effectiveReportType === \"transfers_detailed\" ||\r\n          effectiveReportType === \"accounting_movements\") &&\r\n        selectedUserId\r\n          ? { userId: selectedUserId }\r\n          : {}),\r\n        ...((effectiveReportType === \"worktime\" ||\r\n          effectiveReportType === \"exchanges_detailed\" ||\r\n          effectiveReportType === \"transfers_detailed\" ||\r\n          effectiveReportType === \"accounting_movements\" ||\r\n          effectiveReportType === \"eod_balances\") &&\r\n        selectedPointId\r\n          ? { pointId: selectedPointId }\r\n          : {}),\r\n        ...(effectiveReportType === \"exchanges_detailed\" && selectedCurrencyId\r\n          ? { currencyId: selectedCurrencyId }\r\n          : {}),\r\n        ...(effectiveReportType === \"exchanges_detailed\" && estado\r\n          ? { estado }\r\n          : {}),\r\n        ...(effectiveReportType === \"exchanges_detailed\" && metodoEntrega\r\n          ? { metodoEntrega }\r\n          : {}),\r\n        ...(effectiveReportType === \"transfers_detailed\" && selectedCurrencyId\r\n          ? { currencyId: selectedCurrencyId }\r\n          : {}),\r\n        ...(effectiveReportType === \"transfers_detailed\" && estado\r\n          ? { estado }\r\n          : {}),\r\n      };\r\n\r\n      console.log(\"­ƒôè Enviando solicitud de reporte:\", { apiUrl, requestBody });\r\n      console.log(\"­ƒöÉ Token disponible:\", !!token);\r\n      console.log(\r\n        \"­ƒöÉ Token (primeros 20 chars):\",\r\n        token?.substring(0, 20) + \"...\"\r\n      );\r\n\r\n      const response = await fetch(`${apiUrl}/reports`, {\r\n        method: \"POST\",\r\n        headers: {\r\n          \"Content-Type\": \"application/json\",\r\n          Authorization: `Bearer ${token}`,\r\n        },\r\n        body: JSON.stringify(requestBody),\r\n      });\r\n\r\n      console.log(\"­ƒôí Respuesta del servidor - Status:\", response.status);\r\n      console.log(\r\n        \"­ƒôí Respuesta del servidor - StatusText:\",\r\n        response.statusText\r\n      );\r\n\r\n      const data = await response.json().catch(() => ({\r\n        error: `HTTP ${response.status}: ${response.statusText}`,\r\n      }));\r\n      console.log(\"­ƒôí Respuesta del servidor - Data:\", data);\r\n\r\n      if (!response.ok) {\r\n        if (response.status === 403) {\r\n          throw new Error(\r\n            \"ÔØî Acceso denegado. Verifica tus permisos o contacta al administrador.\"\r\n          );\r\n        } else if (response.status === 401) {\r\n          throw new Error(\r\n            \"ÔØî Sesi├│n expirada. Por favor inicia sesi├│n nuevamente.\"\r\n          );\r\n        } else {\r\n          throw new Error(\r\n            data.error || `ÔØî Error ${response.status}: ${response.statusText}`\r\n          );\r\n        }\r\n      }\r\n\r\n      if (!data.success) {\r\n        throw new Error(data.error || \"Error al generar reporte\");\r\n      }\r\n\r\n      setReportData(Array.isArray(data.data) ? data.data : []);\r\n      toast({\r\n        title: \"Ô£à Reporte generado\",\r\n        description: `Se encontraron ${\r\n          Array.isArray(data.data) ? data.data.length : 0\r\n        } registros`,\r\n      });\r\n    } catch (error) {\r\n      console.error(\"Error generando reporte:\", error);\r\n      const errorMessage =\r\n        error instanceof Error\r\n          ? error.message\r\n          : \"Error desconocido al generar reporte\";\r\n      setError(errorMessage);\r\n      toast({\r\n        title: \"ÔØî Error al generar reporte\",\r\n        description: errorMessage,\r\n        variant: \"destructive\",\r\n      });\r\n    } finally {\r\n      setLoading(false);\r\n    }\r\n  };\r\n\r\n  // Exportar a Excel\r\n  const exportReport = () => {\r\n    if (reportData.length === 0) {\r\n      toast({\r\n        title: \"Sin datos\",\r\n        description: \"No hay datos para exportar\",\r\n        variant: \"destructive\",\r\n      });\r\n      return;\r\n    }\r\n\r\n    const sheetNameMap: Record<string, string> = {\r\n      exchanges: \"Cambios\",\r\n      exchanges_detailed: \"Cambios_Detallados\",\r\n      transfers: \"Transferencias\",\r\n      transfers_detailed: \"Transferencias_Detalladas\",\r\n      balances: \"Saldos\",\r\n      users: \"Usuarios\",\r\n      worktime: \"Tiempo_Trabajo\",\r\n      accounting_movements: \"Movimientos_Contables\",\r\n      eod_balances: \"Saldos_Cierre\",\r\n      point_assignments: \"Asignaciones_Punto\",\r\n      summary: \"Resumen_General\",\r\n    };\r\n\r\n    const fileName = sheetNameMap[effectiveReportType] || \"Reporte\";\r\n    const fullFileName = `${fileName}_${dateFrom}_a_${dateTo}`;\r\n\r\n    try {\r\n      exportToExcel(\r\n        reportData,\r\n        fullFileName,\r\n        undefined,\r\n        undefined,\r\n        undefined,\r\n        fileName\r\n      );\r\n      toast({\r\n        title: \"Ô£à Exportaci├│n exitosa\",\r\n        description: `Archivo ${fullFileName}.xlsx descargado`,\r\n      });\r\n    } catch (error) {\r\n      toast({\r\n        title: \"ÔØî Error al exportar\",\r\n        description: \"No se pudo exportar el archivo\",\r\n        variant: \"destructive\",\r\n      });\r\n    }\r\n  };\r\n\r\n  // Limpiar filtros\r\n  const clearFilters = () => {\r\n    setMainType(\"\");\r\n    setIsDetailed(false);\r\n    setCorte(\"actual\");\r\n    setSelectedUserId(null);\r\n    setSelectedPointId(null);\r\n    setSelectedCurrencyId(null);\r\n    setEstado(null);\r\n    setMetodoEntrega(null);\r\n    setUserSearch(\"\");\r\n    setReportData([]);\r\n    setError(null);\r\n\r\n    // Resetear fechas a ├║ltimos 7 d├¡as\r\n    const today = new Date();\r\n    const start = new Date(today);\r\n    start.setDate(today.getDate() - 6);\r\n    setDateFrom(start.toISOString().slice(0, 10));\r\n    setDateTo(today.toISOString().slice(0, 10));\r\n  };\r\n\r\n  // Helpers de visibilidad\r\n  const showUserFilter =\r\n    mainType === \"worktime\" ||\r\n    (mainType === \"exchanges\" && isDetailed) ||\r\n    (mainType === \"transfers\" && isDetailed) ||\r\n    mainType === \"accounting_movements\";\r\n\r\n  const showPointFilter =\r\n    mainType === \"worktime\" ||\r\n    (mainType === \"exchanges\" && isDetailed) ||\r\n    (mainType === \"transfers\" && isDetailed) ||\r\n    mainType === \"accounting_movements\" ||\r\n    (mainType === \"balances\" && corte === \"eod\");\r\n\r\n  const showCurrencyFilter =\r\n    (mainType === \"exchanges\" && isDetailed) ||\r\n    (mainType === \"transfers\" && isDetailed);\r\n\r\n  const showEstadoFilter =\r\n    (mainType === \"exchanges\" && isDetailed) ||\r\n    (mainType === \"transfers\" && isDetailed);\r\n\r\n  const showMetodoEntregaFilter = mainType === \"exchanges\" && isDetailed;\r\n\r\n  return (\r\n    <div className=\"w-full p-2 sm:p-3 md:p-4 space-y-4 sm:space-y-6\">\r\n      {/* Header mejorado */}\r\n      <div className=\"flex flex-col sm:flex-row sm:items-center sm:justify-between gap-3 sm:gap-4\">\r\n        <div className=\"space-y-1 flex-1 min-w-0\">\r\n          <h1 className=\"text-2xl sm:text-3xl font-bold tracking-tight bg-gradient-to-r from-primary to-primary/70 bg-clip-text text-transparent\">\r\n            ­ƒôè Reportes Generales\r\n          </h1>\r\n          <p className=\"text-muted-foreground text-sm sm:text-base\">\r\n            Genera reportes detallados y exporta datos a Excel de forma\r\n            profesional\r\n          </p>\r\n        </div>\r\n        <Button\r\n          variant=\"outline\"\r\n          onClick={clearFilters}\r\n          className=\"shrink-0 w-full sm:w-auto\"\r\n        >\r\n          <RefreshCw className=\"w-4 h-4 mr-2\" />\r\n          Limpiar Filtros\r\n        </Button>\r\n      </div>\r\n\r\n      {/* Filtros mejorados */}\r\n      <Card className=\"shadow-sm\">\r\n        <CardHeader className=\"pb-4\">\r\n          <CardTitle className=\"flex items-center gap-2 text-xl\">\r\n            <Filter className=\"w-5 h-5 text-primary\" />\r\n            Configuraci├│n del Reporte\r\n          </CardTitle>\r\n          <CardDescription className=\"text-base\">\r\n            Configura los par├ímetros para generar tu reporte personalizado\r\n          </CardDescription>\r\n        </CardHeader>\r\n        <CardContent className=\"space-y-6\">\r\n          {/* Secci├│n 1: Configuraci├│n Principal */}\r\n          <div className=\"space-y-4\">\r\n            <h3 className=\"text-sm font-semibold text-muted-foreground uppercase tracking-wide border-b pb-2\">\r\n              Configuraci├│n Principal\r\n            </h3>\r\n            <div className=\"grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 2xl:grid-cols-4 gap-3 sm:gap-4\">\r\n              <div className=\"space-y-2\">\r\n                <Label className=\"flex items-center gap-2 text-sm font-medium\">\r\n                  <BarChart2 className=\"w-4 h-4 text-primary\" />\r\n                  Tipo de Reporte *\r\n                </Label>\r\n                <Select\r\n                  value={mainType}\r\n                  onValueChange={(v) => {\r\n                    setMainType(isMainReportType(v) ? v : \"\");\r\n                  }}\r\n                >\r\n                  <SelectTrigger className=\"h-10\">\r\n                    <SelectValue placeholder=\"Seleccionar tipo\" />\r\n                  </SelectTrigger>\r\n                  <SelectContent>\r\n                    <SelectItem value=\"exchanges\">­ƒôè Cambios</SelectItem>\r\n                    <SelectItem value=\"transfers\">­ƒÆ© Transferencias</SelectItem>\r\n                    <SelectItem value=\"balances\">­ƒÆ░ Saldos</SelectItem>\r\n                    <SelectItem value=\"users\">­ƒæÑ Actividad Usuarios</SelectItem>\r\n                    <SelectItem value=\"worktime\">\r\n                      ÔÅ░ Tiempo de Trabajo\r\n                    </SelectItem>\r\n                    <SelectItem value=\"accounting_movements\">\r\n                      ­ƒôï Movimientos Contables\r\n                    </SelectItem>\r\n                    <SelectItem value=\"point_assignments\">\r\n                      ­ƒôì Asignaciones de Punto\r\n                    </SelectItem>\r\n                    <SelectItem value=\"summary\">­ƒôê Resumen General</SelectItem>\r\n                  </SelectContent>\r\n                </Select>\r\n              </div>\r\n\r\n              {/* Configuraci├│n espec├¡fica por tipo */}\r\n              {(mainType === \"exchanges\" || mainType === \"transfers\") && (\r\n                <div className=\"space-y-2\">\r\n                  <Label className=\"text-sm font-medium\">\r\n                    Nivel de Detalle\r\n                  </Label>\r\n                  <Select\r\n                    value={isDetailed ? \"detalle\" : \"resumen\"}\r\n                    onValueChange={(v) => setIsDetailed(v === \"detalle\")}\r\n                  >\r\n                    <SelectTrigger className=\"h-10\">\r\n                      <SelectValue />\r\n                    </SelectTrigger>\r\n                    <SelectContent>\r\n                      <SelectItem value=\"resumen\">­ƒôï Resumen</SelectItem>\r\n                      <SelectItem value=\"detalle\">­ƒöì Detallado</SelectItem>\r\n                    </SelectContent>\r\n                  </Select>\r\n                </div>\r\n              )}\r\n\r\n              {mainType === \"balances\" && (\r\n                <div className=\"space-y-2\">\r\n                  <Label className=\"text-sm font-medium\">Tipo de Corte</Label>\r\n                  <Select\r\n                    value={corte}\r\n                    onValueChange={(v) => setCorte(v as \"actual\" | \"eod\")}\r\n                  >\r\n                    <SelectTrigger className=\"h-10\">\r\n                      <SelectValue />\r\n                    </SelectTrigger>\r\n                    <SelectContent>\r\n                      <SelectItem value=\"actual\">­ƒöä Actual</SelectItem>\r\n                      <SelectItem value=\"eod\">­ƒîà Fin de D├¡a</SelectItem>\r\n                    </SelectContent>\r\n                  </Select>\r\n                </div>\r\n              )}\r\n            </div>\r\n          </div>\r\n\r\n          {/* Secci├│n 2: Rango de Fechas */}\r\n          <div className=\"space-y-4\">\r\n            <h3 className=\"text-sm font-semibold text-muted-foreground uppercase tracking-wide border-b pb-2\">\r\n              Rango de Fechas\r\n            </h3>\r\n            <div className=\"grid grid-cols-1 sm:grid-cols-2 gap-4\">\r\n              <div className=\"space-y-2\">\r\n                <Label className=\"flex items-center gap-2 text-sm font-medium\">\r\n                  <Calendar className=\"w-4 h-4 text-primary\" />\r\n                  Fecha Desde *\r\n                </Label>\r\n                <Input\r\n                  type=\"date\"\r\n                  value={dateFrom}\r\n                  onChange={(e) => setDateFrom(e.target.value)}\r\n                  className=\"h-10\"\r\n                />\r\n              </div>\r\n              <div className=\"space-y-2\">\r\n                <Label className=\"flex items-center gap-2 text-sm font-medium\">\r\n                  <Calendar className=\"w-4 h-4 text-primary\" />\r\n                  Fecha Hasta *\r\n                </Label>\r\n                <Input\r\n                  type=\"date\"\r\n                  value={dateTo}\r\n                  onChange={(e) => setDateTo(e.target.value)}\r\n                  className=\"h-10\"\r\n                />\r\n              </div>\r\n            </div>\r\n          </div>\r\n\r\n          {/* Secci├│n 3: Filtros Opcionales */}\r\n          {(showUserFilter ||\r\n            showPointFilter ||\r\n            showCurrencyFilter ||\r\n            showEstadoFilter ||\r\n            showMetodoEntregaFilter) && (\r\n            <div className=\"space-y-4\">\r\n              <h3 className=\"text-sm font-semibold text-muted-foreground uppercase tracking-wide border-b pb-2\">\r\n                Filtros Opcionales\r\n              </h3>\r\n              <div className=\"grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-4\">\r\n                {/* Usuario mejorado */}\r\n                {showUserFilter && (\r\n                  <div className=\"space-y-3\">\r\n                    <Label className=\"flex items-center gap-2 text-sm font-medium\">\r\n                      <Users className=\"w-4 h-4 text-primary\" />\r\n                      Usuario\r\n                      {users.length === 0 && (\r\n                        <Badge variant=\"outline\" className=\"ml-2\">\r\n                          Cargando...\r\n                        </Badge>\r\n                      )}\r\n                      {users.length > 0 && (\r\n                        <Badge variant=\"secondary\" className=\"ml-2\">\r\n                          {users.length} disponibles\r\n                        </Badge>\r\n                      )}\r\n                    </Label>\r\n                    <div className=\"space-y-2\">\r\n                      <Input\r\n                        placeholder=\"­ƒöì Buscar por nombre o usuario...\"\r\n                        value={userSearch}\r\n                        onChange={(e) => setUserSearch(e.target.value)}\r\n                        className=\"h-10\"\r\n                        disabled={users.length === 0}\r\n                      />\r\n                      <Select\r\n                        value={selectedUserId || \"\"}\r\n                        onValueChange={(v) =>\r\n                          setSelectedUserId(v === \"ALL\" ? null : v)\r\n                        }\r\n                        disabled={users.length === 0}\r\n                      >\r\n                        <SelectTrigger className=\"h-10\">\r\n                          <SelectValue placeholder={users.length === 0 ? \"Cargando usuarios...\" : \"Todos los usuarios\"} />\r\n                        </SelectTrigger>\r\n                        <SelectContent className=\"max-h-60\">\r\n                          <SelectItem value=\"ALL\">\r\n                            <div className=\"flex items-center gap-2\">\r\n                              <Users className=\"w-4 h-4\" />\r\n                              Todos los usuarios\r\n                            </div>\r\n                          </SelectItem>\r\n                          {filteredUsers.map((u) => (\r\n                            <SelectItem key={u.id} value={u.id}>\r\n                              <div className=\"flex items-center gap-2\">\r\n                                <div className=\"w-2 h-2 bg-primary rounded-full\" />\r\n                                <span className=\"font-medium\">{u.nombre}</span>\r\n                                <span className=\"text-muted-foreground text-xs\">\r\n                                  @{u.username}\r\n                                </span>\r\n                              </div>\r\n                            </SelectItem>\r\n                          ))}\r\n                        </SelectContent>\r\n                      </Select>\r\n                    </div>\r\n                  </div>\r\n                )}\r\n\r\n                {/* Punto */}\r\n                {showPointFilter && (\r\n                  <div className=\"space-y-2\">\r\n                    <Label className=\"flex items-center gap-2 text-sm font-medium\">\r\n                      <MapPin className=\"w-4 h-4 text-primary\" />\r\n                      Punto de Atenci├│n\r\n                      {points.length === 0 && (\r\n                        <Badge variant=\"outline\" className=\"ml-2\">\r\n                          Cargando...\r\n                        </Badge>\r\n                      )}\r\n                      {points.length > 0 && (\r\n                        <Badge variant=\"secondary\" className=\"ml-2\">\r\n                          {points.length} disponibles\r\n                        </Badge>\r\n                      )}\r\n                    </Label>\r\n                    <Select\r\n                      value={selectedPointId || \"\"}\r\n                      onValueChange={(v) =>\r\n                        setSelectedPointId(v === \"ALL\" ? null : v)\r\n                      }\r\n                      disabled={points.length === 0}\r\n                    >\r\n                      <SelectTrigger className=\"h-10\">\r\n                        <SelectValue placeholder={points.length === 0 ? \"Cargando puntos...\" : \"Todos los puntos\"} />\r\n                      </SelectTrigger>\r\n                      <SelectContent>\r\n                        <SelectItem value=\"ALL\">\r\n                          <div className=\"flex items-center gap-2\">\r\n                            <MapPin className=\"w-4 h-4\" />\r\n                            Todos los puntos\r\n                          </div>\r\n                        </SelectItem>\r\n                        {points.map((p) => (\r\n                          <SelectItem key={p.id} value={p.id}>\r\n                            <div className=\"flex items-center gap-2\">\r\n                              <div className=\"w-2 h-2 bg-green-500 rounded-full\" />\r\n                              {p.nombre}\r\n                            </div>\r\n                          </SelectItem>\r\n                        ))}\r\n                      </SelectContent>\r\n                    </Select>\r\n                  </div>\r\n                )}\r\n\r\n                {/* Moneda */}\r\n                {showCurrencyFilter && (\r\n                  <div className=\"space-y-2\">\r\n                    <Label className=\"flex items-center gap-2 text-sm font-medium\">\r\n                      <Coins className=\"w-4 h-4 text-primary\" />\r\n                      Moneda\r\n                    </Label>\r\n                    <Select\r\n                      value={selectedCurrencyId || \"\"}\r\n                      onValueChange={(v) =>\r\n                        setSelectedCurrencyId(v === \"ALL\" ? null : v)\r\n                      }\r\n                    >\r\n                      <SelectTrigger className=\"h-10\">\r\n                        <SelectValue placeholder=\"Todas las monedas\" />\r\n                      </SelectTrigger>\r\n                      <SelectContent>\r\n                        <SelectItem value=\"ALL\">\r\n                          <div className=\"flex items-center gap-2\">\r\n                            <Coins className=\"w-4 h-4\" />\r\n                            Todas las monedas\r\n                          </div>\r\n                        </SelectItem>\r\n                        {currencies.map((c) => (\r\n                          <SelectItem key={c.id} value={c.id}>\r\n                            <div className=\"flex items-center gap-2\">\r\n                              <div className=\"w-2 h-2 bg-yellow-500 rounded-full\" />\r\n                              {c.codigo}\r\n                            </div>\r\n                          </SelectItem>\r\n                        ))}\r\n                      </SelectContent>\r\n                    </Select>\r\n                  </div>\r\n                )}\r\n\r\n                {/* Estado */}\r\n                {showEstadoFilter && (\r\n                  <div className=\"space-y-2\">\r\n                    <Label className=\"text-sm font-medium\">Estado</Label>\r\n                    <Select\r\n                      value={estado || \"\"}\r\n                      onValueChange={(v) => setEstado(v === \"ALL\" ? null : v)}\r\n                    >\r\n                      <SelectTrigger className=\"h-10\">\r\n                        <SelectValue placeholder=\"Todos los estados\" />\r\n                      </SelectTrigger>\r\n                      <SelectContent>\r\n                        <SelectItem value=\"ALL\">Todos los estados</SelectItem>\r\n                        {mainType === \"exchanges\" && (\r\n                          <>\r\n                            <SelectItem value=\"PENDIENTE\">\r\n                              ­ƒƒí PENDIENTE\r\n                            </SelectItem>\r\n                            <SelectItem value=\"COMPLETADO\">\r\n                              ­ƒƒó COMPLETADO\r\n                            </SelectItem>\r\n                          </>\r\n                        )}\r\n                        {mainType === \"transfers\" && (\r\n                          <>\r\n                            <SelectItem value=\"PENDIENTE\">\r\n                              ­ƒƒí PENDIENTE\r\n                            </SelectItem>\r\n                            <SelectItem value=\"APROBADO\">\r\n                              ­ƒƒó APROBADO\r\n                            </SelectItem>\r\n                            <SelectItem value=\"RECHAZADO\">\r\n                              ­ƒö┤ RECHAZADO\r\n                            </SelectItem>\r\n                          </>\r\n                        )}\r\n                      </SelectContent>\r\n                    </Select>\r\n                  </div>\r\n                )}\r\n\r\n                {/* M├®todo de entrega */}\r\n                {showMetodoEntregaFilter && (\r\n                  <div className=\"space-y-2\">\r\n                    <Label className=\"text-sm font-medium\">\r\n                      M├®todo de Entrega\r\n                    </Label>\r\n                    <Select\r\n                      value={metodoEntrega || \"\"}\r\n                      onValueChange={(v) =>\r\n                        setMetodoEntrega(\r\n                          v === \"ALL\" ? null : isMetodoEntrega(v) ? v : null\r\n                        )\r\n                      }\r\n                    >\r\n                      <SelectTrigger className=\"h-10\">\r\n                        <SelectValue placeholder=\"Todos los m├®todos\" />\r\n                      </SelectTrigger>\r\n                      <SelectContent>\r\n                        <SelectItem value=\"ALL\">Todos los m├®todos</SelectItem>\r\n                        <SelectItem value=\"efectivo\">­ƒÆÁ Efectivo</SelectItem>\r\n                        <SelectItem value=\"transferencia\">\r\n                          ­ƒÅª Transferencia\r\n                        </SelectItem>\r\n                      </SelectContent>\r\n                    </Select>\r\n                  </div>\r\n                )}\r\n              </div>\r\n            </div>\r\n          )}\r\n\r\n          {/* Botones de acci├│n mejorados */}\r\n          <div className=\"flex flex-col sm:flex-row gap-3 pt-6 border-t\">\r\n            <Button\r\n              onClick={generateReport}\r\n              disabled={loading || !effectiveReportType || !dateFrom || !dateTo}\r\n              className=\"flex-1 sm:flex-none h-11 px-6\"\r\n              size=\"lg\"\r\n            >\r\n              {loading ? (\r\n                <Loader2 className=\"w-4 h-4 mr-2 animate-spin\" />\r\n              ) : (\r\n                <BarChart2 className=\"w-4 h-4 mr-2\" />\r\n              )}\r\n              {loading ? \"Generando...\" : \"Generar Reporte\"}\r\n            </Button>\r\n\r\n            <Button\r\n              variant=\"outline\"\r\n              onClick={exportReport}\r\n              disabled={reportData.length === 0}\r\n              className=\"h-11 px-6\"\r\n              size=\"lg\"\r\n            >\r\n              <Download className=\"w-4 h-4 mr-2\" />\r\n              Exportar Excel\r\n            </Button>\r\n          </div>\r\n        </CardContent>\r\n      </Card>\r\n\r\n      {/* Error */}\r\n      {error && (\r\n        <Alert variant=\"destructive\" className=\"border-red-200 bg-red-50\">\r\n          <AlertCircle className=\"h-4 w-4\" />\r\n          <AlertDescription className=\"text-red-800\">\r\n            <strong>Error:</strong> {error}\r\n          </AlertDescription>\r\n        </Alert>\r\n      )}\r\n\r\n      {/* Resultados mejorados */}\r\n      <Card className=\"shadow-sm\">\r\n        <CardHeader className=\"pb-4\">\r\n          <div className=\"flex items-center justify-between\">\r\n            <div>\r\n              <CardTitle className=\"flex items-center gap-2 text-xl\">\r\n                <FileText className=\"w-5 h-5 text-primary\" />\r\n                Resultados del Reporte\r\n              </CardTitle>\r\n              <CardDescription className=\"text-base mt-1\">\r\n                {reportData.length > 0\r\n                  ? `Se encontraron ${reportData.length} registros para el per├¡odo seleccionado`\r\n                  : \"Los resultados aparecer├ín aqu├¡ despu├®s de generar un reporte\"}\r\n              </CardDescription>\r\n            </div>\r\n            {reportData.length > 0 && (\r\n              <Badge variant=\"secondary\" className=\"text-sm px-3 py-1\">\r\n                {reportData.length} registros\r\n              </Badge>\r\n            )}\r\n          </div>\r\n        </CardHeader>\r\n        <CardContent>\r\n          {loading ? (\r\n            <div className=\"flex items-center justify-center py-20\">\r\n              <div className=\"text-center space-y-4\">\r\n                <Loader2 className=\"w-12 h-12 mx-auto animate-spin text-primary\" />\r\n                <div>\r\n                  <p className=\"text-lg font-medium\">Generando reporte...</p>\r\n                  <p className=\"text-sm text-muted-foreground\">\r\n                    Esto puede tomar unos momentos dependiendo del rango de\r\n                    fechas\r\n                  </p>\r\n                </div>\r\n              </div>\r\n            </div>\r\n          ) : reportData.length === 0 ? (\r\n            <div className=\"flex flex-col items-center justify-center py-20 text-center\">\r\n              <div className=\"w-16 h-16 bg-muted rounded-full flex items-center justify-center mb-4\">\r\n                <BarChart2 className=\"w-8 h-8 text-muted-foreground\" />\r\n              </div>\r\n              <h3 className=\"text-lg font-medium mb-2\">\r\n                Sin datos para mostrar\r\n              </h3>\r\n              <p className=\"text-sm text-muted-foreground mb-6 max-w-md\">\r\n                Selecciona un tipo de reporte y configura las fechas para\r\n                comenzar a generar reportes\r\n              </p>\r\n            </div>\r\n          ) : (\r\n            <div className=\"space-y-6\">\r\n              {/* KPIs mejorados */}\r\n              <div className=\"grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-4\">\r\n                {kpis.map((kpi, index) => (\r\n                  <Card\r\n                    key={index}\r\n                    className=\"bg-gradient-to-br from-primary/5 to-primary/10 border-primary/20\"\r\n                  >\r\n                    <CardContent className=\"p-4\">\r\n                      <div className=\"flex items-center gap-3 mb-2\">\r\n                        <div className=\"p-2 bg-primary/10 rounded-lg\">\r\n                          {kpi.icon}\r\n                        </div>\r\n                        <span className=\"text-sm font-medium text-muted-foreground\">\r\n                          {kpi.label}\r\n                        </span>\r\n                      </div>\r\n                      <div className=\"text-2xl font-bold text-primary\">\r\n                        {typeof kpi.value === \"number\"\r\n                          ? kpi.value.toLocaleString(\"es-EC\")\r\n                          : kpi.value}\r\n                      </div>\r\n                    </CardContent>\r\n                  </Card>\r\n                ))}\r\n              </div>\r\n\r\n              <Separator />\r\n\r\n              {/* Tabla de datos mejorada */}\r\n              <div className=\"space-y-4\">\r\n                <div className=\"flex items-center justify-between\">\r\n                  <h4 className=\"text-lg font-semibold\">Datos Detallados</h4>\r\n                  <div className=\"text-sm text-muted-foreground\">\r\n                    Despl├ízate horizontalmente para ver m├ís columnas\r\n                  </div>\r\n                </div>\r\n\r\n                <div className=\"rounded-lg border bg-card overflow-hidden\">\r\n                  <div className=\"overflow-x-auto\">\r\n                    <div className=\"max-h-[600px] overflow-y-auto\">\r\n                      <table className=\"w-full min-w-full\">\r\n                        <thead className=\"bg-muted/50 sticky top-0 z-10\">\r\n                          <tr>\r\n                            {reportData.length > 0 &&\r\n                              Object.keys(reportData[0]).map((key) => (\r\n                                <th\r\n                                  key={key}\r\n                                  className=\"px-4 py-3 text-left text-xs font-semibold uppercase tracking-wider text-muted-foreground whitespace-nowrap border-b\"\r\n                                >\r\n                                  {key.replace(/_/g, \" \")}\r\n                                </th>\r\n                              ))}\r\n                          </tr>\r\n                        </thead>\r\n                        <tbody className=\"divide-y divide-border\">\r\n                          {reportData.map((row, index) => (\r\n                            <tr\r\n                              key={index}\r\n                              className=\"hover:bg-muted/30 transition-colors\"\r\n                            >\r\n                              {Object.values(row).map((value, cellIndex) => (\r\n                                <td\r\n                                  key={cellIndex}\r\n                                  className=\"px-4 py-3 text-sm whitespace-nowrap\"\r\n                                >\r\n                                  <div\r\n                                    className=\"max-w-[200px] truncate\"\r\n                                    title={String(value || \"\")}\r\n                                  >\r\n                                    {typeof value === \"number\"\r\n                                      ? value.toLocaleString(\"es-EC\", {\r\n                                          minimumFractionDigits:\r\n                                            value % 1 === 0 ? 0 : 2,\r\n                                          maximumFractionDigits: 2,\r\n                                        })\r\n                                      : String(value || \"\")}\r\n                                  </div>\r\n                                </td>\r\n                              ))}\r\n                            </tr>\r\n                          ))}\r\n                        </tbody>\r\n                      </table>\r\n                    </div>\r\n                  </div>\r\n                </div>\r\n              </div>\r\n            </div>\r\n          )}\r\n        </CardContent>\r\n      </Card>\r\n    </div>\r\n  );\r\n};\r\n\r\nexport default ReportsImproved;\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\oswal\\OneDrive\\Documentos\\Punto Cambio\\punto_cambio_new\\src\\components\\reports\\ReportsImproved.tsx","messages":[{"ruleId":"no-console","severity":1,"message":"Unexpected console statement. Only these console methods are allowed: warn, error.","line":347,"column":7,"nodeType":"MemberExpression","messageId":"limited","endLine":347,"endColumn":18,"suggestions":[{"fix":{"range":[10642,10713],"text":""},"messageId":"removeConsole","data":{"propertyName":"log"},"desc":"Remove the console.log()."}]},{"ruleId":"no-console","severity":1,"message":"Unexpected console statement. Only these console methods are allowed: warn, error.","line":359,"column":7,"nodeType":"MemberExpression","messageId":"limited","endLine":359,"endColumn":18,"suggestions":[{"fix":{"range":[11031,11076],"text":""},"messageId":"removeConsole","data":{"propertyName":"log"},"desc":"Remove the console.log()."}]},{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'error' is defined but never used.","line":436,"column":14,"nodeType":null,"messageId":"unusedVar","endLine":436,"endColumn":19}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":3,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import React, { useEffect, useMemo, useState } from \"react\";\r\nimport { Button } from \"@/components/ui/button\";\r\nimport { Input } from \"@/components/ui/input\";\r\nimport { Label } from \"@/components/ui/label\";\r\nimport {\r\n  Select,\r\n  SelectContent,\r\n  SelectItem,\r\n  SelectTrigger,\r\n  SelectValue,\r\n} from \"@/components/ui/select\";\r\nimport {\r\n  Card,\r\n  CardContent,\r\n  CardDescription,\r\n  CardHeader,\r\n  CardTitle,\r\n} from \"@/components/ui/card\";\r\nimport { Separator } from \"@/components/ui/separator\";\r\nimport { Badge } from \"@/components/ui/badge\";\r\nimport { toast } from \"@/hooks/use-toast\";\r\nimport type { User, Usuario } from \"../../types\";\r\nimport { userService } from \"@/services/userService\";\r\nimport { pointService } from \"@/services/pointService\";\r\nimport { currencyService } from \"@/services/currencyService\";\r\nimport { exportToExcel } from \"@/utils/exportToExcel\";\r\nimport {\r\n  Loader2,\r\n  Filter,\r\n  Download,\r\n  BarChart2,\r\n  Calendar,\r\n  Users,\r\n  MapPin,\r\n  Coins,\r\n  TrendingUp,\r\n  FileText,\r\n  RefreshCw,\r\n  AlertCircle,\r\n} from \"lucide-react\";\r\nimport { Alert, AlertDescription } from \"@/components/ui/alert\";\r\n\r\ninterface ReportsProps {\r\n  user: User;\r\n  selectedPoint?: unknown;\r\n}\r\n\r\ntype MainReportType =\r\n  | \"exchanges\"\r\n  | \"transfers\"\r\n  | \"balances\"\r\n  | \"users\"\r\n  | \"worktime\"\r\n  | \"accounting_movements\"\r\n  | \"point_assignments\"\r\n  | \"summary\"\r\n  | \"\";\r\n\r\ntype MetodoEntrega = \"efectivo\" | \"transferencia\";\r\n\r\ntype ReportRow = Record<string, unknown>;\r\n\r\nconst isMainReportType = (v: string): v is MainReportType =>\r\n  v === \"\" ||\r\n  v === \"exchanges\" ||\r\n  v === \"transfers\" ||\r\n  v === \"balances\" ||\r\n  v === \"users\" ||\r\n  v === \"worktime\" ||\r\n  v === \"accounting_movements\" ||\r\n  v === \"point_assignments\" ||\r\n  v === \"summary\";\r\n\r\nconst isMetodoEntrega = (v: string): v is MetodoEntrega =>\r\n  v === \"efectivo\" || v === \"transferencia\";\r\n\r\nconst getRowNumber = (row: ReportRow, key: string): number => {\r\n  const value = row[key];\r\n  if (typeof value === \"number\") return value;\r\n  if (typeof value === \"string\") {\r\n    const n = Number(value);\r\n    return Number.isFinite(n) ? n : 0;\r\n  }\r\n  return 0;\r\n};\r\n\r\nconst ReportsImproved: React.FC<ReportsProps> = ({ user: _user }) => {\r\n  // Estados principales\r\n  const [mainType, setMainType] = useState<MainReportType>(\"\");\r\n\r\n  const [isDetailed, setIsDetailed] = useState<boolean>(false);\r\n  const [corte, setCorte] = useState<\"actual\" | \"eod\">(\"actual\");\r\n\r\n  // Fechas\r\n  const [dateFrom, setDateFrom] = useState(\"\");\r\n  const [dateTo, setDateTo] = useState(\"\");\r\n\r\n  // Estados de carga y datos\r\n  const [loading, setLoading] = useState(false);\r\n  const [reportData, setReportData] = useState<ReportRow[]>([]);\r\n  const [error, setError] = useState<string | null>(null);\r\n\r\n  // Filtros\r\n  const [users, setUsers] = useState<Usuario[]>([]);\r\n  const [userSearch, setUserSearch] = useState(\"\");\r\n  const [selectedUserId, setSelectedUserId] = useState<string | null>(null);\r\n  const [points, setPoints] = useState<{ id: string; nombre: string }[]>([]);\r\n  const [selectedPointId, setSelectedPointId] = useState<string | null>(null);\r\n\r\n  // Filtros adicionales\r\n  const [currencies, setCurrencies] = useState<\r\n    { id: string; codigo: string }[]\r\n  >([]);\r\n  const [selectedCurrencyId, setSelectedCurrencyId] = useState<string | null>(\r\n    null\r\n  );\r\n  const [estado, setEstado] = useState<string | null>(null);\r\n  const [metodoEntrega, setMetodoEntrega] = useState<\r\n    \"efectivo\" | \"transferencia\" | null\r\n  >(null);\r\n  const [tipoReferencia, setTipoReferencia] = useState<string | null>(null); // Ô£à Nuevo filtro\r\n\r\n  // Configuraci├│n inicial de fechas (├║ltimos 7 d├¡as)\r\n  useEffect(() => {\r\n    const today = new Date();\r\n    const start = new Date(today);\r\n    start.setDate(today.getDate() - 6);\r\n    setDateFrom(start.toISOString().slice(0, 10));\r\n    setDateTo(today.toISOString().slice(0, 10));\r\n  }, []);\r\n\r\n  // Cargar cat├ílogos seg├║n el tipo de reporte\r\n  useEffect(() => {\r\n    const loadCatalogs = async () => {\r\n      try {\r\n        const needUsersPoints =\r\n          mainType === \"worktime\" ||\r\n          (mainType === \"exchanges\" && isDetailed) ||\r\n          (mainType === \"transfers\" && isDetailed) ||\r\n          mainType === \"accounting_movements\" ||\r\n          (mainType === \"balances\" && corte === \"eod\");\r\n\r\n        const needCurrencies =\r\n          (mainType === \"exchanges\" && isDetailed) ||\r\n          (mainType === \"transfers\" && isDetailed);\r\n\r\n        if (needUsersPoints) {\r\n          if (users.length === 0) {\r\n            const usersRes = await userService.getAllUsers();\r\n            if (!usersRes.error) setUsers(usersRes.users);\r\n          }\r\n          if (points.length === 0) {\r\n            const pointsRes = await pointService.getAllPoints();\r\n            if (!pointsRes.error) {\r\n              setPoints(\r\n                pointsRes.points.map((p) => ({\r\n                  id: p.id,\r\n                  nombre: p.nombre,\r\n                }))\r\n              );\r\n            }\r\n          }\r\n        }\r\n\r\n        if (needCurrencies && currencies.length === 0) {\r\n          const currenciesRes = await currencyService.getAllCurrencies();\r\n          if (!currenciesRes.error) {\r\n            setCurrencies(\r\n              currenciesRes.currencies.map((c) => ({\r\n                id: c.id,\r\n                codigo: c.codigo,\r\n              }))\r\n            );\r\n          }\r\n        }\r\n      } catch (error) {\r\n        console.warn(\"Error cargando cat├ílogos:\", error);\r\n      }\r\n    };\r\n\r\n    loadCatalogs();\r\n  }, [\r\n    mainType,\r\n    isDetailed,\r\n    corte,\r\n    users.length,\r\n    points.length,\r\n    currencies.length,\r\n  ]);\r\n\r\n  // Filtrar usuarios por b├║squeda\r\n  const filteredUsers = useMemo(() => {\r\n    const term = userSearch.trim().toLowerCase();\r\n    if (!term) return users;\r\n    return users.filter(\r\n      (u) =>\r\n        u.nombre.toLowerCase().includes(term) ||\r\n        u.username.toLowerCase().includes(term)\r\n    );\r\n  }, [users, userSearch]);\r\n\r\n  // Tipo efectivo para el backend\r\n  const effectiveReportType = useMemo(() => {\r\n    if (mainType === \"exchanges\")\r\n      return isDetailed ? \"exchanges_detailed\" : \"exchanges\";\r\n    if (mainType === \"transfers\")\r\n      return isDetailed ? \"transfers_detailed\" : \"transfers\";\r\n    if (mainType === \"balances\")\r\n      return corte === \"eod\" ? \"eod_balances\" : \"balances\";\r\n    return mainType || \"\";\r\n  }, [mainType, isDetailed, corte]);\r\n\r\n  // Calcular KPIs\r\n  const kpis = useMemo(() => {\r\n    const sumByKeys = (arr: ReportRow[], keys: string[]) =>\r\n      arr.reduce(\r\n        (acc, r) => acc + keys.reduce((s, k) => s + getRowNumber(r, k), 0),\r\n        0\r\n      );\r\n    const countBy = (arr: ReportRow[], key: string, val: unknown) =>\r\n      arr.filter((r) => r[key] === val).length;\r\n\r\n    const k: Array<{\r\n      label: string;\r\n      value: number | string;\r\n      icon: React.ReactNode;\r\n    }> = [\r\n      {\r\n        label: \"Total Registros\",\r\n        value: reportData.length,\r\n        icon: <FileText className=\"w-4 h-4\" />,\r\n      },\r\n    ];\r\n\r\n    const amount = sumByKeys(reportData, [\r\n      \"monto\",\r\n      \"monto_destino\",\r\n      \"monto_origen\",\r\n      \"amount\",\r\n      \"total\",\r\n      \"balance\",\r\n    ]);\r\n\r\n    if (amount > 0) {\r\n      k.push({\r\n        label: \"Monto Total\",\r\n        value: `$${amount.toLocaleString(\"es-EC\", {\r\n          minimumFractionDigits: 2,\r\n        })}`,\r\n        icon: <TrendingUp className=\"w-4 h-4\" />,\r\n      });\r\n    }\r\n\r\n    if (effectiveReportType === \"transfers_detailed\") {\r\n      k.push({\r\n        label: \"Aprobadas\",\r\n        value: countBy(reportData, \"estado\", \"APROBADO\"),\r\n        icon: <Badge className=\"w-4 h-4\" />,\r\n      });\r\n      k.push({\r\n        label: \"Rechazadas\",\r\n        value: countBy(reportData, \"estado\", \"RECHAZADO\"),\r\n        icon: <AlertCircle className=\"w-4 h-4\" />,\r\n      });\r\n    }\r\n\r\n    if (effectiveReportType === \"exchanges_detailed\") {\r\n      k.push({\r\n        label: \"Completadas\",\r\n        value: countBy(reportData, \"estado\", \"COMPLETADO\"),\r\n        icon: <Badge className=\"w-4 h-4\" />,\r\n      });\r\n      const margen = sumByKeys(reportData, [\"margen_bruto\"]);\r\n      if (margen > 0) {\r\n        k.push({\r\n          label: \"Margen Bruto\",\r\n          value: `$${margen.toLocaleString(\"es-EC\", {\r\n            minimumFractionDigits: 2,\r\n          })}`,\r\n          icon: <TrendingUp className=\"w-4 h-4\" />,\r\n        });\r\n      }\r\n    }\r\n\r\n    return k;\r\n  }, [reportData, effectiveReportType]);\r\n\r\n  // Generar reporte\r\n  const generateReport = async () => {\r\n    if (!effectiveReportType || !dateFrom || !dateTo) {\r\n      toast({\r\n        title: \"Campos requeridos\",\r\n        description: \"Debe seleccionar el tipo de reporte y las fechas\",\r\n        variant: \"destructive\",\r\n      });\r\n      return;\r\n    }\r\n\r\n    setLoading(true);\r\n    setError(null);\r\n\r\n    try {\r\n      const token = localStorage.getItem(\"authToken\");\r\n      const apiUrl =\r\n        import.meta.env.VITE_API_URL || \"http://34.122.108.114:3001/api\";\r\n\r\n      const requestBody = {\r\n        reportType: effectiveReportType,\r\n        dateFrom,\r\n        dateTo,\r\n        // Filtros opcionales\r\n        ...((effectiveReportType === \"worktime\" ||\r\n          effectiveReportType === \"exchanges_detailed\" ||\r\n          effectiveReportType === \"transfers_detailed\" ||\r\n          effectiveReportType === \"accounting_movements\") &&\r\n        selectedUserId\r\n          ? { userId: selectedUserId }\r\n          : {}),\r\n        ...((effectiveReportType === \"worktime\" ||\r\n          effectiveReportType === \"exchanges_detailed\" ||\r\n          effectiveReportType === \"transfers_detailed\" ||\r\n          effectiveReportType === \"accounting_movements\" ||\r\n          effectiveReportType === \"eod_balances\") &&\r\n        selectedPointId\r\n          ? { pointId: selectedPointId }\r\n          : {}),\r\n        ...(effectiveReportType === \"exchanges_detailed\" && selectedCurrencyId\r\n          ? { currencyId: selectedCurrencyId }\r\n          : {}),\r\n        ...(effectiveReportType === \"exchanges_detailed\" && estado\r\n          ? { estado }\r\n          : {}),\r\n        ...(effectiveReportType === \"exchanges_detailed\" && metodoEntrega\r\n          ? { metodoEntrega }\r\n          : {}),\r\n        ...(effectiveReportType === \"transfers_detailed\" && selectedCurrencyId\r\n          ? { currencyId: selectedCurrencyId }\r\n          : {}),\r\n        ...(effectiveReportType === \"transfers_detailed\" && estado\r\n          ? { estado }\r\n          : {}),\r\n        ...(effectiveReportType === \"accounting_movements\" && tipoReferencia\r\n          ? { tipoReferencia }\r\n          : {}), // Ô£à Nuevo filtro para movimientos contables\r\n      };\r\n\r\n      console.log(\"Enviando solicitud de reporte:\", { apiUrl, requestBody });\r\n\r\n      const response = await fetch(`${apiUrl}/reports`, {\r\n        method: \"POST\",\r\n        headers: {\r\n          \"Content-Type\": \"application/json\",\r\n          Authorization: `Bearer ${token}`,\r\n        },\r\n        body: JSON.stringify(requestBody),\r\n      });\r\n\r\n      const data = await response.json();\r\n      console.log(\"Respuesta del servidor:\", data);\r\n\r\n      if (!response.ok) {\r\n        throw new Error(\r\n          data.error || `Error ${response.status}: ${response.statusText}`\r\n        );\r\n      }\r\n\r\n      if (!data.success) {\r\n        throw new Error(data.error || \"Error al generar reporte\");\r\n      }\r\n\r\n      setReportData(Array.isArray(data.data) ? data.data : []);\r\n      toast({\r\n        title: \"Ô£à Reporte generado\",\r\n        description: `Se encontraron ${\r\n          Array.isArray(data.data) ? data.data.length : 0\r\n        } registros`,\r\n      });\r\n    } catch (error) {\r\n      console.error(\"Error generando reporte:\", error);\r\n      const errorMessage =\r\n        error instanceof Error\r\n          ? error.message\r\n          : \"Error desconocido al generar reporte\";\r\n      setError(errorMessage);\r\n      toast({\r\n        title: \"ÔØî Error al generar reporte\",\r\n        description: errorMessage,\r\n        variant: \"destructive\",\r\n      });\r\n    } finally {\r\n      setLoading(false);\r\n    }\r\n  };\r\n\r\n  // Exportar a Excel\r\n  const exportReport = () => {\r\n    if (reportData.length === 0) {\r\n      toast({\r\n        title: \"Sin datos\",\r\n        description: \"No hay datos para exportar\",\r\n        variant: \"destructive\",\r\n      });\r\n      return;\r\n    }\r\n\r\n    const sheetNameMap: Record<string, string> = {\r\n      exchanges: \"Cambios\",\r\n      exchanges_detailed: \"Cambios_Detallados\",\r\n      transfers: \"Transferencias\",\r\n      transfers_detailed: \"Transferencias_Detalladas\",\r\n      balances: \"Saldos\",\r\n      users: \"Usuarios\",\r\n      worktime: \"Tiempo_Trabajo\",\r\n      accounting_movements: \"Movimientos_Contables\",\r\n      eod_balances: \"Saldos_Cierre\",\r\n      point_assignments: \"Asignaciones_Punto\",\r\n      summary: \"Resumen_General\",\r\n    };\r\n\r\n    const fileName = sheetNameMap[effectiveReportType] || \"Reporte\";\r\n    const fullFileName = `${fileName}_${dateFrom}_a_${dateTo}`;\r\n\r\n    try {\r\n      exportToExcel(\r\n        reportData,\r\n        fullFileName,\r\n        undefined,\r\n        undefined,\r\n        undefined,\r\n        fileName\r\n      );\r\n      toast({\r\n        title: \"Ô£à Exportaci├│n exitosa\",\r\n        description: `Archivo ${fullFileName}.xlsx descargado`,\r\n      });\r\n    } catch (error) {\r\n      toast({\r\n        title: \"ÔØî Error al exportar\",\r\n        description: \"No se pudo exportar el archivo\",\r\n        variant: \"destructive\",\r\n      });\r\n    }\r\n  };\r\n\r\n  // Limpiar filtros\r\n  const clearFilters = () => {\r\n    setMainType(\"\");\r\n    setIsDetailed(false);\r\n    setCorte(\"actual\");\r\n    setSelectedUserId(null);\r\n    setSelectedPointId(null);\r\n    setSelectedCurrencyId(null);\r\n    setEstado(null);\r\n    setMetodoEntrega(null);\r\n    setTipoReferencia(null); // Ô£à Limpiar nuevo filtro\r\n    setUserSearch(\"\");\r\n    setReportData([]);\r\n    setError(null);\r\n\r\n    // Resetear fechas a ├║ltimos 7 d├¡as\r\n    const today = new Date();\r\n    const start = new Date(today);\r\n    start.setDate(today.getDate() - 6);\r\n    setDateFrom(start.toISOString().slice(0, 10));\r\n    setDateTo(today.toISOString().slice(0, 10));\r\n  };\r\n\r\n  // Helpers de visibilidad\r\n  const showUserFilter =\r\n    mainType === \"worktime\" ||\r\n    (mainType === \"exchanges\" && isDetailed) ||\r\n    (mainType === \"transfers\" && isDetailed) ||\r\n    mainType === \"accounting_movements\";\r\n\r\n  const showPointFilter =\r\n    mainType === \"worktime\" ||\r\n    (mainType === \"exchanges\" && isDetailed) ||\r\n    (mainType === \"transfers\" && isDetailed) ||\r\n    mainType === \"accounting_movements\" ||\r\n    (mainType === \"balances\" && corte === \"eod\");\r\n\r\n  const showCurrencyFilter =\r\n    (mainType === \"exchanges\" && isDetailed) ||\r\n    (mainType === \"transfers\" && isDetailed);\r\n\r\n  const showEstadoFilter =\r\n    (mainType === \"exchanges\" && isDetailed) ||\r\n    (mainType === \"transfers\" && isDetailed);\r\n\r\n  const showMetodoEntregaFilter = mainType === \"exchanges\" && isDetailed;\r\n\r\n  const showTipoReferenciaFilter = mainType === \"accounting_movements\"; // Ô£à Nuevo filtro\r\n\r\n  return (\r\n    <div className=\"space-y-6\">\r\n      {/* Header */}\r\n      <div className=\"flex items-center justify-between\">\r\n        <div>\r\n          <h1 className=\"text-3xl font-bold tracking-tight\">\r\n            Reportes Generales\r\n          </h1>\r\n          <p className=\"text-muted-foreground\">\r\n            Genera reportes detallados y exporta datos a Excel\r\n          </p>\r\n        </div>\r\n        <Button variant=\"outline\" onClick={clearFilters}>\r\n          <RefreshCw className=\"w-4 h-4 mr-2\" />\r\n          Limpiar Filtros\r\n        </Button>\r\n      </div>\r\n\r\n      {/* Filtros */}\r\n      <Card>\r\n        <CardHeader>\r\n          <CardTitle className=\"flex items-center gap-2\">\r\n            <Filter className=\"w-5 h-5\" />\r\n            Filtros de Reporte\r\n          </CardTitle>\r\n          <CardDescription>\r\n            Configura los par├ímetros para generar tu reporte personalizado\r\n          </CardDescription>\r\n        </CardHeader>\r\n        <CardContent className=\"space-y-6\">\r\n          {/* Fila 1: Tipo y configuraci├│n */}\r\n          <div className=\"grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4\">\r\n            <div className=\"space-y-2\">\r\n              <Label className=\"flex items-center gap-2\">\r\n                <BarChart2 className=\"w-4 h-4\" />\r\n                Tipo de Reporte *\r\n              </Label>\r\n              <Select\r\n                value={mainType}\r\n                  onValueChange={(v) => {\r\n                    setMainType(isMainReportType(v) ? v : \"\");\r\n                  }}\r\n              >\r\n                <SelectTrigger>\r\n                  <SelectValue placeholder=\"Seleccionar tipo\" />\r\n                </SelectTrigger>\r\n                <SelectContent>\r\n                  <SelectItem value=\"exchanges\">­ƒôè Cambios</SelectItem>\r\n                  <SelectItem value=\"transfers\">­ƒÆ© Transferencias</SelectItem>\r\n                  <SelectItem value=\"balances\">­ƒÆ░ Saldos</SelectItem>\r\n                  <SelectItem value=\"users\">­ƒæÑ Actividad Usuarios</SelectItem>\r\n                  <SelectItem value=\"worktime\">ÔÅ░ Tiempo de Trabajo</SelectItem>\r\n                  <SelectItem value=\"accounting_movements\">\r\n                    ­ƒôï Movimientos Contables\r\n                  </SelectItem>\r\n                  <SelectItem value=\"point_assignments\">\r\n                    ­ƒôì Asignaciones de Punto\r\n                  </SelectItem>\r\n                  <SelectItem value=\"summary\">­ƒôê Resumen General</SelectItem>\r\n                </SelectContent>\r\n              </Select>\r\n            </div>\r\n\r\n            {/* Configuraci├│n espec├¡fica por tipo */}\r\n            {(mainType === \"exchanges\" || mainType === \"transfers\") && (\r\n              <div className=\"space-y-2\">\r\n                <Label>Nivel de Detalle</Label>\r\n                <Select\r\n                  value={isDetailed ? \"detalle\" : \"resumen\"}\r\n                  onValueChange={(v) => setIsDetailed(v === \"detalle\")}\r\n                >\r\n                  <SelectTrigger>\r\n                    <SelectValue />\r\n                  </SelectTrigger>\r\n                  <SelectContent>\r\n                    <SelectItem value=\"resumen\">­ƒôï Resumen</SelectItem>\r\n                    <SelectItem value=\"detalle\">­ƒöì Detallado</SelectItem>\r\n                  </SelectContent>\r\n                </Select>\r\n              </div>\r\n            )}\r\n\r\n            {mainType === \"balances\" && (\r\n              <div className=\"space-y-2\">\r\n                <Label>Tipo de Corte</Label>\r\n                <Select\r\n                  value={corte}\r\n                  onValueChange={(v) => setCorte(v as \"actual\" | \"eod\")}\r\n                >\r\n                  <SelectTrigger>\r\n                    <SelectValue />\r\n                  </SelectTrigger>\r\n                  <SelectContent>\r\n                    <SelectItem value=\"actual\">­ƒöä Actual</SelectItem>\r\n                    <SelectItem value=\"eod\">­ƒîà Fin de D├¡a</SelectItem>\r\n                  </SelectContent>\r\n                </Select>\r\n              </div>\r\n            )}\r\n          </div>\r\n\r\n          {/* Fila 2: Fechas */}\r\n          <div className=\"grid grid-cols-1 md:grid-cols-2 gap-4\">\r\n            <div className=\"space-y-2\">\r\n              <Label className=\"flex items-center gap-2\">\r\n                <Calendar className=\"w-4 h-4\" />\r\n                Fecha Desde *\r\n              </Label>\r\n              <Input\r\n                type=\"date\"\r\n                value={dateFrom}\r\n                onChange={(e) => setDateFrom(e.target.value)}\r\n                className=\"w-full\"\r\n              />\r\n            </div>\r\n            <div className=\"space-y-2\">\r\n              <Label className=\"flex items-center gap-2\">\r\n                <Calendar className=\"w-4 h-4\" />\r\n                Fecha Hasta *\r\n              </Label>\r\n              <Input\r\n                type=\"date\"\r\n                value={dateTo}\r\n                onChange={(e) => setDateTo(e.target.value)}\r\n                className=\"w-full\"\r\n              />\r\n            </div>\r\n          </div>\r\n\r\n          {/* Fila 3: Filtros opcionales */}\r\n          <div className=\"grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4\">\r\n            {/* Usuario */}\r\n            {showUserFilter && (\r\n              <div className=\"space-y-2\">\r\n                <Label className=\"flex items-center gap-2\">\r\n                  <Users className=\"w-4 h-4\" />\r\n                  Usuario\r\n                </Label>\r\n                <div className=\"space-y-2\">\r\n                  <Input\r\n                    placeholder=\"Buscar usuario...\"\r\n                    value={userSearch}\r\n                    onChange={(e) => setUserSearch(e.target.value)}\r\n                  />\r\n                  <Select\r\n                    value={selectedUserId || \"\"}\r\n                    onValueChange={(v) =>\r\n                      setSelectedUserId(v === \"ALL\" ? null : v)\r\n                    }\r\n                  >\r\n                    <SelectTrigger>\r\n                      <SelectValue placeholder=\"Todos los usuarios\" />\r\n                    </SelectTrigger>\r\n                    <SelectContent>\r\n                      <SelectItem value=\"ALL\">Todos</SelectItem>\r\n                      {filteredUsers.map((u) => (\r\n                        <SelectItem key={u.id} value={u.id}>\r\n                          {u.nombre} (@{u.username})\r\n                        </SelectItem>\r\n                      ))}\r\n                    </SelectContent>\r\n                  </Select>\r\n                </div>\r\n              </div>\r\n            )}\r\n\r\n            {/* Punto */}\r\n            {showPointFilter && (\r\n              <div className=\"space-y-2\">\r\n                <Label className=\"flex items-center gap-2\">\r\n                  <MapPin className=\"w-4 h-4\" />\r\n                  Punto de Atenci├│n\r\n                </Label>\r\n                <Select\r\n                  value={selectedPointId || \"\"}\r\n                  onValueChange={(v) =>\r\n                    setSelectedPointId(v === \"ALL\" ? null : v)\r\n                  }\r\n                >\r\n                  <SelectTrigger>\r\n                    <SelectValue placeholder=\"Todos los puntos\" />\r\n                  </SelectTrigger>\r\n                  <SelectContent>\r\n                    <SelectItem value=\"ALL\">Todos</SelectItem>\r\n                    {points.map((p) => (\r\n                      <SelectItem key={p.id} value={p.id}>\r\n                        {p.nombre}\r\n                      </SelectItem>\r\n                    ))}\r\n                  </SelectContent>\r\n                </Select>\r\n              </div>\r\n            )}\r\n\r\n            {/* Moneda */}\r\n            {showCurrencyFilter && (\r\n              <div className=\"space-y-2\">\r\n                <Label className=\"flex items-center gap-2\">\r\n                  <Coins className=\"w-4 h-4\" />\r\n                  Moneda\r\n                </Label>\r\n                <Select\r\n                  value={selectedCurrencyId || \"\"}\r\n                  onValueChange={(v) =>\r\n                    setSelectedCurrencyId(v === \"ALL\" ? null : v)\r\n                  }\r\n                >\r\n                  <SelectTrigger>\r\n                    <SelectValue placeholder=\"Todas las monedas\" />\r\n                  </SelectTrigger>\r\n                  <SelectContent>\r\n                    <SelectItem value=\"ALL\">Todas</SelectItem>\r\n                    {currencies.map((c) => (\r\n                      <SelectItem key={c.id} value={c.id}>\r\n                        {c.codigo}\r\n                      </SelectItem>\r\n                    ))}\r\n                  </SelectContent>\r\n                </Select>\r\n              </div>\r\n            )}\r\n\r\n            {/* Estado */}\r\n            {showEstadoFilter && (\r\n              <div className=\"space-y-2\">\r\n                <Label>Estado</Label>\r\n                <Select\r\n                  value={estado || \"\"}\r\n                  onValueChange={(v) => setEstado(v === \"ALL\" ? null : v)}\r\n                >\r\n                  <SelectTrigger>\r\n                    <SelectValue placeholder=\"Todos los estados\" />\r\n                  </SelectTrigger>\r\n                  <SelectContent>\r\n                    <SelectItem value=\"ALL\">Todos</SelectItem>\r\n                    {mainType === \"exchanges\" && (\r\n                      <>\r\n                        <SelectItem value=\"PENDIENTE\">­ƒƒí PENDIENTE</SelectItem>\r\n                        <SelectItem value=\"COMPLETADO\">\r\n                          ­ƒƒó COMPLETADO\r\n                        </SelectItem>\r\n                      </>\r\n                    )}\r\n                    {mainType === \"transfers\" && (\r\n                      <>\r\n                        <SelectItem value=\"PENDIENTE\">­ƒƒí PENDIENTE</SelectItem>\r\n                        <SelectItem value=\"APROBADO\">­ƒƒó APROBADO</SelectItem>\r\n                        <SelectItem value=\"RECHAZADO\">­ƒö┤ RECHAZADO</SelectItem>\r\n                      </>\r\n                    )}\r\n                  </SelectContent>\r\n                </Select>\r\n              </div>\r\n            )}\r\n\r\n            {/* M├®todo de entrega */}\r\n            {showMetodoEntregaFilter && (\r\n              <div className=\"space-y-2\">\r\n                <Label>M├®todo de Entrega</Label>\r\n                <Select\r\n                  value={metodoEntrega || \"\"}\r\n                  onValueChange={(v) =>\r\n                        setMetodoEntrega(\r\n                          v === \"ALL\" ? null : isMetodoEntrega(v) ? v : null\r\n                        )\r\n                  }\r\n                >\r\n                  <SelectTrigger>\r\n                    <SelectValue placeholder=\"Todos los m├®todos\" />\r\n                  </SelectTrigger>\r\n                  <SelectContent>\r\n                    <SelectItem value=\"ALL\">Todos</SelectItem>\r\n                    <SelectItem value=\"efectivo\">­ƒÆÁ Efectivo</SelectItem>\r\n                    <SelectItem value=\"transferencia\">\r\n                      ­ƒÅª Transferencia\r\n                    </SelectItem>\r\n                  </SelectContent>\r\n                </Select>\r\n              </div>\r\n            )}\r\n\r\n            {/* Ô£à Tipo de Referencia (para movimientos contables) */}\r\n            {showTipoReferenciaFilter && (\r\n              <div className=\"space-y-2\">\r\n                <Label>Tipo de Referencia</Label>\r\n                <Select\r\n                  value={tipoReferencia || \"\"}\r\n                  onValueChange={(v) =>\r\n                    setTipoReferencia(v === \"ALL\" ? null : v)\r\n                  }\r\n                >\r\n                  <SelectTrigger>\r\n                    <SelectValue placeholder=\"Todos los tipos\" />\r\n                  </SelectTrigger>\r\n                  <SelectContent>\r\n                    <SelectItem value=\"ALL\">Todos</SelectItem>\r\n                    <SelectItem value=\"CAMBIO_DIVISA\">\r\n                      ­ƒöä Cambio de Divisa\r\n                    </SelectItem>\r\n                    <SelectItem value=\"EXCHANGE\">­ƒÆ▒ Exchange</SelectItem>\r\n                    <SelectItem value=\"TRANSFER\">­ƒÆ© Transferencia</SelectItem>\r\n                    <SelectItem value=\"SERVICIO_EXTERNO\">\r\n                      ­ƒÅó Servicio Externo\r\n                    </SelectItem>\r\n                    <SelectItem value=\"AJUSTE_MANUAL\">\r\n                      Ô£Å´©Å Ajuste Manual\r\n                    </SelectItem>\r\n                    <SelectItem value=\"SALDO_INICIAL\">\r\n                      ­ƒÆ░ Saldo Inicial\r\n                    </SelectItem>\r\n                    <SelectItem value=\"CIERRE_DIARIO\">\r\n                      ­ƒôè Cierre Diario\r\n                    </SelectItem>\r\n                    <SelectItem value=\"SERVIENTREGA\">\r\n                      ­ƒôª Servientrega\r\n                    </SelectItem>\r\n                  </SelectContent>\r\n                </Select>\r\n              </div>\r\n            )}\r\n          </div>\r\n\r\n          {/* Botones de acci├│n */}\r\n          <div className=\"flex flex-wrap gap-3 pt-4 border-t\">\r\n            <Button\r\n              onClick={generateReport}\r\n              disabled={loading || !effectiveReportType || !dateFrom || !dateTo}\r\n              className=\"flex-1 sm:flex-none\"\r\n            >\r\n              {loading ? (\r\n                <Loader2 className=\"w-4 h-4 mr-2 animate-spin\" />\r\n              ) : (\r\n                <BarChart2 className=\"w-4 h-4 mr-2\" />\r\n              )}\r\n              {loading ? \"Generando...\" : \"Generar Reporte\"}\r\n            </Button>\r\n\r\n            <Button\r\n              variant=\"outline\"\r\n              onClick={exportReport}\r\n              disabled={reportData.length === 0}\r\n            >\r\n              <Download className=\"w-4 h-4 mr-2\" />\r\n              Exportar Excel\r\n            </Button>\r\n          </div>\r\n        </CardContent>\r\n      </Card>\r\n\r\n      {/* Error */}\r\n      {error && (\r\n        <Alert variant=\"destructive\">\r\n          <AlertCircle className=\"h-4 w-4\" />\r\n          <AlertDescription>\r\n            <strong>Error:</strong> {error}\r\n          </AlertDescription>\r\n        </Alert>\r\n      )}\r\n\r\n      {/* Resultados */}\r\n      <Card>\r\n        <CardHeader>\r\n          <CardTitle className=\"flex items-center gap-2\">\r\n            <FileText className=\"w-5 h-5\" />\r\n            Resultados del Reporte\r\n          </CardTitle>\r\n          <CardDescription>\r\n            {reportData.length > 0\r\n              ? `Se encontraron ${reportData.length} registros`\r\n              : \"Los resultados aparecer├ín aqu├¡ despu├®s de generar un reporte\"}\r\n          </CardDescription>\r\n        </CardHeader>\r\n        <CardContent>\r\n          {loading ? (\r\n            <div className=\"flex items-center justify-center py-16\">\r\n              <div className=\"text-center\">\r\n                <Loader2 className=\"w-8 h-8 mx-auto mb-4 animate-spin text-primary\" />\r\n                <p className=\"text-lg font-medium\">Generando reporte...</p>\r\n                <p className=\"text-sm text-muted-foreground\">\r\n                  Esto puede tomar unos momentos\r\n                </p>\r\n              </div>\r\n            </div>\r\n          ) : reportData.length === 0 ? (\r\n            <div className=\"flex flex-col items-center justify-center py-16 text-center\">\r\n              <BarChart2 className=\"w-12 h-12 mb-4 text-muted-foreground/50\" />\r\n              <h3 className=\"text-lg font-medium mb-2\">\r\n                Sin datos para mostrar\r\n              </h3>\r\n              <p className=\"text-sm text-muted-foreground mb-4\">\r\n                Selecciona un tipo de reporte y fechas para comenzar\r\n              </p>\r\n            </div>\r\n          ) : (\r\n            <>\r\n              {/* KPIs */}\r\n              <div className=\"grid grid-cols-2 md:grid-cols-4 gap-4 mb-6\">\r\n                {kpis.map((kpi, index) => (\r\n                  <Card\r\n                    key={index}\r\n                    className=\"bg-gradient-to-br from-primary/5 to-primary/10\"\r\n                  >\r\n                    <CardContent className=\"p-4\">\r\n                      <div className=\"flex items-center gap-2 mb-2\">\r\n                        {kpi.icon}\r\n                        <span className=\"text-sm font-medium text-muted-foreground\">\r\n                          {kpi.label}\r\n                        </span>\r\n                      </div>\r\n                      <div className=\"text-2xl font-bold\">\r\n                        {typeof kpi.value === \"number\"\r\n                          ? kpi.value.toLocaleString(\"es-EC\")\r\n                          : kpi.value}\r\n                      </div>\r\n                    </CardContent>\r\n                  </Card>\r\n                ))}\r\n              </div>\r\n\r\n              <Separator className=\"mb-6\" />\r\n\r\n              {/* Tabla de datos */}\r\n              <div className=\"rounded-lg border overflow-hidden\">\r\n                <div className=\"overflow-x-auto max-h-96\">\r\n                  <table className=\"w-full\">\r\n                    <thead className=\"bg-muted/50 sticky top-0\">\r\n                      <tr>\r\n                        {reportData.length > 0 &&\r\n                          Object.keys(reportData[0])\r\n                            .filter((key) => key !== \"signo\") // Ô£à Ocultar columna \"signo\"\r\n                            .map((key) => (\r\n                              <th\r\n                                key={key}\r\n                                className=\"px-4 py-3 text-left text-sm font-semibold whitespace-nowrap\"\r\n                              >\r\n                                {key.replace(/_/g, \" \").toUpperCase()}\r\n                              </th>\r\n                            ))}\r\n                      </tr>\r\n                    </thead>\r\n                    <tbody>\r\n                      {reportData.map((row, index) => (\r\n                        <tr\r\n                          key={index}\r\n                          className=\"hover:bg-muted/30 border-b border-border/50\"\r\n                        >\r\n                          {Object.entries(row).map(\r\n                            ([key, value], cellIndex) => {\r\n                              // Ô£à Formateo especial para monto con signo\r\n                              if (key === \"monto\" && \"signo\" in row) {\r\n                                const signo = row.signo === \"+\" ? \"+\" : \"-\";\r\n                                const color =\r\n                                  row.signo === \"+\"\r\n                                    ? \"text-green-600\"\r\n                                    : \"text-red-600\";\r\n                                return (\r\n                                  <td\r\n                                    key={cellIndex}\r\n                                    className={`px-4 py-3 text-sm font-medium ${color}`}\r\n                                  >\r\n                                    {signo}{\" \"}\r\n                                    {typeof value === \"number\"\r\n                                      ? value.toLocaleString(\"es-EC\", {\r\n                                          minimumFractionDigits: 2,\r\n                                          maximumFractionDigits: 2,\r\n                                        })\r\n                                      : String(value || \"\")}\r\n                                  </td>\r\n                                );\r\n                              }\r\n                              // Ô£à Ocultar columna \"signo\" (ya se muestra con el monto)\r\n                              if (key === \"signo\") {\r\n                                return null;\r\n                              }\r\n                              // Renderizado normal\r\n                              return (\r\n                                <td\r\n                                  key={cellIndex}\r\n                                  className=\"px-4 py-3 text-sm\"\r\n                                >\r\n                                  {typeof value === \"number\"\r\n                                    ? value.toLocaleString(\"es-EC\")\r\n                                    : String(value || \"\")}\r\n                                </td>\r\n                              );\r\n                            }\r\n                          )}\r\n                        </tr>\r\n                      ))}\r\n                    </tbody>\r\n                  </table>\r\n                </div>\r\n              </div>\r\n            </>\r\n          )}\r\n        </CardContent>\r\n      </Card>\r\n    </div>\r\n  );\r\n};\r\n\r\nexport default ReportsImproved;\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\oswal\\OneDrive\\Documentos\\Punto Cambio\\punto_cambio_new\\src\\components\\servientrega\\ListadoGuias.tsx","messages":[{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'Loader2' is defined but never used. Allowed unused vars must match /^_/u.","line":11,"column":10,"nodeType":null,"messageId":"unusedVar","endLine":11,"endColumn":17},{"ruleId":"react-hooks/exhaustive-deps","severity":1,"message":"React Hook useEffect has a missing dependency: 'fetchGuias'. Either include it or remove the dependency array.","line":147,"column":6,"nodeType":"ArrayExpression","endLine":147,"endColumn":20,"suggestions":[{"desc":"Update the dependencies array to be: [desde, fetchGuias, hasta]","fix":{"range":[5086,5100],"text":"[desde, fetchGuias, hasta]"}}]}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":2,"fixableErrorCount":0,"fixableWarningCount":0,"source":"\"use client\";\r\n\r\nimport React, { useEffect, useState } from \"react\";\r\nimport axiosInstance from \"@/services/axiosInstance\";\r\nimport { format, isToday, parseISO, subDays } from \"date-fns\";\r\nimport { Card, CardContent, CardHeader, CardTitle } from \"@/components/ui/card\";\r\nimport { Button } from \"@/components/ui/button\";\r\nimport { Input } from \"@/components/ui/input\";\r\nimport { Label } from \"@/components/ui/label\";\r\nimport { toast } from \"sonner\";\r\nimport { Loader2 } from \"lucide-react\";\r\nimport { useConfirmationDialog } from \"@/components/ui/confirmation-dialog\";\r\nimport { Loading } from \"@/components/ui/loading\";\r\nimport SaldoCompacto from \"./SaldoCompacto\";\r\nimport { useAuth } from \"@/hooks/useAuth\";\r\nimport { Guia } from \"@/types/servientrega\";\r\nimport {\r\n  Dialog,\r\n  DialogContent,\r\n  DialogHeader,\r\n  DialogTitle,\r\n  DialogFooter,\r\n} from \"@/components/ui/dialog\";\r\nimport { Textarea } from \"@/components/ui/textarea\";\r\n\r\nexport default function ListadoGuias() {\r\n  const hoy = new Date();\r\n  const [guias, setGuias] = useState<Guia[]>([]);\r\n  const [desde, setDesde] = useState(format(subDays(hoy, 7), \"yyyy-MM-dd\"));\r\n  const [hasta, setHasta] = useState(format(hoy, \"yyyy-MM-dd\"));\r\n  const [loading, setLoading] = useState(false);\r\n  const [error, setError] = useState<string | null>(null);\r\n  const { showConfirmation, ConfirmationDialog } = useConfirmationDialog();\r\n  const { user } = useAuth();\r\n\r\n  // Estados para solicitud de anulaci├│n\r\n  const [showAnulacionDialog, setShowAnulacionDialog] = useState(false);\r\n  const [guiaParaAnular, setGuiaParaAnular] = useState<Guia | null>(null);\r\n  const [motivoAnulacion, setMotivoAnulacion] = useState(\"\");\r\n\r\n  const fetchGuias = async () => {\r\n    setLoading(true);\r\n    setError(null);\r\n\r\n    try {\r\n      const response = await axiosInstance.get(\"/servientrega/informes/guias\", {\r\n        params: { desde, hasta },\r\n      });\r\n\r\n      if (response.data && Array.isArray(response.data.data)) {\r\n        setGuias(response.data.data);\r\n        if (response.data.data.length === 0) {\r\n          toast.info(\"No se encontraron gu├¡as en el per├¡odo seleccionado.\");\r\n        }\r\n      } else {\r\n        throw new Error(\"Formato de respuesta inv├ílido\");\r\n      }\r\n    } catch (err) {\r\n      const errorMessage =\r\n        err instanceof Error ? err.message : \"Error desconocido\";\r\n      setError(`Error al cargar gu├¡as: ${errorMessage}`);\r\n      toast.error(\"No se pudieron cargar las gu├¡as.\");\r\n      setGuias([]);\r\n    } finally {\r\n      setLoading(false);\r\n    }\r\n  };\r\n\r\n  const handleSolicitarAnulacion = (guia: Guia) => {\r\n    setGuiaParaAnular(guia);\r\n    setMotivoAnulacion(\"\");\r\n    setShowAnulacionDialog(true);\r\n  };\r\n\r\n  const handleConfirmarSolicitudAnulacion = async () => {\r\n    if (!guiaParaAnular || !motivoAnulacion.trim()) {\r\n      toast.error(\"Debe proporcionar un motivo para la anulaci├│n\");\r\n      return;\r\n    }\r\n\r\n    try {\r\n      await axiosInstance.post(\"/servientrega/solicitar-anulacion\", {\r\n        guia_id: guiaParaAnular.id,\r\n        numero_guia: guiaParaAnular.numero_guia,\r\n        motivo: motivoAnulacion.trim(),\r\n      });\r\n\r\n      toast.success(\r\n        \"Ô£à Solicitud de anulaci├│n enviada. Esperando aprobaci├│n del administrador.\"\r\n      );\r\n      setShowAnulacionDialog(false);\r\n      setGuiaParaAnular(null);\r\n      setMotivoAnulacion(\"\");\r\n      fetchGuias();\r\n    } catch (err) {\r\n      const errorMessage =\r\n        err instanceof Error ? err.message : \"Error desconocido\";\r\n      console.error(\"Error al solicitar anulaci├│n:\", err);\r\n      toast.error(`No se pudo enviar la solicitud: ${errorMessage}`);\r\n    }\r\n  };\r\n\r\n  const handleAnularDirecto = (guia: Guia) => {\r\n    showConfirmation(\r\n      \"Confirmar anulaci├│n\",\r\n      `┬┐Est├í seguro de que desea anular la gu├¡a ${guia.numero_guia}? Esta acci├│n no se puede deshacer.`,\r\n      async () => {\r\n        try {\r\n          await axiosInstance.post(\"/servientrega/anular-guia\", {\r\n            guia: guia.numero_guia,\r\n            motivo: \"Anulaci├│n directa por administrador\",\r\n          });\r\n          toast.success(\"Ô£à Gu├¡a anulada exitosamente.\");\r\n          fetchGuias();\r\n        } catch (err) {\r\n          const errorMessage =\r\n            err instanceof Error ? err.message : \"Error desconocido\";\r\n          console.error(\"Error al anular gu├¡a:\", err);\r\n          toast.error(`No se pudo anular la gu├¡a: ${errorMessage}`);\r\n        }\r\n      },\r\n      \"destructive\"\r\n    );\r\n  };\r\n\r\n  const handleVerPDF = (base64: string) => {\r\n    try {\r\n      const pdfURL = `data:application/pdf;base64,${base64}`;\r\n      const win = window.open();\r\n      if (win) {\r\n        win.document.write(\r\n          `<iframe width=\"100%\" height=\"100%\" style=\"border:none;\" src=\"${pdfURL}\"></iframe>`\r\n        );\r\n      } else {\r\n        toast.error(\r\n          \"No se pudo abrir la ventana del PDF. Verifique que no est├® bloqueada por el navegador.\"\r\n        );\r\n      }\r\n    } catch (err) {\r\n      console.error(\"Error al abrir PDF:\", err);\r\n      toast.error(\"Error al mostrar el PDF.\");\r\n    }\r\n  };\r\n\r\n  useEffect(() => {\r\n    fetchGuias();\r\n  }, [desde, hasta]);\r\n\r\n  return (\r\n    <div className=\"w-full max-w-7xl mx-auto mt-3 sm:mt-4 space-y-2 sm:space-y-3\">\r\n      {/* Informaci├│n del saldo */}\r\n      {user?.punto_atencion_id && (\r\n        <SaldoCompacto\r\n          puntoAtencionId={user.punto_atencion_id}\r\n          showSolicitar={true}\r\n        />\r\n      )}\r\n\r\n      <Card>\r\n        <CardHeader className=\"pb-3\">\r\n          <CardTitle className=\"text-base\">Gu├¡as generadas</CardTitle>\r\n        </CardHeader>\r\n        <CardContent>\r\n          {/* Filtros */}\r\n          <div className=\"flex gap-3 mb-4 flex-wrap\">\r\n            <div className=\"flex-1 min-w-32\">\r\n              <Label className=\"text-xs\">Desde</Label>\r\n              <Input\r\n                type=\"date\"\r\n                value={desde}\r\n                onChange={(e) => setDesde(e.target.value)}\r\n                className=\"h-8 text-sm\"\r\n              />\r\n            </div>\r\n            <div className=\"flex-1 min-w-32\">\r\n              <Label className=\"text-xs\">Hasta</Label>\r\n              <Input\r\n                type=\"date\"\r\n                value={hasta}\r\n                onChange={(e) => setHasta(e.target.value)}\r\n                className=\"h-8 text-sm\"\r\n              />\r\n            </div>\r\n            <Button onClick={fetchGuias} className=\"self-end h-8 text-sm\">\r\n              Buscar\r\n            </Button>\r\n          </div>\r\n\r\n          {/* Listado de gu├¡as */}\r\n          {loading ? (\r\n            <Loading text=\"Cargando gu├¡as...\" className=\"py-4\" />\r\n          ) : error ? (\r\n            <div className=\"text-center py-4\">\r\n              <p className=\"text-destructive mb-2 text-sm\">{error}</p>\r\n              <Button onClick={fetchGuias} variant=\"outline\" size=\"sm\">\r\n                Reintentar\r\n              </Button>\r\n            </div>\r\n          ) : guias.length === 0 ? (\r\n            <p className=\"text-muted-foreground text-center py-4 text-sm\">\r\n              No hay gu├¡as en este periodo.\r\n            </p>\r\n          ) : (\r\n            <div className=\"space-y-4\">\r\n              {guias.map((guia) => (\r\n                  <div\r\n                    key={guia.id}\r\n                    className=\"border p-4 rounded flex flex-col md:flex-row justify-between items-start md:items-center gap-2\"\r\n                  >\r\n                    <div>\r\n                      <p>\r\n                        <strong>Gu├¡a:</strong> {guia.numero_guia}\r\n                      </p>\r\n                      <p>\r\n                        <strong>Fecha:</strong>{\" \"}\r\n                        {format(\r\n                          parseISO(guia.created_at || \"\"),\r\n                          \"yyyy-MM-dd HH:mm\"\r\n                        )}\r\n                      </p>\r\n                      <p>\r\n                        <strong>Costo:</strong>{\" \"}\r\n                        {typeof guia.costo_envio === \"number\"\r\n                          ? `$${guia.costo_envio.toFixed(2)}`\r\n                          : \"N/A\"}\r\n                      </p>\r\n                      <p>\r\n                        <strong>Estado:</strong>{\" \"}\r\n                        <span\r\n                          className={`px-2 py-1 rounded text-xs font-medium ${\r\n                            guia.estado === \"ACTIVA\"\r\n                              ? \"bg-green-100 text-green-800\"\r\n                              : guia.estado === \"ANULADA\"\r\n                              ? \"bg-red-100 text-red-800\"\r\n                              : \"bg-yellow-100 text-yellow-800\"\r\n                          }`}\r\n                        >\r\n                          {guia.estado === \"ACTIVA\"\r\n                            ? \"Activa\"\r\n                            : guia.estado === \"ANULADA\"\r\n                            ? \"Anulada\"\r\n                            : \"Pendiente Anulaci├│n\"}\r\n                        </span>\r\n                      </p>\r\n                      {guia.motivo_anulacion && (\r\n                        <p className=\"text-sm text-gray-600 mt-1\">\r\n                          <strong>Motivo:</strong> {guia.motivo_anulacion}\r\n                        </p>\r\n                      )}\r\n                      {/* Campos de agencia/oficina */}\r\n                      <p>\r\n                        <strong>Agencia C├│digo:</strong> {guia.agencia_codigo || \"N/A\"}\r\n                      </p>\r\n                      <p>\r\n                        <strong>Agencia Nombre:</strong> {guia.agencia_nombre || \"N/A\"}\r\n                      </p>\r\n                      <p>\r\n                        <strong>Alianza:</strong> {guia.alianza || \"N/A\"}\r\n                      </p>\r\n                      <p>\r\n                        <strong>Oficina Alianza:</strong> {guia.oficina_alianza || \"N/A\"}\r\n                      </p>\r\n                    </div>\r\n                  <div className=\"flex gap-2 flex-wrap\">\r\n                    <Button\r\n                      onClick={() => handleVerPDF(guia.base64_response || \"\")}\r\n                      variant=\"secondary\"\r\n                      size=\"sm\"\r\n                    >\r\n                      Ver PDF\r\n                    </Button>\r\n\r\n                    {/* L├│gica de botones seg├║n rol y estado */}\r\n                    {guia.estado === \"ACTIVA\" &&\r\n                      isToday(parseISO(guia.created_at || \"\")) && (\r\n                        <>\r\n                          {user?.rol === \"ADMIN\" ||\r\n                          user?.rol === \"SUPER_USUARIO\" ? (\r\n                            <Button\r\n                              onClick={() => handleAnularDirecto(guia)}\r\n                              variant=\"destructive\"\r\n                              size=\"sm\"\r\n                            >\r\n                              Anular\r\n                            </Button>\r\n                          ) : (\r\n                            <Button\r\n                              onClick={() => handleSolicitarAnulacion(guia)}\r\n                              variant=\"outline\"\r\n                              size=\"sm\"\r\n                              className=\"border-orange-300 text-orange-700 hover:bg-orange-50\"\r\n                            >\r\n                              Solicitar Anulaci├│n\r\n                            </Button>\r\n                          )}\r\n                        </>\r\n                      )}\r\n\r\n                    {guia.estado === \"PENDIENTE_ANULACION\" && (\r\n                      <span className=\"text-sm text-yellow-600 font-medium\">\r\n                        Esperando aprobaci├│n\r\n                      </span>\r\n                    )}\r\n\r\n                    {guia.estado === \"ANULADA\" && (\r\n                      <span className=\"text-sm text-red-600 font-medium\">\r\n                        Gu├¡a anulada\r\n                      </span>\r\n                    )}\r\n\r\n                    {guia.estado === \"ACTIVA\" &&\r\n                      !isToday(parseISO(guia.created_at || \"\")) && (\r\n                        <span className=\"text-sm text-gray-500\">\r\n                          No se puede anular\r\n                        </span>\r\n                      )}\r\n                  </div>\r\n                </div>\r\n              ))}\r\n            </div>\r\n          )}\r\n        </CardContent>\r\n        <ConfirmationDialog />\r\n      </Card>\r\n\r\n      {/* Modal para solicitar anulaci├│n */}\r\n      <Dialog open={showAnulacionDialog} onOpenChange={setShowAnulacionDialog}>\r\n        <DialogContent>\r\n          <DialogHeader>\r\n            <DialogTitle>Solicitar Anulaci├│n de Gu├¡a</DialogTitle>\r\n          </DialogHeader>\r\n          <div className=\"space-y-4\">\r\n            <div>\r\n              <p>\r\n                <strong>Gu├¡a:</strong> {guiaParaAnular?.numero_guia}\r\n              </p>\r\n              <p>\r\n                <strong>Fecha:</strong>{\" \"}\r\n                {guiaParaAnular &&\r\n                  format(\r\n                    parseISO(guiaParaAnular.created_at || \"\"),\r\n                    \"yyyy-MM-dd HH:mm\"\r\n                  )}\r\n              </p>\r\n            </div>\r\n            <div>\r\n              <Label htmlFor=\"motivo\">Motivo de la anulaci├│n *</Label>\r\n              <Textarea\r\n                id=\"motivo\"\r\n                placeholder=\"Explique el motivo por el cual solicita la anulaci├│n de esta gu├¡a...\"\r\n                value={motivoAnulacion}\r\n                onChange={(e) => setMotivoAnulacion(e.target.value)}\r\n                rows={4}\r\n              />\r\n            </div>\r\n          </div>\r\n          <DialogFooter>\r\n            <Button\r\n              variant=\"outline\"\r\n              onClick={() => setShowAnulacionDialog(false)}\r\n            >\r\n              Cancelar\r\n            </Button>\r\n            <Button\r\n              onClick={handleConfirmarSolicitudAnulacion}\r\n              disabled={!motivoAnulacion.trim()}\r\n            >\r\n              Enviar Solicitud\r\n            </Button>\r\n          </DialogFooter>\r\n        </DialogContent>\r\n      </Dialog>\r\n    </div>\r\n  );\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\oswal\\OneDrive\\Documentos\\Punto Cambio\\punto_cambio_new\\src\\components\\servientrega\\PasoConfirmarEnvio.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\oswal\\OneDrive\\Documentos\\Punto Cambio\\punto_cambio_new\\src\\components\\servientrega\\PasoDestinatario.tsx","messages":[],"suppressedMessages":[{"ruleId":"react-hooks/exhaustive-deps","severity":1,"message":"React Hook useEffect has a missing dependency: 'cargarCiudadesPorPais'. Either include it or remove the dependency array.","line":192,"column":6,"nodeType":"ArrayExpression","endLine":192,"endColumn":20,"suggestions":[{"desc":"Update the dependencies array to be: [cargarCiudadesPorPais, form.codpais]","fix":{"range":[5850,5864],"text":"[cargarCiudadesPorPais, form.codpais]"}}],"suppressions":[{"kind":"directive","justification":""}]}],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\oswal\\OneDrive\\Documentos\\Punto Cambio\\punto_cambio_new\\src\\components\\servientrega\\PasoEmpaqueYMedidas.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\oswal\\OneDrive\\Documentos\\Punto Cambio\\punto_cambio_new\\src\\components\\servientrega\\PasoProducto.tsx","messages":[],"suppressedMessages":[{"ruleId":"react-hooks/exhaustive-deps","severity":1,"message":"React Hook useEffect has a missing dependency: 'fetchProductos'. Either include it or remove the dependency array.","line":150,"column":6,"nodeType":"ArrayExpression","endLine":150,"endColumn":8,"suggestions":[{"desc":"Update the dependencies array to be: [fetchProductos]","fix":{"range":[4961,4963],"text":"[fetchProductos]"}}],"suppressions":[{"kind":"directive","justification":""}]}],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\oswal\\OneDrive\\Documentos\\Punto Cambio\\punto_cambio_new\\src\\components\\servientrega\\PasoRemitente.tsx","messages":[{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'ciudadesCanon' is assigned a value but never used. Allowed unused vars must match /^_/u.","line":34,"column":10,"nodeType":null,"messageId":"unusedVar","endLine":34,"endColumn":23}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":1,"fixableErrorCount":0,"fixableWarningCount":0,"source":"\"use client\";\r\n\r\nimport React, { useEffect, useState } from \"react\";\r\nimport axiosInstance from \"@/services/axiosInstance\";\r\nimport { Button } from \"@/components/ui/button\";\r\nimport { Card, CardContent, CardHeader, CardTitle } from \"@/components/ui/card\";\r\nimport { Input } from \"@/components/ui/input\";\r\nimport { Loader2 } from \"lucide-react\";\r\nimport { toast } from \"sonner\";\r\nimport { Usuario, PuntoAtencion } from \"../../types\";\r\nimport { Remitente } from \"@/types/servientrega\"; // Usa tu tipado global\r\n\r\ninterface PasoRemitenteProps {\r\n  user: Usuario;\r\n  selectedPoint: PuntoAtencion;\r\n  onNext: (remitente: Remitente) => void;\r\n}\r\n\r\n// Helpers de normalizaci├│n\r\nconst clean = (s: string) =>\r\n  (s ?? \"\")\r\n    .normalize(\"NFD\")\r\n    .replace(/[\\u0300-\\u036f]/g, \"\")\r\n    .toUpperCase()\r\n    .trim();\r\n\r\ntype CiudadCanon = { ciudad: string; provincia: string; raw: string };\r\n\r\nexport default function PasoRemitente({\r\n  selectedPoint,\r\n  onNext,\r\n}: PasoRemitenteProps) {\r\n  // Cat├ílogo oficial de ciudades (Servientrega)\r\n  const [ciudadesCanon, setCiudadesCanon] = useState<CiudadCanon[]>([]);\r\n  const [cargandoCiudades, setCargandoCiudades] = useState(true);\r\n\r\n  // Usa SIEMPRE ciudad/provincia del punto de atenci├│n (validada contra cat├ílogo)\r\n  const [formData, setFormData] = useState<Remitente>({\r\n    identificacion: \"\",\r\n    nombre: \"\",\r\n    direccion: \"\",\r\n    telefono: \"\",\r\n    email: \"\",\r\n    ciudad: selectedPoint?.ciudad || \"\",\r\n    provincia: selectedPoint?.provincia || \"\",\r\n    codigo_postal: selectedPoint?.codigo_postal || \"170150\",\r\n    pais: \"ECUADOR\",\r\n  });\r\n\r\n  const [extraDireccion, setExtraDireccion] = useState({\r\n    callePrincipal: \"\",\r\n    numeracion: \"\",\r\n    calleSecundaria: \"\",\r\n    referencia: \"\",\r\n  });\r\n\r\n  const [loading, setLoading] = useState(false);\r\n  const [ciudadValida, setCiudadValida] = useState(false);\r\n\r\n  const [cedulaQuery, setCedulaQuery] = useState(\"\");\r\n  const [cedulaResultados, setCedulaResultados] = useState<Remitente[]>([]);\r\n  const [buscandoCedula, setBuscandoCedula] = useState(false);\r\n  const [remitenteExistente, setRemitenteExistente] =\r\n    useState<Remitente | null>(null);\r\n\r\n  // 1) Cargar ciudades (codpais: 63 Ecuador) y validar punto de atenci├│n\r\n  useEffect(() => {\r\n    const loadCiudades = async () => {\r\n      try {\r\n        setCargandoCiudades(true);\r\n        const { data } = await axiosInstance.post(\"/servientrega/ciudades\", {\r\n          codpais: 63,\r\n        });\r\n\r\n        const lista: CiudadCanon[] = (data?.fetch || []).map(\r\n          (it: { city: string }) => {\r\n            const [ciu, prov] = (it.city || \"\").split(\"-\");\r\n            return {\r\n              ciudad: (ciu || \"\").trim(),\r\n              provincia: (prov || \"\").trim(),\r\n              raw: it.city,\r\n            };\r\n          }\r\n        );\r\n\r\n        setCiudadesCanon(lista);\r\n\r\n        // Validar/ajustar contra cat├ílogo\r\n        const spCiudad = clean(selectedPoint?.ciudad || \"\");\r\n        const spProv = clean(selectedPoint?.provincia || \"\");\r\n\r\n        // Match exacto (normalizado)\r\n        let match =\r\n          lista.find(\r\n            (c) => clean(c.ciudad) === spCiudad && clean(c.provincia) === spProv\r\n          ) || null;\r\n\r\n        // Match aproximado si no hay exacto (contiene)\r\n        if (!match) {\r\n          match =\r\n            lista.find(\r\n              (c) =>\r\n                clean(c.ciudad).includes(spCiudad) &&\r\n                clean(c.provincia).includes(spProv)\r\n            ) || null;\r\n        }\r\n\r\n        if (match) {\r\n          setFormData((prev) => ({\r\n            ...prev,\r\n            ciudad: match.ciudad,\r\n            provincia: match.provincia,\r\n            pais: \"ECUADOR\",\r\n          }));\r\n          setCiudadValida(true);\r\n        } else {\r\n          setCiudadValida(false);\r\n          setFormData((prev) => ({\r\n            ...prev,\r\n            ciudad: selectedPoint?.ciudad || \"\",\r\n            provincia: selectedPoint?.provincia || \"\",\r\n            pais: \"ECUADOR\",\r\n          }));\r\n          toast.error(\r\n            \"La ciudad/provincia del Punto de Atenci├│n no existe en el cat├ílogo de Servientrega. Contacta a soporte para homologar el punto.\"\r\n          );\r\n        }\r\n      } catch (e) {\r\n        console.error(\"ÔØî Error cargando ciudades:\", e);\r\n        setCiudadValida(false);\r\n        toast.error(\r\n          \"No se pudo validar ciudades con Servientrega. Verifica conexi├│n.\"\r\n        );\r\n      } finally {\r\n        setCargandoCiudades(false);\r\n      }\r\n    };\r\n\r\n    loadCiudades();\r\n     \r\n  }, [selectedPoint?.ciudad, selectedPoint?.provincia]);\r\n\r\n  // 2) B├║squeda predictiva de remitente\r\n  useEffect(() => {\r\n    const query = cedulaQuery.trim();\r\n    if (query.length >= 3) {\r\n      setBuscandoCedula(true);\r\n      axiosInstance\r\n        .get(`/servientrega/remitente/buscar/${encodeURIComponent(query)}`)\r\n        .then((res) => setCedulaResultados(res.data.remitentes || []))\r\n        .catch(() => setCedulaResultados([]))\r\n        .finally(() => setBuscandoCedula(false));\r\n    } else {\r\n      setCedulaResultados([]);\r\n    }\r\n  }, [cedulaQuery]);\r\n\r\n  const seleccionarRemitente = (rem: Remitente) => {\r\n    setFormData((prev) => ({\r\n      ...prev,\r\n      identificacion: rem.cedula || rem.identificacion || \"\",\r\n      nombre: rem.nombre || \"\",\r\n      telefono: rem.telefono || \"\",\r\n      email: rem.email || \"\",\r\n      direccion: rem.direccion || \"\",\r\n      // Fijar SIEMPRE la ciudad/provincia del punto (ya validadas contra cat├ílogo)\r\n      ciudad: prev.ciudad,\r\n      provincia: prev.provincia,\r\n      codigo_postal: prev.codigo_postal || \"170150\",\r\n      pais: \"ECUADOR\",\r\n    }));\r\n\r\n    // Parseo de direcci├│n\r\n    if (rem.direccion) {\r\n      const partes = String(rem.direccion)\r\n        .split(\",\")\r\n        .map((p: string) => p.trim());\r\n      const referenciaIndex = partes.findIndex((p: string) =>\r\n        p.toLowerCase().startsWith(\"ref:\")\r\n      );\r\n      const referencia =\r\n        referenciaIndex >= 0\r\n          ? partes\r\n              .slice(referenciaIndex)\r\n              .join(\", \")\r\n              .replace(/^Ref:\\s*/i, \"\")\r\n              .trim()\r\n          : \"\";\r\n\r\n      const partesAntes =\r\n        referenciaIndex >= 0 ? partes.slice(0, referenciaIndex) : partes;\r\n\r\n      const callePrincipal = partesAntes[0]?.trim() || \"\";\r\n      const segundaParte = partesAntes[1]?.trim() || \"\";\r\n      let numeracion = \"\";\r\n      let calleSecundaria = \"\";\r\n\r\n      if (segundaParte.startsWith(\"#\")) {\r\n        numeracion = segundaParte.replace(\"#\", \"\").trim();\r\n        calleSecundaria = partesAntes[2]?.replace(/^y\\s*/i, \"\").trim() || \"\";\r\n      } else {\r\n        calleSecundaria = segundaParte.replace(/^y\\s*/i, \"\").trim();\r\n      }\r\n\r\n      setExtraDireccion({\r\n        callePrincipal,\r\n        numeracion,\r\n        calleSecundaria,\r\n        referencia,\r\n      });\r\n    }\r\n\r\n    setRemitenteExistente(rem);\r\n    setCedulaResultados([]);\r\n  };\r\n\r\n  // Validaci├│n identificaci├│n EC (c├®dula/RUC) + fallback pasaporte\r\n  const validarIdentificacion = (id: string): boolean => {\r\n    const cleanId = (id || \"\").trim();\r\n    if (!cleanId) return false;\r\n    if (/^\\d{10}$/.test(cleanId)) {\r\n      const provincia = parseInt(cleanId.substring(0, 2));\r\n      if (provincia < 1 || provincia > 24) return false;\r\n      const digitoVerificador = parseInt(cleanId[9]);\r\n      const coef = [2, 1, 2, 1, 2, 1, 2, 1, 2];\r\n      let suma = 0;\r\n      for (let i = 0; i < 9; i++) {\r\n        let val = parseInt(cleanId[i]) * coef[i];\r\n        if (val >= 10) val -= 9;\r\n        suma += val;\r\n      }\r\n      return digitoVerificador === (10 - (suma % 10)) % 10;\r\n    }\r\n    if (/^\\d{13}$/.test(cleanId))\r\n      return validarIdentificacion(cleanId.substring(0, 10));\r\n    return /^[A-Za-z0-9]{6,}$/.test(cleanId); // pasaporte gen├®rico\r\n  };\r\n\r\n  const handleChange = (e: React.ChangeEvent<HTMLInputElement>) =>\r\n    setFormData((prev) => ({ ...prev, [e.target.name]: e.target.value }));\r\n\r\n  const handleExtraDireccionChange = (e: React.ChangeEvent<HTMLInputElement>) =>\r\n    setExtraDireccion((prev) => ({ ...prev, [e.target.name]: e.target.value }));\r\n\r\n  const handleContinue = async () => {\r\n    if (cargandoCiudades) {\r\n      toast.info(\"Cargando cat├ílogo de ciudades...\");\r\n      return;\r\n    }\r\n    if (!ciudadValida) {\r\n      toast.error(\r\n        \"La ciudad del Punto de Atenci├│n no est├í homologada. No se puede continuar.\"\r\n      );\r\n      return;\r\n    }\r\n\r\n    const { identificacion, nombre, telefono, email, ciudad, pais } = formData;\r\n    if (!identificacion || !nombre || !telefono || !email || !ciudad || !pais) {\r\n      toast.error(\"Completa todos los campos obligatorios.\");\r\n      return;\r\n    }\r\n    if (!validarIdentificacion(identificacion)) {\r\n      toast.error(\"N├║mero de identificaci├│n inv├ílido.\");\r\n      return;\r\n    }\r\n\r\n    const direccionFinal = [\r\n      extraDireccion.callePrincipal.trim(),\r\n      extraDireccion.numeracion && `#${extraDireccion.numeracion.trim()}`,\r\n      extraDireccion.calleSecundaria &&\r\n        `y ${extraDireccion.calleSecundaria.trim()}`,\r\n      extraDireccion.referencia && `Ref: ${extraDireccion.referencia.trim()}`,\r\n    ]\r\n      .filter(Boolean)\r\n      .join(\", \");\r\n\r\n    if (!direccionFinal.trim()) {\r\n      toast.error(\"La direcci├│n es requerida\");\r\n      return;\r\n    }\r\n\r\n    // Construye el remitente canonizado\r\n    const remitenteFinal: Remitente = {\r\n      identificacion: formData.identificacion.trim(),\r\n      nombre: formData.nombre.trim(),\r\n      direccion: direccionFinal.trim(),\r\n      telefono: formData.telefono.trim(),\r\n      email: formData.email?.trim() || \"\",\r\n      ciudad: formData.ciudad.trim(), // canon Servientrega\r\n      provincia: formData.provincia.trim(), // canon Servientrega\r\n      codigo_postal: formData.codigo_postal?.trim() || \"170150\",\r\n      pais: \"ECUADOR\",\r\n    };\r\n\r\n    // Payload a BD (usa campos b├ísicos por compatibilidad)\r\n    const payload = {\r\n      cedula: remitenteFinal.identificacion,\r\n      nombre: remitenteFinal.nombre,\r\n      direccion: remitenteFinal.direccion,\r\n      telefono: remitenteFinal.telefono,\r\n      email: remitenteFinal.email,\r\n      codigo_postal: remitenteFinal.codigo_postal,\r\n      ciudad: remitenteFinal.ciudad,\r\n      provincia: remitenteFinal.provincia,\r\n    };\r\n\r\n    setLoading(true);\r\n    try {\r\n      if (remitenteExistente) {\r\n        await axiosInstance.put(\r\n          `/servientrega/remitente/actualizar/${remitenteFinal.identificacion}`,\r\n          payload\r\n        );\r\n      } else {\r\n        await axiosInstance.post(\"/servientrega/remitente/guardar\", payload);\r\n      }\r\n      toast.success(\"Remitente guardado correctamente.\");\r\n      onNext(remitenteFinal);\r\n    } catch (err) {\r\n      console.error(\r\n        \"ÔØî Error al guardar remitente:\",\r\n        err,\r\n        \"\\nPayload:\",\r\n        payload\r\n      );\r\n      toast.error(\"Hubo un problema al guardar el remitente.\");\r\n    } finally {\r\n      setLoading(false);\r\n    }\r\n  };\r\n\r\n  return (\r\n    <Card className=\"w-full max-w-3xl mx-auto mt-4 sm:mt-6\">\r\n      <CardHeader>\r\n        <CardTitle>Informaci├│n del Remitente</CardTitle>\r\n      </CardHeader>\r\n      <CardContent className=\"space-y-4\">\r\n        {/* Identificaci├│n (con b├║squeda) */}\r\n        <div className=\"relative\">\r\n          <Input\r\n            name=\"identificacion\"\r\n            placeholder=\"C├®dula, RUC o Pasaporte\"\r\n            value={formData.identificacion}\r\n            onChange={(e) => {\r\n              const value = e.target.value.trimStart();\r\n              setFormData((prev) => ({ ...prev, identificacion: value }));\r\n              setCedulaQuery(value);\r\n            }}\r\n          />\r\n          {buscandoCedula && (\r\n            <Loader2 className=\"absolute right-2 top-2 h-4 w-4 animate-spin text-gray-400\" />\r\n          )}\r\n          {cedulaResultados.length > 0 && (\r\n            <div className=\"absolute bg-white border rounded-md shadow-md w-full max-h-40 overflow-y-auto z-10\">\r\n              {cedulaResultados.map((r, idx) => (\r\n                <div\r\n                  key={idx}\r\n                  className=\"p-2 hover:bg-gray-100 cursor-pointer\"\r\n                  onClick={() => seleccionarRemitente(r)}\r\n                >\r\n                  {(r.cedula || r.identificacion) + \" - \" + r.nombre}\r\n                </div>\r\n              ))}\r\n            </div>\r\n          )}\r\n        </div>\r\n\r\n        <Input\r\n          name=\"nombre\"\r\n          placeholder=\"Nombre completo\"\r\n          value={formData.nombre}\r\n          onChange={handleChange}\r\n        />\r\n        <Input\r\n          name=\"telefono\"\r\n          placeholder=\"Tel├®fono\"\r\n          value={formData.telefono}\r\n          onChange={handleChange}\r\n        />\r\n        <Input\r\n          name=\"email\"\r\n          placeholder=\"Correo electr├│nico\"\r\n          value={formData.email}\r\n          onChange={handleChange}\r\n        />\r\n\r\n        {/* Direcci├│n desglosada */}\r\n        <Input\r\n          name=\"callePrincipal\"\r\n          placeholder=\"Calle principal\"\r\n          value={extraDireccion.callePrincipal}\r\n          onChange={handleExtraDireccionChange}\r\n        />\r\n        <Input\r\n          name=\"numeracion\"\r\n          placeholder=\"Numeraci├│n\"\r\n          value={extraDireccion.numeracion}\r\n          onChange={handleExtraDireccionChange}\r\n        />\r\n        <Input\r\n          name=\"calleSecundaria\"\r\n          placeholder=\"Calle secundaria\"\r\n          value={extraDireccion.calleSecundaria}\r\n          onChange={handleExtraDireccionChange}\r\n        />\r\n        <Input\r\n          name=\"referencia\"\r\n          placeholder=\"Referencia\"\r\n          value={extraDireccion.referencia}\r\n          onChange={handleExtraDireccionChange}\r\n        />\r\n\r\n        {/* Ciudad y Provincia ÔÇö SIEMPRE desde punto de atenci├│n y validadas contra cat├ílogo */}\r\n        <Input\r\n          name=\"ciudad\"\r\n          value={\r\n            cargandoCiudades\r\n              ? \"Validando ciudad del punto...\"\r\n              : `${formData.ciudad} - ${formData.provincia}`\r\n          }\r\n          readOnly\r\n        />\r\n\r\n        {/* Pa├¡s (fijo) */}\r\n        <Input name=\"pais\" placeholder=\"Pa├¡s\" value={formData.pais} readOnly />\r\n\r\n        <Button\r\n          disabled={loading || !ciudadValida}\r\n          onClick={handleContinue}\r\n          className=\"w-full\"\r\n        >\r\n          {loading ? (\r\n            <Loader2 className=\"mr-2 h-4 w-4 animate-spin\" />\r\n          ) : (\r\n            \"Continuar\"\r\n          )}\r\n        </Button>\r\n      </CardContent>\r\n    </Card>\r\n  );\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\oswal\\OneDrive\\Documentos\\Punto Cambio\\punto_cambio_new\\src\\components\\servientrega\\PasoResumen.tsx","messages":[{"ruleId":"no-console","severity":1,"message":"Unexpected console statement. Only these console methods are allowed: warn, error.","line":265,"column":7,"nodeType":"MemberExpression","messageId":"limited","endLine":265,"endColumn":18,"suggestions":[{"fix":{"range":[8450,8507],"text":""},"messageId":"removeConsole","data":{"propertyName":"log"},"desc":"Remove the console.log()."}]},{"ruleId":"no-console","severity":1,"message":"Unexpected console statement. Only these console methods are allowed: warn, error.","line":324,"column":7,"nodeType":"MemberExpression","messageId":"limited","endLine":324,"endColumn":18,"suggestions":[{"fix":{"range":[10592,10637],"text":""},"messageId":"removeConsole","data":{"propertyName":"log"},"desc":"Remove the console.log()."}]}],"suppressedMessages":[{"ruleId":"react-hooks/exhaustive-deps","severity":1,"message":"React Hook useEffect has missing dependencies: 'fetchTarifa' and 'obtenerSaldo'. Either include them or remove the dependency array.","line":359,"column":6,"nodeType":"ArrayExpression","endLine":359,"endColumn":16,"suggestions":[{"desc":"Update the dependencies array to be: [fetchTarifa, formData, obtenerSaldo]","fix":{"range":[11783,11793],"text":"[fetchTarifa, formData, obtenerSaldo]"}}],"suppressions":[{"kind":"directive","justification":""}]}],"errorCount":0,"fatalErrorCount":0,"warningCount":2,"fixableErrorCount":0,"fixableWarningCount":0,"source":"// src/components/servientrega/PasoResumen.tsx\r\n\"use client\";\r\n\r\nimport React, { useEffect, useMemo, useState } from \"react\";\r\nimport axiosInstance from \"@/services/axiosInstance\";\r\nimport { Card, CardHeader, CardTitle, CardContent } from \"@/components/ui/card\";\r\nimport { Separator } from \"@/components/ui/separator\";\r\nimport { Button } from \"@/components/ui/button\";\r\nimport { toast } from \"sonner\";\r\nimport { Loader2, Wallet, AlertTriangle, Calculator } from \"lucide-react\";\r\nimport TarifaModal from \"./TarifaModal\";\r\n\r\n/** Tipos m├¡nimos locales (ajusta si ya los tienes tipados globalmente) */\r\ninterface Remitente {\r\n  identificacion?: string;\r\n  nombre?: string;\r\n  direccion?: string;\r\n  telefono?: string;\r\n  email?: string;\r\n  ciudad?: string;\r\n  provincia?: string;\r\n  codigo_postal?: string;\r\n  pais?: string;\r\n}\r\ninterface Destinatario extends Remitente {\r\n  codpais?: number;\r\n}\r\ninterface Medidas {\r\n  alto: number;\r\n  ancho: number;\r\n  largo: number;\r\n  peso: number;\r\n  valor_declarado: number;\r\n  valor_seguro?: number;\r\n  recoleccion?: boolean;\r\n}\r\ninterface FormDataGuia {\r\n  remitente: Remitente;\r\n  destinatario: Destinatario;\r\n  medidas: Medidas;\r\n  punto_atencion_id?: string | number;\r\n  nombre_producto?: string; // Texto que viene del PasoProducto\r\n  requiere_empaque?: boolean;\r\n  empaque?: { tipo_empaque: string };\r\n  contenido?: string;\r\n  retiro_oficina?: boolean;\r\n  nombre_agencia_retiro_oficina?: string;\r\n  pedido?: string;\r\n  factura?: string;\r\n}\r\n\r\ninterface PasoResumenProps {\r\n  formData: FormDataGuia;\r\n  onBack: () => void;\r\n  onConfirm: (tarifaData: TarifaResponseUI) => void; // Pasar la tarifa calculada\r\n}\r\n\r\n/** Respuesta que mostramos en la UI */\r\ninterface TarifaResponseUI {\r\n  flete: number;\r\n  valor_declarado: number;\r\n  valor_empaque: number;\r\n  seguro?: number;\r\n  tiempo: string | null;\r\n  peso_vol?: number;\r\n  descuento?: number;\r\n  tarifa0?: number;\r\n  tarifa12?: number;\r\n  tiva?: number;\r\n  gtotal?: number;\r\n  total_transacion?: number;\r\n  trayecto?: string;\r\n}\r\n\r\n/** Para pintar campos */\r\nconst Campo = ({\r\n  label,\r\n  value,\r\n  highlight = false,\r\n}: {\r\n  label: string;\r\n  value: string | number | undefined;\r\n  highlight?: boolean;\r\n}) => (\r\n  <div className=\"flex justify-between py-1 text-sm border-b last:border-0\">\r\n    <span className=\"font-medium text-gray-600\">{label}</span>\r\n    <span\r\n      className={`text-right ${\r\n        highlight ? \"text-red-600 font-bold\" : \"text-gray-900\"\r\n      }`}\r\n    >\r\n      {value !== undefined && value !== null && value !== \"\" ? value : \"-\"}\r\n    </span>\r\n  </div>\r\n);\r\n\r\nconst Seccion = ({\r\n  titulo,\r\n  children,\r\n}: {\r\n  titulo: string;\r\n  children: React.ReactNode;\r\n}) => (\r\n  <div className=\"mb-6 border rounded-lg p-4 bg-gray-50\">\r\n    <h3 className=\"text-md font-semibold text-primary mb-3\">{titulo}</h3>\r\n    <div className=\"grid grid-cols-1 sm:grid-cols-2 gap-x-6 gap-y-2\">\r\n      {children}\r\n    </div>\r\n  </div>\r\n);\r\n\r\n/** Helpers de negocio */\r\nconst DEFAULT_EMPAQUE = \"AISLANTE DE HUMEDAD\";\r\nconst DEFAULT_CP_ORI = \"170150\";\r\nconst DEFAULT_CP_DES = \"110111\";\r\nconst UMBRAL_SALDO_BAJO = 2.0;\r\n\r\n/** Normaliza el nombre del producto seg├║n documentaci├│n */\r\nfunction mapProducto(\r\n  nombre?: string\r\n): \"DOCUMENTO UNITARIO\" | \"MERCANCIA PREMIER\" {\r\n  const raw = (nombre || \"\").toUpperCase();\r\n  if (raw.includes(\"DOC\")) return \"DOCUMENTO UNITARIO\";\r\n  return \"MERCANCIA PREMIER\";\r\n}\r\n\r\n/** Calcula peso volum├®trico localmente */\r\nfunction calcPesoVol({ alto = 0, ancho = 0, largo = 0 }: Partial<Medidas>) {\r\n  const a = Number(alto) || 0;\r\n  const b = Number(ancho) || 0;\r\n  const c = Number(largo) || 0;\r\n  return a > 0 && b > 0 && c > 0 ? (a * b * c) / 5000 : 0;\r\n}\r\n\r\nexport default function PasoResumen({\r\n  formData,\r\n  onBack,\r\n  onConfirm,\r\n}: PasoResumenProps) {\r\n  const { remitente, destinatario, medidas, punto_atencion_id } = formData;\r\n\r\n  /** Estado UI */\r\n  const [tarifa, setTarifa] = useState<TarifaResponseUI | null>(null);\r\n  const [tarifaCruda, setTarifaCruda] = useState<unknown>(null); // para el modal\r\n  const [loadingTarifa, setLoadingTarifa] = useState(false);\r\n\r\n  const [saldo, setSaldo] = useState<{\r\n    disponible: number;\r\n    billetes?: number;\r\n    monedas_fisicas?: number;\r\n    estado: \"OK\" | \"SALDO_BAJO\" | \"ERROR\";\r\n    mensaje?: string;\r\n  } | null>(null);\r\n  const [loadingSaldo, setLoadingSaldo] = useState(false);\r\n\r\n  const [showTarifaModal, setShowTarifaModal] = useState(false);\r\n\r\n  /** C├ílculos de peso */\r\n  const pesoFisico = Number(medidas?.peso || 0);\r\n  const pesoVolumetrico = useMemo(\r\n    () => Number(tarifa?.peso_vol || calcPesoVol(medidas)),\r\n    [tarifa?.peso_vol, medidas]\r\n  );\r\n  const pesoFacturable = Math.max(pesoFisico, pesoVolumetrico);\r\n\r\n  /** Total mostrado (preferimos total_transacion > gtotal > suma simple) */\r\n  const total = useMemo(() => {\r\n    if (!tarifa) return 0;\r\n    if (tarifa.total_transacion && Number(tarifa.total_transacion) > 0) {\r\n      return Number(tarifa.total_transacion);\r\n    }\r\n    if (tarifa.gtotal && Number(tarifa.gtotal) > 0) {\r\n      return Number(tarifa.gtotal);\r\n    }\r\n    const flete = Number(tarifa.flete || 0);\r\n    const empaque = Number(tarifa.valor_empaque || 0);\r\n    const seguro = Number(tarifa.seguro || 0);\r\n    const iva = Number(tarifa.tiva || 0);\r\n    return flete + empaque + seguro + iva;\r\n  }, [tarifa]);\r\n\r\n  const saldoSuficiente = saldo ? saldo.disponible >= total : false;\r\n  const saldoBajo = saldo?.estado === \"SALDO_BAJO\";\r\n\r\n  /** Cargar saldo */\r\n  const obtenerSaldo = async () => {\r\n    if (!punto_atencion_id) return;\r\n    setLoadingSaldo(true);\r\n    try {\r\n      const { data } = await axiosInstance.get(\r\n        `/servientrega/saldo/${punto_atencion_id}`\r\n      );\r\n      const disponible = Number(data.disponible || 0);\r\n      const estado = disponible < UMBRAL_SALDO_BAJO ? \"SALDO_BAJO\" : \"OK\";\r\n      setSaldo({\r\n        disponible,\r\n        billetes: Number(data.billetes ?? 0),\r\n        monedas_fisicas: Number(data.monedas_fisicas ?? 0),\r\n        estado,\r\n        mensaje:\r\n          estado === \"SALDO_BAJO\"\r\n            ? \"Saldo bajo. Se recomienda solicitar m├ís saldo.\"\r\n            : undefined,\r\n      });\r\n    } catch (error) {\r\n      console.error(\"ÔØî Error al obtener saldo:\", error);\r\n      setSaldo({\r\n        disponible: 0,\r\n        billetes: 0,\r\n        monedas_fisicas: 0,\r\n        estado: \"ERROR\",\r\n        mensaje: \"Error al consultar el saldo\",\r\n      });\r\n    } finally {\r\n      setLoadingSaldo(false);\r\n    }\r\n  };\r\n\r\n  /** Cargar tarifa */\r\n  const fetchTarifa = async () => {\r\n    if (!remitente || !destinatario || !medidas) {\r\n      toast.error(\"Faltan datos para calcular la tarifa.\");\r\n      return;\r\n    }\r\n    setLoadingTarifa(true);\r\n    try {\r\n      const isInternacional =\r\n        (destinatario?.pais || \"ECUADOR\").toUpperCase() !== \"ECUADOR\";\r\n      const nombre_producto = mapProducto(formData?.nombre_producto);\r\n\r\n      // Tipo seg├║n doc: usamos \"obtener_tarifa_nacional\" incluso cuando haya pa├¡s destino distinto\r\n      const payload: Record<string, string> = {\r\n        tipo: \"obtener_tarifa_nacional\",\r\n        // Origen\r\n        ciu_ori: (remitente?.ciudad || \"\").toUpperCase(),\r\n        provincia_ori: (remitente?.provincia || \"\").toUpperCase(),\r\n        // Destino\r\n        ciu_des: (destinatario?.ciudad || \"\").toUpperCase(),\r\n        provincia_des: (destinatario?.provincia || \"\").toUpperCase(),\r\n        // Valores\r\n        valor_seguro: String(medidas?.valor_seguro ?? \"0\"),\r\n        valor_declarado: String(medidas?.valor_declarado ?? \"0\"),\r\n        peso: String(pesoFacturable),\r\n        alto: String(medidas?.alto ?? 0),\r\n        ancho: String(medidas?.ancho ?? 0),\r\n        largo: String(medidas?.largo ?? 0),\r\n        recoleccion: \"NO\",\r\n        nombre_producto, // \"DOCUMENTO UNITARIO\" | \"MERCANCIA PREMIER\"\r\n      };\r\n\r\n      // Solo agregar empaque si el usuario lo requiere\r\n      if (formData.requiere_empaque) {\r\n        payload.empaque = formData.empaque?.tipo_empaque || DEFAULT_EMPAQUE;\r\n      }\r\n\r\n      // Para ÔÇ£internacionalÔÇØ (doc usa mismo tipo pero a├▒adimos pa├¡s/c├│digos postales)\r\n      if (isInternacional) {\r\n        payload.pais_ori = remitente?.pais || \"ECUADOR\";\r\n        payload.pais_des = destinatario?.pais || \"ECUADOR\";\r\n        payload.codigo_postal_ori = remitente?.codigo_postal || DEFAULT_CP_ORI;\r\n        payload.codigo_postal_des =\r\n          destinatario?.codigo_postal || DEFAULT_CP_DES;\r\n      }\r\n\r\n      console.log(\"­ƒôñ Payload tarifa (PasoResumen):\", payload);\r\n      const res = await axiosInstance.post(\"/servientrega/tarifa\", payload);\r\n      const raw = Array.isArray(res.data) ? res.data[0] : res.data;\r\n      setTarifaCruda(raw);\r\n\r\n      if (!raw || raw.flete === undefined) {\r\n        console.error(\"ÔØî Respuesta inv├ílida de Servientrega:\", raw);\r\n        toast.error(\"No se pudo calcular la tarifa. Verifica los datos.\");\r\n        setTarifa(null);\r\n        return;\r\n      }\r\n\r\n      // Normalizaci├│n\r\n      const tarifaUI: TarifaResponseUI = {\r\n        flete: Number(raw.flete || 0),\r\n        valor_declarado: Number(raw.valor_declarado || 0),\r\n        valor_empaque: Number(raw.valor_empaque || 0),\r\n        seguro: Number(raw.prima || raw.seguro || 0),\r\n        tiempo: raw.tiempo || \"1-2 d├¡as h├íbiles\",\r\n        peso_vol: Number(raw.peso_vol || raw.volumen || calcPesoVol(medidas)),\r\n        descuento: Number(raw.descuento || 0),\r\n        tarifa0: Number(raw.tarifa0 || 0),\r\n        tarifa12: Number(raw.tarifa12 || 0),\r\n        tiva: Number(raw.tiva || 0),\r\n        gtotal: Number(raw.gtotal || 0),\r\n        total_transacion: Number(raw.total_transacion || 0),\r\n        trayecto: raw.trayecto || \"\",\r\n      };\r\n\r\n      setTarifa(tarifaUI);\r\n      toast.success(\"Tarifa calculada exitosamente.\");\r\n    } catch (err) {\r\n      console.error(\"ÔØî Error al obtener tarifa:\", err);\r\n      toast.error(\"Error al calcular la tarifa. Intenta nuevamente.\");\r\n      setTarifa(null);\r\n    } finally {\r\n      setLoadingTarifa(false);\r\n    }\r\n  };\r\n\r\n  /** Validar saldo antes de confirmar */\r\n  const validarSaldoAntesConfirmar = async () => {\r\n    if (!punto_atencion_id) {\r\n      toast.error(\"No se ha identificado el punto de atenci├│n.\");\r\n      return;\r\n    }\r\n    if (!tarifa) {\r\n      toast.error(\"A├║n no se ha calculado la tarifa.\");\r\n      return;\r\n    }\r\n\r\n    // Calcular el monto total de la transacci├│n\r\n    const montoTotal = tarifa.total_transacion || tarifa.gtotal || 0;\r\n\r\n    try {\r\n      const { data } = await axiosInstance.get(\r\n        `/servientrega/saldo/validar/${punto_atencion_id}?monto=${montoTotal}`\r\n      );\r\n\r\n      console.log(\"­ƒöì Validaci├│n de saldo:\", data);\r\n\r\n      if (data?.estado === \"OK\") {\r\n        if (tarifa) {\r\n          onConfirm(tarifa);\r\n        }\r\n      } else {\r\n        // Mostrar mensaje espec├¡fico seg├║n el estado\r\n        let mensaje =\r\n          data?.mensaje || \"Saldo insuficiente para generar esta gu├¡a.\";\r\n\r\n        if (data?.estado === \"SIN_SALDO\") {\r\n          mensaje =\r\n            \"No hay saldo asignado para este punto de atenci├│n. Contacte al administrador.\";\r\n        } else if (data?.estado === \"SALDO_AGOTADO\") {\r\n          mensaje = \"El saldo disponible se ha agotado. Solicite una recarga.\";\r\n        } else if (data?.estado === \"SALDO_INSUFICIENTE\") {\r\n          mensaje = `Saldo insuficiente. Disponible: $${data.disponible?.toFixed(\r\n            2\r\n          )}, Requerido: $${montoTotal.toFixed(2)}`;\r\n        }\r\n\r\n        toast.error(mensaje);\r\n      }\r\n    } catch (err) {\r\n      console.error(\"Error al validar saldo:\", err);\r\n      toast.error(\"No se pudo validar el saldo disponible.\");\r\n    }\r\n  };\r\n\r\n  /** Efectos iniciales */\r\n  useEffect(() => {\r\n    fetchTarifa();\r\n    obtenerSaldo();\r\n    // eslint-disable-next-line react-hooks/exhaustive-deps\r\n  }, [formData]);\r\n\r\n  return (\r\n    <Card className=\"w-full max-w-5xl mx-auto mt-4 sm:mt-6 shadow-lg border rounded-xl\">\r\n      <CardHeader>\r\n        <CardTitle className=\"text-xl\">Resumen de la Gu├¡a</CardTitle>\r\n      </CardHeader>\r\n      <CardContent className=\"space-y-6\">\r\n        {/* Panel de saldo */}\r\n        <Card\r\n          className={`${\r\n            saldoBajo\r\n              ? \"border-yellow-300 bg-yellow-50\"\r\n              : saldo?.estado === \"ERROR\"\r\n              ? \"border-red-300 bg-red-50\"\r\n              : \"border-green-300 bg-green-50\"\r\n          }`}\r\n        >\r\n          <CardHeader className=\"pb-3\">\r\n            <CardTitle className=\"flex items-center justify-between text-lg\">\r\n              <div className=\"flex items-center gap-2\">\r\n                <Wallet\r\n                  className={`h-5 w-5 ${\r\n                    saldoBajo\r\n                      ? \"text-yellow-600\"\r\n                      : saldo?.estado === \"ERROR\"\r\n                      ? \"text-red-600\"\r\n                      : \"text-green-600\"\r\n                  }`}\r\n                />\r\n                <span>Saldo Disponible</span>\r\n              </div>\r\n              {loadingSaldo && <Loader2 className=\"h-4 w-4 animate-spin\" />}\r\n            </CardTitle>\r\n          </CardHeader>\r\n          <CardContent>\r\n            <div className=\"flex justify-between items-center\">\r\n              <div>\r\n                <div\r\n                  className={`text-2xl font-bold ${\r\n                    saldoBajo\r\n                      ? \"text-yellow-600\"\r\n                      : saldo?.estado === \"ERROR\"\r\n                      ? \"text-red-600\"\r\n                      : \"text-green-600\"\r\n                  }`}\r\n                >\r\n                  ${saldo?.disponible?.toFixed(2) || \"0.00\"}\r\n                </div>\r\n                {saldo?.billetes !== undefined && saldo?.monedas_fisicas !== undefined && (\r\n                  <div className=\"flex flex-col mt-2 text-xs text-gray-700\">\r\n                    <div>\r\n                      <span className=\"font-semibold\">Billetes:</span> ${saldo.billetes?.toFixed(2)}\r\n                    </div>\r\n                    <div>\r\n                      <span className=\"font-semibold\">Monedas:</span> ${saldo.monedas_fisicas?.toFixed(2)}\r\n                    </div>\r\n                  </div>\r\n                )}\r\n                {saldo?.mensaje && (\r\n                  <p\r\n                    className={`text-sm ${\r\n                      saldoBajo ? \"text-yellow-600\" : \"text-red-600\"\r\n                    }`}\r\n                  >\r\n                    {saldo.mensaje}\r\n                  </p>\r\n                )}\r\n              </div>\r\n              <div className=\"text-right\">\r\n                <p className=\"text-sm text-gray-600\">Costo estimado:</p>\r\n                <p\r\n                  className={`text-lg font-semibold ${\r\n                    saldoSuficiente ? \"text-green-600\" : \"text-red-600\"\r\n                  }`}\r\n                >\r\n                  ${total.toFixed(2)}\r\n                </p>\r\n                {!saldoSuficiente && total > 0 && (\r\n                  <p className=\"text-xs text-red-600 flex items-center gap-1\">\r\n                    <AlertTriangle className=\"h-3 w-3\" />\r\n                    Saldo insuficiente\r\n                  </p>\r\n                )}\r\n              </div>\r\n            </div>\r\n          </CardContent>\r\n        </Card>\r\n\r\n        {/* Producto */}\r\n        <Seccion titulo=\"­ƒôª Producto\">\r\n          <Campo\r\n            label=\"Nombre del producto\"\r\n            value={mapProducto(formData?.nombre_producto)}\r\n          />\r\n          <Campo\r\n            label=\"Contenido\"\r\n            value={\r\n              formData?.contenido || mapProducto(formData?.nombre_producto)\r\n            }\r\n          />\r\n        </Seccion>\r\n\r\n        {/* Remitente */}\r\n        <Seccion titulo=\"­ƒºì Remitente\">\r\n          <Campo label=\"Nombre\" value={remitente?.nombre} />\r\n          <Campo label=\"C├®dula\" value={remitente?.identificacion} />\r\n          <Campo\r\n            label=\"Ciudad\"\r\n            value={`${remitente?.ciudad} - ${remitente?.provincia}`}\r\n          />\r\n          <Campo label=\"Tel├®fono\" value={remitente?.telefono} />\r\n          <Campo label=\"Email\" value={remitente?.email} />\r\n          <Campo label=\"Direcci├│n\" value={remitente?.direccion} />\r\n        </Seccion>\r\n\r\n        {/* Destinatario */}\r\n        <Seccion titulo=\"­ƒÄ» Destinatario\">\r\n          <Campo label=\"Nombre\" value={destinatario?.nombre} />\r\n          <Campo label=\"C├®dula\" value={destinatario?.identificacion} />\r\n          <Campo\r\n            label=\"Ciudad\"\r\n            value={`${destinatario?.ciudad} - ${destinatario?.provincia}`}\r\n          />\r\n          <Campo label=\"Tel├®fono\" value={destinatario?.telefono} />\r\n          <Campo label=\"Pa├¡s\" value={destinatario?.pais} />\r\n          <Campo label=\"Direcci├│n\" value={destinatario?.direccion} />\r\n        </Seccion>\r\n\r\n        {/* Medidas */}\r\n        <Seccion titulo=\"­ƒôÉ Medidas y valores\">\r\n          <Campo\r\n            label=\"Valor declarado\"\r\n            value={`$${Number(medidas?.valor_declarado || 0).toFixed(2)}`}\r\n          />\r\n          <Campo\r\n            label=\"Valor asegurado\"\r\n            value={`$${Number(medidas?.valor_seguro || 0).toFixed(2)}`}\r\n          />\r\n          <Campo label=\"Peso f├¡sico (kg)\" value={pesoFisico} />\r\n          <Campo\r\n            label=\"Peso volum├®trico (kg)\"\r\n            value={pesoVolumetrico.toFixed(2)}\r\n          />\r\n          <Campo\r\n            label=\"Peso facturable (kg)\"\r\n            value={pesoFacturable.toFixed(2)}\r\n            highlight={\r\n              pesoFacturable === pesoVolumetrico && pesoVolumetrico > pesoFisico\r\n            }\r\n          />\r\n          <Campo\r\n            label=\"Medidas (cm)\"\r\n            value={`${medidas?.alto} x ${medidas?.ancho} x ${medidas?.largo}`}\r\n          />\r\n        </Seccion>\r\n\r\n        {/* Costos */}\r\n        <div>\r\n          <h3 className=\"font-semibold text-gray-800 mb-2 flex items-center gap-2\">\r\n            <Calculator className=\"h-5 w-5\" />\r\n            Costos\r\n          </h3>\r\n\r\n          {tarifa ? (\r\n            <div className=\"bg-blue-50 p-4 rounded-lg space-y-2\">\r\n              <div className=\"flex justify-between text-sm\">\r\n                <span>Flete:</span>\r\n                <span>${Number(tarifa.flete || 0).toFixed(2)}</span>\r\n              </div>\r\n              <div className=\"flex justify-between text-sm\">\r\n                <span>Empaque:</span>\r\n                <span>${Number(tarifa.valor_empaque || 0).toFixed(2)}</span>\r\n              </div>\r\n              {(tarifa.seguro || 0) > 0 && (\r\n                <div className=\"flex justify-between text-sm\">\r\n                  <span>Seguro:</span>\r\n                  <span>${Number(tarifa.seguro).toFixed(2)}</span>\r\n                </div>\r\n              )}\r\n              {(tarifa.tiva || 0) > 0 && (\r\n                <div className=\"flex justify-between text-sm\">\r\n                  <span>IVA:</span>\r\n                  <span>${Number(tarifa.tiva).toFixed(2)}</span>\r\n                </div>\r\n              )}\r\n              {(tarifa.descuento || 0) > 0 && (\r\n                <div className=\"flex justify-between text-sm text-green-600\">\r\n                  <span>Descuento:</span>\r\n                  <span>- ${Number(tarifa.descuento).toFixed(2)}</span>\r\n                </div>\r\n              )}\r\n              <Separator />\r\n              <div className=\"flex justify-between items-center\">\r\n                <div className=\"flex justify-between font-semibold text-lg w-full\">\r\n                  <span>Total:</span>\r\n                  <span className=\"text-blue-600\">${total.toFixed(2)}</span>\r\n                </div>\r\n              </div>\r\n\r\n              {/* Ver detalle crudo de Servientrega */}\r\n              {tarifaCruda && (\r\n                <div className=\"flex justify-end mt-2\">\r\n                  <Button\r\n                    variant=\"outline\"\r\n                    size=\"sm\"\r\n                    onClick={() => setShowTarifaModal(true)}\r\n                  >\r\n                    Ver detalles completos\r\n                  </Button>\r\n                </div>\r\n              )}\r\n\r\n              {/* Info adicional */}\r\n              <div className=\"mt-3 pt-2 border-t border-blue-200 text-center text-xs text-gray-500\">\r\n                {tarifa.peso_vol && (\r\n                  <div>\r\n                    Peso volum├®trico: {Number(tarifa.peso_vol).toFixed(2)} kg\r\n                  </div>\r\n                )}\r\n                {tarifa.tiempo && <div>Tiempo estimado: {tarifa.tiempo}</div>}\r\n                {tarifa.trayecto && <div>Trayecto: {tarifa.trayecto}</div>}\r\n              </div>\r\n            </div>\r\n          ) : (\r\n            <div className=\"bg-gray-50 p-4 rounded-lg text-center\">\r\n              <div className=\"text-gray-500 mb-2\">\r\n                {loadingTarifa ? (\r\n                  <>\r\n                    <Loader2 className=\"h-4 w-4 animate-spin mx-auto mb-2\" />\r\n                    Calculando tarifa...\r\n                  </>\r\n                ) : (\r\n                  \"Calculando costos...\"\r\n                )}\r\n              </div>\r\n              {!loadingTarifa && (\r\n                <div className=\"space-y-2\">\r\n                  <Button\r\n                    onClick={fetchTarifa}\r\n                    size=\"sm\"\r\n                    className=\"bg-blue-600 hover:bg-blue-700 text-white w-full\"\r\n                  >\r\n                    <Calculator className=\"h-4 w-4 mr-2\" />\r\n                    Recalcular tarifa\r\n                  </Button>\r\n                  <div className=\"text-xs text-gray-500\">\r\n                    Los costos se calcular├ín autom├íticamente\r\n                  </div>\r\n                </div>\r\n              )}\r\n            </div>\r\n          )}\r\n        </div>\r\n\r\n        {/* Acciones */}\r\n        <div className=\"flex justify-between mt-6\">\r\n          <Button variant=\"outline\" onClick={onBack}>\r\n            ÔåÉ Atr├ís\r\n          </Button>\r\n          <Button\r\n            onClick={validarSaldoAntesConfirmar}\r\n            className=\"bg-green-600 text-white hover:bg-green-700\"\r\n            disabled={loadingTarifa || !tarifa}\r\n          >\r\n            Confirmar y continuar\r\n          </Button>\r\n        </div>\r\n      </CardContent>\r\n\r\n      {/* Modal detalle crudo (usa tu componente existente) */}\r\n      <TarifaModal\r\n        isOpen={showTarifaModal}\r\n        onClose={() => setShowTarifaModal(false)}\r\n        tarifa={tarifaCruda}\r\n        onConfirm={() => setShowTarifaModal(false)}\r\n        loading={false}\r\n        saldoDisponible={saldo?.disponible}\r\n        puntoAtencionNombre={String(punto_atencion_id ?? \"\")}\r\n      />\r\n    </Card>\r\n  );\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\oswal\\OneDrive\\Documentos\\Punto Cambio\\punto_cambio_new\\src\\components\\servientrega\\SaldoCompacto.tsx","messages":[{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'error' is defined but never used.","line":76,"column":14,"nodeType":null,"messageId":"unusedVar","endLine":76,"endColumn":19},{"ruleId":"react-hooks/exhaustive-deps","severity":1,"message":"React Hook useEffect has a missing dependency: 'obtenerSaldo'. Either include it or remove the dependency array.","line":83,"column":6,"nodeType":"ArrayExpression","endLine":83,"endColumn":23,"suggestions":[{"desc":"Update the dependencies array to be: [obtenerSaldo, puntoAtencionId]","fix":{"range":[2128,2145],"text":"[obtenerSaldo, puntoAtencionId]"}}]}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":2,"fixableErrorCount":0,"fixableWarningCount":0,"source":"\"use client\";\r\n\r\nimport React, { useState, useEffect } from \"react\";\r\nimport axiosInstance from \"@/services/axiosInstance\";\r\nimport { Button } from \"@/components/ui/button\";\r\nimport {\r\n  Wallet,\r\n  AlertTriangle,\r\n  RefreshCw,\r\n  CheckCircle,\r\n  XCircle,\r\n  Send,\r\n} from \"lucide-react\";\r\nimport { toast } from \"sonner\";\r\n\r\ninterface SaldoCompactoProps {\r\n  puntoAtencionId: string;\r\n  showSolicitar?: boolean;\r\n}\r\n\r\ninterface SaldoInfo {\r\n  disponible: number;\r\n  estado: \"OK\" | \"SALDO_BAJO\" | \"ERROR\";\r\n  mensaje?: string;\r\n}\r\n\r\nconst UMBRAL_SALDO_BAJO = 2.0;\r\n\r\nexport default function SaldoCompacto({\r\n  puntoAtencionId,\r\n  showSolicitar = true,\r\n}: SaldoCompactoProps) {\r\n  const [saldo, setSaldo] = useState<SaldoInfo | null>(null);\r\n  const [loading, setLoading] = useState(false);\r\n\r\n  // Ô£à Obtener saldo disponible\r\n  const obtenerSaldo = async () => {\r\n    if (!puntoAtencionId) return;\r\n\r\n    setLoading(true);\r\n    try {\r\n      const { data } = await axiosInstance.get(\r\n        `/servientrega/saldo/${puntoAtencionId}`\r\n      );\r\n\r\n      const disponible = Number(data.disponible || 0);\r\n      const estado = disponible < UMBRAL_SALDO_BAJO ? \"SALDO_BAJO\" : \"OK\";\r\n\r\n      setSaldo({\r\n        disponible,\r\n        estado,\r\n        mensaje: estado === \"SALDO_BAJO\" ? `Saldo bajo` : undefined,\r\n      });\r\n    } catch (error) {\r\n      console.error(\"ÔØî Error al obtener saldo:\", error);\r\n      setSaldo({\r\n        disponible: 0,\r\n        estado: \"ERROR\",\r\n        mensaje: \"Error al consultar saldo\",\r\n      });\r\n    } finally {\r\n      setLoading(false);\r\n    }\r\n  };\r\n\r\n  // Ô£à Solicitar saldo r├ípido\r\n  const solicitarSaldoRapido = async () => {\r\n    try {\r\n      await axiosInstance.post(\"/servientrega/solicitar-saldo\", {\r\n        punto_atencion_id: puntoAtencionId,\r\n        monto_solicitado: 50, // Monto por defecto\r\n        observaciones: \"Solicitud r├ípida desde listado de gu├¡as\",\r\n        creado_por: \"Operador\",\r\n      });\r\n      toast.success(\"Solicitud de saldo enviada\");\r\n    } catch (error) {\r\n      toast.error(\"Error al solicitar saldo\");\r\n    }\r\n  };\r\n\r\n  useEffect(() => {\r\n    obtenerSaldo();\r\n  }, [puntoAtencionId]);\r\n\r\n  if (!saldo) return null;\r\n\r\n  const getSaldoColor = () => {\r\n    switch (saldo.estado) {\r\n      case \"OK\":\r\n        return \"text-green-600\";\r\n      case \"SALDO_BAJO\":\r\n        return \"text-yellow-600\";\r\n      case \"ERROR\":\r\n        return \"text-red-600\";\r\n      default:\r\n        return \"text-gray-500\";\r\n    }\r\n  };\r\n\r\n  const getSaldoIcon = () => {\r\n    switch (saldo.estado) {\r\n      case \"OK\":\r\n        return CheckCircle;\r\n      case \"SALDO_BAJO\":\r\n        return AlertTriangle;\r\n      case \"ERROR\":\r\n        return XCircle;\r\n      default:\r\n        return Wallet;\r\n    }\r\n  };\r\n\r\n  const IconComponent = getSaldoIcon();\r\n  const colorClass = getSaldoColor();\r\n  const saldoBajo = saldo.estado === \"SALDO_BAJO\";\r\n  const sinSaldo = saldo.disponible === 0;\r\n\r\n  return (\r\n    <div\r\n      className={`flex items-center justify-between p-3 rounded-lg border-2 ${\r\n        saldoBajo\r\n          ? \"bg-yellow-50 border-yellow-200\"\r\n          : saldo.estado === \"ERROR\"\r\n          ? \"bg-red-50 border-red-200\"\r\n          : \"bg-green-50 border-green-200\"\r\n      }`}\r\n    >\r\n      <div className=\"flex items-center gap-3\">\r\n        <IconComponent className={`h-5 w-5 ${colorClass}`} />\r\n        <div>\r\n          <div className={`font-semibold ${colorClass}`}>\r\n            ${saldo.disponible.toFixed(2)}\r\n          </div>\r\n          <div className=\"text-xs text-gray-600\">Saldo disponible</div>\r\n        </div>\r\n      </div>\r\n\r\n      <div className=\"flex items-center gap-2\">\r\n        {saldo.mensaje && (\r\n          <span className={`text-xs ${colorClass}`}>{saldo.mensaje}</span>\r\n        )}\r\n\r\n        <Button\r\n          variant=\"ghost\"\r\n          size=\"sm\"\r\n          onClick={obtenerSaldo}\r\n          disabled={loading}\r\n          className=\"h-8 w-8 p-0\"\r\n        >\r\n          <RefreshCw className={`h-4 w-4 ${loading ? \"animate-spin\" : \"\"}`} />\r\n        </Button>\r\n\r\n        {showSolicitar && (saldoBajo || sinSaldo) && (\r\n          <Button\r\n            variant=\"outline\"\r\n            size=\"sm\"\r\n            onClick={solicitarSaldoRapido}\r\n            className=\"text-xs px-2 py-1 h-8\"\r\n          >\r\n            <Send className=\"h-3 w-3 mr-1\" />\r\n            Solicitar\r\n          </Button>\r\n        )}\r\n      </div>\r\n    </div>\r\n  );\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\oswal\\OneDrive\\Documentos\\Punto Cambio\\punto_cambio_new\\src\\components\\servientrega\\SaldoOperador.tsx","messages":[{"ruleId":"no-console","severity":1,"message":"Unexpected console statement. Only these console methods are allowed: warn, error.","line":80,"column":7,"nodeType":"MemberExpression","messageId":"limited","endLine":80,"endColumn":18,"suggestions":[{"fix":{"range":[2295,2353],"text":""},"messageId":"removeConsole","data":{"propertyName":"log"},"desc":"Remove the console.log()."}]},{"ruleId":"react-hooks/exhaustive-deps","severity":1,"message":"React Hook useEffect has a missing dependency: 'obtenerSaldo'. Either include it or remove the dependency array.","line":130,"column":6,"nodeType":"ArrayExpression","endLine":130,"endColumn":23,"suggestions":[{"desc":"Update the dependencies array to be: [obtenerSaldo, puntoAtencionId]","fix":{"range":[3797,3814],"text":"[obtenerSaldo, puntoAtencionId]"}}]}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":2,"fixableErrorCount":0,"fixableWarningCount":0,"source":"\"use client\";\r\n\r\nimport React, { useState, useEffect } from \"react\";\r\nimport axiosInstance from \"@/services/axiosInstance\";\r\nimport { Card, CardHeader, CardTitle, CardContent } from \"@/components/ui/card\";\r\nimport { Button } from \"@/components/ui/button\";\r\nimport { Input } from \"@/components/ui/input\";\r\nimport { Label } from \"@/components/ui/label\";\r\nimport { Textarea } from \"@/components/ui/textarea\";\r\nimport {\r\n  Wallet,\r\n  AlertTriangle,\r\n  Send,\r\n  RefreshCw,\r\n  CheckCircle,\r\n  XCircle,\r\n} from \"lucide-react\";\r\nimport { toast } from \"sonner\";\r\nimport {\r\n  AlertDialog,\r\n  AlertDialogAction,\r\n  AlertDialogCancel,\r\n  AlertDialogContent,\r\n  AlertDialogDescription,\r\n  AlertDialogFooter,\r\n  AlertDialogHeader,\r\n  AlertDialogTitle,\r\n} from \"@/components/ui/alert-dialog\";\r\n\r\ninterface SaldoOperadorProps {\r\n  puntoAtencionId: string;\r\n  puntoAtencionNombre: string;\r\n}\r\n\r\ninterface SaldoInfo {\r\n  disponible: number;\r\n  billetes?: number;\r\n  monedas_fisicas?: number;\r\n  estado: \"OK\" | \"SALDO_BAJO\" | \"ERROR\";\r\n  mensaje?: string;\r\n}\r\n\r\nconst UMBRAL_SALDO_BAJO = 2.0; // $2.00\r\n\r\nexport default function SaldoOperador({\r\n  puntoAtencionId,\r\n  puntoAtencionNombre,\r\n}: SaldoOperadorProps) {\r\n  const [saldo, setSaldo] = useState<SaldoInfo | null>(null);\r\n  const [loading, setLoading] = useState(false);\r\n  const [solicitudOpen, setSolicitudOpen] = useState(false);\r\n  const [montoSolicitado, setMontoSolicitado] = useState<string>(\"\");\r\n  const [observaciones, setObservaciones] = useState<string>(\"\");\r\n  const [enviandoSolicitud, setEnviandoSolicitud] = useState(false);\r\n\r\n  // Ô£à Obtener saldo disponible\r\n  const obtenerSaldo = async () => {\r\n    if (!puntoAtencionId) return;\r\n\r\n    setLoading(true);\r\n    try {\r\n      const { data } = await axiosInstance.get(\r\n        `/servientrega/saldo/${puntoAtencionId}`\r\n      );\r\n\r\n      const disponible = Number(data.disponible || 0);\r\n      const estado = disponible < UMBRAL_SALDO_BAJO ? \"SALDO_BAJO\" : \"OK\";\r\n\r\n      setSaldo({\r\n        disponible,\r\n        billetes: Number(data.billetes ?? 0),\r\n        monedas_fisicas: Number(data.monedas_fisicas ?? 0),\r\n        estado,\r\n        mensaje:\r\n          estado === \"SALDO_BAJO\"\r\n            ? `Saldo bajo. Se recomienda solicitar m├ís saldo.`\r\n            : undefined,\r\n      });\r\n\r\n      console.log(\"­ƒÆ░ Saldo obtenido:\", { disponible, estado });\r\n    } catch (error) {\r\n      console.error(\"ÔØî Error al obtener saldo:\", error);\r\n      setSaldo({\r\n        disponible: 0,\r\n        billetes: 0,\r\n        monedas_fisicas: 0,\r\n        estado: \"ERROR\",\r\n        mensaje: \"Error al consultar el saldo\",\r\n      });\r\n      toast.error(\"Error al consultar el saldo\");\r\n    } finally {\r\n      setLoading(false);\r\n    }\r\n  };\r\n\r\n  // Ô£à Solicitar saldo al administrador\r\n  const solicitarSaldo = async () => {\r\n    if (!montoSolicitado || Number(montoSolicitado) <= 0) {\r\n      toast.error(\"Ingresa un monto v├ílido\");\r\n      return;\r\n    }\r\n\r\n    setEnviandoSolicitud(true);\r\n    try {\r\n      await axiosInstance.post(\"/servientrega/solicitar-saldo\", {\r\n        punto_atencion_id: puntoAtencionId,\r\n        monto_solicitado: Number(montoSolicitado),\r\n        observaciones: observaciones.trim() || \"\",\r\n        creado_por: \"Operador\",\r\n      });\r\n\r\n      toast.success(\"Solicitud de saldo enviada al administrador\");\r\n      setSolicitudOpen(false);\r\n      setMontoSolicitado(\"\");\r\n      setObservaciones(\"\");\r\n\r\n      // Actualizar saldo despu├®s de solicitar\r\n      setTimeout(obtenerSaldo, 1000);\r\n    } catch (error) {\r\n      console.error(\"ÔØî Error al solicitar saldo:\", error);\r\n      toast.error(\"Error al enviar la solicitud de saldo\");\r\n    } finally {\r\n      setEnviandoSolicitud(false);\r\n    }\r\n  };\r\n\r\n  // Ô£à Cargar saldo al montar el componente\r\n  useEffect(() => {\r\n    obtenerSaldo();\r\n  }, [puntoAtencionId]);\r\n\r\n  // Ô£à Determinar color y icono seg├║n el estado del saldo\r\n  const getSaldoDisplay = () => {\r\n    if (!saldo)\r\n      return { color: \"text-gray-500\", icon: Wallet, bg: \"bg-gray-50\" };\r\n\r\n    switch (saldo.estado) {\r\n      case \"OK\":\r\n        return {\r\n          color: \"text-green-600\",\r\n          icon: CheckCircle,\r\n          bg: \"bg-green-50 border-green-200\",\r\n        };\r\n      case \"SALDO_BAJO\":\r\n        return {\r\n          color: \"text-yellow-600\",\r\n          icon: AlertTriangle,\r\n          bg: \"bg-yellow-50 border-yellow-200\",\r\n        };\r\n      case \"ERROR\":\r\n        return {\r\n          color: \"text-red-600\",\r\n          icon: XCircle,\r\n          bg: \"bg-red-50 border-red-200\",\r\n        };\r\n      default:\r\n        return { color: \"text-gray-500\", icon: Wallet, bg: \"bg-gray-50\" };\r\n    }\r\n  };\r\n\r\n  const { color, icon: IconComponent, bg } = getSaldoDisplay();\r\n  const saldoBajo = saldo?.estado === \"SALDO_BAJO\";\r\n  const sinSaldo = saldo?.disponible === 0;\r\n\r\n  return (\r\n    <>\r\n      <Card className={`w-full ${bg} border-2`}>\r\n        <CardHeader className=\"pb-3\">\r\n          <CardTitle className=\"flex items-center justify-between text-lg\">\r\n            <div className=\"flex items-center gap-2\">\r\n              <IconComponent className={`h-5 w-5 ${color}`} />\r\n              <span>Saldo Disponible</span>\r\n            </div>\r\n            <Button\r\n              variant=\"ghost\"\r\n              size=\"sm\"\r\n              onClick={obtenerSaldo}\r\n              disabled={loading}\r\n              className=\"h-8 w-8 p-0\"\r\n            >\r\n              <RefreshCw\r\n                className={`h-4 w-4 ${loading ? \"animate-spin\" : \"\"}`}\r\n              />\r\n            </Button>\r\n          </CardTitle>\r\n        </CardHeader>\r\n        <CardContent className=\"space-y-4\">\r\n          {/* Informaci├│n del saldo */}\r\n          <div className=\"text-center\">\r\n            <div className={`text-3xl font-bold ${color}`}>\r\n              {loading ? \"...\" : `$${saldo?.disponible?.toFixed(2) || \"0.00\"}`}\r\n            </div>\r\n            <p className=\"text-sm text-gray-600 mt-1\">{puntoAtencionNombre}</p>\r\n            {saldo?.mensaje && (\r\n              <p className={`text-sm mt-2 ${color}`}>{saldo.mensaje}</p>\r\n            )}\r\n          </div>\r\n          {saldo?.billetes !== undefined && saldo?.monedas_fisicas !== undefined && (\r\n            <div className=\"flex flex-col items-center mt-2 text-xs text-gray-700\">\r\n              <div>\r\n                <span className=\"font-semibold\">Billetes:</span> ${saldo.billetes?.toFixed(2)}\r\n              </div>\r\n              <div>\r\n                <span className=\"font-semibold\">Monedas:</span> ${saldo.monedas_fisicas?.toFixed(2)}\r\n              </div>\r\n            </div>\r\n          )}\r\n\r\n          {/* Alertas y acciones */}\r\n          {sinSaldo && (\r\n            <div className=\"bg-red-100 border border-red-300 rounded-lg p-3 text-center\">\r\n              <p className=\"text-red-700 font-medium text-sm\">\r\n                ÔÜá´©Å Sin saldo disponible\r\n              </p>\r\n              <p className=\"text-red-600 text-xs mt-1\">\r\n                No puedes generar gu├¡as sin saldo\r\n              </p>\r\n            </div>\r\n          )}\r\n\r\n          {saldoBajo && !sinSaldo && (\r\n            <div className=\"bg-yellow-100 border border-yellow-300 rounded-lg p-3 text-center\">\r\n              <p className=\"text-yellow-700 font-medium text-sm\">\r\n                ÔÜá´©Å Saldo bajo\r\n              </p>\r\n              <p className=\"text-yellow-600 text-xs mt-1\">\r\n                Se recomienda solicitar m├ís saldo\r\n              </p>\r\n            </div>\r\n          )}\r\n\r\n          {/* Bot├│n para solicitar saldo */}\r\n          {(saldoBajo || sinSaldo) && (\r\n            <Button\r\n              onClick={() => setSolicitudOpen(true)}\r\n              className=\"w-full bg-blue-600 hover:bg-blue-700 text-white\"\r\n              disabled={enviandoSolicitud}\r\n            >\r\n              <Send className=\"mr-2 h-4 w-4\" />\r\n              Solicitar Saldo\r\n            </Button>\r\n          )}\r\n        </CardContent>\r\n      </Card>\r\n\r\n      {/* Modal para solicitar saldo */}\r\n      <AlertDialog open={solicitudOpen} onOpenChange={setSolicitudOpen}>\r\n        <AlertDialogContent>\r\n          <AlertDialogHeader>\r\n            <AlertDialogTitle>Solicitar Saldo</AlertDialogTitle>\r\n            <AlertDialogDescription>\r\n              Env├¡a una solicitud al administrador para asignar m├ís saldo a tu\r\n              punto de atenci├│n.\r\n            </AlertDialogDescription>\r\n          </AlertDialogHeader>\r\n\r\n          <div className=\"space-y-4 py-4\">\r\n            <div className=\"space-y-2\">\r\n              <Label htmlFor=\"monto\">Monto a solicitar ($)</Label>\r\n              <Input\r\n                id=\"monto\"\r\n                type=\"number\"\r\n                min=\"1\"\r\n                step=\"0.01\"\r\n                placeholder=\"Ej: 100.00\"\r\n                value={montoSolicitado}\r\n                onChange={(e) => setMontoSolicitado(e.target.value)}\r\n              />\r\n            </div>\r\n\r\n            <div className=\"space-y-2\">\r\n              <Label htmlFor=\"observaciones\">Observaciones (opcional)</Label>\r\n              <Textarea\r\n                id=\"observaciones\"\r\n                placeholder=\"Motivo de la solicitud, urgencia, etc.\"\r\n                value={observaciones}\r\n                onChange={(e) => setObservaciones(e.target.value)}\r\n                rows={3}\r\n              />\r\n            </div>\r\n\r\n            <div className=\"bg-gray-50 p-3 rounded-lg text-sm\">\r\n              <p>\r\n                <strong>Punto:</strong> {puntoAtencionNombre}\r\n              </p>\r\n              <p>\r\n                <strong>Saldo actual:</strong> $\r\n                {saldo?.disponible?.toFixed(2) || \"0.00\"}\r\n              </p>\r\n            </div>\r\n          </div>\r\n\r\n          <AlertDialogFooter>\r\n            <AlertDialogCancel>Cancelar</AlertDialogCancel>\r\n            <AlertDialogAction\r\n              onClick={solicitarSaldo}\r\n              disabled={enviandoSolicitud || !montoSolicitado}\r\n              className=\"bg-blue-600 hover:bg-blue-700\"\r\n            >\r\n              {enviandoSolicitud ? (\r\n                <>\r\n                  <RefreshCw className=\"mr-2 h-4 w-4 animate-spin\" />\r\n                  Enviando...\r\n                </>\r\n              ) : (\r\n                <>\r\n                  <Send className=\"mr-2 h-4 w-4\" />\r\n                  Enviar Solicitud\r\n                </>\r\n              )}\r\n            </AlertDialogAction>\r\n          </AlertDialogFooter>\r\n        </AlertDialogContent>\r\n      </AlertDialog>\r\n    </>\r\n  );\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\oswal\\OneDrive\\Documentos\\Punto Cambio\\punto_cambio_new\\src\\components\\servientrega\\ServientregaMain.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\oswal\\OneDrive\\Documentos\\Punto Cambio\\punto_cambio_new\\src\\components\\servientrega\\TarifaModal.tsx","messages":[],"suppressedMessages":[{"ruleId":"react-hooks/exhaustive-deps","severity":1,"message":"React Hook useEffect has a missing dependency: 'paNombre'. Either include it or remove the dependency array.","line":178,"column":6,"nodeType":"ArrayExpression","endLine":178,"endColumn":31,"suggestions":[{"desc":"Update the dependencies array to be: [isOpen, paNombre, puntoAtencionId]","fix":{"range":[4826,4851],"text":"[isOpen, paNombre, puntoAtencionId]"}}],"suppressions":[{"kind":"directive","justification":""}]}],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\oswal\\OneDrive\\Documentos\\Punto Cambio\\punto_cambio_new\\src\\components\\timeTracking\\AdminTimeManagement.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\oswal\\OneDrive\\Documentos\\Punto Cambio\\punto_cambio_new\\src\\components\\timeTracking\\AutoTimeTracker.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\oswal\\OneDrive\\Documentos\\Punto Cambio\\punto_cambio_new\\src\\components\\timeTracking\\OperatorTimeManagement.tsx","messages":[{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'SpontaneousExit' is defined but never used. Allowed unused vars must match /^_/u.","line":10,"column":3,"nodeType":null,"messageId":"unusedVar","endLine":10,"endColumn":18},{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'e' is defined but never used.","line":124,"column":14,"nodeType":null,"messageId":"unusedVar","endLine":124,"endColumn":15}],"suppressedMessages":[{"ruleId":"react-hooks/exhaustive-deps","severity":1,"message":"React Hook useEffect has a missing dependency: 'loadSchedulesHistory'. Either include it or remove the dependency array.","line":44,"column":6,"nodeType":"ArrayExpression","endLine":44,"endColumn":17,"suggestions":[{"desc":"Update the dependencies array to be: [activeTab, loadSchedulesHistory]","fix":{"range":[1519,1530],"text":"[activeTab, loadSchedulesHistory]"}}],"suppressions":[{"kind":"directive","justification":""}]}],"errorCount":0,"fatalErrorCount":0,"warningCount":2,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import { useState, useEffect } from \"react\";\r\nimport { Tabs, TabsContent, TabsList, TabsTrigger } from \"@/components/ui/tabs\";\r\nimport { User, PuntoAtencion, SalidaEspontanea } from \"../../types\";\r\nimport AutoTimeTracker from \"./AutoTimeTracker\";\r\nimport TimeTracker from \"./TimeTracker\";\r\nimport SpontaneousExitForm from \"./SpontaneousExitForm\";\r\nimport SpontaneousExitHistory from \"./SpontaneousExitHistory\";\r\nimport {\r\n  spontaneousExitService,\r\n  SpontaneousExit,\r\n} from \"../../services/spontaneousExitService\";\r\nimport { scheduleService, Schedule } from \"../../services/scheduleService\";\r\nimport { toast } from \"@/hooks/use-toast\";\r\n\r\ninterface OperatorTimeManagementProps {\r\n  user: User;\r\n  selectedPoint: PuntoAtencion | null;\r\n}\r\n\r\nconst OperatorTimeManagement = ({\r\n  user,\r\n  selectedPoint,\r\n}: OperatorTimeManagementProps) => {\r\n  const [spontaneousExits, setSpontaneousExits] = useState<SalidaEspontanea[]>(\r\n    []\r\n  );\r\n  const [isLoadingExits, setIsLoadingExits] = useState(true);\r\n  const [showExitForm, setShowExitForm] = useState(false);\r\n\r\n  // New state for schedules history\r\n  const [schedules, setSchedules] = useState<Schedule[]>([]);\r\n  const [isLoadingSchedules, setIsLoadingSchedules] = useState(false);\r\n  const [activeTab, setActiveTab] = useState(\"tracker\");\r\n\r\n  useEffect(() => {\r\n    loadSpontaneousExits();\r\n  }, []);\r\n\r\n  useEffect(() => {\r\n    if (activeTab === \"history\") {\r\n      loadSchedulesHistory();\r\n    }\r\n    // eslint-disable-next-line react-hooks/exhaustive-deps\r\n  }, [activeTab]);\r\n\r\n  const loadSpontaneousExits = async () => {\r\n    try {\r\n      setIsLoadingExits(true);\r\n      const { exits, error } = await spontaneousExitService.getAllExits();\r\n\r\n      if (error) {\r\n        toast({\r\n          title: \"Error\",\r\n          description: error,\r\n          variant: \"destructive\",\r\n        });\r\n      } else {\r\n        // Convertir SpontaneousExit a SalidaEspontanea\r\n        const convertedExits: SalidaEspontanea[] = exits.map((exit) => ({\r\n          id: exit.id,\r\n          usuario_id: exit.usuario_id,\r\n          punto_atencion_id: exit.punto_atencion_id,\r\n          motivo: exit.motivo,\r\n          descripcion: exit.descripcion,\r\n          fecha_salida: exit.fecha_salida,\r\n          fecha_regreso: exit.fecha_regreso,\r\n          ubicacion_salida: exit.ubicacion_salida,\r\n          ubicacion_regreso: exit.ubicacion_regreso,\r\n          duracion_minutos: exit.duracion_minutos,\r\n          aprobado_por: exit.aprobado_por,\r\n          created_at: exit.created_at,\r\n          updated_at: exit.updated_at,\r\n          estado: exit.estado,\r\n          usuario: {\r\n            id: exit.usuario?.id || \"\",\r\n            username: exit.usuario?.username || \"\",\r\n            nombre: exit.usuario?.nombre || \"\",\r\n            correo: \"\",\r\n            telefono: \"\",\r\n            rol: \"OPERADOR\" as const,\r\n            activo: true,\r\n            created_at: \"\",\r\n            updated_at: \"\",\r\n          },\r\n        }));\r\n        setSpontaneousExits(convertedExits);\r\n      }\r\n    } catch {\r\n      toast({\r\n        title: \"Error\",\r\n        description: \"Error al cargar las salidas espont├íneas\",\r\n        variant: \"destructive\",\r\n      });\r\n    } finally {\r\n      setIsLoadingExits(false);\r\n    }\r\n  };\r\n\r\n  const loadSchedulesHistory = async () => {\r\n    try {\r\n      setIsLoadingSchedules(true);\r\n      const to = new Date();\r\n      const from = new Date();\r\n      from.setDate(from.getDate() - 28);\r\n\r\n      const { schedules: result, error } =\r\n        await scheduleService.getAllSchedules({\r\n          usuario_id: user.id,\r\n          from: from.toISOString().slice(0, 10),\r\n          to: to.toISOString().slice(0, 10),\r\n          limit: 200,\r\n        });\r\n\r\n      if (error) {\r\n        setSchedules([]);\r\n        toast({\r\n          title: \"Error\",\r\n          description: \"No se pudo cargar el historial de jornadas.\",\r\n          variant: \"destructive\",\r\n        });\r\n      } else {\r\n        setSchedules(result);\r\n      }\r\n    } catch (e) {\r\n      setSchedules([]);\r\n      toast({\r\n        title: \"Error\",\r\n        description: \"Ocurri├│ un error al cargar las jornadas\",\r\n        variant: \"destructive\",\r\n      });\r\n    } finally {\r\n      setIsLoadingSchedules(false);\r\n    }\r\n  };\r\n\r\n  const handleExitRegistered = (exit: SalidaEspontanea) => {\r\n    setSpontaneousExits((prev) => [exit, ...prev]);\r\n    setShowExitForm(false);\r\n    toast({\r\n      title: \"Salida registrada\",\r\n      description: `Salida espont├ínea por ${exit.motivo\r\n        .toLowerCase()\r\n        .replace(\"_\", \" \")} registrada correctamente`,\r\n    });\r\n  };\r\n\r\n  const handleExitReturn = async (\r\n    exitId: string,\r\n    returnData: { lat: number; lng: number; direccion?: string }\r\n  ) => {\r\n    try {\r\n      const { exit: updatedExit, error } =\r\n        await spontaneousExitService.markReturn(exitId, {\r\n          ubicacion_regreso: returnData,\r\n        });\r\n\r\n      if (error) {\r\n        toast({\r\n          title: \"Error\",\r\n          description: error,\r\n          variant: \"destructive\",\r\n        });\r\n        return;\r\n      }\r\n\r\n      if (updatedExit) {\r\n        // Convertir el exit actualizado\r\n        const convertedExit: SalidaEspontanea = {\r\n          id: updatedExit.id,\r\n          usuario_id: updatedExit.usuario_id,\r\n          punto_atencion_id: updatedExit.punto_atencion_id,\r\n          motivo: updatedExit.motivo,\r\n          descripcion: updatedExit.descripcion,\r\n          fecha_salida: updatedExit.fecha_salida,\r\n          fecha_regreso: updatedExit.fecha_regreso,\r\n          ubicacion_salida: updatedExit.ubicacion_salida,\r\n          ubicacion_regreso: updatedExit.ubicacion_regreso,\r\n          duracion_minutos: updatedExit.duracion_minutos,\r\n          aprobado_por: updatedExit.aprobado_por,\r\n          created_at: updatedExit.created_at,\r\n          updated_at: updatedExit.updated_at,\r\n          estado: updatedExit.estado,\r\n          usuario: {\r\n            id: updatedExit.usuario?.id || \"\",\r\n            username: updatedExit.usuario?.username || \"\",\r\n            nombre: updatedExit.usuario?.nombre || \"\",\r\n            correo: \"\",\r\n            telefono: \"\",\r\n            rol: \"OPERADOR\" as const,\r\n            activo: true,\r\n            created_at: \"\",\r\n            updated_at: \"\",\r\n          },\r\n        };\r\n\r\n        setSpontaneousExits((prev) =>\r\n          prev.map((exit) => (exit.id === exitId ? convertedExit : exit))\r\n        );\r\n\r\n        toast({\r\n          title: \"Regreso registrado\",\r\n          description: \"Se ha registrado el regreso de la salida espont├ínea\",\r\n        });\r\n      }\r\n    } catch {\r\n      toast({\r\n        title: \"Error\",\r\n        description: \"Error al registrar el regreso\",\r\n        variant: \"destructive\",\r\n      });\r\n    }\r\n  };\r\n\r\n  const toTime = (v?: string | null) =>\r\n    v\r\n      ? new Date(v).toLocaleTimeString(\"es-EC\", {\r\n          hour: \"2-digit\",\r\n          minute: \"2-digit\",\r\n        })\r\n      : \"-\";\r\n\r\n  return (\r\n    <div className=\"p-6\">\r\n      <div className=\"mb-6\">\r\n        <h1 className=\"text-2xl font-bold text-gray-800\">\r\n          Control de Horarios\r\n        </h1>\r\n        <p className=\"text-gray-600\">\r\n          Gestiona tu jornada laboral y salidas espont├íneas\r\n        </p>\r\n      </div>\r\n\r\n      <Tabs value={activeTab} onValueChange={setActiveTab} className=\"w-full\">\r\n        <TabsList className=\"grid w-full grid-cols-4\">\r\n          <TabsTrigger value=\"tracker\">Mi Jornada</TabsTrigger>\r\n          <TabsTrigger value=\"lunch\">Almuerzo</TabsTrigger>\r\n          <TabsTrigger value=\"spontaneous\">Salidas Espont├íneas</TabsTrigger>\r\n          <TabsTrigger value=\"history\">Mi Historial</TabsTrigger>\r\n        </TabsList>\r\n\r\n        <TabsContent value=\"tracker\">\r\n          <AutoTimeTracker user={user} selectedPoint={selectedPoint} />\r\n        </TabsContent>\r\n\r\n        <TabsContent value=\"lunch\">\r\n          <TimeTracker\r\n            user={user}\r\n            selectedPoint={selectedPoint}\r\n            spontaneousExits={spontaneousExits}\r\n          />\r\n        </TabsContent>\r\n\r\n        <TabsContent value=\"spontaneous\">\r\n          <div className=\"space-y-6\">\r\n            <button\r\n              onClick={() => setShowExitForm(true)}\r\n              className=\"mb-4 rounded bg-blue-600 px-4 py-2 text-white hover:bg-blue-700\"\r\n            >\r\n              Registrar Salida Espont├ínea\r\n            </button>\r\n\r\n            {showExitForm && (\r\n              <SpontaneousExitForm\r\n                user={user}\r\n                selectedPoint={selectedPoint}\r\n                onExitRegistered={handleExitRegistered}\r\n                onCancel={() => setShowExitForm(false)}\r\n              />\r\n            )}\r\n          </div>\r\n        </TabsContent>\r\n\r\n        <TabsContent value=\"history\">\r\n          <div className=\"space-y-6\">\r\n            <div>\r\n              <h2 className=\"font-semibold mb-2\">\r\n                Mis Jornadas (├║ltimos 28 d├¡as)\r\n              </h2>\r\n              {isLoadingSchedules ? (\r\n                <div className=\"text-center p-4 text-gray-400\">\r\n                  Cargando jornadas...\r\n                </div>\r\n              ) : schedules.length === 0 ? (\r\n                <div className=\"text-center p-4 text-gray-400\">\r\n                  No hay jornadas en el per├¡odo\r\n                </div>\r\n              ) : (\r\n                <div className=\"overflow-auto rounded border\">\r\n                  <table className=\"w-full text-sm\">\r\n                    <thead className=\"bg-gray-50\">\r\n                      <tr>\r\n                        <th className=\"px-3 py-2 text-left\">Fecha</th>\r\n                        <th className=\"px-3 py-2 text-left\">Inicio</th>\r\n                        <th className=\"px-3 py-2 text-left\">Almuerzo</th>\r\n                        <th className=\"px-3 py-2 text-left\">Regreso</th>\r\n                        <th className=\"px-3 py-2 text-left\">Salida</th>\r\n                        <th className=\"px-3 py-2 text-left\">Estado</th>\r\n                      </tr>\r\n                    </thead>\r\n                    <tbody>\r\n                      {schedules.map((s) => {\r\n                        const d = new Date(s.fecha_inicio);\r\n                        return (\r\n                          <tr key={s.id} className=\"border-t\">\r\n                            <td className=\"px-3 py-2\">\r\n                              {d.toLocaleDateString(\"es-EC\")}\r\n                            </td>\r\n                            <td className=\"px-3 py-2\">\r\n                              {toTime(s.fecha_inicio)}\r\n                            </td>\r\n                            <td className=\"px-3 py-2\">\r\n                              {toTime(s.fecha_almuerzo)}\r\n                            </td>\r\n                            <td className=\"px-3 py-2\">\r\n                              {toTime(s.fecha_regreso)}\r\n                            </td>\r\n                            <td className=\"px-3 py-2\">\r\n                              {toTime(s.fecha_salida)}\r\n                            </td>\r\n                            <td className=\"px-3 py-2\">{s.estado}</td>\r\n                          </tr>\r\n                        );\r\n                      })}\r\n                    </tbody>\r\n                  </table>\r\n                </div>\r\n              )}\r\n            </div>\r\n\r\n            <div>\r\n              <h2 className=\"font-semibold mb-2\">Mis Salidas Espont├íneas</h2>\r\n              {isLoadingExits ? (\r\n                <div className=\"text-center py-8\">\r\n                  <div className=\"animate-spin rounded-full h-8 w-8 border-b-2 border-blue-600 mx-auto\"></div>\r\n                  <p className=\"mt-2 text-gray-600\">Cargando historial...</p>\r\n                </div>\r\n              ) : (\r\n                <SpontaneousExitHistory\r\n                  exits={spontaneousExits}\r\n                  onExitReturn={handleExitReturn}\r\n                />\r\n              )}\r\n            </div>\r\n          </div>\r\n        </TabsContent>\r\n      </Tabs>\r\n    </div>\r\n  );\r\n};\r\n\r\nexport default OperatorTimeManagement;\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\oswal\\OneDrive\\Documentos\\Punto Cambio\\punto_cambio_new\\src\\components\\timeTracking\\PermissionRequest.tsx","messages":[{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'e' is defined but never used.","line":55,"column":14,"nodeType":null,"messageId":"unusedVar","endLine":55,"endColumn":15}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":1,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import { useState } from \"react\";\r\nimport { useAuth } from \"@/hooks/useAuth\";\r\nimport { Button } from \"@/components/ui/button\";\r\nimport { Card, CardContent, CardHeader, CardTitle } from \"@/components/ui/card\";\r\nimport { Input } from \"@/components/ui/input\";\r\nimport { Label } from \"@/components/ui/label\";\r\nimport { Textarea } from \"@/components/ui/textarea\";\r\nimport { toast } from \"@/hooks/use-toast\";\r\nimport { permissionService } from \"@/services/permissionService\";\r\nimport type { PermisoTipo } from \"@/types\";\r\n\r\nconst tipos: PermisoTipo[] = [\"PERSONAL\", \"SALUD\", \"OFICIAL\", \"OTRO\"];\r\n\r\nexport default function PermissionRequest() {\r\n  const { user, selectedPoint } = useAuth();\r\n  const [tipo, setTipo] = useState<PermisoTipo>(\"PERSONAL\");\r\n  const [fechaInicio, setFechaInicio] = useState(\"\");\r\n  const [fechaFin, setFechaFin] = useState(\"\");\r\n  const [descripcion, setDescripcion] = useState(\"\");\r\n  const [fileName, setFileName] = useState<string>(\"\");\r\n  const [fileUrl, setFileUrl] = useState<string>(\"\");\r\n  const [submitting, setSubmitting] = useState(false);\r\n\r\n  const handleSubmit = async (e: React.FormEvent) => {\r\n    e.preventDefault();\r\n    if (!user) return;\r\n    if (!fechaInicio || !fechaFin) {\r\n      toast({\r\n        title: \"Error\",\r\n        description: \"Seleccione fechas v├ílidas\",\r\n        variant: \"destructive\",\r\n      });\r\n      return;\r\n    }\r\n    try {\r\n      setSubmitting(true);\r\n      const { success } = await permissionService.create({\r\n        tipo,\r\n        fecha_inicio: new Date(fechaInicio).toISOString(),\r\n        fecha_fin: new Date(fechaFin).toISOString(),\r\n        descripcion: descripcion || undefined,\r\n        archivo_url: fileUrl || undefined,\r\n        archivo_nombre: fileName || undefined,\r\n        punto_atencion_id: selectedPoint?.id,\r\n      });\r\n      if (success) {\r\n        toast({\r\n          title: \"Solicitud enviada\",\r\n          description: \"Tu permiso qued├│ en estado pendiente\",\r\n        });\r\n        setDescripcion(\"\");\r\n        setFileName(\"\");\r\n        setFileUrl(\"\");\r\n      }\r\n    } catch (e) {\r\n      toast({\r\n        title: \"Error\",\r\n        description: \"No se pudo enviar la solicitud\",\r\n        variant: \"destructive\",\r\n      });\r\n    } finally {\r\n      setSubmitting(false);\r\n    }\r\n  };\r\n\r\n  return (\r\n    <Card>\r\n      <CardHeader>\r\n        <CardTitle>Solicitud de Permiso</CardTitle>\r\n      </CardHeader>\r\n      <CardContent>\r\n        <form onSubmit={handleSubmit} className=\"space-y-4\">\r\n          <div className=\"grid grid-cols-1 md:grid-cols-2 gap-4\">\r\n            <div>\r\n              <Label>Tipo</Label>\r\n              <select\r\n                className=\"border rounded p-2 w-full\"\r\n                value={tipo}\r\n                onChange={(e) => setTipo(e.target.value as PermisoTipo)}\r\n              >\r\n                {tipos.map((t) => (\r\n                  <option key={t} value={t}>\r\n                    {t}\r\n                  </option>\r\n                ))}\r\n              </select>\r\n            </div>\r\n            <div>\r\n              <Label>Fecha inicio</Label>\r\n              <Input\r\n                type=\"date\"\r\n                value={fechaInicio}\r\n                onChange={(e) => setFechaInicio(e.target.value)}\r\n              />\r\n            </div>\r\n            <div>\r\n              <Label>Fecha fin</Label>\r\n              <Input\r\n                type=\"date\"\r\n                value={fechaFin}\r\n                onChange={(e) => setFechaFin(e.target.value)}\r\n              />\r\n            </div>\r\n          </div>\r\n\r\n          <div>\r\n            <Label>Descripci├│n</Label>\r\n            <Textarea\r\n              value={descripcion}\r\n              onChange={(e) => setDescripcion(e.target.value)}\r\n            />\r\n          </div>\r\n\r\n          <div className=\"grid grid-cols-1 md:grid-cols-3 gap-4 items-end\">\r\n            <div className=\"md:col-span-2\">\r\n              <Label>Archivo (URL en Cloud Storage)</Label>\r\n              <Input\r\n                placeholder=\"https://storage.googleapis.com/tu-bucket/permiso.pdf\"\r\n                value={fileUrl}\r\n                onChange={(e) => setFileUrl(e.target.value)}\r\n              />\r\n            </div>\r\n            <div>\r\n              <Label>Nombre del archivo</Label>\r\n              <Input\r\n                placeholder=\"permiso.pdf\"\r\n                value={fileName}\r\n                onChange={(e) => setFileName(e.target.value)}\r\n              />\r\n            </div>\r\n          </div>\r\n\r\n          <div className=\"flex justify-end\">\r\n            <Button type=\"submit\" disabled={submitting}>\r\n              {submitting ? \"Enviando...\" : \"Enviar solicitud\"}\r\n            </Button>\r\n          </div>\r\n        </form>\r\n      </CardContent>\r\n    </Card>\r\n  );\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\oswal\\OneDrive\\Documentos\\Punto Cambio\\punto_cambio_new\\src\\components\\timeTracking\\SpontaneousExitForm.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\oswal\\OneDrive\\Documentos\\Punto Cambio\\punto_cambio_new\\src\\components\\timeTracking\\SpontaneousExitHistory.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\oswal\\OneDrive\\Documentos\\Punto Cambio\\punto_cambio_new\\src\\components\\timeTracking\\TimeManagement.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\oswal\\OneDrive\\Documentos\\Punto Cambio\\punto_cambio_new\\src\\components\\timeTracking\\TimeReports.tsx","messages":[{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'formatMinutes' is assigned a value but never used. Allowed unused vars must match /^_/u.","line":151,"column":9,"nodeType":null,"messageId":"unusedVar","endLine":151,"endColumn":22},{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'e' is defined but never used.","line":258,"column":14,"nodeType":null,"messageId":"unusedVar","endLine":258,"endColumn":15}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":2,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import { useEffect, useMemo, useState } from \"react\";\r\nimport { Button } from \"@/components/ui/button\";\r\nimport {\r\n  Card,\r\n  CardContent,\r\n  CardDescription,\r\n  CardHeader,\r\n  CardTitle,\r\n} from \"@/components/ui/card\";\r\nimport { Input } from \"@/components/ui/input\";\r\nimport { Label } from \"@/components/ui/label\";\r\nimport {\r\n  Table,\r\n  TableBody,\r\n  TableCell,\r\n  TableHead,\r\n  TableHeader,\r\n  TableRow,\r\n} from \"@/components/ui/table\";\r\nimport {\r\n  Select,\r\n  SelectContent,\r\n  SelectItem,\r\n  SelectTrigger,\r\n  SelectValue,\r\n} from \"@/components/ui/select\";\r\nimport { Download, FileText, Clock } from \"lucide-react\";\r\nimport { User, PuntoAtencion, Usuario } from \"../../types\";\r\nimport { useToast } from \"@/hooks/use-toast\";\r\nimport { userService } from \"@/services/userService\";\r\nimport { pointService } from \"@/services/pointService\";\r\n\r\ninterface TimeReportsProps {\r\n  _user: User;\r\n  selectedPoint: PuntoAtencion | null;\r\n}\r\n\r\nconst TimeReports = ({ selectedPoint }: TimeReportsProps) => {\r\n  const [dateFrom, setDateFrom] = useState(\"\");\r\n  const [dateTo, setDateTo] = useState(\"\");\r\n  const [reportData, setReportData] = useState<WorktimeRow[]>([]);\r\n  const [isLoading, setIsLoading] = useState(false);\r\n  const { toast } = useToast();\r\n\r\n  // Filtros adicionales\r\n  const [users, setUsers] = useState<Usuario[]>([]);\r\n  const [userSearch, setUserSearch] = useState(\"\");\r\n  const [selectedUserId, setSelectedUserId] = useState<string>(\"\");\r\n  const [points, setPoints] = useState<{ id: string; nombre: string }[]>([]);\r\n  const [selectedPointId, setSelectedPointId] = useState<string>(\"\");\r\n\r\n  useEffect(() => {\r\n    // Cargar usuarios y puntos (una vez)\r\n    (async () => {\r\n      try {\r\n        const u = await userService.getAllUsers();\r\n        if (!u.error) setUsers(u.users);\r\n      } catch {\r\n        // noop: handled by empty users state\r\n      }\r\n      try {\r\n        const p = await pointService.getAllPoints();\r\n        if (!p.error)\r\n          setPoints(p.points.map((x) => ({ id: x.id, nombre: x.nombre })));\r\n      } catch {\r\n        // noop: handled by empty points state\r\n      }\r\n    })();\r\n  }, []);\r\n\r\n  const filteredUsers = useMemo(() => {\r\n    const term = userSearch.trim().toLowerCase();\r\n    if (!term) return users;\r\n    return users.filter(\r\n      (u) =>\r\n        u.nombre.toLowerCase().includes(term) ||\r\n        u.username.toLowerCase().includes(term)\r\n    );\r\n  }, [users, userSearch]);\r\n\r\n  // Datos recibidos desde backend (/reports worktime)\r\n  interface WorktimeRow {\r\n    date: string; // YYYY-MM-DD (d├¡a GYE)\r\n    point: string;\r\n    user: string;\r\n    username?: string;\r\n    entrada: string; // ISO\r\n    almuerzo?: string; // ISO\r\n    regreso?: string; // ISO\r\n    salida: string; // ISO | \"\"\r\n    estado?: string;\r\n    lunchMinutes: number;\r\n    spontaneousMinutes: number;\r\n    effectiveMinutes: number;\r\n  }\r\n\r\n  const generateReport = async () => {\r\n    if (!dateFrom || !dateTo) {\r\n      toast({\r\n        title: \"Error\",\r\n        description: \"Por favor seleccione las fechas del reporte\",\r\n        variant: \"destructive\",\r\n      });\r\n      return;\r\n    }\r\n\r\n    setIsLoading(true);\r\n    try {\r\n      const token = localStorage.getItem(\"authToken\");\r\n      const response = await fetch(\r\n        `${import.meta.env.VITE_API_URL || \"http://35.238.95.118/api\"}/reports`,\r\n        {\r\n          method: \"POST\",\r\n          headers: {\r\n            \"Content-Type\": \"application/json\",\r\n            Authorization: `Bearer ${token}`,\r\n          },\r\n          body: JSON.stringify({\r\n            reportType: \"worktime\",\r\n            dateFrom,\r\n            dateTo,\r\n            // Mostrar todos por defecto: solo filtrar si se elige manualmente\r\n            ...(selectedUserId ? { userId: selectedUserId } : {}),\r\n            ...(selectedPointId ? { pointId: selectedPointId } : {}),\r\n          }),\r\n        }\r\n      );\r\n\r\n      const data = await response.json();\r\n      if (!data.success)\r\n        throw new Error(data.error || \"Error al generar reporte\");\r\n\r\n      setReportData(data.data as WorktimeRow[]);\r\n\r\n      toast({\r\n        title: \"Reporte generado\",\r\n        description: \"El reporte de tiempo se ha generado exitosamente\",\r\n      });\r\n    } catch (error) {\r\n      console.error(\"Error generating time report:\", error);\r\n      toast({\r\n        title: \"Error\",\r\n        description: \"Error al generar el reporte de tiempo\",\r\n        variant: \"destructive\",\r\n      });\r\n    } finally {\r\n      setIsLoading(false);\r\n    }\r\n  };\r\n\r\n  const formatMinutes = (minutes: number) => {\r\n    const hours = Math.floor(minutes / 60);\r\n    const mins = minutes % 60;\r\n    return `${hours}h ${mins}m`;\r\n  };\r\n\r\n  // Exporta el informe visible a CSV (mismo comportamiento movido desde Usuarios Activos)\r\n  const exportReportCSV = () => {\r\n    try {\r\n      const header = [\r\n        \"Fecha\",\r\n        \"Punto\",\r\n        \"Usuario\",\r\n        \"Username\",\r\n        \"Entrada\",\r\n        \"Almuerzo\",\r\n        \"Regreso\",\r\n        \"Salida\",\r\n        \"Almuerzo (min)\",\r\n        \"Salidas (min)\",\r\n        \"Tiempo Efectivo (min)\",\r\n        \"Estado\",\r\n      ];\r\n      const rows = reportData.map((r) => [\r\n        r.date,\r\n        r.point,\r\n        r.user,\r\n        r.username ? `@${r.username}` : \"\",\r\n        r.entrada\r\n          ? new Date(r.entrada).toLocaleTimeString(\"es-EC\", {\r\n              hour: \"2-digit\",\r\n              minute: \"2-digit\",\r\n            })\r\n          : \"\",\r\n        r.almuerzo\r\n          ? new Date(r.almuerzo).toLocaleTimeString(\"es-EC\", {\r\n              hour: \"2-digit\",\r\n              minute: \"2-digit\",\r\n            })\r\n          : \"\",\r\n        r.regreso\r\n          ? new Date(r.regreso).toLocaleTimeString(\"es-EC\", {\r\n              hour: \"2-digit\",\r\n              minute: \"2-digit\",\r\n            })\r\n          : \"\",\r\n        r.salida\r\n          ? new Date(r.salida).toLocaleTimeString(\"es-EC\", {\r\n              hour: \"2-digit\",\r\n              minute: \"2-digit\",\r\n            })\r\n          : \"\",\r\n        r.lunchMinutes,\r\n        r.spontaneousMinutes,\r\n        r.effectiveMinutes,\r\n        r.estado ?? \"\",\r\n      ]);\r\n      // Totales al final\r\n      const totalLunch = reportData.reduce(\r\n        (s, r) => s + (r.lunchMinutes || 0),\r\n        0\r\n      );\r\n      const totalSpont = reportData.reduce(\r\n        (s, r) => s + (r.spontaneousMinutes || 0),\r\n        0\r\n      );\r\n      const totalEffective = reportData.reduce(\r\n        (s, r) => s + (r.effectiveMinutes || 0),\r\n        0\r\n      );\r\n      rows.push([\r\n        \"\",\r\n        \"\",\r\n        \"\",\r\n        \"\",\r\n        \"\",\r\n        \"\",\r\n        \"\",\r\n        \"Totales:\",\r\n        totalLunch,\r\n        totalSpont,\r\n        totalEffective,\r\n        \"\",\r\n      ]);\r\n\r\n      const csv = [header, ...rows]\r\n        .map((cols) =>\r\n          cols\r\n            .map((c) => {\r\n              const v = String(c ?? \"\");\r\n              return v.includes(\",\") || v.includes(\"\\n\") || v.includes('\"')\r\n                ? `\"${v.replaceAll('\"', '\"\"')}\"`\r\n                : v;\r\n            })\r\n            .join(\",\")\r\n        )\r\n        .join(\"\\n\");\r\n      const blob = new Blob([csv], { type: \"text/csv;charset=utf-8;\" });\r\n      const url = URL.createObjectURL(blob);\r\n      const a = document.createElement(\"a\");\r\n      a.href = url;\r\n      const today = new Date().toISOString().slice(0, 10);\r\n      a.download = `reporte_horarios_${today}.csv`;\r\n      document.body.appendChild(a);\r\n      a.click();\r\n      a.remove();\r\n      URL.revokeObjectURL(url);\r\n    } catch (e) {\r\n      toast({\r\n        title: \"Error\",\r\n        description: \"No se pudo exportar el informe\",\r\n        variant: \"destructive\",\r\n      });\r\n    }\r\n  };\r\n\r\n  return (\r\n    <div className=\"space-y-6\">\r\n      <Card>\r\n        <CardHeader>\r\n          <CardTitle className=\"flex items-center gap-2\">\r\n            <Clock className=\"h-5 w-5\" />\r\n            Reporte de Horarios\r\n          </CardTitle>\r\n          <CardDescription>\r\n            Informe administrativo de horarios por usuario y punto\r\n          </CardDescription>\r\n        </CardHeader>\r\n        <CardContent>\r\n          <div className=\"grid grid-cols-1 md:grid-cols-6 gap-4 mb-4\">\r\n            <div className=\"space-y-2\">\r\n              <Label htmlFor=\"dateFrom\">Fecha Desde</Label>\r\n              <Input\r\n                id=\"dateFrom\"\r\n                type=\"date\"\r\n                value={dateFrom}\r\n                onChange={(e) => setDateFrom(e.target.value)}\r\n              />\r\n            </div>\r\n            <div className=\"space-y-2\">\r\n              <Label htmlFor=\"dateTo\">Fecha Hasta</Label>\r\n              <Input\r\n                id=\"dateTo\"\r\n                type=\"date\"\r\n                value={dateTo}\r\n                onChange={(e) => setDateTo(e.target.value)}\r\n              />\r\n            </div>\r\n            <div className=\"space-y-2\">\r\n              <Label>Usuario (opcional)</Label>\r\n              <Input\r\n                placeholder=\"Buscar nombre o username\"\r\n                value={userSearch}\r\n                onChange={(e) => setUserSearch(e.target.value)}\r\n              />\r\n              <Select\r\n                value={selectedUserId}\r\n                onValueChange={(v) =>\r\n                  setSelectedUserId(v === \"__all__\" ? \"\" : v)\r\n                }\r\n              >\r\n                <SelectTrigger>\r\n                  <SelectValue placeholder=\"Todos\" />\r\n                </SelectTrigger>\r\n                <SelectContent>\r\n                  <SelectItem value=\"__all__\">Todos</SelectItem>\r\n                  {filteredUsers.map((u) => (\r\n                    <SelectItem key={u.id} value={u.id}>\r\n                      {u.nombre} (@{u.username})\r\n                    </SelectItem>\r\n                  ))}\r\n                </SelectContent>\r\n              </Select>\r\n            </div>\r\n            <div className=\"space-y-2\">\r\n              <Label>Punto (opcional)</Label>\r\n              <Select\r\n                value={selectedPointId}\r\n                onValueChange={(v) =>\r\n                  setSelectedPointId(v === \"__all__\" ? \"\" : v)\r\n                }\r\n              >\r\n                <SelectTrigger>\r\n                  <SelectValue placeholder=\"Todos\" />\r\n                </SelectTrigger>\r\n                <SelectContent>\r\n                  <SelectItem value=\"__all__\">Todos</SelectItem>\r\n                  {points.map((p) => (\r\n                    <SelectItem key={p.id} value={p.id}>\r\n                      {p.nombre}\r\n                    </SelectItem>\r\n                  ))}\r\n                </SelectContent>\r\n              </Select>\r\n            </div>\r\n            <div className=\"flex items-end col-span-2\">\r\n              <Button\r\n                onClick={generateReport}\r\n                disabled={isLoading}\r\n                className=\"w-full\"\r\n              >\r\n                <FileText className=\"mr-2 h-4 w-4\" />\r\n                {isLoading ? \"Generando...\" : \"Generar\"}\r\n              </Button>\r\n            </div>\r\n          </div>\r\n\r\n          {selectedPoint && (\r\n            <div className=\"mb-4 p-3 bg-blue-50 rounded-lg\">\r\n              <p className=\"text-sm text-blue-800\">\r\n                <strong>Punto:</strong> {selectedPoint.nombre}\r\n              </p>\r\n            </div>\r\n          )}\r\n        </CardContent>\r\n      </Card>\r\n\r\n      {reportData.length > 0 && (\r\n        <Card>\r\n          <CardHeader className=\"flex flex-row items-center justify-between\">\r\n            <div>\r\n              <CardTitle>Resultados del Reporte</CardTitle>\r\n              <CardDescription>\r\n                Detalle del tiempo trabajado en el per├¡odo seleccionado\r\n              </CardDescription>\r\n            </div>\r\n            <div>\r\n              <Button variant=\"secondary\" onClick={exportReportCSV}>\r\n                <Download className=\"mr-2 h-4 w-4\" />\r\n                Exportar Informe\r\n              </Button>\r\n            </div>\r\n          </CardHeader>\r\n          <CardContent>\r\n            <h3 className=\"text-lg font-semibold mb-2\">Informe (lista)</h3>\r\n            <Table>\r\n              <TableHeader>\r\n                <TableRow>\r\n                  <TableHead>Fecha</TableHead>\r\n                  <TableHead>Punto</TableHead>\r\n                  <TableHead>Usuario</TableHead>\r\n                  <TableHead>Username</TableHead>\r\n                  <TableHead>Entrada</TableHead>\r\n                  <TableHead>Almuerzo</TableHead>\r\n                  <TableHead>Regreso</TableHead>\r\n                  <TableHead>Salida</TableHead>\r\n                  <TableHead>Almuerzo (min)</TableHead>\r\n                  <TableHead>Salidas (min)</TableHead>\r\n                  <TableHead>Tiempo Efectivo</TableHead>\r\n                  <TableHead>Estado</TableHead>\r\n                </TableRow>\r\n              </TableHeader>\r\n              <TableBody>\r\n                {reportData.map((row, index) => {\r\n                  const fmtHM = (mins: number) => {\r\n                    const h = Math.floor((mins || 0) / 60);\r\n                    const m = Math.abs((mins || 0) % 60);\r\n                    return `${h}h ${m}m`;\r\n                  };\r\n                  const fmtTime = (iso?: string) =>\r\n                    iso\r\n                      ? new Date(iso).toLocaleTimeString(\"es-EC\", {\r\n                          hour: \"2-digit\",\r\n                          minute: \"2-digit\",\r\n                        })\r\n                      : \"\";\r\n                  return (\r\n                    <TableRow key={index}>\r\n                      <TableCell>{row.date}</TableCell>\r\n                      <TableCell>{row.point}</TableCell>\r\n                      <TableCell>{row.user}</TableCell>\r\n                      <TableCell>\r\n                        {row.username ? `@${row.username}` : \"\"}\r\n                      </TableCell>\r\n                      <TableCell>{fmtTime(row.entrada)}</TableCell>\r\n                      <TableCell>{fmtTime(row.almuerzo)}</TableCell>\r\n                      <TableCell>{fmtTime(row.regreso)}</TableCell>\r\n                      <TableCell>{fmtTime(row.salida)}</TableCell>\r\n                      <TableCell>{fmtHM(row.lunchMinutes)}</TableCell>\r\n                      <TableCell>{fmtHM(row.spontaneousMinutes)}</TableCell>\r\n                      <TableCell className=\"font-medium\">\r\n                        {fmtHM(row.effectiveMinutes)}\r\n                      </TableCell>\r\n                      <TableCell>{row.estado || \"\"}</TableCell>\r\n                    </TableRow>\r\n                  );\r\n                })}\r\n                {/* Totales */}\r\n                <TableRow>\r\n                  <TableCell colSpan={8} className=\"text-right font-semibold\">\r\n                    Totales\r\n                  </TableCell>\r\n                  <TableCell className=\"font-semibold\">\r\n                    {(() => {\r\n                      const t = reportData.reduce(\r\n                        (s, r) => s + (r.lunchMinutes || 0),\r\n                        0\r\n                      );\r\n                      const h = Math.floor(t / 60);\r\n                      const m = Math.abs(t % 60);\r\n                      return `${h}h ${m}m`;\r\n                    })()}\r\n                  </TableCell>\r\n                  <TableCell className=\"font-semibold\">\r\n                    {(() => {\r\n                      const t = reportData.reduce(\r\n                        (s, r) => s + (r.spontaneousMinutes || 0),\r\n                        0\r\n                      );\r\n                      const h = Math.floor(t / 60);\r\n                      const m = Math.abs(t % 60);\r\n                      return `${h}h ${m}m`;\r\n                    })()}\r\n                  </TableCell>\r\n                  <TableCell className=\"font-semibold\">\r\n                    {(() => {\r\n                      const t = reportData.reduce(\r\n                        (s, r) => s + (r.effectiveMinutes || 0),\r\n                        0\r\n                      );\r\n                      const h = Math.floor(t / 60);\r\n                      const m = Math.abs(t % 60);\r\n                      return `${h}h ${m}m`;\r\n                    })()}\r\n                  </TableCell>\r\n                  <TableCell />\r\n                </TableRow>\r\n              </TableBody>\r\n            </Table>\r\n          </CardContent>\r\n        </Card>\r\n      )}\r\n    </div>\r\n  );\r\n};\r\n\r\nexport default TimeReports;\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\oswal\\OneDrive\\Documentos\\Punto Cambio\\punto_cambio_new\\src\\components\\timeTracking\\TimeTracker.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\oswal\\OneDrive\\Documentos\\Punto Cambio\\punto_cambio_new\\src\\components\\transfer\\TransferForm.tsx","messages":[{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'Send' is defined but never used. Allowed unused vars must match /^_/u.","line":20,"column":10,"nodeType":null,"messageId":"unusedVar","endLine":20,"endColumn":14},{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'X' is defined but never used. Allowed unused vars must match /^_/u.","line":20,"column":16,"nodeType":null,"messageId":"unusedVar","endLine":20,"endColumn":17}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":2,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import { useState, useEffect, FormEvent } from \"react\";\r\nimport { Button } from \"@/components/ui/button\";\r\nimport { Input } from \"@/components/ui/input\";\r\nimport { Label } from \"@/components/ui/label\";\r\nimport { Textarea } from \"@/components/ui/textarea\";\r\nimport {\r\n  Card,\r\n  CardContent,\r\n  CardDescription,\r\n  CardHeader,\r\n  CardTitle,\r\n} from \"@/components/ui/card\";\r\nimport {\r\n  Select,\r\n  SelectContent,\r\n  SelectItem,\r\n  SelectTrigger,\r\n  SelectValue,\r\n} from \"@/components/ui/select\";\r\nimport { Send, X } from \"lucide-react\";\r\nimport { User, PuntoAtencion, Moneda } from \"../../types\";\r\nimport { transferService } from \"../../services/transferService\";\r\nimport { currencyService } from \"../../services/currencyService\";\r\nimport { pointService } from \"../../services/pointService\";\r\nimport { toast } from \"sonner\";\r\n\r\ninterface TransferFormProps {\r\n  user: User;\r\n  selectedPoint: PuntoAtencion | null;\r\n  onTransferCreated: () => void;\r\n  onCancel: () => void;\r\n}\r\n\r\nconst TIPO_TRANSFERENCIA_ENTRE_PUNTOS = \"ENTRE_PUNTOS\" as const;\r\n\r\nconst initialErrorState = {\r\n  destinationPointId: \"\",\r\n  currencyId: \"\",\r\n  amount: \"\",\r\n  description: \"\",\r\n};\r\n\r\nconst TransferForm = ({\r\n  user,\r\n  selectedPoint,\r\n  onTransferCreated,\r\n  onCancel,\r\n}: TransferFormProps) => {\r\n  const [destinationPointId, setDestinationPointId] = useState(\"\");\r\n  const [currencyId, setCurrencyId] = useState(\"\");\r\n  const [amount, setAmount] = useState(\"\");\r\n  const [description, setDescription] = useState(\"\");\r\n  const [isLoading, setIsLoading] = useState(false);\r\n  const [availablePoints, setAvailablePoints] = useState<PuntoAtencion[]>([]);\r\n  const [currencies, setCurrencies] = useState<Moneda[]>([]);\r\n  const [errors, setErrors] = useState(initialErrorState);\r\n\r\n  useEffect(() => {\r\n    const loadData = async () => {\r\n      try {\r\n        const { points } = await pointService.getActivePointsForTransfers();\r\n        setAvailablePoints(\r\n          points.filter((point) => point.id !== selectedPoint?.id)\r\n        );\r\n\r\n        const { currencies: fetchedCurrencies } =\r\n          await currencyService.getAllCurrencies();\r\n        // Permitir USD aunque estuviera inactiva y mostrar todas para transferencias\r\n        setCurrencies(\r\n          [...fetchedCurrencies].sort((a, b) => {\r\n            // Prioriza USD arriba y luego orden alfab├®tico por c├│digo\r\n            if (a.codigo === \"USD\" && b.codigo !== \"USD\") return -1;\r\n            if (b.codigo === \"USD\" && a.codigo !== \"USD\") return 1;\r\n            return a.codigo.localeCompare(b.codigo);\r\n          })\r\n        );\r\n      } catch {\r\n        toast.error(\"Error al cargar datos necesarios\");\r\n      }\r\n    };\r\n\r\n    loadData();\r\n  }, [selectedPoint]);\r\n\r\n  // Validaci├│n en tiempo real\r\n  useEffect(() => {\r\n    setErrors({\r\n      destinationPointId: destinationPointId ? \"\" : \"Selecciona el destino\",\r\n      currencyId: currencyId ? \"\" : \"Selecciona la moneda\",\r\n      amount: !amount\r\n        ? \"Ingresa un monto\"\r\n        : parseFloat(amount) <= 0\r\n        ? \"El monto debe ser mayor a 0\"\r\n        : \"\",\r\n      description: description.trim() ? \"\" : \"Describe el motivo\",\r\n    });\r\n  }, [destinationPointId, currencyId, amount, description]);\r\n\r\n  const formHasData = destinationPointId || currencyId || amount || description;\r\n\r\n  const handleSubmit = async (e: FormEvent<HTMLFormElement>) => {\r\n    e.preventDefault();\r\n\r\n    // Chequeo r├ípido antes de enviar\r\n    if (\r\n      !destinationPointId ||\r\n      !currencyId ||\r\n      !amount ||\r\n      !description.trim() ||\r\n      parseFloat(amount) <= 0\r\n    ) {\r\n      toast.error(\"Completa todos los campos requeridos correctamente\");\r\n      return;\r\n    }\r\n\r\n    if (!selectedPoint) {\r\n      toast.error(\"No hay punto de origen seleccionado\");\r\n      return;\r\n    }\r\n\r\n    try {\r\n      setIsLoading(true);\r\n\r\n      const transferData = {\r\n        origen_id: selectedPoint.id,\r\n        destino_id: destinationPointId,\r\n        moneda_id: currencyId,\r\n        monto: parseFloat(amount),\r\n        descripcion: description.trim(),\r\n        tipo_transferencia: TIPO_TRANSFERENCIA_ENTRE_PUNTOS,\r\n        solicitado_por: user.id,\r\n      };\r\n\r\n      const { transfer, error } = await transferService.createTransfer(\r\n        transferData\r\n      );\r\n\r\n      if (error || !transfer) {\r\n        toast.error(error || \"Error al crear la transferencia\");\r\n        return;\r\n      }\r\n\r\n      toast.success(\r\n        `Ô£à Solicitud de transferencia por ${transfer.monto.toLocaleString()} creada con ├®xito.`\r\n      );\r\n\r\n      setDestinationPointId(\"\");\r\n      setCurrencyId(\"\");\r\n      setAmount(\"\");\r\n      setDescription(\"\");\r\n      onTransferCreated();\r\n    } catch {\r\n      toast.error(\"Error al crear la transferencia\");\r\n    } finally {\r\n      setIsLoading(false);\r\n    }\r\n  };\r\n\r\n  const selectedCurrency = currencies.find((c) => c.id === currencyId);\r\n  const selectedDestinationPoint = availablePoints.find(\r\n    (p) => p.id === destinationPointId\r\n  );\r\n\r\n  return (\r\n    <Card>\r\n      <CardHeader>\r\n        <CardTitle>Nueva Transferencia</CardTitle>\r\n        <CardDescription>\r\n          Solicita una transferencia entre puntos. Todos los campos son\r\n          obligatorios.\r\n        </CardDescription>\r\n      </CardHeader>\r\n      <CardContent>\r\n        <form onSubmit={handleSubmit} className=\"space-y-4\">\r\n          <div className=\"grid grid-cols-1 md:grid-cols-2 gap-3\">\r\n            {/* Origen */}\r\n            <div className=\"space-y-1\">\r\n              <Label className=\"text-sm font-medium\">Punto de Origen</Label>\r\n              <Input\r\n                value={selectedPoint?.nombre || \"No seleccionado\"}\r\n                disabled\r\n                className=\"bg-muted h-9\"\r\n              />\r\n            </div>\r\n\r\n            {/* Destino */}\r\n            <div className=\"space-y-1\">\r\n              <Label htmlFor=\"destinationPoint\" className=\"text-sm font-medium\">\r\n                Punto de Destino *\r\n              </Label>\r\n              <Select\r\n                value={destinationPointId}\r\n                onValueChange={setDestinationPointId}\r\n                name=\"destinationPoint\"\r\n              >\r\n                <SelectTrigger className=\"h-9\">\r\n                  <SelectValue placeholder=\"Seleccionar destino\" />\r\n                </SelectTrigger>\r\n                <SelectContent>\r\n                  {availablePoints.map((point) => (\r\n                    <SelectItem key={point.id} value={point.id}>\r\n                      {point.nombre}\r\n                    </SelectItem>\r\n                  ))}\r\n                </SelectContent>\r\n              </Select>\r\n              {errors.destinationPointId && (\r\n                <span className=\"text-xs text-destructive\">\r\n                  {errors.destinationPointId}\r\n                </span>\r\n              )}\r\n            </div>\r\n          </div>\r\n\r\n          <div className=\"grid grid-cols-1 md:grid-cols-2 gap-3\">\r\n            {/* Moneda */}\r\n            <div className=\"space-y-1\">\r\n              <Label htmlFor=\"currency\" className=\"text-sm font-medium\">\r\n                Moneda *\r\n              </Label>\r\n              <Select\r\n                value={currencyId}\r\n                onValueChange={setCurrencyId}\r\n                name=\"currency\"\r\n              >\r\n                <SelectTrigger className=\"h-9\">\r\n                  <SelectValue placeholder=\"Seleccionar moneda\" />\r\n                </SelectTrigger>\r\n                <SelectContent>\r\n                  {currencies.map((currency) => (\r\n                    <SelectItem key={currency.id} value={currency.id}>\r\n                      {currency.codigo} - {currency.nombre}\r\n                    </SelectItem>\r\n                  ))}\r\n                </SelectContent>\r\n              </Select>\r\n              {errors.currencyId && (\r\n                <span className=\"text-xs text-destructive\">\r\n                  {errors.currencyId}\r\n                </span>\r\n              )}\r\n            </div>\r\n\r\n            {/* Monto */}\r\n            <div className=\"space-y-1\">\r\n              <Label htmlFor=\"amount\" className=\"text-sm font-medium\">\r\n                Monto *\r\n              </Label>\r\n              <div className=\"relative\">\r\n                <span className=\"absolute left-3 top-1/2 transform -translate-y-1/2 text-muted-foreground text-sm\">\r\n                  {selectedCurrency?.simbolo || \"$\"}\r\n                </span>\r\n                <Input\r\n                  id=\"amount\"\r\n                  className=\"pl-8 h-9\"\r\n                  type=\"number\"\r\n                  value={amount}\r\n                  onChange={(e) => setAmount(e.target.value)}\r\n                  placeholder=\"0.00\"\r\n                  step=\"0.01\"\r\n                  min=\"0.01\"\r\n                  disabled={!currencyId}\r\n                  autoComplete=\"off\"\r\n                />\r\n              </div>\r\n              {errors.amount && (\r\n                <span className=\"text-xs text-destructive\">\r\n                  {errors.amount}\r\n                </span>\r\n              )}\r\n            </div>\r\n          </div>\r\n\r\n          {/* Descripci├│n */}\r\n          <div className=\"space-y-1\">\r\n            <Label htmlFor=\"description\" className=\"text-sm font-medium\">\r\n              Descripci├│n / Motivo *\r\n            </Label>\r\n            <Textarea\r\n              id=\"description\"\r\n              value={description}\r\n              onChange={(e) => setDescription(e.target.value)}\r\n              placeholder=\"Ej: Transferencia de fondos para cambio de turno\"\r\n              rows={2}\r\n              className=\"resize-none\"\r\n            />\r\n            {errors.description && (\r\n              <span className=\"text-xs text-destructive\">\r\n                {errors.description}\r\n              </span>\r\n            )}\r\n          </div>\r\n\r\n          {/* Resumen compacto */}\r\n          {destinationPointId &&\r\n            currencyId &&\r\n            amount &&\r\n            parseFloat(amount) > 0 && (\r\n              <div className=\"p-3 bg-muted/50 rounded-lg border\">\r\n                <h4 className=\"font-medium mb-2 text-sm\">Resumen</h4>\r\n                <div className=\"grid grid-cols-2 gap-2 text-xs\">\r\n                  <div>\r\n                    <span className=\"text-muted-foreground\">Desde:</span>{\" \"}\r\n                    {selectedPoint?.nombre}\r\n                  </div>\r\n                  <div>\r\n                    <span className=\"text-muted-foreground\">Hacia:</span>{\" \"}\r\n                    {selectedDestinationPoint?.nombre}\r\n                  </div>\r\n                  <div>\r\n                    <span className=\"text-muted-foreground\">Monto:</span>{\" \"}\r\n                    {selectedCurrency?.simbolo}\r\n                    {amount} {selectedCurrency?.codigo}\r\n                  </div>\r\n                  <div>\r\n                    <span className=\"text-muted-foreground\">Solicitante:</span>{\" \"}\r\n                    {user.nombre}\r\n                  </div>\r\n                </div>\r\n              </div>\r\n            )}\r\n\r\n          <div className=\"flex gap-2 pt-2\">\r\n            <Button\r\n              type=\"submit\"\r\n              disabled={isLoading || Object.values(errors).some(Boolean)}\r\n              className=\"h-9\"\r\n            >\r\n              {isLoading ? \"Creando...\" : \"Crear Transferencia\"}\r\n            </Button>\r\n            {formHasData && (\r\n              <Button\r\n                type=\"button\"\r\n                variant=\"outline\"\r\n                onClick={onCancel}\r\n                disabled={isLoading}\r\n                className=\"h-9\"\r\n              >\r\n                Cancelar\r\n              </Button>\r\n            )}\r\n          </div>\r\n        </form>\r\n      </CardContent>\r\n    </Card>\r\n  );\r\n};\r\n\r\nexport default TransferForm;\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\oswal\\OneDrive\\Documentos\\Punto Cambio\\punto_cambio_new\\src\\components\\transfer\\TransferList.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\oswal\\OneDrive\\Documentos\\Punto Cambio\\punto_cambio_new\\src\\components\\transfer\\TransferManagement.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\oswal\\OneDrive\\Documentos\\Punto Cambio\\punto_cambio_new\\src\\components\\ui\\AgenciaSelector.tsx","messages":[{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'Button' is defined but never used. Allowed unused vars must match /^_/u.","line":2,"column":10,"nodeType":null,"messageId":"unusedVar","endLine":2,"endColumn":16},{"ruleId":"no-console","severity":1,"message":"Unexpected console statement. Only these console methods are allowed: warn, error.","line":60,"column":7,"nodeType":"MemberExpression","messageId":"limited","endLine":60,"endColumn":18,"suggestions":[{"fix":{"range":[1757,1823],"text":""},"messageId":"removeConsole","data":{"propertyName":"log"},"desc":"Remove the console.log()."}]},{"ruleId":"no-console","severity":1,"message":"Unexpected console statement. Only these console methods are allowed: warn, error.","line":64,"column":7,"nodeType":"MemberExpression","messageId":"limited","endLine":64,"endColumn":18,"suggestions":[{"fix":{"range":[1935,2113],"text":""},"messageId":"removeConsole","data":{"propertyName":"log"},"desc":"Remove the console.log()."}]},{"ruleId":"no-console","severity":1,"message":"Unexpected console statement. Only these console methods are allowed: warn, error.","line":100,"column":7,"nodeType":"MemberExpression","messageId":"limited","endLine":100,"endColumn":18,"suggestions":[{"fix":{"range":[3103,3175],"text":""},"messageId":"removeConsole","data":{"propertyName":"log"},"desc":"Remove the console.log()."}]},{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'error' is defined but never used.","line":101,"column":14,"nodeType":null,"messageId":"unusedVar","endLine":101,"endColumn":19}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":5,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import { useState, useEffect } from \"react\";\r\nimport { Button } from \"@/components/ui/button\";\r\nimport { Label } from \"@/components/ui/label\";\r\nimport {\r\n  Select,\r\n  SelectContent,\r\n  SelectItem,\r\n  SelectTrigger,\r\n  SelectValue,\r\n} from \"@/components/ui/select\";\r\nimport { Loader2 } from \"lucide-react\";\r\nimport { Agencia } from \"../../types\";\r\nimport { servientregaService } from \"../../services/servientregaService\";\r\nimport { toast } from \"@/hooks/use-toast\";\r\n\r\ninterface AgenciaSelectorProps {\r\n  value?: string;\r\n  onAgenciaSelect: (agencia: Agencia | null) => void;\r\n  placeholder?: string;\r\n  disabled?: boolean;\r\n}\r\n\r\nexport function AgenciaSelector({\r\n  value = \"\",\r\n  onAgenciaSelect,\r\n  placeholder = \"Seleccionar agencia...\",\r\n  disabled = false,\r\n}: AgenciaSelectorProps) {\r\n  const [agencias, setAgencias] = useState<Agencia[]>([]);\r\n  const [loading, setLoading] = useState(false);\r\n  const [selectedAgencia, setSelectedAgencia] = useState<Agencia | null>(null);\r\n\r\n  // Cargar agencias al montar el componente\r\n  useEffect(() => {\r\n    loadAgencias();\r\n  }, []);\r\n\r\n  // Buscar la agencia seleccionada cuando cambia el value\r\n  useEffect(() => {\r\n    if (value && agencias.length > 0) {\r\n      // Buscar por nombre exacto primero\r\n      let agencia = agencias.find((a) => a.nombre === value);\r\n\r\n      // Si no se encuentra por nombre exacto, buscar por nombre que contenga el valor\r\n      if (!agencia) {\r\n        agencia = agencias.find((a) =>\r\n          a.nombre.toLowerCase().includes(value.toLowerCase())\r\n        );\r\n      }\r\n\r\n      setSelectedAgencia(agencia || null);\r\n    } else {\r\n      setSelectedAgencia(null);\r\n    }\r\n  }, [value, agencias]);\r\n\r\n  const loadAgencias = async () => {\r\n    setLoading(true);\r\n    try {\r\n      console.log(\"­ƒöì AgenciaSelector: Iniciando carga de agencias...\");\r\n      const { agencias: fetchedAgencias, error } =\r\n        await servientregaService.getAgencias();\r\n\r\n      console.log(\"­ƒôì AgenciaSelector: Respuesta del servicio:\", {\r\n        agenciasCount: fetchedAgencias.length,\r\n        error,\r\n        firstAgencia: fetchedAgencias[0],\r\n      });\r\n\r\n      if (error) {\r\n        console.error(\"ÔØî AgenciaSelector: Error del servicio:\", error);\r\n        toast({\r\n          title: \"Error\",\r\n          description: error,\r\n          variant: \"destructive\",\r\n        });\r\n        return;\r\n      }\r\n\r\n      // Detectar agencias duplicadas para debugging\r\n      const duplicates = fetchedAgencias.filter(\r\n        (agencia, index, arr) =>\r\n          arr.findIndex(\r\n            (a) => a.nombre === agencia.nombre && a.ciudad === agencia.ciudad\r\n          ) !== index\r\n      );\r\n\r\n      if (duplicates.length > 0) {\r\n        console.warn(\"ÔÜá´©Å Agencias duplicadas detectadas:\", duplicates);\r\n      }\r\n\r\n      // Ordenar agencias por nombre y ciudad para mejor UX\r\n      const sortedAgencias = fetchedAgencias.sort((a, b) => {\r\n        const nameCompare = a.nombre.localeCompare(b.nombre);\r\n        if (nameCompare !== 0) return nameCompare;\r\n        return a.ciudad.localeCompare(b.ciudad);\r\n      });\r\n\r\n      setAgencias(sortedAgencias);\r\n      console.log(`Ô£à ${sortedAgencias.length} agencias cargadas y ordenadas`);\r\n    } catch (error) {\r\n      toast({\r\n        title: \"Error\",\r\n        description: \"Error al cargar agencias de Servientrega\",\r\n        variant: \"destructive\",\r\n      });\r\n    } finally {\r\n      setLoading(false);\r\n    }\r\n  };\r\n\r\n  const handleSelect = (agenciaKey: string) => {\r\n    if (agenciaKey === \"clear\") {\r\n      setSelectedAgencia(null);\r\n      onAgenciaSelect(null);\r\n      return;\r\n    }\r\n\r\n    // Usar una clave m├ís espec├¡fica que incluya tipo_cs para evitar duplicados\r\n    const agencia = agencias.find(\r\n      (a) => `${a.nombre}-${a.ciudad}-${a.tipo_cs}` === agenciaKey\r\n    );\r\n    if (agencia) {\r\n      setSelectedAgencia(agencia);\r\n      onAgenciaSelect(agencia);\r\n    }\r\n  };\r\n\r\n  return (\r\n    <div className=\"space-y-3\">\r\n      <Label className=\"text-sm font-medium\">Agencia Servientrega</Label>\r\n      <Select\r\n        value={\r\n          selectedAgencia\r\n            ? `${selectedAgencia.nombre}-${selectedAgencia.ciudad}-${selectedAgencia.tipo_cs}`\r\n            : \"\"\r\n        }\r\n        onValueChange={handleSelect}\r\n        disabled={disabled || loading}\r\n      >\r\n        <SelectTrigger className=\"w-full\">\r\n          <SelectValue\r\n            placeholder={loading ? \"Cargando agencias...\" : placeholder}\r\n          />\r\n        </SelectTrigger>\r\n        <SelectContent className=\"max-h-[300px] max-w-[500px]\">\r\n          {loading ? (\r\n            <SelectItem value=\"loading\" disabled>\r\n              <div className=\"flex items-center\">\r\n                <Loader2 className=\"mr-2 h-4 w-4 animate-spin\" />\r\n                Cargando agencias...\r\n              </div>\r\n            </SelectItem>\r\n          ) : agencias.length === 0 ? (\r\n            <SelectItem value=\"empty\" disabled>\r\n              No hay agencias disponibles\r\n            </SelectItem>\r\n          ) : (\r\n            <>\r\n              {selectedAgencia && (\r\n                <SelectItem value=\"clear\">\r\n                  <span className=\"text-gray-500 italic\">\r\n                    Limpiar selecci├│n\r\n                  </span>\r\n                </SelectItem>\r\n              )}\r\n              {agencias.map((agencia) => {\r\n                // Verificar si hay otras agencias con el mismo nombre\r\n                const duplicateCount = agencias.filter(\r\n                  (a) => a.nombre === agencia.nombre\r\n                ).length;\r\n                const isDuplicate = duplicateCount > 1;\r\n\r\n                return (\r\n                  <SelectItem\r\n                    key={`${agencia.nombre}-${agencia.ciudad}-${agencia.tipo_cs}`}\r\n                    value={`${agencia.nombre}-${agencia.ciudad}-${agencia.tipo_cs}`}\r\n                    className=\"py-3\"\r\n                  >\r\n                    <div className=\"flex flex-col gap-1 w-full max-w-[400px]\">\r\n                      <div className=\"flex items-start gap-2\">\r\n                        <span className=\"font-medium text-sm leading-tight flex-1 min-w-0\">\r\n                          {agencia.nombre}\r\n                        </span>\r\n                        {isDuplicate && (\r\n                          <span className=\"text-xs bg-blue-100 text-blue-700 px-2 py-0.5 rounded-full flex-shrink-0\">\r\n                            {duplicateCount}\r\n                          </span>\r\n                        )}\r\n                      </div>\r\n                      <div className=\"text-xs text-gray-600 flex items-center gap-1\">\r\n                        <span>­ƒôì</span>\r\n                        <span className=\"truncate\">\r\n                          {agencia.ciudad.trim()}\r\n                        </span>\r\n                      </div>\r\n                      <div className=\"text-xs text-gray-500 line-clamp-2 leading-tight\">\r\n                        {agencia.direccion.trim()}\r\n                      </div>\r\n                      <div className=\"text-xs text-blue-600 font-mono\">\r\n                        {agencia.tipo_cs.trim()}\r\n                      </div>\r\n                    </div>\r\n                  </SelectItem>\r\n                );\r\n              })}\r\n            </>\r\n          )}\r\n        </SelectContent>\r\n      </Select>\r\n\r\n      {selectedAgencia && (\r\n        <div className=\"text-sm bg-blue-50 border border-blue-200 rounded-lg p-3 max-w-full\">\r\n          <div className=\"font-medium text-blue-900 mb-2 flex items-center gap-2\">\r\n            <span className=\"text-green-600\">Ô£à</span>\r\n            <span>Agencia seleccionada</span>\r\n          </div>\r\n          <div className=\"space-y-2 text-blue-800\">\r\n            <div className=\"break-words\">\r\n              <strong className=\"text-blue-900\">Nombre:</strong>\r\n              <br />\r\n              <span className=\"text-sm\">{selectedAgencia.nombre}</span>\r\n            </div>\r\n            <div className=\"grid grid-cols-2 gap-2\">\r\n              <div>\r\n                <strong className=\"text-blue-900\">Ciudad:</strong>\r\n                <br />\r\n                <span className=\"text-sm\">{selectedAgencia.ciudad.trim()}</span>\r\n              </div>\r\n              <div>\r\n                <strong className=\"text-blue-900\">C├│digo:</strong>\r\n                <br />\r\n                <code className=\"bg-blue-100 px-2 py-1 rounded text-xs font-mono\">\r\n                  {selectedAgencia.tipo_cs.trim()}\r\n                </code>\r\n              </div>\r\n            </div>\r\n            <div className=\"break-words\">\r\n              <strong className=\"text-blue-900\">Direcci├│n:</strong>\r\n              <br />\r\n              <span className=\"text-sm leading-relaxed\">\r\n                {selectedAgencia.direccion.trim()}\r\n              </span>\r\n            </div>\r\n          </div>\r\n        </div>\r\n      )}\r\n    </div>\r\n  );\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\oswal\\OneDrive\\Documentos\\Punto Cambio\\punto_cambio_new\\src\\components\\ui\\accordion.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\oswal\\OneDrive\\Documentos\\Punto Cambio\\punto_cambio_new\\src\\components\\ui\\alert-dialog.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\oswal\\OneDrive\\Documentos\\Punto Cambio\\punto_cambio_new\\src\\components\\ui\\alert.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\oswal\\OneDrive\\Documentos\\Punto Cambio\\punto_cambio_new\\src\\components\\ui\\aspect-ratio.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\oswal\\OneDrive\\Documentos\\Punto Cambio\\punto_cambio_new\\src\\components\\ui\\avatar.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\oswal\\OneDrive\\Documentos\\Punto Cambio\\punto_cambio_new\\src\\components\\ui\\badge.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\oswal\\OneDrive\\Documentos\\Punto Cambio\\punto_cambio_new\\src\\components\\ui\\breadcrumb.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\oswal\\OneDrive\\Documentos\\Punto Cambio\\punto_cambio_new\\src\\components\\ui\\button.tsx","messages":[{"ruleId":"react-refresh/only-export-components","severity":1,"message":"Fast refresh only works when a file only exports components. Use a new file to share constants or functions between components.","line":56,"column":18,"nodeType":"Identifier","messageId":"namedExport","endLine":56,"endColumn":32}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":1,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import * as React from \"react\"\r\nimport { Slot } from \"@radix-ui/react-slot\"\r\nimport { cva, type VariantProps } from \"class-variance-authority\"\r\n\r\nimport { cn } from \"@/lib/utils\"\r\n\r\nconst buttonVariants = cva(\r\n  \"inline-flex items-center justify-center gap-2 whitespace-nowrap rounded-md text-sm font-medium ring-offset-background transition-colors focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 disabled:pointer-events-none disabled:opacity-50 [&_svg]:pointer-events-none [&_svg]:size-4 [&_svg]:shrink-0\",\r\n  {\r\n    variants: {\r\n      variant: {\r\n        default: \"bg-primary text-primary-foreground hover:bg-primary/90\",\r\n        destructive:\r\n          \"bg-destructive text-destructive-foreground hover:bg-destructive/90\",\r\n        outline:\r\n          \"border border-input bg-background hover:bg-accent hover:text-accent-foreground\",\r\n        secondary:\r\n          \"bg-secondary text-secondary-foreground hover:bg-secondary/80\",\r\n        ghost: \"hover:bg-accent hover:text-accent-foreground\",\r\n        link: \"text-primary underline-offset-4 hover:underline\",\r\n      },\r\n      size: {\r\n        default: \"h-10 px-4 py-2\",\r\n        sm: \"h-9 rounded-md px-3\",\r\n        lg: \"h-11 rounded-md px-8\",\r\n        icon: \"h-10 w-10\",\r\n      },\r\n    },\r\n    defaultVariants: {\r\n      variant: \"default\",\r\n      size: \"default\",\r\n    },\r\n  }\r\n)\r\n\r\nexport interface ButtonProps\r\n  extends React.ButtonHTMLAttributes<HTMLButtonElement>,\r\n    VariantProps<typeof buttonVariants> {\r\n  asChild?: boolean\r\n}\r\n\r\nconst Button = React.forwardRef<HTMLButtonElement, ButtonProps>(\r\n  ({ className, variant, size, asChild = false, ...props }, ref) => {\r\n    const Comp = asChild ? Slot : \"button\"\r\n    return (\r\n      <Comp\r\n        className={cn(buttonVariants({ variant, size, className }))}\r\n        ref={ref}\r\n        {...props}\r\n      />\r\n    )\r\n  }\r\n)\r\nButton.displayName = \"Button\"\r\n\r\nexport { Button, buttonVariants }\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\oswal\\OneDrive\\Documentos\\Punto Cambio\\punto_cambio_new\\src\\components\\ui\\calendar.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\oswal\\OneDrive\\Documentos\\Punto Cambio\\punto_cambio_new\\src\\components\\ui\\card.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\oswal\\OneDrive\\Documentos\\Punto Cambio\\punto_cambio_new\\src\\components\\ui\\carousel.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\oswal\\OneDrive\\Documentos\\Punto Cambio\\punto_cambio_new\\src\\components\\ui\\chart.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\oswal\\OneDrive\\Documentos\\Punto Cambio\\punto_cambio_new\\src\\components\\ui\\checkbox.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\oswal\\OneDrive\\Documentos\\Punto Cambio\\punto_cambio_new\\src\\components\\ui\\collapsible.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\oswal\\OneDrive\\Documentos\\Punto Cambio\\punto_cambio_new\\src\\components\\ui\\command.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\oswal\\OneDrive\\Documentos\\Punto Cambio\\punto_cambio_new\\src\\components\\ui\\confirmation-dialog.tsx","messages":[{"ruleId":"react-refresh/only-export-components","severity":1,"message":"Fast refresh only works when a file only exports components. Use a new file to share constants or functions between components.","line":63,"column":17,"nodeType":"Identifier","messageId":"namedExport","endLine":63,"endColumn":38}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":1,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import React from \"react\";\r\nimport {\r\n  AlertDialog,\r\n  AlertDialogAction,\r\n  AlertDialogCancel,\r\n  AlertDialogContent,\r\n  AlertDialogDescription,\r\n  AlertDialogFooter,\r\n  AlertDialogHeader,\r\n  AlertDialogTitle,\r\n} from \"@/components/ui/alert-dialog\";\r\n\r\ninterface ConfirmationDialogProps {\r\n  open: boolean;\r\n  onOpenChange: (open: boolean) => void;\r\n  title: string;\r\n  description: string;\r\n  confirmText?: string;\r\n  cancelText?: string;\r\n  onConfirm: () => void;\r\n  variant?: \"default\" | \"destructive\";\r\n}\r\n\r\nexport function ConfirmationDialog({\r\n  open,\r\n  onOpenChange,\r\n  title,\r\n  description,\r\n  confirmText = \"Confirmar\",\r\n  cancelText = \"Cancelar\",\r\n  onConfirm,\r\n  variant = \"default\",\r\n}: ConfirmationDialogProps) {\r\n  const handleConfirm = () => {\r\n    onConfirm();\r\n    onOpenChange(false);\r\n  };\r\n\r\n  return (\r\n    <AlertDialog open={open} onOpenChange={onOpenChange}>\r\n      <AlertDialogContent>\r\n        <AlertDialogHeader>\r\n          <AlertDialogTitle>{title}</AlertDialogTitle>\r\n          <AlertDialogDescription>{description}</AlertDialogDescription>\r\n        </AlertDialogHeader>\r\n        <AlertDialogFooter>\r\n          <AlertDialogCancel>{cancelText}</AlertDialogCancel>\r\n          <AlertDialogAction\r\n            onClick={handleConfirm}\r\n            className={\r\n              variant === \"destructive\" ? \"bg-red-600 hover:bg-red-700\" : \"\"\r\n            }\r\n          >\r\n            {confirmText}\r\n          </AlertDialogAction>\r\n        </AlertDialogFooter>\r\n      </AlertDialogContent>\r\n    </AlertDialog>\r\n  );\r\n}\r\n\r\n// Hook para usar el di├ílogo de confirmaci├│n\r\nexport function useConfirmationDialog() {\r\n  const [dialogState, setDialogState] = React.useState<{\r\n    open: boolean;\r\n    title: string;\r\n    description: string;\r\n    onConfirm: () => void;\r\n    variant?: \"default\" | \"destructive\";\r\n  }>({\r\n    open: false,\r\n    title: \"\",\r\n    description: \"\",\r\n    onConfirm: () => {},\r\n    variant: \"default\",\r\n  });\r\n\r\n  const showConfirmation = React.useCallback(\r\n    (\r\n      title: string,\r\n      description: string,\r\n      onConfirm: () => void,\r\n      variant: \"default\" | \"destructive\" = \"default\"\r\n    ) => {\r\n      setDialogState({\r\n        open: true,\r\n        title,\r\n        description,\r\n        onConfirm,\r\n        variant,\r\n      });\r\n    },\r\n    []\r\n  );\r\n\r\n  const hideConfirmation = React.useCallback(() => {\r\n    setDialogState((prev) => ({ ...prev, open: false }));\r\n  }, []);\r\n\r\n  const ConfirmationDialogComponent = React.useCallback(\r\n    () => (\r\n      <ConfirmationDialog\r\n        open={dialogState.open}\r\n        onOpenChange={hideConfirmation}\r\n        title={dialogState.title}\r\n        description={dialogState.description}\r\n        onConfirm={dialogState.onConfirm}\r\n        variant={dialogState.variant}\r\n      />\r\n    ),\r\n    [dialogState, hideConfirmation]\r\n  );\r\n\r\n  return {\r\n    showConfirmation,\r\n    hideConfirmation,\r\n    ConfirmationDialog: ConfirmationDialogComponent,\r\n  };\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\oswal\\OneDrive\\Documentos\\Punto Cambio\\punto_cambio_new\\src\\components\\ui\\context-menu.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\oswal\\OneDrive\\Documentos\\Punto Cambio\\punto_cambio_new\\src\\components\\ui\\currency-search-select.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\oswal\\OneDrive\\Documentos\\Punto Cambio\\punto_cambio_new\\src\\components\\ui\\customer-search.tsx","messages":[{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'err' is defined but never used.","line":66,"column":16,"nodeType":null,"messageId":"unusedVar","endLine":66,"endColumn":19}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":1,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import { useState, useEffect, useRef } from \"react\";\r\nimport { Search, User, Clock, FileText } from \"lucide-react\";\r\nimport { Input } from \"@/components/ui/input\";\r\nimport { Button } from \"@/components/ui/button\";\r\nimport { Card, CardContent } from \"@/components/ui/card\";\r\nimport { Badge } from \"@/components/ui/badge\";\r\nimport { exchangeService, ClienteEncontrado } from \"@/services/exchangeService\";\r\nimport { DatosCliente } from \"@/types\";\r\n\r\ninterface CustomerSearchProps {\r\n  onSelectCustomer: (customer: DatosCliente) => void;\r\n  placeholder?: string;\r\n}\r\n\r\nconst CustomerSearch = ({\r\n  onSelectCustomer,\r\n  placeholder = \"Buscar cliente por nombre o c├®dula...\",\r\n}: CustomerSearchProps) => {\r\n  const [searchTerm, setSearchTerm] = useState(\"\");\r\n  const [customers, setCustomers] = useState<ClienteEncontrado[]>([]);\r\n  const [isLoading, setIsLoading] = useState(false);\r\n  const [isOpen, setIsOpen] = useState(false);\r\n  const [error, setError] = useState<string | null>(null);\r\n  const searchRef = useRef<HTMLDivElement>(null);\r\n  const inputRef = useRef<HTMLInputElement>(null);\r\n\r\n  // Cerrar dropdown cuando se hace clic fuera\r\n  useEffect(() => {\r\n    const handleClickOutside = (event: MouseEvent) => {\r\n      if (\r\n        searchRef.current &&\r\n        !searchRef.current.contains(event.target as Node)\r\n      ) {\r\n        setIsOpen(false);\r\n      }\r\n    };\r\n\r\n    document.addEventListener(\"mousedown\", handleClickOutside);\r\n    return () => document.removeEventListener(\"mousedown\", handleClickOutside);\r\n  }, []);\r\n\r\n  // Buscar clientes cuando cambia el t├®rmino de b├║squeda\r\n  useEffect(() => {\r\n    const searchCustomers = async () => {\r\n      if (searchTerm.trim().length < 2) {\r\n        setCustomers([]);\r\n        setIsOpen(false);\r\n        return;\r\n      }\r\n\r\n      setIsLoading(true);\r\n      setError(null);\r\n\r\n      try {\r\n        const { clientes, error } = await exchangeService.searchCustomers(\r\n          searchTerm\r\n        );\r\n\r\n        if (error) {\r\n          setError(error);\r\n          setCustomers([]);\r\n        } else {\r\n          setCustomers(clientes);\r\n          setIsOpen(clientes.length > 0);\r\n        }\r\n      } catch (err) {\r\n        setError(\"Error al buscar clientes\");\r\n        setCustomers([]);\r\n      } finally {\r\n        setIsLoading(false);\r\n      }\r\n    };\r\n\r\n    const timeoutId = setTimeout(searchCustomers, 300); // Debounce\r\n    return () => clearTimeout(timeoutId);\r\n  }, [searchTerm]);\r\n\r\n  const handleSelectCustomer = (customer: ClienteEncontrado) => {\r\n    const customerData: DatosCliente = {\r\n      nombre: customer.nombre,\r\n      apellido: customer.apellido,\r\n      documento: customer.cedula,\r\n      cedula: customer.cedula,\r\n      telefono: customer.telefono,\r\n    };\r\n\r\n    onSelectCustomer(customerData);\r\n    setSearchTerm(`${customer.nombre} ${customer.apellido}`);\r\n    setIsOpen(false);\r\n  };\r\n\r\n  const formatDate = (dateString: string) => {\r\n    return new Date(dateString).toLocaleDateString(\"es-ES\", {\r\n      day: \"2-digit\",\r\n      month: \"2-digit\",\r\n      year: \"numeric\",\r\n    });\r\n  };\r\n\r\n  const clearSearch = () => {\r\n    setSearchTerm(\"\");\r\n    setCustomers([]);\r\n    setIsOpen(false);\r\n    inputRef.current?.focus();\r\n  };\r\n\r\n  return (\r\n    <div ref={searchRef} className=\"relative w-full\">\r\n      <div className=\"relative\">\r\n        <Search className=\"absolute left-3 top-1/2 transform -translate-y-1/2 text-gray-400 h-4 w-4\" />\r\n        <Input\r\n          ref={inputRef}\r\n          type=\"text\"\r\n          placeholder={placeholder}\r\n          value={searchTerm}\r\n          onChange={(e) => setSearchTerm(e.target.value)}\r\n          className=\"pl-10 pr-20 h-10\"\r\n          onFocus={() => {\r\n            if (customers.length > 0) {\r\n              setIsOpen(true);\r\n            }\r\n          }}\r\n        />\r\n        {searchTerm && (\r\n          <Button\r\n            type=\"button\"\r\n            variant=\"ghost\"\r\n            size=\"sm\"\r\n            onClick={clearSearch}\r\n            className=\"absolute right-2 top-1/2 transform -translate-y-1/2 h-6 w-6 p-0 hover:bg-gray-100\"\r\n          >\r\n            ├ù\r\n          </Button>\r\n        )}\r\n      </div>\r\n\r\n      {/* Dropdown de resultados */}\r\n      {isOpen && (\r\n        <Card className=\"absolute top-full left-0 right-0 z-50 mt-1 max-h-80 overflow-y-auto shadow-lg border\">\r\n          <CardContent className=\"p-0\">\r\n            {isLoading && (\r\n              <div className=\"p-4 text-center text-gray-500\">\r\n                <div className=\"animate-spin h-5 w-5 border-2 border-blue-500 border-t-transparent rounded-full mx-auto mb-2\"></div>\r\n                Buscando clientes...\r\n              </div>\r\n            )}\r\n\r\n            {error && (\r\n              <div className=\"p-4 text-center text-red-500\">{error}</div>\r\n            )}\r\n\r\n            {!isLoading &&\r\n              !error &&\r\n              customers.length === 0 &&\r\n              searchTerm.length >= 2 && (\r\n                <div className=\"p-4 text-center text-gray-500\">\r\n                  <User className=\"h-8 w-8 mx-auto mb-2 text-gray-300\" />\r\n                  No se encontraron clientes\r\n                </div>\r\n              )}\r\n\r\n            {!isLoading && !error && customers.length > 0 && (\r\n              <div className=\"divide-y\">\r\n                {customers.map((customer) => (\r\n                  <div\r\n                    key={`${customer.fuente}-${customer.id}`}\r\n                    className=\"p-3 hover:bg-gray-50 cursor-pointer transition-colors\"\r\n                    onClick={() => handleSelectCustomer(customer)}\r\n                  >\r\n                    <div className=\"flex items-start justify-between\">\r\n                      <div className=\"flex-1\">\r\n                        <div className=\"flex items-center gap-2 mb-1\">\r\n                          <User className=\"h-4 w-4 text-blue-500\" />\r\n                          <span className=\"font-medium text-gray-900\">\r\n                            {customer.nombre} {customer.apellido}\r\n                          </span>\r\n                          <Badge\r\n                            variant={\r\n                              customer.fuente === \"recibo\"\r\n                                ? \"default\"\r\n                                : \"secondary\"\r\n                            }\r\n                            className=\"text-xs\"\r\n                          >\r\n                            {customer.fuente === \"recibo\"\r\n                              ? \"Completo\"\r\n                              : \"B├ísico\"}\r\n                          </Badge>\r\n                        </div>\r\n\r\n                        <div className=\"text-sm text-gray-600 space-y-1\">\r\n                          {customer.cedula && (\r\n                            <div>\r\n                              <span className=\"font-medium\">C├®dula:</span>{\" \"}\r\n                              {customer.cedula}\r\n                            </div>\r\n                          )}\r\n                          {customer.telefono && (\r\n                            <div>\r\n                              <span className=\"font-medium\">Tel├®fono:</span>{\" \"}\r\n                              {customer.telefono}\r\n                            </div>\r\n                          )}\r\n                        </div>\r\n                      </div>\r\n\r\n                      <div className=\"text-right text-xs text-gray-500 ml-4\">\r\n                        <div className=\"flex items-center gap-1 mb-1\">\r\n                          <Clock className=\"h-3 w-3\" />\r\n                          {formatDate(customer.fecha_ultima_operacion)}\r\n                        </div>\r\n                        {customer.numero_recibo && (\r\n                          <div className=\"flex items-center gap-1\">\r\n                            <FileText className=\"h-3 w-3\" />\r\n                            {customer.numero_recibo}\r\n                          </div>\r\n                        )}\r\n                      </div>\r\n                    </div>\r\n                  </div>\r\n                ))}\r\n              </div>\r\n            )}\r\n          </CardContent>\r\n        </Card>\r\n      )}\r\n    </div>\r\n  );\r\n};\r\n\r\nexport default CustomerSearch;\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\oswal\\OneDrive\\Documentos\\Punto Cambio\\punto_cambio_new\\src\\components\\ui\\data-table.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\oswal\\OneDrive\\Documentos\\Punto Cambio\\punto_cambio_new\\src\\components\\ui\\dialog.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\oswal\\OneDrive\\Documentos\\Punto Cambio\\punto_cambio_new\\src\\components\\ui\\drawer.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\oswal\\OneDrive\\Documentos\\Punto Cambio\\punto_cambio_new\\src\\components\\ui\\dropdown-menu.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\oswal\\OneDrive\\Documentos\\Punto Cambio\\punto_cambio_new\\src\\components\\ui\\form.tsx","messages":[{"ruleId":"react-refresh/only-export-components","severity":1,"message":"Fast refresh only works when a file only exports components. Use a new file to share constants or functions between components.","line":168,"column":3,"nodeType":"Identifier","messageId":"namedExport","endLine":168,"endColumn":15}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":1,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import * as React from \"react\"\r\nimport * as LabelPrimitive from \"@radix-ui/react-label\"\r\nimport { Slot } from \"@radix-ui/react-slot\"\r\nimport {\r\n  Controller,\r\n  ControllerProps,\r\n  FieldPath,\r\n  FieldValues,\r\n  FormProvider,\r\n  useFormContext,\r\n} from \"react-hook-form\"\r\n\r\nimport { cn } from \"@/lib/utils\"\r\nimport { Label } from \"@/components/ui/label\"\r\n\r\nconst Form = FormProvider\r\n\r\ntype FormFieldContextValue<\r\n  TFieldValues extends FieldValues = FieldValues,\r\n  TName extends FieldPath<TFieldValues> = FieldPath<TFieldValues>\r\n> = {\r\n  name: TName\r\n}\r\n\r\nconst FormFieldContext = React.createContext<FormFieldContextValue>(\r\n  {} as FormFieldContextValue\r\n)\r\n\r\nconst FormField = <\r\n  TFieldValues extends FieldValues = FieldValues,\r\n  TName extends FieldPath<TFieldValues> = FieldPath<TFieldValues>\r\n>({\r\n  ...props\r\n}: ControllerProps<TFieldValues, TName>) => {\r\n  return (\r\n    <FormFieldContext.Provider value={{ name: props.name }}>\r\n      <Controller {...props} />\r\n    </FormFieldContext.Provider>\r\n  )\r\n}\r\n\r\nconst useFormField = () => {\r\n  const fieldContext = React.useContext(FormFieldContext)\r\n  const itemContext = React.useContext(FormItemContext)\r\n  const { getFieldState, formState } = useFormContext()\r\n\r\n  const fieldState = getFieldState(fieldContext.name, formState)\r\n\r\n  if (!fieldContext) {\r\n    throw new Error(\"useFormField should be used within <FormField>\")\r\n  }\r\n\r\n  const { id } = itemContext\r\n\r\n  return {\r\n    id,\r\n    name: fieldContext.name,\r\n    formItemId: `${id}-form-item`,\r\n    formDescriptionId: `${id}-form-item-description`,\r\n    formMessageId: `${id}-form-item-message`,\r\n    ...fieldState,\r\n  }\r\n}\r\n\r\ntype FormItemContextValue = {\r\n  id: string\r\n}\r\n\r\nconst FormItemContext = React.createContext<FormItemContextValue>(\r\n  {} as FormItemContextValue\r\n)\r\n\r\nconst FormItem = React.forwardRef<\r\n  HTMLDivElement,\r\n  React.HTMLAttributes<HTMLDivElement>\r\n>(({ className, ...props }, ref) => {\r\n  const id = React.useId()\r\n\r\n  return (\r\n    <FormItemContext.Provider value={{ id }}>\r\n      <div ref={ref} className={cn(\"space-y-2\", className)} {...props} />\r\n    </FormItemContext.Provider>\r\n  )\r\n})\r\nFormItem.displayName = \"FormItem\"\r\n\r\nconst FormLabel = React.forwardRef<\r\n  React.ElementRef<typeof LabelPrimitive.Root>,\r\n  React.ComponentPropsWithoutRef<typeof LabelPrimitive.Root>\r\n>(({ className, ...props }, ref) => {\r\n  const { error, formItemId } = useFormField()\r\n\r\n  return (\r\n    <Label\r\n      ref={ref}\r\n      className={cn(error && \"text-destructive\", className)}\r\n      htmlFor={formItemId}\r\n      {...props}\r\n    />\r\n  )\r\n})\r\nFormLabel.displayName = \"FormLabel\"\r\n\r\nconst FormControl = React.forwardRef<\r\n  React.ElementRef<typeof Slot>,\r\n  React.ComponentPropsWithoutRef<typeof Slot>\r\n>(({ ...props }, ref) => {\r\n  const { error, formItemId, formDescriptionId, formMessageId } = useFormField()\r\n\r\n  return (\r\n    <Slot\r\n      ref={ref}\r\n      id={formItemId}\r\n      aria-describedby={\r\n        !error\r\n          ? `${formDescriptionId}`\r\n          : `${formDescriptionId} ${formMessageId}`\r\n      }\r\n      aria-invalid={!!error}\r\n      {...props}\r\n    />\r\n  )\r\n})\r\nFormControl.displayName = \"FormControl\"\r\n\r\nconst FormDescription = React.forwardRef<\r\n  HTMLParagraphElement,\r\n  React.HTMLAttributes<HTMLParagraphElement>\r\n>(({ className, ...props }, ref) => {\r\n  const { formDescriptionId } = useFormField()\r\n\r\n  return (\r\n    <p\r\n      ref={ref}\r\n      id={formDescriptionId}\r\n      className={cn(\"text-sm text-muted-foreground\", className)}\r\n      {...props}\r\n    />\r\n  )\r\n})\r\nFormDescription.displayName = \"FormDescription\"\r\n\r\nconst FormMessage = React.forwardRef<\r\n  HTMLParagraphElement,\r\n  React.HTMLAttributes<HTMLParagraphElement>\r\n>(({ className, children, ...props }, ref) => {\r\n  const { error, formMessageId } = useFormField()\r\n  const body = error ? String(error?.message) : children\r\n\r\n  if (!body) {\r\n    return null\r\n  }\r\n\r\n  return (\r\n    <p\r\n      ref={ref}\r\n      id={formMessageId}\r\n      className={cn(\"text-sm font-medium text-destructive\", className)}\r\n      {...props}\r\n    >\r\n      {body}\r\n    </p>\r\n  )\r\n})\r\nFormMessage.displayName = \"FormMessage\"\r\n\r\nexport {\r\n  useFormField,\r\n  Form,\r\n  FormItem,\r\n  FormLabel,\r\n  FormControl,\r\n  FormDescription,\r\n  FormMessage,\r\n  FormField,\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\oswal\\OneDrive\\Documentos\\Punto Cambio\\punto_cambio_new\\src\\components\\ui\\hover-card.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\oswal\\OneDrive\\Documentos\\Punto Cambio\\punto_cambio_new\\src\\components\\ui\\input-otp.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\oswal\\OneDrive\\Documentos\\Punto Cambio\\punto_cambio_new\\src\\components\\ui\\input.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\oswal\\OneDrive\\Documentos\\Punto Cambio\\punto_cambio_new\\src\\components\\ui\\label.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\oswal\\OneDrive\\Documentos\\Punto Cambio\\punto_cambio_new\\src\\components\\ui\\loading.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\oswal\\OneDrive\\Documentos\\Punto Cambio\\punto_cambio_new\\src\\components\\ui\\menubar.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\oswal\\OneDrive\\Documentos\\Punto Cambio\\punto_cambio_new\\src\\components\\ui\\navigation-menu.tsx","messages":[{"ruleId":"react-refresh/only-export-components","severity":1,"message":"Fast refresh only works when a file only exports components. Use a new file to share constants or functions between components.","line":119,"column":3,"nodeType":"Identifier","messageId":"namedExport","endLine":119,"endColumn":29}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":1,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import * as React from \"react\"\r\nimport * as NavigationMenuPrimitive from \"@radix-ui/react-navigation-menu\"\r\nimport { cva } from \"class-variance-authority\"\r\nimport { ChevronDown } from \"lucide-react\"\r\n\r\nimport { cn } from \"@/lib/utils\"\r\n\r\nconst NavigationMenu = React.forwardRef<\r\n  React.ElementRef<typeof NavigationMenuPrimitive.Root>,\r\n  React.ComponentPropsWithoutRef<typeof NavigationMenuPrimitive.Root>\r\n>(({ className, children, ...props }, ref) => (\r\n  <NavigationMenuPrimitive.Root\r\n    ref={ref}\r\n    className={cn(\r\n      \"relative z-10 flex max-w-max flex-1 items-center justify-center\",\r\n      className\r\n    )}\r\n    {...props}\r\n  >\r\n    {children}\r\n    <NavigationMenuViewport />\r\n  </NavigationMenuPrimitive.Root>\r\n))\r\nNavigationMenu.displayName = NavigationMenuPrimitive.Root.displayName\r\n\r\nconst NavigationMenuList = React.forwardRef<\r\n  React.ElementRef<typeof NavigationMenuPrimitive.List>,\r\n  React.ComponentPropsWithoutRef<typeof NavigationMenuPrimitive.List>\r\n>(({ className, ...props }, ref) => (\r\n  <NavigationMenuPrimitive.List\r\n    ref={ref}\r\n    className={cn(\r\n      \"group flex flex-1 list-none items-center justify-center space-x-1\",\r\n      className\r\n    )}\r\n    {...props}\r\n  />\r\n))\r\nNavigationMenuList.displayName = NavigationMenuPrimitive.List.displayName\r\n\r\nconst NavigationMenuItem = NavigationMenuPrimitive.Item\r\n\r\nconst navigationMenuTriggerStyle = cva(\r\n  \"group inline-flex h-10 w-max items-center justify-center rounded-md bg-background px-4 py-2 text-sm font-medium transition-colors hover:bg-accent hover:text-accent-foreground focus:bg-accent focus:text-accent-foreground focus:outline-none disabled:pointer-events-none disabled:opacity-50 data-[active]:bg-accent/50 data-[state=open]:bg-accent/50\"\r\n)\r\n\r\nconst NavigationMenuTrigger = React.forwardRef<\r\n  React.ElementRef<typeof NavigationMenuPrimitive.Trigger>,\r\n  React.ComponentPropsWithoutRef<typeof NavigationMenuPrimitive.Trigger>\r\n>(({ className, children, ...props }, ref) => (\r\n  <NavigationMenuPrimitive.Trigger\r\n    ref={ref}\r\n    className={cn(navigationMenuTriggerStyle(), \"group\", className)}\r\n    {...props}\r\n  >\r\n    {children}{\" \"}\r\n    <ChevronDown\r\n      className=\"relative top-[1px] ml-1 h-3 w-3 transition duration-200 group-data-[state=open]:rotate-180\"\r\n      aria-hidden=\"true\"\r\n    />\r\n  </NavigationMenuPrimitive.Trigger>\r\n))\r\nNavigationMenuTrigger.displayName = NavigationMenuPrimitive.Trigger.displayName\r\n\r\nconst NavigationMenuContent = React.forwardRef<\r\n  React.ElementRef<typeof NavigationMenuPrimitive.Content>,\r\n  React.ComponentPropsWithoutRef<typeof NavigationMenuPrimitive.Content>\r\n>(({ className, ...props }, ref) => (\r\n  <NavigationMenuPrimitive.Content\r\n    ref={ref}\r\n    className={cn(\r\n      \"left-0 top-0 w-full data-[motion^=from-]:animate-in data-[motion^=to-]:animate-out data-[motion^=from-]:fade-in data-[motion^=to-]:fade-out data-[motion=from-end]:slide-in-from-right-52 data-[motion=from-start]:slide-in-from-left-52 data-[motion=to-end]:slide-out-to-right-52 data-[motion=to-start]:slide-out-to-left-52 md:absolute md:w-auto \",\r\n      className\r\n    )}\r\n    {...props}\r\n  />\r\n))\r\nNavigationMenuContent.displayName = NavigationMenuPrimitive.Content.displayName\r\n\r\nconst NavigationMenuLink = NavigationMenuPrimitive.Link\r\n\r\nconst NavigationMenuViewport = React.forwardRef<\r\n  React.ElementRef<typeof NavigationMenuPrimitive.Viewport>,\r\n  React.ComponentPropsWithoutRef<typeof NavigationMenuPrimitive.Viewport>\r\n>(({ className, ...props }, ref) => (\r\n  <div className={cn(\"absolute left-0 top-full flex justify-center\")}>\r\n    <NavigationMenuPrimitive.Viewport\r\n      className={cn(\r\n        \"origin-top-center relative mt-1.5 h-[var(--radix-navigation-menu-viewport-height)] w-full overflow-hidden rounded-md border bg-popover text-popover-foreground shadow-lg data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:zoom-out-95 data-[state=open]:zoom-in-90 md:w-[var(--radix-navigation-menu-viewport-width)]\",\r\n        className\r\n      )}\r\n      ref={ref}\r\n      {...props}\r\n    />\r\n  </div>\r\n))\r\nNavigationMenuViewport.displayName =\r\n  NavigationMenuPrimitive.Viewport.displayName\r\n\r\nconst NavigationMenuIndicator = React.forwardRef<\r\n  React.ElementRef<typeof NavigationMenuPrimitive.Indicator>,\r\n  React.ComponentPropsWithoutRef<typeof NavigationMenuPrimitive.Indicator>\r\n>(({ className, ...props }, ref) => (\r\n  <NavigationMenuPrimitive.Indicator\r\n    ref={ref}\r\n    className={cn(\r\n      \"top-full z-[1] flex h-1.5 items-end justify-center overflow-hidden data-[state=visible]:animate-in data-[state=hidden]:animate-out data-[state=hidden]:fade-out data-[state=visible]:fade-in\",\r\n      className\r\n    )}\r\n    {...props}\r\n  >\r\n    <div className=\"relative top-[60%] h-2 w-2 rotate-45 rounded-tl-sm bg-border shadow-md\" />\r\n  </NavigationMenuPrimitive.Indicator>\r\n))\r\nNavigationMenuIndicator.displayName =\r\n  NavigationMenuPrimitive.Indicator.displayName\r\n\r\nexport {\r\n  navigationMenuTriggerStyle,\r\n  NavigationMenu,\r\n  NavigationMenuList,\r\n  NavigationMenuItem,\r\n  NavigationMenuContent,\r\n  NavigationMenuTrigger,\r\n  NavigationMenuLink,\r\n  NavigationMenuIndicator,\r\n  NavigationMenuViewport,\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\oswal\\OneDrive\\Documentos\\Punto Cambio\\punto_cambio_new\\src\\components\\ui\\pagination.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\oswal\\OneDrive\\Documentos\\Punto Cambio\\punto_cambio_new\\src\\components\\ui\\popover.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\oswal\\OneDrive\\Documentos\\Punto Cambio\\punto_cambio_new\\src\\components\\ui\\progress.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\oswal\\OneDrive\\Documentos\\Punto Cambio\\punto_cambio_new\\src\\components\\ui\\radio-group.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\oswal\\OneDrive\\Documentos\\Punto Cambio\\punto_cambio_new\\src\\components\\ui\\resizable.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\oswal\\OneDrive\\Documentos\\Punto Cambio\\punto_cambio_new\\src\\components\\ui\\scroll-area.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\oswal\\OneDrive\\Documentos\\Punto Cambio\\punto_cambio_new\\src\\components\\ui\\select.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\oswal\\OneDrive\\Documentos\\Punto Cambio\\punto_cambio_new\\src\\components\\ui\\separator.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\oswal\\OneDrive\\Documentos\\Punto Cambio\\punto_cambio_new\\src\\components\\ui\\sheet.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\oswal\\OneDrive\\Documentos\\Punto Cambio\\punto_cambio_new\\src\\components\\ui\\sidebar.tsx","messages":[{"ruleId":"react-refresh/only-export-components","severity":1,"message":"Fast refresh only works when a file only exports components. Use a new file to share constants or functions between components.","line":760,"column":3,"nodeType":"Identifier","messageId":"namedExport","endLine":760,"endColumn":13}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":1,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import * as React from \"react\"\r\nimport { Slot } from \"@radix-ui/react-slot\"\r\nimport { VariantProps, cva } from \"class-variance-authority\"\r\nimport { PanelLeft } from \"lucide-react\"\r\n\r\nimport { useIsMobile } from \"@/hooks/use-mobile\"\r\nimport { cn } from \"@/lib/utils\"\r\nimport { Button } from \"@/components/ui/button\"\r\nimport { Input } from \"@/components/ui/input\"\r\nimport { Separator } from \"@/components/ui/separator\"\r\nimport { Sheet, SheetContent } from \"@/components/ui/sheet\"\r\nimport { Skeleton } from \"@/components/ui/skeleton\"\r\nimport {\r\n  Tooltip,\r\n  TooltipContent,\r\n  TooltipProvider,\r\n  TooltipTrigger,\r\n} from \"@/components/ui/tooltip\"\r\n\r\nconst SIDEBAR_COOKIE_NAME = \"sidebar:state\"\r\nconst SIDEBAR_COOKIE_MAX_AGE = 60 * 60 * 24 * 7\r\nconst SIDEBAR_WIDTH = \"16rem\"\r\nconst SIDEBAR_WIDTH_MOBILE = \"18rem\"\r\nconst SIDEBAR_WIDTH_ICON = \"3rem\"\r\nconst SIDEBAR_KEYBOARD_SHORTCUT = \"b\"\r\n\r\ntype SidebarContext = {\r\n  state: \"expanded\" | \"collapsed\"\r\n  open: boolean\r\n  setOpen: (open: boolean) => void\r\n  openMobile: boolean\r\n  setOpenMobile: (open: boolean) => void\r\n  isMobile: boolean\r\n  toggleSidebar: () => void\r\n}\r\n\r\nconst SidebarContext = React.createContext<SidebarContext | null>(null)\r\n\r\nfunction useSidebar() {\r\n  const context = React.useContext(SidebarContext)\r\n  if (!context) {\r\n    throw new Error(\"useSidebar must be used within a SidebarProvider.\")\r\n  }\r\n\r\n  return context\r\n}\r\n\r\nconst SidebarProvider = React.forwardRef<\r\n  HTMLDivElement,\r\n  React.ComponentProps<\"div\"> & {\r\n    defaultOpen?: boolean\r\n    open?: boolean\r\n    onOpenChange?: (open: boolean) => void\r\n  }\r\n>(\r\n  (\r\n    {\r\n      defaultOpen = true,\r\n      open: openProp,\r\n      onOpenChange: setOpenProp,\r\n      className,\r\n      style,\r\n      children,\r\n      ...props\r\n    },\r\n    ref\r\n  ) => {\r\n    const isMobile = useIsMobile()\r\n    const [openMobile, setOpenMobile] = React.useState(false)\r\n\r\n    // This is the internal state of the sidebar.\r\n    // We use openProp and setOpenProp for control from outside the component.\r\n    const [_open, _setOpen] = React.useState(defaultOpen)\r\n    const open = openProp ?? _open\r\n    const setOpen = React.useCallback(\r\n      (value: boolean | ((value: boolean) => boolean)) => {\r\n        const openState = typeof value === \"function\" ? value(open) : value\r\n        if (setOpenProp) {\r\n          setOpenProp(openState)\r\n        } else {\r\n          _setOpen(openState)\r\n        }\r\n\r\n        // This sets the cookie to keep the sidebar state.\r\n        document.cookie = `${SIDEBAR_COOKIE_NAME}=${openState}; path=/; max-age=${SIDEBAR_COOKIE_MAX_AGE}`\r\n      },\r\n      [setOpenProp, open]\r\n    )\r\n\r\n    // Helper to toggle the sidebar.\r\n    const toggleSidebar = React.useCallback(() => {\r\n      return isMobile\r\n        ? setOpenMobile((open) => !open)\r\n        : setOpen((open) => !open)\r\n    }, [isMobile, setOpen, setOpenMobile])\r\n\r\n    // Adds a keyboard shortcut to toggle the sidebar.\r\n    React.useEffect(() => {\r\n      const handleKeyDown = (event: KeyboardEvent) => {\r\n        if (\r\n          event.key === SIDEBAR_KEYBOARD_SHORTCUT &&\r\n          (event.metaKey || event.ctrlKey)\r\n        ) {\r\n          event.preventDefault()\r\n          toggleSidebar()\r\n        }\r\n      }\r\n\r\n      window.addEventListener(\"keydown\", handleKeyDown)\r\n      return () => window.removeEventListener(\"keydown\", handleKeyDown)\r\n    }, [toggleSidebar])\r\n\r\n    // We add a state so that we can do data-state=\"expanded\" or \"collapsed\".\r\n    // This makes it easier to style the sidebar with Tailwind classes.\r\n    const state = open ? \"expanded\" : \"collapsed\"\r\n\r\n    const contextValue = React.useMemo<SidebarContext>(\r\n      () => ({\r\n        state,\r\n        open,\r\n        setOpen,\r\n        isMobile,\r\n        openMobile,\r\n        setOpenMobile,\r\n        toggleSidebar,\r\n      }),\r\n      [state, open, setOpen, isMobile, openMobile, setOpenMobile, toggleSidebar]\r\n    )\r\n\r\n    return (\r\n      <SidebarContext.Provider value={contextValue}>\r\n        <TooltipProvider delayDuration={0}>\r\n          <div\r\n            style={\r\n              {\r\n                \"--sidebar-width\": SIDEBAR_WIDTH,\r\n                \"--sidebar-width-icon\": SIDEBAR_WIDTH_ICON,\r\n                ...style,\r\n              } as React.CSSProperties\r\n            }\r\n            className={cn(\r\n              \"group/sidebar-wrapper flex min-h-svh w-full has-[[data-variant=inset]]:bg-sidebar\",\r\n              className\r\n            )}\r\n            ref={ref}\r\n            {...props}\r\n          >\r\n            {children}\r\n          </div>\r\n        </TooltipProvider>\r\n      </SidebarContext.Provider>\r\n    )\r\n  }\r\n)\r\nSidebarProvider.displayName = \"SidebarProvider\"\r\n\r\nconst Sidebar = React.forwardRef<\r\n  HTMLDivElement,\r\n  React.ComponentProps<\"div\"> & {\r\n    side?: \"left\" | \"right\"\r\n    variant?: \"sidebar\" | \"floating\" | \"inset\"\r\n    collapsible?: \"offcanvas\" | \"icon\" | \"none\"\r\n  }\r\n>(\r\n  (\r\n    {\r\n      side = \"left\",\r\n      variant = \"sidebar\",\r\n      collapsible = \"offcanvas\",\r\n      className,\r\n      children,\r\n      ...props\r\n    },\r\n    ref\r\n  ) => {\r\n    const { isMobile, state, openMobile, setOpenMobile } = useSidebar()\r\n\r\n    if (collapsible === \"none\") {\r\n      return (\r\n        <div\r\n          className={cn(\r\n            \"flex h-full w-[--sidebar-width] flex-col bg-sidebar text-sidebar-foreground\",\r\n            className\r\n          )}\r\n          ref={ref}\r\n          {...props}\r\n        >\r\n          {children}\r\n        </div>\r\n      )\r\n    }\r\n\r\n    if (isMobile) {\r\n      return (\r\n        <Sheet open={openMobile} onOpenChange={setOpenMobile} {...props}>\r\n          <SheetContent\r\n            data-sidebar=\"sidebar\"\r\n            data-mobile=\"true\"\r\n            className=\"w-[--sidebar-width] bg-sidebar p-0 text-sidebar-foreground [&>button]:hidden\"\r\n            style={\r\n              {\r\n                \"--sidebar-width\": SIDEBAR_WIDTH_MOBILE,\r\n              } as React.CSSProperties\r\n            }\r\n            side={side}\r\n          >\r\n            <div className=\"flex h-full w-full flex-col\">{children}</div>\r\n          </SheetContent>\r\n        </Sheet>\r\n      )\r\n    }\r\n\r\n    return (\r\n      <div\r\n        ref={ref}\r\n        className=\"group peer hidden md:block text-sidebar-foreground\"\r\n        data-state={state}\r\n        data-collapsible={state === \"collapsed\" ? collapsible : \"\"}\r\n        data-variant={variant}\r\n        data-side={side}\r\n      >\r\n        {/* This is what handles the sidebar gap on desktop */}\r\n        <div\r\n          className={cn(\r\n            \"duration-200 relative h-svh w-[--sidebar-width] bg-transparent transition-[width] ease-linear\",\r\n            \"group-data-[collapsible=offcanvas]:w-0\",\r\n            \"group-data-[side=right]:rotate-180\",\r\n            variant === \"floating\" || variant === \"inset\"\r\n              ? \"group-data-[collapsible=icon]:w-[calc(var(--sidebar-width-icon)_+_theme(spacing.4))]\"\r\n              : \"group-data-[collapsible=icon]:w-[--sidebar-width-icon]\"\r\n          )}\r\n        />\r\n        <div\r\n          className={cn(\r\n            \"duration-200 fixed inset-y-0 z-10 hidden h-svh w-[--sidebar-width] transition-[left,right,width] ease-linear md:flex\",\r\n            side === \"left\"\r\n              ? \"left-0 group-data-[collapsible=offcanvas]:left-[calc(var(--sidebar-width)*-1)]\"\r\n              : \"right-0 group-data-[collapsible=offcanvas]:right-[calc(var(--sidebar-width)*-1)]\",\r\n            // Adjust the padding for floating and inset variants.\r\n            variant === \"floating\" || variant === \"inset\"\r\n              ? \"p-2 group-data-[collapsible=icon]:w-[calc(var(--sidebar-width-icon)_+_theme(spacing.4)_+2px)]\"\r\n              : \"group-data-[collapsible=icon]:w-[--sidebar-width-icon] group-data-[side=left]:border-r group-data-[side=right]:border-l\",\r\n            className\r\n          )}\r\n          {...props}\r\n        >\r\n          <div\r\n            data-sidebar=\"sidebar\"\r\n            className=\"flex h-full w-full flex-col bg-sidebar group-data-[variant=floating]:rounded-lg group-data-[variant=floating]:border group-data-[variant=floating]:border-sidebar-border group-data-[variant=floating]:shadow\"\r\n          >\r\n            {children}\r\n          </div>\r\n        </div>\r\n      </div>\r\n    )\r\n  }\r\n)\r\nSidebar.displayName = \"Sidebar\"\r\n\r\nconst SidebarTrigger = React.forwardRef<\r\n  React.ElementRef<typeof Button>,\r\n  React.ComponentProps<typeof Button>\r\n>(({ className, onClick, ...props }, ref) => {\r\n  const { toggleSidebar } = useSidebar()\r\n\r\n  return (\r\n    <Button\r\n      ref={ref}\r\n      data-sidebar=\"trigger\"\r\n      variant=\"ghost\"\r\n      size=\"icon\"\r\n      className={cn(\"h-7 w-7\", className)}\r\n      onClick={(event) => {\r\n        onClick?.(event)\r\n        toggleSidebar()\r\n      }}\r\n      {...props}\r\n    >\r\n      <PanelLeft />\r\n      <span className=\"sr-only\">Toggle Sidebar</span>\r\n    </Button>\r\n  )\r\n})\r\nSidebarTrigger.displayName = \"SidebarTrigger\"\r\n\r\nconst SidebarRail = React.forwardRef<\r\n  HTMLButtonElement,\r\n  React.ComponentProps<\"button\">\r\n>(({ className, ...props }, ref) => {\r\n  const { toggleSidebar } = useSidebar()\r\n\r\n  return (\r\n    <button\r\n      ref={ref}\r\n      data-sidebar=\"rail\"\r\n      aria-label=\"Toggle Sidebar\"\r\n      tabIndex={-1}\r\n      onClick={toggleSidebar}\r\n      title=\"Toggle Sidebar\"\r\n      className={cn(\r\n        \"absolute inset-y-0 z-20 hidden w-4 -translate-x-1/2 transition-all ease-linear after:absolute after:inset-y-0 after:left-1/2 after:w-[2px] hover:after:bg-sidebar-border group-data-[side=left]:-right-4 group-data-[side=right]:left-0 sm:flex\",\r\n        \"[[data-side=left]_&]:cursor-w-resize [[data-side=right]_&]:cursor-e-resize\",\r\n        \"[[data-side=left][data-state=collapsed]_&]:cursor-e-resize [[data-side=right][data-state=collapsed]_&]:cursor-w-resize\",\r\n        \"group-data-[collapsible=offcanvas]:translate-x-0 group-data-[collapsible=offcanvas]:after:left-full group-data-[collapsible=offcanvas]:hover:bg-sidebar\",\r\n        \"[[data-side=left][data-collapsible=offcanvas]_&]:-right-2\",\r\n        \"[[data-side=right][data-collapsible=offcanvas]_&]:-left-2\",\r\n        className\r\n      )}\r\n      {...props}\r\n    />\r\n  )\r\n})\r\nSidebarRail.displayName = \"SidebarRail\"\r\n\r\nconst SidebarInset = React.forwardRef<\r\n  HTMLDivElement,\r\n  React.ComponentProps<\"main\">\r\n>(({ className, ...props }, ref) => {\r\n  return (\r\n    <main\r\n      ref={ref}\r\n      className={cn(\r\n        \"relative flex min-h-svh flex-1 flex-col bg-background\",\r\n        \"peer-data-[variant=inset]:min-h-[calc(100svh-theme(spacing.4))] md:peer-data-[variant=inset]:m-2 md:peer-data-[state=collapsed]:peer-data-[variant=inset]:ml-2 md:peer-data-[variant=inset]:ml-0 md:peer-data-[variant=inset]:rounded-xl md:peer-data-[variant=inset]:shadow\",\r\n        className\r\n      )}\r\n      {...props}\r\n    />\r\n  )\r\n})\r\nSidebarInset.displayName = \"SidebarInset\"\r\n\r\nconst SidebarInput = React.forwardRef<\r\n  React.ElementRef<typeof Input>,\r\n  React.ComponentProps<typeof Input>\r\n>(({ className, ...props }, ref) => {\r\n  return (\r\n    <Input\r\n      ref={ref}\r\n      data-sidebar=\"input\"\r\n      className={cn(\r\n        \"h-8 w-full bg-background shadow-none focus-visible:ring-2 focus-visible:ring-sidebar-ring\",\r\n        className\r\n      )}\r\n      {...props}\r\n    />\r\n  )\r\n})\r\nSidebarInput.displayName = \"SidebarInput\"\r\n\r\nconst SidebarHeader = React.forwardRef<\r\n  HTMLDivElement,\r\n  React.ComponentProps<\"div\">\r\n>(({ className, ...props }, ref) => {\r\n  return (\r\n    <div\r\n      ref={ref}\r\n      data-sidebar=\"header\"\r\n      className={cn(\"flex flex-col gap-2 p-2\", className)}\r\n      {...props}\r\n    />\r\n  )\r\n})\r\nSidebarHeader.displayName = \"SidebarHeader\"\r\n\r\nconst SidebarFooter = React.forwardRef<\r\n  HTMLDivElement,\r\n  React.ComponentProps<\"div\">\r\n>(({ className, ...props }, ref) => {\r\n  return (\r\n    <div\r\n      ref={ref}\r\n      data-sidebar=\"footer\"\r\n      className={cn(\"flex flex-col gap-2 p-2\", className)}\r\n      {...props}\r\n    />\r\n  )\r\n})\r\nSidebarFooter.displayName = \"SidebarFooter\"\r\n\r\nconst SidebarSeparator = React.forwardRef<\r\n  React.ElementRef<typeof Separator>,\r\n  React.ComponentProps<typeof Separator>\r\n>(({ className, ...props }, ref) => {\r\n  return (\r\n    <Separator\r\n      ref={ref}\r\n      data-sidebar=\"separator\"\r\n      className={cn(\"mx-2 w-auto bg-sidebar-border\", className)}\r\n      {...props}\r\n    />\r\n  )\r\n})\r\nSidebarSeparator.displayName = \"SidebarSeparator\"\r\n\r\nconst SidebarContent = React.forwardRef<\r\n  HTMLDivElement,\r\n  React.ComponentProps<\"div\">\r\n>(({ className, ...props }, ref) => {\r\n  return (\r\n    <div\r\n      ref={ref}\r\n      data-sidebar=\"content\"\r\n      className={cn(\r\n        \"flex min-h-0 flex-1 flex-col gap-2 overflow-auto group-data-[collapsible=icon]:overflow-hidden\",\r\n        className\r\n      )}\r\n      {...props}\r\n    />\r\n  )\r\n})\r\nSidebarContent.displayName = \"SidebarContent\"\r\n\r\nconst SidebarGroup = React.forwardRef<\r\n  HTMLDivElement,\r\n  React.ComponentProps<\"div\">\r\n>(({ className, ...props }, ref) => {\r\n  return (\r\n    <div\r\n      ref={ref}\r\n      data-sidebar=\"group\"\r\n      className={cn(\"relative flex w-full min-w-0 flex-col p-2\", className)}\r\n      {...props}\r\n    />\r\n  )\r\n})\r\nSidebarGroup.displayName = \"SidebarGroup\"\r\n\r\nconst SidebarGroupLabel = React.forwardRef<\r\n  HTMLDivElement,\r\n  React.ComponentProps<\"div\"> & { asChild?: boolean }\r\n>(({ className, asChild = false, ...props }, ref) => {\r\n  const Comp = asChild ? Slot : \"div\"\r\n\r\n  return (\r\n    <Comp\r\n      ref={ref}\r\n      data-sidebar=\"group-label\"\r\n      className={cn(\r\n        \"duration-200 flex h-8 shrink-0 items-center rounded-md px-2 text-xs font-medium text-sidebar-foreground/70 outline-none ring-sidebar-ring transition-[margin,opa] ease-linear focus-visible:ring-2 [&>svg]:size-4 [&>svg]:shrink-0\",\r\n        \"group-data-[collapsible=icon]:-mt-8 group-data-[collapsible=icon]:opacity-0\",\r\n        className\r\n      )}\r\n      {...props}\r\n    />\r\n  )\r\n})\r\nSidebarGroupLabel.displayName = \"SidebarGroupLabel\"\r\n\r\nconst SidebarGroupAction = React.forwardRef<\r\n  HTMLButtonElement,\r\n  React.ComponentProps<\"button\"> & { asChild?: boolean }\r\n>(({ className, asChild = false, ...props }, ref) => {\r\n  const Comp = asChild ? Slot : \"button\"\r\n\r\n  return (\r\n    <Comp\r\n      ref={ref}\r\n      data-sidebar=\"group-action\"\r\n      className={cn(\r\n        \"absolute right-3 top-3.5 flex aspect-square w-5 items-center justify-center rounded-md p-0 text-sidebar-foreground outline-none ring-sidebar-ring transition-transform hover:bg-sidebar-accent hover:text-sidebar-accent-foreground focus-visible:ring-2 [&>svg]:size-4 [&>svg]:shrink-0\",\r\n        // Increases the hit area of the button on mobile.\r\n        \"after:absolute after:-inset-2 after:md:hidden\",\r\n        \"group-data-[collapsible=icon]:hidden\",\r\n        className\r\n      )}\r\n      {...props}\r\n    />\r\n  )\r\n})\r\nSidebarGroupAction.displayName = \"SidebarGroupAction\"\r\n\r\nconst SidebarGroupContent = React.forwardRef<\r\n  HTMLDivElement,\r\n  React.ComponentProps<\"div\">\r\n>(({ className, ...props }, ref) => (\r\n  <div\r\n    ref={ref}\r\n    data-sidebar=\"group-content\"\r\n    className={cn(\"w-full text-sm\", className)}\r\n    {...props}\r\n  />\r\n))\r\nSidebarGroupContent.displayName = \"SidebarGroupContent\"\r\n\r\nconst SidebarMenu = React.forwardRef<\r\n  HTMLUListElement,\r\n  React.ComponentProps<\"ul\">\r\n>(({ className, ...props }, ref) => (\r\n  <ul\r\n    ref={ref}\r\n    data-sidebar=\"menu\"\r\n    className={cn(\"flex w-full min-w-0 flex-col gap-1\", className)}\r\n    {...props}\r\n  />\r\n))\r\nSidebarMenu.displayName = \"SidebarMenu\"\r\n\r\nconst SidebarMenuItem = React.forwardRef<\r\n  HTMLLIElement,\r\n  React.ComponentProps<\"li\">\r\n>(({ className, ...props }, ref) => (\r\n  <li\r\n    ref={ref}\r\n    data-sidebar=\"menu-item\"\r\n    className={cn(\"group/menu-item relative\", className)}\r\n    {...props}\r\n  />\r\n))\r\nSidebarMenuItem.displayName = \"SidebarMenuItem\"\r\n\r\nconst sidebarMenuButtonVariants = cva(\r\n  \"peer/menu-button flex w-full items-center gap-2 overflow-hidden rounded-md p-2 text-left text-sm outline-none ring-sidebar-ring transition-[width,height,padding] hover:bg-sidebar-accent hover:text-sidebar-accent-foreground focus-visible:ring-2 active:bg-sidebar-accent active:text-sidebar-accent-foreground disabled:pointer-events-none disabled:opacity-50 group-has-[[data-sidebar=menu-action]]/menu-item:pr-8 aria-disabled:pointer-events-none aria-disabled:opacity-50 data-[active=true]:bg-sidebar-accent data-[active=true]:font-medium data-[active=true]:text-sidebar-accent-foreground data-[state=open]:hover:bg-sidebar-accent data-[state=open]:hover:text-sidebar-accent-foreground group-data-[collapsible=icon]:!size-8 group-data-[collapsible=icon]:!p-2 [&>span:last-child]:truncate [&>svg]:size-4 [&>svg]:shrink-0\",\r\n  {\r\n    variants: {\r\n      variant: {\r\n        default: \"hover:bg-sidebar-accent hover:text-sidebar-accent-foreground\",\r\n        outline:\r\n          \"bg-background shadow-[0_0_0_1px_hsl(var(--sidebar-border))] hover:bg-sidebar-accent hover:text-sidebar-accent-foreground hover:shadow-[0_0_0_1px_hsl(var(--sidebar-accent))]\",\r\n      },\r\n      size: {\r\n        default: \"h-8 text-sm\",\r\n        sm: \"h-7 text-xs\",\r\n        lg: \"h-12 text-sm group-data-[collapsible=icon]:!p-0\",\r\n      },\r\n    },\r\n    defaultVariants: {\r\n      variant: \"default\",\r\n      size: \"default\",\r\n    },\r\n  }\r\n)\r\n\r\nconst SidebarMenuButton = React.forwardRef<\r\n  HTMLButtonElement,\r\n  React.ComponentProps<\"button\"> & {\r\n    asChild?: boolean\r\n    isActive?: boolean\r\n    tooltip?: string | React.ComponentProps<typeof TooltipContent>\r\n  } & VariantProps<typeof sidebarMenuButtonVariants>\r\n>(\r\n  (\r\n    {\r\n      asChild = false,\r\n      isActive = false,\r\n      variant = \"default\",\r\n      size = \"default\",\r\n      tooltip,\r\n      className,\r\n      ...props\r\n    },\r\n    ref\r\n  ) => {\r\n    const Comp = asChild ? Slot : \"button\"\r\n    const { isMobile, state } = useSidebar()\r\n\r\n    const button = (\r\n      <Comp\r\n        ref={ref}\r\n        data-sidebar=\"menu-button\"\r\n        data-size={size}\r\n        data-active={isActive}\r\n        className={cn(sidebarMenuButtonVariants({ variant, size }), className)}\r\n        {...props}\r\n      />\r\n    )\r\n\r\n    if (!tooltip) {\r\n      return button\r\n    }\r\n\r\n    if (typeof tooltip === \"string\") {\r\n      tooltip = {\r\n        children: tooltip,\r\n      }\r\n    }\r\n\r\n    return (\r\n      <Tooltip>\r\n        <TooltipTrigger asChild>{button}</TooltipTrigger>\r\n        <TooltipContent\r\n          side=\"right\"\r\n          align=\"center\"\r\n          hidden={state !== \"collapsed\" || isMobile}\r\n          {...tooltip}\r\n        />\r\n      </Tooltip>\r\n    )\r\n  }\r\n)\r\nSidebarMenuButton.displayName = \"SidebarMenuButton\"\r\n\r\nconst SidebarMenuAction = React.forwardRef<\r\n  HTMLButtonElement,\r\n  React.ComponentProps<\"button\"> & {\r\n    asChild?: boolean\r\n    showOnHover?: boolean\r\n  }\r\n>(({ className, asChild = false, showOnHover = false, ...props }, ref) => {\r\n  const Comp = asChild ? Slot : \"button\"\r\n\r\n  return (\r\n    <Comp\r\n      ref={ref}\r\n      data-sidebar=\"menu-action\"\r\n      className={cn(\r\n        \"absolute right-1 top-1.5 flex aspect-square w-5 items-center justify-center rounded-md p-0 text-sidebar-foreground outline-none ring-sidebar-ring transition-transform hover:bg-sidebar-accent hover:text-sidebar-accent-foreground focus-visible:ring-2 peer-hover/menu-button:text-sidebar-accent-foreground [&>svg]:size-4 [&>svg]:shrink-0\",\r\n        // Increases the hit area of the button on mobile.\r\n        \"after:absolute after:-inset-2 after:md:hidden\",\r\n        \"peer-data-[size=sm]/menu-button:top-1\",\r\n        \"peer-data-[size=default]/menu-button:top-1.5\",\r\n        \"peer-data-[size=lg]/menu-button:top-2.5\",\r\n        \"group-data-[collapsible=icon]:hidden\",\r\n        showOnHover &&\r\n          \"group-focus-within/menu-item:opacity-100 group-hover/menu-item:opacity-100 data-[state=open]:opacity-100 peer-data-[active=true]/menu-button:text-sidebar-accent-foreground md:opacity-0\",\r\n        className\r\n      )}\r\n      {...props}\r\n    />\r\n  )\r\n})\r\nSidebarMenuAction.displayName = \"SidebarMenuAction\"\r\n\r\nconst SidebarMenuBadge = React.forwardRef<\r\n  HTMLDivElement,\r\n  React.ComponentProps<\"div\">\r\n>(({ className, ...props }, ref) => (\r\n  <div\r\n    ref={ref}\r\n    data-sidebar=\"menu-badge\"\r\n    className={cn(\r\n      \"absolute right-1 flex h-5 min-w-5 items-center justify-center rounded-md px-1 text-xs font-medium tabular-nums text-sidebar-foreground select-none pointer-events-none\",\r\n      \"peer-hover/menu-button:text-sidebar-accent-foreground peer-data-[active=true]/menu-button:text-sidebar-accent-foreground\",\r\n      \"peer-data-[size=sm]/menu-button:top-1\",\r\n      \"peer-data-[size=default]/menu-button:top-1.5\",\r\n      \"peer-data-[size=lg]/menu-button:top-2.5\",\r\n      \"group-data-[collapsible=icon]:hidden\",\r\n      className\r\n    )}\r\n    {...props}\r\n  />\r\n))\r\nSidebarMenuBadge.displayName = \"SidebarMenuBadge\"\r\n\r\nconst SidebarMenuSkeleton = React.forwardRef<\r\n  HTMLDivElement,\r\n  React.ComponentProps<\"div\"> & {\r\n    showIcon?: boolean\r\n  }\r\n>(({ className, showIcon = false, ...props }, ref) => {\r\n  // Random width between 50 to 90%.\r\n  const width = React.useMemo(() => {\r\n    return `${Math.floor(Math.random() * 40) + 50}%`\r\n  }, [])\r\n\r\n  return (\r\n    <div\r\n      ref={ref}\r\n      data-sidebar=\"menu-skeleton\"\r\n      className={cn(\"rounded-md h-8 flex gap-2 px-2 items-center\", className)}\r\n      {...props}\r\n    >\r\n      {showIcon && (\r\n        <Skeleton\r\n          className=\"size-4 rounded-md\"\r\n          data-sidebar=\"menu-skeleton-icon\"\r\n        />\r\n      )}\r\n      <Skeleton\r\n        className=\"h-4 flex-1 max-w-[--skeleton-width]\"\r\n        data-sidebar=\"menu-skeleton-text\"\r\n        style={\r\n          {\r\n            \"--skeleton-width\": width,\r\n          } as React.CSSProperties\r\n        }\r\n      />\r\n    </div>\r\n  )\r\n})\r\nSidebarMenuSkeleton.displayName = \"SidebarMenuSkeleton\"\r\n\r\nconst SidebarMenuSub = React.forwardRef<\r\n  HTMLUListElement,\r\n  React.ComponentProps<\"ul\">\r\n>(({ className, ...props }, ref) => (\r\n  <ul\r\n    ref={ref}\r\n    data-sidebar=\"menu-sub\"\r\n    className={cn(\r\n      \"mx-3.5 flex min-w-0 translate-x-px flex-col gap-1 border-l border-sidebar-border px-2.5 py-0.5\",\r\n      \"group-data-[collapsible=icon]:hidden\",\r\n      className\r\n    )}\r\n    {...props}\r\n  />\r\n))\r\nSidebarMenuSub.displayName = \"SidebarMenuSub\"\r\n\r\nconst SidebarMenuSubItem = React.forwardRef<\r\n  HTMLLIElement,\r\n  React.ComponentProps<\"li\">\r\n>(({ ...props }, ref) => <li ref={ref} {...props} />)\r\nSidebarMenuSubItem.displayName = \"SidebarMenuSubItem\"\r\n\r\nconst SidebarMenuSubButton = React.forwardRef<\r\n  HTMLAnchorElement,\r\n  React.ComponentProps<\"a\"> & {\r\n    asChild?: boolean\r\n    size?: \"sm\" | \"md\"\r\n    isActive?: boolean\r\n  }\r\n>(({ asChild = false, size = \"md\", isActive, className, ...props }, ref) => {\r\n  const Comp = asChild ? Slot : \"a\"\r\n\r\n  return (\r\n    <Comp\r\n      ref={ref}\r\n      data-sidebar=\"menu-sub-button\"\r\n      data-size={size}\r\n      data-active={isActive}\r\n      className={cn(\r\n        \"flex h-7 min-w-0 -translate-x-px items-center gap-2 overflow-hidden rounded-md px-2 text-sidebar-foreground outline-none ring-sidebar-ring hover:bg-sidebar-accent hover:text-sidebar-accent-foreground focus-visible:ring-2 active:bg-sidebar-accent active:text-sidebar-accent-foreground disabled:pointer-events-none disabled:opacity-50 aria-disabled:pointer-events-none aria-disabled:opacity-50 [&>span:last-child]:truncate [&>svg]:size-4 [&>svg]:shrink-0 [&>svg]:text-sidebar-accent-foreground\",\r\n        \"data-[active=true]:bg-sidebar-accent data-[active=true]:text-sidebar-accent-foreground\",\r\n        size === \"sm\" && \"text-xs\",\r\n        size === \"md\" && \"text-sm\",\r\n        \"group-data-[collapsible=icon]:hidden\",\r\n        className\r\n      )}\r\n      {...props}\r\n    />\r\n  )\r\n})\r\nSidebarMenuSubButton.displayName = \"SidebarMenuSubButton\"\r\n\r\nexport {\r\n  Sidebar,\r\n  SidebarContent,\r\n  SidebarFooter,\r\n  SidebarGroup,\r\n  SidebarGroupAction,\r\n  SidebarGroupContent,\r\n  SidebarGroupLabel,\r\n  SidebarHeader,\r\n  SidebarInput,\r\n  SidebarInset,\r\n  SidebarMenu,\r\n  SidebarMenuAction,\r\n  SidebarMenuBadge,\r\n  SidebarMenuButton,\r\n  SidebarMenuItem,\r\n  SidebarMenuSkeleton,\r\n  SidebarMenuSub,\r\n  SidebarMenuSubButton,\r\n  SidebarMenuSubItem,\r\n  SidebarProvider,\r\n  SidebarRail,\r\n  SidebarSeparator,\r\n  SidebarTrigger,\r\n  useSidebar,\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\oswal\\OneDrive\\Documentos\\Punto Cambio\\punto_cambio_new\\src\\components\\ui\\skeleton.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\oswal\\OneDrive\\Documentos\\Punto Cambio\\punto_cambio_new\\src\\components\\ui\\slider.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\oswal\\OneDrive\\Documentos\\Punto Cambio\\punto_cambio_new\\src\\components\\ui\\sonner.tsx","messages":[{"ruleId":"react-refresh/only-export-components","severity":1,"message":"Fast refresh only works when a file only exports components. Use a new file to share constants or functions between components.","line":29,"column":19,"nodeType":"Identifier","messageId":"namedExport","endLine":29,"endColumn":24}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":1,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import { useTheme } from \"next-themes\"\r\nimport { Toaster as Sonner, toast } from \"sonner\"\r\n\r\ntype ToasterProps = React.ComponentProps<typeof Sonner>\r\n\r\nconst Toaster = ({ ...props }: ToasterProps) => {\r\n  const { theme = \"system\" } = useTheme()\r\n\r\n  return (\r\n    <Sonner\r\n      theme={theme as ToasterProps[\"theme\"]}\r\n      className=\"toaster group\"\r\n      toastOptions={{\r\n        classNames: {\r\n          toast:\r\n            \"group toast group-[.toaster]:bg-background group-[.toaster]:text-foreground group-[.toaster]:border-border group-[.toaster]:shadow-lg\",\r\n          description: \"group-[.toast]:text-muted-foreground\",\r\n          actionButton:\r\n            \"group-[.toast]:bg-primary group-[.toast]:text-primary-foreground\",\r\n          cancelButton:\r\n            \"group-[.toast]:bg-muted group-[.toast]:text-muted-foreground\",\r\n        },\r\n      }}\r\n      {...props}\r\n    />\r\n  )\r\n}\r\n\r\nexport { Toaster, toast }\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\oswal\\OneDrive\\Documentos\\Punto Cambio\\punto_cambio_new\\src\\components\\ui\\switch.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\oswal\\OneDrive\\Documentos\\Punto Cambio\\punto_cambio_new\\src\\components\\ui\\table.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\oswal\\OneDrive\\Documentos\\Punto Cambio\\punto_cambio_new\\src\\components\\ui\\tabs.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\oswal\\OneDrive\\Documentos\\Punto Cambio\\punto_cambio_new\\src\\components\\ui\\textarea.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\oswal\\OneDrive\\Documentos\\Punto Cambio\\punto_cambio_new\\src\\components\\ui\\toast.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\oswal\\OneDrive\\Documentos\\Punto Cambio\\punto_cambio_new\\src\\components\\ui\\toaster.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\oswal\\OneDrive\\Documentos\\Punto Cambio\\punto_cambio_new\\src\\components\\ui\\toggle-group.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\oswal\\OneDrive\\Documentos\\Punto Cambio\\punto_cambio_new\\src\\components\\ui\\toggle.tsx","messages":[{"ruleId":"react-refresh/only-export-components","severity":1,"message":"Fast refresh only works when a file only exports components. Use a new file to share constants or functions between components.","line":43,"column":18,"nodeType":"Identifier","messageId":"namedExport","endLine":43,"endColumn":32}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":1,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import * as React from \"react\"\r\nimport * as TogglePrimitive from \"@radix-ui/react-toggle\"\r\nimport { cva, type VariantProps } from \"class-variance-authority\"\r\n\r\nimport { cn } from \"@/lib/utils\"\r\n\r\nconst toggleVariants = cva(\r\n  \"inline-flex items-center justify-center rounded-md text-sm font-medium ring-offset-background transition-colors hover:bg-muted hover:text-muted-foreground focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 disabled:pointer-events-none disabled:opacity-50 data-[state=on]:bg-accent data-[state=on]:text-accent-foreground\",\r\n  {\r\n    variants: {\r\n      variant: {\r\n        default: \"bg-transparent\",\r\n        outline:\r\n          \"border border-input bg-transparent hover:bg-accent hover:text-accent-foreground\",\r\n      },\r\n      size: {\r\n        default: \"h-10 px-3\",\r\n        sm: \"h-9 px-2.5\",\r\n        lg: \"h-11 px-5\",\r\n      },\r\n    },\r\n    defaultVariants: {\r\n      variant: \"default\",\r\n      size: \"default\",\r\n    },\r\n  }\r\n)\r\n\r\nconst Toggle = React.forwardRef<\r\n  React.ElementRef<typeof TogglePrimitive.Root>,\r\n  React.ComponentPropsWithoutRef<typeof TogglePrimitive.Root> &\r\n    VariantProps<typeof toggleVariants>\r\n>(({ className, variant, size, ...props }, ref) => (\r\n  <TogglePrimitive.Root\r\n    ref={ref}\r\n    className={cn(toggleVariants({ variant, size, className }))}\r\n    {...props}\r\n  />\r\n))\r\n\r\nToggle.displayName = TogglePrimitive.Root.displayName\r\n\r\nexport { Toggle, toggleVariants }\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\oswal\\OneDrive\\Documentos\\Punto Cambio\\punto_cambio_new\\src\\components\\ui\\tooltip.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\oswal\\OneDrive\\Documentos\\Punto Cambio\\punto_cambio_new\\src\\components\\ui\\unauthorized.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\oswal\\OneDrive\\Documentos\\Punto Cambio\\punto_cambio_new\\src\\components\\ui\\use-toast.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\oswal\\OneDrive\\Documentos\\Punto Cambio\\punto_cambio_new\\src\\config\\environment.ts","messages":[{"ruleId":"no-console","severity":1,"message":"Unexpected console statement. Only these console methods are allowed: warn, error.","line":44,"column":3,"nodeType":"MemberExpression","messageId":"limited","endLine":44,"endColumn":14,"suggestions":[{"fix":{"range":[1231,1403],"text":""},"messageId":"removeConsole","data":{"propertyName":"log"},"desc":"Remove the console.log()."}]}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":1,"fixableErrorCount":0,"fixableWarningCount":0,"source":"/**\r\n * Configuraci├│n centralizada de variables de entorno\r\n */\r\n\r\ninterface EnvironmentConfig {\r\n  API_URL: string;\r\n  NODE_ENV: string;\r\n  IS_DEVELOPMENT: boolean;\r\n  IS_PRODUCTION: boolean;\r\n  APP_NAME: string;\r\n  APP_VERSION: string;\r\n}\r\n\r\n// Validar variables de entorno requeridas\r\nconst requiredEnvVars = [\"VITE_API_URL\"] as const;\r\n\r\nfunction validateEnvironment(): void {\r\n  const missing = requiredEnvVars.filter((envVar) => !import.meta.env[envVar]);\r\n\r\n  if (missing.length > 0) {\r\n    console.error(\"Variables de entorno faltantes:\", missing);\r\n    throw new Error(\r\n      `Variables de entorno requeridas faltantes: ${missing.join(\", \")}`\r\n    );\r\n  }\r\n}\r\n\r\n// Validar en desarrollo\r\nif (import.meta.env.DEV) {\r\n  validateEnvironment();\r\n}\r\n\r\nexport const env: EnvironmentConfig = {\r\n  API_URL: import.meta.env.VITE_API_URL || \"http://34.122.108.114:3001/api\",\r\n  NODE_ENV: import.meta.env.NODE_ENV || \"development\",\r\n  IS_DEVELOPMENT: import.meta.env.DEV || false,\r\n  IS_PRODUCTION: import.meta.env.PROD || false,\r\n  APP_NAME: import.meta.env.VITE_APP_NAME || \"Punto Cambio\",\r\n  APP_VERSION: import.meta.env.VITE_APP_VERSION || \"1.0.0\",\r\n};\r\n\r\n// Logging de configuraci├│n en desarrollo\r\nif (env.IS_DEVELOPMENT) {\r\n  console.log(\"­ƒöº Configuraci├│n de entorno:\", {\r\n    API_URL: env.API_URL,\r\n    NODE_ENV: env.NODE_ENV,\r\n    APP_NAME: env.APP_NAME,\r\n    APP_VERSION: env.APP_VERSION,\r\n  });\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\oswal\\OneDrive\\Documentos\\Punto Cambio\\punto_cambio_new\\src\\config\\servientrega.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\oswal\\OneDrive\\Documentos\\Punto Cambio\\punto_cambio_new\\src\\constants\\index.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\oswal\\OneDrive\\Documentos\\Punto Cambio\\punto_cambio_new\\src\\hooks\\use-mobile.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\oswal\\OneDrive\\Documentos\\Punto Cambio\\punto_cambio_new\\src\\hooks\\use-toast.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\oswal\\OneDrive\\Documentos\\Punto Cambio\\punto_cambio_new\\src\\hooks\\useAsyncOperation.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\oswal\\OneDrive\\Documentos\\Punto Cambio\\punto_cambio_new\\src\\hooks\\useAuth.tsx","messages":[{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'validateAndTransformUser' is defined but never used. Allowed unused vars must match /^_/u.","line":13,"column":3,"nodeType":null,"messageId":"unusedVar","endLine":13,"endColumn":27},{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'validateAndTransformPuntoAtencion' is defined but never used. Allowed unused vars must match /^_/u.","line":14,"column":3,"nodeType":null,"messageId":"unusedVar","endLine":14,"endColumn":36}],"suppressedMessages":[{"ruleId":"react-refresh/only-export-components","severity":1,"message":"Fast refresh only works when a file only exports components. Use a new file to share constants or functions between components.","line":226,"column":14,"nodeType":"Identifier","messageId":"namedExport","endLine":226,"endColumn":21,"suppressions":[{"kind":"directive","justification":""}]}],"errorCount":0,"fatalErrorCount":0,"warningCount":2,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import {\n  createContext,\n  useContext,\n  useState,\n  useEffect,\n  ReactNode,\n} from \"react\";\nimport { authService, AuthUser } from \"../services/authService\";\nimport { scheduleService } from \"../services/scheduleService\";\nimport { pointService } from \"../services/pointService\";\nimport { PuntoAtencion } from \"../types\";\nimport {\n  validateAndTransformUser,\n  validateAndTransformPuntoAtencion,\n} from \"../utils/typeValidation\";\n\ninterface AuthContextType {\n  user: AuthUser | null;\n  login: (\n    username: string,\n    password: string\n  ) => Promise<{ success: boolean; error?: string }>;\n  logout: () => void;\n  isLoading: boolean;\n  selectedPoint: PuntoAtencion | null;\n  setSelectedPoint: (point: PuntoAtencion | null) => void;\n}\n\nconst AuthContext = createContext<AuthContextType | undefined>(undefined);\n\nexport const AuthProvider = ({ children }: { children: ReactNode }) => {\n  const [user, setUser] = useState<AuthUser | null>(null);\n  const [isLoading, setIsLoading] = useState(true);\n  const [selectedPoint, setSelectedPointState] = useState<PuntoAtencion | null>(\n    null\n  );\n\n  useEffect(() => {\n    const storedPoint = localStorage.getItem(\"puntoAtencionSeleccionado\");\n    if (storedPoint) {\n      try {\n        const parsedPoint: PuntoAtencion = JSON.parse(storedPoint);\n        setSelectedPointState(parsedPoint);\n      } catch {\n        localStorage.removeItem(\"puntoAtencionSeleccionado\");\n      }\n    }\n  }, []);\n\n  useEffect(() => {\n    if (selectedPoint) {\n      localStorage.setItem(\n        \"puntoAtencionSeleccionado\",\n        JSON.stringify(selectedPoint)\n      );\n    } else {\n      localStorage.removeItem(\"puntoAtencionSeleccionado\");\n    }\n  }, [selectedPoint]);\n\n  useEffect(() => {\n    const initializeAuth = async () => {\n      try {\n        const { user: verifiedUser, valid } = await authService.verifyToken();\n        if (valid && verifiedUser) {\n          setUser(verifiedUser);\n\n          const storedPoint = localStorage.getItem(\"puntoAtencionSeleccionado\");\n          if (!storedPoint) {\n            const forcePointSelection =\n              (typeof window !== \"undefined\" && sessionStorage.getItem(\"pc_force_point_select\") === \"1\") || false;\n            if (forcePointSelection) {\n              try {\n                sessionStorage.removeItem(\"pc_force_point_select\");\n              } catch {\n                // noop: sessionStorage may be unavailable\n              }\n            }\n            // Si es admin, conectar autom├íticamente al punto principal\n            if (\n              verifiedUser.rol === \"ADMIN\" ||\n              verifiedUser.rol === \"SUPER_USUARIO\"\n            ) {\n              try {\n                const { points } = await pointService.getAllPoints();\n                const adminPoint = points.find(\n                  (p) => p.id === verifiedUser.punto_atencion_id\n                ) || points.find((p) => p.es_principal);\n                if (adminPoint) {\n                  setSelectedPointState(adminPoint);\n                }\n              } catch (error) {\n                console.error(\"Error al cargar punto principal para admin:\", error);\n              }\n            } else if (verifiedUser.rol === \"OPERADOR\") {\n              // Para operadores, usar la l├│gica existente de jornada activa\n              if (!forcePointSelection) {\n                const res = await scheduleService.getActiveSchedule();\n                if (res?.schedule?.puntoAtencion) {\n                  setSelectedPointState(\n                    res.schedule.puntoAtencion as PuntoAtencion\n                  );\n                }\n              }\n            } else if (verifiedUser.rol === \"CONCESION\") {\n              // Para concesi├│n, usar el punto asignado en su perfil si existe\n              if (verifiedUser.punto_atencion_id) {\n                const { points } = await pointService.getAllPoints();\n                const concesionPoint = points.find(\n                  (p) => p.id === verifiedUser.punto_atencion_id\n                );\n                if (concesionPoint) {\n                  setSelectedPointState(concesionPoint);\n                }\n              }\n            }\n          }\n        } else {\n          authService.removeStoredToken();\n        }\n      } catch {\n        authService.removeStoredToken();\n      } finally {\n        setIsLoading(false);\n      }\n    };\n\n    initializeAuth();\n  }, []);\n\n  const login = async (username: string, password: string) => {\n    try {\n      const {\n        user: loggedUser,\n        token,\n        error,\n      } = await authService.login({ username, password });\n\n      if (loggedUser && token) {\n        setUser(loggedUser);\n        const forcePointSelection =\n          (typeof window !== \"undefined\" && sessionStorage.getItem(\"pc_force_point_select\") === \"1\") || false;\n        if (forcePointSelection) {\n          try {\n            sessionStorage.removeItem(\"pc_force_point_select\");\n          } catch {\n            // noop: sessionStorage may be unavailable\n          }\n        }\n\n        // Si es admin, conectar autom├íticamente al punto principal\n        if (loggedUser.rol === \"ADMIN\" || loggedUser.rol === \"SUPER_USUARIO\") {\n          try {\n            // Cargar el punto de atenci├│n del admin desde su perfil\n            const { points } = await pointService.getAllPoints();\n            const adminPoint = points.find(\n              (p) => p.id === loggedUser.punto_atencion_id\n            ) || points.find((p) => p.es_principal);\n            if (adminPoint) {\n              setSelectedPointState(adminPoint);\n            }\n          } catch (error) {\n            console.error(\"Error al cargar punto principal para admin:\", error);\n          }\n        } else if (loggedUser.rol === \"OPERADOR\") {\n          // Para operadores, usar la l├│gica existente de jornada activa\n          if (!forcePointSelection) {\n            const res = await scheduleService.getActiveSchedule();\n            if (res?.schedule?.puntoAtencion) {\n              setSelectedPointState(res.schedule.puntoAtencion as PuntoAtencion);\n            }\n          }\n        } else if (loggedUser.rol === \"CONCESION\") {\n          // Para concesi├│n, usar el punto asignado en su perfil si existe\n          if (loggedUser.punto_atencion_id) {\n            const { points } = await pointService.getAllPoints();\n            const concesionPoint = points.find(\n              (p) => p.id === loggedUser.punto_atencion_id\n            );\n            if (concesionPoint) {\n              setSelectedPointState(concesionPoint);\n            }\n          }\n        }\n\n        return { success: true };\n      } else {\n        return { success: false, error: error || \"Error de autenticaci├│n\" };\n      }\n    } catch {\n      return { success: false, error: \"Error de conexi├│n\" };\n    }\n  };\n\n  const logout = () => {\n    authService.removeStoredToken();\n    setUser(null);\n    setSelectedPointState(null);\n    localStorage.removeItem(\"puntoAtencionSeleccionado\");\n    // Limpiar tambi├®n claves de vista y punto para evitar continuar en el mismo punto\n    localStorage.removeItem(\"pc_selected_point_id\");\n    localStorage.removeItem(\"pc_active_view\");\n  };\n\n  const setSelectedPoint = (point: PuntoAtencion | null) => {\n    setSelectedPointState(point);\n  };\n\n  return (\n    <AuthContext.Provider\n      value={{\n        user,\n        login,\n        logout,\n        isLoading,\n        selectedPoint,\n        setSelectedPoint,\n      }}\n    >\n      {children}\n    </AuthContext.Provider>\n  );\n};\n\n// eslint-disable-next-line react-refresh/only-export-components\nexport const useAuth = () => {\n  const context = useContext(AuthContext);\n  if (context === undefined) {\n    throw new Error(\"useAuth must be used within an AuthProvider\");\n  }\n  return context;\n};\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\oswal\\OneDrive\\Documentos\\Punto Cambio\\punto_cambio_new\\src\\hooks\\useConfirmationDialog.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\oswal\\OneDrive\\Documentos\\Punto Cambio\\punto_cambio_new\\src\\hooks\\useContabilidadAdmin.ts","messages":[{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'SaldoMoneda' is defined but never used. Allowed unused vars must match /^_/u.","line":3,"column":16,"nodeType":null,"messageId":"unusedVar","endLine":3,"endColumn":27},{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'err' is defined but never used.","line":85,"column":14,"nodeType":null,"messageId":"unusedVar","endLine":85,"endColumn":17},{"ruleId":"react-hooks/exhaustive-deps","severity":1,"message":"React Hook useCallback has missing dependencies: 'isAdmin' and 'isAdminPoint'. Either include them or remove the dependency array.","line":92,"column":6,"nodeType":"ArrayExpression","endLine":92,"endColumn":8,"suggestions":[{"desc":"Update the dependencies array to be: [isAdmin, isAdminPoint]","fix":{"range":[3005,3007],"text":"[isAdmin, isAdminPoint]"}}]},{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'err' is defined but never used.","line":154,"column":16,"nodeType":null,"messageId":"unusedVar","endLine":154,"endColumn":19},{"ruleId":"react-hooks/exhaustive-deps","severity":1,"message":"React Hook useCallback has a missing dependency: 'isAdmin'. Either include it or remove the dependency array.","line":161,"column":5,"nodeType":"ArrayExpression","endLine":161,"endColumn":7,"suggestions":[{"desc":"Update the dependencies array to be: [isAdmin]","fix":{"range":[5108,5110],"text":"[isAdmin]"}}]}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":5,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import { useState, useEffect, useCallback } from \"react\";\r\nimport { toast } from \"sonner\";\r\nimport { User, SaldoMoneda, SaldoConsolidado, MovimientoSaldo } from \"@/types\";\r\nimport { movimientosContablesService } from \"@/services/movimientosContablesService\";\r\nimport { pointService } from \"@/services/pointService\";\r\n\r\ninterface UseContabilidadAdminProps {\r\n  user: User;\r\n}\r\n\r\ninterface MovimientoConsolidado extends MovimientoSaldo {\r\n  punto_nombre: string;\r\n}\r\n\r\nexport const useContabilidadAdmin = ({\r\n  user: _user,\r\n}: UseContabilidadAdminProps) => {\r\n  type AdminPoint = { id: string; nombre: string };\r\n\r\n  const isAdminPoint = (value: unknown): value is AdminPoint => {\r\n    if (typeof value !== \"object\" || value === null) return false;\r\n    const record = value as Record<string, unknown>;\r\n    return typeof record.id === \"string\" && typeof record.nombre === \"string\";\r\n  };\r\n  const [saldosConsolidados, setSaldosConsolidados] = useState<\r\n    SaldoConsolidado[]\r\n  >([]);\r\n  const [movimientosConsolidados, setMovimientosConsolidados] = useState<\r\n    MovimientoConsolidado[]\r\n  >([]);\r\n  const [isLoading, setIsLoading] = useState(false);\r\n  const [error, setError] = useState<string | null>(null);\r\n  const isAdmin = _user?.rol === \"ADMIN\" || _user?.rol === \"SUPER_USUARIO\";\r\n\r\n  // Cargar saldos consolidados de todos los puntos\r\n  const cargarSaldosConsolidados = useCallback(async () => {\r\n    setIsLoading(true);\r\n    setError(null);\r\n\r\n    try {\r\n      if (!isAdmin) {\r\n        setSaldosConsolidados([]);\r\n        setIsLoading(false);\r\n        return;\r\n      }\r\n      // Primero obtener todos los puntos (solo para admins)\r\n      const { points, error: pointsError } =\r\n        await pointService.getAllPointsForAdmin();\r\n\r\n      if (pointsError) {\r\n        setError(pointsError);\r\n        toast.error(`Error al cargar puntos: ${pointsError}`);\r\n        return;\r\n      }\r\n\r\n      if (!points || points.length === 0) {\r\n        setSaldosConsolidados([]);\r\n        return;\r\n      }\r\n\r\n      // Obtener saldos de cada punto\r\n      const saldosPromises = points.filter(isAdminPoint).map(async (punto) => {\r\n        const { saldos, error: saldosError } =\r\n          await movimientosContablesService.getSaldosActualesPorPunto(punto.id);\r\n\r\n        if (saldosError) {\r\n          console.error(\r\n            `Error al cargar saldos del punto ${punto.nombre}:`,\r\n            saldosError\r\n          );\r\n          return [];\r\n        }\r\n\r\n        return (saldos || []).map((saldo) => ({\r\n          ...saldo,\r\n          punto_nombre: punto.nombre,\r\n          punto_id: punto.id,\r\n        }));\r\n      });\r\n\r\n      const resultados = await Promise.all(saldosPromises);\r\n      const saldosConsolidados = resultados.flat();\r\n\r\n      setSaldosConsolidados(saldosConsolidados);\r\n    } catch (err) {\r\n      const errorMessage = \"Error inesperado al cargar saldos consolidados\";\r\n      setError(errorMessage);\r\n      toast.error(errorMessage);\r\n    } finally {\r\n      setIsLoading(false);\r\n    }\r\n  }, []);\r\n\r\n  // Cargar movimientos consolidados de todos los puntos\r\n  const cargarMovimientosConsolidados = useCallback(\r\n    async (\r\n      moneda_id?: string,\r\n      limit = 100,\r\n      opts?: { date?: string; from?: string; to?: string }\r\n    ) => {\r\n      try {\r\n        if (!isAdmin) {\r\n          setMovimientosConsolidados([]);\r\n          return;\r\n        }\r\n        // Obtener todos los puntos (solo para admins)\r\n        const { points, error: pointsError } =\r\n          await pointService.getAllPointsForAdmin();\r\n\r\n        if (pointsError) {\r\n          setError(pointsError);\r\n          return;\r\n        }\r\n\r\n        if (!points || points.length === 0) {\r\n          setMovimientosConsolidados([]);\r\n          return;\r\n        }\r\n\r\n        // Obtener movimientos de cada punto\r\n        const movimientosPromises = points.map(async (punto) => {\r\n          const { movimientos, error: movimientosError } =\r\n            await movimientosContablesService.getHistorialMovimientos(\r\n              punto.id,\r\n              moneda_id,\r\n              limit,\r\n              opts\r\n            );\r\n\r\n          if (movimientosError) {\r\n            console.error(\r\n              `Error al cargar movimientos del punto ${punto.nombre}:`,\r\n              movimientosError\r\n            );\r\n            return [];\r\n          }\r\n\r\n          return (movimientos || []).map((movimiento) => ({\r\n            ...movimiento,\r\n            punto_nombre: punto.nombre,\r\n            punto_id: punto.id,\r\n          }));\r\n        });\r\n\r\n        const resultados = await Promise.all(movimientosPromises);\r\n        const movimientosConsolidados = resultados.flat();\r\n\r\n        // Ordenar por fecha descendente\r\n        movimientosConsolidados.sort(\r\n          (a, b) => new Date(b.fecha).getTime() - new Date(a.fecha).getTime()\r\n        );\r\n\r\n        setMovimientosConsolidados(movimientosConsolidados.slice(0, limit));\r\n      } catch (err) {\r\n        const errorMessage =\r\n          \"Error inesperado al cargar movimientos consolidados\";\r\n        setError(errorMessage);\r\n        toast.error(errorMessage);\r\n      }\r\n    },\r\n    []\r\n  );\r\n\r\n  // Cargar datos iniciales\r\n  useEffect(() => {\r\n    cargarSaldosConsolidados();\r\n    cargarMovimientosConsolidados();\r\n  }, [cargarSaldosConsolidados, cargarMovimientosConsolidados]);\r\n\r\n  const refresh = useCallback(() => {\r\n    cargarSaldosConsolidados();\r\n    cargarMovimientosConsolidados();\r\n  }, [cargarSaldosConsolidados, cargarMovimientosConsolidados]);\r\n\r\n  return {\r\n    saldosConsolidados,\r\n    movimientosConsolidados,\r\n    isLoading,\r\n    error,\r\n    refresh,\r\n    cargarSaldosConsolidados,\r\n    cargarMovimientosConsolidados,\r\n  };\r\n};\r\n\r\nexport default useContabilidadAdmin;\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\oswal\\OneDrive\\Documentos\\Punto Cambio\\punto_cambio_new\\src\\hooks\\useContabilidadDivisas.ts","messages":[{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'err' is defined but never used.","line":51,"column":14,"nodeType":null,"messageId":"unusedVar","endLine":51,"endColumn":17},{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'err' is defined but never used.","line":86,"column":16,"nodeType":null,"messageId":"unusedVar","endLine":86,"endColumn":19},{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'err' is defined but never used.","line":116,"column":16,"nodeType":null,"messageId":"unusedVar","endLine":116,"endColumn":19},{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'err' is defined but never used.","line":172,"column":16,"nodeType":null,"messageId":"unusedVar","endLine":172,"endColumn":19}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":4,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import { useState, useEffect, useCallback } from \"react\";\r\nimport { toast } from \"sonner\";\r\nimport { CambioDivisa, User, PuntoAtencion, MovimientoSaldo } from \"../types\";\r\nimport { movimientosContablesService } from \"../services/movimientosContablesService\";\r\nimport { SaldoActualizado } from \"../types\";\r\n\r\ninterface SaldoMoneda {\r\n  moneda_id: string;\r\n  moneda_codigo: string;\r\n  saldo: number;\r\n  billetes?: number;\r\n  monedas_fisicas?: number;\r\n}\r\n\r\ninterface UseContabilidadDivisasProps {\r\n  user: User;\r\n  selectedPoint: PuntoAtencion | null;\r\n}\r\n\r\nexport const useContabilidadDivisas = ({\r\n  user,\r\n  selectedPoint,\r\n}: UseContabilidadDivisasProps) => {\r\n  const [saldos, setSaldos] = useState<SaldoMoneda[]>([]);\r\n  const [movimientos, setMovimientos] = useState<MovimientoSaldo[]>([]);\r\n  const [isLoading, setIsLoading] = useState(false);\r\n  const [error, setError] = useState<string | null>(null);\r\n\r\n  // Cargar saldos actuales del punto\r\n  const cargarSaldos = useCallback(async () => {\r\n    if (!selectedPoint) return;\r\n\r\n    setIsLoading(true);\r\n    setError(null);\r\n\r\n    try {\r\n      const { saldos: saldosData, error: saldosError } =\r\n        await movimientosContablesService.getSaldosActualesPorPunto(\r\n          selectedPoint.id\r\n        );\r\n\r\n      if (saldosError) {\r\n        setError(saldosError);\r\n        toast.error(`Error al cargar saldos: ${saldosError}`);\r\n        return;\r\n      }\r\n\r\n      if (saldosData) {\r\n        setSaldos(saldosData);\r\n      }\r\n    } catch (err) {\r\n      const errorMessage = \"Error inesperado al cargar saldos\";\r\n      setError(errorMessage);\r\n      toast.error(errorMessage);\r\n    } finally {\r\n      setIsLoading(false);\r\n    }\r\n  }, [selectedPoint]);\r\n\r\n  // Cargar historial de movimientos\r\n  const cargarMovimientos = useCallback(\r\n    async (\r\n      moneda_id?: string,\r\n      limit = 50,\r\n      opts?: { date?: string; from?: string; to?: string }\r\n    ) => {\r\n      if (!selectedPoint) return;\r\n\r\n      try {\r\n        const { movimientos: movimientosData, error: movimientosError } =\r\n          await movimientosContablesService.getHistorialMovimientos(\r\n            selectedPoint.id,\r\n            moneda_id,\r\n            limit,\r\n            opts\r\n          );\r\n\r\n        if (movimientosError) {\r\n          toast.error(`Error al cargar movimientos: ${movimientosError}`);\r\n          return;\r\n        }\r\n\r\n        if (movimientosData) {\r\n          setMovimientos(movimientosData);\r\n        }\r\n      } catch (err) {\r\n        toast.error(\"Error inesperado al cargar movimientos\");\r\n      }\r\n    },\r\n    [selectedPoint]\r\n  );\r\n\r\n  // Validar saldo antes de realizar un cambio\r\n  const validarSaldoParaCambio = useCallback(\r\n    async (\r\n      moneda_destino_id: string,\r\n      monto_destino: number\r\n    ): Promise<{ valido: boolean; saldo_actual: number; mensaje?: string }> => {\r\n      if (!selectedPoint) {\r\n        return {\r\n          valido: false,\r\n          saldo_actual: 0,\r\n          mensaje: \"No hay punto seleccionado\",\r\n        };\r\n      }\r\n\r\n      try {\r\n        const { valido, saldo_actual, error } =\r\n          await movimientosContablesService.validarSaldoParaCambio(\r\n            selectedPoint.id,\r\n            moneda_destino_id,\r\n            monto_destino\r\n          );\r\n\r\n        return { valido, saldo_actual, mensaje: error || undefined };\r\n      } catch (err) {\r\n        return {\r\n          valido: false,\r\n          saldo_actual: 0,\r\n          mensaje: \"Error al validar saldo\",\r\n        };\r\n      }\r\n    },\r\n    [selectedPoint]\r\n  );\r\n\r\n  // Procesar movimientos contables despu├®s de un cambio\r\n  const procesarMovimientosCambio = useCallback(\r\n    async (\r\n      cambio: CambioDivisa\r\n    ): Promise<{\r\n      success: boolean;\r\n      saldos_actualizados?: SaldoActualizado[];\r\n    }> => {\r\n      if (!user || !selectedPoint) {\r\n        toast.error(\"Usuario o punto no v├ílido\");\r\n        return { success: false };\r\n      }\r\n\r\n      try {\r\n        const { result, error } =\r\n          await movimientosContablesService.procesarMovimientosCambio(\r\n            cambio,\r\n            user.id\r\n          );\r\n\r\n        if (error) {\r\n          toast.error(`Error en contabilidad: ${error}`);\r\n          return { success: false };\r\n        }\r\n\r\n        if (result && result.success) {\r\n          // Actualizar saldos locales\r\n          await cargarSaldos();\r\n\r\n          // Mostrar resumen de movimientos\r\n          const resumen = result.saldos_actualizados\r\n            .map(\r\n              (s) => `${s.moneda_id}: ${s.saldo_anterior} ÔåÆ ${s.saldo_nuevo}`\r\n            )\r\n            .join(\", \");\r\n\r\n          toast.success(`Ô£à Saldos actualizados: ${resumen}`);\r\n\r\n          return {\r\n            success: true,\r\n            saldos_actualizados: result.saldos_actualizados,\r\n          };\r\n        }\r\n\r\n        return { success: false };\r\n      } catch (err) {\r\n        toast.error(\"Error inesperado al procesar movimientos contables\");\r\n        return { success: false };\r\n      }\r\n    },\r\n    [user, selectedPoint, cargarSaldos]\r\n  );\r\n\r\n  // Obtener saldo de una moneda espec├¡fica\r\n  const getSaldoMoneda = useCallback(\r\n    (moneda_id: string): number => {\r\n      const saldo = saldos.find((s) => s.moneda_id === moneda_id);\r\n      return saldo?.saldo || 0;\r\n    },\r\n    [saldos]\r\n  );\r\n\r\n  // Verificar si hay saldo suficiente\r\n  const tieneSaldoSuficiente = useCallback(\r\n    (moneda_id: string, monto: number): boolean => {\r\n      const saldoActual = getSaldoMoneda(moneda_id);\r\n      return saldoActual >= monto;\r\n    },\r\n    [getSaldoMoneda]\r\n  );\r\n\r\n  // Cargar datos iniciales\r\n  useEffect(() => {\r\n    if (selectedPoint) {\r\n      cargarSaldos();\r\n      cargarMovimientos();\r\n    }\r\n  }, [selectedPoint, cargarSaldos, cargarMovimientos]);\r\n\r\n  return {\r\n    // Estados\r\n    saldos,\r\n    movimientos,\r\n    isLoading,\r\n    error,\r\n\r\n    // Funciones\r\n    cargarSaldos,\r\n    cargarMovimientos,\r\n    validarSaldoParaCambio,\r\n    procesarMovimientosCambio,\r\n    getSaldoMoneda,\r\n    tieneSaldoSuficiente,\r\n\r\n    // Utilidades\r\n    refresh: () => {\r\n      cargarSaldos();\r\n      cargarMovimientos();\r\n    },\r\n  };\r\n};\r\n\r\nexport default useContabilidadDivisas;\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\oswal\\OneDrive\\Documentos\\Punto Cambio\\punto_cambio_new\\src\\hooks\\useCuadreCaja.ts","messages":[],"suppressedMessages":[{"ruleId":"react-hooks/exhaustive-deps","severity":1,"message":"React Hook useEffect has a missing dependency: 'refresh'. Either include it or remove the dependency array.","line":195,"column":6,"nodeType":"ArrayExpression","endLine":195,"endColumn":49,"suggestions":[{"desc":"Update the dependencies array to be: [fecha, withContabilidad, options.pointId, refresh]","fix":{"range":[5816,5859],"text":"[fecha, withContabilidad, options.pointId, refresh]"}}],"suppressions":[{"kind":"directive","justification":""}]}],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\oswal\\OneDrive\\Documentos\\Punto Cambio\\punto_cambio_new\\src\\hooks\\useExchangeCalculations.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\oswal\\OneDrive\\Documentos\\Punto Cambio\\punto_cambio_new\\src\\hooks\\useExchangeData.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\oswal\\OneDrive\\Documentos\\Punto Cambio\\punto_cambio_new\\src\\hooks\\useExchangeProcess.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\oswal\\OneDrive\\Documentos\\Punto Cambio\\punto_cambio_new\\src\\integrations\\supabase\\client.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\oswal\\OneDrive\\Documentos\\Punto Cambio\\punto_cambio_new\\src\\integrations\\supabase\\types.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\oswal\\OneDrive\\Documentos\\Punto Cambio\\punto_cambio_new\\src\\lib\\api.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\oswal\\OneDrive\\Documentos\\Punto Cambio\\punto_cambio_new\\src\\lib\\pointEvents.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\oswal\\OneDrive\\Documentos\\Punto Cambio\\punto_cambio_new\\src\\lib\\utils.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\oswal\\OneDrive\\Documentos\\Punto Cambio\\punto_cambio_new\\src\\main.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\oswal\\OneDrive\\Documentos\\Punto Cambio\\punto_cambio_new\\src\\pages\\Dashboard.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\oswal\\OneDrive\\Documentos\\Punto Cambio\\punto_cambio_new\\src\\pages\\Index.tsx","messages":[],"suppressedMessages":[{"ruleId":"react-hooks/exhaustive-deps","severity":1,"message":"React Hook useEffect has missing dependencies: 'selectedPoint', 'setSelectedPoint', and 'toast'. Either include them or remove the dependency array.","line":89,"column":6,"nodeType":"ArrayExpression","endLine":89,"endColumn":12,"suggestions":[{"desc":"Update the dependencies array to be: [selectedPoint, setSelectedPoint, toast, user]","fix":{"range":[2914,2920],"text":"[selectedPoint, setSelectedPoint, toast, user]"}}],"suppressions":[{"kind":"directive","justification":""}]}],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\oswal\\OneDrive\\Documentos\\Punto Cambio\\punto_cambio_new\\src\\pages\\Login.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\oswal\\OneDrive\\Documentos\\Punto Cambio\\punto_cambio_new\\src\\pages\\NotFound.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\oswal\\OneDrive\\Documentos\\Punto Cambio\\punto_cambio_new\\src\\pages\\admin\\CurrencyBehaviorPage.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\oswal\\OneDrive\\Documentos\\Punto Cambio\\punto_cambio_new\\src\\services\\apiService.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\oswal\\OneDrive\\Documentos\\Punto Cambio\\punto_cambio_new\\src\\services\\authService.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\oswal\\OneDrive\\Documentos\\Punto Cambio\\punto_cambio_new\\src\\services\\axiosInstance.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\oswal\\OneDrive\\Documentos\\Punto Cambio\\punto_cambio_new\\src\\services\\balanceService.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\oswal\\OneDrive\\Documentos\\Punto Cambio\\punto_cambio_new\\src\\services\\contabilidadDiariaService.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\oswal\\OneDrive\\Documentos\\Punto Cambio\\punto_cambio_new\\src\\services\\cuatreCajaService.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\oswal\\OneDrive\\Documentos\\Punto Cambio\\punto_cambio_new\\src\\services\\currencyService.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\oswal\\OneDrive\\Documentos\\Punto Cambio\\punto_cambio_new\\src\\services\\deviceService.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\oswal\\OneDrive\\Documentos\\Punto Cambio\\punto_cambio_new\\src\\services\\exchangeService.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\oswal\\OneDrive\\Documentos\\Punto Cambio\\punto_cambio_new\\src\\services\\externalServicesService.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\oswal\\OneDrive\\Documentos\\Punto Cambio\\punto_cambio_new\\src\\services\\fxService.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\oswal\\OneDrive\\Documentos\\Punto Cambio\\punto_cambio_new\\src\\services\\movimientosContablesService.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\oswal\\OneDrive\\Documentos\\Punto Cambio\\punto_cambio_new\\src\\services\\permissionService.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\oswal\\OneDrive\\Documentos\\Punto Cambio\\punto_cambio_new\\src\\services\\pointService.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\oswal\\OneDrive\\Documentos\\Punto Cambio\\punto_cambio_new\\src\\services\\receiptService.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\oswal\\OneDrive\\Documentos\\Punto Cambio\\punto_cambio_new\\src\\services\\reportService.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\oswal\\OneDrive\\Documentos\\Punto Cambio\\punto_cambio_new\\src\\services\\saldoInicialService.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\oswal\\OneDrive\\Documentos\\Punto Cambio\\punto_cambio_new\\src\\services\\scheduleService.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\oswal\\OneDrive\\Documentos\\Punto Cambio\\punto_cambio_new\\src\\services\\servientregaService.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\oswal\\OneDrive\\Documentos\\Punto Cambio\\punto_cambio_new\\src\\services\\spontaneousExitService.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\oswal\\OneDrive\\Documentos\\Punto Cambio\\punto_cambio_new\\src\\services\\transferApprovalService.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\oswal\\OneDrive\\Documentos\\Punto Cambio\\punto_cambio_new\\src\\services\\transferService.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\oswal\\OneDrive\\Documentos\\Punto Cambio\\punto_cambio_new\\src\\services\\userService.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\oswal\\OneDrive\\Documentos\\Punto Cambio\\punto_cambio_new\\src\\services\\validationService.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\oswal\\OneDrive\\Documentos\\Punto Cambio\\punto_cambio_new\\src\\types\\currency-shims.d.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\oswal\\OneDrive\\Documentos\\Punto Cambio\\punto_cambio_new\\src\\types\\events.d.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\oswal\\OneDrive\\Documentos\\Punto Cambio\\punto_cambio_new\\src\\types\\index.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\oswal\\OneDrive\\Documentos\\Punto Cambio\\punto_cambio_new\\src\\types\\servientrega.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\oswal\\OneDrive\\Documentos\\Punto Cambio\\punto_cambio_new\\src\\utils\\currencyCalculations.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\oswal\\OneDrive\\Documentos\\Punto Cambio\\punto_cambio_new\\src\\utils\\errorHandler.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\oswal\\OneDrive\\Documentos\\Punto Cambio\\punto_cambio_new\\src\\utils\\exportToExcel.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\oswal\\OneDrive\\Documentos\\Punto Cambio\\punto_cambio_new\\src\\utils\\healthCheck.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\oswal\\OneDrive\\Documentos\\Punto Cambio\\punto_cambio_new\\src\\utils\\timezone.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\oswal\\OneDrive\\Documentos\\Punto Cambio\\punto_cambio_new\\src\\utils\\typeValidation.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\oswal\\OneDrive\\Documentos\\Punto Cambio\\punto_cambio_new\\src\\vite-env.d.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\oswal\\OneDrive\\Documentos\\Punto Cambio\\punto_cambio_new\\tailwind.config.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\oswal\\OneDrive\\Documentos\\Punto Cambio\\punto_cambio_new\\vite.config.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]}]
